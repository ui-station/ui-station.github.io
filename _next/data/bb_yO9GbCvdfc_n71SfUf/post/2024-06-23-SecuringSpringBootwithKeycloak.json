{"pageProps":{"post":{"title":"Keycloak으로 Spring Boot 보안 설정하는 방법","description":"","date":"2024-06-23 21:21","slug":"2024-06-23-SecuringSpringBootwithKeycloak","content":"\n![사진](/assets/img/2024-06-23-SecuringSpringBootwithKeycloak_0.png)\n\n개요\n우리 애플리케이션을 안전하게 보호하는 것은 요즘 큰 걱정이자 도전입니다. 처음부터 구축하는 것은 더 어려울 수 있고 더 많은 시간이 소요될 수 있습니다. 따라서 우리는 IDP(Identity Provider) 도구인 Keycloak과 같이 애플리케이션의 인가 서버로 구현할 수 있습니다.\n\nKeycloak이란\n\nKeycloak은 레드햇에서 개발된 오픈 소스 식별 및 액세스 관리 도구입니다. 쉬운 설정 및 애플리케이션 통합으로 여러분이 직접 모든 것을 맞춤 설정하는 것보다 훨씬 많은 시간을 절약할 수 있습니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n많은 회사에서 이미 보안 구성 요소로 채택되어 있어서 도구들이 검증되었고 더욱 신뢰할 수 있는 상태로 구현되어 있습니다. 많은 회사가 Keycloak을 사용하기 때문에 학습 자료를 쉽게 얻고 인터넷에서 의논할 수 있습니다.\n\n주요 기능을 갖고 있기 때문에 비즈니스나 보안 흐름에 대응해야 할 경우 애플리케이션을 미래에 대비하여 더 확장 가능하게 만들 수 있습니다.\n\n구현\nKeycloak를 구현하는 여러 방법이 있습니다. 예를 들어 SSO, 소셜 미디어 로그인 또는 액세스 토큰을 얻기 위해 API에 접근하는 방법이 있습니다.\n\n우리는 필요에 따라 구현이 필요한 사용자 정의 흐름을 처리하는 독립된 인증 서비스를 사용하여 구현할 것이지만, 자격 증명 자체를 인증하는 데 Keycloak가 책임을 집니다. 그리고 서비스 레이어의 리소스 서버에서 토큰을 확인합니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n시스템 다이어그램\n\n![image](/assets/img/2024-06-23-SecuringSpringBootwithKeycloak_1.png)\n\n사용자는 자격 증명을 제출하고, 이는 인증 서비스에서 처리되어 Keycloak 측에서 유효성이 검사됩니다. 자격 증명이 유효한 경우, Keycloak은 액세스 토큰을 반환하고, 유효하지 않은 경우 응답 401 — 권한 없음을 반환합니다.\n\n물론 애플리케이션 클라이언트(FE 또는 모바일 앱)에게 다시 원시 응답을 반환하지는 않겠습니다. 인증 서비스에서 응답을 표준화하여 처리할 것입니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\nKeycloak 설치 및 설정\n다음 yml 파일을 사용하여 도커 컴포즈로 Keycloak을 설치하고 구성하세요:\n\n```js\nversion: \"3\"\n\nservices:\n  keycloak:\n    image: quay.io/keycloak/keycloak:20.0.0\n    command: start-dev\n    environment:\n      KC_DB: postgres\n      KC_DB_URL_HOST: postgres\n      KC_DB_URL_DATABASE: keycloak_v1\n      KC_DB_PASSWORD: root\n      KC_DB_USERNAME: postgres\n      KC_DB_SCHEMA: public\n      KEYCLOAK_ADMIN: admin\n      KEYCLOAK_ADMIN_PASSWORD: admin\n      KEYCLOAK_JDBC_PARAMS: 'sslmode=require'\n    ports:\n      - \"9090:8080\"\n    depends_on:\n      postgres:\n        condition: service_healthy\n    networks:\n      network_sso:\n\n  postgres:\n    image: postgres:10\n    command: [\"postgres\", \"-c\", \"max_connections=200\", \"-c\", \"shared_buffers=24MB\", \"-c\", \"listen_addresses=*\"]\n    environment:\n      POSTGRES_DB: keycloak_v1\n      POSTGRES_USER: postgres\n      POSTGRES_PASSWORD: root\n    healthcheck:\n      test: \"exit 0\"\n    ports:\n      - \"5436:5432\"\n    networks:\n      network_sso:\n    volumes:\n      - postgres_data:/var/lib/postgresql/data\n    user: postgres\n\n  redis:\n    image: redis:latest\n    ports:\n      - \"6379:6379\"\n    environment:\n      REDIS_PASSWORD: \"root\"\n    volumes:\n      - redis_data:/data\n\nvolumes:\n  postgres_data:\n  redis_data:\n\nnetworks:\n  network_sso:\n```\n\n저희 Keycloak 애플리케이션에서 사용자 저장소로 postgres 데이터베이스를 사용하세요. “docker-compose up”을 실행한 후 http://localhost:9090에 액세스하고 다음 자격 증명으로 로그인하세요:\n\n계층을 만들고 원하는 대로 계층 이름 폼을 작성하세요.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n![이미지](/assets/img/2024-06-23-SecuringSpringBootwithKeycloak_2.png)\n\n이 구성대로 클라이언트를 계속 생성하세요.\n\n![이미지](/assets/img/2024-06-23-SecuringSpringBootwithKeycloak_3.png)\n\n![이미지](/assets/img/2024-06-23-SecuringSpringBootwithKeycloak_4.png)\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n클라이언트를 성공적으로 생성한 후, 클라이언트 비밀키를 복사하려면 클라이언트 자격 증명 탭으로 이동하세요.\n\n사용자를 생성하고 사용자 자격 증명 또는 암호를 설정한 후, 임시 암호 토글을 비활성화해야 합니다. userdemo와 admindemo 두 명의 사용자를 생성하세요.\n\n![이미지](/assets/img/2024-06-23-SecuringSpringBootwithKeycloak_5.png)\n\n역할 할당\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n키클로크에는 렘 역할과 리소스 클라이언트 역할이 있어요. 둘 다 서로 다른 책임과 동작을 가지고 있어요.\n\n렘 역할을 만들어 보세요, \"admin\"과 \"user\"와 같이요.\n\n![image](/assets/img/2024-06-23-SecuringSpringBootwithKeycloak_6.png)\n\n리소스 클라이언트 역할도 만들어 보세요, \"write\"와 \"read\" 같은 역할을 만들어 보세요.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n<img src=\"/assets/img/2024-06-23-SecuringSpringBootwithKeycloak_7.png\" />\n\n사용자 메뉴로 이동해서 사용자 'admindemo'에게 'admin' 및 'write' 역할을 할당하고, 'userdemo'에게 'user' 및 'read' 역할을 할당하세요.\n\n<img src=\"/assets/img/2024-06-23-SecuringSpringBootwithKeycloak_8.png\" />\n\n코드 구현\nSpring 프로젝트를 초기화하고, pom.xml에 다음 종속성을 추가하세요.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```js\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n <modelVersion>4.0.0</modelVersion>\n <parent>\n  <groupId>org.springframework.boot</groupId>\n  <artifactId>spring-boot-starter-parent</artifactId>\n  <version>3.2.2</version>\n </parent>\n <artifactId>auth-service</artifactId>\n <version>0.0.1-SNAPSHOT</version>\n <name>auth-service</name>\n <description>Demo project for Spring Boot</description>\n <properties>\n  <java.version>17</java.version>\n </properties>\n <dependencies>\n  <dependency>\n   <groupId>org.springframework.boot</groupId>\n   <artifactId>spring-boot-starter-web</artifactId>\n  </dependency>\n  <dependency>\n   <groupId>org.springframework.boot</groupId>\n   <artifactId>spring-boot-starter-security</artifactId>\n  </dependency>\n  <dependency>\n   <groupId>org.springframework.boot</groupId>\n   <artifactId>spring-boot-starter-oauth2-client</artifactId>\n  </dependency>\n  <dependency>\n   <groupId>org.springframework.boot</groupId>\n   <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>\n  </dependency>\n  <dependency>\n   <groupId>org.apache.commons</groupId>\n   <artifactId>commons-collections4</artifactId>\n   <version>4.4</version>\n  </dependency>\n  <dependency>\n   <groupId>org.projectlombok</groupId>\n   <artifactId>lombok</artifactId>\n   <version>1.18.30</version>\n   <scope>provided</scope>\n  </dependency>\n </dependencies>\n\n <build>\n  <plugins>\n   <plugin>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-maven-plugin</artifactId>\n   </plugin>\n   <plugin>\n    <groupId>org.apache.maven.plugins</groupId>\n    <artifactId>maven-surefire-plugin</artifactId>\n    <version>3.2.2</version>\n   </plugin>\n  </plugins>\n </build>\n\n</project>\n```\n\nKeycloakJwtRolesResolver.java 파일은 키클로캣 액세스 토큰에서 로그인한 사용자 역할을 추출하여 GrantedAuthority 컬렉션에 저장하는 것입니다 (여기서 토큰을 디버그할 수 있습니다). 이 코드에서는 렘 역할을 구성하고 리소스 역할에 연결한 다음 대문자로 변환합니다. 결과는 ADMIN_WRITE 또는 USER_READ여야 합니다.\n\n```js\n@Slf4j\npublic class KeycloakJwtRolesConverter implements Converter<Jwt, Collection<GrantedAuthority>> {\n\n    private static final String CLAIM_REALM_ACCESS = \"realm_access\";\n    private static final String CLAIM_RESOURCE_ACCESS = \"resource_access\";\n    private static final String CLAIM_ROLES = \"roles\";\n\n    private final String kcClientId;\n\n    public KeycloakJwtRolesConverter(String kcClientId) {\n        this.kcClientId = kcClientId;\n    }\n\n    @Override\n    public Collection<GrantedAuthority> convert(Jwt jwt) {\n        Map<String, Collection<String>> realmAccess = jwt.getClaim(CLAIM_REALM_ACCESS);\n        Map<String, Map<String, Collection<String>>> resourceAccess = jwt.getClaim(CLAIM_RESOURCE_ACCESS);\n\n        Collection<GrantedAuthority> grantedAuthorities = new ArrayList<>();\n\n        if (realmAccess != null && !realmAccess.isEmpty()) {\n            Collection<String> realmRole = realmAccess.get(CLAIM_ROLES);\n            if (realmRole != null && !realmRole.isEmpty()) {\n                realmRole.forEach(r -> {\n                    if (resourceAccess != null && !resourceAccess.isEmpty() && resourceAccess.containsKey(kcClientId)) {\n                        resourceAccess.get(kcClientId).get(CLAIM_ROLES).forEach(resourceRole -> {\n                            String role = String.format(\"%s_%s\", r, resourceRole).toUpperCase(Locale.ROOT);\n                            grantedAuthorities.add(new SimpleGrantedAuthority(role));\n                        });\n                    } else {\n                        grantedAuthorities.add(new SimpleGrantedAuthority(r));\n                    }\n                });\n            }\n        }\n\n        return grantedAuthorities;\n    }\n}\n```\n\nCustomAuthenticationEntryPoint.java 파일은 요청을 인증하는 동안 예외를 처리하는 클래스이며 JSON을 반환합니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```java\n@Component\npublic class CustomAuthenticationEntryPoint implements AuthenticationEntryPoint {\n\n    @Override\n    public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException) throws IOException, ServletException {\n        response.setStatus(HttpStatus.UNAUTHORIZED.value());\n        response.setContentType(\"application/json\");\n\n        BaseResponseDto errorResponse = BaseResponseDto.builder()\n                .status(\"UNAUTHORIZED\")\n                .build();\n\n        ObjectMapper mapper = new ObjectMapper();\n        mapper.writeValue(response.getWriter(), errorResponse);\n    }\n}\n```\n\nCustomAccessDenied.java은 예외 처리를 위한 클래스입니다. 로그인한 사용자가 일부 엔드포인트에서 유효한 역할이나 권한이 없는 경우 JSON을 반환합니다.\n\n```java\n@Component\npublic class CustomAccessDenied implements AccessDeniedHandler {\n    @Override\n    public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException) throws IOException, ServletException {\n        response.setStatus(HttpStatus.FORBIDDEN.value());\n        response.setContentType(MediaType.APPLICATION_JSON_VALUE);\n\n        BaseResponseDto errorResponse = BaseResponseDto.builder()\n                .status(\"ACCESS_DENIED\")\n                .build();\n\n        ObjectMapper mapper = new ObjectMapper();\n        mapper.writeValue(response.getWriter(), errorResponse);\n    }\n}\n```\n\nWebSecurityConfiguration.java에서는 보안 구성을 정의하고, 일부 엔드포인트를 역할 확인으로 보호하며, 보안 시스템 내에서 사용자 정의 예외 처리를 어떻게 구현하는지 설명합니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\njwtDecoder() 함수는 요청에서 받은 JSON 웹 토큰(JWT)을 유효성 검사하고 해독하는 역할을 담당합니다. 이 함수는 토큰을 생성하고 서명하는 인증 서버로 가리키는 발급자를 가리킵니다.\n\ngrantedAuthorityDefaults() 함수는 우리 스프링 애플리케이션에서 \"ROLE\\_\" 접두사를 제거하는 역할을 합니다.\n\n```js\n@Slf4j\n@Configuration\n@EnableWebSecurity\npublic class WebSecurityConfiguration {\n\n    @Value(\"${keycloak.client-id}\")\n    private String kcClientId;\n\n    @Value(\"${keycloak.issuer-url}\")\n    private String tokenIssuerUrl;\n\n    @Bean\n    public SecurityFilterChain securityFilterChain(HttpSecurity http, CustomAuthenticationEntryPoint entryPoint,\n                                                   CustomAccessDenied accessDenied) throws Exception {\n\n        DelegatingJwtGrantedAuthoritiesConverter authoritiesConverter = new DelegatingJwtGrantedAuthoritiesConverter(\n                        new JwtGrantedAuthoritiesConverter(),\n                        new KeycloakJwtRolesConverter(kcClientId));\n\n        http.authorizeHttpRequests(authorizeRequests ->\n                authorizeRequests\n                    .requestMatchers(\"/home/admin/**\")\n                        .hasRole(\"ADMIN_WRITE\")\n                    .requestMatchers(\"/home/public/**\")\n                        .hasRole(\"USER_READ\")\n                    .requestMatchers(\"/auth/**\").permitAll()\n                    .anyRequest().authenticated()\n            )\n            .httpBasic()\n            .and()\n            .exceptionHandling()\n                .authenticationEntryPoint(entryPoint)\n                .accessDeniedHandler(accessDenied)\n            .and()\n            .csrf().disable()\n                .oauth2ResourceServer()\n                .jwt()\n                .jwtAuthenticationConverter(\n                        jwt -> new JwtAuthenticationToken(jwt, authoritiesConverter.convert(jwt))\n                );\n        return http.build();\n    }\n\n    @Bean\n    public JwtDecoder jwtDecoder() {\n        return JwtDecoders.fromIssuerLocation(tokenIssuerUrl);\n    }\n\n    @Bean\n    GrantedAuthorityDefaults grantedAuthorityDefaults() {\n        return new GrantedAuthorityDefaults(\"\");\n    }\n}\n```\n\nAuthService.java는 Keycloak의 엔드포인트에 요청을 보내 인증할 자격 증명을 제공하는 서비스 클래스입니다. client_id 및 client_secret 자격 증명은 Keycloak에 방금 등록한 클라이언트에서 얻었습니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n서비스에는 액세스 토큰을 가져오고 토큰을 새로 고침하는 두 가지 메서드가 있습니다. 액세스 및 새로 고침 토큰을 받았으므로 새로 고침 토큰을 Redis에 REFRESH_TOKEN 상수 키로 저장한 다음 디바이스 ID와 연결합니다. 토큰을 새로 고칠 때 Redis에서 저장할 때와 동일한 키로 가져옵니다.\n\n```js\n@Slf4j\n@Service\npublic class AuthService {\n\n    @Autowired\n    private RestTemplate restTemplate;\n\n    @Autowired\n    private SessionStorage sessionStorage;\n\n    @Value(\"${keycloak.client-id}\")\n    private String kcClientId;\n\n    @Value(\"${keycloak.client-secret}\")\n    private String kcClientSecret;\n\n    @Value(\"${keycloak.get-token-url}\")\n    private String kcGetTokenUrl;\n\n    private static final String GRANT_TYPE_PASSWORD = \"password\";\n    private static final String GRANT_TYPE_REFRESH_TOKEN = \"refresh_token\";\n\n    private static final String ACCESS_TOKEN = \"Access-Token\";\n    private static final String REFRESH_TOKEN = \"Refresh-Token\";\n    private static final String EXPIRES_IN = \"Expires-In\";\n    private static final String DEVICE_ID = \"Device-Id\";\n\n    public ResponseEntity<Object> login(LoginRequestDto request, HttpServletRequest servletRequest, HttpServletResponse servletResponse) {\n        log.info(\"액세스 토큰을 가져오기 시작\");\n\n        String deviceId = servletRequest.getHeader(DEVICE_ID);\n\n        TokenDto tokenDto = this.getAccessToken(request);\n\n        servletResponse.addHeader(ACCESS_TOKEN, tokenDto.getAccessToken());\n        servletResponse.addHeader(EXPIRES_IN, String.valueOf(tokenDto.getExpiresIn()));\n\n        sessionStorage.putCache(REFRESH_TOKEN, deviceId, tokenDto.getRefreshToken(), 1800);\n\n        return ResponseEntity.ok().body(BaseResponseDto.builder()\n                .status(\"SUCCESS\")\n                .build());\n    }\n\n    public ResponseEntity<Object> refreshToken(HttpServletRequest servletRequest, HttpServletResponse servletResponse) {\n        log.info(\"액세스 토큰을 새로 고침하기 시작\");\n\n        String deviceId = servletRequest.getHeader(DEVICE_ID);\n        String refreshToken = (String) sessionStorage.getCache(REFRESH_TOKEN, deviceId);\n\n        TokenDto tokenDto = this.getRefreshToken(refreshToken);\n\n        servletResponse.addHeader(ACCESS_TOKEN, tokenDto.getAccessToken());\n        servletResponse.addHeader(EXPIRES_IN, String.valueOf(tokenDto.getExpiresIn()));\n\n        sessionStorage.putCache(REFRESH_TOKEN, deviceId, tokenDto.getRefreshToken(), tokenDto.getRefreshExpiresIn());\n\n        return ResponseEntity.ok().body(BaseResponseDto.builder()\n                .status(\"SUCCESS\")\n                .build());\n    }\n\n    private TokenDto getAccessToken(LoginRequestDto request) {\n        HttpHeaders headers = new HttpHeaders();\n        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);\n\n        MultiValueMap<String, String> requestBody = new LinkedMultiValueMap<>();\n        requestBody.add(\"grant_type\", GRANT_TYPE_PASSWORD);\n        requestBody.add(\"client_id\", kcClientId);\n        requestBody.add(\"client_secret\", kcClientSecret);\n        requestBody.add(\"username\", request.getUsername());\n        requestBody.add(\"password\", request.getPassword());\n\n        ResponseEntity<TokenDto> response = restTemplate.postForEntity(kcGetTokenUrl,\n                new HttpEntity<>(requestBody, headers), TokenDto.class);\n\n        return response.getBody();\n    }\n\n    private TokenDto getRefreshToken(String refreshToken) {\n        HttpHeaders headers = new HttpHeaders();\n        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);\n\n        MultiValueMap<String, String> requestBody = new LinkedMultiValueMap<>();\n        requestBody.add(\"grant_type\", GRANT_TYPE_REFRESH_TOKEN);\n        requestBody.add(\"refresh_token\", refreshToken);\n        requestBody.add(\"client_id\", kcClientId);\n        requestBody.add(\"client_secret\", kcClientSecret);\n\n        ResponseEntity<TokenDto> response = restTemplate.postForEntity(kcGetTokenUrl,\n                new HttpEntity<>(requestBody, headers), TokenDto.class);\n\n        return response.getBody();\n    }\n}\n```\n\nAuthController.java\n\n```js\n@RestController\n@RequestMapping(value = \"/auth\")\npublic class AuthController {\n\n    @Autowired\n    private AuthService authService;\n\n    @PostMapping(value = \"/login\")\n    public ResponseEntity<Object> login(@RequestBody LoginRequestDto request, HttpServletRequest servletRequest,\n                                        HttpServletResponse servletResponse) {\n        return authService.login(request, servletRequest, servletResponse);\n    }\n\n    @PostMapping(value = \"/refresh-token\")\n    public ResponseEntity<Object> refreshToken(HttpServletRequest servletRequest, HttpServletResponse servletResponse) {\n        return authService.refreshToken(servletRequest, servletResponse);\n    }\n}\n```\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\nHomeController.java에는 USER 역할로 로그인한 사용자를 위한 공개 엔드포인트 및 ADMIN 역할을 위한 /admin을 처리하는 컨트롤러가 있습니다.\n\n```java\n@RestController\n@RequestMapping(value = \"/home\")\npublic class HomeController {\n\n    @GetMapping(value = \"/public\")\n    public ResponseEntity<Object> home() {\n        return new ResponseEntity<>(\"PAGE_PUBLIC\", HttpStatus.OK);\n    }\n\n    @GetMapping(value = \"/admin\")\n    public ResponseEntity<Object> homeAdmin() {\n        return new ResponseEntity<>(\"PAGE_ADMIN\", HttpStatus.OK);\n    }\n}\n```\n\n테스트\n\n새로 등록한 사용자 자격 증명으로 /api/auth/login 엔드 포인트에 로그인하세요.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\ncurl을 사용하여 테이블로 admin 엔드포인트로 이동 가능합니다.\n\n```js\ncurl --location 'http://localhost:8085/api/auth/login' \\\n--header 'Device-Id: example-my-device-id' \\\n--header 'Content-Type: application/json' \\\n--data '{\n    \"username\": \"userdemo\",\n    \"password\": \"useruser123\"\n}'\n```\n\nadmin 엔드포인트로 이동하는 curl입니다.\n\n```js\ncurl --location 'http://localhost:8085/api/home/admin' \\\n--header 'Authorization: Bearer $access_token'\n\n# 페이지_ADMIN을 반환해야 함\n```\n\npublic 엔드포인트로 이동하는 curl입니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```js\ncurl --location 'http://localhost:8085/api/home/public' \\\n--header 'Authorization: Bearer $access_token'\n\n# 페이지_PUBLIC이 반환되어야합니다\n```\n\n사용자가 역할에 맞지 않는 엔드포인트에 액세스하려고하면 403 — 금지로 반환되어야 합니다.\n\n새로 고침 토큰 엔드포인트를 호출하여 리프레시 토큰을 갱신하고 액세스 토큰을 받아옵니다.\n\n```js\ncurl --location --request POST 'http://localhost:8085/api/auth/refresh-token' \\\n--header 'Device-Id: example-my-device-id'\n```\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n업그레이드\n동일한 보안 구성을 적용하는 여러 서비스가 있다면, KeycloakJwtRolesResolver.java를 복제하고 중복 코드를 만드는 것은 좋지 않습니다. 더 나은 접근 방식은 해당 클래스를 독립된 스프링 프로젝트로 분리하는 것입니다. 이 프로젝트를 모듈-공통이라고 부르고, 다른 서비스에 공통으로 사용되는 클래스나 기능을 수용하도록 합니다.\n","ogImage":{"url":"/assets/img/2024-06-23-SecuringSpringBootwithKeycloak_0.png"},"coverImage":"/assets/img/2024-06-23-SecuringSpringBootwithKeycloak_0.png","tag":["Tech"],"readingTime":22},"content":"<!doctype html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\">\n<meta content=\"width=device-width, initial-scale=1\" name=\"viewport\">\n</head>\n<body>\n<p><img src=\"/assets/img/2024-06-23-SecuringSpringBootwithKeycloak_0.png\" alt=\"사진\"></p>\n<p>개요\n우리 애플리케이션을 안전하게 보호하는 것은 요즘 큰 걱정이자 도전입니다. 처음부터 구축하는 것은 더 어려울 수 있고 더 많은 시간이 소요될 수 있습니다. 따라서 우리는 IDP(Identity Provider) 도구인 Keycloak과 같이 애플리케이션의 인가 서버로 구현할 수 있습니다.</p>\n<p>Keycloak이란</p>\n<p>Keycloak은 레드햇에서 개발된 오픈 소스 식별 및 액세스 관리 도구입니다. 쉬운 설정 및 애플리케이션 통합으로 여러분이 직접 모든 것을 맞춤 설정하는 것보다 훨씬 많은 시간을 절약할 수 있습니다.</p>\n<p></p>\n<p>많은 회사에서 이미 보안 구성 요소로 채택되어 있어서 도구들이 검증되었고 더욱 신뢰할 수 있는 상태로 구현되어 있습니다. 많은 회사가 Keycloak을 사용하기 때문에 학습 자료를 쉽게 얻고 인터넷에서 의논할 수 있습니다.</p>\n<p>주요 기능을 갖고 있기 때문에 비즈니스나 보안 흐름에 대응해야 할 경우 애플리케이션을 미래에 대비하여 더 확장 가능하게 만들 수 있습니다.</p>\n<p>구현\nKeycloak를 구현하는 여러 방법이 있습니다. 예를 들어 SSO, 소셜 미디어 로그인 또는 액세스 토큰을 얻기 위해 API에 접근하는 방법이 있습니다.</p>\n<p>우리는 필요에 따라 구현이 필요한 사용자 정의 흐름을 처리하는 독립된 인증 서비스를 사용하여 구현할 것이지만, 자격 증명 자체를 인증하는 데 Keycloak가 책임을 집니다. 그리고 서비스 레이어의 리소스 서버에서 토큰을 확인합니다.</p>\n<p></p>\n<p>시스템 다이어그램</p>\n<p><img src=\"/assets/img/2024-06-23-SecuringSpringBootwithKeycloak_1.png\" alt=\"image\"></p>\n<p>사용자는 자격 증명을 제출하고, 이는 인증 서비스에서 처리되어 Keycloak 측에서 유효성이 검사됩니다. 자격 증명이 유효한 경우, Keycloak은 액세스 토큰을 반환하고, 유효하지 않은 경우 응답 401 — 권한 없음을 반환합니다.</p>\n<p>물론 애플리케이션 클라이언트(FE 또는 모바일 앱)에게 다시 원시 응답을 반환하지는 않겠습니다. 인증 서비스에서 응답을 표준화하여 처리할 것입니다.</p>\n<p></p>\n<p>Keycloak 설치 및 설정\n다음 yml 파일을 사용하여 도커 컴포즈로 Keycloak을 설치하고 구성하세요:</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-attr\">version</span>: <span class=\"hljs-string\">\"3\"</span>\n\n<span class=\"hljs-attr\">services</span>:\n  <span class=\"hljs-attr\">keycloak</span>:\n    <span class=\"hljs-attr\">image</span>: quay.<span class=\"hljs-property\">io</span>/keycloak/<span class=\"hljs-attr\">keycloak</span>:<span class=\"hljs-number\">20.0</span><span class=\"hljs-number\">.0</span>\n    <span class=\"hljs-attr\">command</span>: start-dev\n    <span class=\"hljs-attr\">environment</span>:\n      <span class=\"hljs-attr\">KC_DB</span>: postgres\n      <span class=\"hljs-attr\">KC_DB_URL_HOST</span>: postgres\n      <span class=\"hljs-attr\">KC_DB_URL_DATABASE</span>: keycloak_v1\n      <span class=\"hljs-attr\">KC_DB_PASSWORD</span>: root\n      <span class=\"hljs-attr\">KC_DB_USERNAME</span>: postgres\n      <span class=\"hljs-attr\">KC_DB_SCHEMA</span>: public\n      <span class=\"hljs-attr\">KEYCLOAK_ADMIN</span>: admin\n      <span class=\"hljs-attr\">KEYCLOAK_ADMIN_PASSWORD</span>: admin\n      <span class=\"hljs-attr\">KEYCLOAK_JDBC_PARAMS</span>: <span class=\"hljs-string\">'sslmode=require'</span>\n    <span class=\"hljs-attr\">ports</span>:\n      - <span class=\"hljs-string\">\"9090:8080\"</span>\n    <span class=\"hljs-attr\">depends_on</span>:\n      <span class=\"hljs-attr\">postgres</span>:\n        <span class=\"hljs-attr\">condition</span>: service_healthy\n    <span class=\"hljs-attr\">networks</span>:\n      <span class=\"hljs-attr\">network_sso</span>:\n\n  <span class=\"hljs-attr\">postgres</span>:\n    <span class=\"hljs-attr\">image</span>: <span class=\"hljs-attr\">postgres</span>:<span class=\"hljs-number\">10</span>\n    <span class=\"hljs-attr\">command</span>: [<span class=\"hljs-string\">\"postgres\"</span>, <span class=\"hljs-string\">\"-c\"</span>, <span class=\"hljs-string\">\"max_connections=200\"</span>, <span class=\"hljs-string\">\"-c\"</span>, <span class=\"hljs-string\">\"shared_buffers=24MB\"</span>, <span class=\"hljs-string\">\"-c\"</span>, <span class=\"hljs-string\">\"listen_addresses=*\"</span>]\n    <span class=\"hljs-attr\">environment</span>:\n      <span class=\"hljs-attr\">POSTGRES_DB</span>: keycloak_v1\n      <span class=\"hljs-attr\">POSTGRES_USER</span>: postgres\n      <span class=\"hljs-attr\">POSTGRES_PASSWORD</span>: root\n    <span class=\"hljs-attr\">healthcheck</span>:\n      <span class=\"hljs-attr\">test</span>: <span class=\"hljs-string\">\"exit 0\"</span>\n    <span class=\"hljs-attr\">ports</span>:\n      - <span class=\"hljs-string\">\"5436:5432\"</span>\n    <span class=\"hljs-attr\">networks</span>:\n      <span class=\"hljs-attr\">network_sso</span>:\n    <span class=\"hljs-attr\">volumes</span>:\n      - <span class=\"hljs-attr\">postgres_data</span>:<span class=\"hljs-regexp\">/var/</span>lib/postgresql/data\n    <span class=\"hljs-attr\">user</span>: postgres\n\n  <span class=\"hljs-attr\">redis</span>:\n    <span class=\"hljs-attr\">image</span>: <span class=\"hljs-attr\">redis</span>:latest\n    <span class=\"hljs-attr\">ports</span>:\n      - <span class=\"hljs-string\">\"6379:6379\"</span>\n    <span class=\"hljs-attr\">environment</span>:\n      <span class=\"hljs-attr\">REDIS_PASSWORD</span>: <span class=\"hljs-string\">\"root\"</span>\n    <span class=\"hljs-attr\">volumes</span>:\n      - <span class=\"hljs-attr\">redis_data</span>:/data\n\n<span class=\"hljs-attr\">volumes</span>:\n  <span class=\"hljs-attr\">postgres_data</span>:\n  <span class=\"hljs-attr\">redis_data</span>:\n\n<span class=\"hljs-attr\">networks</span>:\n  <span class=\"hljs-attr\">network_sso</span>:\n</code></pre>\n<p>저희 Keycloak 애플리케이션에서 사용자 저장소로 postgres 데이터베이스를 사용하세요. “docker-compose up”을 실행한 후 <a href=\"http://localhost:9090%EC%97%90\" rel=\"nofollow\" target=\"_blank\">http://localhost:9090에</a> 액세스하고 다음 자격 증명으로 로그인하세요:</p>\n<p>계층을 만들고 원하는 대로 계층 이름 폼을 작성하세요.</p>\n<p></p>\n<p><img src=\"/assets/img/2024-06-23-SecuringSpringBootwithKeycloak_2.png\" alt=\"이미지\"></p>\n<p>이 구성대로 클라이언트를 계속 생성하세요.</p>\n<p><img src=\"/assets/img/2024-06-23-SecuringSpringBootwithKeycloak_3.png\" alt=\"이미지\"></p>\n<p><img src=\"/assets/img/2024-06-23-SecuringSpringBootwithKeycloak_4.png\" alt=\"이미지\"></p>\n<p></p>\n<p>클라이언트를 성공적으로 생성한 후, 클라이언트 비밀키를 복사하려면 클라이언트 자격 증명 탭으로 이동하세요.</p>\n<p>사용자를 생성하고 사용자 자격 증명 또는 암호를 설정한 후, 임시 암호 토글을 비활성화해야 합니다. userdemo와 admindemo 두 명의 사용자를 생성하세요.</p>\n<p><img src=\"/assets/img/2024-06-23-SecuringSpringBootwithKeycloak_5.png\" alt=\"이미지\"></p>\n<p>역할 할당</p>\n<p></p>\n<p>키클로크에는 렘 역할과 리소스 클라이언트 역할이 있어요. 둘 다 서로 다른 책임과 동작을 가지고 있어요.</p>\n<p>렘 역할을 만들어 보세요, \"admin\"과 \"user\"와 같이요.</p>\n<p><img src=\"/assets/img/2024-06-23-SecuringSpringBootwithKeycloak_6.png\" alt=\"image\"></p>\n<p>리소스 클라이언트 역할도 만들어 보세요, \"write\"와 \"read\" 같은 역할을 만들어 보세요.</p>\n<p></p>\n<p>사용자 메뉴로 이동해서 사용자 'admindemo'에게 'admin' 및 'write' 역할을 할당하고, 'userdemo'에게 'user' 및 'read' 역할을 할당하세요.</p>\n<p>코드 구현\nSpring 프로젝트를 초기화하고, pom.xml에 다음 종속성을 추가하세요.</p>\n<p></p>\n<pre><code class=\"hljs language-js\">&#x3C;?xml version=<span class=\"hljs-string\">\"1.0\"</span> encoding=<span class=\"hljs-string\">\"UTF-8\"</span>?>\n<span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">project</span> <span class=\"hljs-attr\">xmlns</span>=<span class=\"hljs-string\">\"http://maven.apache.org/POM/4.0.0\"</span> <span class=\"hljs-attr\">xmlns:xsi</span>=<span class=\"hljs-string\">\"http://www.w3.org/2001/XMLSchema-instance\"</span>\n <span class=\"hljs-attr\">xsi:schemaLocation</span>=<span class=\"hljs-string\">\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\"</span>></span>\n <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">modelVersion</span>></span>4.0.0<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">modelVersion</span>></span>\n <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">parent</span>></span>\n  <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">groupId</span>></span>org.springframework.boot<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">groupId</span>></span>\n  <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">artifactId</span>></span>spring-boot-starter-parent<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">artifactId</span>></span>\n  <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">version</span>></span>3.2.2<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">version</span>></span>\n <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">parent</span>></span>\n <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">artifactId</span>></span>auth-service<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">artifactId</span>></span>\n <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">version</span>></span>0.0.1-SNAPSHOT<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">version</span>></span>\n <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">name</span>></span>auth-service<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">name</span>></span>\n <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">description</span>></span>Demo project for Spring Boot<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">description</span>></span>\n <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">properties</span>></span>\n  <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">java.version</span>></span>17<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">java.version</span>></span>\n <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">properties</span>></span>\n <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">dependencies</span>></span>\n  <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">dependency</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">groupId</span>></span>org.springframework.boot<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">groupId</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">artifactId</span>></span>spring-boot-starter-web<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">artifactId</span>></span>\n  <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">dependency</span>></span>\n  <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">dependency</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">groupId</span>></span>org.springframework.boot<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">groupId</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">artifactId</span>></span>spring-boot-starter-security<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">artifactId</span>></span>\n  <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">dependency</span>></span>\n  <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">dependency</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">groupId</span>></span>org.springframework.boot<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">groupId</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">artifactId</span>></span>spring-boot-starter-oauth2-client<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">artifactId</span>></span>\n  <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">dependency</span>></span>\n  <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">dependency</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">groupId</span>></span>org.springframework.boot<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">groupId</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">artifactId</span>></span>spring-boot-starter-oauth2-resource-server<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">artifactId</span>></span>\n  <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">dependency</span>></span>\n  <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">dependency</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">groupId</span>></span>org.apache.commons<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">groupId</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">artifactId</span>></span>commons-collections4<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">artifactId</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">version</span>></span>4.4<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">version</span>></span>\n  <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">dependency</span>></span>\n  <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">dependency</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">groupId</span>></span>org.projectlombok<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">groupId</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">artifactId</span>></span>lombok<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">artifactId</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">version</span>></span>1.18.30<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">version</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">scope</span>></span>provided<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">scope</span>></span>\n  <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">dependency</span>></span>\n <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">dependencies</span>></span>\n\n <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">build</span>></span>\n  <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">plugins</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">plugin</span>></span>\n    <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">groupId</span>></span>org.springframework.boot<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">groupId</span>></span>\n    <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">artifactId</span>></span>spring-boot-maven-plugin<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">artifactId</span>></span>\n   <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">plugin</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">plugin</span>></span>\n    <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">groupId</span>></span>org.apache.maven.plugins<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">groupId</span>></span>\n    <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">artifactId</span>></span>maven-surefire-plugin<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">artifactId</span>></span>\n    <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">version</span>></span>3.2.2<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">version</span>></span>\n   <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">plugin</span>></span>\n  <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">plugins</span>></span>\n <span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">build</span>></span>\n\n<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">project</span>></span></span>\n</code></pre>\n<p>KeycloakJwtRolesResolver.java 파일은 키클로캣 액세스 토큰에서 로그인한 사용자 역할을 추출하여 GrantedAuthority 컬렉션에 저장하는 것입니다 (여기서 토큰을 디버그할 수 있습니다). 이 코드에서는 렘 역할을 구성하고 리소스 역할에 연결한 다음 대문자로 변환합니다. 결과는 ADMIN_WRITE 또는 USER_READ여야 합니다.</p>\n<pre><code class=\"hljs language-js\">@<span class=\"hljs-title class_\">Slf4</span>j\npublic <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">KeycloakJwtRolesConverter</span> implements <span class=\"hljs-title class_\">Converter</span>&#x3C;<span class=\"hljs-title class_\">Jwt</span>, <span class=\"hljs-title class_\">Collection</span>&#x3C;<span class=\"hljs-title class_\">GrantedAuthority</span>>> {\n\n    private <span class=\"hljs-keyword\">static</span> final <span class=\"hljs-title class_\">String</span> <span class=\"hljs-variable constant_\">CLAIM_REALM_ACCESS</span> = <span class=\"hljs-string\">\"realm_access\"</span>;\n    private <span class=\"hljs-keyword\">static</span> final <span class=\"hljs-title class_\">String</span> <span class=\"hljs-variable constant_\">CLAIM_RESOURCE_ACCESS</span> = <span class=\"hljs-string\">\"resource_access\"</span>;\n    private <span class=\"hljs-keyword\">static</span> final <span class=\"hljs-title class_\">String</span> <span class=\"hljs-variable constant_\">CLAIM_ROLES</span> = <span class=\"hljs-string\">\"roles\"</span>;\n\n    private final <span class=\"hljs-title class_\">String</span> kcClientId;\n\n    public <span class=\"hljs-title class_\">KeycloakJwtRolesConverter</span>(<span class=\"hljs-title class_\">String</span> kcClientId) {\n        <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">kcClientId</span> = kcClientId;\n    }\n\n    @<span class=\"hljs-title class_\">Override</span>\n    public <span class=\"hljs-title class_\">Collection</span>&#x3C;<span class=\"hljs-title class_\">GrantedAuthority</span>> <span class=\"hljs-title function_\">convert</span>(<span class=\"hljs-params\">Jwt jwt</span>) {\n        <span class=\"hljs-title class_\">Map</span>&#x3C;<span class=\"hljs-title class_\">String</span>, <span class=\"hljs-title class_\">Collection</span>&#x3C;<span class=\"hljs-title class_\">String</span>>> realmAccess = jwt.<span class=\"hljs-title function_\">getClaim</span>(<span class=\"hljs-variable constant_\">CLAIM_REALM_ACCESS</span>);\n        <span class=\"hljs-title class_\">Map</span>&#x3C;<span class=\"hljs-title class_\">String</span>, <span class=\"hljs-title class_\">Map</span>&#x3C;<span class=\"hljs-title class_\">String</span>, <span class=\"hljs-title class_\">Collection</span>&#x3C;<span class=\"hljs-title class_\">String</span>>>> resourceAccess = jwt.<span class=\"hljs-title function_\">getClaim</span>(<span class=\"hljs-variable constant_\">CLAIM_RESOURCE_ACCESS</span>);\n\n        <span class=\"hljs-title class_\">Collection</span>&#x3C;<span class=\"hljs-title class_\">GrantedAuthority</span>> grantedAuthorities = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">ArrayList</span>&#x3C;>();\n\n        <span class=\"hljs-keyword\">if</span> (realmAccess != <span class=\"hljs-literal\">null</span> &#x26;&#x26; !realmAccess.<span class=\"hljs-title function_\">isEmpty</span>()) {\n            <span class=\"hljs-title class_\">Collection</span>&#x3C;<span class=\"hljs-title class_\">String</span>> realmRole = realmAccess.<span class=\"hljs-title function_\">get</span>(<span class=\"hljs-variable constant_\">CLAIM_ROLES</span>);\n            <span class=\"hljs-keyword\">if</span> (realmRole != <span class=\"hljs-literal\">null</span> &#x26;&#x26; !realmRole.<span class=\"hljs-title function_\">isEmpty</span>()) {\n                realmRole.<span class=\"hljs-title function_\">forEach</span>(r -> {\n                    <span class=\"hljs-keyword\">if</span> (resourceAccess != <span class=\"hljs-literal\">null</span> &#x26;&#x26; !resourceAccess.<span class=\"hljs-title function_\">isEmpty</span>() &#x26;&#x26; resourceAccess.<span class=\"hljs-title function_\">containsKey</span>(kcClientId)) {\n                        resourceAccess.<span class=\"hljs-title function_\">get</span>(kcClientId).<span class=\"hljs-title function_\">get</span>(<span class=\"hljs-variable constant_\">CLAIM_ROLES</span>).<span class=\"hljs-title function_\">forEach</span>(resourceRole -> {\n                            <span class=\"hljs-title class_\">String</span> role = <span class=\"hljs-title class_\">String</span>.<span class=\"hljs-title function_\">format</span>(<span class=\"hljs-string\">\"%s_%s\"</span>, r, resourceRole).<span class=\"hljs-title function_\">toUpperCase</span>(<span class=\"hljs-title class_\">Locale</span>.<span class=\"hljs-property\">ROOT</span>);\n                            grantedAuthorities.<span class=\"hljs-title function_\">add</span>(<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">SimpleGrantedAuthority</span>(role));\n                        });\n                    } <span class=\"hljs-keyword\">else</span> {\n                        grantedAuthorities.<span class=\"hljs-title function_\">add</span>(<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">SimpleGrantedAuthority</span>(r));\n                    }\n                });\n            }\n        }\n\n        <span class=\"hljs-keyword\">return</span> grantedAuthorities;\n    }\n}\n</code></pre>\n<p>CustomAuthenticationEntryPoint.java 파일은 요청을 인증하는 동안 예외를 처리하는 클래스이며 JSON을 반환합니다.</p>\n<p></p>\n<pre><code class=\"hljs language-java\"><span class=\"hljs-meta\">@Component</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">CustomAuthenticationEntryPoint</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title class_\">AuthenticationEntryPoint</span> {\n\n    <span class=\"hljs-meta\">@Override</span>\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title function_\">commence</span><span class=\"hljs-params\">(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException)</span> <span class=\"hljs-keyword\">throws</span> IOException, ServletException {\n        response.setStatus(HttpStatus.UNAUTHORIZED.value());\n        response.setContentType(<span class=\"hljs-string\">\"application/json\"</span>);\n\n        <span class=\"hljs-type\">BaseResponseDto</span> <span class=\"hljs-variable\">errorResponse</span> <span class=\"hljs-operator\">=</span> BaseResponseDto.builder()\n                .status(<span class=\"hljs-string\">\"UNAUTHORIZED\"</span>)\n                .build();\n\n        <span class=\"hljs-type\">ObjectMapper</span> <span class=\"hljs-variable\">mapper</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">ObjectMapper</span>();\n        mapper.writeValue(response.getWriter(), errorResponse);\n    }\n}\n</code></pre>\n<p>CustomAccessDenied.java은 예외 처리를 위한 클래스입니다. 로그인한 사용자가 일부 엔드포인트에서 유효한 역할이나 권한이 없는 경우 JSON을 반환합니다.</p>\n<pre><code class=\"hljs language-java\"><span class=\"hljs-meta\">@Component</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">CustomAccessDenied</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title class_\">AccessDeniedHandler</span> {\n    <span class=\"hljs-meta\">@Override</span>\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title function_\">handle</span><span class=\"hljs-params\">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException)</span> <span class=\"hljs-keyword\">throws</span> IOException, ServletException {\n        response.setStatus(HttpStatus.FORBIDDEN.value());\n        response.setContentType(MediaType.APPLICATION_JSON_VALUE);\n\n        <span class=\"hljs-type\">BaseResponseDto</span> <span class=\"hljs-variable\">errorResponse</span> <span class=\"hljs-operator\">=</span> BaseResponseDto.builder()\n                .status(<span class=\"hljs-string\">\"ACCESS_DENIED\"</span>)\n                .build();\n\n        <span class=\"hljs-type\">ObjectMapper</span> <span class=\"hljs-variable\">mapper</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">ObjectMapper</span>();\n        mapper.writeValue(response.getWriter(), errorResponse);\n    }\n}\n</code></pre>\n<p>WebSecurityConfiguration.java에서는 보안 구성을 정의하고, 일부 엔드포인트를 역할 확인으로 보호하며, 보안 시스템 내에서 사용자 정의 예외 처리를 어떻게 구현하는지 설명합니다.</p>\n<p></p>\n<p>jwtDecoder() 함수는 요청에서 받은 JSON 웹 토큰(JWT)을 유효성 검사하고 해독하는 역할을 담당합니다. 이 함수는 토큰을 생성하고 서명하는 인증 서버로 가리키는 발급자를 가리킵니다.</p>\n<p>grantedAuthorityDefaults() 함수는 우리 스프링 애플리케이션에서 \"ROLE_\" 접두사를 제거하는 역할을 합니다.</p>\n<pre><code class=\"hljs language-js\">@<span class=\"hljs-title class_\">Slf4</span>j\n@<span class=\"hljs-title class_\">Configuration</span>\n@<span class=\"hljs-title class_\">EnableWebSecurity</span>\npublic <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">WebSecurityConfiguration</span> {\n\n    @<span class=\"hljs-title class_\">Value</span>(<span class=\"hljs-string\">\"${keycloak.client-id}\"</span>)\n    private <span class=\"hljs-title class_\">String</span> kcClientId;\n\n    @<span class=\"hljs-title class_\">Value</span>(<span class=\"hljs-string\">\"${keycloak.issuer-url}\"</span>)\n    private <span class=\"hljs-title class_\">String</span> tokenIssuerUrl;\n\n    @<span class=\"hljs-title class_\">Bean</span>\n    public <span class=\"hljs-title class_\">SecurityFilterChain</span> <span class=\"hljs-title function_\">securityFilterChain</span>(<span class=\"hljs-title class_\">HttpSecurity</span> http, <span class=\"hljs-title class_\">CustomAuthenticationEntryPoint</span> entryPoint,\n                                                   <span class=\"hljs-title class_\">CustomAccessDenied</span> accessDenied) throws <span class=\"hljs-title class_\">Exception</span> {\n\n        <span class=\"hljs-title class_\">DelegatingJwtGrantedAuthoritiesConverter</span> authoritiesConverter = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">DelegatingJwtGrantedAuthoritiesConverter</span>(\n                        <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">JwtGrantedAuthoritiesConverter</span>(),\n                        <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">KeycloakJwtRolesConverter</span>(kcClientId));\n\n        http.<span class=\"hljs-title function_\">authorizeHttpRequests</span>(authorizeRequests ->\n                authorizeRequests\n                    .<span class=\"hljs-title function_\">requestMatchers</span>(<span class=\"hljs-string\">\"/home/admin/**\"</span>)\n                        .<span class=\"hljs-title function_\">hasRole</span>(<span class=\"hljs-string\">\"ADMIN_WRITE\"</span>)\n                    .<span class=\"hljs-title function_\">requestMatchers</span>(<span class=\"hljs-string\">\"/home/public/**\"</span>)\n                        .<span class=\"hljs-title function_\">hasRole</span>(<span class=\"hljs-string\">\"USER_READ\"</span>)\n                    .<span class=\"hljs-title function_\">requestMatchers</span>(<span class=\"hljs-string\">\"/auth/**\"</span>).<span class=\"hljs-title function_\">permitAll</span>()\n                    .<span class=\"hljs-title function_\">anyRequest</span>().<span class=\"hljs-title function_\">authenticated</span>()\n            )\n            .<span class=\"hljs-title function_\">httpBasic</span>()\n            .<span class=\"hljs-title function_\">and</span>()\n            .<span class=\"hljs-title function_\">exceptionHandling</span>()\n                .<span class=\"hljs-title function_\">authenticationEntryPoint</span>(entryPoint)\n                .<span class=\"hljs-title function_\">accessDeniedHandler</span>(accessDenied)\n            .<span class=\"hljs-title function_\">and</span>()\n            .<span class=\"hljs-title function_\">csrf</span>().<span class=\"hljs-title function_\">disable</span>()\n                .<span class=\"hljs-title function_\">oauth2ResourceServer</span>()\n                .<span class=\"hljs-title function_\">jwt</span>()\n                .<span class=\"hljs-title function_\">jwtAuthenticationConverter</span>(\n                        jwt -> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">JwtAuthenticationToken</span>(jwt, authoritiesConverter.<span class=\"hljs-title function_\">convert</span>(jwt))\n                );\n        <span class=\"hljs-keyword\">return</span> http.<span class=\"hljs-title function_\">build</span>();\n    }\n\n    @<span class=\"hljs-title class_\">Bean</span>\n    public <span class=\"hljs-title class_\">JwtDecoder</span> <span class=\"hljs-title function_\">jwtDecoder</span>(<span class=\"hljs-params\"></span>) {\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title class_\">JwtDecoders</span>.<span class=\"hljs-title function_\">fromIssuerLocation</span>(tokenIssuerUrl);\n    }\n\n    @<span class=\"hljs-title class_\">Bean</span>\n    <span class=\"hljs-title class_\">GrantedAuthorityDefaults</span> <span class=\"hljs-title function_\">grantedAuthorityDefaults</span>(<span class=\"hljs-params\"></span>) {\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">GrantedAuthorityDefaults</span>(<span class=\"hljs-string\">\"\"</span>);\n    }\n}\n</code></pre>\n<p>AuthService.java는 Keycloak의 엔드포인트에 요청을 보내 인증할 자격 증명을 제공하는 서비스 클래스입니다. client_id 및 client_secret 자격 증명은 Keycloak에 방금 등록한 클라이언트에서 얻었습니다.</p>\n<p></p>\n<p>서비스에는 액세스 토큰을 가져오고 토큰을 새로 고침하는 두 가지 메서드가 있습니다. 액세스 및 새로 고침 토큰을 받았으므로 새로 고침 토큰을 Redis에 REFRESH_TOKEN 상수 키로 저장한 다음 디바이스 ID와 연결합니다. 토큰을 새로 고칠 때 Redis에서 저장할 때와 동일한 키로 가져옵니다.</p>\n<pre><code class=\"hljs language-js\">@<span class=\"hljs-title class_\">Slf4</span>j\n@<span class=\"hljs-title class_\">Service</span>\npublic <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">AuthService</span> {\n\n    @<span class=\"hljs-title class_\">Autowired</span>\n    private <span class=\"hljs-title class_\">RestTemplate</span> restTemplate;\n\n    @<span class=\"hljs-title class_\">Autowired</span>\n    private <span class=\"hljs-title class_\">SessionStorage</span> <span class=\"hljs-variable language_\">sessionStorage</span>;\n\n    @<span class=\"hljs-title class_\">Value</span>(<span class=\"hljs-string\">\"${keycloak.client-id}\"</span>)\n    private <span class=\"hljs-title class_\">String</span> kcClientId;\n\n    @<span class=\"hljs-title class_\">Value</span>(<span class=\"hljs-string\">\"${keycloak.client-secret}\"</span>)\n    private <span class=\"hljs-title class_\">String</span> kcClientSecret;\n\n    @<span class=\"hljs-title class_\">Value</span>(<span class=\"hljs-string\">\"${keycloak.get-token-url}\"</span>)\n    private <span class=\"hljs-title class_\">String</span> kcGetTokenUrl;\n\n    private <span class=\"hljs-keyword\">static</span> final <span class=\"hljs-title class_\">String</span> <span class=\"hljs-variable constant_\">GRANT_TYPE_PASSWORD</span> = <span class=\"hljs-string\">\"password\"</span>;\n    private <span class=\"hljs-keyword\">static</span> final <span class=\"hljs-title class_\">String</span> <span class=\"hljs-variable constant_\">GRANT_TYPE_REFRESH_TOKEN</span> = <span class=\"hljs-string\">\"refresh_token\"</span>;\n\n    private <span class=\"hljs-keyword\">static</span> final <span class=\"hljs-title class_\">String</span> <span class=\"hljs-variable constant_\">ACCESS_TOKEN</span> = <span class=\"hljs-string\">\"Access-Token\"</span>;\n    private <span class=\"hljs-keyword\">static</span> final <span class=\"hljs-title class_\">String</span> <span class=\"hljs-variable constant_\">REFRESH_TOKEN</span> = <span class=\"hljs-string\">\"Refresh-Token\"</span>;\n    private <span class=\"hljs-keyword\">static</span> final <span class=\"hljs-title class_\">String</span> <span class=\"hljs-variable constant_\">EXPIRES_IN</span> = <span class=\"hljs-string\">\"Expires-In\"</span>;\n    private <span class=\"hljs-keyword\">static</span> final <span class=\"hljs-title class_\">String</span> <span class=\"hljs-variable constant_\">DEVICE_ID</span> = <span class=\"hljs-string\">\"Device-Id\"</span>;\n\n    public <span class=\"hljs-title class_\">ResponseEntity</span>&#x3C;<span class=\"hljs-title class_\">Object</span>> <span class=\"hljs-title function_\">login</span>(<span class=\"hljs-params\">LoginRequestDto request, HttpServletRequest servletRequest, HttpServletResponse servletResponse</span>) {\n        log.<span class=\"hljs-title function_\">info</span>(<span class=\"hljs-string\">\"액세스 토큰을 가져오기 시작\"</span>);\n\n        <span class=\"hljs-title class_\">String</span> deviceId = servletRequest.<span class=\"hljs-title function_\">getHeader</span>(<span class=\"hljs-variable constant_\">DEVICE_ID</span>);\n\n        <span class=\"hljs-title class_\">TokenDto</span> tokenDto = <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-title function_\">getAccessToken</span>(request);\n\n        servletResponse.<span class=\"hljs-title function_\">addHeader</span>(<span class=\"hljs-variable constant_\">ACCESS_TOKEN</span>, tokenDto.<span class=\"hljs-title function_\">getAccessToken</span>());\n        servletResponse.<span class=\"hljs-title function_\">addHeader</span>(<span class=\"hljs-variable constant_\">EXPIRES_IN</span>, <span class=\"hljs-title class_\">String</span>.<span class=\"hljs-title function_\">valueOf</span>(tokenDto.<span class=\"hljs-title function_\">getExpiresIn</span>()));\n\n        <span class=\"hljs-variable language_\">sessionStorage</span>.<span class=\"hljs-title function_\">putCache</span>(<span class=\"hljs-variable constant_\">REFRESH_TOKEN</span>, deviceId, tokenDto.<span class=\"hljs-title function_\">getRefreshToken</span>(), <span class=\"hljs-number\">1800</span>);\n\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title class_\">ResponseEntity</span>.<span class=\"hljs-title function_\">ok</span>().<span class=\"hljs-title function_\">body</span>(<span class=\"hljs-title class_\">BaseResponseDto</span>.<span class=\"hljs-title function_\">builder</span>()\n                .<span class=\"hljs-title function_\">status</span>(<span class=\"hljs-string\">\"SUCCESS\"</span>)\n                .<span class=\"hljs-title function_\">build</span>());\n    }\n\n    public <span class=\"hljs-title class_\">ResponseEntity</span>&#x3C;<span class=\"hljs-title class_\">Object</span>> <span class=\"hljs-title function_\">refreshToken</span>(<span class=\"hljs-params\">HttpServletRequest servletRequest, HttpServletResponse servletResponse</span>) {\n        log.<span class=\"hljs-title function_\">info</span>(<span class=\"hljs-string\">\"액세스 토큰을 새로 고침하기 시작\"</span>);\n\n        <span class=\"hljs-title class_\">String</span> deviceId = servletRequest.<span class=\"hljs-title function_\">getHeader</span>(<span class=\"hljs-variable constant_\">DEVICE_ID</span>);\n        <span class=\"hljs-title class_\">String</span> refreshToken = (<span class=\"hljs-title class_\">String</span>) <span class=\"hljs-variable language_\">sessionStorage</span>.<span class=\"hljs-title function_\">getCache</span>(<span class=\"hljs-variable constant_\">REFRESH_TOKEN</span>, deviceId);\n\n        <span class=\"hljs-title class_\">TokenDto</span> tokenDto = <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-title function_\">getRefreshToken</span>(refreshToken);\n\n        servletResponse.<span class=\"hljs-title function_\">addHeader</span>(<span class=\"hljs-variable constant_\">ACCESS_TOKEN</span>, tokenDto.<span class=\"hljs-title function_\">getAccessToken</span>());\n        servletResponse.<span class=\"hljs-title function_\">addHeader</span>(<span class=\"hljs-variable constant_\">EXPIRES_IN</span>, <span class=\"hljs-title class_\">String</span>.<span class=\"hljs-title function_\">valueOf</span>(tokenDto.<span class=\"hljs-title function_\">getExpiresIn</span>()));\n\n        <span class=\"hljs-variable language_\">sessionStorage</span>.<span class=\"hljs-title function_\">putCache</span>(<span class=\"hljs-variable constant_\">REFRESH_TOKEN</span>, deviceId, tokenDto.<span class=\"hljs-title function_\">getRefreshToken</span>(), tokenDto.<span class=\"hljs-title function_\">getRefreshExpiresIn</span>());\n\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title class_\">ResponseEntity</span>.<span class=\"hljs-title function_\">ok</span>().<span class=\"hljs-title function_\">body</span>(<span class=\"hljs-title class_\">BaseResponseDto</span>.<span class=\"hljs-title function_\">builder</span>()\n                .<span class=\"hljs-title function_\">status</span>(<span class=\"hljs-string\">\"SUCCESS\"</span>)\n                .<span class=\"hljs-title function_\">build</span>());\n    }\n\n    private <span class=\"hljs-title class_\">TokenDto</span> <span class=\"hljs-title function_\">getAccessToken</span>(<span class=\"hljs-params\">LoginRequestDto request</span>) {\n        <span class=\"hljs-title class_\">HttpHeaders</span> headers = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">HttpHeaders</span>();\n        headers.<span class=\"hljs-title function_\">setContentType</span>(<span class=\"hljs-title class_\">MediaType</span>.<span class=\"hljs-property\">APPLICATION_FORM_URLENCODED</span>);\n\n        <span class=\"hljs-title class_\">MultiValueMap</span>&#x3C;<span class=\"hljs-title class_\">String</span>, <span class=\"hljs-title class_\">String</span>> requestBody = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">LinkedMultiValueMap</span>&#x3C;>();\n        requestBody.<span class=\"hljs-title function_\">add</span>(<span class=\"hljs-string\">\"grant_type\"</span>, <span class=\"hljs-variable constant_\">GRANT_TYPE_PASSWORD</span>);\n        requestBody.<span class=\"hljs-title function_\">add</span>(<span class=\"hljs-string\">\"client_id\"</span>, kcClientId);\n        requestBody.<span class=\"hljs-title function_\">add</span>(<span class=\"hljs-string\">\"client_secret\"</span>, kcClientSecret);\n        requestBody.<span class=\"hljs-title function_\">add</span>(<span class=\"hljs-string\">\"username\"</span>, request.<span class=\"hljs-title function_\">getUsername</span>());\n        requestBody.<span class=\"hljs-title function_\">add</span>(<span class=\"hljs-string\">\"password\"</span>, request.<span class=\"hljs-title function_\">getPassword</span>());\n\n        <span class=\"hljs-title class_\">ResponseEntity</span>&#x3C;<span class=\"hljs-title class_\">TokenDto</span>> response = restTemplate.<span class=\"hljs-title function_\">postForEntity</span>(kcGetTokenUrl,\n                <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">HttpEntity</span>&#x3C;>(requestBody, headers), <span class=\"hljs-title class_\">TokenDto</span>.<span class=\"hljs-property\">class</span>);\n\n        <span class=\"hljs-keyword\">return</span> response.<span class=\"hljs-title function_\">getBody</span>();\n    }\n\n    private <span class=\"hljs-title class_\">TokenDto</span> <span class=\"hljs-title function_\">getRefreshToken</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">String</span> refreshToken</span>) {\n        <span class=\"hljs-title class_\">HttpHeaders</span> headers = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">HttpHeaders</span>();\n        headers.<span class=\"hljs-title function_\">setContentType</span>(<span class=\"hljs-title class_\">MediaType</span>.<span class=\"hljs-property\">APPLICATION_FORM_URLENCODED</span>);\n\n        <span class=\"hljs-title class_\">MultiValueMap</span>&#x3C;<span class=\"hljs-title class_\">String</span>, <span class=\"hljs-title class_\">String</span>> requestBody = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">LinkedMultiValueMap</span>&#x3C;>();\n        requestBody.<span class=\"hljs-title function_\">add</span>(<span class=\"hljs-string\">\"grant_type\"</span>, <span class=\"hljs-variable constant_\">GRANT_TYPE_REFRESH_TOKEN</span>);\n        requestBody.<span class=\"hljs-title function_\">add</span>(<span class=\"hljs-string\">\"refresh_token\"</span>, refreshToken);\n        requestBody.<span class=\"hljs-title function_\">add</span>(<span class=\"hljs-string\">\"client_id\"</span>, kcClientId);\n        requestBody.<span class=\"hljs-title function_\">add</span>(<span class=\"hljs-string\">\"client_secret\"</span>, kcClientSecret);\n\n        <span class=\"hljs-title class_\">ResponseEntity</span>&#x3C;<span class=\"hljs-title class_\">TokenDto</span>> response = restTemplate.<span class=\"hljs-title function_\">postForEntity</span>(kcGetTokenUrl,\n                <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">HttpEntity</span>&#x3C;>(requestBody, headers), <span class=\"hljs-title class_\">TokenDto</span>.<span class=\"hljs-property\">class</span>);\n\n        <span class=\"hljs-keyword\">return</span> response.<span class=\"hljs-title function_\">getBody</span>();\n    }\n}\n</code></pre>\n<p>AuthController.java</p>\n<pre><code class=\"hljs language-js\">@<span class=\"hljs-title class_\">RestController</span>\n@<span class=\"hljs-title class_\">RequestMapping</span>(value = <span class=\"hljs-string\">\"/auth\"</span>)\npublic <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">AuthController</span> {\n\n    @<span class=\"hljs-title class_\">Autowired</span>\n    private <span class=\"hljs-title class_\">AuthService</span> authService;\n\n    @<span class=\"hljs-title class_\">PostMapping</span>(value = <span class=\"hljs-string\">\"/login\"</span>)\n    public <span class=\"hljs-title class_\">ResponseEntity</span>&#x3C;<span class=\"hljs-title class_\">Object</span>> <span class=\"hljs-title function_\">login</span>(<span class=\"hljs-params\">@RequestBody LoginRequestDto request, HttpServletRequest servletRequest,\n                                        HttpServletResponse servletResponse</span>) {\n        <span class=\"hljs-keyword\">return</span> authService.<span class=\"hljs-title function_\">login</span>(request, servletRequest, servletResponse);\n    }\n\n    @<span class=\"hljs-title class_\">PostMapping</span>(value = <span class=\"hljs-string\">\"/refresh-token\"</span>)\n    public <span class=\"hljs-title class_\">ResponseEntity</span>&#x3C;<span class=\"hljs-title class_\">Object</span>> <span class=\"hljs-title function_\">refreshToken</span>(<span class=\"hljs-params\">HttpServletRequest servletRequest, HttpServletResponse servletResponse</span>) {\n        <span class=\"hljs-keyword\">return</span> authService.<span class=\"hljs-title function_\">refreshToken</span>(servletRequest, servletResponse);\n    }\n}\n</code></pre>\n<p></p>\n<p>HomeController.java에는 USER 역할로 로그인한 사용자를 위한 공개 엔드포인트 및 ADMIN 역할을 위한 /admin을 처리하는 컨트롤러가 있습니다.</p>\n<pre><code class=\"hljs language-java\"><span class=\"hljs-meta\">@RestController</span>\n<span class=\"hljs-meta\">@RequestMapping(value = \"/home\")</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">HomeController</span> {\n\n    <span class=\"hljs-meta\">@GetMapping(value = \"/public\")</span>\n    <span class=\"hljs-keyword\">public</span> ResponseEntity&#x3C;Object> <span class=\"hljs-title function_\">home</span><span class=\"hljs-params\">()</span> {\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">ResponseEntity</span>&#x3C;>(<span class=\"hljs-string\">\"PAGE_PUBLIC\"</span>, HttpStatus.OK);\n    }\n\n    <span class=\"hljs-meta\">@GetMapping(value = \"/admin\")</span>\n    <span class=\"hljs-keyword\">public</span> ResponseEntity&#x3C;Object> <span class=\"hljs-title function_\">homeAdmin</span><span class=\"hljs-params\">()</span> {\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">ResponseEntity</span>&#x3C;>(<span class=\"hljs-string\">\"PAGE_ADMIN\"</span>, HttpStatus.OK);\n    }\n}\n</code></pre>\n<p>테스트</p>\n<p>새로 등록한 사용자 자격 증명으로 /api/auth/login 엔드 포인트에 로그인하세요.</p>\n<p></p>\n<p>curl을 사용하여 테이블로 admin 엔드포인트로 이동 가능합니다.</p>\n<pre><code class=\"hljs language-js\">curl --location <span class=\"hljs-string\">'http://localhost:8085/api/auth/login'</span> \\\n--header <span class=\"hljs-string\">'Device-Id: example-my-device-id'</span> \\\n--header <span class=\"hljs-string\">'Content-Type: application/json'</span> \\\n--data <span class=\"hljs-string\">'{\n    \"username\": \"userdemo\",\n    \"password\": \"useruser123\"\n}'</span>\n</code></pre>\n<p>admin 엔드포인트로 이동하는 curl입니다.</p>\n<pre><code class=\"hljs language-js\">curl --location <span class=\"hljs-string\">'http://localhost:8085/api/home/admin'</span> \\\n--header <span class=\"hljs-string\">'Authorization: Bearer $access_token'</span>\n\n# 페이지_ADMIN을 반환해야 함\n</code></pre>\n<p>public 엔드포인트로 이동하는 curl입니다.</p>\n<p></p>\n<pre><code class=\"hljs language-js\">curl --location <span class=\"hljs-string\">'http://localhost:8085/api/home/public'</span> \\\n--header <span class=\"hljs-string\">'Authorization: Bearer $access_token'</span>\n\n# 페이지_PUBLIC이 반환되어야합니다\n</code></pre>\n<p>사용자가 역할에 맞지 않는 엔드포인트에 액세스하려고하면 403 — 금지로 반환되어야 합니다.</p>\n<p>새로 고침 토큰 엔드포인트를 호출하여 리프레시 토큰을 갱신하고 액세스 토큰을 받아옵니다.</p>\n<pre><code class=\"hljs language-js\">curl --location --request <span class=\"hljs-variable constant_\">POST</span> <span class=\"hljs-string\">'http://localhost:8085/api/auth/refresh-token'</span> \\\n--header <span class=\"hljs-string\">'Device-Id: example-my-device-id'</span>\n</code></pre>\n<p></p>\n<p>업그레이드\n동일한 보안 구성을 적용하는 여러 서비스가 있다면, KeycloakJwtRolesResolver.java를 복제하고 중복 코드를 만드는 것은 좋지 않습니다. 더 나은 접근 방식은 해당 클래스를 독립된 스프링 프로젝트로 분리하는 것입니다. 이 프로젝트를 모듈-공통이라고 부르고, 다른 서비스에 공통으로 사용되는 클래스나 기능을 수용하도록 합니다.</p>\n</body>\n</html>\n"},"__N_SSG":true}