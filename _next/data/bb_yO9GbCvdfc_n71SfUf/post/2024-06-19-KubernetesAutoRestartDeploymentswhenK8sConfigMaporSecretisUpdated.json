{"pageProps":{"post":{"title":"Kubernetes K8s ConfigMap ë˜ëŠ” Secretê°€ ì—…ë°ì´íŠ¸ë  ë•Œ ë°°í¬ ìë™ ì¬ì‹œì‘í•˜ê¸°","description":"","date":"2024-06-19 13:11","slug":"2024-06-19-KubernetesAutoRestartDeploymentswhenK8sConfigMaporSecretisUpdated","content":"\n## ìë™ ë¡¤ì•„ì›ƒ ì¬ì‹œì‘: K8s ConfigMap ë˜ëŠ” Secretê°€ ì—…ë°ì´íŠ¸ë  ë•Œ ë°°í¬ ë‹¤ì‹œ ì‹œì‘í•˜ê¸°\n\nì¿ ë²„ë„¤í‹°ìŠ¤ ë°°í¬ëŠ” ëª¨ë“  ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ì—ì„œ ê°€ì¥ ì¼ë°˜ì ì¸ ë¦¬ì†ŒìŠ¤ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. ìš°ë¦¬ëŠ” ëª¨ë‘ podë¥¼ K8s ë°°í¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰í•˜ì—¬ ë†’ì€ ê°€ìš©ì„±ì„ ë³´ì¥í•˜ê³ , podê°€ ì‚­ì œë˜ë©´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ë„ë¡í•©ë‹ˆë‹¤.\n\nì• í”Œë¦¬ì¼€ì´ì…˜ì´ í•­ìƒ ì—¬ëŸ¬ í™˜ê²½ì—ì„œ ì›í™œí•˜ê²Œ ì‹¤í–‰ë˜ë„ë¡í•˜ê¸° ìœ„í•´ êµ¬ì„±ì´ í•„ìš”í•œ ê²ƒì€ ë§¤ìš° í”í•©ë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ì ì´ë¦„, ë¹„ë°€ë²ˆí˜¸ ë“±ê³¼ ê°™ì€ ì¤‘ìš”í•œ ì •ë³´ê°€ í•„ìš”í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œëŠ” êµ¬ì„± ë§µê³¼ ì‹œí¬ë¦¿ì„ ì‚¬ìš©í•˜ì—¬ ì‘ìš© í”„ë¡œê·¸ë¨ë³„ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  podë¡œ ì£¼ì…í•˜ì—¬ ì‘ìš© í”„ë¡œê·¸ë¨ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\nê·¸ë ‡ë‹¤ë©´ êµ¬ì„± ë§µì´ë‚˜ ì‹œí¬ë¦¿ì˜ ê°’ì„ ì—…ë°ì´íŠ¸í–ˆì„ ë•ŒëŠ” ì–´ë–¨ê¹Œìš”? ìµœì‹  ê°’ì„ ë°˜ì˜í•˜ë ¤ë©´ podë¥¼ ë‹¤ì‹œ ì‹œì‘í•´ì•¼í•©ë‹ˆë‹¤, ë§ì£ ? ë˜ëŠ” ë¡¤ì•„ì›ƒì„ ë‹¤ì‹œ ì‹œì‘í•˜ì—¬ ìƒˆë¡œìš´ podë¥¼ ìƒì„±í•˜ê²Œ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì´ì œ ìƒìƒí•´ë³´ì„¸ìš”. ê³µí†µ configmap ë˜ëŠ” secretì„ ì‚¬ìš©í•˜ëŠ” ìˆ˜ë°± ê°œì˜ ë°°í¬ê°€ ìˆê³  ê·¸ ê°’ì„ ì—…ë°ì´íŠ¸í•˜ê³  ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ìµœì‹  ê°’ì´ë¼ëŠ” ê²ƒì„ í™•ì‹¤í•˜ê²Œ í•´ì•¼í•œë‹¤ê³  ê°€ì •í•´ë³´ì„¸ìš”.\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\nì €í¬ëŠ” AWS Secrets Managerì— ë¹„ë°€ì„ ì €ì¥í•˜ê³ , Kubernetes Secrets Store CSI Driverë¥¼ ìœ„í•´ AWS Secrets ë° êµ¬ì„± ì œê³µì(ASCP)ë¡œë¶€í„° Kubernetes Secretsë¥¼ ìƒì„±í•©ë‹ˆë‹¤.\n\nì´ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì—ì„œëŠ” Secret ë˜ëŠ” ConfigMapì´ ì—…ë°ì´íŠ¸ë  ë•Œ Kubernetes ë°°í¬ë¥¼ ìë™ìœ¼ë¡œ ë¡¤ì•„ì›ƒ ë° ë‹¤ì‹œ ì‹œì‘í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.\n\n# ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨:\n\n![Architecture Diagram](/assets/img/2024-06-19-KubernetesAutoRestartDeploymentswhenK8sConfigMaporSecretisUpdated_0.png)\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n## ì‹œì‘í•´ ë´…ì‹œë‹¤!\n\n### ì¤€ë¹„ë¬¼:\n\n- EKS í´ëŸ¬ìŠ¤í„°\n- EKSë¥¼ ìœ„í•œ OIDC ì œê³µì êµ¬ì„± í•„ìš”\n- Kubectl\n- AWS CLI\n\n### ë‹¨ê³„ 1: ASCPë¥¼ ìœ„í•œ IAM ì—­í•  ë° ì •ì±… ìƒì„±\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\nASCP(Amazon EKS Security Token Service)ëŠ” Amazon EKS íŒŒë“œ IDë¥¼ ê²€ìƒ‰í•˜ì—¬ IAM ì—­í• ë¡œ êµí™˜í•©ë‹ˆë‹¤. í•´ë‹¹ IAM ì—­í• ì— ëŒ€í•œ IAM ì •ì±…ì—ì„œ ê¶Œí•œì„ ì„¤ì •í•©ë‹ˆë‹¤. ASCPê°€ IAM ì—­í• ì„ ê°€ì •í•˜ë©´ ê¶Œí•œì„ ë¶€ì—¬ë°›ì€ ì‹œí¬ë¦¿ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆëŠ” IAM ì—­í• ê³¼ ì—°ê²°ë˜ì§€ ì•ŠëŠ” í•œ ì‹œí¬ë¦¿ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n- IAM ì •ì±… ë¬¸ì„œ ì‘ì„±\n  \"secrets_policy\"ë¼ëŠ” ì´ë¦„ì˜ íŒŒì¼ì„ ë§Œë“¤ê³  ë‹¤ìŒ ë‚´ìš©ì„ ì¶”ê°€í•˜ì‹­ì‹œì˜¤.\n\n```js\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"secretsmanager:DescribeSecret\",\n                \"secretsmanager:GetSecretValue\"\n            ],\n            \"Effect\": \"Allow\",\n            \"Resource\": \"*\"\n        }\n}\n```\n\n2. ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ IAM ì •ì±…ì„ ë§Œë“­ë‹ˆë‹¤.\n   IAM ì •ì±…ì„ IAM ì—­í• ì— ì—°ê²°í•  ë•Œ policy ARNì„ ë©”ëª¨í•˜ì‹­ì‹œì˜¤.\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```js\naws iam create-policy \\\n    --policy-name my-secret-manager-policy \\\n    --policy-document file://secrets_policy\n```\n\n3. IAM ì—­í• ì— ì‹ ë¢° ì •ì±… ìƒì„±í•˜ê¸°\n   \"trust_policy\"ë¼ëŠ” ì´ë¦„ì˜ íŒŒì¼ì„ ìƒì„±í•˜ê³  ë‹¤ìŒ ë‚´ìš©ì„ ì¶”ê°€í•˜ì„¸ìš”. ì˜¬ë°”ë¥¸ ê°’ìœ¼ë¡œ ëŒ€ì²´í•´ì•¼ í•©ë‹ˆë‹¤. `SERVICE_ACCOUNT_NAME`ì€ ì„ì˜ë¡œ ì§€ì •í•  ìˆ˜ ìˆì§€ë§Œ Kubernetesì—ì„œ ì‹¤ì œ ì„œë¹„ìŠ¤ ê³„ì •ì„ ìƒì„±í•  ë•Œ ë™ì¼í•œ ì´ë¦„ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.\n\n```js\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": \"sts:AssumeRoleWithWebIdentity\",\n      \"Principal\": {\n        \"Federated\": \"arn:aws:iam::<AWS_ACCOUNT_ID>:oidc-provider/oidc.eks.<AWS_REGION>.amazonaws.com/id/<OIDC_ID>\"\n      },\n      \"Condition\": {\n        \"StringEquals\": {\n          \"oidc.eks.<AWS_REGION>.amazonaws.com/id/<OIDC_ID>:aud\": \"sts.amazonaws.com\",\n          \"oidc.eks.<AWS_REGION>.amazonaws.com/id/<OIDC_ID>:sub\": \"system:serviceaccount:<K8S_NAMESPACE>:<SERVICE_ACCOUNT_NAME>\"\n        }\n      }\n    }\n  ]\n}\n```\n\n4. ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ IAM ì—­í• ì„ ë§Œë“œì„¸ìš”.\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```js\naws iam create-role --role-name my-secret-manager-role --assume-role-policy-document file://trust_policy\n```\n\n5. Attach IAM policy to IAM Role\n\n```js\naws iam attach-role-policy --policy-arn <your_policy_arn> --role-name my-secret-manager-role\n```\n\nìš°ë¦¬ëŠ” í•„ìš”í•œ ëª¨ë“  IAM ì—­í• ê³¼ ì •ì±…ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n# ë‹¨ê³„ 2: ASCP ì„¤ì¹˜ ë° êµ¬ì„±\n\nì´ì œ 2ê°œì˜ Helm ì°¨íŠ¸ë¥¼ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.\n\n- AWS Secrets and Configuration Provider (ASCP) ì°¨íŠ¸ ì„¤ì¹˜\n\n```js\n# ASCP Helm ì°¨íŠ¸ ë¦¬í¬ì§€í† ë¦¬ ì¶”ê°€\nhelm repo add aws-secrets-manager https://aws.github.io/secrets-store-csi-driver-provider-aws\n\n# ASCP Helm ì°¨íŠ¸ ì„¤ì¹˜\nhelm install -n kube-system secrets-provider-aws aws-secrets-manager/secrets-store-csi-driver-provider-aws\n```\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n2. Secrets Store CSI Driver ì°¨íŠ¸ ì„¤ì¹˜\n\n- Secrets Store CSI Driver ì°¨íŠ¸ë¥¼ ìœ„í•œ helm ë ˆí¬ì§€í† ë¦¬ ì¶”ê°€\n\n```js\n# Secrets Store CSI Driver ì°¨íŠ¸ ë ˆí¬ì§€í† ë¦¬ ì¶”ê°€\nhelm repo add secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts\n```\n\n- ê¸°ë³¸ê°’ í™•ì¸\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n# ê¸°ë³¸ ê°’ ê°€ì ¸ì˜¤ê¸°\n\nhelm show values secrets-store-csi-driver/secrets-store-csi-driver > secrets-store-csi-driver.yaml\n\n- secrets-store-csi-driver.yaml íŒŒì¼ì—ì„œ ë‹¤ìŒ ê°’ì„ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.\n\n## K8S Secrets ë™ê¸°í™”ì— í•„ìš”í•œ RBAC ì—­í•  ë° ë°”ì¸ë”© ì„¤ì¹˜ ì—¬ë¶€\n\nsyncSecret:\nenabled: true\n\n## ì‹œí¬ë¦¿ ë¡œí…Œì´ì…˜ ê¸°ëŠ¥ í™œì„±í™” [ì•ŒíŒŒ]\n\nenableSecretRotation: true\n\nìœ„ì˜ êµ¬ì„±ì€ \"secrets-store-csi-driver\"ê°€ AWS Secret Managerì—ì„œ ìµœì‹  ê°’ì„ ê°€ì ¸ì™€ í•´ë‹¹ ê°’ì„ Kubernetes Secrets ê°ì²´ì— ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\níšŒì „-íˆ¬í‘œ-ê°„ê²©ì€ ê¸°ë³¸ì ìœ¼ë¡œ 2ë¶„ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆì§€ë§Œ, ì†ì„± rotationPollIntervalì„ ì„¤ì •í•¨ìœ¼ë¡œì¨ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n- Helm ì°¨íŠ¸ ì„¤ì¹˜\n\n```js\n# Helm ì°¨íŠ¸ ì„¤ì¹˜\nhelm install -n kube-system csi-secrets-store secrets-store-csi-driver/secrets-store-csi-driver -f secrets-store-csi-driver.yaml\n```\n\n# ë‹¨ê³„ 3: AWS Secret Managerì— í…ŒìŠ¤íŠ¸ ì‹œí¬ë¦¿ ìƒì„±\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\nAWS Secret Managerì—ì„œ í…ŒìŠ¤íŠ¸ ì‹œí¬ë¦¿ì„ ìƒì„±í•  ê²ƒì…ë‹ˆë‹¤.\n\n```js\naws secretsmanager create-secret \\\n    --name my-test-secret \\\n    --description \"CLIë¡œ ìƒì„±í•œ ë‚´ í…ŒìŠ¤íŠ¸ ì‹œí¬ë¦¿.\" \\\n    --secret-string \"{\\\"user\\\":\\\"my-user\\\",\\\"password\\\":\\\"ì˜ˆì‹œ-ë¹„ë°€ë²ˆí˜¸\\\"}\"\n```\n\n# ë‹¨ê³„ 4: Kubernetes ServiceAccount ìƒì„±\n\nì´ì œ IAM ì—­í• ì„ ê°€ì •í•  ìˆ˜ ìˆë„ë¡ íŒŒë“œì— í—ˆìš©í•˜ëŠ” ServiceAccountë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ServiceAccountëŠ” K8s ë°°í¬ì—ì„œ ì‚¬ìš©ë  ê²ƒì…ë‹ˆë‹¤.\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\nserviceaccount.yamlì´ë¼ëŠ” ì´ë¦„ì˜ íŒŒì¼ì„ ìƒì„±í•´ì£¼ì„¸ìš”.\n\n```yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: <your_service_account_name> # ì´ ì´ë¦„ì€ IAM ì‹ ë¢° ì •ì±…ì„ ë§Œë“¤ ë•Œ ì§€ì •í•œ ì´ë¦„ê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.\n  annotations:\n    eks.amazonaws.com/role-arn: <IAM_ROLE_ARN>\n```\n\në‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ K8sì—ì„œ ì„œë¹„ìŠ¤ ê³„ì •ì„ ìƒì„±í•©ë‹ˆë‹¤.\n\n```bash\nkubectl apply -f serviceaccount.yaml\n```\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n# ë‹¨ê³„ 5: í…ŒìŠ¤íŠ¸ ê°ì²´ ìƒì„±í•˜ê¸°\n\nì´ì œ í•„ìš”í•œ ëª¨ë“  ë¦¬ì†ŒìŠ¤ë¥¼ ë°°í¬í–ˆìŠµë‹ˆë‹¤. ì´ì œ í…ŒìŠ¤íŠ¸ ê°ì²´ë¥¼ ë§Œë“¤ì–´ ë´…ì‹œë‹¤.\n\n- ì´ë¦„ì´ â€œmy-test-secret-manifest.yamlâ€ì¸ íŒŒì¼ ìƒì„±\n\n```js\n---\napiVersion: secrets-store.csi.x-k8s.io/v1\nkind: SecretProviderClass\nmetadata:\n  name: aws-secrets-providerclass\nspec:\n  provider: aws\n  secretObjects:\n    - secretName: my-test-k8s-secret\n      type: Opaque\n      data:\n        - objectName: user\n          key: user\n        - objectName: password\n          key: password\n  parameters:\n    objects: |\n      - objectName: arn:aws:secretsmanager:<AWS_REGION>:<AWS_ACCOUNT_ID>:secret:my-test-secret\n        jmesPath:\n          - path: user\n            objectAlias: user\n          - path: password\n            objectAlias: password\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: secret-rotation-test-ubuntu-deployment\n  labels:\n    app: ubuntu\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: ubuntu\n  template:\n    metadata:\n      labels:\n        app: ubuntu\n    spec:\n      serviceAccountName: <your_service_account_name> # ì´ ì´ë¦„ì€ ë‹¨ê³„ 4ì—ì„œ ë§Œë“  ì„œë¹„ìŠ¤ ê³„ì • ì´ë¦„ê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤\n      volumes:\n      - name: mount-secrets-access\n        csi:\n          driver: secrets-store.csi.k8s.io\n          readOnly: true\n          volumeAttributes:\n            secretProviderClass: \"aws-secrets-providerclass\"\n      containers:\n      - name: ubuntu\n        image: ubuntu\n        command: [\"sleep\", \"123456\"]\n        env:\n        - name: USER\n          valueFrom:\n            secretKeyRef:\n              name: my-test-k8s-secret\n              key: user\n        - name: PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: my-test-k8s-secret\n              key: password\n        volumeMounts:\n        - name: mount-secrets-access\n          mountPath: \"/mnt/aws-secrets\"\n          readOnly: true\n```\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n2. manifestë¥¼ ì ìš©í•˜ì‹­ì‹œì˜¤\n\n```js\nkubectl apply -f my-test-secret-manifest.yaml\n```\n\n3. ë‹¤ìŒ ë¦¬ì†ŒìŠ¤ê°€ ìƒì„±ë©ë‹ˆë‹¤.\n\n- SecretProviderClass ë¦¬ì†ŒìŠ¤ - AWS Secret Managerì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ K8s Secretë¥¼ ìƒì„±í•©ë‹ˆë‹¤\n- ë³¼ë¥¨ ë§ˆìš´íŠ¸ê°€ ìˆëŠ” ë°°í¬ - SecretProviderClassë¥¼ ë³¼ë¥¨ìœ¼ë¡œ ë§ˆìš´íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤\n- Kubernetes Secret - íŒŒë“œ ë‚´ì—ì„œ í™˜ê²½ ë³€ìˆ˜ë¡œ ì£¼ì…ë©ë‹ˆë‹¤\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\nì•„ë˜ ë‹¤ì´ì–´ê·¸ë¨ì€ YAMLì„ ì ìš©í•  ë•Œ ë’·ë‹¨ì—ì„œ ë¬´ìŠ¨ ì¼ì´ ë²Œì–´ì§€ëŠ”ì§€ ì˜ ì‹œê°í™”í•œ ê²ƒì…ë‹ˆë‹¤.\n\n![ë‹¤ì´ì–´ê·¸ë¨](/assets/img/2024-06-19-KubernetesAutoRestartDeploymentswhenK8sConfigMaporSecretisUpdated_1.png)\n\n4. ëª¨ë“  ê²ƒì´ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”.\n\n```js\n# SecretProviderClass í™•ì¸\nkubectl get SecretProviderClass aws-secrets-providerclass -o yaml\n\n# ë°°í¬ í™•ì¸\nkubectl get deploy secret-rotation-test-ubuntu-deployment -o yaml\n\n# Pod í™•ì¸\nkubectl get po <pod_name> -o yaml\n\n# Secret ê°€ì ¸ì˜¤ê¸°\nkubectl get secret my-test-k8s-secret -o yaml\n```\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n# ë‹¨ê³„ 6: Reloader ì„¤ì¹˜í•˜ê¸°\n\nReloaderëŠ” ConfigMapê³¼ Secretì˜ ë³€ê²½ ì‚¬í•­ì„ ê°ì§€í•˜ê³  ê´€ë ¨ëœ DeploymentConfig, Deployment, DaemonSet, StatefulSet ë° Rolloutê³¼ í•¨ê»˜ Podì˜ ë¡¤ë§ ì—…ê·¸ë ˆì´ë“œë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n- Reloader Helm Repo ì¶”ê°€\n\n```js\n# Helm Repo ì¶”ê°€\nhelm repo add stakater https://stakater.github.io/stakater-charts\n```\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n2. ê¸°ë³¸ê°’ ê°€ì ¸ì˜¤ê¸°\n\n```js\n# ê¸°ë³¸ê°’ ê°€ì ¸ì˜¤ê¸°\nhelm show values stakater/reloader > reloader.yaml\n```\n\n3. reloader.yaml íŒŒì¼ ì—…ë°ì´íŠ¸í•˜ê¸°\n\n```js\nreloader:\n  # ë¦¬ë”ì‹­ ì„ ì¶œì„ í™œì„±í™”í•˜ë ¤ë©´ trueë¡œ ì„¤ì •í•˜ì—¬ ì—¬ëŸ¬ ë ˆí”Œë¦¬ì¹´ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n  enableHA: true\n  deployment:\n    # ì—¬ëŸ¬ ë ˆí”Œë¦¬ì¹´ë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ reloader.enableHA = trueë¡œ ì„¤ì •í•©ë‹ˆë‹¤.\n    replicas: 2\n```\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n4. Helm ì°¨íŠ¸ ì„¤ì¹˜\n\n```js\n# Helm ì°¨íŠ¸ ì„¤ì¹˜\nhelm install reloader -f reloader.yaml stakater/reloader -n kube-system\n```\n\n# ë‹¨ê³„ 7: Secret ì—…ë°ì´íŠ¸ë¡œ í…ŒìŠ¤íŠ¸í•˜ê¸°\n\n- ReloaderëŠ” ì£¼ì„ì— ì˜í–¥ì„ ë°›ìŠµë‹ˆë‹¤.\n  ê¸°ë³¸ ì£¼ì„ reloader.stakater.com/autoëŠ” ì£¼ìš” ë©”íƒ€ë°ì´í„°ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ì•„ë˜ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ë°°í¬ì— ì£¼ì„ì„ ì¶”ê°€í•˜ì„¸ìš”.\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```js\n# ë°°í¬ ì£¼ì„ ì¶”ê°€\nkubectl annotate deployment secret-rotation-test-ubuntu-deployment \"reloader.stakater.com/auto=true\"\n```\n\në˜ëŠ” ë‹¤ìŒ ë¸”ë¡ìœ¼ë¡œ ë°°í¬ íŒŒì¼ì„ í¸ì§‘í•˜ê³  ì ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.\n\n```js\nmetadata:\n  annotations:\n    reloader.stakater.com/auto: \"true\"\n```\n\n2. AWS Secret Managerì—ì„œ ì‹œí¬ë¦¿ ì—…ë°ì´íŠ¸í•˜ê¸°\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```js\naws secretsmanager put-secret-value \\\n      --secret-id my-test-secret \\\n      --secret-string \"{\\\"user\\\":\\\"diegor\\\",\\\"password\\\":\\\"SAMPLE-PASSWORD\\\"}\"\n```\n\n3. í•œ ë²ˆ ì‹œí¬ë¦¿ì´ AWS ì‹œí¬ë¦¿ ìŠ¤í† ì–´ csi ë“œë¼ì´ë²„ì— ì—…ë°ì´íŠ¸ë˜ë©´ K8s ì‹œí¬ë¦¿ì´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤. K8s ì‹œí¬ë¦¿ì´ ì—…ë°ì´íŠ¸ë˜ë©´ Reloaderê°€ ë¡¤ì•„ì›ƒì„ ë‹¤ì‹œ ì‹œì‘í•˜ë„ë¡ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.\n\n```js\n# K8s ì‹œí¬ë¦¿ì„ í™•ì¸í•˜ì„¸ìš”. ìƒˆë¡œìš´ ê°’ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.\nkubectl get secret my-test-k8s-secret -o yaml\n\n# Podë¥¼ í™•ì¸í•˜ì„¸ìš”. ëª‡ ì´ˆ ì „ì— ì‹œì‘ë˜ì—ˆì–´ì•¼ í•©ë‹ˆë‹¤.\nkubectl get po\n\n# Reloader íŒŸì˜ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.\nkubectl logs <reloader-pod-name> -n kube-system\n\n# Podë¡œ ì‹¤í–‰ í›„ ìƒˆë¡œìš´ ê°’ì„ í™•ì¸í•˜ì„¸ìš”.\nkubectl exec -it <pod_name> -- bash\n\n# Podì— ë“¤ì–´ê°„ í›„ `env` ëª…ë ¹ì„ ì‹¤í–‰í•˜ì„¸ìš”. Podì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  í™˜ê²½ ë³€ìˆ˜ê°€ ì¶œë ¥ë©ë‹ˆë‹¤.\n```\n\n# ë‹¨ê³„ 8: ConfigMap ì—…ë°ì´íŠ¸ë¥¼ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n- \"my-test-cm-manifest.yaml\" íŒŒì¼ì„ ìƒì„±í•´ì£¼ì„¸ìš”.\n\n```yaml\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: my-test-k8s-cm\ndata:\n  myvalue: \"Hello World\"\n  drink: coffee\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: reloader-poc-ubuntu-deployment\n  labels:\n    app: ubuntu\n  annotations:\n    reloader.stakater.com/auto: \"true\"\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: ubuntu\n  template:\n    metadata:\n      labels:\n        app: ubuntu\n    spec:\n      containers:\n        - name: ubuntu\n          image: ubuntu\n          command: [\"sleep\", \"123456\"]\n          env:\n            - name: DRINK\n              valueFrom:\n                configMapKeyRef:\n                  name: my-test-k8s-cm\n                  key: drink\n            - name: MYVALUE\n              valueFrom:\n                configMapKeyRef:\n                  name: my-test-k8s-cm\n                  key: myvalue\n```\n\n2. ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì ìš©\n\n```bash\nkubectl apply -f my-test-cm-manifest.yaml\n```\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n3. my-test-cm-manifest.yaml íŒŒì¼ì—ì„œ configmapì„ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.\n\n```yaml\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: my-test-k8s-cm\ndata:\n  myvalue: \"ì•ˆë…•í•˜ì„¸ìš”\"\n  drink: ì°¨\n```\n\n4. íŒŒì¼ì„ ë‹¤ì‹œ ì ìš©í•˜ì„¸ìš”.\n\n```yaml\nkubectl apply -f my-test-cm-manifest.yaml\n```\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n5. í™•ì¸\n\n```js\n# ConfigMap í™•ì¸\nkubectl get cm my-test-k8s-cm -o yaml\n\n# Pod í™•ì¸\nkubectl get po\n\n# Podì— ì ‘ì†í•˜ì—¬ ìƒˆ ê°’ í™•ì¸\nkubectl exec -it <pod_name> -- bash\n\n# Podì— ë“¤ì–´ê°„ í›„ `env` ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ Pod ë‚´ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  í™˜ê²½ ë³€ìˆ˜ê°€ ì¶œë ¥ë©ë‹ˆë‹¤\n```\n\nì¶•í•˜í•©ë‹ˆë‹¤!!! secret-store-csi-driverì™€ reloaderë¥¼ ì„±ê³µì ìœ¼ë¡œ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.\n\nê°ì‚¬í•©ë‹ˆë‹¤!!!\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n## ì°¸ê³  ìë£Œ:\n\n- [AWS ê³µì‹ ë¬¸ì„œ - CSI ë“œë¼ì´ë²„ í†µí•©](https://docs.aws.amazon.com/secretsmanager/latest/userguide/integrating_csi_driver.html)\n- [Bootlabs ê¸°ìˆ  ë¸”ë¡œê·¸ - AWS Secrets Manager in Kubernetes ì‹œí¬ë¦¿ íšŒì „ê³¼ ë¦¬ë¡œë”](https://blog.bootlabstech.com/aws-secrets-manager-in-kubernetes-secret-rotation-and-reloader)\n- [Secrets Store CSI ë“œë¼ì´ë²„ ê³µì‹ í™ˆí˜ì´ì§€ - ì‹œí¬ë¦¿ ìë™ íšŒì „](https://secrets-store-csi-driver.sigs.k8s.io/topics/secret-auto-rotation)\n- [Secrets Store CSI ë“œë¼ì´ë²„ ì°¨íŠ¸ ê°’ ì„¤ì • íŒŒì¼](https://github.com/kubernetes-sigs/secrets-store-csi-driver/blob/main/charts/secrets-store-csi-driver/values.yaml)\n- [Reloader GitHub ì €ì¥ì†Œ](https://github.com/stakater/Reloader/tree/master)\n- [Reloader ì‘ë™ í™•ì¸ ë¬¸ì„œ](https://github.com/stakater/Reloader/blob/master/docs/Verify-Reloader-Working.md)\n- [Reloader ì‘ë™ ë°©ì‹ ë¬¸ì„œ](https://github.com/stakater/Reloader/blob/master/docs/How-it-works.md)\n\n# ê°„ë‹¨íˆ ë§í•˜ìë©´ ğŸš€\n\nIn Plain English ì»¤ë®¤ë‹ˆí‹°ì˜ ì¼ì›ì´ ë˜ì–´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ê³„ì† ì°¸ì—¬í•´ ì£¼ì„¸ìš”:\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n- ì‘ê°€ì—ê²Œ ë°•ìˆ˜ë¥¼ ë³´ë‚´ê³  íŒ”ë¡œìš°ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš” ï¸ğŸ‘ï¸ï¸\n- íŒ”ë¡œìš°í•˜ê¸°: X | LinkedIn | YouTube | Discord | Newsletter\n- ë‹¤ë¥¸ í”Œë«í¼ì—ì„œ ì €í¬ë¥¼ ë§Œë‚˜ë³´ì„¸ìš”: Stackademic | CoFeed | Venture | Cubed\n- ì•Œê³ ë¦¬ì¦˜ ì½˜í…ì¸ ë¥¼ ë‹¤ë¤„ì•¼ í•˜ëŠ” ë¸”ë¡œê·¸ í”Œë«í¼ì— ì§€ì³¤ë‚˜ìš”? Differë¥¼ ì‹œë„í•´ë³´ì„¸ìš”\n- PlainEnglish.ioì—ì„œ ë” ë§ì€ ì½˜í…ì¸ ë¥¼ ë§Œë‚˜ë³´ì„¸ìš”\n","ogImage":{"url":"/assets/img/2024-06-19-KubernetesAutoRestartDeploymentswhenK8sConfigMaporSecretisUpdated_0.png"},"coverImage":"/assets/img/2024-06-19-KubernetesAutoRestartDeploymentswhenK8sConfigMaporSecretisUpdated_0.png","tag":["Tech"],"readingTime":19},"content":"<!doctype html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\">\n<meta content=\"width=device-width, initial-scale=1\" name=\"viewport\">\n</head>\n<body>\n<h2>ìë™ ë¡¤ì•„ì›ƒ ì¬ì‹œì‘: K8s ConfigMap ë˜ëŠ” Secretê°€ ì—…ë°ì´íŠ¸ë  ë•Œ ë°°í¬ ë‹¤ì‹œ ì‹œì‘í•˜ê¸°</h2>\n<p>ì¿ ë²„ë„¤í‹°ìŠ¤ ë°°í¬ëŠ” ëª¨ë“  ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ì—ì„œ ê°€ì¥ ì¼ë°˜ì ì¸ ë¦¬ì†ŒìŠ¤ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. ìš°ë¦¬ëŠ” ëª¨ë‘ podë¥¼ K8s ë°°í¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰í•˜ì—¬ ë†’ì€ ê°€ìš©ì„±ì„ ë³´ì¥í•˜ê³ , podê°€ ì‚­ì œë˜ë©´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ë„ë¡í•©ë‹ˆë‹¤.</p>\n<p>ì• í”Œë¦¬ì¼€ì´ì…˜ì´ í•­ìƒ ì—¬ëŸ¬ í™˜ê²½ì—ì„œ ì›í™œí•˜ê²Œ ì‹¤í–‰ë˜ë„ë¡í•˜ê¸° ìœ„í•´ êµ¬ì„±ì´ í•„ìš”í•œ ê²ƒì€ ë§¤ìš° í”í•©ë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ì ì´ë¦„, ë¹„ë°€ë²ˆí˜¸ ë“±ê³¼ ê°™ì€ ì¤‘ìš”í•œ ì •ë³´ê°€ í•„ìš”í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œëŠ” êµ¬ì„± ë§µê³¼ ì‹œí¬ë¦¿ì„ ì‚¬ìš©í•˜ì—¬ ì‘ìš© í”„ë¡œê·¸ë¨ë³„ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  podë¡œ ì£¼ì…í•˜ì—¬ ì‘ìš© í”„ë¡œê·¸ë¨ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>\n<p>ê·¸ë ‡ë‹¤ë©´ êµ¬ì„± ë§µì´ë‚˜ ì‹œí¬ë¦¿ì˜ ê°’ì„ ì—…ë°ì´íŠ¸í–ˆì„ ë•ŒëŠ” ì–´ë–¨ê¹Œìš”? ìµœì‹  ê°’ì„ ë°˜ì˜í•˜ë ¤ë©´ podë¥¼ ë‹¤ì‹œ ì‹œì‘í•´ì•¼í•©ë‹ˆë‹¤, ë§ì£ ? ë˜ëŠ” ë¡¤ì•„ì›ƒì„ ë‹¤ì‹œ ì‹œì‘í•˜ì—¬ ìƒˆë¡œìš´ podë¥¼ ìƒì„±í•˜ê²Œ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì´ì œ ìƒìƒí•´ë³´ì„¸ìš”. ê³µí†µ configmap ë˜ëŠ” secretì„ ì‚¬ìš©í•˜ëŠ” ìˆ˜ë°± ê°œì˜ ë°°í¬ê°€ ìˆê³  ê·¸ ê°’ì„ ì—…ë°ì´íŠ¸í•˜ê³  ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ìµœì‹  ê°’ì´ë¼ëŠ” ê²ƒì„ í™•ì‹¤í•˜ê²Œ í•´ì•¼í•œë‹¤ê³  ê°€ì •í•´ë³´ì„¸ìš”.</p>\n<p></p>\n<p>ì €í¬ëŠ” AWS Secrets Managerì— ë¹„ë°€ì„ ì €ì¥í•˜ê³ , Kubernetes Secrets Store CSI Driverë¥¼ ìœ„í•´ AWS Secrets ë° êµ¬ì„± ì œê³µì(ASCP)ë¡œë¶€í„° Kubernetes Secretsë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>\n<p>ì´ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì—ì„œëŠ” Secret ë˜ëŠ” ConfigMapì´ ì—…ë°ì´íŠ¸ë  ë•Œ Kubernetes ë°°í¬ë¥¼ ìë™ìœ¼ë¡œ ë¡¤ì•„ì›ƒ ë° ë‹¤ì‹œ ì‹œì‘í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.</p>\n<h1>ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨:</h1>\n<p><img src=\"/assets/img/2024-06-19-KubernetesAutoRestartDeploymentswhenK8sConfigMaporSecretisUpdated_0.png\" alt=\"Architecture Diagram\"></p>\n<p></p>\n<h2>ì‹œì‘í•´ ë´…ì‹œë‹¤!</h2>\n<h3>ì¤€ë¹„ë¬¼:</h3>\n<ul>\n<li>EKS í´ëŸ¬ìŠ¤í„°</li>\n<li>EKSë¥¼ ìœ„í•œ OIDC ì œê³µì êµ¬ì„± í•„ìš”</li>\n<li>Kubectl</li>\n<li>AWS CLI</li>\n</ul>\n<h3>ë‹¨ê³„ 1: ASCPë¥¼ ìœ„í•œ IAM ì—­í•  ë° ì •ì±… ìƒì„±</h3>\n<p></p>\n<p>ASCP(Amazon EKS Security Token Service)ëŠ” Amazon EKS íŒŒë“œ IDë¥¼ ê²€ìƒ‰í•˜ì—¬ IAM ì—­í• ë¡œ êµí™˜í•©ë‹ˆë‹¤. í•´ë‹¹ IAM ì—­í• ì— ëŒ€í•œ IAM ì •ì±…ì—ì„œ ê¶Œí•œì„ ì„¤ì •í•©ë‹ˆë‹¤. ASCPê°€ IAM ì—­í• ì„ ê°€ì •í•˜ë©´ ê¶Œí•œì„ ë¶€ì—¬ë°›ì€ ì‹œí¬ë¦¿ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆëŠ” IAM ì—­í• ê³¼ ì—°ê²°ë˜ì§€ ì•ŠëŠ” í•œ ì‹œí¬ë¦¿ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>\n<ul>\n<li>IAM ì •ì±… ë¬¸ì„œ ì‘ì„±\n\"secrets_policy\"ë¼ëŠ” ì´ë¦„ì˜ íŒŒì¼ì„ ë§Œë“¤ê³  ë‹¤ìŒ ë‚´ìš©ì„ ì¶”ê°€í•˜ì‹­ì‹œì˜¤.</li>\n</ul>\n<pre><code class=\"hljs language-js\">{\n    <span class=\"hljs-string\">\"Version\"</span>: <span class=\"hljs-string\">\"2012-10-17\"</span>,\n    <span class=\"hljs-string\">\"Statement\"</span>: [\n        {\n            <span class=\"hljs-string\">\"Action\"</span>: [\n                <span class=\"hljs-string\">\"secretsmanager:DescribeSecret\"</span>,\n                <span class=\"hljs-string\">\"secretsmanager:GetSecretValue\"</span>\n            ],\n            <span class=\"hljs-string\">\"Effect\"</span>: <span class=\"hljs-string\">\"Allow\"</span>,\n            <span class=\"hljs-string\">\"Resource\"</span>: <span class=\"hljs-string\">\"*\"</span>\n        }\n}\n</code></pre>\n<ol start=\"2\">\n<li>ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ IAM ì •ì±…ì„ ë§Œë“­ë‹ˆë‹¤.\nIAM ì •ì±…ì„ IAM ì—­í• ì— ì—°ê²°í•  ë•Œ policy ARNì„ ë©”ëª¨í•˜ì‹­ì‹œì˜¤.</li>\n</ol>\n<p></p>\n<pre><code class=\"hljs language-js\">aws iam create-policy \\\n    --policy-name my-secret-manager-policy \\\n    --policy-<span class=\"hljs-variable language_\">document</span> <span class=\"hljs-attr\">file</span>:<span class=\"hljs-comment\">//secrets_policy</span>\n</code></pre>\n<ol start=\"3\">\n<li>IAM ì—­í• ì— ì‹ ë¢° ì •ì±… ìƒì„±í•˜ê¸°\n\"trust_policy\"ë¼ëŠ” ì´ë¦„ì˜ íŒŒì¼ì„ ìƒì„±í•˜ê³  ë‹¤ìŒ ë‚´ìš©ì„ ì¶”ê°€í•˜ì„¸ìš”. ì˜¬ë°”ë¥¸ ê°’ìœ¼ë¡œ ëŒ€ì²´í•´ì•¼ í•©ë‹ˆë‹¤. <code>SERVICE_ACCOUNT_NAME</code>ì€ ì„ì˜ë¡œ ì§€ì •í•  ìˆ˜ ìˆì§€ë§Œ Kubernetesì—ì„œ ì‹¤ì œ ì„œë¹„ìŠ¤ ê³„ì •ì„ ìƒì„±í•  ë•Œ ë™ì¼í•œ ì´ë¦„ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.</li>\n</ol>\n<pre><code class=\"hljs language-js\">{\n  <span class=\"hljs-string\">\"Version\"</span>: <span class=\"hljs-string\">\"2012-10-17\"</span>,\n  <span class=\"hljs-string\">\"Statement\"</span>: [\n    {\n      <span class=\"hljs-string\">\"Effect\"</span>: <span class=\"hljs-string\">\"Allow\"</span>,\n      <span class=\"hljs-string\">\"Action\"</span>: <span class=\"hljs-string\">\"sts:AssumeRoleWithWebIdentity\"</span>,\n      <span class=\"hljs-string\">\"Principal\"</span>: {\n        <span class=\"hljs-string\">\"Federated\"</span>: <span class=\"hljs-string\">\"arn:aws:iam::&#x3C;AWS_ACCOUNT_ID>:oidc-provider/oidc.eks.&#x3C;AWS_REGION>.amazonaws.com/id/&#x3C;OIDC_ID>\"</span>\n      },\n      <span class=\"hljs-string\">\"Condition\"</span>: {\n        <span class=\"hljs-string\">\"StringEquals\"</span>: {\n          <span class=\"hljs-string\">\"oidc.eks.&#x3C;AWS_REGION>.amazonaws.com/id/&#x3C;OIDC_ID>:aud\"</span>: <span class=\"hljs-string\">\"sts.amazonaws.com\"</span>,\n          <span class=\"hljs-string\">\"oidc.eks.&#x3C;AWS_REGION>.amazonaws.com/id/&#x3C;OIDC_ID>:sub\"</span>: <span class=\"hljs-string\">\"system:serviceaccount:&#x3C;K8S_NAMESPACE>:&#x3C;SERVICE_ACCOUNT_NAME>\"</span>\n        }\n      }\n    }\n  ]\n}\n</code></pre>\n<ol start=\"4\">\n<li>ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ IAM ì—­í• ì„ ë§Œë“œì„¸ìš”.</li>\n</ol>\n<p></p>\n<pre><code class=\"hljs language-js\">aws iam create-role --role-name my-secret-manager-role --assume-role-policy-<span class=\"hljs-variable language_\">document</span> <span class=\"hljs-attr\">file</span>:<span class=\"hljs-comment\">//trust_policy</span>\n</code></pre>\n<ol start=\"5\">\n<li>Attach IAM policy to IAM Role</li>\n</ol>\n<pre><code class=\"hljs language-js\">aws iam attach-role-policy --policy-arn &#x3C;your_policy_arn> --role-name my-secret-manager-role\n</code></pre>\n<p>ìš°ë¦¬ëŠ” í•„ìš”í•œ ëª¨ë“  IAM ì—­í• ê³¼ ì •ì±…ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.</p>\n<p></p>\n<h1>ë‹¨ê³„ 2: ASCP ì„¤ì¹˜ ë° êµ¬ì„±</h1>\n<p>ì´ì œ 2ê°œì˜ Helm ì°¨íŠ¸ë¥¼ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.</p>\n<ul>\n<li>AWS Secrets and Configuration Provider (ASCP) ì°¨íŠ¸ ì„¤ì¹˜</li>\n</ul>\n<pre><code class=\"hljs language-js\"># <span class=\"hljs-variable constant_\">ASCP</span> <span class=\"hljs-title class_\">Helm</span> ì°¨íŠ¸ ë¦¬í¬ì§€í† ë¦¬ ì¶”ê°€\nhelm repo add aws-secrets-manager <span class=\"hljs-attr\">https</span>:<span class=\"hljs-comment\">//aws.github.io/secrets-store-csi-driver-provider-aws</span>\n\n# <span class=\"hljs-variable constant_\">ASCP</span> <span class=\"hljs-title class_\">Helm</span> ì°¨íŠ¸ ì„¤ì¹˜\nhelm install -n kube-system secrets-provider-aws aws-secrets-manager/secrets-store-csi-driver-provider-aws\n</code></pre>\n<p></p>\n<ol start=\"2\">\n<li>Secrets Store CSI Driver ì°¨íŠ¸ ì„¤ì¹˜</li>\n</ol>\n<ul>\n<li>Secrets Store CSI Driver ì°¨íŠ¸ë¥¼ ìœ„í•œ helm ë ˆí¬ì§€í† ë¦¬ ì¶”ê°€</li>\n</ul>\n<pre><code class=\"hljs language-js\"># <span class=\"hljs-title class_\">Secrets</span> <span class=\"hljs-title class_\">Store</span> <span class=\"hljs-variable constant_\">CSI</span> <span class=\"hljs-title class_\">Driver</span> ì°¨íŠ¸ ë ˆí¬ì§€í† ë¦¬ ì¶”ê°€\nhelm repo add secrets-store-csi-driver <span class=\"hljs-attr\">https</span>:<span class=\"hljs-comment\">//kubernetes-sigs.github.io/secrets-store-csi-driver/charts</span>\n</code></pre>\n<ul>\n<li>ê¸°ë³¸ê°’ í™•ì¸</li>\n</ul>\n<p></p>\n<h1>ê¸°ë³¸ ê°’ ê°€ì ¸ì˜¤ê¸°</h1>\n<p>helm show values secrets-store-csi-driver/secrets-store-csi-driver > secrets-store-csi-driver.yaml</p>\n<ul>\n<li>secrets-store-csi-driver.yaml íŒŒì¼ì—ì„œ ë‹¤ìŒ ê°’ì„ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.</li>\n</ul>\n<h2>K8S Secrets ë™ê¸°í™”ì— í•„ìš”í•œ RBAC ì—­í•  ë° ë°”ì¸ë”© ì„¤ì¹˜ ì—¬ë¶€</h2>\n<p>syncSecret:\nenabled: true</p>\n<h2>ì‹œí¬ë¦¿ ë¡œí…Œì´ì…˜ ê¸°ëŠ¥ í™œì„±í™” [ì•ŒíŒŒ]</h2>\n<p>enableSecretRotation: true</p>\n<p>ìœ„ì˜ êµ¬ì„±ì€ \"secrets-store-csi-driver\"ê°€ AWS Secret Managerì—ì„œ ìµœì‹  ê°’ì„ ê°€ì ¸ì™€ í•´ë‹¹ ê°’ì„ Kubernetes Secrets ê°ì²´ì— ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.</p>\n<p></p>\n<p>íšŒì „-íˆ¬í‘œ-ê°„ê²©ì€ ê¸°ë³¸ì ìœ¼ë¡œ 2ë¶„ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆì§€ë§Œ, ì†ì„± rotationPollIntervalì„ ì„¤ì •í•¨ìœ¼ë¡œì¨ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>\n<ul>\n<li>Helm ì°¨íŠ¸ ì„¤ì¹˜</li>\n</ul>\n<pre><code class=\"hljs language-js\"># <span class=\"hljs-title class_\">Helm</span> ì°¨íŠ¸ ì„¤ì¹˜\nhelm install -n kube-system csi-secrets-store secrets-store-csi-driver/secrets-store-csi-driver -f secrets-store-csi-driver.<span class=\"hljs-property\">yaml</span>\n</code></pre>\n<h1>ë‹¨ê³„ 3: AWS Secret Managerì— í…ŒìŠ¤íŠ¸ ì‹œí¬ë¦¿ ìƒì„±</h1>\n<p></p>\n<p>AWS Secret Managerì—ì„œ í…ŒìŠ¤íŠ¸ ì‹œí¬ë¦¿ì„ ìƒì„±í•  ê²ƒì…ë‹ˆë‹¤.</p>\n<pre><code class=\"hljs language-js\">aws secretsmanager create-secret \\\n    --name my-test-secret \\\n    --description <span class=\"hljs-string\">\"CLIë¡œ ìƒì„±í•œ ë‚´ í…ŒìŠ¤íŠ¸ ì‹œí¬ë¦¿.\"</span> \\\n    --secret-string <span class=\"hljs-string\">\"{\\\"user\\\":\\\"my-user\\\",\\\"password\\\":\\\"ì˜ˆì‹œ-ë¹„ë°€ë²ˆí˜¸\\\"}\"</span>\n</code></pre>\n<h1>ë‹¨ê³„ 4: Kubernetes ServiceAccount ìƒì„±</h1>\n<p>ì´ì œ IAM ì—­í• ì„ ê°€ì •í•  ìˆ˜ ìˆë„ë¡ íŒŒë“œì— í—ˆìš©í•˜ëŠ” ServiceAccountë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ServiceAccountëŠ” K8s ë°°í¬ì—ì„œ ì‚¬ìš©ë  ê²ƒì…ë‹ˆë‹¤.</p>\n<p></p>\n<p>serviceaccount.yamlì´ë¼ëŠ” ì´ë¦„ì˜ íŒŒì¼ì„ ìƒì„±í•´ì£¼ì„¸ìš”.</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">ServiceAccount</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">&#x3C;your_service_account_name></span> <span class=\"hljs-comment\"># ì´ ì´ë¦„ì€ IAM ì‹ ë¢° ì •ì±…ì„ ë§Œë“¤ ë•Œ ì§€ì •í•œ ì´ë¦„ê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.</span>\n  <span class=\"hljs-attr\">annotations:</span>\n    <span class=\"hljs-attr\">eks.amazonaws.com/role-arn:</span> <span class=\"hljs-string\">&#x3C;IAM_ROLE_ARN></span>\n</code></pre>\n<p>ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ K8sì—ì„œ ì„œë¹„ìŠ¤ ê³„ì •ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>\n<pre><code class=\"hljs language-bash\">kubectl apply -f serviceaccount.yaml\n</code></pre>\n<p></p>\n<h1>ë‹¨ê³„ 5: í…ŒìŠ¤íŠ¸ ê°ì²´ ìƒì„±í•˜ê¸°</h1>\n<p>ì´ì œ í•„ìš”í•œ ëª¨ë“  ë¦¬ì†ŒìŠ¤ë¥¼ ë°°í¬í–ˆìŠµë‹ˆë‹¤. ì´ì œ í…ŒìŠ¤íŠ¸ ê°ì²´ë¥¼ ë§Œë“¤ì–´ ë´…ì‹œë‹¤.</p>\n<ul>\n<li>ì´ë¦„ì´ â€œmy-test-secret-manifest.yamlâ€ì¸ íŒŒì¼ ìƒì„±</li>\n</ul>\n<pre><code class=\"hljs language-js\">---\n<span class=\"hljs-attr\">apiVersion</span>: secrets-store.<span class=\"hljs-property\">csi</span>.<span class=\"hljs-property\">x</span>-k8s.<span class=\"hljs-property\">io</span>/v1\n<span class=\"hljs-attr\">kind</span>: <span class=\"hljs-title class_\">SecretProviderClass</span>\n<span class=\"hljs-attr\">metadata</span>:\n  <span class=\"hljs-attr\">name</span>: aws-secrets-provider<span class=\"hljs-keyword\">class</span>\n<span class=\"hljs-title class_\">spec</span>:\n  <span class=\"hljs-attr\">provider</span>: aws\n  <span class=\"hljs-attr\">secretObjects</span>:\n    - <span class=\"hljs-attr\">secretName</span>: my-test-k8s-secret\n      <span class=\"hljs-attr\">type</span>: <span class=\"hljs-title class_\">Opaque</span>\n      <span class=\"hljs-attr\">data</span>:\n        - <span class=\"hljs-attr\">objectName</span>: user\n          <span class=\"hljs-attr\">key</span>: user\n        - <span class=\"hljs-attr\">objectName</span>: password\n          <span class=\"hljs-attr\">key</span>: password\n  <span class=\"hljs-attr\">parameters</span>:\n    <span class=\"hljs-attr\">objects</span>: |\n      - <span class=\"hljs-attr\">objectName</span>: <span class=\"hljs-attr\">arn</span>:<span class=\"hljs-attr\">aws</span>:<span class=\"hljs-attr\">secretsmanager</span>:&#x3C;<span class=\"hljs-variable constant_\">AWS_REGION</span>>:&#x3C;<span class=\"hljs-variable constant_\">AWS_ACCOUNT_ID</span>>:<span class=\"hljs-attr\">secret</span>:my-test-secret\n        <span class=\"hljs-attr\">jmesPath</span>:\n          - <span class=\"hljs-attr\">path</span>: user\n            <span class=\"hljs-attr\">objectAlias</span>: user\n          - <span class=\"hljs-attr\">path</span>: password\n            <span class=\"hljs-attr\">objectAlias</span>: password\n---\n<span class=\"hljs-attr\">apiVersion</span>: apps/v1\n<span class=\"hljs-attr\">kind</span>: <span class=\"hljs-title class_\">Deployment</span>\n<span class=\"hljs-attr\">metadata</span>:\n  <span class=\"hljs-attr\">name</span>: secret-rotation-test-ubuntu-deployment\n  <span class=\"hljs-attr\">labels</span>:\n    <span class=\"hljs-attr\">app</span>: ubuntu\n<span class=\"hljs-attr\">spec</span>:\n  <span class=\"hljs-attr\">replicas</span>: <span class=\"hljs-number\">1</span>\n  <span class=\"hljs-attr\">selector</span>:\n    <span class=\"hljs-attr\">matchLabels</span>:\n      <span class=\"hljs-attr\">app</span>: ubuntu\n  <span class=\"hljs-attr\">template</span>:\n    <span class=\"hljs-attr\">metadata</span>:\n      <span class=\"hljs-attr\">labels</span>:\n        <span class=\"hljs-attr\">app</span>: ubuntu\n    <span class=\"hljs-attr\">spec</span>:\n      <span class=\"hljs-attr\">serviceAccountName</span>: &#x3C;your_service_account_name> # ì´ ì´ë¦„ì€ ë‹¨ê³„ <span class=\"hljs-number\">4</span>ì—ì„œ ë§Œë“  ì„œë¹„ìŠ¤ ê³„ì • ì´ë¦„ê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤\n      <span class=\"hljs-attr\">volumes</span>:\n      - <span class=\"hljs-attr\">name</span>: mount-secrets-access\n        <span class=\"hljs-attr\">csi</span>:\n          <span class=\"hljs-attr\">driver</span>: secrets-store.<span class=\"hljs-property\">csi</span>.<span class=\"hljs-property\">k8s</span>.<span class=\"hljs-property\">io</span>\n          <span class=\"hljs-attr\">readOnly</span>: <span class=\"hljs-literal\">true</span>\n          <span class=\"hljs-attr\">volumeAttributes</span>:\n            <span class=\"hljs-attr\">secretProviderClass</span>: <span class=\"hljs-string\">\"aws-secrets-providerclass\"</span>\n      <span class=\"hljs-attr\">containers</span>:\n      - <span class=\"hljs-attr\">name</span>: ubuntu\n        <span class=\"hljs-attr\">image</span>: ubuntu\n        <span class=\"hljs-attr\">command</span>: [<span class=\"hljs-string\">\"sleep\"</span>, <span class=\"hljs-string\">\"123456\"</span>]\n        <span class=\"hljs-attr\">env</span>:\n        - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-variable constant_\">USER</span>\n          <span class=\"hljs-attr\">valueFrom</span>:\n            <span class=\"hljs-attr\">secretKeyRef</span>:\n              <span class=\"hljs-attr\">name</span>: my-test-k8s-secret\n              <span class=\"hljs-attr\">key</span>: user\n        - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-variable constant_\">PASSWORD</span>\n          <span class=\"hljs-attr\">valueFrom</span>:\n            <span class=\"hljs-attr\">secretKeyRef</span>:\n              <span class=\"hljs-attr\">name</span>: my-test-k8s-secret\n              <span class=\"hljs-attr\">key</span>: password\n        <span class=\"hljs-attr\">volumeMounts</span>:\n        - <span class=\"hljs-attr\">name</span>: mount-secrets-access\n          <span class=\"hljs-attr\">mountPath</span>: <span class=\"hljs-string\">\"/mnt/aws-secrets\"</span>\n          <span class=\"hljs-attr\">readOnly</span>: <span class=\"hljs-literal\">true</span>\n</code></pre>\n<p></p>\n<ol start=\"2\">\n<li>manifestë¥¼ ì ìš©í•˜ì‹­ì‹œì˜¤</li>\n</ol>\n<pre><code class=\"hljs language-js\">kubectl apply -f my-test-secret-manifest.<span class=\"hljs-property\">yaml</span>\n</code></pre>\n<ol start=\"3\">\n<li>ë‹¤ìŒ ë¦¬ì†ŒìŠ¤ê°€ ìƒì„±ë©ë‹ˆë‹¤.</li>\n</ol>\n<ul>\n<li>SecretProviderClass ë¦¬ì†ŒìŠ¤ - AWS Secret Managerì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ K8s Secretë¥¼ ìƒì„±í•©ë‹ˆë‹¤</li>\n<li>ë³¼ë¥¨ ë§ˆìš´íŠ¸ê°€ ìˆëŠ” ë°°í¬ - SecretProviderClassë¥¼ ë³¼ë¥¨ìœ¼ë¡œ ë§ˆìš´íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤</li>\n<li>Kubernetes Secret - íŒŒë“œ ë‚´ì—ì„œ í™˜ê²½ ë³€ìˆ˜ë¡œ ì£¼ì…ë©ë‹ˆë‹¤</li>\n</ul>\n<p></p>\n<p>ì•„ë˜ ë‹¤ì´ì–´ê·¸ë¨ì€ YAMLì„ ì ìš©í•  ë•Œ ë’·ë‹¨ì—ì„œ ë¬´ìŠ¨ ì¼ì´ ë²Œì–´ì§€ëŠ”ì§€ ì˜ ì‹œê°í™”í•œ ê²ƒì…ë‹ˆë‹¤.</p>\n<p><img src=\"/assets/img/2024-06-19-KubernetesAutoRestartDeploymentswhenK8sConfigMaporSecretisUpdated_1.png\" alt=\"ë‹¤ì´ì–´ê·¸ë¨\"></p>\n<ol start=\"4\">\n<li>ëª¨ë“  ê²ƒì´ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”.</li>\n</ol>\n<pre><code class=\"hljs language-js\"># <span class=\"hljs-title class_\">SecretProviderClass</span> í™•ì¸\nkubectl get <span class=\"hljs-title class_\">SecretProviderClass</span> aws-secrets-providerclass -o yaml\n\n# ë°°í¬ í™•ì¸\nkubectl get deploy secret-rotation-test-ubuntu-deployment -o yaml\n\n# <span class=\"hljs-title class_\">Pod</span> í™•ì¸\nkubectl get po &#x3C;pod_name> -o yaml\n\n# <span class=\"hljs-title class_\">Secret</span> ê°€ì ¸ì˜¤ê¸°\nkubectl get secret my-test-k8s-secret -o yaml\n</code></pre>\n<p></p>\n<h1>ë‹¨ê³„ 6: Reloader ì„¤ì¹˜í•˜ê¸°</h1>\n<p>ReloaderëŠ” ConfigMapê³¼ Secretì˜ ë³€ê²½ ì‚¬í•­ì„ ê°ì§€í•˜ê³  ê´€ë ¨ëœ DeploymentConfig, Deployment, DaemonSet, StatefulSet ë° Rolloutê³¼ í•¨ê»˜ Podì˜ ë¡¤ë§ ì—…ê·¸ë ˆì´ë“œë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>\n<ul>\n<li>Reloader Helm Repo ì¶”ê°€</li>\n</ul>\n<pre><code class=\"hljs language-js\"># <span class=\"hljs-title class_\">Helm</span> <span class=\"hljs-title class_\">Repo</span> ì¶”ê°€\nhelm repo add stakater <span class=\"hljs-attr\">https</span>:<span class=\"hljs-comment\">//stakater.github.io/stakater-charts</span>\n</code></pre>\n<p></p>\n<ol start=\"2\">\n<li>ê¸°ë³¸ê°’ ê°€ì ¸ì˜¤ê¸°</li>\n</ol>\n<pre><code class=\"hljs language-js\"># ê¸°ë³¸ê°’ ê°€ì ¸ì˜¤ê¸°\nhelm show values stakater/reloader > reloader.<span class=\"hljs-property\">yaml</span>\n</code></pre>\n<ol start=\"3\">\n<li>reloader.yaml íŒŒì¼ ì—…ë°ì´íŠ¸í•˜ê¸°</li>\n</ol>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-attr\">reloader</span>:\n  # ë¦¬ë”ì‹­ ì„ ì¶œì„ í™œì„±í™”í•˜ë ¤ë©´ <span class=\"hljs-literal\">true</span>ë¡œ ì„¤ì •í•˜ì—¬ ì—¬ëŸ¬ ë ˆí”Œë¦¬ì¹´ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n  <span class=\"hljs-attr\">enableHA</span>: <span class=\"hljs-literal\">true</span>\n  <span class=\"hljs-attr\">deployment</span>:\n    # ì—¬ëŸ¬ ë ˆí”Œë¦¬ì¹´ë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ reloader.<span class=\"hljs-property\">enableHA</span> = <span class=\"hljs-literal\">true</span>ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.\n    <span class=\"hljs-attr\">replicas</span>: <span class=\"hljs-number\">2</span>\n</code></pre>\n<p></p>\n<ol start=\"4\">\n<li>Helm ì°¨íŠ¸ ì„¤ì¹˜</li>\n</ol>\n<pre><code class=\"hljs language-js\"># <span class=\"hljs-title class_\">Helm</span> ì°¨íŠ¸ ì„¤ì¹˜\nhelm install reloader -f reloader.<span class=\"hljs-property\">yaml</span> stakater/reloader -n kube-system\n</code></pre>\n<h1>ë‹¨ê³„ 7: Secret ì—…ë°ì´íŠ¸ë¡œ í…ŒìŠ¤íŠ¸í•˜ê¸°</h1>\n<ul>\n<li>ReloaderëŠ” ì£¼ì„ì— ì˜í–¥ì„ ë°›ìŠµë‹ˆë‹¤.\nê¸°ë³¸ ì£¼ì„ reloader.stakater.com/autoëŠ” ì£¼ìš” ë©”íƒ€ë°ì´í„°ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ì•„ë˜ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ë°°í¬ì— ì£¼ì„ì„ ì¶”ê°€í•˜ì„¸ìš”.</li>\n</ul>\n<p></p>\n<pre><code class=\"hljs language-js\"># ë°°í¬ ì£¼ì„ ì¶”ê°€\nkubectl annotate deployment secret-rotation-test-ubuntu-deployment <span class=\"hljs-string\">\"reloader.stakater.com/auto=true\"</span>\n</code></pre>\n<p>ë˜ëŠ” ë‹¤ìŒ ë¸”ë¡ìœ¼ë¡œ ë°°í¬ íŒŒì¼ì„ í¸ì§‘í•˜ê³  ì ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-attr\">metadata</span>:\n  <span class=\"hljs-attr\">annotations</span>:\n    reloader.<span class=\"hljs-property\">stakater</span>.<span class=\"hljs-property\">com</span>/<span class=\"hljs-attr\">auto</span>: <span class=\"hljs-string\">\"true\"</span>\n</code></pre>\n<ol start=\"2\">\n<li>AWS Secret Managerì—ì„œ ì‹œí¬ë¦¿ ì—…ë°ì´íŠ¸í•˜ê¸°</li>\n</ol>\n<p></p>\n<pre><code class=\"hljs language-js\">aws secretsmanager put-secret-value \\\n      --secret-id my-test-secret \\\n      --secret-string <span class=\"hljs-string\">\"{\\\"user\\\":\\\"diegor\\\",\\\"password\\\":\\\"SAMPLE-PASSWORD\\\"}\"</span>\n</code></pre>\n<ol start=\"3\">\n<li>í•œ ë²ˆ ì‹œí¬ë¦¿ì´ AWS ì‹œí¬ë¦¿ ìŠ¤í† ì–´ csi ë“œë¼ì´ë²„ì— ì—…ë°ì´íŠ¸ë˜ë©´ K8s ì‹œí¬ë¦¿ì´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤. K8s ì‹œí¬ë¦¿ì´ ì—…ë°ì´íŠ¸ë˜ë©´ Reloaderê°€ ë¡¤ì•„ì›ƒì„ ë‹¤ì‹œ ì‹œì‘í•˜ë„ë¡ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.</li>\n</ol>\n<pre><code class=\"hljs language-js\"># K8s ì‹œí¬ë¦¿ì„ í™•ì¸í•˜ì„¸ìš”. ìƒˆë¡œìš´ ê°’ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.\nkubectl get secret my-test-k8s-secret -o yaml\n\n# <span class=\"hljs-title class_\">Pod</span>ë¥¼ í™•ì¸í•˜ì„¸ìš”. ëª‡ ì´ˆ ì „ì— ì‹œì‘ë˜ì—ˆì–´ì•¼ í•©ë‹ˆë‹¤.\nkubectl get po\n\n# <span class=\"hljs-title class_\">Reloader</span> íŒŸì˜ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.\nkubectl logs &#x3C;reloader-pod-name> -n kube-system\n\n# <span class=\"hljs-title class_\">Pod</span>ë¡œ ì‹¤í–‰ í›„ ìƒˆë¡œìš´ ê°’ì„ í™•ì¸í•˜ì„¸ìš”.\nkubectl exec -it &#x3C;pod_name> -- bash\n\n# <span class=\"hljs-title class_\">Pod</span>ì— ë“¤ì–´ê°„ í›„ <span class=\"hljs-string\">`env`</span> ëª…ë ¹ì„ ì‹¤í–‰í•˜ì„¸ìš”. <span class=\"hljs-title class_\">Pod</span>ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  í™˜ê²½ ë³€ìˆ˜ê°€ ì¶œë ¥ë©ë‹ˆë‹¤.\n</code></pre>\n<h1>ë‹¨ê³„ 8: ConfigMap ì—…ë°ì´íŠ¸ë¥¼ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.</h1>\n<p></p>\n<ul>\n<li>\"my-test-cm-manifest.yaml\" íŒŒì¼ì„ ìƒì„±í•´ì£¼ì„¸ìš”.</li>\n</ul>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-meta\">---</span>\n<span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">ConfigMap</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">my-test-k8s-cm</span>\n<span class=\"hljs-attr\">data:</span>\n  <span class=\"hljs-attr\">myvalue:</span> <span class=\"hljs-string\">\"Hello World\"</span>\n  <span class=\"hljs-attr\">drink:</span> <span class=\"hljs-string\">coffee</span>\n<span class=\"hljs-meta\">---</span>\n<span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps/v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">Deployment</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">reloader-poc-ubuntu-deployment</span>\n  <span class=\"hljs-attr\">labels:</span>\n    <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">ubuntu</span>\n  <span class=\"hljs-attr\">annotations:</span>\n    <span class=\"hljs-attr\">reloader.stakater.com/auto:</span> <span class=\"hljs-string\">\"true\"</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">replicas:</span> <span class=\"hljs-number\">1</span>\n  <span class=\"hljs-attr\">selector:</span>\n    <span class=\"hljs-attr\">matchLabels:</span>\n      <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">ubuntu</span>\n  <span class=\"hljs-attr\">template:</span>\n    <span class=\"hljs-attr\">metadata:</span>\n      <span class=\"hljs-attr\">labels:</span>\n        <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">ubuntu</span>\n    <span class=\"hljs-attr\">spec:</span>\n      <span class=\"hljs-attr\">containers:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ubuntu</span>\n          <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">ubuntu</span>\n          <span class=\"hljs-attr\">command:</span> [<span class=\"hljs-string\">\"sleep\"</span>, <span class=\"hljs-string\">\"123456\"</span>]\n          <span class=\"hljs-attr\">env:</span>\n            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">DRINK</span>\n              <span class=\"hljs-attr\">valueFrom:</span>\n                <span class=\"hljs-attr\">configMapKeyRef:</span>\n                  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">my-test-k8s-cm</span>\n                  <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">drink</span>\n            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">MYVALUE</span>\n              <span class=\"hljs-attr\">valueFrom:</span>\n                <span class=\"hljs-attr\">configMapKeyRef:</span>\n                  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">my-test-k8s-cm</span>\n                  <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">myvalue</span>\n</code></pre>\n<ol start=\"2\">\n<li>ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì ìš©</li>\n</ol>\n<pre><code class=\"hljs language-bash\">kubectl apply -f my-test-cm-manifest.yaml\n</code></pre>\n<p></p>\n<ol start=\"3\">\n<li>my-test-cm-manifest.yaml íŒŒì¼ì—ì„œ configmapì„ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.</li>\n</ol>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-meta\">---</span>\n<span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">ConfigMap</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">my-test-k8s-cm</span>\n<span class=\"hljs-attr\">data:</span>\n  <span class=\"hljs-attr\">myvalue:</span> <span class=\"hljs-string\">\"ì•ˆë…•í•˜ì„¸ìš”\"</span>\n  <span class=\"hljs-attr\">drink:</span> <span class=\"hljs-string\">ì°¨</span>\n</code></pre>\n<ol start=\"4\">\n<li>íŒŒì¼ì„ ë‹¤ì‹œ ì ìš©í•˜ì„¸ìš”.</li>\n</ol>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-string\">kubectl</span> <span class=\"hljs-string\">apply</span> <span class=\"hljs-string\">-f</span> <span class=\"hljs-string\">my-test-cm-manifest.yaml</span>\n</code></pre>\n<p></p>\n<ol start=\"5\">\n<li>í™•ì¸</li>\n</ol>\n<pre><code class=\"hljs language-js\"># <span class=\"hljs-title class_\">ConfigMap</span> í™•ì¸\nkubectl get cm my-test-k8s-cm -o yaml\n\n# <span class=\"hljs-title class_\">Pod</span> í™•ì¸\nkubectl get po\n\n# <span class=\"hljs-title class_\">Pod</span>ì— ì ‘ì†í•˜ì—¬ ìƒˆ ê°’ í™•ì¸\nkubectl exec -it &#x3C;pod_name> -- bash\n\n# <span class=\"hljs-title class_\">Pod</span>ì— ë“¤ì–´ê°„ í›„ <span class=\"hljs-string\">`env`</span> ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ <span class=\"hljs-title class_\">Pod</span> ë‚´ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  í™˜ê²½ ë³€ìˆ˜ê°€ ì¶œë ¥ë©ë‹ˆë‹¤\n</code></pre>\n<p>ì¶•í•˜í•©ë‹ˆë‹¤!!! secret-store-csi-driverì™€ reloaderë¥¼ ì„±ê³µì ìœ¼ë¡œ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.</p>\n<p>ê°ì‚¬í•©ë‹ˆë‹¤!!!</p>\n<p></p>\n<h2>ì°¸ê³  ìë£Œ:</h2>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/secretsmanager/latest/userguide/integrating_csi_driver.html\" rel=\"nofollow\" target=\"_blank\">AWS ê³µì‹ ë¬¸ì„œ - CSI ë“œë¼ì´ë²„ í†µí•©</a></li>\n<li><a href=\"https://blog.bootlabstech.com/aws-secrets-manager-in-kubernetes-secret-rotation-and-reloader\" rel=\"nofollow\" target=\"_blank\">Bootlabs ê¸°ìˆ  ë¸”ë¡œê·¸ - AWS Secrets Manager in Kubernetes ì‹œí¬ë¦¿ íšŒì „ê³¼ ë¦¬ë¡œë”</a></li>\n<li><a href=\"https://secrets-store-csi-driver.sigs.k8s.io/topics/secret-auto-rotation\" rel=\"nofollow\" target=\"_blank\">Secrets Store CSI ë“œë¼ì´ë²„ ê³µì‹ í™ˆí˜ì´ì§€ - ì‹œí¬ë¦¿ ìë™ íšŒì „</a></li>\n<li><a href=\"https://github.com/kubernetes-sigs/secrets-store-csi-driver/blob/main/charts/secrets-store-csi-driver/values.yaml\" rel=\"nofollow\" target=\"_blank\">Secrets Store CSI ë“œë¼ì´ë²„ ì°¨íŠ¸ ê°’ ì„¤ì • íŒŒì¼</a></li>\n<li><a href=\"https://github.com/stakater/Reloader/tree/master\" rel=\"nofollow\" target=\"_blank\">Reloader GitHub ì €ì¥ì†Œ</a></li>\n<li><a href=\"https://github.com/stakater/Reloader/blob/master/docs/Verify-Reloader-Working.md\" rel=\"nofollow\" target=\"_blank\">Reloader ì‘ë™ í™•ì¸ ë¬¸ì„œ</a></li>\n<li><a href=\"https://github.com/stakater/Reloader/blob/master/docs/How-it-works.md\" rel=\"nofollow\" target=\"_blank\">Reloader ì‘ë™ ë°©ì‹ ë¬¸ì„œ</a></li>\n</ul>\n<h1>ê°„ë‹¨íˆ ë§í•˜ìë©´ ğŸš€</h1>\n<p>In Plain English ì»¤ë®¤ë‹ˆí‹°ì˜ ì¼ì›ì´ ë˜ì–´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ê³„ì† ì°¸ì—¬í•´ ì£¼ì„¸ìš”:</p>\n<p></p>\n<ul>\n<li>ì‘ê°€ì—ê²Œ ë°•ìˆ˜ë¥¼ ë³´ë‚´ê³  íŒ”ë¡œìš°ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš” ï¸ğŸ‘ï¸ï¸</li>\n<li>íŒ”ë¡œìš°í•˜ê¸°: X | LinkedIn | YouTube | Discord | Newsletter</li>\n<li>ë‹¤ë¥¸ í”Œë«í¼ì—ì„œ ì €í¬ë¥¼ ë§Œë‚˜ë³´ì„¸ìš”: Stackademic | CoFeed | Venture | Cubed</li>\n<li>ì•Œê³ ë¦¬ì¦˜ ì½˜í…ì¸ ë¥¼ ë‹¤ë¤„ì•¼ í•˜ëŠ” ë¸”ë¡œê·¸ í”Œë«í¼ì— ì§€ì³¤ë‚˜ìš”? Differë¥¼ ì‹œë„í•´ë³´ì„¸ìš”</li>\n<li>PlainEnglish.ioì—ì„œ ë” ë§ì€ ì½˜í…ì¸ ë¥¼ ë§Œë‚˜ë³´ì„¸ìš”</li>\n</ul>\n</body>\n</html>\n"},"__N_SSG":true}