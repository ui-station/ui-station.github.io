{"pageProps":{"post":{"title":"ì‚¬ìš©ì ì •ì˜ í…Œì´ë¸” í•¨ìˆ˜ UDTF","description":"","date":"2024-05-23 15:41","slug":"2024-05-23-User-definedTableFunctionsUDTF","content":"\n![ì´ë¯¸ì§€](/assets/img/2024-05-23-User-definedTableFunctionsUDTF_0.png)\n\nSpark 3.5ì—ì„œëŠ” íŒŒì´ì¬ ì‚¬ìš©ì ì •ì˜ í…Œì´ë¸” í•¨ìˆ˜(UDTF)ë¥¼ ì†Œê°œí–ˆìŠµë‹ˆë‹¤. ì´ê²ƒì€ ìƒˆë¡œìš´ ì¢…ë¥˜ì˜ ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ì…ë‹ˆë‹¤. ìŠ¤ì¹¼ë¼ í•¨ìˆ˜ëŠ” ê° í˜¸ì¶œì— ëŒ€í•´ í•˜ë‚˜ì˜ ê²°ê³¼ë¥¼ ìƒì„±í•˜ëŠ” ë°˜ë©´, UDTFëŠ” ì¿¼ë¦¬ì˜ FROM ì ˆ ë‚´ì—ì„œ í˜¸ì¶œë˜ë©° ì „ì²´ í…Œì´ë¸”ì„ ì¶œë ¥í•©ë‹ˆë‹¤. UDTF í˜¸ì¶œì€ ìŠ¤ì¹¼ë¼ ì‹ì´ë‚˜ ì™„ì „í•œ ì…ë ¥ í…Œì´ë¸”ì„ ë‚˜íƒ€ë‚´ëŠ” í…Œì´ë¸” ì¸ìˆ˜ ì¤‘ ì–´ë–¤ ê²ƒì´ë“  ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n![ì´ë¯¸ì§€](/assets/img/2024-05-23-User-definedTableFunctionsUDTF_1.png)\n\n## íŒŒì´ì¬ UDTF ì‚¬ìš© ì´ìœ \n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\në§Œì•½ ë‹¤ì–‘í•œ í–‰ê³¼ ì—´ì„ ìƒì„±í•˜ë©´ì„œ íŒŒì´ì¬ì˜ ë‹¤ì–‘í•œ ìƒíƒœê³„ë¥¼ í™œìš©í•˜ê³  ì‹¶ë‹¤ë©´, Python UDTFê°€ ì´ìƒì ì…ë‹ˆë‹¤.\n\n## Python UDTF ëŒ€ Python UDF\n\nSparkì˜ Python UDFëŠ” ì…ë ¥ìœ¼ë¡œ ìŠ¤ì¹¼ë¼ ê°’s ì¤‘ 0ê°œ ì´ìƒì„ ë°›ì•„ë“¤ì´ê³  ë‹¨ì¼ ê°’ì„ ë°˜í™˜í•˜ëŠ” ê²ƒì´ ì„¤ê³„ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê·¸ì— ë°˜í•´, UDTFëŠ” ì—¬ëŸ¬ í–‰ê³¼ ì—´ì„ ë°˜í™˜í•  ìˆ˜ ìˆì–´ UDFì˜ ê¸°ëŠ¥ì„ ë” í™•ì¥ì‹œí‚¬ ìˆ˜ ìˆì–´ ë” ìœ ì—°í•©ë‹ˆë‹¤.\n\n## Python UDTF ëŒ€ SQL UDTF\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\nSQL UDTFsëŠ” íš¨ìœ¨ì ì´ê³  ë‹¤ì¬ë‹¤ëŠ¥í•˜ì§€ë§Œ, Pythonì€ ë” ë‹¤ì–‘í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ ë„êµ¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤. í†µê³„ í•¨ìˆ˜ë‚˜ ë¨¸ì‹  ëŸ¬ë‹ ì¶”ë¡ ê³¼ ê°™ì´ ê³ ê¸‰ ê¸°ìˆ ì´ í•„ìš”í•œ ë³€í™˜ ë˜ëŠ” ê³„ì‚°ì„ ìœ„í•´ì„œëŠ” Python UDTFsê°€ íŠ¹íˆ ìœ ë¦¬í•©ë‹ˆë‹¤.\n\n# LangChainê³¼ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” UDTF\n\nì´ì „ ì˜ˆì œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë³´ì¼ ìˆ˜ ìˆì§€ë§Œ, Python UDTFsë¥¼ LangChainê³¼ í†µí•©í•˜ì—¬ ë” í¥ë¯¸ë¡œìš´ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ íƒìƒ‰í•´ ë´…ì‹œë‹¤.\n\n```js\nfrom langchain.chains import LLMChain\nfrom langchain.llms import OpenAI\nfrom langchain.prompts import PromptTemplate\nfrom pyspark.sql.functions import lit, udtf\n\n@udtf(returnType=\"keyword: string\")\nclass KeywordsGenerator:\n    \"\"\"\n    Generate a list of comma separated keywords about a topic using an LLM.\n    Output only the keywords.\n    \"\"\"\n    def __init__(self):\n        llm = OpenAI(model_name=\"gpt-4\", openai_api_key=<your-key>)\n        prompt = PromptTemplate(\n            input_variables=[\"topic\"],\n            template=\"generate a couple of comma separated keywords about {topic}. Output only the keywords.\"\n        )\n        self.chain = LLMChain(llm=llm, prompt=prompt)\n\n    def eval(self, topic: str):\n        response = self.chain.run(topic)\n        keywords = [keyword.strip() for keyword in response.split(\",\")]\n        for keyword in keywords:\n            yield (keyword, )\n```\n\n<!-- ui-station ì‚¬ê°í˜• -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\nì„¸ë¶€ ì •ë³´:-\n\nì¦ê±°ìš´ í•™ìŠµí•˜ì„¸ìš” ğŸ™‚ !!!!!!\n","ogImage":{"url":"/assets/img/2024-05-23-User-definedTableFunctionsUDTF_0.png"},"coverImage":"/assets/img/2024-05-23-User-definedTableFunctionsUDTF_0.png","tag":["Tech"],"readingTime":3},"content":"<!doctype html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\">\n<meta content=\"width=device-width, initial-scale=1\" name=\"viewport\">\n</head>\n<body>\n<p><img src=\"/assets/img/2024-05-23-User-definedTableFunctionsUDTF_0.png\" alt=\"ì´ë¯¸ì§€\"></p>\n<p>Spark 3.5ì—ì„œëŠ” íŒŒì´ì¬ ì‚¬ìš©ì ì •ì˜ í…Œì´ë¸” í•¨ìˆ˜(UDTF)ë¥¼ ì†Œê°œí–ˆìŠµë‹ˆë‹¤. ì´ê²ƒì€ ìƒˆë¡œìš´ ì¢…ë¥˜ì˜ ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ì…ë‹ˆë‹¤. ìŠ¤ì¹¼ë¼ í•¨ìˆ˜ëŠ” ê° í˜¸ì¶œì— ëŒ€í•´ í•˜ë‚˜ì˜ ê²°ê³¼ë¥¼ ìƒì„±í•˜ëŠ” ë°˜ë©´, UDTFëŠ” ì¿¼ë¦¬ì˜ FROM ì ˆ ë‚´ì—ì„œ í˜¸ì¶œë˜ë©° ì „ì²´ í…Œì´ë¸”ì„ ì¶œë ¥í•©ë‹ˆë‹¤. UDTF í˜¸ì¶œì€ ìŠ¤ì¹¼ë¼ ì‹ì´ë‚˜ ì™„ì „í•œ ì…ë ¥ í…Œì´ë¸”ì„ ë‚˜íƒ€ë‚´ëŠ” í…Œì´ë¸” ì¸ìˆ˜ ì¤‘ ì–´ë–¤ ê²ƒì´ë“  ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>\n<p><img src=\"/assets/img/2024-05-23-User-definedTableFunctionsUDTF_1.png\" alt=\"ì´ë¯¸ì§€\"></p>\n<h2>íŒŒì´ì¬ UDTF ì‚¬ìš© ì´ìœ </h2>\n<!-- ui-station ì‚¬ê°í˜• -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>ë§Œì•½ ë‹¤ì–‘í•œ í–‰ê³¼ ì—´ì„ ìƒì„±í•˜ë©´ì„œ íŒŒì´ì¬ì˜ ë‹¤ì–‘í•œ ìƒíƒœê³„ë¥¼ í™œìš©í•˜ê³  ì‹¶ë‹¤ë©´, Python UDTFê°€ ì´ìƒì ì…ë‹ˆë‹¤.</p>\n<h2>Python UDTF ëŒ€ Python UDF</h2>\n<p>Sparkì˜ Python UDFëŠ” ì…ë ¥ìœ¼ë¡œ ìŠ¤ì¹¼ë¼ ê°’s ì¤‘ 0ê°œ ì´ìƒì„ ë°›ì•„ë“¤ì´ê³  ë‹¨ì¼ ê°’ì„ ë°˜í™˜í•˜ëŠ” ê²ƒì´ ì„¤ê³„ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê·¸ì— ë°˜í•´, UDTFëŠ” ì—¬ëŸ¬ í–‰ê³¼ ì—´ì„ ë°˜í™˜í•  ìˆ˜ ìˆì–´ UDFì˜ ê¸°ëŠ¥ì„ ë” í™•ì¥ì‹œí‚¬ ìˆ˜ ìˆì–´ ë” ìœ ì—°í•©ë‹ˆë‹¤.</p>\n<h2>Python UDTF ëŒ€ SQL UDTF</h2>\n<!-- ui-station ì‚¬ê°í˜• -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>SQL UDTFsëŠ” íš¨ìœ¨ì ì´ê³  ë‹¤ì¬ë‹¤ëŠ¥í•˜ì§€ë§Œ, Pythonì€ ë” ë‹¤ì–‘í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ ë„êµ¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤. í†µê³„ í•¨ìˆ˜ë‚˜ ë¨¸ì‹  ëŸ¬ë‹ ì¶”ë¡ ê³¼ ê°™ì´ ê³ ê¸‰ ê¸°ìˆ ì´ í•„ìš”í•œ ë³€í™˜ ë˜ëŠ” ê³„ì‚°ì„ ìœ„í•´ì„œëŠ” Python UDTFsê°€ íŠ¹íˆ ìœ ë¦¬í•©ë‹ˆë‹¤.</p>\n<h1>LangChainê³¼ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” UDTF</h1>\n<p>ì´ì „ ì˜ˆì œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë³´ì¼ ìˆ˜ ìˆì§€ë§Œ, Python UDTFsë¥¼ LangChainê³¼ í†µí•©í•˜ì—¬ ë” í¥ë¯¸ë¡œìš´ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ íƒìƒ‰í•´ ë´…ì‹œë‹¤.</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">from</span> langchain.<span class=\"hljs-property\">chains</span> <span class=\"hljs-keyword\">import</span> <span class=\"hljs-title class_\">LLMChain</span>\n<span class=\"hljs-keyword\">from</span> langchain.<span class=\"hljs-property\">llms</span> <span class=\"hljs-keyword\">import</span> <span class=\"hljs-title class_\">OpenAI</span>\n<span class=\"hljs-keyword\">from</span> langchain.<span class=\"hljs-property\">prompts</span> <span class=\"hljs-keyword\">import</span> <span class=\"hljs-title class_\">PromptTemplate</span>\n<span class=\"hljs-keyword\">from</span> pyspark.<span class=\"hljs-property\">sql</span>.<span class=\"hljs-property\">functions</span> <span class=\"hljs-keyword\">import</span> lit, udtf\n\n@<span class=\"hljs-title function_\">udtf</span>(returnType=<span class=\"hljs-string\">\"keyword: string\"</span>)\n<span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">KeywordsGenerator</span>:\n    <span class=\"hljs-string\">\"\"</span><span class=\"hljs-string\">\"\n    Generate a list of comma separated keywords about a topic using an LLM.\n    Output only the keywords.\n    \"</span><span class=\"hljs-string\">\"\"</span>\n    def <span class=\"hljs-title function_\">__init__</span>(self):\n        llm = <span class=\"hljs-title class_\">OpenAI</span>(model_name=<span class=\"hljs-string\">\"gpt-4\"</span>, openai_api_key=&#x3C;your-key>)\n        prompt = <span class=\"hljs-title class_\">PromptTemplate</span>(\n            input_variables=[<span class=\"hljs-string\">\"topic\"</span>],\n            template=<span class=\"hljs-string\">\"generate a couple of comma separated keywords about {topic}. Output only the keywords.\"</span>\n        )\n        self.<span class=\"hljs-property\">chain</span> = <span class=\"hljs-title class_\">LLMChain</span>(llm=llm, prompt=prompt)\n\n    def <span class=\"hljs-built_in\">eval</span>(self, <span class=\"hljs-attr\">topic</span>: str):\n        response = self.<span class=\"hljs-property\">chain</span>.<span class=\"hljs-title function_\">run</span>(topic)\n        keywords = [keyword.<span class=\"hljs-title function_\">strip</span>() <span class=\"hljs-keyword\">for</span> keyword <span class=\"hljs-keyword\">in</span> response.<span class=\"hljs-title function_\">split</span>(<span class=\"hljs-string\">\",\"</span>)]\n        <span class=\"hljs-keyword\">for</span> keyword <span class=\"hljs-keyword\">in</span> <span class=\"hljs-attr\">keywords</span>:\n            <span class=\"hljs-keyword\">yield</span> (keyword, )\n</code></pre>\n<!-- ui-station ì‚¬ê°í˜• -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>ì„¸ë¶€ ì •ë³´:-</p>\n<p>ì¦ê±°ìš´ í•™ìŠµí•˜ì„¸ìš” ğŸ™‚ !!!!!!</p>\n</body>\n</html>\n"},"__N_SSG":true}