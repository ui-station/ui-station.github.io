{"pageProps":{"post":{"title":"쿠버네티스 이스티오 앰비언트 메쉬 투어  1부 설정 및 Z터널 사용 방법","description":"","date":"2024-06-23 23:14","slug":"2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel","content":"\n피츠오는 앰비언트 모드로 전환하고 있어요 — 사이드카 없는 모델로 말이죠. 마침내 우리는 CPU와 메모리 소비가 많은 사이드카를 버릴 수 있게 되었어요!\n\n다가오는 장마시즌을 맞아, 저는 피츠오 앰비언트 메시에 간접적으로 참여해보기로 했어요.\n\n이 블로그를 사용하여 여행을 문서화하고, 비슷한 생각을 가진 피츠오 사용자들이 함께 따라올 수 있게 도와볼 거예요 :P.\n\n![이미지](/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_0.png)\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n제가 나름대로 번역해보겠습니다:\n\n안녕하세요! Part 1에서는 주변 메시 실험을 위해 로컬 클러스터 설정을 완벽하게 진행할 예정입니다. 그런 다음 메시의 ztunnel 구성 요소를 탐험할 것입니다.\n\nPart 2에서는 L4 인증 정책에 대해 이야기하고 waypoint 프록시를 시작하는 방법을 살펴볼 것입니다.\n\n# Ambient란 무엇인가요?\n\nIstio Ambient Mesh는 사이드카 없이 Istio의 새로운 데이터플레인 모드입니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n일반적인 Istio 모드에서는 모든 응용 프로그램 Pod이 envoy 프록시로 주입되었다는 것을 기억하십시오. 그러나 이 새로운 모드에서는 응용 프로그램 Pod이 건드리지 않을 거에요 :) 그리고 그들은 자신의 응용 프로그램 컨테이너만 가지게 될 거에요.\n\n![이미지](/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_1.png)\n\n가장 먼저 떠오르는 큰 장점 중 하나는 인프라 비용이 크게 절감된다는 것입니다. 컴퓨팅 코어 및 메모리 관점에서 얼마나 많은 돈을 절약하고 있는지 상상해보세요 !!\n\n![이미지](/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_2.png)\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n# Ambient Architecture\n\n과거와 현재의 Ambient Architecture를 상상해 보는 시간입니다. 데이터 평면의 트래픽 흐름 경로에서 그들이 어떻게 다른지 살펴봅시다.\n\n## Sidecar 모드\n\n![이미지](/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_3.png)\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n이것은 전통적인 사이드카 모델이며 각 서비스 팟에는 애플리케이션 컨테이너와 Envoy 사이드카가 결합되어 있습니다. 애플리케이션으로부터 오고 가는 모든 트래픽은 사이드카에 의해 가로채집니다.\n\n## Ambient 모드, ztunnel 사용\n\n![이미지](/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_4.png)\n\n이 새로운 ambient 모드에서 애플리케이션 팟은 사이드카가 없는 독립적인 팟입니다. 그러나 이 경우에는 클러스터의 각 Kubernetes 노드마다 데몬셋 팟이 실행될 것입니다 - 강력한 ztunnel (제로 트러스트 터널). 노드 내 팟간의 모든 트래픽은 ztunnel에 의해 가로채집됩니다. Ztunnel은 각 노드당 L4 프록시입니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n## Ambient mode, with ztunnel + waypoint\n\n![Image](/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_5.png)\n\nZtunnel은 L4 프록시가 필요한 워크로드 간 네트워킹에 충분합니다. http 헤더 기반 라우팅, L7 권한 부여와 같은 L7 요구 사항을 충족시키기 위해 waypoint 프록시라는 워크로드를 배포합니다. 이는 애플리케이션당 envoy 팟으로, 동일한 노드 또는 다른 노드에서 실행될 수 있습니다.\n\n이 경우 ztunnel에서 생성된 트래픽은 waypoint 프록시에 도달하고, waypoint는 그것을 목적지 ztunnel로 전달합니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n그러므로, 어플리케이션이 L7 처리를 요구하지 않는 경우 waypoint를 없애고 ztunnel만 사용할 수 있습니다. 이전 방식에서는, 우리가 L4 요구사항만 가지고 있더라도 envoy sidecars를 반드시 사용해야 했습니다.\n\n# 클러스터 설정 깊이에 대한 정보\n\n이상적으로 지원되는 환경에서 사용할 수 있는 유효한 CNI 설정으로 Kind 클러스터를 설정하는 데 많은 조정이 필요했습니다. 현재는 어떤 공개 GKE/AKS/EKS k8s 클러스터에 대한 실험을 할 수 있는 권한이 없습니다.\n\n![이미지](/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_6.png)\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n그러므로 로컬 Kind 클러스터를 홈 설정하겠습니다.\n\n## 시스템 사양\n\n- Mac M1 (Apple-Silicon 아키텍처)를 사용하며 기본 구성으로 진행됩니다.\n\n시스템 아키텍처(Linux/Windows/Apple Intel)를 고려하여 비슷하게 진행할 수 있습니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n- Rancher Desktop\n\n저희 k8s 클러스터를 위해 도커 런타임이 필요한데, 저는 SUSE의 Rancher Desktop을 사용할 예정입니다 — https://rancherdesktop.io/.\n\n다른 대안으로는 Docker Desktop이 있습니다 — https://www.docker.com/products/docker-desktop/\n\n- Kind\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n저는 Multi-Node K8s 클러스터가 필요하다고 생각해요. 그래서 우리가 사용할 최상의 도구는 Kind를 이용해 클러스터를 부트스트랩하는 거죠. 여기 https://kind.sigs.k8s.io/docs/user/quick-start 에서 보다 자세한 정보를 얻을 수 있어요.\n\n이를 통해 우리는 k8s 노드에 ssh로 접속하고 노드 구성을 실험해볼 수도 있을 거에요.\n\n그리고 블로그에 나온대로 istio-ambient 프로필을 설치한 후에는 Kind 노드에서 문제가 발생할 수 있어요. 여기 https://kind.sigs.k8s.io/docs/user/known-issues/#pod-errors-due-to-too-many-open-files 에서 문제를 해결할 수 있어요. 영향을 받는 노드의 sysctl.conf를 수정한 후에는 istio-system pods가 문제없이 생성될 거에요.\n\n<img src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_7.png\" />\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n- CNI(Container Networking Interface)\n\n\"Istio Ambient Mode\"은 Calico, Cilium 등과 같은 CNI와 함께 지원됩니다. Kind 클러스터의 기본 CNI는 \"kindnetd\"이며, 저는 직접 테스트해 본 결과 ztunnel 팟이 실행되지 않았습니다. 그래서 다른 CNI가 필요했습니다.\n\n- Cilium CNI도 Mac M1에서 제대로 로드되지 않았습니다. 즉, cilium 데몬셋 팟이 실행되지 않았습니다.\n- 마침내 Calico CNI로 Kind를 설정하는 방법을 찾았습니다. Kind에서 기본 CNI를 비활성화하고 다음과 같이 진행합니다: [https://docs.tigera.io/calico/latest/getting-started/kubernetes/kind](https://docs.tigera.io/calico/latest/getting-started/kubernetes/kind)\n- 이 설정에서 마지막 단계를 따를 수도 있습니다: [https://alexbrand.dev/post/creating-a-kind-cluster-with-calico-networking/](https://alexbrand.dev/post/creating-a-kind-cluster-with-calico-networking/)\n\n# Istio 설치\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n## 클러스터 개요\n\n이스티오를 시작하기 전에 클러스터 스펙을 살펴봅시다.\n\n다음은 Kind 클러스터 설정 스크립트입니다.\n\n마스터 노드 1개와 워커 노드 2개가 있습니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```js\n(⎈|kind-ambient:istio-system)➜  ~ kg 노드\n이름                    상태     역할           생성 시간    버전\nambient-control-plane   준비     제어 플레인    117분     v1.30.0\nambient-worker          준비     <없음>         116분     v1.30.0\nambient-worker2         준비     <없음>         116분     v1.30.0\n```\n\n또한 Calico CNI 데몬세트가 실행 중인지 확인합니다. 클러스터 CoreDNS도 준비되어 있는지 확인합니다.\n\n```js\n(⎈|kind-ambient:kube-system)➜  ~ kgpo\n이름                                            준비     상태      재시작      생성 시간\ncalico-kube-controllers-564985c589-xmsrp        1/1     실행 중  1 (96분 전)  117분\ncalico-node-796kq                               1/1     실행 중  0             116분\ncalico-node-l6fsg                               1/1     실행 중  0             116분\ncalico-node-zkckp                               1/1     실행 중  0             116분\ncoredns-7db6d8ff4d-h88q6                        1/1     실행 중  0             118분\ncoredns-7db6d8ff4d-rtncd                        1/1     실행 중  0             118분\n```\n\n## Istio Ambient 프로필 설치\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n설치는 간단하게 진행됩니다. 여기에서 찾을 수 있어요: [https://istio.io/v1.20/docs/ops/ambient/getting-started/](https://istio.io/v1.20/docs/ops/ambient/getting-started/)\n\n```js\nsabuj $ istioctl install --set profile=ambient --set \"components.ingressGateways[0].enabled=true\" --set \"components.ingressGateways[0].name=istio-ingressgateway\" --skip-confirmation\n✔ Istio core가 설치되었습니다\n✔ Ztunnel이 설치되었습니다\n✔ Istiod가 설치되었습니다\n✔ CNI가 설치되었습니다\n✔ 인그레스 게이트웨이가 설치되었습니다\n✔ 설치가 완료되었습니다\n이 설치를 주입과 유효성 검사를 위한 기본 설정으로 지정합니다.\n```\n\n- 내가 사용 중인 Istio 버전은 다음과 같아요.\n\n```js\n(⎈|kind-ambient:kube-system)➜  ~ istioctl version\nclient version: 1.15.0\ncontrol plane version: 1.22.1\ndata plane version: 1.22.1 (4 프록시)\n```\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n- Ztunnel은 각 노드에서 실행되는 데몬세트입니다 — 이 경우 3개의 노드가 있습니다. istio-system 네임스페이스에서 ztunnel이 제대로 실행 중인지 확인해 봅시다.\n\n```js\n(⎈|kind-ambient:istio-system)➜  ~ kgpo -owide\nNAME                                    READY   STATUS    RESTARTS   AGE    IP               NODE                    NOMINATED NODE   READINESS GATES\nistio-cni-node-7q6z7                    1/1     Running   0          117m   172.18.0.2       ambient-worker2         <none>           <none>\nistio-cni-node-fg6n4                    1/1     Running   0          117m   172.18.0.4       ambient-worker          <none>           <none>\nistio-cni-node-gwvl8                    1/1     Running   0          117m   172.18.0.3       ambient-control-plane   <none>           <none>\nistio-ingressgateway-6f48dfb7db-862sm   1/1     Running   0          117m   192.168.184.70   ambient-worker          <none>           <none>\nistiod-6875bc5c58-n4j7d                 1/1     Running   0          118m   192.168.246.2    ambient-worker2         <none>           <none>\nztunnel-62hp8                           1/1     Running   0          117m   192.168.246.3    ambient-worker2         <none>           <none>\nztunnel-fv5f8                           1/1     Running   0          117m   192.168.184.71   ambient-worker          <none>           <none>\nztunnel-gs52c                           1/1     Running   0          117m   192.168.208.1    ambient-control-plane   <none>           <none>\n\n(⎈|kind-ambient:istio-system)➜  ~ kg ds\nNAME             DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE\nistio-cni-node   3         3         3       3            3           kubernetes.io/os=linux   119m\nztunnel          3         3         3       3            3           kubernetes.io/os=linux   118m\n```\n\n정말로 3개의 파드가 있네요 !\n\n- 비슷하게 Istio-cni는 또 다른 설치된 데몬세트입니다.\n- Istio 제어 평면인 istiod도 실행 중입니다.\n- 우리는 공개 트래픽을 위해 기본 istio ingressgateway도 설치했습니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n# 작업량 설정\n\n이 프로젝트의 모든 매니페스트 파일은 여기에서 찾을 수 있습니다: https://github.com/JanaSabuj/istio-ambient-mesh-exploration\n\n## 안건\n\n- 우리는 앰비언트 프로필 없이 앱을 설정하고, 일반 Istio crds를 사용할 것입니다. 그 후에 앱을 호출할 예정입니다. i) 인그레스 ii) 디버그 클라이언트 pod\n- 그 후에, Istio 데이터 평면 모드를 앰비언트로 전환하고, ztunnel pod를 통해 흐르는 트래픽 경로의 변화를 관찰할 것입니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n## 네임스페이스\n\nambient-demo라는 네임스페이스를 만들어 보겠습니다. 이 네임스페이스에서 앱을 호스팅할 예정입니다.\n\n```js\n(⎈|kind-ambient:istio-system)➜  ~ k create ns ambient-demo\n\n(⎈|kind-ambient:istio-system)➜  ~ kg ns\nNAME                 STATUS   AGE\ndefault              Active   132m\nistio-system         Active   125m\nkube-node-lease      Active   132m\nkube-public          Active   132m\nkube-system          Active   132m\nlocal-path-storage   Active   132m\n```\n\n## 애플리케이션\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n그럼 배포, 서비스 및 서비스 어카운트 yaml을 사용하여 애플리케이션을 배포합니다.\n\n클러스터에서는 다음과 같이 보입니다.\n\n```bash\n(⎈|kind-ambient:ambient-demo)➜  ~ kg all\nNAME                          READY   STATUS    RESTARTS   AGE\npod/httpbin-6f4dc97cb-5dpz9   1/1     Running   0          3m21s\npod/httpbin-6f4dc97cb-swdlb   1/1     Running   0          3m31s\n\nNAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE\nservice/httpbin   ClusterIP   10.96.157.221   <none>        80/TCP    143m\n\nNAME                      READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/httpbin   2/2     2            2           143m\n\nNAME                                 DESIRED   CURRENT   READY   AGE\nreplicaset.apps/httpbin-6f4dc97cb    2         2         2       3m31s\n```\n\n## Istio 구성\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n외부 세계에 노출하기 위해 Istio Gateway 및 Istio VirtualService를 생성하여 Istio Ingress를 통해 액세스할 수 있게 만듭니다.\n\n- 우리는 Istio Ingress 파드에 8081 포트를 통해 게이트웨이를 추가하고 있습니다.\n- 그 다음으로, VirtualService를 통해 ambient-demo 네임스페이스에서 실행되는 httpbin 서비스로 라우팅합니다.\n\n## Istio Ingress를 통한 확인\n\n이제 우리의 응용 프로그램에 액세스할 수 있는지 확인할 수 있습니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```js\n(⎈|kind-ambient:istio-system)➜  ~ kgs\nNAME                   TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)                                      AGE\nistio-ingressgateway   LoadBalancer   10.96.77.172   <pending>     15021:30807/TCP,80:30587/TCP,443:31004/TCP   147m\n```\n\nKind가 인그레스 서비스를 위한 외부 IP를 제공하지 않았기 때문에, 원하는 리스너 8081에서 인그레스 파드를 포트포워딩하여 외부 액세스를 시뮬레이션할 것입니다.\n\n```js\n(⎈|kind-ambient:istio-system)➜  ~ kpf istio-ingressgateway-6f48dfb7db-862sm 8081\nForwarding from 127.0.0.1:8081 -> 8081\nForwarding from [::1]:8081 -> 8081\n```\n\n브라우저에서 127.0.0.1:8081을 입력하여 애플리케이션을 확인할 수 있습니다!\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```js\nhttp://127.0.0.1:8081/\n\nhttpbin.org\n 0.9.2\n[ Base URL: 127.0.0.1:8081/ ]\n간단한 HTTP 요청 및 응답 서비스입니다.\n\n로컬에서 실행: $ docker run -p 80:80 kennethreitz/httpbin\n\n개발자 - 웹사이트\n개발자에게 이메일 보내기\n```\n\n- 또 다른 확인 방법은 로컬에서 curl을 통해 하는 것입니다. 우리는 요청이 istio-envoy 파드에 의해 처리된 것을 확인합니다.\n\n```js\n(⎈|kind-ambient:istio-system)➜  ~ curl 127.0.0.1:8081 -v\n*   Trying 127.0.0.1:8081...\n* Connected to 127.0.0.1 (127.0.0.1) port 8081\n> GET / HTTP/1.1\n> Host: 127.0.0.1:8081\n> User-Agent: curl/8.6.0\n> Accept: */*\n>\n< HTTP/1.1 200 OK\n< server: istio-envoy\n< date: Sun, 16 Jun 2024 11:52:13 GMT\n< content-type: text/html; charset=utf-8\n< content-length: 9593\n< access-control-allow-origin: *\n< access-control-allow-credentials: true\n< x-envoy-upstream-service-time: 271\n<\n<!DOCTYPE html>\n<html lang=\"en\">\n...\n```\n\n## 디버그 클라이언트 파드를 통한 확인\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n우리는 메쉬 내부 호출을 테스트해보려고 합니다. 따라서 각 노드마다 클라이언트 팟이 하나씩 있는 것이 좋습니다. 이를 위해 디버거 데몬세트 클라이언트 워크로드를 설정할 수 있습니다 — https://github.com/digitalocean/doks-debug\n\n사용한 수정된 Manifest: https://gist.github.com/JanaSabuj/a4dd2504752b8c2b30d2d2d05320f7ef\n\n저는 이 데몬세트를 우리 ambient-demo 네임스페이스에 배포했습니다.\n\n```js\n(⎈|kind-ambient:ambient-demo)➜  ~ kg ds\nNAME         DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE\ndoks-debug   3         3         3       3            3           <none>          89m\n\n(⎈|kind-ambient:ambient-demo)➜  ~ kgpo -owide\nNAME                      READY   STATUS    RESTARTS   AGE   IP               NODE                    NOMINATED NODE   READINESS GATES\ndoks-debug-j9mm5          1/1     Running   0          90m   192.168.246.5    ambient-worker2         <none>           <none>\ndoks-debug-rdhgq          1/1     Running   0          90m   192.168.184.73   ambient-worker          <none>           <none>\ndoks-debug-v7cld          1/1     Running   0          90m   192.168.208.3    ambient-control-plane   <none>\n```\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n테스트해 보기 위해 디버그 팟으로 진입하여 k8s fqdn httpbin.ambient-demo.svc.cluster.local을 curl을 시도해 보았습니다.\n\n200 OK를 반환하고 있습니다.\n\n```js\n(⎈|kind-ambient:ambient-demo)➜  ~ k exec -it doks-debug-j9mm5 -- /bin/bash\n\nroot@doks-debug-j9mm5:~# curl httpbin.ambient-demo.svc.cluster.local -v\n*   Trying 10.96.157.221:80...\n* Connected to httpbin.ambient-demo.svc.cluster.local (10.96.157.221) port 80 (#0)\n> GET / HTTP/1.1\n> Host: httpbin.ambient-demo.svc.cluster.local\n> User-Agent: curl/7.88.1\n> Accept: */*\n>\n< HTTP/1.1 200 OK\n< Server: gunicorn/19.9.0\n< Date: Sun, 16 Jun 2024 12:06:11 GMT\n< Connection: keep-alive\n< Content-Type: text/html; charset=utf-8\n< Content-Length: 9593\n< Access-Control-Allow-Origin: *\n< Access-Control-Allow-Credentials: true\n<\n```\n\n# Ambient Injection\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n지금까지 앰비언트 모드가 활성화되지 않았습니다. Istio 게이트웨이에서 추가 된 리스너로 인해 요청은 Istio 인그레스 파드에 도착한 다음 VirtualService를 통해 앱 파드로 라우팅됩니다.\n\n매쉬 내부 호출의 경우, 클라이언트와 서버 파드 사이에 직접적인 포드 간 통신이 이루어집니다.\n\n![이미지](/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_8.png)\n\n앰비언트를 주입하는 동안 우리는 또한 다음 로그를 계속 추적할 것입니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n- istio-cni\n- ztunnel\n\nIstio가 네임스페이스 ambient-demo에 대한 Ambient Dataplane 모드를 활성화하도록 내부적으로 라우트, iptables 등을 설정했는지 확인하려면 아래 명령어를 사용해보세요.\n\n```js\n(⎈|kind-ambient:ambient-demo)➜\n~ kubectl label namespace ambient-demo istio.io/dataplane-mode=ambient\n```\n\n## 관찰된 로그\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n- istio-cni\n\n```js\n(⎈|kind-ambient:ambient-demo)➜ ~ stern istio-cni -n istio-system\n\nistio-cni-node-7q6z7 install-cni 2024-06-16T10:13:59.243451Z info ambient Namespace ambient-demo is enabled in ambient mesh\nistio-cni-node-7q6z7 install-cni 2024-06-16T10:13:59.264500Z info ambient in pod mode - adding pod ambient-demo/httpbin-5bd875fbdd-84vs8 to ztunnel\nistio-cni-node-gwvl8 install-cni 2024-06-16T10:13:59.291505Z info ambient Namespace ambient-demo is enabled in ambient mesh\nistio-cni-node-fg6n4 install-cni 2024-06-16T10:13:59.281587Z info ambient Namespace ambient-demo is enabled in ambient mesh\nistio-cni-node-fg6n4 install-cni 2024-06-16T10:13:59.313668Z info ambient in pod mode - adding pod ambient-demo/httpbin-5bd875fbdd-dp4ct to ztunnel\n\nistio-cni-node-7q6z7 install-cni 2024-06-16T10:13:59.264500Z info ambient in pod mode - adding pod ambient-demo/httpbin-5bd875fbdd-84vs8 to ztunnel\nistio-cni-node-7q6z7 install-cni 2024-06-16T10:13:59.325907Z info iptables Running iptables-restore with the following input:\nistio-cni-node-7q6z7 install-cni * nat\nistio-cni-node-7q6z7 install-cni -N ISTIO_OUTPUT\nistio-cni-node-7q6z7 install-cni -A OUTPUT -j ISTIO_OUTPUT\nistio-cni-node-7q6z7 install-cni -A ISTIO_OUTPUT -d 169.254.7.127 -p tcp -m tcp -j ACCEPT\nistio-cni-node-7q6z7 install-cni -A ISTIO_OUTPUT -p tcp -m mark --mark 0x111/0xfff -j ACCEPT\nistio-cni-node-7q6z7 install-cni -A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -j ACCEPT\nistio-cni-node-7q6z7 install-cni -A ISTIO_OUTPUT ! -d 127.0.0.1/32 -p tcp -m mark ! --mark 0x539/0xfff -j REDIRECT --to-ports 15001\nistio-cni-node-7q6z7 install-cni COMMIT\nistio-cni-node-7q6z7 install-cni * mangle\nistio-cni-node-7q6z7 install-cni -N ISTIO_PRERT\nistio-cni-node-7q6z7 install-cni -N ISTIO_OUTPUT\nistio-cni-node-7q6z7 install-cni -A PREROUTING -j ISTIO_PRERT\nistio-cni-node-7q6z7 install-cni -A OUTPUT -j ISTIO_OUTPUT\nistio-cni-node-7q6z7 install-cni -A ISTIO_PRERT -m mark --mark 0x539/0xfff -j CONNMARK --set-xmark 0x111/0xfff\nistio-cni-node-7q6z7 install-cni -A ISTIO_PRERT -s 169.254.7.127 -p tcp -m tcp -j ACCEPT\nistio-cni-node-7q6z7 install-cni -A ISTIO_PRERT ! -d 127.0.0.1/32 -p tcp -i lo -j ACCEPT\nistio-cni-node-7q6z7 install-cni -A ISTIO_PRERT -p tcp -m tcp --dport 15008 -m mark ! --mark 0x539/0xfff -j TPROXY --on-port 15008 --tproxy-mark 0x111/0xfff\nistio-cni-node-7q6z7 install-cni -A ISTIO_PRERT -p tcp -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT\nistio-cni-node-7q6z7 install-cni -A ISTIO_PRERT ! -d 127.0.0.1/32 -p tcp -m mark ! --mark 0x539/0xfff -j TPROXY --on-port 15006 --tproxy-mark 0x111/0xfff\nistio-cni-node-7q6z7 install-cni -A ISTIO_OUTPUT -m connmark --mark 0x111/0xfff -j CONNMARK --restore-mark --nfmask 0xffffffff --ctmask 0xffffffff\nistio-cni-node-7q6z7 install-cni COMMIT\nistio-cni-node-7q6z7 install-cni 2024-06-16T10:13:59.335115Z info Running command (with wait lock): iptables-restore --noflush -v --wait=30\nistio-cni-node-7q6z7 install-cni 2024-06-16T10:13:59.550687Z info ambient About to send added pod: 3ab72f78-8e2b-4e49-bc47-45fa4f90dbf7 to ztunnel: add:{uid:\"3ab72f78-8e2b-4e49-bc47-45fa4f90dbf7\" workload_info:{name:\"httpbin-5bd875fbdd-84vs8\" namespace:\"ambient-demo\" service_account:\"default\" trust_domain:\"cluster.local\"}\n```\n\n많은 로그가 생성되었습니다. 우리는 각 httpbin pod를 ambient-demo 네임스페이스에 추가하여 ztunnel을 통해 ambient 경로에 추가하고 있음을 확인할 수 있습니다.\n\n- ztunnel\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```plaintext\n(⎈|kind-ambient:ambient-demo)➜ ~ stern ztunnel -n istio-system\n\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.559505Z 정보 inpod::statemanager pod WorkloadUid(\"3ab72f78-8e2b-4e49-bc47-45fa4f90dbf7\")가 netns를 수신하고 프록시를 시작합니다.\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.557545Z 정보 inpod::statemanager pod WorkloadUid(\"7f8be6a6-64f2-40e9-8926-6c3a618eb7d9\")가 netns를 수신하고 프록시를 시작합니다.\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.560458Z 정보 proxy::inbound 리스너가 구성되었으며 주소=[::]:15008 구성요소=\"inbound\" 투명=true\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.561604Z 정보 proxy::inbound_passthrough 리스너가 구성되었으며 주소=[::]:15006 구성요소=\"inbound plaintext\" 투명=true\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.561647Z 정보 proxy::outbound 리스너가 구성되었으며 주소=[::]:15001 구성요소=\"outbound\" 투명=true\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.573883Z 정보 proxy::inbound 리스너가 구성되었으며 주소=[::]:15008 구성요소=\"inbound\" 투명=true\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.586596Z 정보 proxy::inbound_passthrough 리스너가 구성되었으며 주소=[::]:15006 구성요소=\"inbound plaintext\" 투명=true\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.586819Z 정보 proxy::outbound 리스너가 구성되었으며 주소=[::]:15001 구성요소=\"outbound\" 투명=true\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.811460Z 정보 xds::client:xds{id=14}가 응답을 수신했습니다. type_url=\"type.googleapis.com/istio.workload.Address\" 크기=2  삭제=0\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.816352Z 정보 xds::client:xds{id=14}가 응답을 수신했습니다. type_url=\"type.googleapis.com/istio.workload.Address\" 크기=2  삭제=0\nztunnel-gs52c istio-proxy 2024-06-16T10:13:59.821310Z 정보 xds::client:xds{id=14}가 응답을 수신했습니다. type_url=\"type.googleapis.com/istio.workload.Address\" 크기=2  삭제=0\n```\n\nztunnel이 자체 내부 및 외부 리스너를 설정 중인 것으로 보입니다.\n\n## 트래픽 흐름 - Istio Ingress를 통해\n\n이전과 마찬가지로, istio-ingress pod로 포트 포워딩을 설정하고 localhost를 통해 액세스합니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n두 개의 호출을 각각 2개의 httpbin 팟에 대응하도록 인그레스에서 호출을 추출하려고 합니다. 그리고 동시에 동일한 ztunnel 로그를 캡처하려고 합니다.\n\n```js\n(⎈|kind-ambient:istio-system)➜  ~ kpf istio-ingressgateway-6f48dfb7db-862sm 8081\nForwarding from 127.0.0.1:8081 -> 8081\n\n$ curl localhost:8081/\n$ curl localhost:8081/\n```\n\n```js\n(⎈|kind-ambient:istio-system)➜  ~ stern ztunnel -n istio-system\n\nztunnel-fv5f8 istio-proxy 2024-06-16T12:26:24.154500Z\ninfo access connection complete src.addr=192.168.184.70:52792\nsrc.workload=istio-ingressgateway-6f48dfb7db-862sm src.namespace=istio-system\nsrc.identity=\"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account\"\ndst.addr=192.168.184.74:80 dst.hbone_addr=192.168.184.74:80\ndst.service=httpbin.ambient-demo.svc.cluster.local\ndst.workload=httpbin-6f4dc97cb-swdlb dst.namespace=ambient-demo\ndst.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\"\ndirection=\"inbound\" bytes_sent=51083 bytes_recv=4180 duration=\"2166ms\"\n\nztunnel-62hp8 istio-proxy 2024-06-16T12:28:40.267690Z\ninfo access connection complete src.addr=192.168.184.70:55036\nsrc.workload=istio-ingressgateway-6f48dfb7db-862sm src.namespace=istio-system\nsrc.identity=\"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account\"\ndst.addr=192.168.246.6:80 dst.hbone_addr=192.168.246.6:80\ndst.service=httpbin.ambient-demo.svc.cluster.local\ndst.workload=httpbin-6f4dc97cb-5dpz9 dst.namespace=ambient-demo\ndst.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\"\ndirection=\"inbound\" bytes_sent=41251 bytes_recv=2007 duration=\"2331ms\"\n```\n\n인그레스가 주변 데이터 플레인 경로에 떨어지지 않기 때문에 인그레스 팟에서의 호출은 주변 데이터 플레인 경로로 직접 ztunnel 팟으로 이어집니다. 한 번에 하나의 노드로 이동한 후 해당 내부 노드 팟으로 inbound됩니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n아래는 로그 캡처에서 확인한 내용입니다\n\n```js\ndirection = \"inbound\";\n```\n\n- 이는 주변 레이블이 붙은 네임스페이스 파드로의 트래픽이 항상 ztunnel을 통해 이동함을 확인합니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\ndst.hbone_addr=192.168.184.74:80\ndst.hbone_addr=192.168.246.6:80\n\nhttpbin-6f4dc97cb-5dpz9 1/1 Running 0 56m 192.168.246.6 ambient-worker2 <none> <none>\nhttpbin-6f4dc97cb-swdlb 1/1 Running 0 56m 192.168.184.74 ambient-worker <none> <none>\n\n- 이것은 실제 httpbin pod ip에 해당하는 dest pod ip를 캡처합니다.\n\n## 트래픽 흐름 — Mesh 내부를 통해\n\n클라이언트 디버그 pod에 exec하여 httpbin 서비스로의 Mesh 내부 호출을 시도하고 동시에 ztunnel 로그를 캡쳐하여 동일한 동작을 확인해보겠습니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```js\n(⎈|kind-ambient:ambient-demo)➜  ~ kgpo -owide\nNAME                      READY   STATUS    RESTARTS   AGE    IP               NODE                    NOMINATED NODE   READINESS GATES\ndoks-debug-j9mm5          1/1     Running   0          122m   192.168.246.5    ambient-worker2         <none>           <none>\ndoks-debug-rdhgq          1/1     Running   0          122m   192.168.184.73   ambient-worker          <none>           <none>\ndoks-debug-v7cld          1/1     Running   0          122m   192.168.208.3    ambient-control-plane   <none>           <none>\nhttpbin-6f4dc97cb-5dpz9   1/1     Running   0          56m    192.168.246.6    ambient-worker2         <none>           <none>\nhttpbin-6f4dc97cb-swdlb   1/1     Running   0          56m    192.168.184.74   ambient-worker          <none>           <none>\n```\n\n그냥 같은 노드에 있는 클라이언트와 앱 팟들을 연결하기 위해 —\n\n```js\n(⎈|kind-ambient:ambient-demo)➜  ~ kgpo -A -owide | grep \"ambient-worker \"\nambient-demo         doks-debug-rdhgq                                1/1     Running   0               133m    192.168.184.73   ambient-worker          <none>           <none>\nistio-system         ztunnel-fv5f8                                   1/1     Running   0               3h24m   192.168.184.71   ambient-worker          <none>           <none>\nambient-demo         httpbin-6f4dc97cb-swdlb                         1/1     Running   0               68m     192.168.184.74   ambient-worker          <none>           <none>\n\n\n(⎈|kind-ambient:ambient-demo)➜  ~ kgpo -A -owide | grep \"ambient-worker2\"\nkube-system          doks-debug-9nlh7                                1/1     Running   0               3h6m    192.168.246.4    ambient-worker2         <none>           <none>\nistio-system         ztunnel-62hp8                                   1/1     Running   0               3h23m   192.168.246.3    ambient-worker2         <none>           <none>\nambient-demo         httpbin-6f4dc97cb-5dpz9                         1/1     Running   0               67m     192.168.246.6    ambient-worker2         <none>           <none>\n```\n\ndebug pod인 doks-debug-rdhgq를 실행하기 위해 ambient-worker 노드에 스케줄된 상태로 들어가보겠습니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n<img src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_10.png\" />\n\n```js\n테이블 1: 동일 노드 내의 클라이언트 및 서버\n---------\nztunnel-fv5f8 istio-proxy 2024-06-16T12:40:48.707707Z info access connection complete src.addr=192.168.184.73:56463 src.workload=doks-debug-rdhgq src.namespace=ambient-demo src.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/default\" dst.addr=192.168.184.74:80 dst.hbone_addr=192.168.184.74:80 dst.service=httpbin.ambient-demo.svc.cluster.local dst.workload=httpbin-6f4dc97cb-swdlb dst.namespace=ambient-demo dst.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\" direction  =\"inbound\" bytes_sent=9832 bytes_recv=84 duration=\"178ms\"\nztunnel-fv5f8 istio-proxy 2024-06-16T12:40:48.708070Z info access connection complete src.addr=192.168.184.73:34190 src.workload=doks-debug-rdhgq src.namespace=ambient-demo src.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/default\" dst.addr=192.168.184.74:15008 dst.hbone_addr=192.168.184.74:80 dst.service=httpbin.ambient-demo.svc.cluster.local dst.workload=httpbin-6f4dc97cb-swdlb dst.namespace=ambient-demo dst.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\" direction=\"outbound\" bytes_sent=84 bytes_recv=9832 duration=\"203ms\"\n```\n\n동일 노드 내의 클라이언트와 서버의 경우, 파드에서 ztunnel로 외부 패킷이 들어오면 동일한 ztunnel을 통해 대상 파드로 들어오는 내부 패킷으로 리디렉션됩니다.\n\n따라서, 동일 노드 내의 클라이언트 및 서버에서는 한 ztunnel이 외부 패킷과 내부 패킷을 받습니다. \"bound\"는 동일 노드 내의 응용 프로그램 파드로부터/받는 방향을 지정합니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```js\n캡처 2: 클라이언트 및 서버가 다른 노드에 있는 경우\n---------\nztunnel-62hp8 istio-proxy 2024-06-16T12:48:51.792527Z info access connection complete src.addr=192.168.184.73:53265 src.workload=doks-debug-rdhgq src.namespace=ambient-demo src.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/default\" dst.addr=192.168.246.6:80 dst.hbone_addr=192.168.246.6:80 dst.service=httpbin.ambient-demo.svc.cluster.local dst.workload=httpbin-6f4dc97cb-5dpz9 dst.namespace=ambient-demo dst.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\" direction=\"inbound\" bytes_sent=9832 bytes_recv=84 duration=\"60ms\"\nztunnel-fv5f8 istio-proxy 2024-06-16T12:48:51.793112Z info access connection complete src.addr=192.168.184.73:60162 src.workload=doks-debug-rdhgq src.namespace=ambient-demo src.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/default\" dst.addr=192.168.246.6:15008 dst.hbone_addr=192.168.246.6:80 dst.service=httpbin.ambient-demo.svc.cluster.local dst.workload=httpbin-6f4dc97cb-5dpz9 dst.namespace=ambient-demo dst.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\" direction=\"outbound\" bytes_sent=84 bytes_recv=9832 duration=\"61ms\"\n```\n\n만약 클라이언트와 서버가 다른 노드에 있는 경우, 출발 트래픽은 동일한 노드인 ztunnel에서 외부 트래픽 패킷을 만나고, 그런 다음 목적지 파드의 노드의 ztunnel로 전송되어 들어오는 패킷으로 처리됩니다.\n\n# 결론\n\n이 실험을 통해 Istio Ambient Mesh에서 ztunnel을 통한 패킷 흐름을 시각화할 수 있었습니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n![이미지](/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_11.png)\n\n다음 파트에서는 ztunnel을 통해 적용할 수 있는 L4 인증 정책을 탐색할 것입니다.\n\n또한 Ambient에 있는 L7 프록시인 Waypoint Proxy에 대해 탐구할 것입니다.\n\n다른 기술 블로그는 여기에서 확인할 수 있습니다: [링크](https://janasabuj.github.io/posts/)\n","ogImage":{"url":"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_0.png"},"coverImage":"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_0.png","tag":["Tech"],"readingTime":35},"content":"<!doctype html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\">\n<meta content=\"width=device-width, initial-scale=1\" name=\"viewport\">\n</head>\n<body>\n<p>피츠오는 앰비언트 모드로 전환하고 있어요 — 사이드카 없는 모델로 말이죠. 마침내 우리는 CPU와 메모리 소비가 많은 사이드카를 버릴 수 있게 되었어요!</p>\n<p>다가오는 장마시즌을 맞아, 저는 피츠오 앰비언트 메시에 간접적으로 참여해보기로 했어요.</p>\n<p>이 블로그를 사용하여 여행을 문서화하고, 비슷한 생각을 가진 피츠오 사용자들이 함께 따라올 수 있게 도와볼 거예요 :P.</p>\n<p><img src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_0.png\" alt=\"이미지\"></p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>제가 나름대로 번역해보겠습니다:</p>\n<p>안녕하세요! Part 1에서는 주변 메시 실험을 위해 로컬 클러스터 설정을 완벽하게 진행할 예정입니다. 그런 다음 메시의 ztunnel 구성 요소를 탐험할 것입니다.</p>\n<p>Part 2에서는 L4 인증 정책에 대해 이야기하고 waypoint 프록시를 시작하는 방법을 살펴볼 것입니다.</p>\n<h1>Ambient란 무엇인가요?</h1>\n<p>Istio Ambient Mesh는 사이드카 없이 Istio의 새로운 데이터플레인 모드입니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>일반적인 Istio 모드에서는 모든 응용 프로그램 Pod이 envoy 프록시로 주입되었다는 것을 기억하십시오. 그러나 이 새로운 모드에서는 응용 프로그램 Pod이 건드리지 않을 거에요 :) 그리고 그들은 자신의 응용 프로그램 컨테이너만 가지게 될 거에요.</p>\n<p><img src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_1.png\" alt=\"이미지\"></p>\n<p>가장 먼저 떠오르는 큰 장점 중 하나는 인프라 비용이 크게 절감된다는 것입니다. 컴퓨팅 코어 및 메모리 관점에서 얼마나 많은 돈을 절약하고 있는지 상상해보세요 !!</p>\n<p><img src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_2.png\" alt=\"이미지\"></p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<h1>Ambient Architecture</h1>\n<p>과거와 현재의 Ambient Architecture를 상상해 보는 시간입니다. 데이터 평면의 트래픽 흐름 경로에서 그들이 어떻게 다른지 살펴봅시다.</p>\n<h2>Sidecar 모드</h2>\n<p><img src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_3.png\" alt=\"이미지\"></p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>이것은 전통적인 사이드카 모델이며 각 서비스 팟에는 애플리케이션 컨테이너와 Envoy 사이드카가 결합되어 있습니다. 애플리케이션으로부터 오고 가는 모든 트래픽은 사이드카에 의해 가로채집니다.</p>\n<h2>Ambient 모드, ztunnel 사용</h2>\n<p><img src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_4.png\" alt=\"이미지\"></p>\n<p>이 새로운 ambient 모드에서 애플리케이션 팟은 사이드카가 없는 독립적인 팟입니다. 그러나 이 경우에는 클러스터의 각 Kubernetes 노드마다 데몬셋 팟이 실행될 것입니다 - 강력한 ztunnel (제로 트러스트 터널). 노드 내 팟간의 모든 트래픽은 ztunnel에 의해 가로채집됩니다. Ztunnel은 각 노드당 L4 프록시입니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<h2>Ambient mode, with ztunnel + waypoint</h2>\n<p><img src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_5.png\" alt=\"Image\"></p>\n<p>Ztunnel은 L4 프록시가 필요한 워크로드 간 네트워킹에 충분합니다. http 헤더 기반 라우팅, L7 권한 부여와 같은 L7 요구 사항을 충족시키기 위해 waypoint 프록시라는 워크로드를 배포합니다. 이는 애플리케이션당 envoy 팟으로, 동일한 노드 또는 다른 노드에서 실행될 수 있습니다.</p>\n<p>이 경우 ztunnel에서 생성된 트래픽은 waypoint 프록시에 도달하고, waypoint는 그것을 목적지 ztunnel로 전달합니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>그러므로, 어플리케이션이 L7 처리를 요구하지 않는 경우 waypoint를 없애고 ztunnel만 사용할 수 있습니다. 이전 방식에서는, 우리가 L4 요구사항만 가지고 있더라도 envoy sidecars를 반드시 사용해야 했습니다.</p>\n<h1>클러스터 설정 깊이에 대한 정보</h1>\n<p>이상적으로 지원되는 환경에서 사용할 수 있는 유효한 CNI 설정으로 Kind 클러스터를 설정하는 데 많은 조정이 필요했습니다. 현재는 어떤 공개 GKE/AKS/EKS k8s 클러스터에 대한 실험을 할 수 있는 권한이 없습니다.</p>\n<p><img src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_6.png\" alt=\"이미지\"></p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>그러므로 로컬 Kind 클러스터를 홈 설정하겠습니다.</p>\n<h2>시스템 사양</h2>\n<ul>\n<li>Mac M1 (Apple-Silicon 아키텍처)를 사용하며 기본 구성으로 진행됩니다.</li>\n</ul>\n<p>시스템 아키텍처(Linux/Windows/Apple Intel)를 고려하여 비슷하게 진행할 수 있습니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<ul>\n<li>Rancher Desktop</li>\n</ul>\n<p>저희 k8s 클러스터를 위해 도커 런타임이 필요한데, 저는 SUSE의 Rancher Desktop을 사용할 예정입니다 — <a href=\"https://rancherdesktop.io/\" rel=\"nofollow\" target=\"_blank\">https://rancherdesktop.io/</a>.</p>\n<p>다른 대안으로는 Docker Desktop이 있습니다 — <a href=\"https://www.docker.com/products/docker-desktop/\" rel=\"nofollow\" target=\"_blank\">https://www.docker.com/products/docker-desktop/</a></p>\n<ul>\n<li>Kind</li>\n</ul>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>저는 Multi-Node K8s 클러스터가 필요하다고 생각해요. 그래서 우리가 사용할 최상의 도구는 Kind를 이용해 클러스터를 부트스트랩하는 거죠. 여기 <a href=\"https://kind.sigs.k8s.io/docs/user/quick-start\" rel=\"nofollow\" target=\"_blank\">https://kind.sigs.k8s.io/docs/user/quick-start</a> 에서 보다 자세한 정보를 얻을 수 있어요.</p>\n<p>이를 통해 우리는 k8s 노드에 ssh로 접속하고 노드 구성을 실험해볼 수도 있을 거에요.</p>\n<p>그리고 블로그에 나온대로 istio-ambient 프로필을 설치한 후에는 Kind 노드에서 문제가 발생할 수 있어요. 여기 <a href=\"https://kind.sigs.k8s.io/docs/user/known-issues/#pod-errors-due-to-too-many-open-files\" rel=\"nofollow\" target=\"_blank\">https://kind.sigs.k8s.io/docs/user/known-issues/#pod-errors-due-to-too-many-open-files</a> 에서 문제를 해결할 수 있어요. 영향을 받는 노드의 sysctl.conf를 수정한 후에는 istio-system pods가 문제없이 생성될 거에요.</p>\n<img src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_7.png\">\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<ul>\n<li>CNI(Container Networking Interface)</li>\n</ul>\n<p>\"Istio Ambient Mode\"은 Calico, Cilium 등과 같은 CNI와 함께 지원됩니다. Kind 클러스터의 기본 CNI는 \"kindnetd\"이며, 저는 직접 테스트해 본 결과 ztunnel 팟이 실행되지 않았습니다. 그래서 다른 CNI가 필요했습니다.</p>\n<ul>\n<li>Cilium CNI도 Mac M1에서 제대로 로드되지 않았습니다. 즉, cilium 데몬셋 팟이 실행되지 않았습니다.</li>\n<li>마침내 Calico CNI로 Kind를 설정하는 방법을 찾았습니다. Kind에서 기본 CNI를 비활성화하고 다음과 같이 진행합니다: <a href=\"https://docs.tigera.io/calico/latest/getting-started/kubernetes/kind\" rel=\"nofollow\" target=\"_blank\">https://docs.tigera.io/calico/latest/getting-started/kubernetes/kind</a></li>\n<li>이 설정에서 마지막 단계를 따를 수도 있습니다: <a href=\"https://alexbrand.dev/post/creating-a-kind-cluster-with-calico-networking/\" rel=\"nofollow\" target=\"_blank\">https://alexbrand.dev/post/creating-a-kind-cluster-with-calico-networking/</a></li>\n</ul>\n<h1>Istio 설치</h1>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<h2>클러스터 개요</h2>\n<p>이스티오를 시작하기 전에 클러스터 스펙을 살펴봅시다.</p>\n<p>다음은 Kind 클러스터 설정 스크립트입니다.</p>\n<p>마스터 노드 1개와 워커 노드 2개가 있습니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<pre><code class=\"hljs language-js\">(⎈|kind-<span class=\"hljs-attr\">ambient</span>:istio-system)➜  ~ kg 노드\n이름                    상태     역할           생성 시간    버전\nambient-control-plane   준비     제어 플레인    <span class=\"hljs-number\">117</span>분     v1<span class=\"hljs-number\">.30</span><span class=\"hljs-number\">.0</span>\nambient-worker          준비     &#x3C;없음>         <span class=\"hljs-number\">116</span>분     v1<span class=\"hljs-number\">.30</span><span class=\"hljs-number\">.0</span>\nambient-worker2         준비     &#x3C;없음>         <span class=\"hljs-number\">116</span>분     v1<span class=\"hljs-number\">.30</span><span class=\"hljs-number\">.0</span>\n</code></pre>\n<p>또한 Calico CNI 데몬세트가 실행 중인지 확인합니다. 클러스터 CoreDNS도 준비되어 있는지 확인합니다.</p>\n<pre><code class=\"hljs language-js\">(⎈|kind-<span class=\"hljs-attr\">ambient</span>:kube-system)➜  ~ kgpo\n이름                                            준비     상태      재시작      생성 시간\ncalico-kube-controllers-564985c589-xmsrp        <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     실행 중  <span class=\"hljs-number\">1</span> (<span class=\"hljs-number\">96</span>분 전)  <span class=\"hljs-number\">117</span>분\ncalico-node-796kq                               <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     실행 중  <span class=\"hljs-number\">0</span>             <span class=\"hljs-number\">116</span>분\ncalico-node-l6fsg                               <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     실행 중  <span class=\"hljs-number\">0</span>             <span class=\"hljs-number\">116</span>분\ncalico-node-zkckp                               <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     실행 중  <span class=\"hljs-number\">0</span>             <span class=\"hljs-number\">116</span>분\ncoredns-7db6d8ff4d-h88q6                        <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     실행 중  <span class=\"hljs-number\">0</span>             <span class=\"hljs-number\">118</span>분\ncoredns-7db6d8ff4d-rtncd                        <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     실행 중  <span class=\"hljs-number\">0</span>             <span class=\"hljs-number\">118</span>분\n</code></pre>\n<h2>Istio Ambient 프로필 설치</h2>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>설치는 간단하게 진행됩니다. 여기에서 찾을 수 있어요: <a href=\"https://istio.io/v1.20/docs/ops/ambient/getting-started/\" rel=\"nofollow\" target=\"_blank\">https://istio.io/v1.20/docs/ops/ambient/getting-started/</a></p>\n<pre><code class=\"hljs language-js\">sabuj $ istioctl install --set profile=ambient --set <span class=\"hljs-string\">\"components.ingressGateways[0].enabled=true\"</span> --set <span class=\"hljs-string\">\"components.ingressGateways[0].name=istio-ingressgateway\"</span> --skip-confirmation\n✔ <span class=\"hljs-title class_\">Istio</span> core가 설치되었습니다\n✔ <span class=\"hljs-title class_\">Ztunnel</span>이 설치되었습니다\n✔ <span class=\"hljs-title class_\">Istiod</span>가 설치되었습니다\n✔ <span class=\"hljs-variable constant_\">CNI</span>가 설치되었습니다\n✔ 인그레스 게이트웨이가 설치되었습니다\n✔ 설치가 완료되었습니다\n이 설치를 주입과 유효성 검사를 위한 기본 설정으로 지정합니다.\n</code></pre>\n<ul>\n<li>내가 사용 중인 Istio 버전은 다음과 같아요.</li>\n</ul>\n<pre><code class=\"hljs language-js\">(⎈|kind-<span class=\"hljs-attr\">ambient</span>:kube-system)➜  ~ istioctl version\nclient <span class=\"hljs-attr\">version</span>: <span class=\"hljs-number\">1.15</span><span class=\"hljs-number\">.0</span>\ncontrol plane <span class=\"hljs-attr\">version</span>: <span class=\"hljs-number\">1.22</span><span class=\"hljs-number\">.1</span>\ndata plane <span class=\"hljs-attr\">version</span>: <span class=\"hljs-number\">1.22</span><span class=\"hljs-number\">.1</span> (<span class=\"hljs-number\">4</span> 프록시)\n</code></pre>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<ul>\n<li>Ztunnel은 각 노드에서 실행되는 데몬세트입니다 — 이 경우 3개의 노드가 있습니다. istio-system 네임스페이스에서 ztunnel이 제대로 실행 중인지 확인해 봅시다.</li>\n</ul>\n<pre><code class=\"hljs language-js\">(⎈|kind-<span class=\"hljs-attr\">ambient</span>:istio-system)➜  ~ kgpo -owide\n<span class=\"hljs-variable constant_\">NAME</span>                                    <span class=\"hljs-variable constant_\">READY</span>   <span class=\"hljs-variable constant_\">STATUS</span>    <span class=\"hljs-variable constant_\">RESTARTS</span>   <span class=\"hljs-variable constant_\">AGE</span>    <span class=\"hljs-variable constant_\">IP</span>               <span class=\"hljs-variable constant_\">NODE</span>                    <span class=\"hljs-variable constant_\">NOMINATED</span> <span class=\"hljs-variable constant_\">NODE</span>   <span class=\"hljs-variable constant_\">READINESS</span> <span class=\"hljs-variable constant_\">GATES</span>\nistio-cni-node-7q6z7                    <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>          117m   <span class=\"hljs-number\">172.18</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.2</span>       ambient-worker2         &#x3C;none>           &#x3C;none>\nistio-cni-node-fg6n4                    <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>          117m   <span class=\"hljs-number\">172.18</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.4</span>       ambient-worker          &#x3C;none>           &#x3C;none>\nistio-cni-node-gwvl8                    <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>          117m   <span class=\"hljs-number\">172.18</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.3</span>       ambient-control-plane   &#x3C;none>           &#x3C;none>\nistio-ingressgateway-6f48dfb7db-862sm   <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>          117m   <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.70</span>   ambient-worker          &#x3C;none>           &#x3C;none>\nistiod-6875bc5c58-n4j7d                 <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>          118m   <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.246</span><span class=\"hljs-number\">.2</span>    ambient-worker2         &#x3C;none>           &#x3C;none>\nztunnel-62hp8                           <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>          117m   <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.246</span><span class=\"hljs-number\">.3</span>    ambient-worker2         &#x3C;none>           &#x3C;none>\nztunnel-fv5f8                           <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>          117m   <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.71</span>   ambient-worker          &#x3C;none>           &#x3C;none>\nztunnel-gs52c                           <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>          117m   <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.208</span><span class=\"hljs-number\">.1</span>    ambient-control-plane   &#x3C;none>           &#x3C;none>\n\n(⎈|kind-<span class=\"hljs-attr\">ambient</span>:istio-system)➜  ~ kg ds\n<span class=\"hljs-variable constant_\">NAME</span>             <span class=\"hljs-variable constant_\">DESIRED</span>   <span class=\"hljs-variable constant_\">CURRENT</span>   <span class=\"hljs-variable constant_\">READY</span>   <span class=\"hljs-variable constant_\">UP</span>-<span class=\"hljs-variable constant_\">TO</span>-<span class=\"hljs-variable constant_\">DATE</span>   <span class=\"hljs-variable constant_\">AVAILABLE</span>   <span class=\"hljs-variable constant_\">NODE</span> <span class=\"hljs-variable constant_\">SELECTOR</span>            <span class=\"hljs-variable constant_\">AGE</span>\nistio-cni-node   <span class=\"hljs-number\">3</span>         <span class=\"hljs-number\">3</span>         <span class=\"hljs-number\">3</span>       <span class=\"hljs-number\">3</span>            <span class=\"hljs-number\">3</span>           kubernetes.<span class=\"hljs-property\">io</span>/os=linux   119m\nztunnel          <span class=\"hljs-number\">3</span>         <span class=\"hljs-number\">3</span>         <span class=\"hljs-number\">3</span>       <span class=\"hljs-number\">3</span>            <span class=\"hljs-number\">3</span>           kubernetes.<span class=\"hljs-property\">io</span>/os=linux   118m\n</code></pre>\n<p>정말로 3개의 파드가 있네요 !</p>\n<ul>\n<li>비슷하게 Istio-cni는 또 다른 설치된 데몬세트입니다.</li>\n<li>Istio 제어 평면인 istiod도 실행 중입니다.</li>\n<li>우리는 공개 트래픽을 위해 기본 istio ingressgateway도 설치했습니다.</li>\n</ul>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<h1>작업량 설정</h1>\n<p>이 프로젝트의 모든 매니페스트 파일은 여기에서 찾을 수 있습니다: <a href=\"https://github.com/JanaSabuj/istio-ambient-mesh-exploration\" rel=\"nofollow\" target=\"_blank\">https://github.com/JanaSabuj/istio-ambient-mesh-exploration</a></p>\n<h2>안건</h2>\n<ul>\n<li>우리는 앰비언트 프로필 없이 앱을 설정하고, 일반 Istio crds를 사용할 것입니다. 그 후에 앱을 호출할 예정입니다. i) 인그레스 ii) 디버그 클라이언트 pod</li>\n<li>그 후에, Istio 데이터 평면 모드를 앰비언트로 전환하고, ztunnel pod를 통해 흐르는 트래픽 경로의 변화를 관찰할 것입니다.</li>\n</ul>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<h2>네임스페이스</h2>\n<p>ambient-demo라는 네임스페이스를 만들어 보겠습니다. 이 네임스페이스에서 앱을 호스팅할 예정입니다.</p>\n<pre><code class=\"hljs language-js\">(⎈|kind-<span class=\"hljs-attr\">ambient</span>:istio-system)➜  ~ k create ns ambient-demo\n\n(⎈|kind-<span class=\"hljs-attr\">ambient</span>:istio-system)➜  ~ kg ns\n<span class=\"hljs-variable constant_\">NAME</span>                 <span class=\"hljs-variable constant_\">STATUS</span>   <span class=\"hljs-variable constant_\">AGE</span>\n<span class=\"hljs-keyword\">default</span>              <span class=\"hljs-title class_\">Active</span>   132m\nistio-system         <span class=\"hljs-title class_\">Active</span>   125m\nkube-node-lease      <span class=\"hljs-title class_\">Active</span>   132m\nkube-public          <span class=\"hljs-title class_\">Active</span>   132m\nkube-system          <span class=\"hljs-title class_\">Active</span>   132m\nlocal-path-storage   <span class=\"hljs-title class_\">Active</span>   132m\n</code></pre>\n<h2>애플리케이션</h2>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>그럼 배포, 서비스 및 서비스 어카운트 yaml을 사용하여 애플리케이션을 배포합니다.</p>\n<p>클러스터에서는 다음과 같이 보입니다.</p>\n<pre><code class=\"hljs language-bash\">(⎈|kind-ambient:ambient-demo)➜  ~ kg all\nNAME                          READY   STATUS    RESTARTS   AGE\npod/httpbin-6f4dc97cb-5dpz9   1/1     Running   0          3m21s\npod/httpbin-6f4dc97cb-swdlb   1/1     Running   0          3m31s\n\nNAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE\nservice/httpbin   ClusterIP   10.96.157.221   &#x3C;none>        80/TCP    143m\n\nNAME                      READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/httpbin   2/2     2            2           143m\n\nNAME                                 DESIRED   CURRENT   READY   AGE\nreplicaset.apps/httpbin-6f4dc97cb    2         2         2       3m31s\n</code></pre>\n<h2>Istio 구성</h2>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>외부 세계에 노출하기 위해 Istio Gateway 및 Istio VirtualService를 생성하여 Istio Ingress를 통해 액세스할 수 있게 만듭니다.</p>\n<ul>\n<li>우리는 Istio Ingress 파드에 8081 포트를 통해 게이트웨이를 추가하고 있습니다.</li>\n<li>그 다음으로, VirtualService를 통해 ambient-demo 네임스페이스에서 실행되는 httpbin 서비스로 라우팅합니다.</li>\n</ul>\n<h2>Istio Ingress를 통한 확인</h2>\n<p>이제 우리의 응용 프로그램에 액세스할 수 있는지 확인할 수 있습니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<pre><code class=\"hljs language-js\">(⎈|kind-<span class=\"hljs-attr\">ambient</span>:istio-system)➜  ~ kgs\n<span class=\"hljs-variable constant_\">NAME</span>                   <span class=\"hljs-variable constant_\">TYPE</span>           <span class=\"hljs-variable constant_\">CLUSTER</span>-<span class=\"hljs-variable constant_\">IP</span>     <span class=\"hljs-variable constant_\">EXTERNAL</span>-<span class=\"hljs-variable constant_\">IP</span>   <span class=\"hljs-title function_\">PORT</span>(S)                                      <span class=\"hljs-variable constant_\">AGE</span>\nistio-ingressgateway   <span class=\"hljs-title class_\">LoadBalancer</span>   <span class=\"hljs-number\">10.96</span><span class=\"hljs-number\">.77</span><span class=\"hljs-number\">.172</span>   &#x3C;pending>     <span class=\"hljs-number\">15021</span>:<span class=\"hljs-number\">30807</span>/<span class=\"hljs-variable constant_\">TCP</span>,<span class=\"hljs-number\">80</span>:<span class=\"hljs-number\">30587</span>/<span class=\"hljs-variable constant_\">TCP</span>,<span class=\"hljs-number\">443</span>:<span class=\"hljs-number\">31004</span>/<span class=\"hljs-variable constant_\">TCP</span>   147m\n</code></pre>\n<p>Kind가 인그레스 서비스를 위한 외부 IP를 제공하지 않았기 때문에, 원하는 리스너 8081에서 인그레스 파드를 포트포워딩하여 외부 액세스를 시뮬레이션할 것입니다.</p>\n<pre><code class=\"hljs language-js\">(⎈|kind-<span class=\"hljs-attr\">ambient</span>:istio-system)➜  ~ kpf istio-ingressgateway-6f48dfb7db-862sm <span class=\"hljs-number\">8081</span>\n<span class=\"hljs-title class_\">Forwarding</span> <span class=\"hljs-keyword\">from</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>:<span class=\"hljs-number\">8081</span> -> <span class=\"hljs-number\">8081</span>\n<span class=\"hljs-title class_\">Forwarding</span> <span class=\"hljs-keyword\">from</span> [::<span class=\"hljs-number\">1</span>]:<span class=\"hljs-number\">8081</span> -> <span class=\"hljs-number\">8081</span>\n</code></pre>\n<p>브라우저에서 127.0.0.1:8081을 입력하여 애플리케이션을 확인할 수 있습니다!</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-attr\">http</span>:<span class=\"hljs-comment\">//127.0.0.1:8081/</span>\n\nhttpbin.<span class=\"hljs-property\">org</span>\n <span class=\"hljs-number\">0.9</span><span class=\"hljs-number\">.2</span>\n[ <span class=\"hljs-title class_\">Base</span> <span class=\"hljs-attr\">URL</span>: <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>:<span class=\"hljs-number\">8081</span>/ ]\n간단한 <span class=\"hljs-variable constant_\">HTTP</span> 요청 및 응답 서비스입니다.\n\n로컬에서 실행: $ docker run -p <span class=\"hljs-number\">80</span>:<span class=\"hljs-number\">80</span> kennethreitz/httpbin\n\n개발자 - 웹사이트\n개발자에게 이메일 보내기\n</code></pre>\n<ul>\n<li>또 다른 확인 방법은 로컬에서 curl을 통해 하는 것입니다. 우리는 요청이 istio-envoy 파드에 의해 처리된 것을 확인합니다.</li>\n</ul>\n<pre><code class=\"hljs language-js\">(⎈|kind-<span class=\"hljs-attr\">ambient</span>:istio-system)➜  ~ curl <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>:<span class=\"hljs-number\">8081</span> -v\n*   <span class=\"hljs-title class_\">Trying</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>:<span class=\"hljs-number\">8081.</span>..\n* <span class=\"hljs-title class_\">Connected</span> to <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span> (<span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>) port <span class=\"hljs-number\">8081</span>\n> <span class=\"hljs-variable constant_\">GET</span> / <span class=\"hljs-variable constant_\">HTTP</span>/<span class=\"hljs-number\">1.1</span>\n> <span class=\"hljs-title class_\">Host</span>: <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>:<span class=\"hljs-number\">8081</span>\n> <span class=\"hljs-title class_\">User</span>-<span class=\"hljs-title class_\">Agent</span>: curl/<span class=\"hljs-number\">8.6</span><span class=\"hljs-number\">.0</span>\n> <span class=\"hljs-title class_\">Accept</span>: *<span class=\"hljs-comment\">/*\n>\n&#x3C; HTTP/1.1 200 OK\n&#x3C; server: istio-envoy\n&#x3C; date: Sun, 16 Jun 2024 11:52:13 GMT\n&#x3C; content-type: text/html; charset=utf-8\n&#x3C; content-length: 9593\n&#x3C; access-control-allow-origin: *\n&#x3C; access-control-allow-credentials: true\n&#x3C; x-envoy-upstream-service-time: 271\n&#x3C;\n&#x3C;!DOCTYPE html>\n&#x3C;html lang=\"en\">\n...\n</span></code></pre>\n<h2>디버그 클라이언트 파드를 통한 확인</h2>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>우리는 메쉬 내부 호출을 테스트해보려고 합니다. 따라서 각 노드마다 클라이언트 팟이 하나씩 있는 것이 좋습니다. 이를 위해 디버거 데몬세트 클라이언트 워크로드를 설정할 수 있습니다 — <a href=\"https://github.com/digitalocean/doks-debug\" rel=\"nofollow\" target=\"_blank\">https://github.com/digitalocean/doks-debug</a></p>\n<p>사용한 수정된 Manifest: <a href=\"https://gist.github.com/JanaSabuj/a4dd2504752b8c2b30d2d2d05320f7ef\" rel=\"nofollow\" target=\"_blank\">https://gist.github.com/JanaSabuj/a4dd2504752b8c2b30d2d2d05320f7ef</a></p>\n<p>저는 이 데몬세트를 우리 ambient-demo 네임스페이스에 배포했습니다.</p>\n<pre><code class=\"hljs language-js\">(⎈|kind-<span class=\"hljs-attr\">ambient</span>:ambient-demo)➜  ~ kg ds\n<span class=\"hljs-variable constant_\">NAME</span>         <span class=\"hljs-variable constant_\">DESIRED</span>   <span class=\"hljs-variable constant_\">CURRENT</span>   <span class=\"hljs-variable constant_\">READY</span>   <span class=\"hljs-variable constant_\">UP</span>-<span class=\"hljs-variable constant_\">TO</span>-<span class=\"hljs-variable constant_\">DATE</span>   <span class=\"hljs-variable constant_\">AVAILABLE</span>   <span class=\"hljs-variable constant_\">NODE</span> <span class=\"hljs-variable constant_\">SELECTOR</span>   <span class=\"hljs-variable constant_\">AGE</span>\ndoks-debug   <span class=\"hljs-number\">3</span>         <span class=\"hljs-number\">3</span>         <span class=\"hljs-number\">3</span>       <span class=\"hljs-number\">3</span>            <span class=\"hljs-number\">3</span>           &#x3C;none>          89m\n\n(⎈|kind-<span class=\"hljs-attr\">ambient</span>:ambient-demo)➜  ~ kgpo -owide\n<span class=\"hljs-variable constant_\">NAME</span>                      <span class=\"hljs-variable constant_\">READY</span>   <span class=\"hljs-variable constant_\">STATUS</span>    <span class=\"hljs-variable constant_\">RESTARTS</span>   <span class=\"hljs-variable constant_\">AGE</span>   <span class=\"hljs-variable constant_\">IP</span>               <span class=\"hljs-variable constant_\">NODE</span>                    <span class=\"hljs-variable constant_\">NOMINATED</span> <span class=\"hljs-variable constant_\">NODE</span>   <span class=\"hljs-variable constant_\">READINESS</span> <span class=\"hljs-variable constant_\">GATES</span>\ndoks-debug-j9mm5          <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>          90m   <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.246</span><span class=\"hljs-number\">.5</span>    ambient-worker2         &#x3C;none>           &#x3C;none>\ndoks-debug-rdhgq          <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>          90m   <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.73</span>   ambient-worker          &#x3C;none>           &#x3C;none>\ndoks-debug-v7cld          <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>          90m   <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.208</span><span class=\"hljs-number\">.3</span>    ambient-control-plane   &#x3C;none>\n</code></pre>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>테스트해 보기 위해 디버그 팟으로 진입하여 k8s fqdn httpbin.ambient-demo.svc.cluster.local을 curl을 시도해 보았습니다.</p>\n<p>200 OK를 반환하고 있습니다.</p>\n<pre><code class=\"hljs language-js\">(⎈|kind-<span class=\"hljs-attr\">ambient</span>:ambient-demo)➜  ~ k exec -it doks-debug-j9mm5 -- <span class=\"hljs-regexp\">/bin/</span>bash\n\nroot@doks-debug-<span class=\"hljs-attr\">j9mm5</span>:~# curl httpbin.<span class=\"hljs-property\">ambient</span>-demo.<span class=\"hljs-property\">svc</span>.<span class=\"hljs-property\">cluster</span>.<span class=\"hljs-property\">local</span> -v\n*   <span class=\"hljs-title class_\">Trying</span> <span class=\"hljs-number\">10.96</span><span class=\"hljs-number\">.157</span><span class=\"hljs-number\">.221</span>:<span class=\"hljs-number\">80.</span>..\n* <span class=\"hljs-title class_\">Connected</span> to httpbin.<span class=\"hljs-property\">ambient</span>-demo.<span class=\"hljs-property\">svc</span>.<span class=\"hljs-property\">cluster</span>.<span class=\"hljs-property\">local</span> (<span class=\"hljs-number\">10.96</span><span class=\"hljs-number\">.157</span><span class=\"hljs-number\">.221</span>) port <span class=\"hljs-number\">80</span> (#<span class=\"hljs-number\">0</span>)\n> <span class=\"hljs-variable constant_\">GET</span> / <span class=\"hljs-variable constant_\">HTTP</span>/<span class=\"hljs-number\">1.1</span>\n> <span class=\"hljs-title class_\">Host</span>: httpbin.<span class=\"hljs-property\">ambient</span>-demo.<span class=\"hljs-property\">svc</span>.<span class=\"hljs-property\">cluster</span>.<span class=\"hljs-property\">local</span>\n> <span class=\"hljs-title class_\">User</span>-<span class=\"hljs-title class_\">Agent</span>: curl/<span class=\"hljs-number\">7.88</span><span class=\"hljs-number\">.1</span>\n> <span class=\"hljs-title class_\">Accept</span>: *<span class=\"hljs-comment\">/*\n>\n&#x3C; HTTP/1.1 200 OK\n&#x3C; Server: gunicorn/19.9.0\n&#x3C; Date: Sun, 16 Jun 2024 12:06:11 GMT\n&#x3C; Connection: keep-alive\n&#x3C; Content-Type: text/html; charset=utf-8\n&#x3C; Content-Length: 9593\n&#x3C; Access-Control-Allow-Origin: *\n&#x3C; Access-Control-Allow-Credentials: true\n&#x3C;\n</span></code></pre>\n<h1>Ambient Injection</h1>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>지금까지 앰비언트 모드가 활성화되지 않았습니다. Istio 게이트웨이에서 추가 된 리스너로 인해 요청은 Istio 인그레스 파드에 도착한 다음 VirtualService를 통해 앱 파드로 라우팅됩니다.</p>\n<p>매쉬 내부 호출의 경우, 클라이언트와 서버 파드 사이에 직접적인 포드 간 통신이 이루어집니다.</p>\n<p><img src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_8.png\" alt=\"이미지\"></p>\n<p>앰비언트를 주입하는 동안 우리는 또한 다음 로그를 계속 추적할 것입니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<ul>\n<li>istio-cni</li>\n<li>ztunnel</li>\n</ul>\n<p>Istio가 네임스페이스 ambient-demo에 대한 Ambient Dataplane 모드를 활성화하도록 내부적으로 라우트, iptables 등을 설정했는지 확인하려면 아래 명령어를 사용해보세요.</p>\n<pre><code class=\"hljs language-js\">(⎈|kind-<span class=\"hljs-attr\">ambient</span>:ambient-demo)➜\n~ kubectl label namespace ambient-demo istio.<span class=\"hljs-property\">io</span>/dataplane-mode=ambient\n</code></pre>\n<h2>관찰된 로그</h2>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<ul>\n<li>istio-cni</li>\n</ul>\n<pre><code class=\"hljs language-js\">(⎈|kind-<span class=\"hljs-attr\">ambient</span>:ambient-demo)➜ ~ stern istio-cni -n istio-system\n\nistio-cni-node-7q6z7 install-cni <span class=\"hljs-number\">2024</span>-<span class=\"hljs-number\">06</span>-16<span class=\"hljs-attr\">T10</span>:<span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">59.</span>243451Z info ambient <span class=\"hljs-title class_\">Namespace</span> ambient-demo is enabled <span class=\"hljs-keyword\">in</span> ambient mesh\nistio-cni-node-7q6z7 install-cni <span class=\"hljs-number\">2024</span>-<span class=\"hljs-number\">06</span>-16<span class=\"hljs-attr\">T10</span>:<span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">59.</span>264500Z info ambient <span class=\"hljs-keyword\">in</span> pod mode - adding pod ambient-demo/httpbin-5bd875fbdd-84vs8 to ztunnel\nistio-cni-node-gwvl8 install-cni <span class=\"hljs-number\">2024</span>-<span class=\"hljs-number\">06</span>-16<span class=\"hljs-attr\">T10</span>:<span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">59.</span>291505Z info ambient <span class=\"hljs-title class_\">Namespace</span> ambient-demo is enabled <span class=\"hljs-keyword\">in</span> ambient mesh\nistio-cni-node-fg6n4 install-cni <span class=\"hljs-number\">2024</span>-<span class=\"hljs-number\">06</span>-16<span class=\"hljs-attr\">T10</span>:<span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">59.</span>281587Z info ambient <span class=\"hljs-title class_\">Namespace</span> ambient-demo is enabled <span class=\"hljs-keyword\">in</span> ambient mesh\nistio-cni-node-fg6n4 install-cni <span class=\"hljs-number\">2024</span>-<span class=\"hljs-number\">06</span>-16<span class=\"hljs-attr\">T10</span>:<span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">59.</span>313668Z info ambient <span class=\"hljs-keyword\">in</span> pod mode - adding pod ambient-demo/httpbin-5bd875fbdd-dp4ct to ztunnel\n\nistio-cni-node-7q6z7 install-cni <span class=\"hljs-number\">2024</span>-<span class=\"hljs-number\">06</span>-16<span class=\"hljs-attr\">T10</span>:<span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">59.</span>264500Z info ambient <span class=\"hljs-keyword\">in</span> pod mode - adding pod ambient-demo/httpbin-5bd875fbdd-84vs8 to ztunnel\nistio-cni-node-7q6z7 install-cni <span class=\"hljs-number\">2024</span>-<span class=\"hljs-number\">06</span>-16<span class=\"hljs-attr\">T10</span>:<span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">59.</span>325907Z info iptables <span class=\"hljs-title class_\">Running</span> iptables-restore <span class=\"hljs-keyword\">with</span> the following <span class=\"hljs-attr\">input</span>:\nistio-cni-node-7q6z7 install-cni * nat\nistio-cni-node-7q6z7 install-cni -N <span class=\"hljs-variable constant_\">ISTIO_OUTPUT</span>\nistio-cni-node-7q6z7 install-cni -A <span class=\"hljs-variable constant_\">OUTPUT</span> -j <span class=\"hljs-variable constant_\">ISTIO_OUTPUT</span>\nistio-cni-node-7q6z7 install-cni -A <span class=\"hljs-variable constant_\">ISTIO_OUTPUT</span> -d <span class=\"hljs-number\">169.254</span><span class=\"hljs-number\">.7</span><span class=\"hljs-number\">.127</span> -p tcp -m tcp -j <span class=\"hljs-variable constant_\">ACCEPT</span>\nistio-cni-node-7q6z7 install-cni -A <span class=\"hljs-variable constant_\">ISTIO_OUTPUT</span> -p tcp -m mark --mark <span class=\"hljs-number\">0x111</span>/<span class=\"hljs-number\">0xfff</span> -j <span class=\"hljs-variable constant_\">ACCEPT</span>\nistio-cni-node-7q6z7 install-cni -A <span class=\"hljs-variable constant_\">ISTIO_OUTPUT</span> ! -d <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>/<span class=\"hljs-number\">32</span> -o lo -j <span class=\"hljs-variable constant_\">ACCEPT</span>\nistio-cni-node-7q6z7 install-cni -A <span class=\"hljs-variable constant_\">ISTIO_OUTPUT</span> ! -d <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>/<span class=\"hljs-number\">32</span> -p tcp -m mark ! --mark <span class=\"hljs-number\">0x539</span>/<span class=\"hljs-number\">0xfff</span> -j <span class=\"hljs-variable constant_\">REDIRECT</span> --to-ports <span class=\"hljs-number\">15001</span>\nistio-cni-node-7q6z7 install-cni <span class=\"hljs-variable constant_\">COMMIT</span>\nistio-cni-node-7q6z7 install-cni * mangle\nistio-cni-node-7q6z7 install-cni -N <span class=\"hljs-variable constant_\">ISTIO_PRERT</span>\nistio-cni-node-7q6z7 install-cni -N <span class=\"hljs-variable constant_\">ISTIO_OUTPUT</span>\nistio-cni-node-7q6z7 install-cni -A <span class=\"hljs-variable constant_\">PREROUTING</span> -j <span class=\"hljs-variable constant_\">ISTIO_PRERT</span>\nistio-cni-node-7q6z7 install-cni -A <span class=\"hljs-variable constant_\">OUTPUT</span> -j <span class=\"hljs-variable constant_\">ISTIO_OUTPUT</span>\nistio-cni-node-7q6z7 install-cni -A <span class=\"hljs-variable constant_\">ISTIO_PRERT</span> -m mark --mark <span class=\"hljs-number\">0x539</span>/<span class=\"hljs-number\">0xfff</span> -j <span class=\"hljs-variable constant_\">CONNMARK</span> --set-xmark <span class=\"hljs-number\">0x111</span>/<span class=\"hljs-number\">0xfff</span>\nistio-cni-node-7q6z7 install-cni -A <span class=\"hljs-variable constant_\">ISTIO_PRERT</span> -s <span class=\"hljs-number\">169.254</span><span class=\"hljs-number\">.7</span><span class=\"hljs-number\">.127</span> -p tcp -m tcp -j <span class=\"hljs-variable constant_\">ACCEPT</span>\nistio-cni-node-7q6z7 install-cni -A <span class=\"hljs-variable constant_\">ISTIO_PRERT</span> ! -d <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>/<span class=\"hljs-number\">32</span> -p tcp -i lo -j <span class=\"hljs-variable constant_\">ACCEPT</span>\nistio-cni-node-7q6z7 install-cni -A <span class=\"hljs-variable constant_\">ISTIO_PRERT</span> -p tcp -m tcp --dport <span class=\"hljs-number\">15008</span> -m mark ! --mark <span class=\"hljs-number\">0x539</span>/<span class=\"hljs-number\">0xfff</span> -j <span class=\"hljs-variable constant_\">TPROXY</span> --on-port <span class=\"hljs-number\">15008</span> --tproxy-mark <span class=\"hljs-number\">0x111</span>/<span class=\"hljs-number\">0xfff</span>\nistio-cni-node-7q6z7 install-cni -A <span class=\"hljs-variable constant_\">ISTIO_PRERT</span> -p tcp -m conntrack --ctstate <span class=\"hljs-variable constant_\">RELATED</span>,<span class=\"hljs-variable constant_\">ESTABLISHED</span> -j <span class=\"hljs-variable constant_\">ACCEPT</span>\nistio-cni-node-7q6z7 install-cni -A <span class=\"hljs-variable constant_\">ISTIO_PRERT</span> ! -d <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>/<span class=\"hljs-number\">32</span> -p tcp -m mark ! --mark <span class=\"hljs-number\">0x539</span>/<span class=\"hljs-number\">0xfff</span> -j <span class=\"hljs-variable constant_\">TPROXY</span> --on-port <span class=\"hljs-number\">15006</span> --tproxy-mark <span class=\"hljs-number\">0x111</span>/<span class=\"hljs-number\">0xfff</span>\nistio-cni-node-7q6z7 install-cni -A <span class=\"hljs-variable constant_\">ISTIO_OUTPUT</span> -m connmark --mark <span class=\"hljs-number\">0x111</span>/<span class=\"hljs-number\">0xfff</span> -j <span class=\"hljs-variable constant_\">CONNMARK</span> --restore-mark --nfmask <span class=\"hljs-number\">0xffffffff</span> --ctmask <span class=\"hljs-number\">0xffffffff</span>\nistio-cni-node-7q6z7 install-cni <span class=\"hljs-variable constant_\">COMMIT</span>\nistio-cni-node-7q6z7 install-cni <span class=\"hljs-number\">2024</span>-<span class=\"hljs-number\">06</span>-16<span class=\"hljs-attr\">T10</span>:<span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">59.</span>335115Z info <span class=\"hljs-title class_\">Running</span> command (<span class=\"hljs-keyword\">with</span> wait lock): iptables-restore --noflush -v --wait=<span class=\"hljs-number\">30</span>\nistio-cni-node-7q6z7 install-cni <span class=\"hljs-number\">2024</span>-<span class=\"hljs-number\">06</span>-16<span class=\"hljs-attr\">T10</span>:<span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">59.</span>550687Z info ambient <span class=\"hljs-title class_\">About</span> to send added <span class=\"hljs-attr\">pod</span>: 3ab72f78-8e2b-<span class=\"hljs-number\">4e49</span>-bc47-45fa4f90dbf7 to <span class=\"hljs-attr\">ztunnel</span>: <span class=\"hljs-attr\">add</span>:{<span class=\"hljs-attr\">uid</span>:<span class=\"hljs-string\">\"3ab72f78-8e2b-4e49-bc47-45fa4f90dbf7\"</span> <span class=\"hljs-attr\">workload_info</span>:{<span class=\"hljs-attr\">name</span>:<span class=\"hljs-string\">\"httpbin-5bd875fbdd-84vs8\"</span> <span class=\"hljs-attr\">namespace</span>:<span class=\"hljs-string\">\"ambient-demo\"</span> <span class=\"hljs-attr\">service_account</span>:<span class=\"hljs-string\">\"default\"</span> <span class=\"hljs-attr\">trust_domain</span>:<span class=\"hljs-string\">\"cluster.local\"</span>}\n</code></pre>\n<p>많은 로그가 생성되었습니다. 우리는 각 httpbin pod를 ambient-demo 네임스페이스에 추가하여 ztunnel을 통해 ambient 경로에 추가하고 있음을 확인할 수 있습니다.</p>\n<ul>\n<li>ztunnel</li>\n</ul>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<pre><code class=\"hljs language-plaintext\">(⎈|kind-ambient:ambient-demo)➜ ~ stern ztunnel -n istio-system\n\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.559505Z 정보 inpod::statemanager pod WorkloadUid(\"3ab72f78-8e2b-4e49-bc47-45fa4f90dbf7\")가 netns를 수신하고 프록시를 시작합니다.\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.557545Z 정보 inpod::statemanager pod WorkloadUid(\"7f8be6a6-64f2-40e9-8926-6c3a618eb7d9\")가 netns를 수신하고 프록시를 시작합니다.\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.560458Z 정보 proxy::inbound 리스너가 구성되었으며 주소=[::]:15008 구성요소=\"inbound\" 투명=true\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.561604Z 정보 proxy::inbound_passthrough 리스너가 구성되었으며 주소=[::]:15006 구성요소=\"inbound plaintext\" 투명=true\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.561647Z 정보 proxy::outbound 리스너가 구성되었으며 주소=[::]:15001 구성요소=\"outbound\" 투명=true\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.573883Z 정보 proxy::inbound 리스너가 구성되었으며 주소=[::]:15008 구성요소=\"inbound\" 투명=true\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.586596Z 정보 proxy::inbound_passthrough 리스너가 구성되었으며 주소=[::]:15006 구성요소=\"inbound plaintext\" 투명=true\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.586819Z 정보 proxy::outbound 리스너가 구성되었으며 주소=[::]:15001 구성요소=\"outbound\" 투명=true\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.811460Z 정보 xds::client:xds{id=14}가 응답을 수신했습니다. type_url=\"type.googleapis.com/istio.workload.Address\" 크기=2  삭제=0\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.816352Z 정보 xds::client:xds{id=14}가 응답을 수신했습니다. type_url=\"type.googleapis.com/istio.workload.Address\" 크기=2  삭제=0\nztunnel-gs52c istio-proxy 2024-06-16T10:13:59.821310Z 정보 xds::client:xds{id=14}가 응답을 수신했습니다. type_url=\"type.googleapis.com/istio.workload.Address\" 크기=2  삭제=0\n</code></pre>\n<p>ztunnel이 자체 내부 및 외부 리스너를 설정 중인 것으로 보입니다.</p>\n<h2>트래픽 흐름 - Istio Ingress를 통해</h2>\n<p>이전과 마찬가지로, istio-ingress pod로 포트 포워딩을 설정하고 localhost를 통해 액세스합니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>두 개의 호출을 각각 2개의 httpbin 팟에 대응하도록 인그레스에서 호출을 추출하려고 합니다. 그리고 동시에 동일한 ztunnel 로그를 캡처하려고 합니다.</p>\n<pre><code class=\"hljs language-js\">(⎈|kind-<span class=\"hljs-attr\">ambient</span>:istio-system)➜  ~ kpf istio-ingressgateway-6f48dfb7db-862sm <span class=\"hljs-number\">8081</span>\n<span class=\"hljs-title class_\">Forwarding</span> <span class=\"hljs-keyword\">from</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>:<span class=\"hljs-number\">8081</span> -> <span class=\"hljs-number\">8081</span>\n\n$ curl <span class=\"hljs-attr\">localhost</span>:<span class=\"hljs-number\">8081</span>/\n$ curl <span class=\"hljs-attr\">localhost</span>:<span class=\"hljs-number\">8081</span>/\n</code></pre>\n<pre><code class=\"hljs language-js\">(⎈|kind-<span class=\"hljs-attr\">ambient</span>:istio-system)➜  ~ stern ztunnel -n istio-system\n\nztunnel-fv5f8 istio-proxy <span class=\"hljs-number\">2024</span>-<span class=\"hljs-number\">06</span>-16<span class=\"hljs-attr\">T12</span>:<span class=\"hljs-number\">26</span>:<span class=\"hljs-number\">24.</span>154500Z\ninfo access connection complete src.<span class=\"hljs-property\">addr</span>=<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.70</span>:<span class=\"hljs-number\">52792</span>\nsrc.<span class=\"hljs-property\">workload</span>=istio-ingressgateway-6f48dfb7db-862sm src.<span class=\"hljs-property\">namespace</span>=istio-system\nsrc.<span class=\"hljs-property\">identity</span>=<span class=\"hljs-string\">\"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account\"</span>\ndst.<span class=\"hljs-property\">addr</span>=<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.74</span>:<span class=\"hljs-number\">80</span> dst.<span class=\"hljs-property\">hbone_addr</span>=<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.74</span>:<span class=\"hljs-number\">80</span>\ndst.<span class=\"hljs-property\">service</span>=httpbin.<span class=\"hljs-property\">ambient</span>-demo.<span class=\"hljs-property\">svc</span>.<span class=\"hljs-property\">cluster</span>.<span class=\"hljs-property\">local</span>\ndst.<span class=\"hljs-property\">workload</span>=httpbin-6f4dc97cb-swdlb dst.<span class=\"hljs-property\">namespace</span>=ambient-demo\ndst.<span class=\"hljs-property\">identity</span>=<span class=\"hljs-string\">\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\"</span>\ndirection=<span class=\"hljs-string\">\"inbound\"</span> bytes_sent=<span class=\"hljs-number\">51083</span> bytes_recv=<span class=\"hljs-number\">4180</span> duration=<span class=\"hljs-string\">\"2166ms\"</span>\n\nztunnel-62hp8 istio-proxy <span class=\"hljs-number\">2024</span>-<span class=\"hljs-number\">06</span>-16<span class=\"hljs-attr\">T12</span>:<span class=\"hljs-number\">28</span>:<span class=\"hljs-number\">40.</span>267690Z\ninfo access connection complete src.<span class=\"hljs-property\">addr</span>=<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.70</span>:<span class=\"hljs-number\">55036</span>\nsrc.<span class=\"hljs-property\">workload</span>=istio-ingressgateway-6f48dfb7db-862sm src.<span class=\"hljs-property\">namespace</span>=istio-system\nsrc.<span class=\"hljs-property\">identity</span>=<span class=\"hljs-string\">\"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account\"</span>\ndst.<span class=\"hljs-property\">addr</span>=<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.246</span><span class=\"hljs-number\">.6</span>:<span class=\"hljs-number\">80</span> dst.<span class=\"hljs-property\">hbone_addr</span>=<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.246</span><span class=\"hljs-number\">.6</span>:<span class=\"hljs-number\">80</span>\ndst.<span class=\"hljs-property\">service</span>=httpbin.<span class=\"hljs-property\">ambient</span>-demo.<span class=\"hljs-property\">svc</span>.<span class=\"hljs-property\">cluster</span>.<span class=\"hljs-property\">local</span>\ndst.<span class=\"hljs-property\">workload</span>=httpbin-6f4dc97cb-5dpz9 dst.<span class=\"hljs-property\">namespace</span>=ambient-demo\ndst.<span class=\"hljs-property\">identity</span>=<span class=\"hljs-string\">\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\"</span>\ndirection=<span class=\"hljs-string\">\"inbound\"</span> bytes_sent=<span class=\"hljs-number\">41251</span> bytes_recv=<span class=\"hljs-number\">2007</span> duration=<span class=\"hljs-string\">\"2331ms\"</span>\n</code></pre>\n<p>인그레스가 주변 데이터 플레인 경로에 떨어지지 않기 때문에 인그레스 팟에서의 호출은 주변 데이터 플레인 경로로 직접 ztunnel 팟으로 이어집니다. 한 번에 하나의 노드로 이동한 후 해당 내부 노드 팟으로 inbound됩니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>아래는 로그 캡처에서 확인한 내용입니다</p>\n<pre><code class=\"hljs language-js\">direction = <span class=\"hljs-string\">\"inbound\"</span>;\n</code></pre>\n<ul>\n<li>이는 주변 레이블이 붙은 네임스페이스 파드로의 트래픽이 항상 ztunnel을 통해 이동함을 확인합니다.</li>\n</ul>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>dst.hbone_addr=192.168.184.74:80\ndst.hbone_addr=192.168.246.6:80</p>\n<p>httpbin-6f4dc97cb-5dpz9 1/1 Running 0 56m 192.168.246.6 ambient-worker2 <none> <none>\nhttpbin-6f4dc97cb-swdlb 1/1 Running 0 56m 192.168.184.74 ambient-worker <none> <none></none></none></none></none></p>\n<ul>\n<li>이것은 실제 httpbin pod ip에 해당하는 dest pod ip를 캡처합니다.</li>\n</ul>\n<h2>트래픽 흐름 — Mesh 내부를 통해</h2>\n<p>클라이언트 디버그 pod에 exec하여 httpbin 서비스로의 Mesh 내부 호출을 시도하고 동시에 ztunnel 로그를 캡쳐하여 동일한 동작을 확인해보겠습니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<pre><code class=\"hljs language-js\">(⎈|kind-<span class=\"hljs-attr\">ambient</span>:ambient-demo)➜  ~ kgpo -owide\n<span class=\"hljs-variable constant_\">NAME</span>                      <span class=\"hljs-variable constant_\">READY</span>   <span class=\"hljs-variable constant_\">STATUS</span>    <span class=\"hljs-variable constant_\">RESTARTS</span>   <span class=\"hljs-variable constant_\">AGE</span>    <span class=\"hljs-variable constant_\">IP</span>               <span class=\"hljs-variable constant_\">NODE</span>                    <span class=\"hljs-variable constant_\">NOMINATED</span> <span class=\"hljs-variable constant_\">NODE</span>   <span class=\"hljs-variable constant_\">READINESS</span> <span class=\"hljs-variable constant_\">GATES</span>\ndoks-debug-j9mm5          <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>          122m   <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.246</span><span class=\"hljs-number\">.5</span>    ambient-worker2         &#x3C;none>           &#x3C;none>\ndoks-debug-rdhgq          <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>          122m   <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.73</span>   ambient-worker          &#x3C;none>           &#x3C;none>\ndoks-debug-v7cld          <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>          122m   <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.208</span><span class=\"hljs-number\">.3</span>    ambient-control-plane   &#x3C;none>           &#x3C;none>\nhttpbin-6f4dc97cb-5dpz9   <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>          56m    <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.246</span><span class=\"hljs-number\">.6</span>    ambient-worker2         &#x3C;none>           &#x3C;none>\nhttpbin-6f4dc97cb-swdlb   <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>          56m    <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.74</span>   ambient-worker          &#x3C;none>           &#x3C;none>\n</code></pre>\n<p>그냥 같은 노드에 있는 클라이언트와 앱 팟들을 연결하기 위해 —</p>\n<pre><code class=\"hljs language-js\">(⎈|kind-<span class=\"hljs-attr\">ambient</span>:ambient-demo)➜  ~ kgpo -A -owide | grep <span class=\"hljs-string\">\"ambient-worker \"</span>\nambient-demo         doks-debug-rdhgq                                <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>               133m    <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.73</span>   ambient-worker          &#x3C;none>           &#x3C;none>\nistio-system         ztunnel-fv5f8                                   <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>               3h24m   <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.71</span>   ambient-worker          &#x3C;none>           &#x3C;none>\nambient-demo         httpbin-6f4dc97cb-swdlb                         <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>               68m     <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.74</span>   ambient-worker          &#x3C;none>           &#x3C;none>\n\n\n(⎈|kind-<span class=\"hljs-attr\">ambient</span>:ambient-demo)➜  ~ kgpo -A -owide | grep <span class=\"hljs-string\">\"ambient-worker2\"</span>\nkube-system          doks-debug-9nlh7                                <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>               3h6m    <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.246</span><span class=\"hljs-number\">.4</span>    ambient-worker2         &#x3C;none>           &#x3C;none>\nistio-system         ztunnel-62hp8                                   <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>               3h23m   <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.246</span><span class=\"hljs-number\">.3</span>    ambient-worker2         &#x3C;none>           &#x3C;none>\nambient-demo         httpbin-6f4dc97cb-5dpz9                         <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">1</span>     <span class=\"hljs-title class_\">Running</span>   <span class=\"hljs-number\">0</span>               67m     <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.246</span><span class=\"hljs-number\">.6</span>    ambient-worker2         &#x3C;none>           &#x3C;none>\n</code></pre>\n<p>debug pod인 doks-debug-rdhgq를 실행하기 위해 ambient-worker 노드에 스케줄된 상태로 들어가보겠습니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<img src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_10.png\">\n<pre><code class=\"hljs language-js\">테이블 <span class=\"hljs-number\">1</span>: 동일 노드 내의 클라이언트 및 서버\n---------\nztunnel-fv5f8 istio-proxy <span class=\"hljs-number\">2024</span>-<span class=\"hljs-number\">06</span>-16<span class=\"hljs-attr\">T12</span>:<span class=\"hljs-number\">40</span>:<span class=\"hljs-number\">48.</span>707707Z info access connection complete src.<span class=\"hljs-property\">addr</span>=<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.73</span>:<span class=\"hljs-number\">56463</span> src.<span class=\"hljs-property\">workload</span>=doks-debug-rdhgq src.<span class=\"hljs-property\">namespace</span>=ambient-demo src.<span class=\"hljs-property\">identity</span>=<span class=\"hljs-string\">\"spiffe://cluster.local/ns/ambient-demo/sa/default\"</span> dst.<span class=\"hljs-property\">addr</span>=<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.74</span>:<span class=\"hljs-number\">80</span> dst.<span class=\"hljs-property\">hbone_addr</span>=<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.74</span>:<span class=\"hljs-number\">80</span> dst.<span class=\"hljs-property\">service</span>=httpbin.<span class=\"hljs-property\">ambient</span>-demo.<span class=\"hljs-property\">svc</span>.<span class=\"hljs-property\">cluster</span>.<span class=\"hljs-property\">local</span> dst.<span class=\"hljs-property\">workload</span>=httpbin-6f4dc97cb-swdlb dst.<span class=\"hljs-property\">namespace</span>=ambient-demo dst.<span class=\"hljs-property\">identity</span>=<span class=\"hljs-string\">\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\"</span> direction  =<span class=\"hljs-string\">\"inbound\"</span> bytes_sent=<span class=\"hljs-number\">9832</span> bytes_recv=<span class=\"hljs-number\">84</span> duration=<span class=\"hljs-string\">\"178ms\"</span>\nztunnel-fv5f8 istio-proxy <span class=\"hljs-number\">2024</span>-<span class=\"hljs-number\">06</span>-16<span class=\"hljs-attr\">T12</span>:<span class=\"hljs-number\">40</span>:<span class=\"hljs-number\">48.</span>708070Z info access connection complete src.<span class=\"hljs-property\">addr</span>=<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.73</span>:<span class=\"hljs-number\">34190</span> src.<span class=\"hljs-property\">workload</span>=doks-debug-rdhgq src.<span class=\"hljs-property\">namespace</span>=ambient-demo src.<span class=\"hljs-property\">identity</span>=<span class=\"hljs-string\">\"spiffe://cluster.local/ns/ambient-demo/sa/default\"</span> dst.<span class=\"hljs-property\">addr</span>=<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.74</span>:<span class=\"hljs-number\">15008</span> dst.<span class=\"hljs-property\">hbone_addr</span>=<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.74</span>:<span class=\"hljs-number\">80</span> dst.<span class=\"hljs-property\">service</span>=httpbin.<span class=\"hljs-property\">ambient</span>-demo.<span class=\"hljs-property\">svc</span>.<span class=\"hljs-property\">cluster</span>.<span class=\"hljs-property\">local</span> dst.<span class=\"hljs-property\">workload</span>=httpbin-6f4dc97cb-swdlb dst.<span class=\"hljs-property\">namespace</span>=ambient-demo dst.<span class=\"hljs-property\">identity</span>=<span class=\"hljs-string\">\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\"</span> direction=<span class=\"hljs-string\">\"outbound\"</span> bytes_sent=<span class=\"hljs-number\">84</span> bytes_recv=<span class=\"hljs-number\">9832</span> duration=<span class=\"hljs-string\">\"203ms\"</span>\n</code></pre>\n<p>동일 노드 내의 클라이언트와 서버의 경우, 파드에서 ztunnel로 외부 패킷이 들어오면 동일한 ztunnel을 통해 대상 파드로 들어오는 내부 패킷으로 리디렉션됩니다.</p>\n<p>따라서, 동일 노드 내의 클라이언트 및 서버에서는 한 ztunnel이 외부 패킷과 내부 패킷을 받습니다. \"bound\"는 동일 노드 내의 응용 프로그램 파드로부터/받는 방향을 지정합니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<pre><code class=\"hljs language-js\">캡처 <span class=\"hljs-number\">2</span>: 클라이언트 및 서버가 다른 노드에 있는 경우\n---------\nztunnel-62hp8 istio-proxy <span class=\"hljs-number\">2024</span>-<span class=\"hljs-number\">06</span>-16<span class=\"hljs-attr\">T12</span>:<span class=\"hljs-number\">48</span>:<span class=\"hljs-number\">51.</span>792527Z info access connection complete src.<span class=\"hljs-property\">addr</span>=<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.73</span>:<span class=\"hljs-number\">53265</span> src.<span class=\"hljs-property\">workload</span>=doks-debug-rdhgq src.<span class=\"hljs-property\">namespace</span>=ambient-demo src.<span class=\"hljs-property\">identity</span>=<span class=\"hljs-string\">\"spiffe://cluster.local/ns/ambient-demo/sa/default\"</span> dst.<span class=\"hljs-property\">addr</span>=<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.246</span><span class=\"hljs-number\">.6</span>:<span class=\"hljs-number\">80</span> dst.<span class=\"hljs-property\">hbone_addr</span>=<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.246</span><span class=\"hljs-number\">.6</span>:<span class=\"hljs-number\">80</span> dst.<span class=\"hljs-property\">service</span>=httpbin.<span class=\"hljs-property\">ambient</span>-demo.<span class=\"hljs-property\">svc</span>.<span class=\"hljs-property\">cluster</span>.<span class=\"hljs-property\">local</span> dst.<span class=\"hljs-property\">workload</span>=httpbin-6f4dc97cb-5dpz9 dst.<span class=\"hljs-property\">namespace</span>=ambient-demo dst.<span class=\"hljs-property\">identity</span>=<span class=\"hljs-string\">\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\"</span> direction=<span class=\"hljs-string\">\"inbound\"</span> bytes_sent=<span class=\"hljs-number\">9832</span> bytes_recv=<span class=\"hljs-number\">84</span> duration=<span class=\"hljs-string\">\"60ms\"</span>\nztunnel-fv5f8 istio-proxy <span class=\"hljs-number\">2024</span>-<span class=\"hljs-number\">06</span>-16<span class=\"hljs-attr\">T12</span>:<span class=\"hljs-number\">48</span>:<span class=\"hljs-number\">51.</span>793112Z info access connection complete src.<span class=\"hljs-property\">addr</span>=<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.184</span><span class=\"hljs-number\">.73</span>:<span class=\"hljs-number\">60162</span> src.<span class=\"hljs-property\">workload</span>=doks-debug-rdhgq src.<span class=\"hljs-property\">namespace</span>=ambient-demo src.<span class=\"hljs-property\">identity</span>=<span class=\"hljs-string\">\"spiffe://cluster.local/ns/ambient-demo/sa/default\"</span> dst.<span class=\"hljs-property\">addr</span>=<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.246</span><span class=\"hljs-number\">.6</span>:<span class=\"hljs-number\">15008</span> dst.<span class=\"hljs-property\">hbone_addr</span>=<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.246</span><span class=\"hljs-number\">.6</span>:<span class=\"hljs-number\">80</span> dst.<span class=\"hljs-property\">service</span>=httpbin.<span class=\"hljs-property\">ambient</span>-demo.<span class=\"hljs-property\">svc</span>.<span class=\"hljs-property\">cluster</span>.<span class=\"hljs-property\">local</span> dst.<span class=\"hljs-property\">workload</span>=httpbin-6f4dc97cb-5dpz9 dst.<span class=\"hljs-property\">namespace</span>=ambient-demo dst.<span class=\"hljs-property\">identity</span>=<span class=\"hljs-string\">\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\"</span> direction=<span class=\"hljs-string\">\"outbound\"</span> bytes_sent=<span class=\"hljs-number\">84</span> bytes_recv=<span class=\"hljs-number\">9832</span> duration=<span class=\"hljs-string\">\"61ms\"</span>\n</code></pre>\n<p>만약 클라이언트와 서버가 다른 노드에 있는 경우, 출발 트래픽은 동일한 노드인 ztunnel에서 외부 트래픽 패킷을 만나고, 그런 다음 목적지 파드의 노드의 ztunnel로 전송되어 들어오는 패킷으로 처리됩니다.</p>\n<h1>결론</h1>\n<p>이 실험을 통해 Istio Ambient Mesh에서 ztunnel을 통한 패킷 흐름을 시각화할 수 있었습니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p><img src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_11.png\" alt=\"이미지\"></p>\n<p>다음 파트에서는 ztunnel을 통해 적용할 수 있는 L4 인증 정책을 탐색할 것입니다.</p>\n<p>또한 Ambient에 있는 L7 프록시인 Waypoint Proxy에 대해 탐구할 것입니다.</p>\n<p>다른 기술 블로그는 여기에서 확인할 수 있습니다: <a href=\"https://janasabuj.github.io/posts/\" rel=\"nofollow\" target=\"_blank\">링크</a></p>\n</body>\n</html>\n"},"__N_SSG":true}