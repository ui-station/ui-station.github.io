{"pageProps":{"post":{"title":"Google Cloud에서 Terraform을 사용하여 인프라 구축하기 - Google Challenge Lab 안내","description":"","date":"2024-05-20 17:28","slug":"2024-05-20-BuildInfrastructureonGoogleCloudwithTerraformGoogleChallengeLabWalkthrough","content":"\n\n구글 클라우드에서 Terraform으로 인프라를 구축하는 코스의 챌린지 랩 워크스루입니다.\n\n이 랩은 다음을 테스트합니다:\n\n- 기존 인프라를 Terraform 구성으로 가져오는 능력.\n- 직접 Terraform 모듈을 빌드하고 참조하는 것.\n- 원격 백엔드를 구성에 추가하는 것.\n- Terraform 레지스트리에서 모듈을 사용하고 구현하는 것.\n- 인프라를 다시 프로비저닝하고 파괴하고 업데이트하는 것.\n- 생성한 리소스 간의 연결성을 테스트하는 것.\n\n# 챌린지 랩 소개\n\n<div class=\"content-ad\"></div>\n\nGoogle은 구글 클라우드 스킬즈 부스트(이전 명칭: QwikLabs)라는 온라인 학습 플랫폼을 제공합니다. 이 플랫폼에서는 학습 경로에 맞는 교육 과정을 따르거나 특정 제품 또는 솔루션에 대한 교육 과정을 진행할 수 있습니다.\n\n이 플랫폼에서의 학습 경험 중 하나는 퀘스트입니다. 퀘스트에 참여하면 안내형 실습 랩을 수행한 후 도전 랩을 완료합니다. 도전 랩은 목표가 명시되지만 목표를 달성하는 방법에 대한 안내가 거의 없는 다른 랩과는 다릅니다.\n\n제가 가끔 이 도전 랩에 대한 해결 방법을 제공합니다. 목표는 도전 랩을 도와주어서 쉽게 풀어내는 데 도움을 주는 것이 아닙니다! 대신에:\n\n- 랩을 완료하는 데 가장 이상적인 경로로 이끄는 것을 보여드립니다.\n- 랩을 스스로 완료할 수 없는 특정 문제나 장애물을 해결하는 데 도움을 줍니다.\n\n<div class=\"content-ad\"></div>\n\n도움이 필요한 경우, 도전 과제에 대한 도움을 얻으려면 올바른 곳에 오신 것을 환영합니다. 그러나 먼저 퀘스트를 진행하고 직접 랩을 시도한 후에 계속 읽기를 강력히 권장합니다!\n\n이러한 랩들은 문제 해결에 대해 다양한 방법이 항상 있습니다. 일반적으로 저는 더 반복 가능하고 프로그래밸하게 문제를 해결할 수 있도록 문제를 해결하는 것이 좋습니다. 그러나 물론 클라우드 콘솔도 사용할 수 있습니다.\n\n# 이 랩 개요\n\n이 랩에서는 Terraform을 사용하여 Google Cloud에서 인프라를 생성, 배포 및 관리해야 합니다. 또한 일부 관리되지 않은 인스턴스를 구성에 가져와 수정해야 합니다.\n\n<div class=\"content-ad\"></div>\n\n# 나의 해결책\n\n우리가 이 도전 과제 동안 사용할 몇 가지 변수를 정의하는 것부터 시작해봅시다. 실제 변수는 랩을 시작할 때 제공될 것입니다.\n\n```js\ngcloud auth list\n\nregion=<지역 입력>\nzone=<존 입력>\nprj=<프로젝트 ID 입력>\n```\n\n## 작업 1 — 구성 파일 생성\n\n<div class=\"content-ad\"></div>\n\n이 폴더 구조를 만들라고 지시받았어요:\n\n```js\nmain.tf\nvariables.tf\nmodules/\n└── instances\n|   ├── instances.tf\n|   ├── outputs.tf\n|   └── variables.tf\n└── storage\n    ├── storage.tf\n    ├── outputs.tf\n    └── variables.tf\n```\n\n이렇게 만들어볼까요:\n\n```js\n# 루트 디렉토리에 main.tf와 variables.tf 파일 생성\ntouch main.tf variables.tf\n\n# main 디렉토리 및 파일 생성\nmkdir -p modules/instances\nmkdir modules/storage\n\n# 'instances' 모듈 디렉토리에 필요한 파일 생성\ntouch modules/instances/instances.tf\ntouch modules/instances/outputs.tf\ntouch modules/instances/variables.tf\n\n# 'storage' 모듈 디렉토리에 필요한 파일 생성\ntouch modules/storage/storage.tf\ntouch modules/storage/outputs.tf\ntouch modules/storage/variables.tf\n```\n\n<div class=\"content-ad\"></div>\n\n이제 변수.tf 파일을 업데이트하여 다음 변수들을 포함하도록 합니다:\n\n```js\nvariable \"region\" {\n  description = \"Google Cloud 지역\"\n  type        = string\n  default     = \"실습에서 제공하는 지역\"\n}\n\nvariable \"zone\" {\n  description = \"Google Cloud 존\"\n  type        = string\n  default     = \"실습에서 제공하는 존\"\n}\n\nvariable \"project_id\" {\n  description = \"리소스를 프로비저닝할 프로젝트의 ID\"\n  type        = string\n  default     = \"귀하의 프로젝트 ID\"\n}\n```\n\n루트 모듈 main.tf를 업데이트하여 Google Cloud Provider를 포함하도록 합니다. Terraform Registry에서 항상 확인할 수 있습니다. 제공자 블록에 세 가지 변수를 모두 포함하도록 요청되었습니다.\n\n```js\nterraform {\n  required_providers {\n    google = {\n      version = \"~> 4.0\"\n    }\n  }\n}\n\nprovider \"google\" {\n  project     = var.project_id\n  region      = var.region\n  zone        = var.zone\n}\n```\n\n<div class=\"content-ad\"></div>\n\n이제 테라폼을 초기화해야 합니다. 따라서 다음 명령을 실행하세요:\n\n```js\nterraform init\n```\n\n## 작업 2 — 인프라 가져오기\n\n여기서의 목표는 지금까지 테라폼 외부에서 프로비저닝된 인프라를 테라폼 제어 아래로 가져오는 것입니다.\n\n<div class=\"content-ad\"></div>\n\n테라폼 가져오기 워크플로우를 사용할 거에요:\n\n![이미지](/assets/img/2024-05-20-BuildInfrastructureonGoogleCloudwithTerraformGoogleChallengeLabWalkthrough_0.png)\n\n이것들은 가져오기 단계들이에요:\n\n- 가져올 기존 인프라를 식별하세요.\n- 인프라를 테라폼 상태에 가져오세요.\n- 해당 인프라와 일치하는 테라폼 구성을 작성하세요.\n- 구성이 예상 상태와 인프라와 일치하는지 확인하기 위해 테라폼 계획을 검토하세요.\n- 구성을 적용하여 테라폼 상태를 업데이트하세요.\n\n<div class=\"content-ad\"></div>\n\n## 가져와야 할 기존 인프라 확인\n\n이미 두 개의 GCE 인스턴스가 생성되었습니다. Cloud 콘솔에서 기존 인스턴스 중 하나인 tf-instance-1을 확인하세요. 우리는 다음을 검색하려고 합니다:\n\n- 네트워크\n- 머신 유형\n- 디스크\n\n다음으로, 우리는 main.tf에 우리의 인스턴스 모듈을 두 번 호출해야 합니다. 이 두 호출은 빈 정의를 포함할 것이므로 가져올 수 있습니다.\n\n<div class=\"content-ad\"></div>\n\n```md\nmodule \"tf_instance_1\" {\n  source        = \"./modules/instances\"\n  instance_name = \"tf-instance-1\"\n  zone          = var.zone\n  region        = var.region\n}\n\nmodule \"tf_instance_2\" {\n  source        = \"./modules/instances\"\n  instance_name = \"tf-instance-2\"\n  zone          = var.zone\n  region        = var.region\n}\n```\n\n각 모듈 정의에는 고유한 레이블이 있어야 합니다.\n\n이제 초기화해보세요:\n\n```bash\nterraform init\n```\n\n<div class=\"content-ad\"></div>\n\n이제 instances.tf에 모듈 구성을 작성합니다. 우리는 포함해야 할 최소한의 구성 요소를 알려받았습니다:\n\n```js\nresource \"google_compute_instance\" \"instance\" {\n  name         = var.instance_name\n  machine_type = \"기존 인스턴스에서 하드 코딩\"\n  zone         = var.zone\n\n  boot_disk {\n    initialize_params {\n      # image = \"debian-cloud/debian-11\"\n      image = \"기존 인스턴스에서 하드 코딩\"\n    }\n  }\n\n  network_interface {\n    # network = \"default\"\n    network = \"기존 인스턴스에서 하드 코딩\"\n    access_config {\n      // 일시적 공용 IP\n    }\n  }\n\n  metadata_startup_script = <<-EOT\n          #!/bin/bash\n      EOT\n  allow_stopping_for_update = true\n}\n```\n\n인스턴스 모듈의 변수를 전달할 수 있도록 variables.tf를 업데이트하십시오. instance_name을 전달할 수 있도록 합니다:\n\n```js\nvariable \"instance_name\" {\n  description = \"인스턴스의 이름.\"\n  type        = string\n}\n```\n\n<div class=\"content-ad\"></div>\n\n## Terraform State로 기존 인프라 가져오기\n\n```js\nterraform import module.tf_instance_1.google_compute_instance.instance \\\n  projects/$prj/zones/$zone/instances/tf-instance-1\n\nterraform import module.tf_instance_2.google_compute_instance.instance \\\n  projects/$prj/zones/$zone/instances/tf-instance-2\n\n# 가져오기 확인\nterraform show\n```\n\n다음과 같이 가져와야 합니다:\n\n<img src=\"/assets/img/2024-05-20-BuildInfrastructureonGoogleCloudwithTerraformGoogleChallengeLabWalkthrough_1.png\" />\n\n<div class=\"content-ad\"></div>\n\n## 계획 및 적용\n\n이제 우리는 apply를 실행하여 인스턴스를 그 자리에서 업데이트합니다:\n\n```js\nterraform plan\nterraform apply\n```\n\n## 작업 3 — 원격 백엔드 구성\n\n<div class=\"content-ad\"></div>\n\n이건 꽤 쉬워요. 원격 GCS 백엔드에 Terraform 상태를 저장하려고 할 때 실행해야 하는 표준 단계들이에요:\n\n- Terraform을 사용하여 GCS 버킷을 프로비저닝합니다.\n- 새로운 GCS 버킷을 가리키는 백엔드 블록을 추가합니다.\n- Terraform을 다시 초기화하고 로컬 상태 파일에서 원격 백엔드로 상태를 이관합니다.\n\n## GCS Bucket 프로비저닝하기\n\n다음 리소스 정의를 main.tf에 추가하세요:\n\n<div class=\"content-ad\"></div>\n\n위의 코드를 아래와 같이 번역해 드립니다.\n\n```js\n리소스 \"google_storage_bucket\" \"test-bucket-for-state\" {\n  이름        = \"할당 받은 버킷 이름\"\n  위치    = \"US\"\n  uniform_bucket_level_access = true\n\n  force_destroy = true\n}\n```\n\n그리고 다음을 적용하세요:\n\n```js\nterraform apply\n```\n\n## GCS 백엔드 추가하기\n\n<div class=\"content-ad\"></div>\n\nmain.tf 파일을 수정하여 백엔드를 terraform 블록에 포함시키세요:\n\n```js\nterraform {\n  backend \"gcs\" {\n    bucket  = \"제공받은 버킷 이름\"\n    prefix  = \"terraform/state\"\n  }\n}\n```\n\n## 상태 이전\n\n로컬 상태 파일에서 GCS 백엔드로 Terraform 상태를 이전하는 부분입니다.\n\n<div class=\"content-ad\"></div>\n\n```js\nterraform init -migrate-state\n```\n\n상태를 이전하려는 것을 확인하라는 메시지가 표시됩니다:\n\n<img src=\"/assets/img/2024-05-20-BuildInfrastructureonGoogleCloudwithTerraformGoogleChallengeLabWalkthrough_2.png\" />\n\n## 작업 4 — 인프라 수정 및 업데이트\n\n<div class=\"content-ad\"></div>\n\n우리는 machine_type을 포함하는 variables.tf를 업데이트해야합니다:\n\n```js\nvariable \"machine_type\" {\n  description = \"인스턴스의 머신 유형\"\n  type        = string\n  default     = \"e2-standard-2\"\n}\n```\n\n그런 다음, instance.tf를 수정하여 machine_type 매개변수를 허용할 수 있도록 설정해야합니다:\n\n```js\nresource \"google_compute_instance\" \"instance\" {\n  name         = var.instance_name\n  machine_type = var.machine_type\n  zone         = var.zone\n\n  ...\n```\n\n<div class=\"content-ad\"></div>\n\n마지막으로, main.tf를 수정해서 세 번째 인스턴스를 추가해야 합니다. 세 번째 모듈을 호출하여 main.tf에 추가합니다. 이미 기본값을 설정했으므로 machine_type을 전달할 필요가 없습니다.\n\n이제 초기화하고(모듈 인스턴스를 추가했으므로) 적용하세요.\n\n```js\nterraform init\nterraform apply\n```\n\n## 작업 5 — 리소스 파기\n\n<div class=\"content-ad\"></div>\n\n이전에 추가했던 인스턴스를 제거해 보겠습니다. main.tf에서 이 모듈 호출을 제거한 다음 다시 적용하십시오:\n\n```js\nterraform init\nterraform apply\n```\n\n## 작업 6 — 레지스트리에서 모듈 사용하기\n\nGoogle Network Module를 사용하려고 합니다.\n\n<div class=\"content-ad\"></div>\n\n```bash\nmodule \"network\" {\n  source  = \"terraform-google-modules/network/google\"\n  version = \"6.0.0\"\n\n  project_id   = var.project_id\n  network_name = \"Use Supplied VPC Name\"\n  routing_mode = \"GLOBAL\"\n\n  subnets = [\n    {\n      subnet_name           = \"subnet-01\"\n      subnet_ip             = \"10.10.10.0/24\"\n      subnet_region         = var.region\n    },\n    {\n      subnet_name           = \"subnet-02\"\n      subnet_ip             = \"10.10.20.0/24\"\n      subnet_region         = var.region\n    }\n  ]\n}\n```\n\n초기화하고 적용하세요:\n\n```bash\nterraform init\nterraform apply\n```\n\n인스턴스 모듈을 업데이트하여 네트워크 매개변수와 서브넷 매개변수를 사용하도록 하십시오.\n\n\n<div class=\"content-ad\"></div>\n\nvariables.tf:\n\n```js\nvariable \"network\" {\n  description = \"네트워크\"\n  type        = string\n}\n\nvariable \"subnet\" {\n  description = \"서브넷\"\n  type        = string\n}\n```\n\ninstance.tf:\n\n```js\nnetwork_interface {\n  network = var.network\n  subnetwork = var.subnet\n\n  access_config {\n    // 일시적인 공용 IP\n  }\n}\n```\n\n<div class=\"content-ad\"></div>\n\n그럼 이렇게 인스턴스를 생성하도록 main.tf를 업데이트하세요:\n\n```js\nmodule \"tf_instance_1\" {\n  source        = \"./modules/instances\"\n  instance_name = \"tf-instance-1\"\n  zone          = var.zone\n  region        = var.region\n\n  network       = module.network.network_name\n  subnet        = \"subnet-01\"\n}\n\nmodule \"tf_instance_2\" {\n  source        = \"./modules/instances\"\n  instance_name = \"tf-instance-2\"\n  zone          = var.zone\n  region        = var.region\n  network       = module.network.network_name\n  subnet        = \"subnet-02\"\n}\n```\n\n```js\nterraform init\nterraform apply\n```\n\n## 작업 7 — 방화벽 추가\n\n<div class=\"content-ad\"></div>\n\n위의 코드를 Korean으로 번역하였습니다:\n\nmd\nmain.tf을 업데이트 해주세요:\n\n```js\nresource \"google_compute_firewall\" \"default\" {\n  name          = \"tf-firewall\"\n  network       = module.network.network_name\n  direction     = \"INGRESS\"\n  source_ranges = [\"0.0.0.0/0\"]\n\n  allow {\n    protocol = \"tcp\"\n    ports    = [\"80\"]\n  }\n}\n```\n\n그리고 마지막으로 한 번 더 실행해주세요...\n\n```js\nterraform apply\n```\n\n\n<div class=\"content-ad\"></div>\n\n그럼 끝났어요!","ogImage":{"url":"/assets/img/2024-05-20-BuildInfrastructureonGoogleCloudwithTerraformGoogleChallengeLabWalkthrough_0.png"},"coverImage":"/assets/img/2024-05-20-BuildInfrastructureonGoogleCloudwithTerraformGoogleChallengeLabWalkthrough_0.png","tag":["Tech"],"readingTime":10},"content":"<!doctype html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\">\n<meta content=\"width=device-width, initial-scale=1\" name=\"viewport\">\n</head>\n<body>\n<p>구글 클라우드에서 Terraform으로 인프라를 구축하는 코스의 챌린지 랩 워크스루입니다.</p>\n<p>이 랩은 다음을 테스트합니다:</p>\n<ul>\n<li>기존 인프라를 Terraform 구성으로 가져오는 능력.</li>\n<li>직접 Terraform 모듈을 빌드하고 참조하는 것.</li>\n<li>원격 백엔드를 구성에 추가하는 것.</li>\n<li>Terraform 레지스트리에서 모듈을 사용하고 구현하는 것.</li>\n<li>인프라를 다시 프로비저닝하고 파괴하고 업데이트하는 것.</li>\n<li>생성한 리소스 간의 연결성을 테스트하는 것.</li>\n</ul>\n<h1>챌린지 랩 소개</h1>\n<p>Google은 구글 클라우드 스킬즈 부스트(이전 명칭: QwikLabs)라는 온라인 학습 플랫폼을 제공합니다. 이 플랫폼에서는 학습 경로에 맞는 교육 과정을 따르거나 특정 제품 또는 솔루션에 대한 교육 과정을 진행할 수 있습니다.</p>\n<p>이 플랫폼에서의 학습 경험 중 하나는 퀘스트입니다. 퀘스트에 참여하면 안내형 실습 랩을 수행한 후 도전 랩을 완료합니다. 도전 랩은 목표가 명시되지만 목표를 달성하는 방법에 대한 안내가 거의 없는 다른 랩과는 다릅니다.</p>\n<p>제가 가끔 이 도전 랩에 대한 해결 방법을 제공합니다. 목표는 도전 랩을 도와주어서 쉽게 풀어내는 데 도움을 주는 것이 아닙니다! 대신에:</p>\n<ul>\n<li>랩을 완료하는 데 가장 이상적인 경로로 이끄는 것을 보여드립니다.</li>\n<li>랩을 스스로 완료할 수 없는 특정 문제나 장애물을 해결하는 데 도움을 줍니다.</li>\n</ul>\n<p>도움이 필요한 경우, 도전 과제에 대한 도움을 얻으려면 올바른 곳에 오신 것을 환영합니다. 그러나 먼저 퀘스트를 진행하고 직접 랩을 시도한 후에 계속 읽기를 강력히 권장합니다!</p>\n<p>이러한 랩들은 문제 해결에 대해 다양한 방법이 항상 있습니다. 일반적으로 저는 더 반복 가능하고 프로그래밸하게 문제를 해결할 수 있도록 문제를 해결하는 것이 좋습니다. 그러나 물론 클라우드 콘솔도 사용할 수 있습니다.</p>\n<h1>이 랩 개요</h1>\n<p>이 랩에서는 Terraform을 사용하여 Google Cloud에서 인프라를 생성, 배포 및 관리해야 합니다. 또한 일부 관리되지 않은 인스턴스를 구성에 가져와 수정해야 합니다.</p>\n<h1>나의 해결책</h1>\n<p>우리가 이 도전 과제 동안 사용할 몇 가지 변수를 정의하는 것부터 시작해봅시다. 실제 변수는 랩을 시작할 때 제공될 것입니다.</p>\n<pre><code class=\"hljs language-js\">gcloud auth list\n\nregion=&#x3C;지역 입력>\nzone=&#x3C;존 입력>\nprj=&#x3C;프로젝트 <span class=\"hljs-variable constant_\">ID</span> 입력>\n</code></pre>\n<h2>작업 1 — 구성 파일 생성</h2>\n<p>이 폴더 구조를 만들라고 지시받았어요:</p>\n<pre><code class=\"hljs language-js\">main.<span class=\"hljs-property\">tf</span>\nvariables.<span class=\"hljs-property\">tf</span>\nmodules/\n└── instances\n|   ├── instances.<span class=\"hljs-property\">tf</span>\n|   ├── outputs.<span class=\"hljs-property\">tf</span>\n|   └── variables.<span class=\"hljs-property\">tf</span>\n└── storage\n    ├── storage.<span class=\"hljs-property\">tf</span>\n    ├── outputs.<span class=\"hljs-property\">tf</span>\n    └── variables.<span class=\"hljs-property\">tf</span>\n</code></pre>\n<p>이렇게 만들어볼까요:</p>\n<pre><code class=\"hljs language-js\"># 루트 디렉토리에 main.<span class=\"hljs-property\">tf</span>와 variables.<span class=\"hljs-property\">tf</span> 파일 생성\ntouch main.<span class=\"hljs-property\">tf</span> variables.<span class=\"hljs-property\">tf</span>\n\n# main 디렉토리 및 파일 생성\nmkdir -p modules/instances\nmkdir modules/storage\n\n# <span class=\"hljs-string\">'instances'</span> 모듈 디렉토리에 필요한 파일 생성\ntouch modules/instances/instances.<span class=\"hljs-property\">tf</span>\ntouch modules/instances/outputs.<span class=\"hljs-property\">tf</span>\ntouch modules/instances/variables.<span class=\"hljs-property\">tf</span>\n\n# <span class=\"hljs-string\">'storage'</span> 모듈 디렉토리에 필요한 파일 생성\ntouch modules/storage/storage.<span class=\"hljs-property\">tf</span>\ntouch modules/storage/outputs.<span class=\"hljs-property\">tf</span>\ntouch modules/storage/variables.<span class=\"hljs-property\">tf</span>\n</code></pre>\n<p>이제 변수.tf 파일을 업데이트하여 다음 변수들을 포함하도록 합니다:</p>\n<pre><code class=\"hljs language-js\">variable <span class=\"hljs-string\">\"region\"</span> {\n  description = <span class=\"hljs-string\">\"Google Cloud 지역\"</span>\n  type        = string\n  <span class=\"hljs-keyword\">default</span>     = <span class=\"hljs-string\">\"실습에서 제공하는 지역\"</span>\n}\n\nvariable <span class=\"hljs-string\">\"zone\"</span> {\n  description = <span class=\"hljs-string\">\"Google Cloud 존\"</span>\n  type        = string\n  <span class=\"hljs-keyword\">default</span>     = <span class=\"hljs-string\">\"실습에서 제공하는 존\"</span>\n}\n\nvariable <span class=\"hljs-string\">\"project_id\"</span> {\n  description = <span class=\"hljs-string\">\"리소스를 프로비저닝할 프로젝트의 ID\"</span>\n  type        = string\n  <span class=\"hljs-keyword\">default</span>     = <span class=\"hljs-string\">\"귀하의 프로젝트 ID\"</span>\n}\n</code></pre>\n<p>루트 모듈 main.tf를 업데이트하여 Google Cloud Provider를 포함하도록 합니다. Terraform Registry에서 항상 확인할 수 있습니다. 제공자 블록에 세 가지 변수를 모두 포함하도록 요청되었습니다.</p>\n<pre><code class=\"hljs language-js\">terraform {\n  required_providers {\n    google = {\n      version = <span class=\"hljs-string\">\"~> 4.0\"</span>\n    }\n  }\n}\n\nprovider <span class=\"hljs-string\">\"google\"</span> {\n  project     = <span class=\"hljs-keyword\">var</span>.<span class=\"hljs-property\">project_id</span>\n  region      = <span class=\"hljs-keyword\">var</span>.<span class=\"hljs-property\">region</span>\n  zone        = <span class=\"hljs-keyword\">var</span>.<span class=\"hljs-property\">zone</span>\n}\n</code></pre>\n<p>이제 테라폼을 초기화해야 합니다. 따라서 다음 명령을 실행하세요:</p>\n<pre><code class=\"hljs language-js\">terraform init\n</code></pre>\n<h2>작업 2 — 인프라 가져오기</h2>\n<p>여기서의 목표는 지금까지 테라폼 외부에서 프로비저닝된 인프라를 테라폼 제어 아래로 가져오는 것입니다.</p>\n<p>테라폼 가져오기 워크플로우를 사용할 거에요:</p>\n<p><img src=\"/assets/img/2024-05-20-BuildInfrastructureonGoogleCloudwithTerraformGoogleChallengeLabWalkthrough_0.png\" alt=\"이미지\"></p>\n<p>이것들은 가져오기 단계들이에요:</p>\n<ul>\n<li>가져올 기존 인프라를 식별하세요.</li>\n<li>인프라를 테라폼 상태에 가져오세요.</li>\n<li>해당 인프라와 일치하는 테라폼 구성을 작성하세요.</li>\n<li>구성이 예상 상태와 인프라와 일치하는지 확인하기 위해 테라폼 계획을 검토하세요.</li>\n<li>구성을 적용하여 테라폼 상태를 업데이트하세요.</li>\n</ul>\n<h2>가져와야 할 기존 인프라 확인</h2>\n<p>이미 두 개의 GCE 인스턴스가 생성되었습니다. Cloud 콘솔에서 기존 인스턴스 중 하나인 tf-instance-1을 확인하세요. 우리는 다음을 검색하려고 합니다:</p>\n<ul>\n<li>네트워크</li>\n<li>머신 유형</li>\n<li>디스크</li>\n</ul>\n<p>다음으로, 우리는 main.tf에 우리의 인스턴스 모듈을 두 번 호출해야 합니다. 이 두 호출은 빈 정의를 포함할 것이므로 가져올 수 있습니다.</p>\n<pre><code class=\"hljs language-md\">module \"tf<span class=\"hljs-emphasis\">_instance_</span>1\" {\n  source        = \"./modules/instances\"\n  instance<span class=\"hljs-emphasis\">_name = \"tf-instance-1\"\n  zone          = var.zone\n  region        = var.region\n}\n\nmodule \"tf_</span>instance<span class=\"hljs-emphasis\">_2\" {\n  source        = \"./modules/instances\"\n  instance_</span>name = \"tf-instance-2\"\n  zone          = var.zone\n  region        = var.region\n}\n</code></pre>\n<p>각 모듈 정의에는 고유한 레이블이 있어야 합니다.</p>\n<p>이제 초기화해보세요:</p>\n<pre><code class=\"hljs language-bash\">terraform init\n</code></pre>\n<p>이제 instances.tf에 모듈 구성을 작성합니다. 우리는 포함해야 할 최소한의 구성 요소를 알려받았습니다:</p>\n<pre><code class=\"hljs language-js\">resource <span class=\"hljs-string\">\"google_compute_instance\"</span> <span class=\"hljs-string\">\"instance\"</span> {\n  name         = <span class=\"hljs-keyword\">var</span>.<span class=\"hljs-property\">instance_name</span>\n  machine_type = <span class=\"hljs-string\">\"기존 인스턴스에서 하드 코딩\"</span>\n  zone         = <span class=\"hljs-keyword\">var</span>.<span class=\"hljs-property\">zone</span>\n\n  boot_disk {\n    initialize_params {\n      # image = <span class=\"hljs-string\">\"debian-cloud/debian-11\"</span>\n      image = <span class=\"hljs-string\">\"기존 인스턴스에서 하드 코딩\"</span>\n    }\n  }\n\n  network_interface {\n    # network = <span class=\"hljs-string\">\"default\"</span>\n    network = <span class=\"hljs-string\">\"기존 인스턴스에서 하드 코딩\"</span>\n    access_config {\n      <span class=\"hljs-comment\">// 일시적 공용 IP</span>\n    }\n  }\n\n  metadata_startup_script = &#x3C;&#x3C;-<span class=\"hljs-variable constant_\">EOT</span>\n          #!<span class=\"hljs-regexp\">/bin/</span>bash\n      <span class=\"hljs-variable constant_\">EOT</span>\n  allow_stopping_for_update = <span class=\"hljs-literal\">true</span>\n}\n</code></pre>\n<p>인스턴스 모듈의 변수를 전달할 수 있도록 variables.tf를 업데이트하십시오. instance_name을 전달할 수 있도록 합니다:</p>\n<pre><code class=\"hljs language-js\">variable <span class=\"hljs-string\">\"instance_name\"</span> {\n  description = <span class=\"hljs-string\">\"인스턴스의 이름.\"</span>\n  type        = string\n}\n</code></pre>\n<h2>Terraform State로 기존 인프라 가져오기</h2>\n<pre><code class=\"hljs language-js\">terraform <span class=\"hljs-keyword\">import</span> <span class=\"hljs-variable language_\">module</span>.<span class=\"hljs-property\">tf_instance_1</span>.<span class=\"hljs-property\">google_compute_instance</span>.<span class=\"hljs-property\">instance</span> \\\n  projects/$prj/zones/$zone/instances/tf-instance-<span class=\"hljs-number\">1</span>\n\nterraform <span class=\"hljs-keyword\">import</span> <span class=\"hljs-variable language_\">module</span>.<span class=\"hljs-property\">tf_instance_2</span>.<span class=\"hljs-property\">google_compute_instance</span>.<span class=\"hljs-property\">instance</span> \\\n  projects/$prj/zones/$zone/instances/tf-instance-<span class=\"hljs-number\">2</span>\n\n# 가져오기 확인\nterraform show\n</code></pre>\n<p>다음과 같이 가져와야 합니다:</p>\n<h2>계획 및 적용</h2>\n<p>이제 우리는 apply를 실행하여 인스턴스를 그 자리에서 업데이트합니다:</p>\n<pre><code class=\"hljs language-js\">terraform plan\nterraform apply\n</code></pre>\n<h2>작업 3 — 원격 백엔드 구성</h2>\n<p>이건 꽤 쉬워요. 원격 GCS 백엔드에 Terraform 상태를 저장하려고 할 때 실행해야 하는 표준 단계들이에요:</p>\n<ul>\n<li>Terraform을 사용하여 GCS 버킷을 프로비저닝합니다.</li>\n<li>새로운 GCS 버킷을 가리키는 백엔드 블록을 추가합니다.</li>\n<li>Terraform을 다시 초기화하고 로컬 상태 파일에서 원격 백엔드로 상태를 이관합니다.</li>\n</ul>\n<h2>GCS Bucket 프로비저닝하기</h2>\n<p>다음 리소스 정의를 main.tf에 추가하세요:</p>\n<p>위의 코드를 아래와 같이 번역해 드립니다.</p>\n<pre><code class=\"hljs language-js\">리소스 <span class=\"hljs-string\">\"google_storage_bucket\"</span> <span class=\"hljs-string\">\"test-bucket-for-state\"</span> {\n  이름        = <span class=\"hljs-string\">\"할당 받은 버킷 이름\"</span>\n  위치    = <span class=\"hljs-string\">\"US\"</span>\n  uniform_bucket_level_access = <span class=\"hljs-literal\">true</span>\n\n  force_destroy = <span class=\"hljs-literal\">true</span>\n}\n</code></pre>\n<p>그리고 다음을 적용하세요:</p>\n<pre><code class=\"hljs language-js\">terraform apply\n</code></pre>\n<h2>GCS 백엔드 추가하기</h2>\n<p>main.tf 파일을 수정하여 백엔드를 terraform 블록에 포함시키세요:</p>\n<pre><code class=\"hljs language-js\">terraform {\n  backend <span class=\"hljs-string\">\"gcs\"</span> {\n    bucket  = <span class=\"hljs-string\">\"제공받은 버킷 이름\"</span>\n    prefix  = <span class=\"hljs-string\">\"terraform/state\"</span>\n  }\n}\n</code></pre>\n<h2>상태 이전</h2>\n<p>로컬 상태 파일에서 GCS 백엔드로 Terraform 상태를 이전하는 부분입니다.</p>\n<pre><code class=\"hljs language-js\">terraform init -migrate-state\n</code></pre>\n<p>상태를 이전하려는 것을 확인하라는 메시지가 표시됩니다:</p>\n<h2>작업 4 — 인프라 수정 및 업데이트</h2>\n<p>우리는 machine_type을 포함하는 variables.tf를 업데이트해야합니다:</p>\n<pre><code class=\"hljs language-js\">variable <span class=\"hljs-string\">\"machine_type\"</span> {\n  description = <span class=\"hljs-string\">\"인스턴스의 머신 유형\"</span>\n  type        = string\n  <span class=\"hljs-keyword\">default</span>     = <span class=\"hljs-string\">\"e2-standard-2\"</span>\n}\n</code></pre>\n<p>그런 다음, instance.tf를 수정하여 machine_type 매개변수를 허용할 수 있도록 설정해야합니다:</p>\n<pre><code class=\"hljs language-js\">resource <span class=\"hljs-string\">\"google_compute_instance\"</span> <span class=\"hljs-string\">\"instance\"</span> {\n  name         = <span class=\"hljs-keyword\">var</span>.<span class=\"hljs-property\">instance_name</span>\n  machine_type = <span class=\"hljs-keyword\">var</span>.<span class=\"hljs-property\">machine_type</span>\n  zone         = <span class=\"hljs-keyword\">var</span>.<span class=\"hljs-property\">zone</span>\n\n  ...\n</code></pre>\n<p>마지막으로, main.tf를 수정해서 세 번째 인스턴스를 추가해야 합니다. 세 번째 모듈을 호출하여 main.tf에 추가합니다. 이미 기본값을 설정했으므로 machine_type을 전달할 필요가 없습니다.</p>\n<p>이제 초기화하고(모듈 인스턴스를 추가했으므로) 적용하세요.</p>\n<pre><code class=\"hljs language-js\">terraform init\nterraform apply\n</code></pre>\n<h2>작업 5 — 리소스 파기</h2>\n<p>이전에 추가했던 인스턴스를 제거해 보겠습니다. main.tf에서 이 모듈 호출을 제거한 다음 다시 적용하십시오:</p>\n<pre><code class=\"hljs language-js\">terraform init\nterraform apply\n</code></pre>\n<h2>작업 6 — 레지스트리에서 모듈 사용하기</h2>\n<p>Google Network Module를 사용하려고 합니다.</p>\n<pre><code class=\"hljs language-bash\">module <span class=\"hljs-string\">\"network\"</span> {\n  <span class=\"hljs-built_in\">source</span>  = <span class=\"hljs-string\">\"terraform-google-modules/network/google\"</span>\n  version = <span class=\"hljs-string\">\"6.0.0\"</span>\n\n  project_id   = var.project_id\n  network_name = <span class=\"hljs-string\">\"Use Supplied VPC Name\"</span>\n  routing_mode = <span class=\"hljs-string\">\"GLOBAL\"</span>\n\n  subnets = [\n    {\n      subnet_name           = <span class=\"hljs-string\">\"subnet-01\"</span>\n      subnet_ip             = <span class=\"hljs-string\">\"10.10.10.0/24\"</span>\n      subnet_region         = var.region\n    },\n    {\n      subnet_name           = <span class=\"hljs-string\">\"subnet-02\"</span>\n      subnet_ip             = <span class=\"hljs-string\">\"10.10.20.0/24\"</span>\n      subnet_region         = var.region\n    }\n  ]\n}\n</code></pre>\n<p>초기화하고 적용하세요:</p>\n<pre><code class=\"hljs language-bash\">terraform init\nterraform apply\n</code></pre>\n<p>인스턴스 모듈을 업데이트하여 네트워크 매개변수와 서브넷 매개변수를 사용하도록 하십시오.</p>\n<p>variables.tf:</p>\n<pre><code class=\"hljs language-js\">variable <span class=\"hljs-string\">\"network\"</span> {\n  description = <span class=\"hljs-string\">\"네트워크\"</span>\n  type        = string\n}\n\nvariable <span class=\"hljs-string\">\"subnet\"</span> {\n  description = <span class=\"hljs-string\">\"서브넷\"</span>\n  type        = string\n}\n</code></pre>\n<p>instance.tf:</p>\n<pre><code class=\"hljs language-js\">network_interface {\n  network = <span class=\"hljs-keyword\">var</span>.<span class=\"hljs-property\">network</span>\n  subnetwork = <span class=\"hljs-keyword\">var</span>.<span class=\"hljs-property\">subnet</span>\n\n  access_config {\n    <span class=\"hljs-comment\">// 일시적인 공용 IP</span>\n  }\n}\n</code></pre>\n<p>그럼 이렇게 인스턴스를 생성하도록 main.tf를 업데이트하세요:</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-variable language_\">module</span> <span class=\"hljs-string\">\"tf_instance_1\"</span> {\n  source        = <span class=\"hljs-string\">\"./modules/instances\"</span>\n  instance_name = <span class=\"hljs-string\">\"tf-instance-1\"</span>\n  zone          = <span class=\"hljs-keyword\">var</span>.<span class=\"hljs-property\">zone</span>\n  region        = <span class=\"hljs-keyword\">var</span>.<span class=\"hljs-property\">region</span>\n\n  network       = <span class=\"hljs-variable language_\">module</span>.<span class=\"hljs-property\">network</span>.<span class=\"hljs-property\">network_name</span>\n  subnet        = <span class=\"hljs-string\">\"subnet-01\"</span>\n}\n\n<span class=\"hljs-variable language_\">module</span> <span class=\"hljs-string\">\"tf_instance_2\"</span> {\n  source        = <span class=\"hljs-string\">\"./modules/instances\"</span>\n  instance_name = <span class=\"hljs-string\">\"tf-instance-2\"</span>\n  zone          = <span class=\"hljs-keyword\">var</span>.<span class=\"hljs-property\">zone</span>\n  region        = <span class=\"hljs-keyword\">var</span>.<span class=\"hljs-property\">region</span>\n  network       = <span class=\"hljs-variable language_\">module</span>.<span class=\"hljs-property\">network</span>.<span class=\"hljs-property\">network_name</span>\n  subnet        = <span class=\"hljs-string\">\"subnet-02\"</span>\n}\n</code></pre>\n<pre><code class=\"hljs language-js\">terraform init\nterraform apply\n</code></pre>\n<h2>작업 7 — 방화벽 추가</h2>\n<p>위의 코드를 Korean으로 번역하였습니다:</p>\n<p>md\nmain.tf을 업데이트 해주세요:</p>\n<pre><code class=\"hljs language-js\">resource <span class=\"hljs-string\">\"google_compute_firewall\"</span> <span class=\"hljs-string\">\"default\"</span> {\n  name          = <span class=\"hljs-string\">\"tf-firewall\"</span>\n  network       = <span class=\"hljs-variable language_\">module</span>.<span class=\"hljs-property\">network</span>.<span class=\"hljs-property\">network_name</span>\n  direction     = <span class=\"hljs-string\">\"INGRESS\"</span>\n  source_ranges = [<span class=\"hljs-string\">\"0.0.0.0/0\"</span>]\n\n  allow {\n    protocol = <span class=\"hljs-string\">\"tcp\"</span>\n    ports    = [<span class=\"hljs-string\">\"80\"</span>]\n  }\n}\n</code></pre>\n<p>그리고 마지막으로 한 번 더 실행해주세요...</p>\n<pre><code class=\"hljs language-js\">terraform apply\n</code></pre>\n<p>그럼 끝났어요!</p>\n</body>\n</html>\n"},"__N_SSG":true}