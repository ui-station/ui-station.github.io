{"pageProps":{"post":{"title":"S3 ì´ë²¤íŠ¸ ì•Œë¦¼ì„ ì‚¬ìš©í•˜ì—¬ ì¸ë„¤ì¼ ìƒì„±í•˜ê¸°","description":"","date":"2024-05-17 18:32","slug":"2024-05-17-UseS3eventnotificationstogeneratethumbnails","content":"\n\n## ì´ë²¤íŠ¸ ê¸°ë°˜ ì„œë²„ë¦¬ìŠ¤ ì•„í‚¤í…ì²˜\n\n![ì´ë¯¸ì§€](/assets/img/2024-05-17-UseS3eventnotificationstogeneratethumbnails_0.png)\n\nì•ˆë…•í•˜ì„¸ìš”!\n\nì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ íŒŒì¼ì„ í´ë¼ìš°ë“œì— ì €ì¥í•˜ëŠ” ê²ƒì€ íŒŒì¼ ì§€ì†ì„±ì˜ í•œ ë°©ë²•ìœ¼ë¡œ ë§¤ìš° ì¼ë°˜ì ì…ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì–´ë””ì—ì„œ ì–´ë–»ê²Œ ì‚¬ìš©ë ì§€ì— ëŒ€í•œ ë§ì€ ìœ ì—°ì„±ì„ ì œê³µí•©ë‹ˆë‹¤.\n\n<div class=\"content-ad\"></div>\n\nAWSëŠ” ê°ì²´ë¥¼ ì €ì¥í•  ìˆ˜ ìˆëŠ” ì˜µì…˜ìœ¼ë¡œ ê´€ë¦¬í˜• ì„œë¹„ìŠ¤ S3 (Simple Storage Service)ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì´ ì„œë¹„ìŠ¤ëŠ” ë†’ì€ ê°€ìš©ì„±, í™•ì¥ì„± ë° ì„±ëŠ¥ì„ ê°–ì¶”ê³  ìˆìŠµë‹ˆë‹¤. ì£¼ë¡œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì €ì¥ ì„œë¹„ìŠ¤ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.\n\nS3ëŠ” ë²„í‚· ì•ˆì—ì„œ ê°ì²´ ì‘ì—…ì— ëŒ€í•œ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ë„ ì œê³µí•©ë‹ˆë‹¤. ì´ëŠ” ê°ì²´ ìƒì„±, ì—…ë°ì´íŠ¸, ì´ë™, ì‚­ì œ ë“±ì˜ ì‘ì—…ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ S3 ì´ë²¤íŠ¸ ì•Œë¦¼ì´ë¼ê³  í•©ë‹ˆë‹¤.\n\nì´ ë¬¸ì„œì—ì„œëŠ” ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•  ë•Œë§ˆë‹¤ í•´ë‹¹ ì´ë¯¸ì§€ì— ëŒ€í•œ ì„¬ë„¤ì¼ì„ ìƒì„±í•˜ëŠ” ì„œë²„ë¦¬ìŠ¤ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.\n\nìš°ë¦¬ëŠ” ì´ë²¤íŠ¸ ì•Œë¦¼ì„ ìˆ˜ì‹ í•˜ê³  ì„¬ë„¤ì¼ì„ ìƒì„±í•˜ëŠ” Goë¡œ ì‘ì„±ëœ ëŒë‹¤ í•¨ìˆ˜ë¥¼ ê°€ì§ˆ ê²ƒì…ë‹ˆë‹¤.\n\n<div class=\"content-ad\"></div>\n\ní•´ë³´ìêµ¬ìš”!\n\n# ìš”êµ¬ ì‚¬í•­\n\n- AWS ê³„ì •\n- ì¢‹ì•„í•˜ëŠ” ì½”ë“œ í¸ì§‘ê¸° (ì €ëŠ” Visual Studio Codeë¥¼ ì‚¬ìš©í•  ì˜ˆì •ì…ë‹ˆë‹¤)\n- GitHub ê³„ì •\n\n# ì•„í‚¤í…ì²˜\n\n<div class=\"content-ad\"></div>\n\n<img src=\"/assets/img/2024-05-17-UseS3eventnotificationstogeneratethumbnails_1.png\" />\n\në²„í‚·ì„ êµ¬ì„±í•˜ì—¬ ê°ì²´ ì´ë²¤íŠ¸ë¥¼ SNS í† í”½ìœ¼ë¡œ ë³´ë‚´ê³  í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ìƒì„±í•œ ì¸ë„¤ì¼ì„ S3 ë²„í‚·ì— ì—…ë¡œë“œí•  ëŒë‹¤ë¡œ ì „ì†¡í•  ê²ƒì…ë‹ˆë‹¤.\n\nS3 ë²„í‚· ì´ë²¤íŠ¸ì— ëŒë‹¤ë¥¼ ì§ì ‘ ëŒ€ìƒìœ¼ë¡œ ì§€ì •í•˜ì§€ ì•Šì„ ê²ƒì…ë‹ˆë‹¤. ì´ìœ ëŠ” ê° ì´ë²¤íŠ¸ ì•Œë¦¼ì— ëŒ€í•´ í•˜ë‚˜ì˜ ëŒ€ìƒ ìœ í˜•ë§Œ ì§€ì •í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. SNS í† í”½ì„ ëŒ€ìƒìœ¼ë¡œ ì‚¬ìš©í•˜ë©´ SQS ëŒ€ê¸°ì—´, ì´ë©”ì¼, ì „í™” ì•Œë¦¼ ë° SNSê°€ ì§€ì›í•˜ëŠ” ê¸°íƒ€ ì—¬ëŸ¬ ëŒ€ìƒìœ¼ë¡œ ì´ë²¤íŠ¸ë¥¼ ì „íŒŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n# Terraformì„ ì‚¬ìš©í•˜ì—¬ ì¸í”„ë¼ êµ¬ì„±í•˜ê¸°\n\n<div class=\"content-ad\"></div>\n\n## ì´ë¯¸ì§€ S3 ë²„í‚·\n\nì‹œì‘í•˜ë ¤ë©´ ìš°ë¦¬ì˜ í…Œë¼í¼ í´ë”ë¥¼ ì„¤ì •í•˜ê¸° ìœ„í•´ í”„ë¡œì íŠ¸ì˜ ë£¨íŠ¸ ë ˆë²¨ì— iacë¼ëŠ” í´ë”ë¥¼ ë§Œë“¤ì–´ ì£¼ì„¸ìš”. ê·¸ ì•ˆì— providers.tfë¼ëŠ” íŒŒì¼ì„ ìƒì„±í•´ AWS í”„ë¡œë°”ì´ë”ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆë„ë¡ ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”:\n\n```js\nterraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.0\"\n    }\n  }\n}\n\n// Regionì€ AWS_REGION í™˜ê²½ ë³€ìˆ˜ì—ì„œ ì„¤ì •ë©ë‹ˆë‹¤\nprovider \"aws\" {\n}\n```\n\në§Œì•½ í…Œë¼í¼ì´ ì¸í”„ë¼ ìƒíƒœë¥¼ ì¶”ì í•˜ë„ë¡ í•˜ë ¤ë©´, AWSì—ì„œ S3 ë²„í‚·ì„ ìƒì„±í•˜ê³  ìƒíƒœ ë°±ì—”ë“œë¡œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ì½”ë“œì—ì„œì²˜ëŸ¼ í•˜ì‹œë©´ ë©ë‹ˆë‹¤:\n\n<div class=\"content-ad\"></div>\n\n```js\nterraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.0\"\n    }\n  }\n\n  backend \"s3\" {\n    bucket = \"terraform-medium-api-notification\" // ì—¬ê¸°ê°€ ìƒíƒœ ë²„í‚·ì…ë‹ˆë‹¤\n    key    = \"thumbnail-generator/state\"\n  }\n}\n\n// AWS_REGION í™˜ê²½ ë³€ìˆ˜ì—ì„œ ì§€ì—­ ì„¤ì •ë¨\nprovider \"aws\" {\n}\n```\n\nì´ì œ ì´ë¯¸ì§€ë¥¼ í˜¸ìŠ¤íŒ…í•˜ëŠ” S3 ë²„í‚·ì„ ë§Œë“¤ì–´ ë´…ì‹œë‹¤.\n\niac í´ë”ì— s3.tfë¼ëŠ” íŒŒì¼ì„ ë§Œë“¤ê³  ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”:\n\n```js\nresource \"aws_s3_bucket\" \"my-app-images\" {\n  bucket = \"my-super-app-images\" // ë²„í‚·ì— ê³ ìœ í•œ ì´ë¦„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”\n}\n\nresource \"aws_s3_object\" \"images_folder\" {\n  bucket = aws_s3_bucket.my-app-images.bucket\n  key    = \"images/\"\n}\n\nresource \"aws_s3_object\" \"thumbnails_folder\" {\n  bucket = aws_s3_bucket.my-app-images.bucket\n  key    = \"thumbnails/\"\n}\n```\n\n<div class=\"content-ad\"></div>\n\në²„í‚· ì†ì„±ì—ì„œëŠ” ë²„í‚·ì— ê³ ìœ í•œ ì´ë¦„ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. ì™œëƒí•˜ë©´ S3 ë²„í‚· ì´ë¦„ì€ ëª¨ë“  AWS ì „ì—­ì—ì„œ ê³ ìœ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì´ë¦„ì„ ì œê³µí•˜ì§€ ì•Šìœ¼ë ¤ë©´ ë¹„ì›Œë‘ê³  AWSê°€ ê³ ìœ í•œ ë²„í‚· ì´ë¦„ì„ í• ë‹¹í•´ ì¤„ ê²ƒì…ë‹ˆë‹¤.\n\nì´ ì½”ë“œëŠ” ì´ë¯¸ì§€/ ë° ì¸ë„¤ì¼/ ë‘ ê°œì˜ í´ë”ê°€ ìˆëŠ” S3 ë²„í‚·ì„ ìƒì„±í•©ë‹ˆë‹¤. ì´ í´ë”ë“¤ì€ íŒŒì¼ì„ ì €ì¥í•˜ëŠ” ë° ì‚¬ìš©í•  ê²ƒì…ë‹ˆë‹¤.\n\n## SNSë¥¼ ì‚¬ìš©í•œ ë©”ì‹œì§•\n\nì´ì œ ì•Œë¦¼ ì£¼ì œì™€ ë©”ì‹œì§€ ëŒ€ê¸°ì—´ì„ ì„¤ì •í•´ ë´…ì‹œë‹¤.\n\n<div class=\"content-ad\"></div>\n\n```yaml\n# messaging.tf\n\nresource \"aws_sns_topic\" \"topic\" {\n  name   = \"image-events\"\n}\n```\n\n```yaml\n# variables.tf\n\nvariable \"region\" {\n  description = \"Default region of your resources\"\n  type        = string\n  default     = \"eu-central-1\" # Set as your default region here\n}\n\nvariable \"account_id\" {\n  description = \"The ID of the default AWS account\"\n  type        = string\n}\n```\n\n<div class=\"content-ad\"></div>\n\nê·¸ë¦¬ê³  variables.tfvarsë¼ëŠ” ë˜ ë‹¤ë¥¸ íŒŒì¼ì„ ë§Œë“¤ì–´ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”:\n\n```js\nregion = \"eu-central-1\" // ì›í•˜ëŠ” ì§€ì—­ì„ ì„¤ì •í•˜ì„¸ìš”\n```\n\në‚˜ì¤‘ì— í…Œë¼í¼ ëª…ë ¹ì–´ì— ì „ë‹¬í•  account_idëŠ” ë‚˜ì¤‘ì— ì¸ìˆ˜ë¡œ ì „ë‹¬í•  ê²ƒì…ë‹ˆë‹¤.\n\n## S3 ì´ë²¤íŠ¸ ì•Œë¦¼\n\n<div class=\"content-ad\"></div>\n\nì´ì œ S3ì— ëŒ€í•œ ì´ë²¤íŠ¸ ì•Œë¦¼ì„ ì„¤ì •í•´ ë´…ì‹œë‹¤.\n\ns3.tf íŒŒì¼ì— ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì—¬ ë²„í‚· ì•Œë¦¼ì„ ì„¤ì •í•˜ì„¸ìš”:\n\n```js\nresource \"aws_s3_bucket_notification\" \"images_put_notification\" {\n  bucket = aws_s3_bucket.my-app-images.id\n  topic {\n    topic_arn = aws_sns_topic.topic.arn\n    filter_prefix = \"images/\"\n    events = [\"s3:ObjectCreated:*\"]\n  }\n}\n```\n\nì´ë¥¼ í™œì„±í™”í•˜ë ¤ë©´ S3 ë²„í‚·ì´ í•´ë‹¹ topicìœ¼ë¡œ ì•Œë¦¼ì„ ë°œí–‰í•  ìˆ˜ ìˆë„ë¡ SNS topicì— ì •ì±…ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤. messaging.tf íŒŒì¼ë¡œ ì´ë™í•˜ì—¬ ë‹¤ìŒ ì •ì±…ì„ ì¶”ê°€í•˜ì„¸ìš”:\n\n<div class=\"content-ad\"></div>\n\n```js\në¦¬ì†ŒìŠ¤ \"aws_sns_topic\" \"topic\" {\n  name   = \"image-events\"\n  policy = data.aws_iam_policy_document.sns-topic-policy.json\n}\n\në°ì´í„° \"aws_iam_policy_document\" \"sns-topic-policy\" {\n  policy_id = \"arn:aws:sns:${var.region}:${var.account_id}:image-events/SNSS3NotificationPolicy\"\n  statement {\n    sid    = \"s3-allow-send-messages\"\n    effect = \"Allow\"\n    principals {\n      type        = \"Service\"\n      identifiers = [\"s3.amazonaws.com\"]\n    }\n    actions = [\n      \"SNS:Publish\",\n    ]\n    resources = [\n      \"arn:aws:sns:${var.region}:${var.account_id}:image-events\",\n    ]\n    condition {\n      test     = \"ArnEquals\"\n      variable = \"aws:SourceArn\"\n      values = [\n        aws_s3_bucket.my-app-images.arn\n      ]\n    }\n  }\n}\n```\n\nì—¬ê¸°ì„œëŠ” sns-topic-policy ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•˜ê³  í•´ë‹¹ ë¦¬ì†ŒìŠ¤ë¥¼ policy ì†ì„±ì— ì „ë‹¬í•˜ëŠ” topic ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.\n\n## ê¸°ë³¸ ëŒë‹¤ ì¶”ê°€í•˜ê¸°\n\nì´ì œ ëŒë‹¤ì˜ ê¸°ë°˜ ì¸í”„ë¼ë¥¼ ì¶”ê°€í•˜ê¸°ë§Œ ë‚¨ì•˜ìŠµë‹ˆë‹¤. ì´í›„ì— ì½”ë“œë¥¼ ì¶”ê°€í•  ê¸°ë³¸ ëŒë‹¤ë¥¼ ì„¤ì •í•  ê²ƒì…ë‹ˆë‹¤. Go ì–¸ì–´ë¡œ ì½”ë“œë¥¼ ì‘ì„±í•  ì˜ˆì •ì…ë‹ˆë‹¤.\n \n\n<div class=\"content-ad\"></div>\n\në¨¼ì €, ëŒë‹¤ í•¨ìˆ˜ë¥¼ ì´ˆê¸°í™”í•  ê¸°ë³¸ ì½”ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤. ê·¸ë˜ì„œ iac í´ë”ì— lambda_init_codeë¼ëŠ” í´ë”ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”. ì—¬ê¸°ì„œ ì†ŒìŠ¤ ì½”ë“œë¥¼ ê°€ì ¸ì™€ì„œ ë©”ì¸ ì»´íŒŒì¼ëœ íŒŒì¼ì„ ì§ì ‘ ì‚¬ìš©í•˜ê±°ë‚˜ README.md íŒŒì¼ì˜ ì§€ì‹œì— ë”°ë¼ ìƒˆë¡œìš´ ì‹¤í–‰ ê°€ëŠ¥ íŒŒì¼ì„ ì»´íŒŒì¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\nì´ì œ ìƒˆ íŒŒì¼ lambdas.tfë¥¼ ìƒì„±í•˜ê³  ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì—¬ ëŒë‹¤ ì¸í”„ë¼ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:\n\n```js\nresource \"aws_iam_role\" \"iam_for_lambda\" {\n  name               = \"thumbnail-generator-lambda-role\"\n  assume_role_policy = data.aws_iam_policy_document.assume_role.json\n  inline_policy {\n    name   = \"DefaultPolicy\"\n    policy = data.aws_iam_policy_document.lambda_role_policies.json\n  }\n}\nresource \"aws_lambda_function\" \"lambda\" {\n  filename      = data.archive_file.lambda.output_path\n  function_name = \"thumbnail-generator\"\n  role          = aws_iam_role.iam_for_lambda.arn\n  handler       = \"main\"\n  runtime       = \"go1.x\"\n  timeout       = 15\n}\n\ndata \"archive_file\" \"lambda\" {\n  type        = \"zip\"\n  source_file = \"./lambda_init_code/main\"\n  output_path = \"thumbnail_generator_lambda_function_payload.zip\"\n}\n\ndata \"aws_iam_policy_document\" \"assume_role\" {\n  statement {\n    effect = \"Allow\"\n    principals {\n      type        = \"Service\"\n      identifiers = [\"lambda.amazonaws.com\"]\n    }\n    actions = [\"sts:AssumeRole\"]\n  }\n}\n\ndata \"aws_iam_policy_document\" \"lambda_role_policies\" {\n  statement {\n    effect = \"Allow\"\n    actions = [\n      \"logs:CreateLogGroup\",\n      \"logs:CreateLogStream\",\n      \"logs:PutLogEvents\",\n    ]\n    resources = [\"arn:aws:logs:*:*:*\"]\n  }\n}\n```\n\nì´ë ‡ê²Œ í•˜ë©´ ëŸ°íƒ€ì„ìœ¼ë¡œ Goë¥¼ ì‚¬ìš©í•˜ëŠ” ëŒë‹¤ í•¨ìˆ˜ë¥¼ ìƒì„±í•˜ê³  ì—­í• ì„ ë§Œë“¤ë©°, ëŒë‹¤ í•¨ìˆ˜ê°€ ì´ ì—­í• ì„ ê°€ì •í•˜ê³  í´ë¼ìš°ë“œì›Œì¹˜ì— ë¡œê¹…í•  ìˆ˜ ìˆë„ë¡ ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.\n\n<div class=\"content-ad\"></div>\n\në‹¤ìŒìœ¼ë¡œ, ëŒë‹¤ê°€ íŠ¸ë¦¬ê±°ë  ìˆ˜ ìˆë„ë¡ SNS ì£¼ì œì— ëŒ€í•œ êµ¬ë…ì„ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤. lambdas.tf íŒŒì¼ì— ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:\n\n```js\nresource \"aws_sns_topic_subscription\" \"topic_subscription\" {\n  topic_arn = aws_sns_topic.topic.arn\n  protocol  = \"lambda\"\n  endpoint  = aws_lambda_function.lambda.arn\n}\n\nresource \"aws_lambda_permission\" \"apigw_lambda\" {\n  statement_id  = \"AllowExecutionFromSNS\"\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.lambda.arn\n  principal     = \"sns.amazonaws.com\"\n  source_arn    = aws_sns_topic.topic.arn\n}\n```\n\nìµœì¢… lambdas.tf íŒŒì¼ì´ ë‹¤ìŒê³¼ ê°™ì´ ë˜ë„ë¡ ë§Œë“¤ì–´ë³´ì„¸ìš”:\n\n```js\nresource \"aws_iam_role\" \"iam_for_lambda\" {\n  name               = \"thumbnail-generator-lambda-role\"\n  assume_role_policy = data.aws_iam_policy_document.assume_role.json\n  inline_policy {\n    name   = \"DefaultPolicy\"\n    policy = data.aws_iam_policy_document.lambda_role_policies.json\n  }\n}\n\nresource \"aws_lambda_function\" \"lambda\" {\n  filename      = data.archive_file.lambda.output_path\n  function_name = \"thumbnail-generator\"\n  role          = aws_iam_role.iam_for_lambda.arn\n  handler       = \"main\"\n  runtime       = \"go1.x\"\n  timeout       = 15\n}\n\nresource \"aws_sns_topic_subscription\" \"topic_subscription\" {\n  topic_arn = aws_sns_topic.topic.arn\n  protocol  = \"lambda\"\n  endpoint  = aws_lambda_function.lambda.arn\n}\n\nresource \"aws_lambda_permission\" \"apigw_lambda\" {\n  statement_id  = \"AllowExecutionFromSNS\"\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.lambda.arn\n  principal     = \"sns.amazonaws.com\"\n  source_arn    = aws_sns_topic.topic.arn\n}\n\ndata \"archive_file\" \"lambda\" {\n  type        = \"zip\"\n  source_file = \"./lambda_init_code/main\"\n  output_path = \"thumbnail_generator_lambda_function_payload.zip\"\n}\n\ndata \"aws_iam_policy_document\" \"assume_role\" {\n  statement {\n    effect = \"Allow\"\n    principals {\n      type        = \"Service\"\n      identifiers = [\"lambda.amazonaws.com\"]\n    }\n    actions = [\"sts:AssumeRole\"]\n  }\n}\n\ndata \"aws_iam_policy_document\" \"lambda_role_policies\" {\n  statement {\n    effect = \"Allow\"\n    actions = [\n      \"logs:CreateLogGroup\",\n      \"logs:CreateLogStream\",\n      \"logs:PutLogEvents\"\n    ]\n    resources = [\"arn:aws:logs:*:*:*\"]\n  }\n\n  statement {\n    effect = \"Allow\"\n    actions = [\n      \"s3:GetObject\",\n    ]\n    resources = [\n      format(\"%s/%s*\", aws_s3_bucket.my-app-images.arn, aws_s3_object.images_folder.key)\n    ]\n  }\n\n  statement {\n    effect = \"Allow\"\n    actions = [\n      \"s3:PutObject\",\n    ]\n    resources = [\n      format(\"%s/%s*\", aws_s3_bucket.my-app-images.arn, aws_s3_object.thumbnails_folder.key)\n    ]\n  }\n}\n```\n\n<div class=\"content-ad\"></div>\n\nìš°ë¦¬ì˜ SNS í† í”½ì´ ëŒë‹¤ë¥¼ ì´ë²¤íŠ¸ì™€ í•¨ê»˜ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ ê¶Œí•œì„ ë¶€ì—¬í•  ê²ƒì…ë‹ˆë‹¤.\n\nëŒë‹¤ëŠ” 15ì´ˆì˜ ì œí•œ ì‹œê°„ì„ ê°–ê³  ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ê¸°ë³¸ ì œí•œ ì‹œê°„ì´ 3ì´ˆì´ê¸° ë•Œë¬¸ì— S3ë¡œ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ê³  ì—…ë¡œë“œí•˜ëŠ” ì‘ì—…ì€ ì´ë¯¸ì§€ í¬ê¸°ì— ë”°ë¼ 3ì´ˆë³´ë‹¤ ë” ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì´ëŠ” S3 ì‘ì—…ì´ ì¸í„°ë„·ì„ í†µê³¼í•˜ê¸° ë•Œë¬¸ì— ë°œìƒí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¤ê³  ì‹¶ë‹¤ë©´ VPCë¥¼ ìƒì„±í•˜ê³  ëŒë‹¤ì™€ VPC ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë§Œë“¤ì–´ S3 ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì—°ê²°ì´ ì¸í„°ë„·ì´ ì•„ë‹Œ AWS ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ì´ë£¨ì–´ì§€ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n## ì¸í”„ë¼ ë°°í¬í•˜ê¸°\n\nì´ì œ ìš°ë¦¬ê°€ ì½”ë“œë¡œ ì •ì˜í•œ ì¸í”„ë¼ë¥¼ ë°°í¬í•˜ê¸° ìœ„í•´ GitHub ì•¡ì…˜ì„ ì‚¬ìš©í•´ë³´ê² ìŠµë‹ˆë‹¤.\n\n<div class=\"content-ad\"></div>\n\nì½”ë“œì— .github/workflows í´ë”ë¥¼ ë§Œë“¤ê³  deploy-infra.yml íŒŒì¼ì„ ì¶”ê°€í•˜ì—¬ GitHub ì•¡ì…˜ ì›Œí¬í”Œë¡œìš°ë¥¼ ì •ì˜í•˜ì„¸ìš”:\n\n```yml\nname: Deploy Infrastructure\non:\n  push:\n    branches:\n      - main\n    paths:\n      - iac/**/*\n      - .github/workflows/deploy-infra.yml\n\ndefaults:\n  run:\n    working-directory: iac/\n\njobs:\n  terraform:\n    name: 'Terraform'\n    runs-on: ubuntu-latest\n    steps:\n      # GitHub Actions ëŸ¬ë„ˆì— ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒ\n      - name: Checkout\n        uses: actions/checkout@v3\n\n      - name: Configure AWS Credentials Action For GitHub Actions\n        uses: aws-actions/configure-aws-credentials@v1\n        with:\n          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}\n          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}\n          aws-region: eu-central-1\n\n      # ìµœì‹  ë²„ì „ì˜ Terraform CLI ì„¤ì¹˜ ë° Terraform Cloud ì‚¬ìš©ì API í† í°ì„ ì‚¬ìš©í•˜ì—¬ Terraform CLI êµ¬ì„± íŒŒì¼ ì„¤ì •\n      - name: Setup Terraform\n        uses: hashicorp/setup-terraform@v3\n\n      # Terraform ì›Œí‚¹ ë””ë ‰í„°ë¦¬ë¥¼ ì´ˆê¸°í™”í•˜ê³  ì´ˆê¸° íŒŒì¼ì„ ìƒì„±í•˜ê±°ë‚˜ ê¸°ì¡´ íŒŒì¼ì„ ë¡œë“œí•˜ê³  ëª¨ë“ˆ ë‹¤ìš´ë¡œë“œ ë“±ì„ ìˆ˜í–‰\n      - name: Terraform Init\n        run: terraform init\n\n      # ëª¨ë“  Terraform êµ¬ì„± íŒŒì¼ì´ ê·œë²”ì  í˜•ì‹ì„ ì¤€ìˆ˜í•˜ëŠ”ì§€ í™•ì¸\n      - name: Terraform Format\n        run: terraform fmt -check\n\n      # Terraform ì‹¤í–‰ ê³„íš ìƒì„±\n      - name: Terraform Plan\n        run: |\n          terraform plan -out=plan -input=false -var-file=\"variables.tfvars\" -var account_id=${{ secrets.AWS_ACCOUNT_ID }}\n\n      # \"main\"ìœ¼ë¡œ í‘¸ì‹œë˜ë©´ Terraform êµ¬ì„± íŒŒì¼ì— ë”°ë¼ ì¸í”„ë¼ë¥¼ êµ¬ì¶• ë˜ëŠ” ë³€ê²½í•¨\n      # ì°¸ê³ : \"Terraform Cloud\"ì— ëŒ€í•´ \"strict\" ìƒíƒœ ê²€ì‚¬ë¥¼ ì„¤ì •í•˜ëŠ” ê²ƒì´ ê¶Œì¥ë©ë‹ˆë‹¤. ìì„¸í•œ ì •ë³´ëŠ” ì•„ë˜ ë¬¸ì„œë¥¼ ì°¸ì¡°í•˜ì„¸ìš”: https://help.github.com/en/github/administering-a-repository/types-of-required-status-checks\n      - name: Terraform Apply\n        run: terraform apply -auto-approve -input=false plan\n```\n\n- AWS_ACCESS_KEY â€” ìì›ì„ ìƒì„±í•  ê¶Œí•œì´ ìˆëŠ” AWSì˜ ì•¡ì„¸ìŠ¤ í‚¤ì…ë‹ˆë‹¤\n- AWS_SECRET_ACCESS_KEY â€” ì•¡ì„¸ìŠ¤ í‚¤ì™€ ì—°ê²°ëœ AWS ì‹œí¬ë¦¿\n- AWS_ACCOUNT_ID â€” AWS ëŒ€ì‹œë³´ë“œ ì˜¤ë¥¸ìª½ ìƒë‹¨ì— ìˆëŠ” ê³„ì • IDì…ë‹ˆë‹¤\n- YOUR_REGION â€” ì¸í”„ë¼ë¥¼ ë°°í¬í•  ê¸°ë³¸ ì§€ì—­\n\nì´ì œ ì½”ë“œë¥¼ GitHubì— í‘¸ì‹œí•˜ê³  ì›Œí¬í”Œë¡œìš°ê°€ ì™„ë£Œë˜ë©´ ì¸í”„ë¼ê°€ ìƒì„±ë˜ëŠ” ê²ƒì„ í™•ì¸í•´ë³´ì„¸ìš”.\n\n<div class=\"content-ad\"></div>\n\ní…ŒìŠ¤íŠ¸í•˜ë ¤ë©´ ì´ë¯¸ì§€/ í´ë”ì— íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  CloudWatchì—ì„œ ëŒë‹¤ ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\nS3ëŠ” ë‘ ê°œì˜ í´ë”ë¡œ ìƒì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤:\n\n![image](/assets/img/2024-05-17-UseS3eventnotificationstogeneratethumbnails_2.png)\n\nSNSëŠ” êµ¬ë…ì´ ìˆëŠ” ìƒíƒœë¡œ ìƒì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤:\n\n<div class=\"content-ad\"></div>\n\n<img src=\"/assets/img/2024-05-17-UseS3eventnotificationstogeneratethumbnails_3.png\" /> \n\nLambdaë¥¼ SNS íŠ¸ë¦¬ê±°ì™€ í•¨ê»˜ ìƒì„±í•´ì•¼í•©ë‹ˆë‹¤:\n\n<img src=\"/assets/img/2024-05-17-UseS3eventnotificationstogeneratethumbnails_4.png\" />\n\n# Lambda êµ¬í˜„\n\n<div class=\"content-ad\"></div>\n\nì¸í”„ë¼ê°€ ì„¤ì¹˜ë˜ì—ˆìœ¼ë¯€ë¡œ ì¸ë„¤ì¼ ìƒì„±ê¸° ì½”ë“œë¥¼ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.\n\në£¨íŠ¸ ë ˆë²¨ì— srcì´ë¼ëŠ” ìƒˆ í´ë”ë¥¼ ìƒì„±í•˜ê³  ë‹¤ìŒ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ Go ëª¨ë“ˆì„ ì´ˆê¸°í™”í•´ë³´ì„¸ìš”:\n\n```js\ngo mod init example.com/thumbnail-generator\ngo get github.com/aws/aws-lambda-go\ngo get github.com/aws/aws-sdk-go-v2\ngo get github.com/aws/aws-sdk-go-v2/service/s3\ngo get github.com/aws/aws-sdk-go-v2/config\ngo get github.com/disintegration/imaging\n```\n\nì›í•˜ëŠ” ê²½ìš° example.com/thumbnail-generatorë¥¼ ì„ í˜¸í•˜ëŠ” ëª¨ë“ˆ ì´ë¦„ìœ¼ë¡œ êµì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n<div class=\"content-ad\"></div>\n\nì´ì œ main.go íŒŒì¼ì„ ë§Œë“¤ê³  ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”:\n\n```go\npackage main\n\nimport (\n\t\"bytes\"\n\t\"context\"\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"image\"\n\t\"image/png\"\n\t\"io\"\n\t\"log\"\n\t\"strings\"\n\n\t\"github.com/aws/aws-lambda-go/events\"\n\t\"github.com/aws/aws-lambda-go/lambda\"\n\t\"github.com/aws/aws-sdk-go-v2/aws\"\n\t\"github.com/aws/aws-sdk-go-v2/config\"\n\t\"github.com/aws/aws-sdk-go-v2/service/s3\"\n\t\"github.com/disintegration/imaging\"\n)\n\ntype awsClient struct {\n\ts3  s3.Client\n\tctx *context.Context\n}\n\nfunc handleRequest(ctx context.Context, event events.SNSEvent) error {\n\tawsConfig, err := config.LoadDefaultConfig(ctx)\n\n\tif err != nil {\n\t\tlog.Fatalf(\"AWS ê¸°ë³¸ êµ¬ì„±ì„ ë¶ˆëŸ¬ ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤\")\n\t\treturn err\n\t}\n\n\tawsClient := awsClient{s3: *s3.NewFromConfig(awsConfig), ctx: &ctx}\n\n\tfor _, record := range event.Records {\n\t\tvar imageEvent events.S3Event\n\n\t\terr := json.Unmarshal([]byte(record.SNS.Message), &imageEvent)\n\n\t\tif err != nil {\n\t\t\tlog.Fatalf(\"SNS ë©”ì‹œì§€ %sì„ S3 ì´ë²¤íŠ¸ ë ˆì½”ë“œë¡œ ì–¸ë§ˆìƒ¬í•˜ëŠ” ë™ì•ˆ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: %v\", record.SNS.Message, err)\n\t\t\treturn err\n\t\t}\n\n\t\tfor _, imageRecord := range imageEvent.Records {\n\t\t\tbucketName := imageRecord.S3.Bucket.Name\n\t\t\tobjectKey := imageRecord.S3.Object.Key\n\n\t\t\tfile, err := awsClient.downloadFile(bucketName, objectKey)\n\n\t\t\tlog.Printf(\"ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì„±ê³µ\")\n\n\t\t\tif err != nil {\n\t\t\t\tlog.Fatalf(\"ë²„í‚· %sì—ì„œ íŒŒì¼ %sì„ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤\", bucketName, objectKey)\n\t\t\t\treturn err\n\t\t\t}\n\n\t\t\tthumbnail, err := createThumbnail(file)\n\n\t\t\tif err != nil {\n\t\t\t\tlog.Fatalf(\"ë²„í‚· %sì˜ íŒŒì¼ %sì— ëŒ€í•œ ì„¬ë„¤ì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: %v\", bucketName, objectKey, err)\n\t\t\t\treturn err\n\t\t\t}\n\n\t\t\tlog.Printf(\"ì„¬ë„¤ì¼ ìƒì„± ì„±ê³µ\")\n\n\t\t\terr = awsClient.uploadFile(bucketName, objectKey, thumbnail)\n\n\t\t\tlog.Printf(\"ì„¬ë„¤ì¼ ì—…ë¡œë“œ ì„±ê³µ\")\n\n\t\t\tif err != nil {\n\t\t\t\tlog.Fatalf(\"ë²„í‚· %sì— íŒŒì¼ %sì„ thumbnails/ì— ì—…ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤\", bucketName, objectKey)\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\t}\n\n\treturn nil\n}\n\nfunc createThumbnail(reader io.Reader) (*bytes.Buffer, error) {\n\tsrcImage, _, err := image.Decode(reader)\n\n\tif err != nil {\n\t\tlog.Fatalf(\"ì˜¤ë¥˜ë¡œ ì¸í•´ íŒŒì¼ì„ ë””ì½”ë”©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: %v\", err)\n\t\treturn nil, err\n\t}\n\n\t// 80x80 í¬ê¸°ì˜ ì„¬ë„¤ì¼ ìƒì„±\n\tthumbnail := imaging.Thumbnail(srcImage, 80, 80, imaging.Lanczos)\n\n\tvar bufferBytes []byte\n\tbuffer := bytes.NewBuffer(bufferBytes)\n\n\terr = png.Encode(buffer, thumbnail)\n\n\treturn buffer, err\n}\n\nfunc (client *awsClient) downloadFile(bucketName string, objectKey string) (*bytes.Reader, error) {\n\tresult, err := client.s3.GetObject(*client.ctx, &s3.GetObjectInput{\n\t\tBucket: aws.String(bucketName),\n\t\tKey:    aws.String(objectKey),\n\t})\n\n\tif err != nil {\n\t\tlog.Fatalf(\"ê°ì²´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ %v:%v. ì›ì¸: %v\", bucketName, objectKey, err)\n\t\treturn nil, err\n\t}\n\n\tdefer result.Body.Close()\n\n\tbody, err := io.ReadAll(result.Body)\n\n\tif err != nil {\n\t\tlog.Fatalf(\"íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ. ì˜¤ë¥˜: %s\", err)\n\t\treturn nil, err\n\t}\n\n\tfile := bytes.NewReader(body)\n\n\treturn file, err\n}\n\nfunc (client *awsClient) uploadFile(bucketName string, originalObjectKey string, thumbnail io.Reader) error {\n\tobjectKeyParts := strings.Split(originalObjectKey, \"/\")\n\tfileNameWithoutExtensions := strings.Split(objectKeyParts[len(objectKeyParts)-1], \".\")[0]\n\tobjectKey := fmt.Sprintf(\"thumbnails/%s_thumbnail.png\", fileNameWithoutExtensions)\n\n\t_, err := client.s3.PutObject(*client.ctx, &s3.PutObjectInput{\n\t\tBucket: aws.String(bucketName),\n\t\tKey:    aws.String(objectKey),\n\t\tBody:   thumbnail,\n\t})\n\n\tif err != nil {\n\t\tlog.Fatalf(\"%vì„(ë¥¼) %vì˜ %vì— ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŒ. ì›ì¸: %v\\n\",\n\t\t\toriginalObjectKey, bucketName, objectKey, err)\n\t}\n\n\treturn err\n}\n\nfunc main() {\n\tlambda.Start(handleRequest)\n}\n```\n\nì´ì œ GitHub workflowë¥¼ ì„¤ì •í•˜ì—¬ ëŒë‹¤ ì½”ë“œë¥¼ ë°°í¬í•´ì•¼ í•©ë‹ˆë‹¤.\n\n.github/workflows í´ë”ì— deploy-lambda.ymlì´ë¼ëŠ” ìƒˆ íŒŒì¼ì„ ì¶”ê°€í•˜ê³  ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”:```\n\n<div class=\"content-ad\"></div>\n\n```bash\nname: Deploy Thumbnail Generator Lambda\non:\n  push:\n    branches:\n      - main\n    paths:\n      - src/**/*\n      - .github/workflows/deploy-lambda.yml\n\ndefaults:\n  run:\n    working-directory: src/\n\njobs:\n  terraform:\n    name: 'Deploy Thumbnail Generator Lambda'\n    runs-on: ubuntu-latest\n    steps:\n      # Checkout the repository to the GitHub Actions runner\n      - name: Checkout\n        uses: actions/checkout@v3\n\n      - uses: actions/setup-go@v4.1.0\n        with:\n          go-version: '1.22.0'\n\n      - name: Configure AWS Credentials Action For GitHub Actions\n        uses: aws-actions/configure-aws-credentials@v1\n        with:\n          aws-access-key-id: ${ secrets.AWS_ACCESS_KEY }\n          aws-secret-access-key: ${ secrets.AWS_SECRET_ACCESS_KEY }\n          aws-region: eu-central-1\n\n      - name: Build Lambda\n        run: GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o build/main .\n\n      - name: Zip build\n        run: zip -r -j main.zip ./build\n\n      - name: Update Lambda code\n        run: aws lambda update-function-code --function-name=thumbnail-generator --zip-file=fileb://main.zip\n```\n\nì½”ë“œë¥¼ ì»¤ë°‹í•˜ê³  ë ˆí¬ì§€í† ë¦¬ì— í‘¸ì‹œí•˜ë©´ ë¹Œë“œê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.\n\nì™„ë£Œë˜ë©´ Lambda í˜ì´ì§€ì˜ \"ìµœì¢… ìˆ˜ì •\" ì†ì„±ì„ í™•ì¸í•˜ì—¬ ë°°í¬ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:\n\n<img src=\"/assets/img/2024-05-17-UseS3eventnotificationstogeneratethumbnails_5.png\" />\n\n\n<div class=\"content-ad\"></div>\n\ní…ŒìŠ¤íŠ¸í•˜ë ¤ë©´ S3 ë²„í‚·ì˜ images/ í´ë”ì— ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤. ì—…ë¡œë“œê°€ ì„±ê³µí•˜ë©´ ì ì‹œ ê¸°ë‹¤ë¦° í›„ ìƒˆë¡œ ë§Œë“  ì„¬ë„¤ì¼ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n# ê²°ë¡ \n\nì´ ê¸€ì—ì„œëŠ” Terraform ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ë¥¼ ì‚¬ìš©í•˜ì—¬ S3 ë²„í‚·, ëŒë‹¤, SNS, SNS ì•Œë¦¼ ë“±ì„ ìƒì„±í•˜ê³  ì—°ê²°í•˜ëŠ” ë°©ë²•ì„ ë°°ì› ìŠµë‹ˆë‹¤.\n\në˜í•œ S3 ì´ë²¤íŠ¸ë¥¼ SNS í† í”½ì— ë³´ë‚´ì–´ ì´ë¥¼ ë‹¤ë¥¸ ì†ŒìŠ¤(ë‹¤ë¥¸ SNS í† í”½ í¬í•¨)ë¡œ í™•ì‚°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ë„ ë°°ì› ìŠµë‹ˆë‹¤.\n\n<div class=\"content-ad\"></div>\n\nì €í¬ëŠ” Goë¡œ ì‘ì„±ëœ ëŒë‹¤ í•¨ìˆ˜ë„ ë§Œë“¤ì—ˆì–´ìš”. ì´ í•¨ìˆ˜ëŠ” SNS ë©”ì‹œì§€ë¥¼ í†µí•´ í˜¸ì¶œë˜ì–´ S3 ë²„í‚·ì—ì„œ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ê³  ì´ë¯¸ì§€ì—ì„œ ì¸ë„¤ì¼ì„ ìƒì„±í•œ ë‹¤ìŒ ì´ ì¸ë„¤ì¼ì„ S3ì— ì—…ë¡œë“œí•©ë‹ˆë‹¤.\n\nì´ ê¸€ì˜ ì½”ë“œëŠ” ì—¬ê¸°ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.\n\nì¦ê±°ìš´ ì½”ë”©í•˜ì„¸ìš”! ğŸ’»","ogImage":{"url":"/assets/img/2024-05-17-UseS3eventnotificationstogeneratethumbnails_0.png"},"coverImage":"/assets/img/2024-05-17-UseS3eventnotificationstogeneratethumbnails_0.png","tag":["Tech"],"readingTime":18},"content":"<!doctype html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\">\n<meta content=\"width=device-width, initial-scale=1\" name=\"viewport\">\n</head>\n<body>\n<h2>ì´ë²¤íŠ¸ ê¸°ë°˜ ì„œë²„ë¦¬ìŠ¤ ì•„í‚¤í…ì²˜</h2>\n<p><img src=\"/assets/img/2024-05-17-UseS3eventnotificationstogeneratethumbnails_0.png\" alt=\"ì´ë¯¸ì§€\"></p>\n<p>ì•ˆë…•í•˜ì„¸ìš”!</p>\n<p>ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ íŒŒì¼ì„ í´ë¼ìš°ë“œì— ì €ì¥í•˜ëŠ” ê²ƒì€ íŒŒì¼ ì§€ì†ì„±ì˜ í•œ ë°©ë²•ìœ¼ë¡œ ë§¤ìš° ì¼ë°˜ì ì…ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì–´ë””ì—ì„œ ì–´ë–»ê²Œ ì‚¬ìš©ë ì§€ì— ëŒ€í•œ ë§ì€ ìœ ì—°ì„±ì„ ì œê³µí•©ë‹ˆë‹¤.</p>\n<p>AWSëŠ” ê°ì²´ë¥¼ ì €ì¥í•  ìˆ˜ ìˆëŠ” ì˜µì…˜ìœ¼ë¡œ ê´€ë¦¬í˜• ì„œë¹„ìŠ¤ S3 (Simple Storage Service)ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì´ ì„œë¹„ìŠ¤ëŠ” ë†’ì€ ê°€ìš©ì„±, í™•ì¥ì„± ë° ì„±ëŠ¥ì„ ê°–ì¶”ê³  ìˆìŠµë‹ˆë‹¤. ì£¼ë¡œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì €ì¥ ì„œë¹„ìŠ¤ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>\n<p>S3ëŠ” ë²„í‚· ì•ˆì—ì„œ ê°ì²´ ì‘ì—…ì— ëŒ€í•œ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ë„ ì œê³µí•©ë‹ˆë‹¤. ì´ëŠ” ê°ì²´ ìƒì„±, ì—…ë°ì´íŠ¸, ì´ë™, ì‚­ì œ ë“±ì˜ ì‘ì—…ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ S3 ì´ë²¤íŠ¸ ì•Œë¦¼ì´ë¼ê³  í•©ë‹ˆë‹¤.</p>\n<p>ì´ ë¬¸ì„œì—ì„œëŠ” ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•  ë•Œë§ˆë‹¤ í•´ë‹¹ ì´ë¯¸ì§€ì— ëŒ€í•œ ì„¬ë„¤ì¼ì„ ìƒì„±í•˜ëŠ” ì„œë²„ë¦¬ìŠ¤ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.</p>\n<p>ìš°ë¦¬ëŠ” ì´ë²¤íŠ¸ ì•Œë¦¼ì„ ìˆ˜ì‹ í•˜ê³  ì„¬ë„¤ì¼ì„ ìƒì„±í•˜ëŠ” Goë¡œ ì‘ì„±ëœ ëŒë‹¤ í•¨ìˆ˜ë¥¼ ê°€ì§ˆ ê²ƒì…ë‹ˆë‹¤.</p>\n<p>í•´ë³´ìêµ¬ìš”!</p>\n<h1>ìš”êµ¬ ì‚¬í•­</h1>\n<ul>\n<li>AWS ê³„ì •</li>\n<li>ì¢‹ì•„í•˜ëŠ” ì½”ë“œ í¸ì§‘ê¸° (ì €ëŠ” Visual Studio Codeë¥¼ ì‚¬ìš©í•  ì˜ˆì •ì…ë‹ˆë‹¤)</li>\n<li>GitHub ê³„ì •</li>\n</ul>\n<h1>ì•„í‚¤í…ì²˜</h1>\n<p>ë²„í‚·ì„ êµ¬ì„±í•˜ì—¬ ê°ì²´ ì´ë²¤íŠ¸ë¥¼ SNS í† í”½ìœ¼ë¡œ ë³´ë‚´ê³  í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ìƒì„±í•œ ì¸ë„¤ì¼ì„ S3 ë²„í‚·ì— ì—…ë¡œë“œí•  ëŒë‹¤ë¡œ ì „ì†¡í•  ê²ƒì…ë‹ˆë‹¤.</p>\n<p>S3 ë²„í‚· ì´ë²¤íŠ¸ì— ëŒë‹¤ë¥¼ ì§ì ‘ ëŒ€ìƒìœ¼ë¡œ ì§€ì •í•˜ì§€ ì•Šì„ ê²ƒì…ë‹ˆë‹¤. ì´ìœ ëŠ” ê° ì´ë²¤íŠ¸ ì•Œë¦¼ì— ëŒ€í•´ í•˜ë‚˜ì˜ ëŒ€ìƒ ìœ í˜•ë§Œ ì§€ì •í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. SNS í† í”½ì„ ëŒ€ìƒìœ¼ë¡œ ì‚¬ìš©í•˜ë©´ SQS ëŒ€ê¸°ì—´, ì´ë©”ì¼, ì „í™” ì•Œë¦¼ ë° SNSê°€ ì§€ì›í•˜ëŠ” ê¸°íƒ€ ì—¬ëŸ¬ ëŒ€ìƒìœ¼ë¡œ ì´ë²¤íŠ¸ë¥¼ ì „íŒŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>\n<h1>Terraformì„ ì‚¬ìš©í•˜ì—¬ ì¸í”„ë¼ êµ¬ì„±í•˜ê¸°</h1>\n<h2>ì´ë¯¸ì§€ S3 ë²„í‚·</h2>\n<p>ì‹œì‘í•˜ë ¤ë©´ ìš°ë¦¬ì˜ í…Œë¼í¼ í´ë”ë¥¼ ì„¤ì •í•˜ê¸° ìœ„í•´ í”„ë¡œì íŠ¸ì˜ ë£¨íŠ¸ ë ˆë²¨ì— iacë¼ëŠ” í´ë”ë¥¼ ë§Œë“¤ì–´ ì£¼ì„¸ìš”. ê·¸ ì•ˆì— providers.tfë¼ëŠ” íŒŒì¼ì„ ìƒì„±í•´ AWS í”„ë¡œë°”ì´ë”ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆë„ë¡ ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”:</p>\n<pre><code class=\"hljs language-js\">terraform {\n  required_providers {\n    aws = {\n      source  = <span class=\"hljs-string\">\"hashicorp/aws\"</span>\n      version = <span class=\"hljs-string\">\"~> 5.0\"</span>\n    }\n  }\n}\n\n<span class=\"hljs-comment\">// Regionì€ AWS_REGION í™˜ê²½ ë³€ìˆ˜ì—ì„œ ì„¤ì •ë©ë‹ˆë‹¤</span>\nprovider <span class=\"hljs-string\">\"aws\"</span> {\n}\n</code></pre>\n<p>ë§Œì•½ í…Œë¼í¼ì´ ì¸í”„ë¼ ìƒíƒœë¥¼ ì¶”ì í•˜ë„ë¡ í•˜ë ¤ë©´, AWSì—ì„œ S3 ë²„í‚·ì„ ìƒì„±í•˜ê³  ìƒíƒœ ë°±ì—”ë“œë¡œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ì½”ë“œì—ì„œì²˜ëŸ¼ í•˜ì‹œë©´ ë©ë‹ˆë‹¤:</p>\n<pre><code class=\"hljs language-js\">terraform {\n  required_providers {\n    aws = {\n      source  = <span class=\"hljs-string\">\"hashicorp/aws\"</span>\n      version = <span class=\"hljs-string\">\"~> 5.0\"</span>\n    }\n  }\n\n  backend <span class=\"hljs-string\">\"s3\"</span> {\n    bucket = <span class=\"hljs-string\">\"terraform-medium-api-notification\"</span> <span class=\"hljs-comment\">// ì—¬ê¸°ê°€ ìƒíƒœ ë²„í‚·ì…ë‹ˆë‹¤</span>\n    key    = <span class=\"hljs-string\">\"thumbnail-generator/state\"</span>\n  }\n}\n\n<span class=\"hljs-comment\">// AWS_REGION í™˜ê²½ ë³€ìˆ˜ì—ì„œ ì§€ì—­ ì„¤ì •ë¨</span>\nprovider <span class=\"hljs-string\">\"aws\"</span> {\n}\n</code></pre>\n<p>ì´ì œ ì´ë¯¸ì§€ë¥¼ í˜¸ìŠ¤íŒ…í•˜ëŠ” S3 ë²„í‚·ì„ ë§Œë“¤ì–´ ë´…ì‹œë‹¤.</p>\n<p>iac í´ë”ì— s3.tfë¼ëŠ” íŒŒì¼ì„ ë§Œë“¤ê³  ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”:</p>\n<pre><code class=\"hljs language-js\">resource <span class=\"hljs-string\">\"aws_s3_bucket\"</span> <span class=\"hljs-string\">\"my-app-images\"</span> {\n  bucket = <span class=\"hljs-string\">\"my-super-app-images\"</span> <span class=\"hljs-comment\">// ë²„í‚·ì— ê³ ìœ í•œ ì´ë¦„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”</span>\n}\n\nresource <span class=\"hljs-string\">\"aws_s3_object\"</span> <span class=\"hljs-string\">\"images_folder\"</span> {\n  bucket = aws_s3_bucket.<span class=\"hljs-property\">my</span>-app-images.<span class=\"hljs-property\">bucket</span>\n  key    = <span class=\"hljs-string\">\"images/\"</span>\n}\n\nresource <span class=\"hljs-string\">\"aws_s3_object\"</span> <span class=\"hljs-string\">\"thumbnails_folder\"</span> {\n  bucket = aws_s3_bucket.<span class=\"hljs-property\">my</span>-app-images.<span class=\"hljs-property\">bucket</span>\n  key    = <span class=\"hljs-string\">\"thumbnails/\"</span>\n}\n</code></pre>\n<p>ë²„í‚· ì†ì„±ì—ì„œëŠ” ë²„í‚·ì— ê³ ìœ í•œ ì´ë¦„ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. ì™œëƒí•˜ë©´ S3 ë²„í‚· ì´ë¦„ì€ ëª¨ë“  AWS ì „ì—­ì—ì„œ ê³ ìœ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì´ë¦„ì„ ì œê³µí•˜ì§€ ì•Šìœ¼ë ¤ë©´ ë¹„ì›Œë‘ê³  AWSê°€ ê³ ìœ í•œ ë²„í‚· ì´ë¦„ì„ í• ë‹¹í•´ ì¤„ ê²ƒì…ë‹ˆë‹¤.</p>\n<p>ì´ ì½”ë“œëŠ” ì´ë¯¸ì§€/ ë° ì¸ë„¤ì¼/ ë‘ ê°œì˜ í´ë”ê°€ ìˆëŠ” S3 ë²„í‚·ì„ ìƒì„±í•©ë‹ˆë‹¤. ì´ í´ë”ë“¤ì€ íŒŒì¼ì„ ì €ì¥í•˜ëŠ” ë° ì‚¬ìš©í•  ê²ƒì…ë‹ˆë‹¤.</p>\n<h2>SNSë¥¼ ì‚¬ìš©í•œ ë©”ì‹œì§•</h2>\n<p>ì´ì œ ì•Œë¦¼ ì£¼ì œì™€ ë©”ì‹œì§€ ëŒ€ê¸°ì—´ì„ ì„¤ì •í•´ ë´…ì‹œë‹¤.</p>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-comment\"># messaging.tf</span>\n\n<span class=\"hljs-string\">resource</span> <span class=\"hljs-string\">\"aws_sns_topic\"</span> <span class=\"hljs-string\">\"topic\"</span> {\n  <span class=\"hljs-string\">name</span>   <span class=\"hljs-string\">=</span> <span class=\"hljs-string\">\"image-events\"</span>\n}\n</code></pre>\n<pre><code class=\"hljs language-yaml\"><span class=\"hljs-comment\"># variables.tf</span>\n\n<span class=\"hljs-string\">variable</span> <span class=\"hljs-string\">\"region\"</span> {\n  <span class=\"hljs-string\">description</span> <span class=\"hljs-string\">=</span> <span class=\"hljs-string\">\"Default region of your resources\"</span>\n  <span class=\"hljs-string\">type</span>        <span class=\"hljs-string\">=</span> <span class=\"hljs-string\">string</span>\n  <span class=\"hljs-string\">default</span>     <span class=\"hljs-string\">=</span> <span class=\"hljs-string\">\"eu-central-1\"</span> <span class=\"hljs-comment\"># Set as your default region here</span>\n}\n\n<span class=\"hljs-string\">variable</span> <span class=\"hljs-string\">\"account_id\"</span> {\n  <span class=\"hljs-string\">description</span> <span class=\"hljs-string\">=</span> <span class=\"hljs-string\">\"The ID of the default AWS account\"</span>\n  <span class=\"hljs-string\">type</span>        <span class=\"hljs-string\">=</span> <span class=\"hljs-string\">string</span>\n}\n</code></pre>\n<p>ê·¸ë¦¬ê³  variables.tfvarsë¼ëŠ” ë˜ ë‹¤ë¥¸ íŒŒì¼ì„ ë§Œë“¤ì–´ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”:</p>\n<pre><code class=\"hljs language-js\">region = <span class=\"hljs-string\">\"eu-central-1\"</span> <span class=\"hljs-comment\">// ì›í•˜ëŠ” ì§€ì—­ì„ ì„¤ì •í•˜ì„¸ìš”</span>\n</code></pre>\n<p>ë‚˜ì¤‘ì— í…Œë¼í¼ ëª…ë ¹ì–´ì— ì „ë‹¬í•  account_idëŠ” ë‚˜ì¤‘ì— ì¸ìˆ˜ë¡œ ì „ë‹¬í•  ê²ƒì…ë‹ˆë‹¤.</p>\n<h2>S3 ì´ë²¤íŠ¸ ì•Œë¦¼</h2>\n<p>ì´ì œ S3ì— ëŒ€í•œ ì´ë²¤íŠ¸ ì•Œë¦¼ì„ ì„¤ì •í•´ ë´…ì‹œë‹¤.</p>\n<p>s3.tf íŒŒì¼ì— ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì—¬ ë²„í‚· ì•Œë¦¼ì„ ì„¤ì •í•˜ì„¸ìš”:</p>\n<pre><code class=\"hljs language-js\">resource <span class=\"hljs-string\">\"aws_s3_bucket_notification\"</span> <span class=\"hljs-string\">\"images_put_notification\"</span> {\n  bucket = aws_s3_bucket.<span class=\"hljs-property\">my</span>-app-images.<span class=\"hljs-property\">id</span>\n  topic {\n    topic_arn = aws_sns_topic.<span class=\"hljs-property\">topic</span>.<span class=\"hljs-property\">arn</span>\n    filter_prefix = <span class=\"hljs-string\">\"images/\"</span>\n    events = [<span class=\"hljs-string\">\"s3:ObjectCreated:*\"</span>]\n  }\n}\n</code></pre>\n<p>ì´ë¥¼ í™œì„±í™”í•˜ë ¤ë©´ S3 ë²„í‚·ì´ í•´ë‹¹ topicìœ¼ë¡œ ì•Œë¦¼ì„ ë°œí–‰í•  ìˆ˜ ìˆë„ë¡ SNS topicì— ì •ì±…ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤. messaging.tf íŒŒì¼ë¡œ ì´ë™í•˜ì—¬ ë‹¤ìŒ ì •ì±…ì„ ì¶”ê°€í•˜ì„¸ìš”:</p>\n<pre><code class=\"hljs language-js\">ë¦¬ì†ŒìŠ¤ <span class=\"hljs-string\">\"aws_sns_topic\"</span> <span class=\"hljs-string\">\"topic\"</span> {\n  name   = <span class=\"hljs-string\">\"image-events\"</span>\n  policy = data.<span class=\"hljs-property\">aws_iam_policy_document</span>.<span class=\"hljs-property\">sns</span>-topic-policy.<span class=\"hljs-property\">json</span>\n}\n\në°ì´í„° <span class=\"hljs-string\">\"aws_iam_policy_document\"</span> <span class=\"hljs-string\">\"sns-topic-policy\"</span> {\n  policy_id = <span class=\"hljs-string\">\"arn:aws:sns:${var.region}:${var.account_id}:image-events/SNSS3NotificationPolicy\"</span>\n  statement {\n    sid    = <span class=\"hljs-string\">\"s3-allow-send-messages\"</span>\n    effect = <span class=\"hljs-string\">\"Allow\"</span>\n    principals {\n      type        = <span class=\"hljs-string\">\"Service\"</span>\n      identifiers = [<span class=\"hljs-string\">\"s3.amazonaws.com\"</span>]\n    }\n    actions = [\n      <span class=\"hljs-string\">\"SNS:Publish\"</span>,\n    ]\n    resources = [\n      <span class=\"hljs-string\">\"arn:aws:sns:${var.region}:${var.account_id}:image-events\"</span>,\n    ]\n    condition {\n      test     = <span class=\"hljs-string\">\"ArnEquals\"</span>\n      variable = <span class=\"hljs-string\">\"aws:SourceArn\"</span>\n      values = [\n        aws_s3_bucket.<span class=\"hljs-property\">my</span>-app-images.<span class=\"hljs-property\">arn</span>\n      ]\n    }\n  }\n}\n</code></pre>\n<p>ì—¬ê¸°ì„œëŠ” sns-topic-policy ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•˜ê³  í•´ë‹¹ ë¦¬ì†ŒìŠ¤ë¥¼ policy ì†ì„±ì— ì „ë‹¬í•˜ëŠ” topic ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>\n<h2>ê¸°ë³¸ ëŒë‹¤ ì¶”ê°€í•˜ê¸°</h2>\n<p>ì´ì œ ëŒë‹¤ì˜ ê¸°ë°˜ ì¸í”„ë¼ë¥¼ ì¶”ê°€í•˜ê¸°ë§Œ ë‚¨ì•˜ìŠµë‹ˆë‹¤. ì´í›„ì— ì½”ë“œë¥¼ ì¶”ê°€í•  ê¸°ë³¸ ëŒë‹¤ë¥¼ ì„¤ì •í•  ê²ƒì…ë‹ˆë‹¤. Go ì–¸ì–´ë¡œ ì½”ë“œë¥¼ ì‘ì„±í•  ì˜ˆì •ì…ë‹ˆë‹¤.</p>\n<p>ë¨¼ì €, ëŒë‹¤ í•¨ìˆ˜ë¥¼ ì´ˆê¸°í™”í•  ê¸°ë³¸ ì½”ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤. ê·¸ë˜ì„œ iac í´ë”ì— lambda_init_codeë¼ëŠ” í´ë”ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”. ì—¬ê¸°ì„œ ì†ŒìŠ¤ ì½”ë“œë¥¼ ê°€ì ¸ì™€ì„œ ë©”ì¸ ì»´íŒŒì¼ëœ íŒŒì¼ì„ ì§ì ‘ ì‚¬ìš©í•˜ê±°ë‚˜ README.md íŒŒì¼ì˜ ì§€ì‹œì— ë”°ë¼ ìƒˆë¡œìš´ ì‹¤í–‰ ê°€ëŠ¥ íŒŒì¼ì„ ì»´íŒŒì¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>\n<p>ì´ì œ ìƒˆ íŒŒì¼ lambdas.tfë¥¼ ìƒì„±í•˜ê³  ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì—¬ ëŒë‹¤ ì¸í”„ë¼ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:</p>\n<pre><code class=\"hljs language-js\">resource <span class=\"hljs-string\">\"aws_iam_role\"</span> <span class=\"hljs-string\">\"iam_for_lambda\"</span> {\n  name               = <span class=\"hljs-string\">\"thumbnail-generator-lambda-role\"</span>\n  assume_role_policy = data.<span class=\"hljs-property\">aws_iam_policy_document</span>.<span class=\"hljs-property\">assume_role</span>.<span class=\"hljs-property\">json</span>\n  inline_policy {\n    name   = <span class=\"hljs-string\">\"DefaultPolicy\"</span>\n    policy = data.<span class=\"hljs-property\">aws_iam_policy_document</span>.<span class=\"hljs-property\">lambda_role_policies</span>.<span class=\"hljs-property\">json</span>\n  }\n}\nresource <span class=\"hljs-string\">\"aws_lambda_function\"</span> <span class=\"hljs-string\">\"lambda\"</span> {\n  filename      = data.<span class=\"hljs-property\">archive_file</span>.<span class=\"hljs-property\">lambda</span>.<span class=\"hljs-property\">output_path</span>\n  function_name = <span class=\"hljs-string\">\"thumbnail-generator\"</span>\n  role          = aws_iam_role.<span class=\"hljs-property\">iam_for_lambda</span>.<span class=\"hljs-property\">arn</span>\n  handler       = <span class=\"hljs-string\">\"main\"</span>\n  runtime       = <span class=\"hljs-string\">\"go1.x\"</span>\n  timeout       = <span class=\"hljs-number\">15</span>\n}\n\ndata <span class=\"hljs-string\">\"archive_file\"</span> <span class=\"hljs-string\">\"lambda\"</span> {\n  type        = <span class=\"hljs-string\">\"zip\"</span>\n  source_file = <span class=\"hljs-string\">\"./lambda_init_code/main\"</span>\n  output_path = <span class=\"hljs-string\">\"thumbnail_generator_lambda_function_payload.zip\"</span>\n}\n\ndata <span class=\"hljs-string\">\"aws_iam_policy_document\"</span> <span class=\"hljs-string\">\"assume_role\"</span> {\n  statement {\n    effect = <span class=\"hljs-string\">\"Allow\"</span>\n    principals {\n      type        = <span class=\"hljs-string\">\"Service\"</span>\n      identifiers = [<span class=\"hljs-string\">\"lambda.amazonaws.com\"</span>]\n    }\n    actions = [<span class=\"hljs-string\">\"sts:AssumeRole\"</span>]\n  }\n}\n\ndata <span class=\"hljs-string\">\"aws_iam_policy_document\"</span> <span class=\"hljs-string\">\"lambda_role_policies\"</span> {\n  statement {\n    effect = <span class=\"hljs-string\">\"Allow\"</span>\n    actions = [\n      <span class=\"hljs-string\">\"logs:CreateLogGroup\"</span>,\n      <span class=\"hljs-string\">\"logs:CreateLogStream\"</span>,\n      <span class=\"hljs-string\">\"logs:PutLogEvents\"</span>,\n    ]\n    resources = [<span class=\"hljs-string\">\"arn:aws:logs:*:*:*\"</span>]\n  }\n}\n</code></pre>\n<p>ì´ë ‡ê²Œ í•˜ë©´ ëŸ°íƒ€ì„ìœ¼ë¡œ Goë¥¼ ì‚¬ìš©í•˜ëŠ” ëŒë‹¤ í•¨ìˆ˜ë¥¼ ìƒì„±í•˜ê³  ì—­í• ì„ ë§Œë“¤ë©°, ëŒë‹¤ í•¨ìˆ˜ê°€ ì´ ì—­í• ì„ ê°€ì •í•˜ê³  í´ë¼ìš°ë“œì›Œì¹˜ì— ë¡œê¹…í•  ìˆ˜ ìˆë„ë¡ ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.</p>\n<p>ë‹¤ìŒìœ¼ë¡œ, ëŒë‹¤ê°€ íŠ¸ë¦¬ê±°ë  ìˆ˜ ìˆë„ë¡ SNS ì£¼ì œì— ëŒ€í•œ êµ¬ë…ì„ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤. lambdas.tf íŒŒì¼ì— ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:</p>\n<pre><code class=\"hljs language-js\">resource <span class=\"hljs-string\">\"aws_sns_topic_subscription\"</span> <span class=\"hljs-string\">\"topic_subscription\"</span> {\n  topic_arn = aws_sns_topic.<span class=\"hljs-property\">topic</span>.<span class=\"hljs-property\">arn</span>\n  protocol  = <span class=\"hljs-string\">\"lambda\"</span>\n  endpoint  = aws_lambda_function.<span class=\"hljs-property\">lambda</span>.<span class=\"hljs-property\">arn</span>\n}\n\nresource <span class=\"hljs-string\">\"aws_lambda_permission\"</span> <span class=\"hljs-string\">\"apigw_lambda\"</span> {\n  statement_id  = <span class=\"hljs-string\">\"AllowExecutionFromSNS\"</span>\n  action        = <span class=\"hljs-string\">\"lambda:InvokeFunction\"</span>\n  function_name = aws_lambda_function.<span class=\"hljs-property\">lambda</span>.<span class=\"hljs-property\">arn</span>\n  principal     = <span class=\"hljs-string\">\"sns.amazonaws.com\"</span>\n  source_arn    = aws_sns_topic.<span class=\"hljs-property\">topic</span>.<span class=\"hljs-property\">arn</span>\n}\n</code></pre>\n<p>ìµœì¢… lambdas.tf íŒŒì¼ì´ ë‹¤ìŒê³¼ ê°™ì´ ë˜ë„ë¡ ë§Œë“¤ì–´ë³´ì„¸ìš”:</p>\n<pre><code class=\"hljs language-js\">resource <span class=\"hljs-string\">\"aws_iam_role\"</span> <span class=\"hljs-string\">\"iam_for_lambda\"</span> {\n  name               = <span class=\"hljs-string\">\"thumbnail-generator-lambda-role\"</span>\n  assume_role_policy = data.<span class=\"hljs-property\">aws_iam_policy_document</span>.<span class=\"hljs-property\">assume_role</span>.<span class=\"hljs-property\">json</span>\n  inline_policy {\n    name   = <span class=\"hljs-string\">\"DefaultPolicy\"</span>\n    policy = data.<span class=\"hljs-property\">aws_iam_policy_document</span>.<span class=\"hljs-property\">lambda_role_policies</span>.<span class=\"hljs-property\">json</span>\n  }\n}\n\nresource <span class=\"hljs-string\">\"aws_lambda_function\"</span> <span class=\"hljs-string\">\"lambda\"</span> {\n  filename      = data.<span class=\"hljs-property\">archive_file</span>.<span class=\"hljs-property\">lambda</span>.<span class=\"hljs-property\">output_path</span>\n  function_name = <span class=\"hljs-string\">\"thumbnail-generator\"</span>\n  role          = aws_iam_role.<span class=\"hljs-property\">iam_for_lambda</span>.<span class=\"hljs-property\">arn</span>\n  handler       = <span class=\"hljs-string\">\"main\"</span>\n  runtime       = <span class=\"hljs-string\">\"go1.x\"</span>\n  timeout       = <span class=\"hljs-number\">15</span>\n}\n\nresource <span class=\"hljs-string\">\"aws_sns_topic_subscription\"</span> <span class=\"hljs-string\">\"topic_subscription\"</span> {\n  topic_arn = aws_sns_topic.<span class=\"hljs-property\">topic</span>.<span class=\"hljs-property\">arn</span>\n  protocol  = <span class=\"hljs-string\">\"lambda\"</span>\n  endpoint  = aws_lambda_function.<span class=\"hljs-property\">lambda</span>.<span class=\"hljs-property\">arn</span>\n}\n\nresource <span class=\"hljs-string\">\"aws_lambda_permission\"</span> <span class=\"hljs-string\">\"apigw_lambda\"</span> {\n  statement_id  = <span class=\"hljs-string\">\"AllowExecutionFromSNS\"</span>\n  action        = <span class=\"hljs-string\">\"lambda:InvokeFunction\"</span>\n  function_name = aws_lambda_function.<span class=\"hljs-property\">lambda</span>.<span class=\"hljs-property\">arn</span>\n  principal     = <span class=\"hljs-string\">\"sns.amazonaws.com\"</span>\n  source_arn    = aws_sns_topic.<span class=\"hljs-property\">topic</span>.<span class=\"hljs-property\">arn</span>\n}\n\ndata <span class=\"hljs-string\">\"archive_file\"</span> <span class=\"hljs-string\">\"lambda\"</span> {\n  type        = <span class=\"hljs-string\">\"zip\"</span>\n  source_file = <span class=\"hljs-string\">\"./lambda_init_code/main\"</span>\n  output_path = <span class=\"hljs-string\">\"thumbnail_generator_lambda_function_payload.zip\"</span>\n}\n\ndata <span class=\"hljs-string\">\"aws_iam_policy_document\"</span> <span class=\"hljs-string\">\"assume_role\"</span> {\n  statement {\n    effect = <span class=\"hljs-string\">\"Allow\"</span>\n    principals {\n      type        = <span class=\"hljs-string\">\"Service\"</span>\n      identifiers = [<span class=\"hljs-string\">\"lambda.amazonaws.com\"</span>]\n    }\n    actions = [<span class=\"hljs-string\">\"sts:AssumeRole\"</span>]\n  }\n}\n\ndata <span class=\"hljs-string\">\"aws_iam_policy_document\"</span> <span class=\"hljs-string\">\"lambda_role_policies\"</span> {\n  statement {\n    effect = <span class=\"hljs-string\">\"Allow\"</span>\n    actions = [\n      <span class=\"hljs-string\">\"logs:CreateLogGroup\"</span>,\n      <span class=\"hljs-string\">\"logs:CreateLogStream\"</span>,\n      <span class=\"hljs-string\">\"logs:PutLogEvents\"</span>\n    ]\n    resources = [<span class=\"hljs-string\">\"arn:aws:logs:*:*:*\"</span>]\n  }\n\n  statement {\n    effect = <span class=\"hljs-string\">\"Allow\"</span>\n    actions = [\n      <span class=\"hljs-string\">\"s3:GetObject\"</span>,\n    ]\n    resources = [\n      <span class=\"hljs-title function_\">format</span>(<span class=\"hljs-string\">\"%s/%s*\"</span>, aws_s3_bucket.<span class=\"hljs-property\">my</span>-app-images.<span class=\"hljs-property\">arn</span>, aws_s3_object.<span class=\"hljs-property\">images_folder</span>.<span class=\"hljs-property\">key</span>)\n    ]\n  }\n\n  statement {\n    effect = <span class=\"hljs-string\">\"Allow\"</span>\n    actions = [\n      <span class=\"hljs-string\">\"s3:PutObject\"</span>,\n    ]\n    resources = [\n      <span class=\"hljs-title function_\">format</span>(<span class=\"hljs-string\">\"%s/%s*\"</span>, aws_s3_bucket.<span class=\"hljs-property\">my</span>-app-images.<span class=\"hljs-property\">arn</span>, aws_s3_object.<span class=\"hljs-property\">thumbnails_folder</span>.<span class=\"hljs-property\">key</span>)\n    ]\n  }\n}\n</code></pre>\n<p>ìš°ë¦¬ì˜ SNS í† í”½ì´ ëŒë‹¤ë¥¼ ì´ë²¤íŠ¸ì™€ í•¨ê»˜ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ ê¶Œí•œì„ ë¶€ì—¬í•  ê²ƒì…ë‹ˆë‹¤.</p>\n<p>ëŒë‹¤ëŠ” 15ì´ˆì˜ ì œí•œ ì‹œê°„ì„ ê°–ê³  ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ê¸°ë³¸ ì œí•œ ì‹œê°„ì´ 3ì´ˆì´ê¸° ë•Œë¬¸ì— S3ë¡œ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ê³  ì—…ë¡œë“œí•˜ëŠ” ì‘ì—…ì€ ì´ë¯¸ì§€ í¬ê¸°ì— ë”°ë¼ 3ì´ˆë³´ë‹¤ ë” ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì´ëŠ” S3 ì‘ì—…ì´ ì¸í„°ë„·ì„ í†µê³¼í•˜ê¸° ë•Œë¬¸ì— ë°œìƒí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¤ê³  ì‹¶ë‹¤ë©´ VPCë¥¼ ìƒì„±í•˜ê³  ëŒë‹¤ì™€ VPC ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë§Œë“¤ì–´ S3 ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì—°ê²°ì´ ì¸í„°ë„·ì´ ì•„ë‹Œ AWS ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ì´ë£¨ì–´ì§€ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>\n<h2>ì¸í”„ë¼ ë°°í¬í•˜ê¸°</h2>\n<p>ì´ì œ ìš°ë¦¬ê°€ ì½”ë“œë¡œ ì •ì˜í•œ ì¸í”„ë¼ë¥¼ ë°°í¬í•˜ê¸° ìœ„í•´ GitHub ì•¡ì…˜ì„ ì‚¬ìš©í•´ë³´ê² ìŠµë‹ˆë‹¤.</p>\n<p>ì½”ë“œì— .github/workflows í´ë”ë¥¼ ë§Œë“¤ê³  deploy-infra.yml íŒŒì¼ì„ ì¶”ê°€í•˜ì—¬ GitHub ì•¡ì…˜ ì›Œí¬í”Œë¡œìš°ë¥¼ ì •ì˜í•˜ì„¸ìš”:</p>\n<pre><code class=\"hljs language-yml\"><span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Deploy</span> <span class=\"hljs-string\">Infrastructure</span>\n<span class=\"hljs-attr\">on:</span>\n  <span class=\"hljs-attr\">push:</span>\n    <span class=\"hljs-attr\">branches:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">main</span>\n    <span class=\"hljs-attr\">paths:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">iac/**/*</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">.github/workflows/deploy-infra.yml</span>\n\n<span class=\"hljs-attr\">defaults:</span>\n  <span class=\"hljs-attr\">run:</span>\n    <span class=\"hljs-attr\">working-directory:</span> <span class=\"hljs-string\">iac/</span>\n\n<span class=\"hljs-attr\">jobs:</span>\n  <span class=\"hljs-attr\">terraform:</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">'Terraform'</span>\n    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">ubuntu-latest</span>\n    <span class=\"hljs-attr\">steps:</span>\n      <span class=\"hljs-comment\"># GitHub Actions ëŸ¬ë„ˆì— ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒ</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Checkout</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@v3</span>\n\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Configure</span> <span class=\"hljs-string\">AWS</span> <span class=\"hljs-string\">Credentials</span> <span class=\"hljs-string\">Action</span> <span class=\"hljs-string\">For</span> <span class=\"hljs-string\">GitHub</span> <span class=\"hljs-string\">Actions</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">aws-actions/configure-aws-credentials@v1</span>\n        <span class=\"hljs-attr\">with:</span>\n          <span class=\"hljs-attr\">aws-access-key-id:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">secrets.AWS_ACCESS_KEY</span> <span class=\"hljs-string\">}}</span>\n          <span class=\"hljs-attr\">aws-secret-access-key:</span> <span class=\"hljs-string\">${{</span> <span class=\"hljs-string\">secrets.AWS_SECRET_ACCESS_KEY</span> <span class=\"hljs-string\">}}</span>\n          <span class=\"hljs-attr\">aws-region:</span> <span class=\"hljs-string\">eu-central-1</span>\n\n      <span class=\"hljs-comment\"># ìµœì‹  ë²„ì „ì˜ Terraform CLI ì„¤ì¹˜ ë° Terraform Cloud ì‚¬ìš©ì API í† í°ì„ ì‚¬ìš©í•˜ì—¬ Terraform CLI êµ¬ì„± íŒŒì¼ ì„¤ì •</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Setup</span> <span class=\"hljs-string\">Terraform</span>\n        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">hashicorp/setup-terraform@v3</span>\n\n      <span class=\"hljs-comment\"># Terraform ì›Œí‚¹ ë””ë ‰í„°ë¦¬ë¥¼ ì´ˆê¸°í™”í•˜ê³  ì´ˆê¸° íŒŒì¼ì„ ìƒì„±í•˜ê±°ë‚˜ ê¸°ì¡´ íŒŒì¼ì„ ë¡œë“œí•˜ê³  ëª¨ë“ˆ ë‹¤ìš´ë¡œë“œ ë“±ì„ ìˆ˜í–‰</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Terraform</span> <span class=\"hljs-string\">Init</span>\n        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">terraform</span> <span class=\"hljs-string\">init</span>\n\n      <span class=\"hljs-comment\"># ëª¨ë“  Terraform êµ¬ì„± íŒŒì¼ì´ ê·œë²”ì  í˜•ì‹ì„ ì¤€ìˆ˜í•˜ëŠ”ì§€ í™•ì¸</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Terraform</span> <span class=\"hljs-string\">Format</span>\n        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">terraform</span> <span class=\"hljs-string\">fmt</span> <span class=\"hljs-string\">-check</span>\n\n      <span class=\"hljs-comment\"># Terraform ì‹¤í–‰ ê³„íš ìƒì„±</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Terraform</span> <span class=\"hljs-string\">Plan</span>\n        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|\n          terraform plan -out=plan -input=false -var-file=\"variables.tfvars\" -var account_id=${{ secrets.AWS_ACCOUNT_ID }}\n</span>\n      <span class=\"hljs-comment\"># \"main\"ìœ¼ë¡œ í‘¸ì‹œë˜ë©´ Terraform êµ¬ì„± íŒŒì¼ì— ë”°ë¼ ì¸í”„ë¼ë¥¼ êµ¬ì¶• ë˜ëŠ” ë³€ê²½í•¨</span>\n      <span class=\"hljs-comment\"># ì°¸ê³ : \"Terraform Cloud\"ì— ëŒ€í•´ \"strict\" ìƒíƒœ ê²€ì‚¬ë¥¼ ì„¤ì •í•˜ëŠ” ê²ƒì´ ê¶Œì¥ë©ë‹ˆë‹¤. ìì„¸í•œ ì •ë³´ëŠ” ì•„ë˜ ë¬¸ì„œë¥¼ ì°¸ì¡°í•˜ì„¸ìš”: https://help.github.com/en/github/administering-a-repository/types-of-required-status-checks</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Terraform</span> <span class=\"hljs-string\">Apply</span>\n        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">terraform</span> <span class=\"hljs-string\">apply</span> <span class=\"hljs-string\">-auto-approve</span> <span class=\"hljs-string\">-input=false</span> <span class=\"hljs-string\">plan</span>\n</code></pre>\n<ul>\n<li>AWS_ACCESS_KEY â€” ìì›ì„ ìƒì„±í•  ê¶Œí•œì´ ìˆëŠ” AWSì˜ ì•¡ì„¸ìŠ¤ í‚¤ì…ë‹ˆë‹¤</li>\n<li>AWS_SECRET_ACCESS_KEY â€” ì•¡ì„¸ìŠ¤ í‚¤ì™€ ì—°ê²°ëœ AWS ì‹œí¬ë¦¿</li>\n<li>AWS_ACCOUNT_ID â€” AWS ëŒ€ì‹œë³´ë“œ ì˜¤ë¥¸ìª½ ìƒë‹¨ì— ìˆëŠ” ê³„ì • IDì…ë‹ˆë‹¤</li>\n<li>YOUR_REGION â€” ì¸í”„ë¼ë¥¼ ë°°í¬í•  ê¸°ë³¸ ì§€ì—­</li>\n</ul>\n<p>ì´ì œ ì½”ë“œë¥¼ GitHubì— í‘¸ì‹œí•˜ê³  ì›Œí¬í”Œë¡œìš°ê°€ ì™„ë£Œë˜ë©´ ì¸í”„ë¼ê°€ ìƒì„±ë˜ëŠ” ê²ƒì„ í™•ì¸í•´ë³´ì„¸ìš”.</p>\n<p>í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´ ì´ë¯¸ì§€/ í´ë”ì— íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  CloudWatchì—ì„œ ëŒë‹¤ ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>\n<p>S3ëŠ” ë‘ ê°œì˜ í´ë”ë¡œ ìƒì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤:</p>\n<p><img src=\"/assets/img/2024-05-17-UseS3eventnotificationstogeneratethumbnails_2.png\" alt=\"image\"></p>\n<p>SNSëŠ” êµ¬ë…ì´ ìˆëŠ” ìƒíƒœë¡œ ìƒì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤:</p>\n<p>Lambdaë¥¼ SNS íŠ¸ë¦¬ê±°ì™€ í•¨ê»˜ ìƒì„±í•´ì•¼í•©ë‹ˆë‹¤:</p>\n<h1>Lambda êµ¬í˜„</h1>\n<p>ì¸í”„ë¼ê°€ ì„¤ì¹˜ë˜ì—ˆìœ¼ë¯€ë¡œ ì¸ë„¤ì¼ ìƒì„±ê¸° ì½”ë“œë¥¼ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.</p>\n<p>ë£¨íŠ¸ ë ˆë²¨ì— srcì´ë¼ëŠ” ìƒˆ í´ë”ë¥¼ ìƒì„±í•˜ê³  ë‹¤ìŒ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ Go ëª¨ë“ˆì„ ì´ˆê¸°í™”í•´ë³´ì„¸ìš”:</p>\n<pre><code class=\"hljs language-js\">go mod init example.<span class=\"hljs-property\">com</span>/thumbnail-generator\ngo get github.<span class=\"hljs-property\">com</span>/aws/aws-lambda-go\ngo get github.<span class=\"hljs-property\">com</span>/aws/aws-sdk-go-v2\ngo get github.<span class=\"hljs-property\">com</span>/aws/aws-sdk-go-v2/service/s3\ngo get github.<span class=\"hljs-property\">com</span>/aws/aws-sdk-go-v2/config\ngo get github.<span class=\"hljs-property\">com</span>/disintegration/imaging\n</code></pre>\n<p>ì›í•˜ëŠ” ê²½ìš° example.com/thumbnail-generatorë¥¼ ì„ í˜¸í•˜ëŠ” ëª¨ë“ˆ ì´ë¦„ìœ¼ë¡œ êµì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>\n<p>ì´ì œ main.go íŒŒì¼ì„ ë§Œë“¤ê³  ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”:</p>\n<pre><code class=\"hljs language-go\"><span class=\"hljs-keyword\">package</span> main\n\n<span class=\"hljs-keyword\">import</span> (\n\t<span class=\"hljs-string\">\"bytes\"</span>\n\t<span class=\"hljs-string\">\"context\"</span>\n\t<span class=\"hljs-string\">\"encoding/json\"</span>\n\t<span class=\"hljs-string\">\"fmt\"</span>\n\t<span class=\"hljs-string\">\"image\"</span>\n\t<span class=\"hljs-string\">\"image/png\"</span>\n\t<span class=\"hljs-string\">\"io\"</span>\n\t<span class=\"hljs-string\">\"log\"</span>\n\t<span class=\"hljs-string\">\"strings\"</span>\n\n\t<span class=\"hljs-string\">\"github.com/aws/aws-lambda-go/events\"</span>\n\t<span class=\"hljs-string\">\"github.com/aws/aws-lambda-go/lambda\"</span>\n\t<span class=\"hljs-string\">\"github.com/aws/aws-sdk-go-v2/aws\"</span>\n\t<span class=\"hljs-string\">\"github.com/aws/aws-sdk-go-v2/config\"</span>\n\t<span class=\"hljs-string\">\"github.com/aws/aws-sdk-go-v2/service/s3\"</span>\n\t<span class=\"hljs-string\">\"github.com/disintegration/imaging\"</span>\n)\n\n<span class=\"hljs-keyword\">type</span> awsClient <span class=\"hljs-keyword\">struct</span> {\n\ts3  s3.Client\n\tctx *context.Context\n}\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">handleRequest</span><span class=\"hljs-params\">(ctx context.Context, event events.SNSEvent)</span></span> <span class=\"hljs-type\">error</span> {\n\tawsConfig, err := config.LoadDefaultConfig(ctx)\n\n\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {\n\t\tlog.Fatalf(<span class=\"hljs-string\">\"AWS ê¸°ë³¸ êµ¬ì„±ì„ ë¶ˆëŸ¬ ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤\"</span>)\n\t\t<span class=\"hljs-keyword\">return</span> err\n\t}\n\n\tawsClient := awsClient{s3: *s3.NewFromConfig(awsConfig), ctx: &#x26;ctx}\n\n\t<span class=\"hljs-keyword\">for</span> _, record := <span class=\"hljs-keyword\">range</span> event.Records {\n\t\t<span class=\"hljs-keyword\">var</span> imageEvent events.S3Event\n\n\t\terr := json.Unmarshal([]<span class=\"hljs-type\">byte</span>(record.SNS.Message), &#x26;imageEvent)\n\n\t\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {\n\t\t\tlog.Fatalf(<span class=\"hljs-string\">\"SNS ë©”ì‹œì§€ %sì„ S3 ì´ë²¤íŠ¸ ë ˆì½”ë“œë¡œ ì–¸ë§ˆìƒ¬í•˜ëŠ” ë™ì•ˆ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: %v\"</span>, record.SNS.Message, err)\n\t\t\t<span class=\"hljs-keyword\">return</span> err\n\t\t}\n\n\t\t<span class=\"hljs-keyword\">for</span> _, imageRecord := <span class=\"hljs-keyword\">range</span> imageEvent.Records {\n\t\t\tbucketName := imageRecord.S3.Bucket.Name\n\t\t\tobjectKey := imageRecord.S3.Object.Key\n\n\t\t\tfile, err := awsClient.downloadFile(bucketName, objectKey)\n\n\t\t\tlog.Printf(<span class=\"hljs-string\">\"ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì„±ê³µ\"</span>)\n\n\t\t\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {\n\t\t\t\tlog.Fatalf(<span class=\"hljs-string\">\"ë²„í‚· %sì—ì„œ íŒŒì¼ %sì„ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤\"</span>, bucketName, objectKey)\n\t\t\t\t<span class=\"hljs-keyword\">return</span> err\n\t\t\t}\n\n\t\t\tthumbnail, err := createThumbnail(file)\n\n\t\t\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {\n\t\t\t\tlog.Fatalf(<span class=\"hljs-string\">\"ë²„í‚· %sì˜ íŒŒì¼ %sì— ëŒ€í•œ ì„¬ë„¤ì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: %v\"</span>, bucketName, objectKey, err)\n\t\t\t\t<span class=\"hljs-keyword\">return</span> err\n\t\t\t}\n\n\t\t\tlog.Printf(<span class=\"hljs-string\">\"ì„¬ë„¤ì¼ ìƒì„± ì„±ê³µ\"</span>)\n\n\t\t\terr = awsClient.uploadFile(bucketName, objectKey, thumbnail)\n\n\t\t\tlog.Printf(<span class=\"hljs-string\">\"ì„¬ë„¤ì¼ ì—…ë¡œë“œ ì„±ê³µ\"</span>)\n\n\t\t\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {\n\t\t\t\tlog.Fatalf(<span class=\"hljs-string\">\"ë²„í‚· %sì— íŒŒì¼ %sì„ thumbnails/ì— ì—…ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤\"</span>, bucketName, objectKey)\n\t\t\t\t<span class=\"hljs-keyword\">return</span> err\n\t\t\t}\n\t\t}\n\t}\n\n\t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">nil</span>\n}\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">createThumbnail</span><span class=\"hljs-params\">(reader io.Reader)</span></span> (*bytes.Buffer, <span class=\"hljs-type\">error</span>) {\n\tsrcImage, _, err := image.Decode(reader)\n\n\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {\n\t\tlog.Fatalf(<span class=\"hljs-string\">\"ì˜¤ë¥˜ë¡œ ì¸í•´ íŒŒì¼ì„ ë””ì½”ë”©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: %v\"</span>, err)\n\t\t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">nil</span>, err\n\t}\n\n\t<span class=\"hljs-comment\">// 80x80 í¬ê¸°ì˜ ì„¬ë„¤ì¼ ìƒì„±</span>\n\tthumbnail := imaging.Thumbnail(srcImage, <span class=\"hljs-number\">80</span>, <span class=\"hljs-number\">80</span>, imaging.Lanczos)\n\n\t<span class=\"hljs-keyword\">var</span> bufferBytes []<span class=\"hljs-type\">byte</span>\n\tbuffer := bytes.NewBuffer(bufferBytes)\n\n\terr = png.Encode(buffer, thumbnail)\n\n\t<span class=\"hljs-keyword\">return</span> buffer, err\n}\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(client *awsClient)</span></span> downloadFile(bucketName <span class=\"hljs-type\">string</span>, objectKey <span class=\"hljs-type\">string</span>) (*bytes.Reader, <span class=\"hljs-type\">error</span>) {\n\tresult, err := client.s3.GetObject(*client.ctx, &#x26;s3.GetObjectInput{\n\t\tBucket: aws.String(bucketName),\n\t\tKey:    aws.String(objectKey),\n\t})\n\n\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {\n\t\tlog.Fatalf(<span class=\"hljs-string\">\"ê°ì²´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ %v:%v. ì›ì¸: %v\"</span>, bucketName, objectKey, err)\n\t\t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">nil</span>, err\n\t}\n\n\t<span class=\"hljs-keyword\">defer</span> result.Body.Close()\n\n\tbody, err := io.ReadAll(result.Body)\n\n\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {\n\t\tlog.Fatalf(<span class=\"hljs-string\">\"íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ. ì˜¤ë¥˜: %s\"</span>, err)\n\t\t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">nil</span>, err\n\t}\n\n\tfile := bytes.NewReader(body)\n\n\t<span class=\"hljs-keyword\">return</span> file, err\n}\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(client *awsClient)</span></span> uploadFile(bucketName <span class=\"hljs-type\">string</span>, originalObjectKey <span class=\"hljs-type\">string</span>, thumbnail io.Reader) <span class=\"hljs-type\">error</span> {\n\tobjectKeyParts := strings.Split(originalObjectKey, <span class=\"hljs-string\">\"/\"</span>)\n\tfileNameWithoutExtensions := strings.Split(objectKeyParts[<span class=\"hljs-built_in\">len</span>(objectKeyParts)<span class=\"hljs-number\">-1</span>], <span class=\"hljs-string\">\".\"</span>)[<span class=\"hljs-number\">0</span>]\n\tobjectKey := fmt.Sprintf(<span class=\"hljs-string\">\"thumbnails/%s_thumbnail.png\"</span>, fileNameWithoutExtensions)\n\n\t_, err := client.s3.PutObject(*client.ctx, &#x26;s3.PutObjectInput{\n\t\tBucket: aws.String(bucketName),\n\t\tKey:    aws.String(objectKey),\n\t\tBody:   thumbnail,\n\t})\n\n\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {\n\t\tlog.Fatalf(<span class=\"hljs-string\">\"%vì„(ë¥¼) %vì˜ %vì— ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŒ. ì›ì¸: %v\\n\"</span>,\n\t\t\toriginalObjectKey, bucketName, objectKey, err)\n\t}\n\n\t<span class=\"hljs-keyword\">return</span> err\n}\n\n<span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">()</span></span> {\n\tlambda.Start(handleRequest)\n}\n</code></pre>\n<p>ì´ì œ GitHub workflowë¥¼ ì„¤ì •í•˜ì—¬ ëŒë‹¤ ì½”ë“œë¥¼ ë°°í¬í•´ì•¼ í•©ë‹ˆë‹¤.</p>\n<p>.github/workflows í´ë”ì— deploy-lambda.ymlì´ë¼ëŠ” ìƒˆ íŒŒì¼ì„ ì¶”ê°€í•˜ê³  ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”:```</p>\n<pre><code class=\"hljs language-bash\">name: Deploy Thumbnail Generator Lambda\non:\n  push:\n    branches:\n      - main\n    paths:\n      - src/**/*\n      - .github/workflows/deploy-lambda.yml\n\ndefaults:\n  run:\n    working-directory: src/\n\n<span class=\"hljs-built_in\">jobs</span>:\n  terraform:\n    name: <span class=\"hljs-string\">'Deploy Thumbnail Generator Lambda'</span>\n    runs-on: ubuntu-latest\n    steps:\n      <span class=\"hljs-comment\"># Checkout the repository to the GitHub Actions runner</span>\n      - name: Checkout\n        uses: actions/checkout@v3\n\n      - uses: actions/setup-go@v4.1.0\n        with:\n          go-version: <span class=\"hljs-string\">'1.22.0'</span>\n\n      - name: Configure AWS Credentials Action For GitHub Actions\n        uses: aws-actions/configure-aws-credentials@v1\n        with:\n          aws-access-key-id: <span class=\"hljs-variable\">${ secrets.AWS_ACCESS_KEY }</span>\n          aws-secret-access-key: <span class=\"hljs-variable\">${ secrets.AWS_SECRET_ACCESS_KEY }</span>\n          aws-region: eu-central-1\n\n      - name: Build Lambda\n        run: GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o build/main .\n\n      - name: Zip build\n        run: zip -r -j main.zip ./build\n\n      - name: Update Lambda code\n        run: aws lambda update-function-code --function-name=thumbnail-generator --zip-file=fileb://main.zip\n</code></pre>\n<p>ì½”ë“œë¥¼ ì»¤ë°‹í•˜ê³  ë ˆí¬ì§€í† ë¦¬ì— í‘¸ì‹œí•˜ë©´ ë¹Œë“œê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.</p>\n<p>ì™„ë£Œë˜ë©´ Lambda í˜ì´ì§€ì˜ \"ìµœì¢… ìˆ˜ì •\" ì†ì„±ì„ í™•ì¸í•˜ì—¬ ë°°í¬ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:</p>\n<p>í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´ S3 ë²„í‚·ì˜ images/ í´ë”ì— ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤. ì—…ë¡œë“œê°€ ì„±ê³µí•˜ë©´ ì ì‹œ ê¸°ë‹¤ë¦° í›„ ìƒˆë¡œ ë§Œë“  ì„¬ë„¤ì¼ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>\n<h1>ê²°ë¡ </h1>\n<p>ì´ ê¸€ì—ì„œëŠ” Terraform ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ë¥¼ ì‚¬ìš©í•˜ì—¬ S3 ë²„í‚·, ëŒë‹¤, SNS, SNS ì•Œë¦¼ ë“±ì„ ìƒì„±í•˜ê³  ì—°ê²°í•˜ëŠ” ë°©ë²•ì„ ë°°ì› ìŠµë‹ˆë‹¤.</p>\n<p>ë˜í•œ S3 ì´ë²¤íŠ¸ë¥¼ SNS í† í”½ì— ë³´ë‚´ì–´ ì´ë¥¼ ë‹¤ë¥¸ ì†ŒìŠ¤(ë‹¤ë¥¸ SNS í† í”½ í¬í•¨)ë¡œ í™•ì‚°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ë„ ë°°ì› ìŠµë‹ˆë‹¤.</p>\n<p>ì €í¬ëŠ” Goë¡œ ì‘ì„±ëœ ëŒë‹¤ í•¨ìˆ˜ë„ ë§Œë“¤ì—ˆì–´ìš”. ì´ í•¨ìˆ˜ëŠ” SNS ë©”ì‹œì§€ë¥¼ í†µí•´ í˜¸ì¶œë˜ì–´ S3 ë²„í‚·ì—ì„œ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ê³  ì´ë¯¸ì§€ì—ì„œ ì¸ë„¤ì¼ì„ ìƒì„±í•œ ë‹¤ìŒ ì´ ì¸ë„¤ì¼ì„ S3ì— ì—…ë¡œë“œí•©ë‹ˆë‹¤.</p>\n<p>ì´ ê¸€ì˜ ì½”ë“œëŠ” ì—¬ê¸°ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.</p>\n<p>ì¦ê±°ìš´ ì½”ë”©í•˜ì„¸ìš”! ğŸ’»</p>\n</body>\n</html>\n"},"__N_SSG":true}