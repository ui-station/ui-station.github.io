{"pageProps":{"post":{"title":"클라우드 비용 요약 도구 만들기 가이드","description":"","date":"2024-06-27 19:29","slug":"2024-06-27-BuildingaCloudCostSummaryTool","content":"\n\n우리 회사에서는 클라우드 제공 업체로 Azure와 AWS를 사용하고 있어요. 두 플랫폼 모두 상당히 포괄적인 비용 분석 UI를 제공하지만, 재무 및 운영 팀 구성원들이 각 프로젝트의 이번 달 실제 비용과 예측을 독립적으로 확인하고 이전 달과 비교하기가 다소 어려웠어요.\n\n그래서 양 제공자로부터 이 데이터를 가져와 프로젝트별로 집계하고 노션 페이지에 요약하는 도구를 만들기로 결정했어요.\n\n# Azure 비용 가져오기\n\n<!-- ui-station 사각형 -->\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n작은 Go 애플리케이션을 시작하여 테넌트 내 모든 Azure 구독 및 비용을 가져 오고자했습니다. 또한 각 구독에 액세스 권한을 가진 사용자 목록을 가져 오고 싶었습니다.\n\n이를 위해 azure-sdk-for-go를 사용했는데, 구체적으로 azidentity, armsubscription 및 armauthorization 패키지를 사용했습니다. AzureAuthenticationService 및 AzureSubscriptionService를 구축하여 모든 Azure 구독과 해당 사용자 및 역할을 나열할 수 있도록했습니다.\n\n이 두 서비스의 사용 예제로 다음 코드는 모든 구독 및 해당 사용자 및 역할을 나열하는 방법을 보여줍니다:\n\n```js\nfunc main() {\n ctx := context.Background()\n\n cred, err := azidentity.NewDefaultAzureCredential(nil)\n if err != nil {\n  fmt.Println(\"[ERROR] Failed to authenticate with azure with error: \" + err.Error())\n  return\n }\n\n subscriptionService, err := AzureApi.NewAzureSubscriptionService(cred)\n if err != nil {\n  fmt.Println(\"[ERROR] Failed to instatiate subscription client with error: \" + err.Error())\n  return\n }\n\n subscriptions, err := subscriptionService.ListSubscriptions(ctx)\n if err != nil {\n  fmt.Println(\"[ERROR] Failed to get subscription with error: \" + err.Error())\n  return\n }\n\n for _, sub := range subscriptions {\n  authService, err := AzureApi.NewAzureAuthenticationService(cred, sub.SubscriptionID)\n  if err != nil {\n   fmt.Println(\"[ERROR] Failed to instatiate subscription client with error: \" + err.Error())\n   return\n  }\n  roles, err := authService.ListUserRoleAssignments(ctx)\n  if err != nil {\n   fmt.Println(\"[ERROR] Failed to instatiate subscription client with error: \" + err.Error())\n   return\n  }\n  fmt.Println(\"------------------------------------------------\")\n  fmt.Printf(\"Users for Subscription %s\\n\", sub.DisplayName)\n  for _, role := range roles {\n   fmt.Printf(\"%s %s\\n\", role.UserDisplayName, role.RoleName)\n  }\n }\n}\n```\n\n<!-- ui-station 사각형 -->\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n비용 관리 패키지인 armcostmanagement을 사용하여 필요한 정보를 검색할 수 있습니다.\n\n한편, 필요한 것을 모두 처리하는 오픈 소스 .NET 도구인 azure-cost-cli를 찾았습니다. 이 도구는 매우 완전한 JSON 보고서를 출력하는 것뿐만 아니라, 꽤 멋진 마크다운 출력도 가능했습니다. 그래서 완전히 처음부터 개발하는 대신에 이것을 사용하기로 결정했습니다.\n\n# Notion 보고서\n\nNotion은 Notion 워크스페이스에서 기존 콘텐츠를 생성하고 변경할 수 있게 해주는 좋은 REST API를 제공합니다. API 및 해당 콘텐츠에 접근하려면 API 키가 필요합니다. 이를 위해 통합을 만들고 필요한 권한을 부여해야 합니다. (여기에서 자세히 설명되어 있습니다).\n\n<!-- ui-station 사각형 -->\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n다음은 노션에서 만든 내용입니다:\n\n- 각 공급업체에 대한 합계 집계가 포함된 주요 요약 페이지\n- 각 공급업체별 페이지는 각 계정/구독에 대한 상세 정보가 포함되어 있습니다.\n- 계정/구독별 상세한 일별 정보가 포함된 페이지\n\n![이미지](/assets/img/2024-06-27-BuildingaCloudCostSummaryTool_1.png)\n\n![이미지](/assets/img/2024-06-27-BuildingaCloudCostSummaryTool_2.png)\n\n<!-- ui-station 사각형 -->\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n<img src=\"/assets/img/2024-06-27-BuildingaCloudCostSummaryTool_3.png\" />\n\nAzure와 AWS 페이지 모두 드릴 다운 세부 정보가 Notion 데이터베이스 구성요소에 저장되어 있었습니다. 그런 후 DB ID가 내 Go 어플리케이션으로 전달되어 구독 레벨이 업데이트된 정보를 매일 행마다 추가하거나 업데이트할 수 있도록 했습니다:\n\n- 이번 달 초부터 현재 날짜까지의 실제 비용\n- 현재 날짜부터 이번 달의 마지막 날까지의 예측 비용\n- 지난 달 총 비용\n- 소유권 데이터\n\n또한 각 행의 일별 세부 정보를 포함하는 일일 세부 정보 패널도 있습니다:\n\n<!-- ui-station 사각형 -->\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n- 하루당 비용\n- 향후 일일 비용 예측\n- 서비스 유형별 실제 비용\n- 위치별 실제 비용\n- 자원 그룹별 실제 비용\n- 이상 징후 감지 설명\n\nAPI를 사용하기 위해 go-notion이라는 오픈 소스 라이브러리를 사용했어요. 그런데 그 주위에 notion-client.go 래퍼를 구현해야 했어요. 이것은 AppendBlockChild 메서드에 필요한 누락된 After 매개변수 때문이었어요. 페이지의 끝이 아니라 항상 상단에 내용을 추가하기 위해 필요한 것이었죠 (소스 저장소로의 보류 중인 풀 리퀘스트).\n\n또한, notion-service.go도 구현되어 이 페이지에서 모든 콘텐츠 생성을 처리했어요.\n\n스크린샷에서도 알 수 있듯이 데이터베이스 뷰는 프로젝트 소유자와 내부 프로젝트 이름에 대한 정보도 포함하고 있어요. 이 정보는 다른 노션 데이터베이스에 보관되어 있으며, 응용 프로그램은 자동으로 두 데이터베이스 간의 관계 열을 업데이트하여 이 필드가 항상 최신 상태로 유지됩니다.\n\n<!-- ui-station 사각형 -->\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n최종적으로 Go 어플리케이션은 현재 및 과거 비용 및 이상 징후 JSON 보고서를 읽는 명령줄 도구로 변형되어, 필요한 집계를 수행하고 해당 노션 페이지를 생성/업데이트합니다.\n\nGo 어플리케이션을 호출하려면 다음과 같은 정보를 전달해야 합니다:\n\n- Azure 구독 ID 및 이름\n- 노션 API 비밀 키\n- 노션 구독 및 소유자 데이터베이스 ID\n- 현재 및 지난 달의 JSON 비용 보고서\n- 이상 징후 JSON 보고서\n\n예를 들어, 호출은 다음과 같이 보일 겁니다:\n\n<!-- ui-station 사각형 -->\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```bash\ngo run ./cmd/cost-analyser/main.go -id \"$SUBSCRIPTION_ID\" -name \"$SUBSCRIPTION_NAME\" -secret \"$NOTION_TOKEN\" -subscriptionsCostDatabaseId \"$NOTION_DATABASE_ID\" -subscriptionsOwnerDatabaseId \"$NOTION_OWNER_DATABASE_ID\" -inputActualReportJson \"$CURR_COST_DATA\" -inputPastReportJson \"$PAST_COST_DATA\" -anomaliesJson \"$ANOMALIES_COST_DATA\"\n```\n\n이는 Azure의 각 구독에 대해 호출해야 하지만, 이에 대해 자세히는 아래의 Github Actions 섹션을 참조해주세요.\n\n# AWS 비용 가져오기\n\nAWS 비용을 가져오기 위해 aws-sdk-go-v2 라이브러리를 사용한 또 다른 작은 Go 앱이 만들어졌습니다.\n\n\n<!-- ui-station 사각형 -->\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n다음은 AWS 계정과 해당 비용을 가져오는 데 책임이 있는 aws_cost_service.go를 사용했습니다.\n\n이후 비용 보고서를 우리 노션 서비스 이전에 사용한 동일한 구조로 변환하여 응용 프로그램은 Azure에 표시된 것과 유사한 AWS를 위한 노션 페이지를 작성합니다. aws-cost-retrieval 코드는 여기에서 찾을 수 있습니다.\n\n이 경우 하루에 한 번만 애플리케이션을 실행하면 모든 AWS 계정을 검토하고 한 번에 적절한 데이터 업데이트를 생성합니다. 다시 한 번 이 내용은 아래의 Github Actions 섹션에서 자세히 설명하겠습니다.\n\n# 요약 페이지 및 Slack\n\n<!-- ui-station 사각형 -->\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n위의 스크린샷에서 확인할 수 있듯이 매일 업데이트해야 하는 노션 요약 페이지가 있습니다. 또한 매주 제공자별로 요약된 집계 비용 정보를 포함하는 슬랙 채널 알림이 필요했습니다.\n\n이를 달성하기 위해 또 다른 작은 Go 애플리케이션인 slack-cost-summary를 개발했습니다.\n\n코드 자체가 매우 명확합니다. 이 애플리케이션은 Azure의 구독 비용을 아티팩트 폴더 내의 로컬 파일에서 읽은 다음 환경 변수를 통해 AWS의 비용을 읽어 공급자별로 비용을 집계하고 현재 요일이 구성된 요일과 일치하는 경우 슬랙 알림을 보냅니다.\n\n<!-- ui-station 사각형 -->\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n# Github 작업\n\n우리가 모든 필요한 요소를 갖추고 Notion에 보고서를 자동으로 추가하는 작업을 자동화하기만 하면 되었습니다. 이를 GitHub 워크플로에 구성된 일일 작업으로 설정하는 것이 필요했습니다.\n\n![이미지](/assets/img/2024-06-27-BuildingaCloudCostSummaryTool_5.png)\n\nAzure의 경우 비용 보고서를 가져오기 위해 기존 도구를 사용했습니다. 이 도구는 구독 수준에서 작동했기 때문에 먼저 모든 구독을 가져와야 했고, 그런 다음 각각의 구독을 위해 도구를 실행해야 했습니다 (현재 월용으로 3회, 이전 달용으로 1회, 그리고 이상 징후 보고서용으로 1회). 따라서 구독 목록을 가져오는 과정은 다음과 같습니다:\n\n<!-- ui-station 사각형 -->\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```js\nget-list-of-subscriptions:\n    runs-on: ubuntu-latest\n    steps:\n      - name: Azure 로그인\n        uses: azure/login@v2\n        with:\n          client-id: ${ secrets.AZURE_CLIENT_ID }\n          tenant-id: ${ secrets.AZURE_TENANT_ID }\n          allow-no-subscriptions: true\n\n      - name: 구독 목록 가져오기\n        id: setMatrix\n        run: echo \"subscriptions={\\\"subscription\\\":$(az account list --query '[].{Id:id,Name:name}' --output json | jq -c)}\" >> $GITHUB_OUTPUT\n    outputs:\n      matrix: ${ steps.setMatrix.outputs.subscriptions }\r\n```\n\n각 구독에 대해 작업은 구독 ID 및 구독명이 포함된 구독 개체를 출력합니다.\n\n이 작업과 병렬로 run-aws-costs-cli 작업에서는 AWS 데이터 수집기 Go 응용프로그램이 실행되어 모든 AWS 데이터를 업데이트합니다:\n\n```js\nrun-aws-costs-cli:\n    runs-on: ubuntu-latest\n    outputs:\n      subscriptions: ${ steps.setAwsSubscriptions.outputs.awsSubscriptions }\n    steps:\n      - name: 저장소 복제\n        uses: actions/checkout@v4\n      - name: AWS 자격 증명 구성\n        uses: aws-actions/configure-aws-credentials@v4\n        with:\n          role-to-assume: ${ env.AWS_ARN_BILLING_COLECTOR }\n          role-session-name: GitHub_to_AWS_via_FederatedOIDC\n          aws-region: ${ env.AWS_REGION }\n\n      - name: Go 1.21.x 설정\n        uses: actions/setup-go@v5\n        with:\n          go-version: 1.21.x\n\n      - name: Go 종속성 설치\n        run: go get ./...\n\n      - name: AWS 비용 실행\n        id: setAwsSubscriptions\n        env:\n          NOTION_TOKEN: ${ secrets.NOTION_TOKEN }\n          NOTION_DATABASE_ID: ${ secrets.NOTION_AWS_DATABASE_ID }\n          NOTION_OWNER_DATABASE_ID: ${ secrets.NOTION_OWNER_DATABASE_ID }\n        run: |\n          echo \"awsSubscriptions=$(go run ./cmd/aws-cost-retrieval/main.go -secret \"$NOTION_TOKEN\" -subscriptionsCostDatabaseId \"$NOTION_DATABASE_ID\" -subscriptionsOwnerDatabaseId \"$NOTION_OWNER_DATABASE_ID\" | jq -c)\" >> $GITHUB_OUTPUT\r\n```\n\n<!-- ui-station 사각형 -->\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n마지막에는 각 AWS 계정의 비용 보고서 목록이 awsSubscription 배열에 저장될 것입니다.\n\nget-list-of-subscriptions에 의해 출력된 각 Azure 구독마다, 다음 단계 구성으로 run-azure-cost-cli 작업이 생성됩니다:\n\n```js\nrun-azure-cost-cli:\n    name: Azure 구독용 비용 가져오기\n    runs-on: ubuntu-latest\n    needs: [get-list-of-subscriptions]\n    strategy:\n      max-parallel: 1\n      matrix: ${fromJson(needs.get-list-of-subscriptions.outputs.matrix)}\n    steps:\n      - name: Azure 로그인\n        uses: azure/login@v2\n        with:\n          client-id: ${secrets.AZURE_CLIENT_ID}\n          tenant-id: ${secrets.AZURE_TENANT_ID}\n          allow-no-subscriptions: true\n      - name: Azure 비용 CLI 설치\n        run: dotnet tool install -g azure-cost-cli --no-cache\n      - name: JSON 비용 DATA 가져오기\n        id: setCostData\n        run: |\n          day=$(date +%d)\n          if [ \"$day\" = \"01\" ]; then\n            from_two_months=$(date -d \"2 month ago\" \"+%Y/%m/01\")\n            to_two_months=$(date -d \"$(date -d \"month ago\" \"+%Y/%m/01\") - 1 day\" \"+%Y/%m/%d\")\n            from_last_month=$(date -d \"1 month ago\" \"+%Y/%m/01\")\n            to_last_month=$(date -d \"$(date \"+%Y/%m/01\") - 1 day\" \"+%Y/%m/%d\")\n            \n            PREV_DATA=$(azure-cost -o json --subscription ${matrix.subscription.Id} -t Custom --from ${from_two_months} --to ${to_two_months} | jq -c) \n            DATA=$(azure-cost -o json --subscription ${matrix.subscription.Id} -t Custom --from ${from_last_month} --to ${to_last_month} | jq -c)\n            \n            echo \"prevDataJson=$PREV_DATA\" >> $GITHUB_OUTPUT\n            echo \"dataJson=$DATA\" >> $GITHUB_OUTPUT\n          else\n            PREV_DATA=$(azure-cost -o json --subscription ${matrix.subscription.Id} -t TheLastBillingMonth | jq -c)\n            DATA=$(azure-cost -o json --subscription ${matrix.subscription.Id} | jq -c)\n              \n            echo \"prevDataJson=$PREV_DATA\" >> $GITHUB_OUTPUT\n            echo \"dataJson=$DATA\" >> $GITHUB_OUTPUT\n          fi\n          ANOMALIES=$(azure-cost detectAnomalies -o json --subscription ${matrix.subscription.Id} | jq -c)\n          echo \"anomaliesDataJson=$ANOMALIES\" >> $GITHUB_OUTPUT\n      - name: Markdown 형식으로 포맷팅\n        run: |\n          if echo '${steps.setCostData.outputs.dataJson}' | jq -c -r '.cost'| jq -e '. == []'; then\n            echo \"> 이 시기에는 ${matrix.subscription.Name} 구독에 대한 비용이 없습니다.\" >> $GITHUB_STEP_SUMMARY\n          else\n            day=$(date +%d)\n            if [ \"$day\" = \"01\" ]; then\n              from_last_month=$(date -d \"1 month ago\" \"+%Y/%m/01\")\n              to_last_month=$(date -d \"$(date \"+%Y/%m/01\") - 1 day\" \"+%Y/%m/%d\")\n              azure-cost -o markdown --subscription ${matrix.subscription.Id} -t Custom --from ${from_last_month} --to ${to_last_month} >> $GITHUB_STEP_SUMMARY\n            else\n              azure-cost -o markdown --subscription ${matrix.subscription.Id} >> $GITHUB_STEP_SUMMARY\n            fi\n          fi\n      - uses: actions/checkout@v4\n      - name: Go 1.21.x 설정\n        uses: actions/setup-go@v5\n        with:\n          go-version: 1.21.x\n      - name: Go 종속성 설치\n        run: go get ./...\n      - name: Notion으로 배포\n        env:\n          NOTION_TOKEN: ${secrets.NOTION_TOKEN}\n          NOTION_DATABASE_ID: ${secrets.NOTION_DATABASE_ID}\n          SUBSCRIPTION_ID: ${matrix.subscription.Id}\n          SUBSCRIPTION_NAME: ${matrix.subscription.Name}\n          NOTION_OWNER_DATABASE_ID: ${secrets.NOTION_OWNER_DATABASE_ID}\n        run: |\n          CURR_COST_DATA=\"$(echo '${steps.setCostData.outputs.dataJson}' | base64)\"\n          PAST_COST_DATA=\"$(echo '${steps.setCostData.outputs.prevDataJson}' | base64)\"\n          ANOMALIES_COST_DATA=\"$(echo '${steps.setCostData.outputs.anomaliesDataJson}' | base64)\"\n          go run ./cmd/cost-analyser/main.go -id \"$SUBSCRIPTION_ID\" -name \"$SUBSCRIPTION_NAME\" -secret \"$NOTION_TOKEN\" -subscriptionsCostDatabaseId \"$NOTION_DATABASE_ID\" -subscriptionsOwnerDatabaseId \"$NOTION_OWNER_DATABASE_ID\" -inputActualReportJson \"$CURR_COST_DATA\" -inputPastReportJson \"$PAST_COST_DATA\" -anomaliesJson \"$ANOMALIES_COST_DATA\" >> ${matrix.subscription.Id}.json\n      - name: Output 업로드\n        uses: actions/upload-artifact@v4\n        with:\n          name: artifact-${matrix.subscription.Id}\n          path: ${matrix.subscription.Id}.json\n          if-no-files-found: warn\n```\n\nAzure API의 시간 초과 또는 요율 제한 문제로 인해 병렬로 더 많은 작업을 실행할 경우에도 한 번에 1개의 작업을 실행합니다. 주요 단계는 다음과 같습니다:\n\n<!-- ui-station 사각형 -->\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n- Get JSON 비용 데이터는 이전 및 현재 일일 비용 보고서를 얻을 것입니다.\n- Markdown 형식에서 현재 월 보고서를 얻어 Markdown 형식으로 포맷팅하여 GITHUB_STEP_SUMMARY에 출력하여 GitHub 작업 요약 페이지에서 볼 수 있게 합니다.\n- Notion에 배포는 특정 구독을 위한 보고서를 업데이트하기 위해 Notion Go 애플리케이션을 실행합니다.\n- 출력 업로드는 이후 summarise-and-notify 단계에서 사용할 비용 보고서 출력을 아티팩트로 저장합니다.\n\nsummarise-and-notify 작업은 모든 run-azure-cost-cli 및 run-aws-costs-cli 작업이 완료된 후에만 실행되며, summary 및 slack 알림을 위해 작동합니다:\n\n```js\nsummarise-and-notify:\n    runs-on: ubuntu-latest\n    needs: [run-azure-cost-cli, run-aws-costs-cli]\n    env:\n      SUBSCRIPTIONS: ${needs.run-aws-costs-cli.outputs.subscriptions}\n      SLACK_CHANNEL_WEBHOOK: ${secrets.SLACK_CHANNEL_WEBHOOK}\n      TRIGGER_MESSAGE_DAY: ${vars.TRIGGER_MESSAGE_DAY}\n      NOTION_AWS_PAGE_URL: ${vars.NOTION_AWS_PAGE_URL}\n      NOTION_AZURE_PAGE_URL: ${vars.NOTION_AZURE_PAGE_URL}\n      NOTION_TOKEN: ${secrets.NOTION_TOKEN}\n      NOTION_COST_SUMMARY_PAGE: ${vars.NOTION_COST_SUMMARY_PAGE}\n    steps:\n      - uses: actions/checkout@v4\n      - name: Setup Go 1.21.x\n        uses: actions/setup-go@v5\n        with:\n          go-version: 1.21.x\n      - name: Install go dependencies\n        run: go get ./...\n      - name: \"Download matrix outputs\"\n        uses: actions/download-artifact@v4\n        with:\n          path: artifact\n          pattern: artifact-*\n          merge-multiple: true\n      - name: \"Notify to slack\"\n        run: |\n          go run ./cmd/slack-cost-summary\n```\n\n마지막으로 실패한 작업을 자동으로 다시 시도할 수 있도록 re-run-azure-cost-cli 작업이 추가되었습니다. 병렬 작업을 실행하지 않더라도 때로는 azure API가 실패할 수 있습니다. 따라서 임시적인 azure API 실패를 제거하는 데 충분한 5번의 시도로 실패한 작업을 다시 시도하는 메커니즘을 추가했습니다:\n\n<!-- ui-station 사각형 -->\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n\n재실행-azure-cost-cli:\n    이름: 실패한 작업 다시 실행하는 워크플로우 호출\n    needs: run-azure-cost-cli\n    if: failure() && fromJSON(github.run_attempt) < 5\n    runs-on: ubuntu-latest\n    steps:\n      - env:\n          GH_REPO: ${ github.repository }\n          GH_TOKEN: ${ github.token }\n          GH_DEBUG: api\n        run: gh workflow run rerun.yml -F run_id=${ github.run_id }\n\n\n\n이름: 실패한 작업 다시 실행하는 워크플로우\n\npermissions:\n  actions: write\n\non:\n  workflow_dispatch:\n    inputs:\n      run_id:\n        required: true\njobs:\n  rerun:\n    runs-on: ubuntu-latest\n    steps:\n      - name: ${ inputs.run_id } 다시 실행\n        env:\n          GH_REPO: ${ github.repository }\n          GH_TOKEN: ${ github.token }\n          GH_DEBUG: api\n        run: |\n          gh run watch ${ inputs.run_id } > /dev/null 2>&1\n          gh run rerun ${ inputs.run_id } --failed\n","ogImage":{"url":"/assets/img/2024-06-27-BuildingaCloudCostSummaryTool_0.png"},"coverImage":"/assets/img/2024-06-27-BuildingaCloudCostSummaryTool_0.png","tag":["Tech"],"readingTime":18},"content":"<!doctype html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\">\n<meta content=\"width=device-width, initial-scale=1\" name=\"viewport\">\n</head>\n<body>\n<p>우리 회사에서는 클라우드 제공 업체로 Azure와 AWS를 사용하고 있어요. 두 플랫폼 모두 상당히 포괄적인 비용 분석 UI를 제공하지만, 재무 및 운영 팀 구성원들이 각 프로젝트의 이번 달 실제 비용과 예측을 독립적으로 확인하고 이전 달과 비교하기가 다소 어려웠어요.</p>\n<p>그래서 양 제공자로부터 이 데이터를 가져와 프로젝트별로 집계하고 노션 페이지에 요약하는 도구를 만들기로 결정했어요.</p>\n<h1>Azure 비용 가져오기</h1>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>작은 Go 애플리케이션을 시작하여 테넌트 내 모든 Azure 구독 및 비용을 가져 오고자했습니다. 또한 각 구독에 액세스 권한을 가진 사용자 목록을 가져 오고 싶었습니다.</p>\n<p>이를 위해 azure-sdk-for-go를 사용했는데, 구체적으로 azidentity, armsubscription 및 armauthorization 패키지를 사용했습니다. AzureAuthenticationService 및 AzureSubscriptionService를 구축하여 모든 Azure 구독과 해당 사용자 및 역할을 나열할 수 있도록했습니다.</p>\n<p>이 두 서비스의 사용 예제로 다음 코드는 모든 구독 및 해당 사용자 및 역할을 나열하는 방법을 보여줍니다:</p>\n<pre><code class=\"hljs language-js\">func <span class=\"hljs-title function_\">main</span>(<span class=\"hljs-params\"></span>) {\n ctx := context.<span class=\"hljs-title class_\">Background</span>()\n\n cred, err := azidentity.<span class=\"hljs-title class_\">NewDefaultAzureCredential</span>(nil)\n <span class=\"hljs-keyword\">if</span> err != nil {\n  fmt.<span class=\"hljs-title class_\">Println</span>(<span class=\"hljs-string\">\"[ERROR] Failed to authenticate with azure with error: \"</span> + err.<span class=\"hljs-title class_\">Error</span>())\n  <span class=\"hljs-keyword\">return</span>\n }\n\n subscriptionService, err := <span class=\"hljs-title class_\">AzureApi</span>.<span class=\"hljs-title class_\">NewAzureSubscriptionService</span>(cred)\n <span class=\"hljs-keyword\">if</span> err != nil {\n  fmt.<span class=\"hljs-title class_\">Println</span>(<span class=\"hljs-string\">\"[ERROR] Failed to instatiate subscription client with error: \"</span> + err.<span class=\"hljs-title class_\">Error</span>())\n  <span class=\"hljs-keyword\">return</span>\n }\n\n subscriptions, err := subscriptionService.<span class=\"hljs-title class_\">ListSubscriptions</span>(ctx)\n <span class=\"hljs-keyword\">if</span> err != nil {\n  fmt.<span class=\"hljs-title class_\">Println</span>(<span class=\"hljs-string\">\"[ERROR] Failed to get subscription with error: \"</span> + err.<span class=\"hljs-title class_\">Error</span>())\n  <span class=\"hljs-keyword\">return</span>\n }\n\n <span class=\"hljs-keyword\">for</span> _, sub := range subscriptions {\n  authService, err := <span class=\"hljs-title class_\">AzureApi</span>.<span class=\"hljs-title class_\">NewAzureAuthenticationService</span>(cred, sub.<span class=\"hljs-property\">SubscriptionID</span>)\n  <span class=\"hljs-keyword\">if</span> err != nil {\n   fmt.<span class=\"hljs-title class_\">Println</span>(<span class=\"hljs-string\">\"[ERROR] Failed to instatiate subscription client with error: \"</span> + err.<span class=\"hljs-title class_\">Error</span>())\n   <span class=\"hljs-keyword\">return</span>\n  }\n  roles, err := authService.<span class=\"hljs-title class_\">ListUserRoleAssignments</span>(ctx)\n  <span class=\"hljs-keyword\">if</span> err != nil {\n   fmt.<span class=\"hljs-title class_\">Println</span>(<span class=\"hljs-string\">\"[ERROR] Failed to instatiate subscription client with error: \"</span> + err.<span class=\"hljs-title class_\">Error</span>())\n   <span class=\"hljs-keyword\">return</span>\n  }\n  fmt.<span class=\"hljs-title class_\">Println</span>(<span class=\"hljs-string\">\"------------------------------------------------\"</span>)\n  fmt.<span class=\"hljs-title class_\">Printf</span>(<span class=\"hljs-string\">\"Users for Subscription %s\\n\"</span>, sub.<span class=\"hljs-property\">DisplayName</span>)\n  <span class=\"hljs-keyword\">for</span> _, role := range roles {\n   fmt.<span class=\"hljs-title class_\">Printf</span>(<span class=\"hljs-string\">\"%s %s\\n\"</span>, role.<span class=\"hljs-property\">UserDisplayName</span>, role.<span class=\"hljs-property\">RoleName</span>)\n  }\n }\n}\n</code></pre>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>비용 관리 패키지인 armcostmanagement을 사용하여 필요한 정보를 검색할 수 있습니다.</p>\n<p>한편, 필요한 것을 모두 처리하는 오픈 소스 .NET 도구인 azure-cost-cli를 찾았습니다. 이 도구는 매우 완전한 JSON 보고서를 출력하는 것뿐만 아니라, 꽤 멋진 마크다운 출력도 가능했습니다. 그래서 완전히 처음부터 개발하는 대신에 이것을 사용하기로 결정했습니다.</p>\n<h1>Notion 보고서</h1>\n<p>Notion은 Notion 워크스페이스에서 기존 콘텐츠를 생성하고 변경할 수 있게 해주는 좋은 REST API를 제공합니다. API 및 해당 콘텐츠에 접근하려면 API 키가 필요합니다. 이를 위해 통합을 만들고 필요한 권한을 부여해야 합니다. (여기에서 자세히 설명되어 있습니다).</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>다음은 노션에서 만든 내용입니다:</p>\n<ul>\n<li>각 공급업체에 대한 합계 집계가 포함된 주요 요약 페이지</li>\n<li>각 공급업체별 페이지는 각 계정/구독에 대한 상세 정보가 포함되어 있습니다.</li>\n<li>계정/구독별 상세한 일별 정보가 포함된 페이지</li>\n</ul>\n<p><img src=\"/assets/img/2024-06-27-BuildingaCloudCostSummaryTool_1.png\" alt=\"이미지\"></p>\n<p><img src=\"/assets/img/2024-06-27-BuildingaCloudCostSummaryTool_2.png\" alt=\"이미지\"></p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<img src=\"/assets/img/2024-06-27-BuildingaCloudCostSummaryTool_3.png\">\n<p>Azure와 AWS 페이지 모두 드릴 다운 세부 정보가 Notion 데이터베이스 구성요소에 저장되어 있었습니다. 그런 후 DB ID가 내 Go 어플리케이션으로 전달되어 구독 레벨이 업데이트된 정보를 매일 행마다 추가하거나 업데이트할 수 있도록 했습니다:</p>\n<ul>\n<li>이번 달 초부터 현재 날짜까지의 실제 비용</li>\n<li>현재 날짜부터 이번 달의 마지막 날까지의 예측 비용</li>\n<li>지난 달 총 비용</li>\n<li>소유권 데이터</li>\n</ul>\n<p>또한 각 행의 일별 세부 정보를 포함하는 일일 세부 정보 패널도 있습니다:</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<ul>\n<li>하루당 비용</li>\n<li>향후 일일 비용 예측</li>\n<li>서비스 유형별 실제 비용</li>\n<li>위치별 실제 비용</li>\n<li>자원 그룹별 실제 비용</li>\n<li>이상 징후 감지 설명</li>\n</ul>\n<p>API를 사용하기 위해 go-notion이라는 오픈 소스 라이브러리를 사용했어요. 그런데 그 주위에 notion-client.go 래퍼를 구현해야 했어요. 이것은 AppendBlockChild 메서드에 필요한 누락된 After 매개변수 때문이었어요. 페이지의 끝이 아니라 항상 상단에 내용을 추가하기 위해 필요한 것이었죠 (소스 저장소로의 보류 중인 풀 리퀘스트).</p>\n<p>또한, notion-service.go도 구현되어 이 페이지에서 모든 콘텐츠 생성을 처리했어요.</p>\n<p>스크린샷에서도 알 수 있듯이 데이터베이스 뷰는 프로젝트 소유자와 내부 프로젝트 이름에 대한 정보도 포함하고 있어요. 이 정보는 다른 노션 데이터베이스에 보관되어 있으며, 응용 프로그램은 자동으로 두 데이터베이스 간의 관계 열을 업데이트하여 이 필드가 항상 최신 상태로 유지됩니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>최종적으로 Go 어플리케이션은 현재 및 과거 비용 및 이상 징후 JSON 보고서를 읽는 명령줄 도구로 변형되어, 필요한 집계를 수행하고 해당 노션 페이지를 생성/업데이트합니다.</p>\n<p>Go 어플리케이션을 호출하려면 다음과 같은 정보를 전달해야 합니다:</p>\n<ul>\n<li>Azure 구독 ID 및 이름</li>\n<li>노션 API 비밀 키</li>\n<li>노션 구독 및 소유자 데이터베이스 ID</li>\n<li>현재 및 지난 달의 JSON 비용 보고서</li>\n<li>이상 징후 JSON 보고서</li>\n</ul>\n<p>예를 들어, 호출은 다음과 같이 보일 겁니다:</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<pre><code class=\"hljs language-bash\">go run ./cmd/cost-analyser/main.go -<span class=\"hljs-built_in\">id</span> <span class=\"hljs-string\">\"<span class=\"hljs-variable\">$SUBSCRIPTION_ID</span>\"</span> -name <span class=\"hljs-string\">\"<span class=\"hljs-variable\">$SUBSCRIPTION_NAME</span>\"</span> -secret <span class=\"hljs-string\">\"<span class=\"hljs-variable\">$NOTION_TOKEN</span>\"</span> -subscriptionsCostDatabaseId <span class=\"hljs-string\">\"<span class=\"hljs-variable\">$NOTION_DATABASE_ID</span>\"</span> -subscriptionsOwnerDatabaseId <span class=\"hljs-string\">\"<span class=\"hljs-variable\">$NOTION_OWNER_DATABASE_ID</span>\"</span> -inputActualReportJson <span class=\"hljs-string\">\"<span class=\"hljs-variable\">$CURR_COST_DATA</span>\"</span> -inputPastReportJson <span class=\"hljs-string\">\"<span class=\"hljs-variable\">$PAST_COST_DATA</span>\"</span> -anomaliesJson <span class=\"hljs-string\">\"<span class=\"hljs-variable\">$ANOMALIES_COST_DATA</span>\"</span>\n</code></pre>\n<p>이는 Azure의 각 구독에 대해 호출해야 하지만, 이에 대해 자세히는 아래의 Github Actions 섹션을 참조해주세요.</p>\n<h1>AWS 비용 가져오기</h1>\n<p>AWS 비용을 가져오기 위해 aws-sdk-go-v2 라이브러리를 사용한 또 다른 작은 Go 앱이 만들어졌습니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>다음은 AWS 계정과 해당 비용을 가져오는 데 책임이 있는 aws_cost_service.go를 사용했습니다.</p>\n<p>이후 비용 보고서를 우리 노션 서비스 이전에 사용한 동일한 구조로 변환하여 응용 프로그램은 Azure에 표시된 것과 유사한 AWS를 위한 노션 페이지를 작성합니다. aws-cost-retrieval 코드는 여기에서 찾을 수 있습니다.</p>\n<p>이 경우 하루에 한 번만 애플리케이션을 실행하면 모든 AWS 계정을 검토하고 한 번에 적절한 데이터 업데이트를 생성합니다. 다시 한 번 이 내용은 아래의 Github Actions 섹션에서 자세히 설명하겠습니다.</p>\n<h1>요약 페이지 및 Slack</h1>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>위의 스크린샷에서 확인할 수 있듯이 매일 업데이트해야 하는 노션 요약 페이지가 있습니다. 또한 매주 제공자별로 요약된 집계 비용 정보를 포함하는 슬랙 채널 알림이 필요했습니다.</p>\n<p>이를 달성하기 위해 또 다른 작은 Go 애플리케이션인 slack-cost-summary를 개발했습니다.</p>\n<p>코드 자체가 매우 명확합니다. 이 애플리케이션은 Azure의 구독 비용을 아티팩트 폴더 내의 로컬 파일에서 읽은 다음 환경 변수를 통해 AWS의 비용을 읽어 공급자별로 비용을 집계하고 현재 요일이 구성된 요일과 일치하는 경우 슬랙 알림을 보냅니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<h1>Github 작업</h1>\n<p>우리가 모든 필요한 요소를 갖추고 Notion에 보고서를 자동으로 추가하는 작업을 자동화하기만 하면 되었습니다. 이를 GitHub 워크플로에 구성된 일일 작업으로 설정하는 것이 필요했습니다.</p>\n<p><img src=\"/assets/img/2024-06-27-BuildingaCloudCostSummaryTool_5.png\" alt=\"이미지\"></p>\n<p>Azure의 경우 비용 보고서를 가져오기 위해 기존 도구를 사용했습니다. 이 도구는 구독 수준에서 작동했기 때문에 먼저 모든 구독을 가져와야 했고, 그런 다음 각각의 구독을 위해 도구를 실행해야 했습니다 (현재 월용으로 3회, 이전 달용으로 1회, 그리고 이상 징후 보고서용으로 1회). 따라서 구독 목록을 가져오는 과정은 다음과 같습니다:</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<pre><code class=\"hljs language-js\">get-list-<span class=\"hljs-keyword\">of</span>-<span class=\"hljs-attr\">subscriptions</span>:\n    runs-<span class=\"hljs-attr\">on</span>: ubuntu-latest\n    <span class=\"hljs-attr\">steps</span>:\n      - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-title class_\">Azure</span> 로그인\n        <span class=\"hljs-attr\">uses</span>: azure/login@v2\n        <span class=\"hljs-attr\">with</span>:\n          client-<span class=\"hljs-attr\">id</span>: ${ secrets.<span class=\"hljs-property\">AZURE_CLIENT_ID</span> }\n          tenant-<span class=\"hljs-attr\">id</span>: ${ secrets.<span class=\"hljs-property\">AZURE_TENANT_ID</span> }\n          allow-no-<span class=\"hljs-attr\">subscriptions</span>: <span class=\"hljs-literal\">true</span>\n\n      - <span class=\"hljs-attr\">name</span>: 구독 목록 가져오기\n        <span class=\"hljs-attr\">id</span>: setMatrix\n        <span class=\"hljs-attr\">run</span>: echo <span class=\"hljs-string\">\"subscriptions={\\\"subscription\\\":$(az account list --query '[].{Id:id,Name:name}' --output json | jq -c)}\"</span> >> $GITHUB_OUTPUT\n    <span class=\"hljs-attr\">outputs</span>:\n      <span class=\"hljs-attr\">matrix</span>: ${ steps.<span class=\"hljs-property\">setMatrix</span>.<span class=\"hljs-property\">outputs</span>.<span class=\"hljs-property\">subscriptions</span> }\n</code></pre>\n<p>각 구독에 대해 작업은 구독 ID 및 구독명이 포함된 구독 개체를 출력합니다.</p>\n<p>이 작업과 병렬로 run-aws-costs-cli 작업에서는 AWS 데이터 수집기 Go 응용프로그램이 실행되어 모든 AWS 데이터를 업데이트합니다:</p>\n<pre><code class=\"hljs language-js\">run-aws-costs-<span class=\"hljs-attr\">cli</span>:\n    runs-<span class=\"hljs-attr\">on</span>: ubuntu-latest\n    <span class=\"hljs-attr\">outputs</span>:\n      <span class=\"hljs-attr\">subscriptions</span>: ${ steps.<span class=\"hljs-property\">setAwsSubscriptions</span>.<span class=\"hljs-property\">outputs</span>.<span class=\"hljs-property\">awsSubscriptions</span> }\n    <span class=\"hljs-attr\">steps</span>:\n      - <span class=\"hljs-attr\">name</span>: 저장소 복제\n        <span class=\"hljs-attr\">uses</span>: actions/checkout@v4\n      - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-variable constant_\">AWS</span> 자격 증명 구성\n        <span class=\"hljs-attr\">uses</span>: aws-actions/configure-aws-credentials@v4\n        <span class=\"hljs-attr\">with</span>:\n          role-to-<span class=\"hljs-attr\">assume</span>: ${ env.<span class=\"hljs-property\">AWS_ARN_BILLING_COLECTOR</span> }\n          role-session-<span class=\"hljs-attr\">name</span>: <span class=\"hljs-title class_\">GitHub</span>_to_AWS_via_FederatedOIDC\n          aws-<span class=\"hljs-attr\">region</span>: ${ env.<span class=\"hljs-property\">AWS_REGION</span> }\n\n      - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-title class_\">Go</span> <span class=\"hljs-number\">1.21</span>.<span class=\"hljs-property\">x</span> 설정\n        <span class=\"hljs-attr\">uses</span>: actions/setup-go@v5\n        <span class=\"hljs-attr\">with</span>:\n          go-<span class=\"hljs-attr\">version</span>: <span class=\"hljs-number\">1.21</span>.<span class=\"hljs-property\">x</span>\n\n      - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-title class_\">Go</span> 종속성 설치\n        <span class=\"hljs-attr\">run</span>: go get ./...\n\n      - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-variable constant_\">AWS</span> 비용 실행\n        <span class=\"hljs-attr\">id</span>: setAwsSubscriptions\n        <span class=\"hljs-attr\">env</span>:\n          <span class=\"hljs-attr\">NOTION_TOKEN</span>: ${ secrets.<span class=\"hljs-property\">NOTION_TOKEN</span> }\n          <span class=\"hljs-attr\">NOTION_DATABASE_ID</span>: ${ secrets.<span class=\"hljs-property\">NOTION_AWS_DATABASE_ID</span> }\n          <span class=\"hljs-attr\">NOTION_OWNER_DATABASE_ID</span>: ${ secrets.<span class=\"hljs-property\">NOTION_OWNER_DATABASE_ID</span> }\n        <span class=\"hljs-attr\">run</span>: |\n          echo <span class=\"hljs-string\">\"awsSubscriptions=$(go run ./cmd/aws-cost-retrieval/main.go -secret \"</span>$NOTION_TOKEN<span class=\"hljs-string\">\" -subscriptionsCostDatabaseId \"</span>$NOTION_DATABASE_ID<span class=\"hljs-string\">\" -subscriptionsOwnerDatabaseId \"</span>$NOTION_OWNER_DATABASE_ID<span class=\"hljs-string\">\" | jq -c)\"</span> >> $GITHUB_OUTPUT\n</code></pre>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>마지막에는 각 AWS 계정의 비용 보고서 목록이 awsSubscription 배열에 저장될 것입니다.</p>\n<p>get-list-of-subscriptions에 의해 출력된 각 Azure 구독마다, 다음 단계 구성으로 run-azure-cost-cli 작업이 생성됩니다:</p>\n<pre><code class=\"hljs language-js\">run-azure-cost-<span class=\"hljs-attr\">cli</span>:\n    <span class=\"hljs-attr\">name</span>: <span class=\"hljs-title class_\">Azure</span> 구독용 비용 가져오기\n    runs-<span class=\"hljs-attr\">on</span>: ubuntu-latest\n    <span class=\"hljs-attr\">needs</span>: [get-list-<span class=\"hljs-keyword\">of</span>-subscriptions]\n    <span class=\"hljs-attr\">strategy</span>:\n      max-<span class=\"hljs-attr\">parallel</span>: <span class=\"hljs-number\">1</span>\n      <span class=\"hljs-attr\">matrix</span>: ${<span class=\"hljs-title function_\">fromJson</span>(needs.<span class=\"hljs-property\">get</span>-list-<span class=\"hljs-keyword\">of</span>-subscriptions.<span class=\"hljs-property\">outputs</span>.<span class=\"hljs-property\">matrix</span>)}\n    <span class=\"hljs-attr\">steps</span>:\n      - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-title class_\">Azure</span> 로그인\n        <span class=\"hljs-attr\">uses</span>: azure/login@v2\n        <span class=\"hljs-attr\">with</span>:\n          client-<span class=\"hljs-attr\">id</span>: ${secrets.<span class=\"hljs-property\">AZURE_CLIENT_ID</span>}\n          tenant-<span class=\"hljs-attr\">id</span>: ${secrets.<span class=\"hljs-property\">AZURE_TENANT_ID</span>}\n          allow-no-<span class=\"hljs-attr\">subscriptions</span>: <span class=\"hljs-literal\">true</span>\n      - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-title class_\">Azure</span> 비용 <span class=\"hljs-variable constant_\">CLI</span> 설치\n        <span class=\"hljs-attr\">run</span>: dotnet tool install -g azure-cost-cli --no-cache\n      - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-title class_\">JSON</span> 비용 <span class=\"hljs-variable constant_\">DATA</span> 가져오기\n        <span class=\"hljs-attr\">id</span>: setCostData\n        <span class=\"hljs-attr\">run</span>: |\n          day=$(date +%d)\n          <span class=\"hljs-keyword\">if</span> [ <span class=\"hljs-string\">\"$day\"</span> = <span class=\"hljs-string\">\"01\"</span> ]; then\n            from_two_months=$(date -d <span class=\"hljs-string\">\"2 month ago\"</span> <span class=\"hljs-string\">\"+%Y/%m/01\"</span>)\n            to_two_months=$(date -d <span class=\"hljs-string\">\"$(date -d \"</span>month ago<span class=\"hljs-string\">\" \"</span>+%Y/%m/<span class=\"hljs-number\">01</span><span class=\"hljs-string\">\") - 1 day\"</span> <span class=\"hljs-string\">\"+%Y/%m/%d\"</span>)\n            from_last_month=$(date -d <span class=\"hljs-string\">\"1 month ago\"</span> <span class=\"hljs-string\">\"+%Y/%m/01\"</span>)\n            to_last_month=$(date -d <span class=\"hljs-string\">\"$(date \"</span>+%Y/%m/<span class=\"hljs-number\">01</span><span class=\"hljs-string\">\") - 1 day\"</span> <span class=\"hljs-string\">\"+%Y/%m/%d\"</span>)\n            \n            <span class=\"hljs-variable constant_\">PREV_DATA</span>=$(azure-cost -o json --subscription ${matrix.<span class=\"hljs-property\">subscription</span>.<span class=\"hljs-property\">Id</span>} -t <span class=\"hljs-title class_\">Custom</span> --<span class=\"hljs-keyword\">from</span> ${from_two_months} --to ${to_two_months} | jq -c) \n            <span class=\"hljs-variable constant_\">DATA</span>=$(azure-cost -o json --subscription ${matrix.<span class=\"hljs-property\">subscription</span>.<span class=\"hljs-property\">Id</span>} -t <span class=\"hljs-title class_\">Custom</span> --<span class=\"hljs-keyword\">from</span> ${from_last_month} --to ${to_last_month} | jq -c)\n            \n            echo <span class=\"hljs-string\">\"prevDataJson=$PREV_DATA\"</span> >> $GITHUB_OUTPUT\n            echo <span class=\"hljs-string\">\"dataJson=$DATA\"</span> >> $GITHUB_OUTPUT\n          <span class=\"hljs-keyword\">else</span>\n            <span class=\"hljs-variable constant_\">PREV_DATA</span>=$(azure-cost -o json --subscription ${matrix.<span class=\"hljs-property\">subscription</span>.<span class=\"hljs-property\">Id</span>} -t <span class=\"hljs-title class_\">TheLastBillingMonth</span> | jq -c)\n            <span class=\"hljs-variable constant_\">DATA</span>=$(azure-cost -o json --subscription ${matrix.<span class=\"hljs-property\">subscription</span>.<span class=\"hljs-property\">Id</span>} | jq -c)\n              \n            echo <span class=\"hljs-string\">\"prevDataJson=$PREV_DATA\"</span> >> $GITHUB_OUTPUT\n            echo <span class=\"hljs-string\">\"dataJson=$DATA\"</span> >> $GITHUB_OUTPUT\n          fi\n          <span class=\"hljs-variable constant_\">ANOMALIES</span>=$(azure-cost detectAnomalies -o json --subscription ${matrix.<span class=\"hljs-property\">subscription</span>.<span class=\"hljs-property\">Id</span>} | jq -c)\n          echo <span class=\"hljs-string\">\"anomaliesDataJson=$ANOMALIES\"</span> >> $GITHUB_OUTPUT\n      - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-title class_\">Markdown</span> 형식으로 포맷팅\n        <span class=\"hljs-attr\">run</span>: |\n          <span class=\"hljs-keyword\">if</span> echo <span class=\"hljs-string\">'${steps.setCostData.outputs.dataJson}'</span> | jq -c -r <span class=\"hljs-string\">'.cost'</span>| jq -e <span class=\"hljs-string\">'. == []'</span>; then\n            echo <span class=\"hljs-string\">\"> 이 시기에는 ${matrix.subscription.Name} 구독에 대한 비용이 없습니다.\"</span> >> $GITHUB_STEP_SUMMARY\n          <span class=\"hljs-keyword\">else</span>\n            day=$(date +%d)\n            <span class=\"hljs-keyword\">if</span> [ <span class=\"hljs-string\">\"$day\"</span> = <span class=\"hljs-string\">\"01\"</span> ]; then\n              from_last_month=$(date -d <span class=\"hljs-string\">\"1 month ago\"</span> <span class=\"hljs-string\">\"+%Y/%m/01\"</span>)\n              to_last_month=$(date -d <span class=\"hljs-string\">\"$(date \"</span>+%Y/%m/<span class=\"hljs-number\">01</span><span class=\"hljs-string\">\") - 1 day\"</span> <span class=\"hljs-string\">\"+%Y/%m/%d\"</span>)\n              azure-cost -o markdown --subscription ${matrix.<span class=\"hljs-property\">subscription</span>.<span class=\"hljs-property\">Id</span>} -t <span class=\"hljs-title class_\">Custom</span> --<span class=\"hljs-keyword\">from</span> ${from_last_month} --to ${to_last_month} >> $GITHUB_STEP_SUMMARY\n            <span class=\"hljs-keyword\">else</span>\n              azure-cost -o markdown --subscription ${matrix.<span class=\"hljs-property\">subscription</span>.<span class=\"hljs-property\">Id</span>} >> $GITHUB_STEP_SUMMARY\n            fi\n          fi\n      - <span class=\"hljs-attr\">uses</span>: actions/checkout@v4\n      - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-title class_\">Go</span> <span class=\"hljs-number\">1.21</span>.<span class=\"hljs-property\">x</span> 설정\n        <span class=\"hljs-attr\">uses</span>: actions/setup-go@v5\n        <span class=\"hljs-attr\">with</span>:\n          go-<span class=\"hljs-attr\">version</span>: <span class=\"hljs-number\">1.21</span>.<span class=\"hljs-property\">x</span>\n      - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-title class_\">Go</span> 종속성 설치\n        <span class=\"hljs-attr\">run</span>: go get ./...\n      - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-title class_\">Notion</span>으로 배포\n        <span class=\"hljs-attr\">env</span>:\n          <span class=\"hljs-attr\">NOTION_TOKEN</span>: ${secrets.<span class=\"hljs-property\">NOTION_TOKEN</span>}\n          <span class=\"hljs-attr\">NOTION_DATABASE_ID</span>: ${secrets.<span class=\"hljs-property\">NOTION_DATABASE_ID</span>}\n          <span class=\"hljs-attr\">SUBSCRIPTION_ID</span>: ${matrix.<span class=\"hljs-property\">subscription</span>.<span class=\"hljs-property\">Id</span>}\n          <span class=\"hljs-attr\">SUBSCRIPTION_NAME</span>: ${matrix.<span class=\"hljs-property\">subscription</span>.<span class=\"hljs-property\">Name</span>}\n          <span class=\"hljs-attr\">NOTION_OWNER_DATABASE_ID</span>: ${secrets.<span class=\"hljs-property\">NOTION_OWNER_DATABASE_ID</span>}\n        <span class=\"hljs-attr\">run</span>: |\n          <span class=\"hljs-variable constant_\">CURR_COST_DATA</span>=<span class=\"hljs-string\">\"$(echo '${steps.setCostData.outputs.dataJson}' | base64)\"</span>\n          <span class=\"hljs-variable constant_\">PAST_COST_DATA</span>=<span class=\"hljs-string\">\"$(echo '${steps.setCostData.outputs.prevDataJson}' | base64)\"</span>\n          <span class=\"hljs-variable constant_\">ANOMALIES_COST_DATA</span>=<span class=\"hljs-string\">\"$(echo '${steps.setCostData.outputs.anomaliesDataJson}' | base64)\"</span>\n          go run ./cmd/cost-analyser/main.<span class=\"hljs-property\">go</span> -id <span class=\"hljs-string\">\"$SUBSCRIPTION_ID\"</span> -name <span class=\"hljs-string\">\"$SUBSCRIPTION_NAME\"</span> -secret <span class=\"hljs-string\">\"$NOTION_TOKEN\"</span> -subscriptionsCostDatabaseId <span class=\"hljs-string\">\"$NOTION_DATABASE_ID\"</span> -subscriptionsOwnerDatabaseId <span class=\"hljs-string\">\"$NOTION_OWNER_DATABASE_ID\"</span> -inputActualReportJson <span class=\"hljs-string\">\"$CURR_COST_DATA\"</span> -inputPastReportJson <span class=\"hljs-string\">\"$PAST_COST_DATA\"</span> -anomaliesJson <span class=\"hljs-string\">\"$ANOMALIES_COST_DATA\"</span> >> ${matrix.<span class=\"hljs-property\">subscription</span>.<span class=\"hljs-property\">Id</span>}.<span class=\"hljs-property\">json</span>\n      - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-title class_\">Output</span> 업로드\n        <span class=\"hljs-attr\">uses</span>: actions/upload-artifact@v4\n        <span class=\"hljs-attr\">with</span>:\n          <span class=\"hljs-attr\">name</span>: artifact-${matrix.<span class=\"hljs-property\">subscription</span>.<span class=\"hljs-property\">Id</span>}\n          <span class=\"hljs-attr\">path</span>: ${matrix.<span class=\"hljs-property\">subscription</span>.<span class=\"hljs-property\">Id</span>}.<span class=\"hljs-property\">json</span>\n          <span class=\"hljs-keyword\">if</span>-no-files-<span class=\"hljs-attr\">found</span>: warn\n</code></pre>\n<p>Azure API의 시간 초과 또는 요율 제한 문제로 인해 병렬로 더 많은 작업을 실행할 경우에도 한 번에 1개의 작업을 실행합니다. 주요 단계는 다음과 같습니다:</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<ul>\n<li>Get JSON 비용 데이터는 이전 및 현재 일일 비용 보고서를 얻을 것입니다.</li>\n<li>Markdown 형식에서 현재 월 보고서를 얻어 Markdown 형식으로 포맷팅하여 GITHUB_STEP_SUMMARY에 출력하여 GitHub 작업 요약 페이지에서 볼 수 있게 합니다.</li>\n<li>Notion에 배포는 특정 구독을 위한 보고서를 업데이트하기 위해 Notion Go 애플리케이션을 실행합니다.</li>\n<li>출력 업로드는 이후 summarise-and-notify 단계에서 사용할 비용 보고서 출력을 아티팩트로 저장합니다.</li>\n</ul>\n<p>summarise-and-notify 작업은 모든 run-azure-cost-cli 및 run-aws-costs-cli 작업이 완료된 후에만 실행되며, summary 및 slack 알림을 위해 작동합니다:</p>\n<pre><code class=\"hljs language-js\">summarise-and-<span class=\"hljs-attr\">notify</span>:\n    runs-<span class=\"hljs-attr\">on</span>: ubuntu-latest\n    <span class=\"hljs-attr\">needs</span>: [run-azure-cost-cli, run-aws-costs-cli]\n    <span class=\"hljs-attr\">env</span>:\n      <span class=\"hljs-attr\">SUBSCRIPTIONS</span>: ${needs.<span class=\"hljs-property\">run</span>-aws-costs-cli.<span class=\"hljs-property\">outputs</span>.<span class=\"hljs-property\">subscriptions</span>}\n      <span class=\"hljs-attr\">SLACK_CHANNEL_WEBHOOK</span>: ${secrets.<span class=\"hljs-property\">SLACK_CHANNEL_WEBHOOK</span>}\n      <span class=\"hljs-attr\">TRIGGER_MESSAGE_DAY</span>: ${vars.<span class=\"hljs-property\">TRIGGER_MESSAGE_DAY</span>}\n      <span class=\"hljs-attr\">NOTION_AWS_PAGE_URL</span>: ${vars.<span class=\"hljs-property\">NOTION_AWS_PAGE_URL</span>}\n      <span class=\"hljs-attr\">NOTION_AZURE_PAGE_URL</span>: ${vars.<span class=\"hljs-property\">NOTION_AZURE_PAGE_URL</span>}\n      <span class=\"hljs-attr\">NOTION_TOKEN</span>: ${secrets.<span class=\"hljs-property\">NOTION_TOKEN</span>}\n      <span class=\"hljs-attr\">NOTION_COST_SUMMARY_PAGE</span>: ${vars.<span class=\"hljs-property\">NOTION_COST_SUMMARY_PAGE</span>}\n    <span class=\"hljs-attr\">steps</span>:\n      - <span class=\"hljs-attr\">uses</span>: actions/checkout@v4\n      - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-title class_\">Setup</span> <span class=\"hljs-title class_\">Go</span> <span class=\"hljs-number\">1.21</span>.<span class=\"hljs-property\">x</span>\n        <span class=\"hljs-attr\">uses</span>: actions/setup-go@v5\n        <span class=\"hljs-attr\">with</span>:\n          go-<span class=\"hljs-attr\">version</span>: <span class=\"hljs-number\">1.21</span>.<span class=\"hljs-property\">x</span>\n      - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-title class_\">Install</span> go dependencies\n        <span class=\"hljs-attr\">run</span>: go get ./...\n      - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">\"Download matrix outputs\"</span>\n        <span class=\"hljs-attr\">uses</span>: actions/download-artifact@v4\n        <span class=\"hljs-attr\">with</span>:\n          <span class=\"hljs-attr\">path</span>: artifact\n          <span class=\"hljs-attr\">pattern</span>: artifact-*\n          merge-<span class=\"hljs-attr\">multiple</span>: <span class=\"hljs-literal\">true</span>\n      - <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">\"Notify to slack\"</span>\n        <span class=\"hljs-attr\">run</span>: |\n          go run ./cmd/slack-cost-summary\n</code></pre>\n<p>마지막으로 실패한 작업을 자동으로 다시 시도할 수 있도록 re-run-azure-cost-cli 작업이 추가되었습니다. 병렬 작업을 실행하지 않더라도 때로는 azure API가 실패할 수 있습니다. 따라서 임시적인 azure API 실패를 제거하는 데 충분한 5번의 시도로 실패한 작업을 다시 시도하는 메커니즘을 추가했습니다:</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>재실행-azure-cost-cli:\n이름: 실패한 작업 다시 실행하는 워크플로우 호출\nneeds: run-azure-cost-cli\nif: failure() &#x26;&#x26; fromJSON(github.run_attempt) &#x3C; 5\nruns-on: ubuntu-latest\nsteps:\n- env:\nGH_REPO: ${ github.repository }\nGH_TOKEN: ${ github.token }\nGH_DEBUG: api\nrun: gh workflow run rerun.yml -F run_id=${ github.run_id }</p>\n<p>이름: 실패한 작업 다시 실행하는 워크플로우</p>\n<p>permissions:\nactions: write</p>\n<p>on:\nworkflow_dispatch:\ninputs:\nrun_id:\nrequired: true\njobs:\nrerun:\nruns-on: ubuntu-latest\nsteps:\n- name: ${ inputs.run_id } 다시 실행\nenv:\nGH_REPO: ${ github.repository }\nGH_TOKEN: ${ github.token }\nGH_DEBUG: api\nrun: |\ngh run watch ${ inputs.run_id } > /dev/null 2>&#x26;1\ngh run rerun ${ inputs.run_id } --failed</p>\n</body>\n</html>\n"},"__N_SSG":true}