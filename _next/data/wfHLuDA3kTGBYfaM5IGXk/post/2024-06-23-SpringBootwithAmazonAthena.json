{"pageProps":{"post":{"title":"Amazon Athena와 함께하는 Spring Boot 사용법","description":"","date":"2024-06-23 20:39","slug":"2024-06-23-SpringBootwithAmazonAthena","content":"\nSpring Boot과 데이터 레이크를 통합하는 방법을 알려드릴게요. 아마존 S3 데이터에 SQL 인터페이스를 제공합니다.\n\n![Spring Boot with Amazon Athena](/assets/img/2024-06-23-SpringBootwithAmazonAthena_0.png)\n\n# 소개\n\n우리는 SpringBoot 애플리케이션을 Amazon Athena와 연결하는 방법을 살펴볼 거에요. Athena가 무엇이며 어떻게 작동하는지 먼저 배운 후, Athena를 쿼리하는 SpringBoot 3 애플리케이션을 생성할 거에요. 해당 애플리케이션은 노출된 Rest API를 통해 Athena에 쿼리합니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n# 아테나 소개\n\n아마존 아테나는 다양한 소스와 형식에 저장된 데이터에 표준 SQL을 실행할 수 있는 쿼리 서비스입니다. 주로 S3와 함께 사용됩니다. 아테나는 Facebook에서 오픈 소스로 공개된 분산 SQL 엔진 Presto를 기반으로 합니다. 아테나는 서버리스이므로 설정하거나 관리할 인프라가 필요하지 않습니다.\n\n아테나는 아마존 S3에 있는 데이터를 분석하는 데 사용됩니다. 아테나는 CSV, ORC, Apache Parquet, Apache Avro, JSON과 같은 데이터 형식을 포함한 다양한 유형의 구조화 및 비구조화 데이터 유형과 작동할 수 있습니다.\n\n아마존의 Simple Storage Service인 S3는 아테나와 함께 사용하기 가장 권장되는 데이터 저장소입니다. S3는 AWS의 객체 저장 서비스로 어떤 파일 형식의 저렴한 저장을 제공합니다. S3는 버킷 내의 객체로 데이터를 저장합니다. 객체는 파일과 파일을 설명하는 메타데이터를 포함합니다. 버킷은 객체를 위한 컨테이너입니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\nAmazon S3에 데이터를 저장하려면 먼저 버킷을 생성하고 버킷 이름과 AWS 지역을 지정해야 합니다. 그런 다음 해당 버킷에 데이터를 Amazon S3의 객체로 업로드합니다. 각 객체는 버킷 내에서의 객체를 식별하는 고유 키(또는 키 이름)를 가지고 있습니다.\n\n# 데이터 다운로드\n\n저희 데이터는 전 세계 도시 인구에 대한 무료 버전 데이터 입니다. 다음 링크에서 액세스할 수 있습니다: [https://simplemaps.com/data/world-cities](https://simplemaps.com/data/world-cities). 원본 데이터 세트에는 몇 가지 조작이 필요했는데, 예를 들어 따옴표 제거와 같은 조작이 있었으며, 따라서 소스 코드에 포함된 클린한 버전이 제공되며 다음 링크를 통해 다운로드 받을 수 있습니다. 이 데이터에는 다음 스키마가 있습니다.\n\n```js\n도시, 도시_ascii, 위도, 경도, 국가, iso2, iso3, 관리 이름, 수도, 인구, id\n```\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n그리고 몇 줄의 샘플이 이렇게 보입니다.\n\n```js\nTokyo,Tokyo,35.6839,139.7744,Japan,JP,JPN,Tōkyō,primary,39105000,1392685764\nJakarta,Jakarta,-6.2146,106.8451,Indonesia,ID,IDN,Jakarta,primary,35362000,1360771077\nDelhi,Delhi,28.6667,77.2167,India,IN,IND,Delhi,admin,31870000,1356872604\nManila,Manila,14.6,120.9833,Philippines,PH,PHL,Manila,primary,23971000,1608618140\nSão Paulo,Sao Paulo,-23.5504,-46.6339,Brazil,BR,BRA,São Paulo,admin,22495000,1076532519\n```\n\n다운로드한 파일의 위치를 주의해주세요. 곧 접근할 것입니다.\n\n# S3 준비\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n다음으로는 데이터를 저장하는 데 사용할 S3 버킷을 생성해야 합니다. 이는 고유한 이름이어야 합니다. 제가 사용한 이름은 world-cities-athena 입니다. 상호적으로 따라오는 경우 다른 고유한 이름을 사용해야 합니다.\n\nAmazon S3 - Buckets - Create bucket 페이지로 이동하여 다음을 입력하고, 버킷 이름으로 교체하세요.\n\n이미지 src=\"/assets/img/2024-06-23-SpringBootwithAmazonAthena_1.png\" />\n\n나머지 설정은 기본값으로 선택하고, 하단의 \"버킷 생성\" 버튼을 눌러주세요.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n그럼 새 버킷을 선택하고 \"폴더 생성\" 버튼을 사용하여 input 및 queries라는 두 개의 폴더를 만들어주세요.\n\n<img src=\"/assets/img/2024-06-23-SpringBootwithAmazonAthena_2.png\" />\n\n폴더를 만들면 위의 이미지와 같이 구성이 되어야 해요.\n\n마지막으로, input 폴더를 클릭하고 \"업로드\"를 선택하여 이전 섹션에서 다운로드한 데이터 세트를 업로드해주세요.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n![Spring Boot with Amazon Athena](/assets/img/2024-06-23-SpringBootwithAmazonAthena_3.png)\n\n이렇게 완료되면 위와 같이 나타날 것입니다.\n\n마지막 단계는 쿼리 결과를 저장할 버킷을 생성하는 것입니다. 이 버킷은 우리가 Athena를 쿼리할 때 포함되며 각 쿼리의 결과가 해당 버킷에 저장됩니다. 그러면 쿼리를 다시 실행하지 않고 결과에 액세스할 수 있으며 비용이 발생하지 않습니다. 그러나 S3에 결과 파일의 저장 비용은 사용자가 책임져야 합니다. 버킷을 생성하려면 다시 Amazon S3 - `Buckets -` Create bucket 페이지로 이동하고 버킷 이름을 world-cities-results로 입력하십시오.\n\n![Spring Boot with Amazon Athena](/assets/img/2024-06-23-SpringBootwithAmazonAthena_4.png)\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n다시 모든 기본 값으로 유지하고 아래에 있는 버킷 생성 버튼을 선택하세요.\n\n이제 S3를 구성하고, 다음 단계로 넘어가서 Athena 데이터베이스와 테이블을 설정할 준비가 되었습니다.\n\n# Athena 구성\n\nAthena 데이터베이스를 구성하기 위한 몇 가지 단계가 있습니다. 이 모든 작업은 Athena AWS 콘솔 내에서 수행됩니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n![SpringBootwithAmazonAthena_5](/assets/img/2024-06-23-SpringBootwithAmazonAthena_5.png)\n\nNote that the interface changed somewhat recently and what you select is the line stating “Query your data with Trino SQL”, Trino being a fork of the SQL Query Engine.\n\nOnce you select Launch query editor then you will see this screen.\n\n![SpringBootwithAmazonAthena_6](/assets/img/2024-06-23-SpringBootwithAmazonAthena_6.png)\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n오른쪽에 있는 쿼리 창을 사용하여 Athena와 상호 작용할 수 있습니다. 이 방법을 사용하겠습니다. 객체를 수동으로 정의하는 마법사 형식의 테이블 생성 방법도 있습니다.\n\n먼저 데이터베이스를 생성하겠습니다. 데이터베이스는 처음에 기본값으로 설정되어 있고 우리만의 특정 데이터베이스를 생성하려고 합니다.\n\n쿼리 창에 다음을 입력하세요.\n\n```js\ncreate database worldcitiesdb\n```\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n다음과 같이 됩니다.\n\n![Spring Boot with Amazon Athena](/assets/img/2024-06-23-SpringBootwithAmazonAthena_7.png)\n\n그런 다음 **실행**을 누르세요.\n\n그럼 왼쪽 데이터 창의 Database 드롭다운에서 새 데이터베이스를 선택할 수 있습니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n현재 시점에서는 새로운 데이터베이스에 테이블이 없는 상태일 것입니다.\n\n테이블을 생성하려면 쿼리를 사용하여 데이터 파일을 가리키고 동시에 데이터로 테이블을 생성하고 채울 것입니다.\n\n오른쪽 쿼리 창에 다음 SQL을 입력하세요.\n\n```js\nCREATE EXTERNAL TABLE IF NOT EXISTS `worldcitiesdb`.`worldcities` (\n `city` string,\n `city_ascii` string,\n `lat` double,\n `lng` double,\n `country` string,\n `iso2` string,\n `iso3` string,\n `admin_name` string,\n `capital` string,\n `population` int,\n `id` int\n)\nROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe'\nWITH SERDEPROPERTIES (\n 'serialization.format' = ',',\n 'field.delim' = ','\n)\nLOCATION 's3://world-cities-athena/input/'\nTBLPROPERTIES ('skip.header.line.count' = '1')\n```\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n위의 create 문에서 특히 이 줄에 주목해주세요.\n\n```js\nLOCATION 's3://world-cities-athena/input/'\n```\n\n이 줄을 여러분의 버킷 이름으로 교체해야 하지만, 그 외에는 수정하지 말아야 합니다.\n\n쿼리에서 world-cities-athena를 여러분의 버킷으로 교체하신 후 Run을 눌러주세요.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n한 두 번 실행한 후 녹색 성공 메시지가 표시됩니다. 그러면 새 테이블이 Athena에서 왼쪽 데이터 창에 표시됩니다.\n\n![Spring Boot with Amazon Athena](/assets/img/2024-06-23-SpringBootwithAmazonAthena_8.png)\n\n쿼리 창에 테스트 쿼리를 입력하고 실행하여 테스트할 수 있습니다.\n\n```js\nselect * from worldcities limit 50\n```\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n다음은 데이터베이스 및 테이블이 있는지 확인하고 쿼리할 수 있다는 것을 확인합니다.\n\n![image](/assets/img/2024-06-23-SpringBootwithAmazonAthena_9.png)\n\nAthena 데이터베이스가 올바르게 설정되었습니다.\n\n# 코드 워크스루\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n이 기사의 코드는 제 Github에서 찾을 수 있습니다. 코드와 함께 다양한 SQL 문도 포함되어 있어요.\n\nAthena가 설정되었다면, 다음 단계는 REST API를 통해 노출할 SpringBoot 애플리케이션을 구현하는 것입니다. S3 기반 Athena 데이터베이스를 삭제하거나 업데이트할 수 없지만, 쿼리를 사용하여 테이블에 추가하거나 쿼리를 실행할 수 있어요.\n\n우리 경우 이전 섹션에서 만든 테이블을 쿼리할 수 있는 두 개의 REST 엔드포인트를 생성할 거에요. 첫 번째 엔드포인트는 국가별로 가져오고, 두 번째 엔드포인트는 국가 코드가 필요합니다. 둘 다 인구순으로 레코드를 표시하며, 가장 큰 값부터 (내림차순) 나타날 거에요.\n\n시작하기 전에 아래에 표시된 Spring Initializr에서 기본 종속성 집합을 가진 SpringBoot 애플리케이션을 생성할 거에요.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n<img src=\"/assets/img/2024-06-23-SpringBootwithAmazonAthena_10.png\" />\n\n여기서는 아테나와 작업하기 위해 필요한 라이브러리를 추가해야 합니다. 이를 위해 Java AWS SDK를 사용할 것입니다. 아래 종속성을 추가하여 이를 활성화하세요.\n\n```js\n<dependency>\n   <groupId>software.amazon.awssdk</groupId>\n   <artifactId>auth</artifactId>\n   <version>2.22.9</version>\n</dependency>\n<dependency>\n   <groupId>software.amazon.awssdk</groupId>\n   <artifactId>athena</artifactId>\n   <version>2.22.9</version>\n</dependency>\n<dependency>\n   <groupId>com.amazonaws</groupId>\n   <artifactId>aws-java-sdk</artifactId>\n   <version>1.12.636</version>\n</dependency>\n```\n\n위의 종속성들은 구현에 필요합니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n여기서 전체 pom.xml을 확인할 수 있습니다.\n\n## 응용 프로그램 구성\n\n응용 프로그램 구성에는 athena에 액세스하기 위해 필요한 모든 정보가 포함됩니다.\n\n```java\n@Data\n@Component\n@ConfigurationProperties(prefix = \"athena\")\npublic class AppConfiguration {\n    private String region;\n    private String workGroup;\n    private String catalog;\n    private String database;\n    private String resultsBucket;\n    private int clientExecutionTimeout;\n    private int limit;\n    private int retrySleep;\n}\n```\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n앱리케이션.yml의 해당 섹션은 아래와 같이 표시됩니다.\n\nathena:\nregion: us-east-1\nworkgroup: primary\ncatalog: AwsDataCatalog\ndatabase: worldcitiesdb\nlimit: 25\nclient-execution-timeout: 100000\nretry-sleep: 1000 # 1초\nresults-bucket: s3://world-cities-results\n\n## Athena 레이어\n\n다음으로 Athena 클라이언트를 생성하고 쿼리를 실행하는 접근 논리를 구현해야 합니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n먼저 Athena 클라이언트를 생성하는 것이 중요합니다. 아래 제공된 코드대로 작업이 진행됩니다.\n\n```js\n@Component\npublic class AthenaClientFactory {\n\n    public AthenaClient createAthenaClient() {\n        return AthenaClient.builder()\n            .credentialsProvider(DefaultCredentialsProvider.create())\n            //.credentialsProvider(EnvironmentVariableCredentialsProvider.create()) // use if creds are\n                                                                                    // env vars\n            .build();\n    }\n}\n```\n\n이 코드는 ~/.aws/credentials 파일에서 액세스 및 시크릿을 로딩하는 과정입니다. 하지만 환경 변수를 사용하고 싶다면 EnvironmentVariableCredentialsProvider를 사용할 수도 있습니다.\n\n이 작업은 software.amazon.awssdk.services.athena.AthenaClient 클래스의 인스턴스를 생성합니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n다음으로 필요한 구성 요소는 쿼리 시작 및 완료입니다. 이것은 두 단계 프로세스입니다.\n\n- 쿼리를 실행하면 시스템에 의해 쿼리 ID가 생성됩니다.\n- 위의 쿼리 ID는 쿼리 완료 상태를 확인하기 위해 성공 또는 실패 여부를 묻는 루프에서 사용됩니다.\n\n아래에 코드가 표시되어 있습니다. 코드에 대한 설명은 코드 뒷부분에 이어집니다.\n\n```js\n@Slf4j\n@Component\npublic class AthenaQuery {\n\n    private final AppConfiguration appConfiguration;\n\n    @Autowired\n    public AthenaQuery(AppConfiguration appConfiguration) {\n        this.appConfiguration = appConfiguration;\n    }\n\n    public String createAthenaQuery(AthenaClient athenaClient, String query) {\n\n        try {\n            QueryExecutionContext queryExecutionContext = QueryExecutionContext.builder()\n                .database(appConfiguration.getDatabase())\n                .build();\n\n            ResultConfiguration resultConfiguration = ResultConfiguration.builder()\n                .outputLocation(appConfiguration.getResultsBucket())\n                .build();\n\n            StartQueryExecutionRequest startQueryExecutionRequest = StartQueryExecutionRequest.builder()\n                .queryString(query)\n                .queryExecutionContext(queryExecutionContext)\n                .resultConfiguration(resultConfiguration)\n                .build();\n\n            StartQueryExecutionResponse startQueryExecutionResponse = athenaClient.startQueryExecution(startQueryExecutionRequest);\n            return startQueryExecutionResponse.queryExecutionId();\n        } catch (AthenaException e) {\n            log.error(\"Error during query execution\", e);\n        }\n        return \"\";\n    }\n\n    public void completeAthenaQuery(AthenaClient athenaClient, String queryExecutionId) {\n\n        GetQueryExecutionRequest getQueryExecutionRequest = GetQueryExecutionRequest.builder()\n            .queryExecutionId(queryExecutionId).build();\n\n        GetQueryExecutionResponse getQueryExecutionResponse;\n        boolean isStillRunning = true;\n        while (isStillRunning) {\n            getQueryExecutionResponse = athenaClient.getQueryExecution(getQueryExecutionRequest);\n            String queryState = getQueryExecutionResponse.queryExecution().status().state().toString();\n            if (queryState.equals(QueryExecutionState.FAILED.toString())) {\n                throw new RuntimeException(\"The Amazon Athena query failed to run with error message: \" + getQueryExecutionResponse\n                    .queryExecution().status().stateChangeReason());\n            } else if (queryState.equals(QueryExecutionState.CANCELLED.toString())) {\n                throw new RuntimeException(\"The Amazon Athena query was cancelled.\");\n            } else if (queryState.equals(QueryExecutionState.SUCCEEDED.toString())) {\n                isStillRunning = false;\n            } else {\n                try {\n                    Thread.sleep(appConfiguration.getRetrySleep());\n                } catch (InterruptedException e) {\n                    throw new RuntimeException(e);\n                }\n            }\n            log.debug(\"The current status is: \" + queryState);\n        }\n    }\n}\n```\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n쿼리는 createAthenaQuery 메서드로 시작됩니다. 이는 데이터베이스와 결과 버킷을 가진 쿼리 컨텍스트를 생성한 다음 쿼리를 Athena에 제출하여 수행됩니다. 성공적으로 실행된 경우 UUID 형식의 쿼리 실행 ID가 반환되며, 그렇지 않으면 빈 문자열이 반환됩니다.\n\ncompleteAthenaQuery 메서드에서는 쿼리가 성공적으로 완료되거나 쿼리가 실패하거나 취소(시간 초과) 될 때까지 루프를 사용합니다. 이는 결과가 준비될 때까지 실행 경로를 차단하기 위한 것입니다.\n\n## DTO 레이어\n\n이는 쿼리에서 가져온 필드와 일치하는 간단한 레코드입니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```kotlin\ndata class TopTenCities(val name: String, val population: Int)\n```\n\n자바 레코드의 사용으로 이것은 간단한 한 줄짜리 문장이 됩니다. 레코드 클래스를 사용하면 getter 및 동등성 비교 기능이 있는 변경 불가능한 POJO를 얻을 수 있습니다.\n\n## 서비스\n\n구현 내에서 서비스는 모든 것을 연결합니다. 이는 이전에 살펴본 Athena 클래스를 사용하여 Athena에서 데이터를 검색하고, 그런 다음 위의 POJO TopTenCities로 매핑합니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n```java\n@Service\n@AllArgsConstructor\n@Slf4j\npublic class AthenaService {\n\n    private static final String QUERY_ALL = \"SELECT city, population FROM worldcities \" +\n        \"ORDER BY population DESC LIMIT {limit}\";\n\n    private static final String QUERY = \"SELECT city, population FROM worldcities where iso2 = '{country}' \" +\n        \"ORDER BY population DESC LIMIT {limit}\";\n\n    private final AthenaClientFactory athenaClientFactory;\n\n    private final AthenaQuery athenaQuery;\n\n    public List<TopTenCities> getTop10All(Integer limit) {\n        return run(\"\", limit, QUERY_ALL);\n    }\n\n    public List<TopTenCities> getTop10(String country, Integer limit) {\n        return run(country, limit, QUERY);\n    }\n\n    public List<TopTenCities> run(String country, Integer limit, String query) {\n\n        AthenaClient athenaClient = athenaClientFactory.createAthenaClient();\n\n        String finalQuery = query.replace(\"{country}\", country)\n            .replace(\"{limit}\", String.valueOf(limit));\n        String queryExecutionId = athenaQuery.createAthenaQuery(athenaClient,\n            finalQuery);\n\n        if (!queryExecutionId.isEmpty()) {\n            log.info(\"Query submitted with query id {} and current mills {}\", queryExecutionId, System.currentTimeMillis());\n\n            athenaQuery.completeAthenaQuery(athenaClient, queryExecutionId);\n\n            log.info(\"Query finished at {}\", System.currentTimeMillis());\n\n            return processResultRows(athenaClient, queryExecutionId);\n        } else {\n            log.error(\"Issue while running the query \" + finalQuery);\n            return new ArrayList<>(); // return empty array\n        }\n    }\n\n    private List<TopTenCities> processResultRows(AthenaClient athenaClient, String queryExecutionId) {\n\n        List<TopTenCities> result = new ArrayList<>();\n        GetQueryResultsRequest getQueryResultsRequest = GetQueryResultsRequest.builder()\n            .queryExecutionId(queryExecutionId).build();\n\n        GetQueryResultsIterable getQueryResultsResults = athenaClient.getQueryResultsPaginator(getQueryResultsRequest);\n\n        for (GetQueryResultsResponse Resultresponse : getQueryResultsResults) {\n            List<ColumnInfo> columnInfoList = Resultresponse.resultSet().resultSetMetadata().columnInfo();\n\n            int resultSize = Resultresponse.resultSet().rows().size();\n            log.info(\"Result size: \" + resultSize);\n\n            List<Row> results = Resultresponse.resultSet().rows();\n            result = processRow(results, columnInfoList);\n        }\n        return result;\n    }\n\n    private List<TopTenCities> processRow(List<Row> rowList, List<ColumnInfo> columnInfoList) {\n\n        List<String> columns = new ArrayList<>();\n        List<TopTenCities> result = new ArrayList<>();\n\n        for (ColumnInfo columnInfo : columnInfoList) {\n            columns.add(columnInfo.name());\n        }\n\n        int rowCtr = 0;\n        for (Row row : rowList) {\n            int index = 0;\n\n            // simple mapping logic for the POJO\n            String name = \"\";\n            String population = \"\";\n\n            for (Datum datum : row.data()) {\n                log.debug(columns.get(index) + \": \" + datum.varCharValue());\n                // skip row header row\n                if (rowCtr > 0) {\n                    if (index == 0) {\n                        name = datum.varCharValue();\n                    } else {\n                        population = datum.varCharValue();\n                    }\n                }\n                index++;\n            }\n            rowCtr++;\n            if (!name.isEmpty()) {\n                var topTenCities = new TopTenCities(name, Integer.valueOf(population));\n                result.add(topTenCities);\n            }\n            log.debug(\"===================================\");\n        }\n        return result;\n    }\n}\n```\n\n이제 각 부분을 확인하면서 구현 내용을 이해하겠습니다. run 메서드는 주요 기능을 담당합니다. 여기서 SQL 쿼리 생성이 이루어지고, Athena 처리 레이어에서 이전에 살펴본 createAthenaQuery 및 completeAthenaQuery 메서드가 호출됩니다. 전자는 쿼리를 초기화하고 제출하며, 후자는 처리를 계속하기 전에 완료될 때까지 대기합니다.\n\nAthenaService의 processResultRows 메서드에서 GetQueryResultsRequest 클래스를 사용하여 쿼리 결과를 검색합니다. 이는 전체 결과를 반환하고, processRows가 각 행을 하나씩 처리하고 Java 개체로 매핑하는 데 사용됩니다.\n\n## Rest API\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n마지막으로 살펴볼 부분은 API 레벨입니다. 여기에서 컨트롤러를 구현합니다.\n\n```js\n@RestController\n@RequestMapping(value = \"/cities\", produces = APPLICATION_JSON_VALUE)\n@AllArgsConstructor\npublic class ApiController {\n\n    private final AthenaService athenaService;\n\n    @GetMapping(value = {\"\", \"/\"})\n    public ResponseEntity<List<TopTenCities>> getTop10All(@RequestParam(defaultValue = \"10\") Integer limit) {\n\n        List<TopTenCities> result = athenaService.getTop10All(limit);\n        return ResponseEntity.accepted().body(result);\n    }\n\n    @GetMapping(value = {\"/{country}\"})\n    public ResponseEntity<List<TopTenCities>> getTop10(@PathVariable(\"country\") String country,\n                                                       @RequestParam(defaultValue = \"10\") Integer limit) {\n\n        List<TopTenCities> result = athenaService.getTop10(country, limit);\n        return ResponseEntity.accepted().body(result);\n    }\n}\n```\n\n여기에 두 개의 엔드포인트가 선언되어 있습니다. 하나는 (GET) /cities 이고 다른 하나는 (GET) /cities/'country' 입니다. 두 엔드포인트 모두 선택적으로 쿼리 파라미터를 받아들이며, 반환할 값의 수를 설정할 수 있습니다. 기본값은 10입니다.\n\n# 테스팅\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n위 명령어로 애플리케이션을 시작하여 테스트해보세요.\n\n```js\njava -jar target/athena-sample-0.0.1-SNAPSHOT.jar\n```\n\n이렇게 하면 애플리케이션이 실행됩니다. 브라우저 URL에 다음을 입력하여 실행 여부를 확인할 수 있습니다.\n\n```js\nhttp://localhost:8080/api/actuator\n```\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n해당 URL을 브라우저에 입력하면 모든 국가의 인구 순으로 상위 열 개의 도시가 반환됩니다.\n\nhttp://localhost:8080/api/cities\n\n다음과 같이 표시됩니다.\n\n![이미지](/assets/img/2024-06-23-SpringBootwithAmazonAthena_11.png)\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n다음 코드도 시도해 볼 수 있어요.\n\n```js\nhttp://localhost:8080/api/cities/US?limit=15\n```\n\n이렇게 하면 미국 내 인구 순으로 상위 15개의 도시 정보를 받아볼 수 있어요. DE, BR, CA와 같은 다른 국가 코드로도 시도해 보세요.\n\n우리는 SpringBoot 애플리케이션을 통해 Athena를 쿼리할 수 있음을 보여줬고, 이를 REST API를 통해 모두 연결했어요.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n# 참고 자료\n\n- Amazon Athena를 활용한 서버리스 분석 — Packt Publishing — Anthony Virtuoso, Mert Turkay Hocanin, Aaron Wishnick\n\n# 요약\n\n오늘은 SpringBoot 애플리케이션에서 Athena로 인터페이스를 만드는 방법을 살펴보았습니다. 우리는 Athena에 대한 배경 정보부터 시작했습니다. 그 후에 CSV 파일을 Athena로 로드하고 사용 가능하게 만드는 방법을 살펴보았습니다. 다음으로 SpringBoot 애플리케이션과 Athena를 연결하고 쿼리하는 방법을 살펴보았습니다. 이러한 클래스들은 여러분의 애플리케이션에 기초를 제공할 수 있습니다. 마지막으로 우리는 테스트를 해보았습니다. 함께 이 여정을 함께해줘서 감사합니다.\n\n<!-- ui-station 사각형 -->\n\n<ins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"></ins>\n\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n\n이 글의 코드는 제 Github에서 찾아볼 수 있어요.\n\n즐거운 여정되세요!\n","ogImage":{"url":"/assets/img/2024-06-23-SpringBootwithAmazonAthena_0.png"},"coverImage":"/assets/img/2024-06-23-SpringBootwithAmazonAthena_0.png","tag":["Tech"],"readingTime":26},"content":"<!doctype html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\">\n<meta content=\"width=device-width, initial-scale=1\" name=\"viewport\">\n</head>\n<body>\n<p>Spring Boot과 데이터 레이크를 통합하는 방법을 알려드릴게요. 아마존 S3 데이터에 SQL 인터페이스를 제공합니다.</p>\n<p><img src=\"/assets/img/2024-06-23-SpringBootwithAmazonAthena_0.png\" alt=\"Spring Boot with Amazon Athena\"></p>\n<h1>소개</h1>\n<p>우리는 SpringBoot 애플리케이션을 Amazon Athena와 연결하는 방법을 살펴볼 거에요. Athena가 무엇이며 어떻게 작동하는지 먼저 배운 후, Athena를 쿼리하는 SpringBoot 3 애플리케이션을 생성할 거에요. 해당 애플리케이션은 노출된 Rest API를 통해 Athena에 쿼리합니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<h1>아테나 소개</h1>\n<p>아마존 아테나는 다양한 소스와 형식에 저장된 데이터에 표준 SQL을 실행할 수 있는 쿼리 서비스입니다. 주로 S3와 함께 사용됩니다. 아테나는 Facebook에서 오픈 소스로 공개된 분산 SQL 엔진 Presto를 기반으로 합니다. 아테나는 서버리스이므로 설정하거나 관리할 인프라가 필요하지 않습니다.</p>\n<p>아테나는 아마존 S3에 있는 데이터를 분석하는 데 사용됩니다. 아테나는 CSV, ORC, Apache Parquet, Apache Avro, JSON과 같은 데이터 형식을 포함한 다양한 유형의 구조화 및 비구조화 데이터 유형과 작동할 수 있습니다.</p>\n<p>아마존의 Simple Storage Service인 S3는 아테나와 함께 사용하기 가장 권장되는 데이터 저장소입니다. S3는 AWS의 객체 저장 서비스로 어떤 파일 형식의 저렴한 저장을 제공합니다. S3는 버킷 내의 객체로 데이터를 저장합니다. 객체는 파일과 파일을 설명하는 메타데이터를 포함합니다. 버킷은 객체를 위한 컨테이너입니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>Amazon S3에 데이터를 저장하려면 먼저 버킷을 생성하고 버킷 이름과 AWS 지역을 지정해야 합니다. 그런 다음 해당 버킷에 데이터를 Amazon S3의 객체로 업로드합니다. 각 객체는 버킷 내에서의 객체를 식별하는 고유 키(또는 키 이름)를 가지고 있습니다.</p>\n<h1>데이터 다운로드</h1>\n<p>저희 데이터는 전 세계 도시 인구에 대한 무료 버전 데이터 입니다. 다음 링크에서 액세스할 수 있습니다: <a href=\"https://simplemaps.com/data/world-cities\" rel=\"nofollow\" target=\"_blank\">https://simplemaps.com/data/world-cities</a>. 원본 데이터 세트에는 몇 가지 조작이 필요했는데, 예를 들어 따옴표 제거와 같은 조작이 있었으며, 따라서 소스 코드에 포함된 클린한 버전이 제공되며 다음 링크를 통해 다운로드 받을 수 있습니다. 이 데이터에는 다음 스키마가 있습니다.</p>\n<pre><code class=\"hljs language-js\">도시, 도시_ascii, 위도, 경도, 국가, iso2, iso3, 관리 이름, 수도, 인구, id\n</code></pre>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>그리고 몇 줄의 샘플이 이렇게 보입니다.</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-title class_\">Tokyo</span>,<span class=\"hljs-title class_\">Tokyo</span>,<span class=\"hljs-number\">35.6839</span>,<span class=\"hljs-number\">139.7744</span>,<span class=\"hljs-title class_\">Japan</span>,<span class=\"hljs-variable constant_\">JP</span>,<span class=\"hljs-variable constant_\">JPN</span>,Tōkyō,primary,<span class=\"hljs-number\">39105000</span>,<span class=\"hljs-number\">1392685764</span>\n<span class=\"hljs-title class_\">Jakarta</span>,<span class=\"hljs-title class_\">Jakarta</span>,-<span class=\"hljs-number\">6.2146</span>,<span class=\"hljs-number\">106.8451</span>,<span class=\"hljs-title class_\">Indonesia</span>,<span class=\"hljs-variable constant_\">ID</span>,<span class=\"hljs-variable constant_\">IDN</span>,<span class=\"hljs-title class_\">Jakarta</span>,primary,<span class=\"hljs-number\">35362000</span>,<span class=\"hljs-number\">1360771077</span>\n<span class=\"hljs-title class_\">Delhi</span>,<span class=\"hljs-title class_\">Delhi</span>,<span class=\"hljs-number\">28.6667</span>,<span class=\"hljs-number\">77.2167</span>,<span class=\"hljs-title class_\">India</span>,<span class=\"hljs-variable constant_\">IN</span>,<span class=\"hljs-variable constant_\">IND</span>,<span class=\"hljs-title class_\">Delhi</span>,admin,<span class=\"hljs-number\">31870000</span>,<span class=\"hljs-number\">1356872604</span>\n<span class=\"hljs-title class_\">Manila</span>,<span class=\"hljs-title class_\">Manila</span>,<span class=\"hljs-number\">14.6</span>,<span class=\"hljs-number\">120.9833</span>,<span class=\"hljs-title class_\">Philippines</span>,<span class=\"hljs-variable constant_\">PH</span>,<span class=\"hljs-variable constant_\">PHL</span>,<span class=\"hljs-title class_\">Manila</span>,primary,<span class=\"hljs-number\">23971000</span>,<span class=\"hljs-number\">1608618140</span>\nSão <span class=\"hljs-title class_\">Paulo</span>,<span class=\"hljs-title class_\">Sao</span> <span class=\"hljs-title class_\">Paulo</span>,-<span class=\"hljs-number\">23.5504</span>,-<span class=\"hljs-number\">46.6339</span>,<span class=\"hljs-title class_\">Brazil</span>,<span class=\"hljs-variable constant_\">BR</span>,<span class=\"hljs-variable constant_\">BRA</span>,São <span class=\"hljs-title class_\">Paulo</span>,admin,<span class=\"hljs-number\">22495000</span>,<span class=\"hljs-number\">1076532519</span>\n</code></pre>\n<p>다운로드한 파일의 위치를 주의해주세요. 곧 접근할 것입니다.</p>\n<h1>S3 준비</h1>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>다음으로는 데이터를 저장하는 데 사용할 S3 버킷을 생성해야 합니다. 이는 고유한 이름이어야 합니다. 제가 사용한 이름은 world-cities-athena 입니다. 상호적으로 따라오는 경우 다른 고유한 이름을 사용해야 합니다.</p>\n<p>Amazon S3 - Buckets - Create bucket 페이지로 이동하여 다음을 입력하고, 버킷 이름으로 교체하세요.</p>\n<p>이미지 src=\"/assets/img/2024-06-23-SpringBootwithAmazonAthena_1.png\" /></p>\n<p>나머지 설정은 기본값으로 선택하고, 하단의 \"버킷 생성\" 버튼을 눌러주세요.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>그럼 새 버킷을 선택하고 \"폴더 생성\" 버튼을 사용하여 input 및 queries라는 두 개의 폴더를 만들어주세요.</p>\n<img src=\"/assets/img/2024-06-23-SpringBootwithAmazonAthena_2.png\">\n<p>폴더를 만들면 위의 이미지와 같이 구성이 되어야 해요.</p>\n<p>마지막으로, input 폴더를 클릭하고 \"업로드\"를 선택하여 이전 섹션에서 다운로드한 데이터 세트를 업로드해주세요.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p><img src=\"/assets/img/2024-06-23-SpringBootwithAmazonAthena_3.png\" alt=\"Spring Boot with Amazon Athena\"></p>\n<p>이렇게 완료되면 위와 같이 나타날 것입니다.</p>\n<p>마지막 단계는 쿼리 결과를 저장할 버킷을 생성하는 것입니다. 이 버킷은 우리가 Athena를 쿼리할 때 포함되며 각 쿼리의 결과가 해당 버킷에 저장됩니다. 그러면 쿼리를 다시 실행하지 않고 결과에 액세스할 수 있으며 비용이 발생하지 않습니다. 그러나 S3에 결과 파일의 저장 비용은 사용자가 책임져야 합니다. 버킷을 생성하려면 다시 Amazon S3 - <code>Buckets -</code> Create bucket 페이지로 이동하고 버킷 이름을 world-cities-results로 입력하십시오.</p>\n<p><img src=\"/assets/img/2024-06-23-SpringBootwithAmazonAthena_4.png\" alt=\"Spring Boot with Amazon Athena\"></p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>다시 모든 기본 값으로 유지하고 아래에 있는 버킷 생성 버튼을 선택하세요.</p>\n<p>이제 S3를 구성하고, 다음 단계로 넘어가서 Athena 데이터베이스와 테이블을 설정할 준비가 되었습니다.</p>\n<h1>Athena 구성</h1>\n<p>Athena 데이터베이스를 구성하기 위한 몇 가지 단계가 있습니다. 이 모든 작업은 Athena AWS 콘솔 내에서 수행됩니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p><img src=\"/assets/img/2024-06-23-SpringBootwithAmazonAthena_5.png\" alt=\"SpringBootwithAmazonAthena_5\"></p>\n<p>Note that the interface changed somewhat recently and what you select is the line stating “Query your data with Trino SQL”, Trino being a fork of the SQL Query Engine.</p>\n<p>Once you select Launch query editor then you will see this screen.</p>\n<p><img src=\"/assets/img/2024-06-23-SpringBootwithAmazonAthena_6.png\" alt=\"SpringBootwithAmazonAthena_6\"></p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>오른쪽에 있는 쿼리 창을 사용하여 Athena와 상호 작용할 수 있습니다. 이 방법을 사용하겠습니다. 객체를 수동으로 정의하는 마법사 형식의 테이블 생성 방법도 있습니다.</p>\n<p>먼저 데이터베이스를 생성하겠습니다. 데이터베이스는 처음에 기본값으로 설정되어 있고 우리만의 특정 데이터베이스를 생성하려고 합니다.</p>\n<p>쿼리 창에 다음을 입력하세요.</p>\n<pre><code class=\"hljs language-js\">create database worldcitiesdb\n</code></pre>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>다음과 같이 됩니다.</p>\n<p><img src=\"/assets/img/2024-06-23-SpringBootwithAmazonAthena_7.png\" alt=\"Spring Boot with Amazon Athena\"></p>\n<p>그런 다음 <strong>실행</strong>을 누르세요.</p>\n<p>그럼 왼쪽 데이터 창의 Database 드롭다운에서 새 데이터베이스를 선택할 수 있습니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>현재 시점에서는 새로운 데이터베이스에 테이블이 없는 상태일 것입니다.</p>\n<p>테이블을 생성하려면 쿼리를 사용하여 데이터 파일을 가리키고 동시에 데이터로 테이블을 생성하고 채울 것입니다.</p>\n<p>오른쪽 쿼리 창에 다음 SQL을 입력하세요.</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-variable constant_\">CREATE</span> <span class=\"hljs-variable constant_\">EXTERNAL</span> <span class=\"hljs-variable constant_\">TABLE</span> <span class=\"hljs-variable constant_\">IF</span> <span class=\"hljs-variable constant_\">NOT</span> <span class=\"hljs-variable constant_\">EXISTS</span> <span class=\"hljs-string\">`worldcitiesdb`</span>.<span class=\"hljs-string\">`worldcities`</span> (\n <span class=\"hljs-string\">`city`</span> string,\n <span class=\"hljs-string\">`city_ascii`</span> string,\n <span class=\"hljs-string\">`lat`</span> double,\n <span class=\"hljs-string\">`lng`</span> double,\n <span class=\"hljs-string\">`country`</span> string,\n <span class=\"hljs-string\">`iso2`</span> string,\n <span class=\"hljs-string\">`iso3`</span> string,\n <span class=\"hljs-string\">`admin_name`</span> string,\n <span class=\"hljs-string\">`capital`</span> string,\n <span class=\"hljs-string\">`population`</span> int,\n <span class=\"hljs-string\">`id`</span> int\n)\n<span class=\"hljs-variable constant_\">ROW</span> <span class=\"hljs-variable constant_\">FORMAT</span> <span class=\"hljs-variable constant_\">SERDE</span> <span class=\"hljs-string\">'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe'</span>\n<span class=\"hljs-variable constant_\">WITH</span> <span class=\"hljs-variable constant_\">SERDEPROPERTIES</span> (\n <span class=\"hljs-string\">'serialization.format'</span> = <span class=\"hljs-string\">','</span>,\n <span class=\"hljs-string\">'field.delim'</span> = <span class=\"hljs-string\">','</span>\n)\n<span class=\"hljs-variable constant_\">LOCATION</span> <span class=\"hljs-string\">'s3://world-cities-athena/input/'</span>\n<span class=\"hljs-variable constant_\">TBLPROPERTIES</span> (<span class=\"hljs-string\">'skip.header.line.count'</span> = <span class=\"hljs-string\">'1'</span>)\n</code></pre>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>위의 create 문에서 특히 이 줄에 주목해주세요.</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-variable constant_\">LOCATION</span> <span class=\"hljs-string\">'s3://world-cities-athena/input/'</span>\n</code></pre>\n<p>이 줄을 여러분의 버킷 이름으로 교체해야 하지만, 그 외에는 수정하지 말아야 합니다.</p>\n<p>쿼리에서 world-cities-athena를 여러분의 버킷으로 교체하신 후 Run을 눌러주세요.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>한 두 번 실행한 후 녹색 성공 메시지가 표시됩니다. 그러면 새 테이블이 Athena에서 왼쪽 데이터 창에 표시됩니다.</p>\n<p><img src=\"/assets/img/2024-06-23-SpringBootwithAmazonAthena_8.png\" alt=\"Spring Boot with Amazon Athena\"></p>\n<p>쿼리 창에 테스트 쿼리를 입력하고 실행하여 테스트할 수 있습니다.</p>\n<pre><code class=\"hljs language-js\">select * <span class=\"hljs-keyword\">from</span> worldcities limit <span class=\"hljs-number\">50</span>\n</code></pre>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>다음은 데이터베이스 및 테이블이 있는지 확인하고 쿼리할 수 있다는 것을 확인합니다.</p>\n<p><img src=\"/assets/img/2024-06-23-SpringBootwithAmazonAthena_9.png\" alt=\"image\"></p>\n<p>Athena 데이터베이스가 올바르게 설정되었습니다.</p>\n<h1>코드 워크스루</h1>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>이 기사의 코드는 제 Github에서 찾을 수 있습니다. 코드와 함께 다양한 SQL 문도 포함되어 있어요.</p>\n<p>Athena가 설정되었다면, 다음 단계는 REST API를 통해 노출할 SpringBoot 애플리케이션을 구현하는 것입니다. S3 기반 Athena 데이터베이스를 삭제하거나 업데이트할 수 없지만, 쿼리를 사용하여 테이블에 추가하거나 쿼리를 실행할 수 있어요.</p>\n<p>우리 경우 이전 섹션에서 만든 테이블을 쿼리할 수 있는 두 개의 REST 엔드포인트를 생성할 거에요. 첫 번째 엔드포인트는 국가별로 가져오고, 두 번째 엔드포인트는 국가 코드가 필요합니다. 둘 다 인구순으로 레코드를 표시하며, 가장 큰 값부터 (내림차순) 나타날 거에요.</p>\n<p>시작하기 전에 아래에 표시된 Spring Initializr에서 기본 종속성 집합을 가진 SpringBoot 애플리케이션을 생성할 거에요.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<img src=\"/assets/img/2024-06-23-SpringBootwithAmazonAthena_10.png\">\n<p>여기서는 아테나와 작업하기 위해 필요한 라이브러리를 추가해야 합니다. 이를 위해 Java AWS SDK를 사용할 것입니다. 아래 종속성을 추가하여 이를 활성화하세요.</p>\n<pre><code class=\"hljs language-js\">&#x3C;dependency>\n   <span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">groupId</span>></span>software.amazon.awssdk<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">groupId</span>></span></span>\n   <span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">artifactId</span>></span>auth<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">artifactId</span>></span></span>\n   <span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">version</span>></span>2.22.9<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">version</span>></span></span>\n&#x3C;/dependency>\n<span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">dependency</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">groupId</span>></span>software.amazon.awssdk<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">groupId</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">artifactId</span>></span>athena<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">artifactId</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">version</span>></span>2.22.9<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">version</span>></span>\n<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">dependency</span>></span></span>\n<span class=\"xml\"><span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">dependency</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">groupId</span>></span>com.amazonaws<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">groupId</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">artifactId</span>></span>aws-java-sdk<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">artifactId</span>></span>\n   <span class=\"hljs-tag\">&#x3C;<span class=\"hljs-name\">version</span>></span>1.12.636<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">version</span>></span>\n<span class=\"hljs-tag\">&#x3C;/<span class=\"hljs-name\">dependency</span>></span></span>\n</code></pre>\n<p>위의 종속성들은 구현에 필요합니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>여기서 전체 pom.xml을 확인할 수 있습니다.</p>\n<h2>응용 프로그램 구성</h2>\n<p>응용 프로그램 구성에는 athena에 액세스하기 위해 필요한 모든 정보가 포함됩니다.</p>\n<pre><code class=\"hljs language-java\"><span class=\"hljs-meta\">@Data</span>\n<span class=\"hljs-meta\">@Component</span>\n<span class=\"hljs-meta\">@ConfigurationProperties(prefix = \"athena\")</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">AppConfiguration</span> {\n    <span class=\"hljs-keyword\">private</span> String region;\n    <span class=\"hljs-keyword\">private</span> String workGroup;\n    <span class=\"hljs-keyword\">private</span> String catalog;\n    <span class=\"hljs-keyword\">private</span> String database;\n    <span class=\"hljs-keyword\">private</span> String resultsBucket;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-type\">int</span> clientExecutionTimeout;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-type\">int</span> limit;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-type\">int</span> retrySleep;\n}\n</code></pre>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>앱리케이션.yml의 해당 섹션은 아래와 같이 표시됩니다.</p>\n<p>athena:\nregion: us-east-1\nworkgroup: primary\ncatalog: AwsDataCatalog\ndatabase: worldcitiesdb\nlimit: 25\nclient-execution-timeout: 100000\nretry-sleep: 1000 # 1초\nresults-bucket: s3://world-cities-results</p>\n<h2>Athena 레이어</h2>\n<p>다음으로 Athena 클라이언트를 생성하고 쿼리를 실행하는 접근 논리를 구현해야 합니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>먼저 Athena 클라이언트를 생성하는 것이 중요합니다. 아래 제공된 코드대로 작업이 진행됩니다.</p>\n<pre><code class=\"hljs language-js\">@<span class=\"hljs-title class_\">Component</span>\npublic <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">AthenaClientFactory</span> {\n\n    public <span class=\"hljs-title class_\">AthenaClient</span> <span class=\"hljs-title function_\">createAthenaClient</span>(<span class=\"hljs-params\"></span>) {\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title class_\">AthenaClient</span>.<span class=\"hljs-title function_\">builder</span>()\n            .<span class=\"hljs-title function_\">credentialsProvider</span>(<span class=\"hljs-title class_\">DefaultCredentialsProvider</span>.<span class=\"hljs-title function_\">create</span>())\n            <span class=\"hljs-comment\">//.credentialsProvider(EnvironmentVariableCredentialsProvider.create()) // use if creds are</span>\n                                                                                    <span class=\"hljs-comment\">// env vars</span>\n            .<span class=\"hljs-title function_\">build</span>();\n    }\n}\n</code></pre>\n<p>이 코드는 ~/.aws/credentials 파일에서 액세스 및 시크릿을 로딩하는 과정입니다. 하지만 환경 변수를 사용하고 싶다면 EnvironmentVariableCredentialsProvider를 사용할 수도 있습니다.</p>\n<p>이 작업은 software.amazon.awssdk.services.athena.AthenaClient 클래스의 인스턴스를 생성합니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>다음으로 필요한 구성 요소는 쿼리 시작 및 완료입니다. 이것은 두 단계 프로세스입니다.</p>\n<ul>\n<li>쿼리를 실행하면 시스템에 의해 쿼리 ID가 생성됩니다.</li>\n<li>위의 쿼리 ID는 쿼리 완료 상태를 확인하기 위해 성공 또는 실패 여부를 묻는 루프에서 사용됩니다.</li>\n</ul>\n<p>아래에 코드가 표시되어 있습니다. 코드에 대한 설명은 코드 뒷부분에 이어집니다.</p>\n<pre><code class=\"hljs language-js\">@<span class=\"hljs-title class_\">Slf4</span>j\n@<span class=\"hljs-title class_\">Component</span>\npublic <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">AthenaQuery</span> {\n\n    private final <span class=\"hljs-title class_\">AppConfiguration</span> appConfiguration;\n\n    @<span class=\"hljs-title class_\">Autowired</span>\n    public <span class=\"hljs-title class_\">AthenaQuery</span>(<span class=\"hljs-title class_\">AppConfiguration</span> appConfiguration) {\n        <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">appConfiguration</span> = appConfiguration;\n    }\n\n    public <span class=\"hljs-title class_\">String</span> <span class=\"hljs-title function_\">createAthenaQuery</span>(<span class=\"hljs-params\">AthenaClient athenaClient, <span class=\"hljs-built_in\">String</span> query</span>) {\n\n        <span class=\"hljs-keyword\">try</span> {\n            <span class=\"hljs-title class_\">QueryExecutionContext</span> queryExecutionContext = <span class=\"hljs-title class_\">QueryExecutionContext</span>.<span class=\"hljs-title function_\">builder</span>()\n                .<span class=\"hljs-title function_\">database</span>(appConfiguration.<span class=\"hljs-title function_\">getDatabase</span>())\n                .<span class=\"hljs-title function_\">build</span>();\n\n            <span class=\"hljs-title class_\">ResultConfiguration</span> resultConfiguration = <span class=\"hljs-title class_\">ResultConfiguration</span>.<span class=\"hljs-title function_\">builder</span>()\n                .<span class=\"hljs-title function_\">outputLocation</span>(appConfiguration.<span class=\"hljs-title function_\">getResultsBucket</span>())\n                .<span class=\"hljs-title function_\">build</span>();\n\n            <span class=\"hljs-title class_\">StartQueryExecutionRequest</span> startQueryExecutionRequest = <span class=\"hljs-title class_\">StartQueryExecutionRequest</span>.<span class=\"hljs-title function_\">builder</span>()\n                .<span class=\"hljs-title function_\">queryString</span>(query)\n                .<span class=\"hljs-title function_\">queryExecutionContext</span>(queryExecutionContext)\n                .<span class=\"hljs-title function_\">resultConfiguration</span>(resultConfiguration)\n                .<span class=\"hljs-title function_\">build</span>();\n\n            <span class=\"hljs-title class_\">StartQueryExecutionResponse</span> startQueryExecutionResponse = athenaClient.<span class=\"hljs-title function_\">startQueryExecution</span>(startQueryExecutionRequest);\n            <span class=\"hljs-keyword\">return</span> startQueryExecutionResponse.<span class=\"hljs-title function_\">queryExecutionId</span>();\n        } <span class=\"hljs-keyword\">catch</span> (<span class=\"hljs-title class_\">AthenaException</span> e) {\n            log.<span class=\"hljs-title function_\">error</span>(<span class=\"hljs-string\">\"Error during query execution\"</span>, e);\n        }\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">\"\"</span>;\n    }\n\n    public <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title function_\">completeAthenaQuery</span>(<span class=\"hljs-params\">AthenaClient athenaClient, <span class=\"hljs-built_in\">String</span> queryExecutionId</span>) {\n\n        <span class=\"hljs-title class_\">GetQueryExecutionRequest</span> getQueryExecutionRequest = <span class=\"hljs-title class_\">GetQueryExecutionRequest</span>.<span class=\"hljs-title function_\">builder</span>()\n            .<span class=\"hljs-title function_\">queryExecutionId</span>(queryExecutionId).<span class=\"hljs-title function_\">build</span>();\n\n        <span class=\"hljs-title class_\">GetQueryExecutionResponse</span> getQueryExecutionResponse;\n        boolean isStillRunning = <span class=\"hljs-literal\">true</span>;\n        <span class=\"hljs-keyword\">while</span> (isStillRunning) {\n            getQueryExecutionResponse = athenaClient.<span class=\"hljs-title function_\">getQueryExecution</span>(getQueryExecutionRequest);\n            <span class=\"hljs-title class_\">String</span> queryState = getQueryExecutionResponse.<span class=\"hljs-title function_\">queryExecution</span>().<span class=\"hljs-title function_\">status</span>().<span class=\"hljs-title function_\">state</span>().<span class=\"hljs-title function_\">toString</span>();\n            <span class=\"hljs-keyword\">if</span> (queryState.<span class=\"hljs-title function_\">equals</span>(<span class=\"hljs-title class_\">QueryExecutionState</span>.<span class=\"hljs-property\">FAILED</span>.<span class=\"hljs-title function_\">toString</span>())) {\n                <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">RuntimeException</span>(<span class=\"hljs-string\">\"The Amazon Athena query failed to run with error message: \"</span> + getQueryExecutionResponse\n                    .<span class=\"hljs-title function_\">queryExecution</span>().<span class=\"hljs-title function_\">status</span>().<span class=\"hljs-title function_\">stateChangeReason</span>());\n            } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (queryState.<span class=\"hljs-title function_\">equals</span>(<span class=\"hljs-title class_\">QueryExecutionState</span>.<span class=\"hljs-property\">CANCELLED</span>.<span class=\"hljs-title function_\">toString</span>())) {\n                <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">RuntimeException</span>(<span class=\"hljs-string\">\"The Amazon Athena query was cancelled.\"</span>);\n            } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (queryState.<span class=\"hljs-title function_\">equals</span>(<span class=\"hljs-title class_\">QueryExecutionState</span>.<span class=\"hljs-property\">SUCCEEDED</span>.<span class=\"hljs-title function_\">toString</span>())) {\n                isStillRunning = <span class=\"hljs-literal\">false</span>;\n            } <span class=\"hljs-keyword\">else</span> {\n                <span class=\"hljs-keyword\">try</span> {\n                    <span class=\"hljs-title class_\">Thread</span>.<span class=\"hljs-title function_\">sleep</span>(appConfiguration.<span class=\"hljs-title function_\">getRetrySleep</span>());\n                } <span class=\"hljs-keyword\">catch</span> (<span class=\"hljs-title class_\">InterruptedException</span> e) {\n                    <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">RuntimeException</span>(e);\n                }\n            }\n            log.<span class=\"hljs-title function_\">debug</span>(<span class=\"hljs-string\">\"The current status is: \"</span> + queryState);\n        }\n    }\n}\n</code></pre>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>쿼리는 createAthenaQuery 메서드로 시작됩니다. 이는 데이터베이스와 결과 버킷을 가진 쿼리 컨텍스트를 생성한 다음 쿼리를 Athena에 제출하여 수행됩니다. 성공적으로 실행된 경우 UUID 형식의 쿼리 실행 ID가 반환되며, 그렇지 않으면 빈 문자열이 반환됩니다.</p>\n<p>completeAthenaQuery 메서드에서는 쿼리가 성공적으로 완료되거나 쿼리가 실패하거나 취소(시간 초과) 될 때까지 루프를 사용합니다. 이는 결과가 준비될 때까지 실행 경로를 차단하기 위한 것입니다.</p>\n<h2>DTO 레이어</h2>\n<p>이는 쿼리에서 가져온 필드와 일치하는 간단한 레코드입니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<pre><code class=\"hljs language-kotlin\"><span class=\"hljs-keyword\">data</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">TopTenCities</span>(<span class=\"hljs-keyword\">val</span> name: String, <span class=\"hljs-keyword\">val</span> population: <span class=\"hljs-built_in\">Int</span>)\n</code></pre>\n<p>자바 레코드의 사용으로 이것은 간단한 한 줄짜리 문장이 됩니다. 레코드 클래스를 사용하면 getter 및 동등성 비교 기능이 있는 변경 불가능한 POJO를 얻을 수 있습니다.</p>\n<h2>서비스</h2>\n<p>구현 내에서 서비스는 모든 것을 연결합니다. 이는 이전에 살펴본 Athena 클래스를 사용하여 Athena에서 데이터를 검색하고, 그런 다음 위의 POJO TopTenCities로 매핑합니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<pre><code class=\"hljs language-java\"><span class=\"hljs-meta\">@Service</span>\n<span class=\"hljs-meta\">@AllArgsConstructor</span>\n<span class=\"hljs-meta\">@Slf4j</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">AthenaService</span> {\n\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">QUERY_ALL</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">\"SELECT city, population FROM worldcities \"</span> +\n        <span class=\"hljs-string\">\"ORDER BY population DESC LIMIT {limit}\"</span>;\n\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">QUERY</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">\"SELECT city, population FROM worldcities where iso2 = '{country}' \"</span> +\n        <span class=\"hljs-string\">\"ORDER BY population DESC LIMIT {limit}\"</span>;\n\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> AthenaClientFactory athenaClientFactory;\n\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> AthenaQuery athenaQuery;\n\n    <span class=\"hljs-keyword\">public</span> List&#x3C;TopTenCities> <span class=\"hljs-title function_\">getTop10All</span><span class=\"hljs-params\">(Integer limit)</span> {\n        <span class=\"hljs-keyword\">return</span> run(<span class=\"hljs-string\">\"\"</span>, limit, QUERY_ALL);\n    }\n\n    <span class=\"hljs-keyword\">public</span> List&#x3C;TopTenCities> <span class=\"hljs-title function_\">getTop10</span><span class=\"hljs-params\">(String country, Integer limit)</span> {\n        <span class=\"hljs-keyword\">return</span> run(country, limit, QUERY);\n    }\n\n    <span class=\"hljs-keyword\">public</span> List&#x3C;TopTenCities> <span class=\"hljs-title function_\">run</span><span class=\"hljs-params\">(String country, Integer limit, String query)</span> {\n\n        <span class=\"hljs-type\">AthenaClient</span> <span class=\"hljs-variable\">athenaClient</span> <span class=\"hljs-operator\">=</span> athenaClientFactory.createAthenaClient();\n\n        <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">finalQuery</span> <span class=\"hljs-operator\">=</span> query.replace(<span class=\"hljs-string\">\"{country}\"</span>, country)\n            .replace(<span class=\"hljs-string\">\"{limit}\"</span>, String.valueOf(limit));\n        <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">queryExecutionId</span> <span class=\"hljs-operator\">=</span> athenaQuery.createAthenaQuery(athenaClient,\n            finalQuery);\n\n        <span class=\"hljs-keyword\">if</span> (!queryExecutionId.isEmpty()) {\n            log.info(<span class=\"hljs-string\">\"Query submitted with query id {} and current mills {}\"</span>, queryExecutionId, System.currentTimeMillis());\n\n            athenaQuery.completeAthenaQuery(athenaClient, queryExecutionId);\n\n            log.info(<span class=\"hljs-string\">\"Query finished at {}\"</span>, System.currentTimeMillis());\n\n            <span class=\"hljs-keyword\">return</span> processResultRows(athenaClient, queryExecutionId);\n        } <span class=\"hljs-keyword\">else</span> {\n            log.error(<span class=\"hljs-string\">\"Issue while running the query \"</span> + finalQuery);\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">ArrayList</span>&#x3C;>(); <span class=\"hljs-comment\">// return empty array</span>\n        }\n    }\n\n    <span class=\"hljs-keyword\">private</span> List&#x3C;TopTenCities> <span class=\"hljs-title function_\">processResultRows</span><span class=\"hljs-params\">(AthenaClient athenaClient, String queryExecutionId)</span> {\n\n        List&#x3C;TopTenCities> result = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">ArrayList</span>&#x3C;>();\n        <span class=\"hljs-type\">GetQueryResultsRequest</span> <span class=\"hljs-variable\">getQueryResultsRequest</span> <span class=\"hljs-operator\">=</span> GetQueryResultsRequest.builder()\n            .queryExecutionId(queryExecutionId).build();\n\n        <span class=\"hljs-type\">GetQueryResultsIterable</span> <span class=\"hljs-variable\">getQueryResultsResults</span> <span class=\"hljs-operator\">=</span> athenaClient.getQueryResultsPaginator(getQueryResultsRequest);\n\n        <span class=\"hljs-keyword\">for</span> (GetQueryResultsResponse Resultresponse : getQueryResultsResults) {\n            List&#x3C;ColumnInfo> columnInfoList = Resultresponse.resultSet().resultSetMetadata().columnInfo();\n\n            <span class=\"hljs-type\">int</span> <span class=\"hljs-variable\">resultSize</span> <span class=\"hljs-operator\">=</span> Resultresponse.resultSet().rows().size();\n            log.info(<span class=\"hljs-string\">\"Result size: \"</span> + resultSize);\n\n            List&#x3C;Row> results = Resultresponse.resultSet().rows();\n            result = processRow(results, columnInfoList);\n        }\n        <span class=\"hljs-keyword\">return</span> result;\n    }\n\n    <span class=\"hljs-keyword\">private</span> List&#x3C;TopTenCities> <span class=\"hljs-title function_\">processRow</span><span class=\"hljs-params\">(List&#x3C;Row> rowList, List&#x3C;ColumnInfo> columnInfoList)</span> {\n\n        List&#x3C;String> columns = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">ArrayList</span>&#x3C;>();\n        List&#x3C;TopTenCities> result = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">ArrayList</span>&#x3C;>();\n\n        <span class=\"hljs-keyword\">for</span> (ColumnInfo columnInfo : columnInfoList) {\n            columns.add(columnInfo.name());\n        }\n\n        <span class=\"hljs-type\">int</span> <span class=\"hljs-variable\">rowCtr</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">0</span>;\n        <span class=\"hljs-keyword\">for</span> (Row row : rowList) {\n            <span class=\"hljs-type\">int</span> <span class=\"hljs-variable\">index</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">0</span>;\n\n            <span class=\"hljs-comment\">// simple mapping logic for the POJO</span>\n            <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">name</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">\"\"</span>;\n            <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">population</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">\"\"</span>;\n\n            <span class=\"hljs-keyword\">for</span> (Datum datum : row.data()) {\n                log.debug(columns.get(index) + <span class=\"hljs-string\">\": \"</span> + datum.varCharValue());\n                <span class=\"hljs-comment\">// skip row header row</span>\n                <span class=\"hljs-keyword\">if</span> (rowCtr > <span class=\"hljs-number\">0</span>) {\n                    <span class=\"hljs-keyword\">if</span> (index == <span class=\"hljs-number\">0</span>) {\n                        name = datum.varCharValue();\n                    } <span class=\"hljs-keyword\">else</span> {\n                        population = datum.varCharValue();\n                    }\n                }\n                index++;\n            }\n            rowCtr++;\n            <span class=\"hljs-keyword\">if</span> (!name.isEmpty()) {\n                <span class=\"hljs-type\">var</span> <span class=\"hljs-variable\">topTenCities</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">TopTenCities</span>(name, Integer.valueOf(population));\n                result.add(topTenCities);\n            }\n            log.debug(<span class=\"hljs-string\">\"===================================\"</span>);\n        }\n        <span class=\"hljs-keyword\">return</span> result;\n    }\n}\n</code></pre>\n<p>이제 각 부분을 확인하면서 구현 내용을 이해하겠습니다. run 메서드는 주요 기능을 담당합니다. 여기서 SQL 쿼리 생성이 이루어지고, Athena 처리 레이어에서 이전에 살펴본 createAthenaQuery 및 completeAthenaQuery 메서드가 호출됩니다. 전자는 쿼리를 초기화하고 제출하며, 후자는 처리를 계속하기 전에 완료될 때까지 대기합니다.</p>\n<p>AthenaService의 processResultRows 메서드에서 GetQueryResultsRequest 클래스를 사용하여 쿼리 결과를 검색합니다. 이는 전체 결과를 반환하고, processRows가 각 행을 하나씩 처리하고 Java 개체로 매핑하는 데 사용됩니다.</p>\n<h2>Rest API</h2>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>마지막으로 살펴볼 부분은 API 레벨입니다. 여기에서 컨트롤러를 구현합니다.</p>\n<pre><code class=\"hljs language-js\">@<span class=\"hljs-title class_\">RestController</span>\n@<span class=\"hljs-title class_\">RequestMapping</span>(value = <span class=\"hljs-string\">\"/cities\"</span>, produces = <span class=\"hljs-variable constant_\">APPLICATION_JSON_VALUE</span>)\n@<span class=\"hljs-title class_\">AllArgsConstructor</span>\npublic <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">ApiController</span> {\n\n    private final <span class=\"hljs-title class_\">AthenaService</span> athenaService;\n\n    @<span class=\"hljs-title class_\">GetMapping</span>(value = {<span class=\"hljs-string\">\"\"</span>, <span class=\"hljs-string\">\"/\"</span>})\n    public <span class=\"hljs-title class_\">ResponseEntity</span>&#x3C;<span class=\"hljs-title class_\">List</span>&#x3C;<span class=\"hljs-title class_\">TopTenCities</span>>> <span class=\"hljs-title function_\">getTop10All</span>(<span class=\"hljs-params\">@RequestParam(defaultValue = <span class=\"hljs-string\">\"10\"</span>) Integer limit</span>) {\n\n        <span class=\"hljs-title class_\">List</span>&#x3C;<span class=\"hljs-title class_\">TopTenCities</span>> result = athenaService.<span class=\"hljs-title function_\">getTop10All</span>(limit);\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title class_\">ResponseEntity</span>.<span class=\"hljs-title function_\">accepted</span>().<span class=\"hljs-title function_\">body</span>(result);\n    }\n\n    @<span class=\"hljs-title class_\">GetMapping</span>(value = {<span class=\"hljs-string\">\"/{country}\"</span>})\n    public <span class=\"hljs-title class_\">ResponseEntity</span>&#x3C;<span class=\"hljs-title class_\">List</span>&#x3C;<span class=\"hljs-title class_\">TopTenCities</span>>> <span class=\"hljs-title function_\">getTop10</span>(<span class=\"hljs-params\">@PathVariable(<span class=\"hljs-string\">\"country\"</span>) <span class=\"hljs-built_in\">String</span> country,\n                                                       @RequestParam(defaultValue = <span class=\"hljs-string\">\"10\"</span>) Integer limit</span>) {\n\n        <span class=\"hljs-title class_\">List</span>&#x3C;<span class=\"hljs-title class_\">TopTenCities</span>> result = athenaService.<span class=\"hljs-title function_\">getTop10</span>(country, limit);\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title class_\">ResponseEntity</span>.<span class=\"hljs-title function_\">accepted</span>().<span class=\"hljs-title function_\">body</span>(result);\n    }\n}\n</code></pre>\n<p>여기에 두 개의 엔드포인트가 선언되어 있습니다. 하나는 (GET) /cities 이고 다른 하나는 (GET) /cities/'country' 입니다. 두 엔드포인트 모두 선택적으로 쿼리 파라미터를 받아들이며, 반환할 값의 수를 설정할 수 있습니다. 기본값은 10입니다.</p>\n<h1>테스팅</h1>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>위 명령어로 애플리케이션을 시작하여 테스트해보세요.</p>\n<pre><code class=\"hljs language-js\">java -jar target/athena-sample-<span class=\"hljs-number\">0.0</span><span class=\"hljs-number\">.1</span>-<span class=\"hljs-variable constant_\">SNAPSHOT</span>.<span class=\"hljs-property\">jar</span>\n</code></pre>\n<p>이렇게 하면 애플리케이션이 실행됩니다. 브라우저 URL에 다음을 입력하여 실행 여부를 확인할 수 있습니다.</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-attr\">http</span>:<span class=\"hljs-comment\">//localhost:8080/api/actuator</span>\n</code></pre>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>해당 URL을 브라우저에 입력하면 모든 국가의 인구 순으로 상위 열 개의 도시가 반환됩니다.</p>\n<p><a href=\"http://localhost:8080/api/cities\" rel=\"nofollow\" target=\"_blank\">http://localhost:8080/api/cities</a></p>\n<p>다음과 같이 표시됩니다.</p>\n<p><img src=\"/assets/img/2024-06-23-SpringBootwithAmazonAthena_11.png\" alt=\"이미지\"></p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>다음 코드도 시도해 볼 수 있어요.</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-attr\">http</span>:<span class=\"hljs-comment\">//localhost:8080/api/cities/US?limit=15</span>\n</code></pre>\n<p>이렇게 하면 미국 내 인구 순으로 상위 15개의 도시 정보를 받아볼 수 있어요. DE, BR, CA와 같은 다른 국가 코드로도 시도해 보세요.</p>\n<p>우리는 SpringBoot 애플리케이션을 통해 Athena를 쿼리할 수 있음을 보여줬고, 이를 REST API를 통해 모두 연결했어요.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<h1>참고 자료</h1>\n<ul>\n<li>Amazon Athena를 활용한 서버리스 분석 — Packt Publishing — Anthony Virtuoso, Mert Turkay Hocanin, Aaron Wishnick</li>\n</ul>\n<h1>요약</h1>\n<p>오늘은 SpringBoot 애플리케이션에서 Athena로 인터페이스를 만드는 방법을 살펴보았습니다. 우리는 Athena에 대한 배경 정보부터 시작했습니다. 그 후에 CSV 파일을 Athena로 로드하고 사용 가능하게 만드는 방법을 살펴보았습니다. 다음으로 SpringBoot 애플리케이션과 Athena를 연결하고 쿼리하는 방법을 살펴보았습니다. 이러한 클래스들은 여러분의 애플리케이션에 기초를 제공할 수 있습니다. 마지막으로 우리는 테스트를 해보았습니다. 함께 이 여정을 함께해줘서 감사합니다.</p>\n<!-- ui-station 사각형 -->\n<p><ins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"></ins></p>\n<script>\n(adsbygoogle = window.adsbygoogle || []).push({});\n</script>\n<p>이 글의 코드는 제 Github에서 찾아볼 수 있어요.</p>\n<p>즐거운 여정되세요!</p>\n</body>\n</html>\n"},"__N_SSG":true}