<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><title>쿠버네티스 이스티오 앰비언트 메쉬 투어  1부 설정 및 Z터널 사용 방법 | ui-station</title><meta name="description" content=""/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:url" content="https://ui-station.github.io///post/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel" data-gatsby-head="true"/><meta property="og:type" content="website" data-gatsby-head="true"/><meta property="og:site_name" content="쿠버네티스 이스티오 앰비언트 메쉬 투어  1부 설정 및 Z터널 사용 방법 | ui-station" data-gatsby-head="true"/><meta property="og:title" content="쿠버네티스 이스티오 앰비언트 메쉬 투어  1부 설정 및 Z터널 사용 방법 | ui-station" data-gatsby-head="true"/><meta property="og:description" content="" data-gatsby-head="true"/><meta property="og:image" content="/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_0.png" data-gatsby-head="true"/><meta property="og:locale" content="en_US" data-gatsby-head="true"/><meta name="twitter:card" content="summary_large_image" data-gatsby-head="true"/><meta property="twitter:domain" content="https://ui-station.github.io/" data-gatsby-head="true"/><meta property="twitter:url" content="https://ui-station.github.io///post/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel" data-gatsby-head="true"/><meta name="twitter:title" content="쿠버네티스 이스티오 앰비언트 메쉬 투어  1부 설정 및 Z터널 사용 방법 | ui-station" data-gatsby-head="true"/><meta name="twitter:description" content="" data-gatsby-head="true"/><meta name="twitter:image" content="/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_0.png" data-gatsby-head="true"/><meta name="twitter:data1" content="Dev | ui-station" data-gatsby-head="true"/><meta name="article:published_time" content="2024-06-23 23:14" data-gatsby-head="true"/><meta name="next-head-count" content="19"/><meta name="google-site-verification" content="a-yehRo3k3xv7fg6LqRaE8jlE42e5wP2bDE_2F849O4"/><link rel="stylesheet" href="/favicons/favicon.ico"/><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png"/><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/assets/favicons/favicon-96x96.png"/><link rel="icon" href="/favicons/apple-icon-180x180.png"/><link rel="apple-touch-icon" href="/favicons/apple-icon-180x180.png"/><link rel="apple-touch-startup-image" href="/startup.png"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black"/><meta name="msapplication-config" content="/favicons/browserconfig.xml"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-BHFR6GTH9P"></script><script>window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
          
            gtag('config', 'G-BHFR6GTH9P');</script><link rel="preload" href="/_next/static/css/6e57edcf9f2ce551.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6e57edcf9f2ce551.css" data-n-g=""/><link rel="preload" href="/_next/static/css/b8ef307c9aee1e34.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b8ef307c9aee1e34.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee6df16fdc6dae4d.js" defer=""></script><script src="/_next/static/chunks/framework-46611630e39cfdeb.js" defer=""></script><script src="/_next/static/chunks/main-cf4a52eec9a970a0.js" defer=""></script><script src="/_next/static/chunks/pages/_app-6fae11262ee5c69b.js" defer=""></script><script src="/_next/static/chunks/75fc9c18-4a646156c659a948.js" defer=""></script><script src="/_next/static/chunks/348-d11c34b645b13f5b.js" defer=""></script><script src="/_next/static/chunks/162-4172e84c8e2aa747.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-4f7b40c1114f0d09.js" defer=""></script><script src="/_next/static/-dPCbnM2yhdKNgXe92VJV/_buildManifest.js" defer=""></script><script src="/_next/static/-dPCbnM2yhdKNgXe92VJV/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="Header_header__Z8PUO"><div class="Header_inner__tfr0u"><strong class="Header_title__Otn70"><a href="/">UI STATION</a></strong><nav class="Header_nav_area__6KVpk"><a class="nav_item" href="/posts/1">Posts</a></nav></div></header><main class="posts_container__NyRU3"><div class="posts_inner__i3n_i"><h1 class="posts_post_title__EbxNx">쿠버네티스 이스티오 앰비언트 메쉬 투어  1부 설정 및 Z터널 사용 방법</h1><div class="posts_meta__cR7lu"><div class="posts_profile_wrap__mslMl"><div class="posts_profile_image_wrap__kPikV"><img alt="쿠버네티스 이스티오 앰비언트 메쉬 투어  1부 설정 및 Z터널 사용 방법" loading="lazy" width="44" height="44" decoding="async" data-nimg="1" class="profile" style="color:transparent" src="/favicons/apple-icon-114x114.png"/></div><div class="posts_textarea__w_iKT"><span class="writer">UI STATION</span><span class="posts_info__5KJdN"><span class="posts_date__ctqHI">Posted On Jun 23, 2024</span><span class="posts_reading_time__f7YPP">35<!-- --> min read</span></span></div></div><img alt="" loading="lazy" width="50" height="50" decoding="async" data-nimg="1" class="posts_view_badge__tcbfm" style="color:transparent" src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fallround-coder.github.io/post/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel&amp;count_bg=%2379C83D&amp;title_bg=%23555555&amp;icon=&amp;icon_color=%23E7E7E7&amp;title=views&amp;edge_flat=false"/></div><article class="posts_post_content__n_L6j"><div><!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
</head>
<body>
<p>피츠오는 앰비언트 모드로 전환하고 있어요 — 사이드카 없는 모델로 말이죠. 마침내 우리는 CPU와 메모리 소비가 많은 사이드카를 버릴 수 있게 되었어요!</p>
<p>다가오는 장마시즌을 맞아, 저는 피츠오 앰비언트 메시에 간접적으로 참여해보기로 했어요.</p>
<p>이 블로그를 사용하여 여행을 문서화하고, 비슷한 생각을 가진 피츠오 사용자들이 함께 따라올 수 있게 도와볼 거예요 :P.</p>
<p><img src="/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_0.png" alt="이미지"></p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>제가 나름대로 번역해보겠습니다:</p>
<p>안녕하세요! Part 1에서는 주변 메시 실험을 위해 로컬 클러스터 설정을 완벽하게 진행할 예정입니다. 그런 다음 메시의 ztunnel 구성 요소를 탐험할 것입니다.</p>
<p>Part 2에서는 L4 인증 정책에 대해 이야기하고 waypoint 프록시를 시작하는 방법을 살펴볼 것입니다.</p>
<h1>Ambient란 무엇인가요?</h1>
<p>Istio Ambient Mesh는 사이드카 없이 Istio의 새로운 데이터플레인 모드입니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>일반적인 Istio 모드에서는 모든 응용 프로그램 Pod이 envoy 프록시로 주입되었다는 것을 기억하십시오. 그러나 이 새로운 모드에서는 응용 프로그램 Pod이 건드리지 않을 거에요 :) 그리고 그들은 자신의 응용 프로그램 컨테이너만 가지게 될 거에요.</p>
<p><img src="/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_1.png" alt="이미지"></p>
<p>가장 먼저 떠오르는 큰 장점 중 하나는 인프라 비용이 크게 절감된다는 것입니다. 컴퓨팅 코어 및 메모리 관점에서 얼마나 많은 돈을 절약하고 있는지 상상해보세요 !!</p>
<p><img src="/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_2.png" alt="이미지"></p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h1>Ambient Architecture</h1>
<p>과거와 현재의 Ambient Architecture를 상상해 보는 시간입니다. 데이터 평면의 트래픽 흐름 경로에서 그들이 어떻게 다른지 살펴봅시다.</p>
<h2>Sidecar 모드</h2>
<p><img src="/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_3.png" alt="이미지"></p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>이것은 전통적인 사이드카 모델이며 각 서비스 팟에는 애플리케이션 컨테이너와 Envoy 사이드카가 결합되어 있습니다. 애플리케이션으로부터 오고 가는 모든 트래픽은 사이드카에 의해 가로채집니다.</p>
<h2>Ambient 모드, ztunnel 사용</h2>
<p><img src="/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_4.png" alt="이미지"></p>
<p>이 새로운 ambient 모드에서 애플리케이션 팟은 사이드카가 없는 독립적인 팟입니다. 그러나 이 경우에는 클러스터의 각 Kubernetes 노드마다 데몬셋 팟이 실행될 것입니다 - 강력한 ztunnel (제로 트러스트 터널). 노드 내 팟간의 모든 트래픽은 ztunnel에 의해 가로채집됩니다. Ztunnel은 각 노드당 L4 프록시입니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h2>Ambient mode, with ztunnel + waypoint</h2>
<p><img src="/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_5.png" alt="Image"></p>
<p>Ztunnel은 L4 프록시가 필요한 워크로드 간 네트워킹에 충분합니다. http 헤더 기반 라우팅, L7 권한 부여와 같은 L7 요구 사항을 충족시키기 위해 waypoint 프록시라는 워크로드를 배포합니다. 이는 애플리케이션당 envoy 팟으로, 동일한 노드 또는 다른 노드에서 실행될 수 있습니다.</p>
<p>이 경우 ztunnel에서 생성된 트래픽은 waypoint 프록시에 도달하고, waypoint는 그것을 목적지 ztunnel로 전달합니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>그러므로, 어플리케이션이 L7 처리를 요구하지 않는 경우 waypoint를 없애고 ztunnel만 사용할 수 있습니다. 이전 방식에서는, 우리가 L4 요구사항만 가지고 있더라도 envoy sidecars를 반드시 사용해야 했습니다.</p>
<h1>클러스터 설정 깊이에 대한 정보</h1>
<p>이상적으로 지원되는 환경에서 사용할 수 있는 유효한 CNI 설정으로 Kind 클러스터를 설정하는 데 많은 조정이 필요했습니다. 현재는 어떤 공개 GKE/AKS/EKS k8s 클러스터에 대한 실험을 할 수 있는 권한이 없습니다.</p>
<p><img src="/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_6.png" alt="이미지"></p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>그러므로 로컬 Kind 클러스터를 홈 설정하겠습니다.</p>
<h2>시스템 사양</h2>
<ul>
<li>Mac M1 (Apple-Silicon 아키텍처)를 사용하며 기본 구성으로 진행됩니다.</li>
</ul>
<p>시스템 아키텍처(Linux/Windows/Apple Intel)를 고려하여 비슷하게 진행할 수 있습니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<ul>
<li>Rancher Desktop</li>
</ul>
<p>저희 k8s 클러스터를 위해 도커 런타임이 필요한데, 저는 SUSE의 Rancher Desktop을 사용할 예정입니다 — <a href="https://rancherdesktop.io/" rel="nofollow" target="_blank">https://rancherdesktop.io/</a>.</p>
<p>다른 대안으로는 Docker Desktop이 있습니다 — <a href="https://www.docker.com/products/docker-desktop/" rel="nofollow" target="_blank">https://www.docker.com/products/docker-desktop/</a></p>
<ul>
<li>Kind</li>
</ul>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>저는 Multi-Node K8s 클러스터가 필요하다고 생각해요. 그래서 우리가 사용할 최상의 도구는 Kind를 이용해 클러스터를 부트스트랩하는 거죠. 여기 <a href="https://kind.sigs.k8s.io/docs/user/quick-start" rel="nofollow" target="_blank">https://kind.sigs.k8s.io/docs/user/quick-start</a> 에서 보다 자세한 정보를 얻을 수 있어요.</p>
<p>이를 통해 우리는 k8s 노드에 ssh로 접속하고 노드 구성을 실험해볼 수도 있을 거에요.</p>
<p>그리고 블로그에 나온대로 istio-ambient 프로필을 설치한 후에는 Kind 노드에서 문제가 발생할 수 있어요. 여기 <a href="https://kind.sigs.k8s.io/docs/user/known-issues/#pod-errors-due-to-too-many-open-files" rel="nofollow" target="_blank">https://kind.sigs.k8s.io/docs/user/known-issues/#pod-errors-due-to-too-many-open-files</a> 에서 문제를 해결할 수 있어요. 영향을 받는 노드의 sysctl.conf를 수정한 후에는 istio-system pods가 문제없이 생성될 거에요.</p>
<img src="/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_7.png">
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<ul>
<li>CNI(Container Networking Interface)</li>
</ul>
<p>"Istio Ambient Mode"은 Calico, Cilium 등과 같은 CNI와 함께 지원됩니다. Kind 클러스터의 기본 CNI는 "kindnetd"이며, 저는 직접 테스트해 본 결과 ztunnel 팟이 실행되지 않았습니다. 그래서 다른 CNI가 필요했습니다.</p>
<ul>
<li>Cilium CNI도 Mac M1에서 제대로 로드되지 않았습니다. 즉, cilium 데몬셋 팟이 실행되지 않았습니다.</li>
<li>마침내 Calico CNI로 Kind를 설정하는 방법을 찾았습니다. Kind에서 기본 CNI를 비활성화하고 다음과 같이 진행합니다: <a href="https://docs.tigera.io/calico/latest/getting-started/kubernetes/kind" rel="nofollow" target="_blank">https://docs.tigera.io/calico/latest/getting-started/kubernetes/kind</a></li>
<li>이 설정에서 마지막 단계를 따를 수도 있습니다: <a href="https://alexbrand.dev/post/creating-a-kind-cluster-with-calico-networking/" rel="nofollow" target="_blank">https://alexbrand.dev/post/creating-a-kind-cluster-with-calico-networking/</a></li>
</ul>
<h1>Istio 설치</h1>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h2>클러스터 개요</h2>
<p>이스티오를 시작하기 전에 클러스터 스펙을 살펴봅시다.</p>
<p>다음은 Kind 클러스터 설정 스크립트입니다.</p>
<p>마스터 노드 1개와 워커 노드 2개가 있습니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<pre><code class="hljs language-js">(⎈|kind-<span class="hljs-attr">ambient</span>:istio-system)➜  ~ kg 노드
이름                    상태     역할           생성 시간    버전
ambient-control-plane   준비     제어 플레인    <span class="hljs-number">117</span>분     v1<span class="hljs-number">.30</span><span class="hljs-number">.0</span>
ambient-worker          준비     &#x3C;없음>         <span class="hljs-number">116</span>분     v1<span class="hljs-number">.30</span><span class="hljs-number">.0</span>
ambient-worker2         준비     &#x3C;없음>         <span class="hljs-number">116</span>분     v1<span class="hljs-number">.30</span><span class="hljs-number">.0</span>
</code></pre>
<p>또한 Calico CNI 데몬세트가 실행 중인지 확인합니다. 클러스터 CoreDNS도 준비되어 있는지 확인합니다.</p>
<pre><code class="hljs language-js">(⎈|kind-<span class="hljs-attr">ambient</span>:kube-system)➜  ~ kgpo
이름                                            준비     상태      재시작      생성 시간
calico-kube-controllers-564985c589-xmsrp        <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     실행 중  <span class="hljs-number">1</span> (<span class="hljs-number">96</span>분 전)  <span class="hljs-number">117</span>분
calico-node-796kq                               <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     실행 중  <span class="hljs-number">0</span>             <span class="hljs-number">116</span>분
calico-node-l6fsg                               <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     실행 중  <span class="hljs-number">0</span>             <span class="hljs-number">116</span>분
calico-node-zkckp                               <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     실행 중  <span class="hljs-number">0</span>             <span class="hljs-number">116</span>분
coredns-7db6d8ff4d-h88q6                        <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     실행 중  <span class="hljs-number">0</span>             <span class="hljs-number">118</span>분
coredns-7db6d8ff4d-rtncd                        <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     실행 중  <span class="hljs-number">0</span>             <span class="hljs-number">118</span>분
</code></pre>
<h2>Istio Ambient 프로필 설치</h2>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>설치는 간단하게 진행됩니다. 여기에서 찾을 수 있어요: <a href="https://istio.io/v1.20/docs/ops/ambient/getting-started/" rel="nofollow" target="_blank">https://istio.io/v1.20/docs/ops/ambient/getting-started/</a></p>
<pre><code class="hljs language-js">sabuj $ istioctl install --set profile=ambient --set <span class="hljs-string">"components.ingressGateways[0].enabled=true"</span> --set <span class="hljs-string">"components.ingressGateways[0].name=istio-ingressgateway"</span> --skip-confirmation
✔ <span class="hljs-title class_">Istio</span> core가 설치되었습니다
✔ <span class="hljs-title class_">Ztunnel</span>이 설치되었습니다
✔ <span class="hljs-title class_">Istiod</span>가 설치되었습니다
✔ <span class="hljs-variable constant_">CNI</span>가 설치되었습니다
✔ 인그레스 게이트웨이가 설치되었습니다
✔ 설치가 완료되었습니다
이 설치를 주입과 유효성 검사를 위한 기본 설정으로 지정합니다.
</code></pre>
<ul>
<li>내가 사용 중인 Istio 버전은 다음과 같아요.</li>
</ul>
<pre><code class="hljs language-js">(⎈|kind-<span class="hljs-attr">ambient</span>:kube-system)➜  ~ istioctl version
client <span class="hljs-attr">version</span>: <span class="hljs-number">1.15</span><span class="hljs-number">.0</span>
control plane <span class="hljs-attr">version</span>: <span class="hljs-number">1.22</span><span class="hljs-number">.1</span>
data plane <span class="hljs-attr">version</span>: <span class="hljs-number">1.22</span><span class="hljs-number">.1</span> (<span class="hljs-number">4</span> 프록시)
</code></pre>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<ul>
<li>Ztunnel은 각 노드에서 실행되는 데몬세트입니다 — 이 경우 3개의 노드가 있습니다. istio-system 네임스페이스에서 ztunnel이 제대로 실행 중인지 확인해 봅시다.</li>
</ul>
<pre><code class="hljs language-js">(⎈|kind-<span class="hljs-attr">ambient</span>:istio-system)➜  ~ kgpo -owide
<span class="hljs-variable constant_">NAME</span>                                    <span class="hljs-variable constant_">READY</span>   <span class="hljs-variable constant_">STATUS</span>    <span class="hljs-variable constant_">RESTARTS</span>   <span class="hljs-variable constant_">AGE</span>    <span class="hljs-variable constant_">IP</span>               <span class="hljs-variable constant_">NODE</span>                    <span class="hljs-variable constant_">NOMINATED</span> <span class="hljs-variable constant_">NODE</span>   <span class="hljs-variable constant_">READINESS</span> <span class="hljs-variable constant_">GATES</span>
istio-cni-node-7q6z7                    <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          117m   <span class="hljs-number">172.18</span><span class="hljs-number">.0</span><span class="hljs-number">.2</span>       ambient-worker2         &#x3C;none>           &#x3C;none>
istio-cni-node-fg6n4                    <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          117m   <span class="hljs-number">172.18</span><span class="hljs-number">.0</span><span class="hljs-number">.4</span>       ambient-worker          &#x3C;none>           &#x3C;none>
istio-cni-node-gwvl8                    <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          117m   <span class="hljs-number">172.18</span><span class="hljs-number">.0</span><span class="hljs-number">.3</span>       ambient-control-plane   &#x3C;none>           &#x3C;none>
istio-ingressgateway-6f48dfb7db-862sm   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          117m   <span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.70</span>   ambient-worker          &#x3C;none>           &#x3C;none>
istiod-6875bc5c58-n4j7d                 <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          118m   <span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.2</span>    ambient-worker2         &#x3C;none>           &#x3C;none>
ztunnel-62hp8                           <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          117m   <span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.3</span>    ambient-worker2         &#x3C;none>           &#x3C;none>
ztunnel-fv5f8                           <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          117m   <span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.71</span>   ambient-worker          &#x3C;none>           &#x3C;none>
ztunnel-gs52c                           <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          117m   <span class="hljs-number">192.168</span><span class="hljs-number">.208</span><span class="hljs-number">.1</span>    ambient-control-plane   &#x3C;none>           &#x3C;none>

(⎈|kind-<span class="hljs-attr">ambient</span>:istio-system)➜  ~ kg ds
<span class="hljs-variable constant_">NAME</span>             <span class="hljs-variable constant_">DESIRED</span>   <span class="hljs-variable constant_">CURRENT</span>   <span class="hljs-variable constant_">READY</span>   <span class="hljs-variable constant_">UP</span>-<span class="hljs-variable constant_">TO</span>-<span class="hljs-variable constant_">DATE</span>   <span class="hljs-variable constant_">AVAILABLE</span>   <span class="hljs-variable constant_">NODE</span> <span class="hljs-variable constant_">SELECTOR</span>            <span class="hljs-variable constant_">AGE</span>
istio-cni-node   <span class="hljs-number">3</span>         <span class="hljs-number">3</span>         <span class="hljs-number">3</span>       <span class="hljs-number">3</span>            <span class="hljs-number">3</span>           kubernetes.<span class="hljs-property">io</span>/os=linux   119m
ztunnel          <span class="hljs-number">3</span>         <span class="hljs-number">3</span>         <span class="hljs-number">3</span>       <span class="hljs-number">3</span>            <span class="hljs-number">3</span>           kubernetes.<span class="hljs-property">io</span>/os=linux   118m
</code></pre>
<p>정말로 3개의 파드가 있네요 !</p>
<ul>
<li>비슷하게 Istio-cni는 또 다른 설치된 데몬세트입니다.</li>
<li>Istio 제어 평면인 istiod도 실행 중입니다.</li>
<li>우리는 공개 트래픽을 위해 기본 istio ingressgateway도 설치했습니다.</li>
</ul>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h1>작업량 설정</h1>
<p>이 프로젝트의 모든 매니페스트 파일은 여기에서 찾을 수 있습니다: <a href="https://github.com/JanaSabuj/istio-ambient-mesh-exploration" rel="nofollow" target="_blank">https://github.com/JanaSabuj/istio-ambient-mesh-exploration</a></p>
<h2>안건</h2>
<ul>
<li>우리는 앰비언트 프로필 없이 앱을 설정하고, 일반 Istio crds를 사용할 것입니다. 그 후에 앱을 호출할 예정입니다. i) 인그레스 ii) 디버그 클라이언트 pod</li>
<li>그 후에, Istio 데이터 평면 모드를 앰비언트로 전환하고, ztunnel pod를 통해 흐르는 트래픽 경로의 변화를 관찰할 것입니다.</li>
</ul>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h2>네임스페이스</h2>
<p>ambient-demo라는 네임스페이스를 만들어 보겠습니다. 이 네임스페이스에서 앱을 호스팅할 예정입니다.</p>
<pre><code class="hljs language-js">(⎈|kind-<span class="hljs-attr">ambient</span>:istio-system)➜  ~ k create ns ambient-demo

(⎈|kind-<span class="hljs-attr">ambient</span>:istio-system)➜  ~ kg ns
<span class="hljs-variable constant_">NAME</span>                 <span class="hljs-variable constant_">STATUS</span>   <span class="hljs-variable constant_">AGE</span>
<span class="hljs-keyword">default</span>              <span class="hljs-title class_">Active</span>   132m
istio-system         <span class="hljs-title class_">Active</span>   125m
kube-node-lease      <span class="hljs-title class_">Active</span>   132m
kube-public          <span class="hljs-title class_">Active</span>   132m
kube-system          <span class="hljs-title class_">Active</span>   132m
local-path-storage   <span class="hljs-title class_">Active</span>   132m
</code></pre>
<h2>애플리케이션</h2>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>그럼 배포, 서비스 및 서비스 어카운트 yaml을 사용하여 애플리케이션을 배포합니다.</p>
<p>클러스터에서는 다음과 같이 보입니다.</p>
<pre><code class="hljs language-bash">(⎈|kind-ambient:ambient-demo)➜  ~ kg all
NAME                          READY   STATUS    RESTARTS   AGE
pod/httpbin-6f4dc97cb-5dpz9   1/1     Running   0          3m21s
pod/httpbin-6f4dc97cb-swdlb   1/1     Running   0          3m31s

NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
service/httpbin   ClusterIP   10.96.157.221   &#x3C;none>        80/TCP    143m

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/httpbin   2/2     2            2           143m

NAME                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/httpbin-6f4dc97cb    2         2         2       3m31s
</code></pre>
<h2>Istio 구성</h2>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>외부 세계에 노출하기 위해 Istio Gateway 및 Istio VirtualService를 생성하여 Istio Ingress를 통해 액세스할 수 있게 만듭니다.</p>
<ul>
<li>우리는 Istio Ingress 파드에 8081 포트를 통해 게이트웨이를 추가하고 있습니다.</li>
<li>그 다음으로, VirtualService를 통해 ambient-demo 네임스페이스에서 실행되는 httpbin 서비스로 라우팅합니다.</li>
</ul>
<h2>Istio Ingress를 통한 확인</h2>
<p>이제 우리의 응용 프로그램에 액세스할 수 있는지 확인할 수 있습니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<pre><code class="hljs language-js">(⎈|kind-<span class="hljs-attr">ambient</span>:istio-system)➜  ~ kgs
<span class="hljs-variable constant_">NAME</span>                   <span class="hljs-variable constant_">TYPE</span>           <span class="hljs-variable constant_">CLUSTER</span>-<span class="hljs-variable constant_">IP</span>     <span class="hljs-variable constant_">EXTERNAL</span>-<span class="hljs-variable constant_">IP</span>   <span class="hljs-title function_">PORT</span>(S)                                      <span class="hljs-variable constant_">AGE</span>
istio-ingressgateway   <span class="hljs-title class_">LoadBalancer</span>   <span class="hljs-number">10.96</span><span class="hljs-number">.77</span><span class="hljs-number">.172</span>   &#x3C;pending>     <span class="hljs-number">15021</span>:<span class="hljs-number">30807</span>/<span class="hljs-variable constant_">TCP</span>,<span class="hljs-number">80</span>:<span class="hljs-number">30587</span>/<span class="hljs-variable constant_">TCP</span>,<span class="hljs-number">443</span>:<span class="hljs-number">31004</span>/<span class="hljs-variable constant_">TCP</span>   147m
</code></pre>
<p>Kind가 인그레스 서비스를 위한 외부 IP를 제공하지 않았기 때문에, 원하는 리스너 8081에서 인그레스 파드를 포트포워딩하여 외부 액세스를 시뮬레이션할 것입니다.</p>
<pre><code class="hljs language-js">(⎈|kind-<span class="hljs-attr">ambient</span>:istio-system)➜  ~ kpf istio-ingressgateway-6f48dfb7db-862sm <span class="hljs-number">8081</span>
<span class="hljs-title class_">Forwarding</span> <span class="hljs-keyword">from</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8081</span> -> <span class="hljs-number">8081</span>
<span class="hljs-title class_">Forwarding</span> <span class="hljs-keyword">from</span> [::<span class="hljs-number">1</span>]:<span class="hljs-number">8081</span> -> <span class="hljs-number">8081</span>
</code></pre>
<p>브라우저에서 127.0.0.1:8081을 입력하여 애플리케이션을 확인할 수 있습니다!</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<pre><code class="hljs language-js"><span class="hljs-attr">http</span>:<span class="hljs-comment">//127.0.0.1:8081/</span>

httpbin.<span class="hljs-property">org</span>
 <span class="hljs-number">0.9</span><span class="hljs-number">.2</span>
[ <span class="hljs-title class_">Base</span> <span class="hljs-attr">URL</span>: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8081</span>/ ]
간단한 <span class="hljs-variable constant_">HTTP</span> 요청 및 응답 서비스입니다.

로컬에서 실행: $ docker run -p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> kennethreitz/httpbin

개발자 - 웹사이트
개발자에게 이메일 보내기
</code></pre>
<ul>
<li>또 다른 확인 방법은 로컬에서 curl을 통해 하는 것입니다. 우리는 요청이 istio-envoy 파드에 의해 처리된 것을 확인합니다.</li>
</ul>
<pre><code class="hljs language-js">(⎈|kind-<span class="hljs-attr">ambient</span>:istio-system)➜  ~ curl <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8081</span> -v
*   <span class="hljs-title class_">Trying</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8081.</span>..
* <span class="hljs-title class_">Connected</span> to <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> (<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>) port <span class="hljs-number">8081</span>
> <span class="hljs-variable constant_">GET</span> / <span class="hljs-variable constant_">HTTP</span>/<span class="hljs-number">1.1</span>
> <span class="hljs-title class_">Host</span>: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8081</span>
> <span class="hljs-title class_">User</span>-<span class="hljs-title class_">Agent</span>: curl/<span class="hljs-number">8.6</span><span class="hljs-number">.0</span>
> <span class="hljs-title class_">Accept</span>: *<span class="hljs-comment">/*
>
&#x3C; HTTP/1.1 200 OK
&#x3C; server: istio-envoy
&#x3C; date: Sun, 16 Jun 2024 11:52:13 GMT
&#x3C; content-type: text/html; charset=utf-8
&#x3C; content-length: 9593
&#x3C; access-control-allow-origin: *
&#x3C; access-control-allow-credentials: true
&#x3C; x-envoy-upstream-service-time: 271
&#x3C;
&#x3C;!DOCTYPE html>
&#x3C;html lang="en">
...
</span></code></pre>
<h2>디버그 클라이언트 파드를 통한 확인</h2>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>우리는 메쉬 내부 호출을 테스트해보려고 합니다. 따라서 각 노드마다 클라이언트 팟이 하나씩 있는 것이 좋습니다. 이를 위해 디버거 데몬세트 클라이언트 워크로드를 설정할 수 있습니다 — <a href="https://github.com/digitalocean/doks-debug" rel="nofollow" target="_blank">https://github.com/digitalocean/doks-debug</a></p>
<p>사용한 수정된 Manifest: <a href="https://gist.github.com/JanaSabuj/a4dd2504752b8c2b30d2d2d05320f7ef" rel="nofollow" target="_blank">https://gist.github.com/JanaSabuj/a4dd2504752b8c2b30d2d2d05320f7ef</a></p>
<p>저는 이 데몬세트를 우리 ambient-demo 네임스페이스에 배포했습니다.</p>
<pre><code class="hljs language-js">(⎈|kind-<span class="hljs-attr">ambient</span>:ambient-demo)➜  ~ kg ds
<span class="hljs-variable constant_">NAME</span>         <span class="hljs-variable constant_">DESIRED</span>   <span class="hljs-variable constant_">CURRENT</span>   <span class="hljs-variable constant_">READY</span>   <span class="hljs-variable constant_">UP</span>-<span class="hljs-variable constant_">TO</span>-<span class="hljs-variable constant_">DATE</span>   <span class="hljs-variable constant_">AVAILABLE</span>   <span class="hljs-variable constant_">NODE</span> <span class="hljs-variable constant_">SELECTOR</span>   <span class="hljs-variable constant_">AGE</span>
doks-debug   <span class="hljs-number">3</span>         <span class="hljs-number">3</span>         <span class="hljs-number">3</span>       <span class="hljs-number">3</span>            <span class="hljs-number">3</span>           &#x3C;none>          89m

(⎈|kind-<span class="hljs-attr">ambient</span>:ambient-demo)➜  ~ kgpo -owide
<span class="hljs-variable constant_">NAME</span>                      <span class="hljs-variable constant_">READY</span>   <span class="hljs-variable constant_">STATUS</span>    <span class="hljs-variable constant_">RESTARTS</span>   <span class="hljs-variable constant_">AGE</span>   <span class="hljs-variable constant_">IP</span>               <span class="hljs-variable constant_">NODE</span>                    <span class="hljs-variable constant_">NOMINATED</span> <span class="hljs-variable constant_">NODE</span>   <span class="hljs-variable constant_">READINESS</span> <span class="hljs-variable constant_">GATES</span>
doks-debug-j9mm5          <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          90m   <span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.5</span>    ambient-worker2         &#x3C;none>           &#x3C;none>
doks-debug-rdhgq          <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          90m   <span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.73</span>   ambient-worker          &#x3C;none>           &#x3C;none>
doks-debug-v7cld          <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          90m   <span class="hljs-number">192.168</span><span class="hljs-number">.208</span><span class="hljs-number">.3</span>    ambient-control-plane   &#x3C;none>
</code></pre>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>테스트해 보기 위해 디버그 팟으로 진입하여 k8s fqdn httpbin.ambient-demo.svc.cluster.local을 curl을 시도해 보았습니다.</p>
<p>200 OK를 반환하고 있습니다.</p>
<pre><code class="hljs language-js">(⎈|kind-<span class="hljs-attr">ambient</span>:ambient-demo)➜  ~ k exec -it doks-debug-j9mm5 -- <span class="hljs-regexp">/bin/</span>bash

root@doks-debug-<span class="hljs-attr">j9mm5</span>:~# curl httpbin.<span class="hljs-property">ambient</span>-demo.<span class="hljs-property">svc</span>.<span class="hljs-property">cluster</span>.<span class="hljs-property">local</span> -v
*   <span class="hljs-title class_">Trying</span> <span class="hljs-number">10.96</span><span class="hljs-number">.157</span><span class="hljs-number">.221</span>:<span class="hljs-number">80.</span>..
* <span class="hljs-title class_">Connected</span> to httpbin.<span class="hljs-property">ambient</span>-demo.<span class="hljs-property">svc</span>.<span class="hljs-property">cluster</span>.<span class="hljs-property">local</span> (<span class="hljs-number">10.96</span><span class="hljs-number">.157</span><span class="hljs-number">.221</span>) port <span class="hljs-number">80</span> (#<span class="hljs-number">0</span>)
> <span class="hljs-variable constant_">GET</span> / <span class="hljs-variable constant_">HTTP</span>/<span class="hljs-number">1.1</span>
> <span class="hljs-title class_">Host</span>: httpbin.<span class="hljs-property">ambient</span>-demo.<span class="hljs-property">svc</span>.<span class="hljs-property">cluster</span>.<span class="hljs-property">local</span>
> <span class="hljs-title class_">User</span>-<span class="hljs-title class_">Agent</span>: curl/<span class="hljs-number">7.88</span><span class="hljs-number">.1</span>
> <span class="hljs-title class_">Accept</span>: *<span class="hljs-comment">/*
>
&#x3C; HTTP/1.1 200 OK
&#x3C; Server: gunicorn/19.9.0
&#x3C; Date: Sun, 16 Jun 2024 12:06:11 GMT
&#x3C; Connection: keep-alive
&#x3C; Content-Type: text/html; charset=utf-8
&#x3C; Content-Length: 9593
&#x3C; Access-Control-Allow-Origin: *
&#x3C; Access-Control-Allow-Credentials: true
&#x3C;
</span></code></pre>
<h1>Ambient Injection</h1>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>지금까지 앰비언트 모드가 활성화되지 않았습니다. Istio 게이트웨이에서 추가 된 리스너로 인해 요청은 Istio 인그레스 파드에 도착한 다음 VirtualService를 통해 앱 파드로 라우팅됩니다.</p>
<p>매쉬 내부 호출의 경우, 클라이언트와 서버 파드 사이에 직접적인 포드 간 통신이 이루어집니다.</p>
<p><img src="/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_8.png" alt="이미지"></p>
<p>앰비언트를 주입하는 동안 우리는 또한 다음 로그를 계속 추적할 것입니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<ul>
<li>istio-cni</li>
<li>ztunnel</li>
</ul>
<p>Istio가 네임스페이스 ambient-demo에 대한 Ambient Dataplane 모드를 활성화하도록 내부적으로 라우트, iptables 등을 설정했는지 확인하려면 아래 명령어를 사용해보세요.</p>
<pre><code class="hljs language-js">(⎈|kind-<span class="hljs-attr">ambient</span>:ambient-demo)➜
~ kubectl label namespace ambient-demo istio.<span class="hljs-property">io</span>/dataplane-mode=ambient
</code></pre>
<h2>관찰된 로그</h2>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<ul>
<li>istio-cni</li>
</ul>
<pre><code class="hljs language-js">(⎈|kind-<span class="hljs-attr">ambient</span>:ambient-demo)➜ ~ stern istio-cni -n istio-system

istio-cni-node-7q6z7 install-cni <span class="hljs-number">2024</span>-<span class="hljs-number">06</span>-16<span class="hljs-attr">T10</span>:<span class="hljs-number">13</span>:<span class="hljs-number">59.</span>243451Z info ambient <span class="hljs-title class_">Namespace</span> ambient-demo is enabled <span class="hljs-keyword">in</span> ambient mesh
istio-cni-node-7q6z7 install-cni <span class="hljs-number">2024</span>-<span class="hljs-number">06</span>-16<span class="hljs-attr">T10</span>:<span class="hljs-number">13</span>:<span class="hljs-number">59.</span>264500Z info ambient <span class="hljs-keyword">in</span> pod mode - adding pod ambient-demo/httpbin-5bd875fbdd-84vs8 to ztunnel
istio-cni-node-gwvl8 install-cni <span class="hljs-number">2024</span>-<span class="hljs-number">06</span>-16<span class="hljs-attr">T10</span>:<span class="hljs-number">13</span>:<span class="hljs-number">59.</span>291505Z info ambient <span class="hljs-title class_">Namespace</span> ambient-demo is enabled <span class="hljs-keyword">in</span> ambient mesh
istio-cni-node-fg6n4 install-cni <span class="hljs-number">2024</span>-<span class="hljs-number">06</span>-16<span class="hljs-attr">T10</span>:<span class="hljs-number">13</span>:<span class="hljs-number">59.</span>281587Z info ambient <span class="hljs-title class_">Namespace</span> ambient-demo is enabled <span class="hljs-keyword">in</span> ambient mesh
istio-cni-node-fg6n4 install-cni <span class="hljs-number">2024</span>-<span class="hljs-number">06</span>-16<span class="hljs-attr">T10</span>:<span class="hljs-number">13</span>:<span class="hljs-number">59.</span>313668Z info ambient <span class="hljs-keyword">in</span> pod mode - adding pod ambient-demo/httpbin-5bd875fbdd-dp4ct to ztunnel

istio-cni-node-7q6z7 install-cni <span class="hljs-number">2024</span>-<span class="hljs-number">06</span>-16<span class="hljs-attr">T10</span>:<span class="hljs-number">13</span>:<span class="hljs-number">59.</span>264500Z info ambient <span class="hljs-keyword">in</span> pod mode - adding pod ambient-demo/httpbin-5bd875fbdd-84vs8 to ztunnel
istio-cni-node-7q6z7 install-cni <span class="hljs-number">2024</span>-<span class="hljs-number">06</span>-16<span class="hljs-attr">T10</span>:<span class="hljs-number">13</span>:<span class="hljs-number">59.</span>325907Z info iptables <span class="hljs-title class_">Running</span> iptables-restore <span class="hljs-keyword">with</span> the following <span class="hljs-attr">input</span>:
istio-cni-node-7q6z7 install-cni * nat
istio-cni-node-7q6z7 install-cni -N <span class="hljs-variable constant_">ISTIO_OUTPUT</span>
istio-cni-node-7q6z7 install-cni -A <span class="hljs-variable constant_">OUTPUT</span> -j <span class="hljs-variable constant_">ISTIO_OUTPUT</span>
istio-cni-node-7q6z7 install-cni -A <span class="hljs-variable constant_">ISTIO_OUTPUT</span> -d <span class="hljs-number">169.254</span><span class="hljs-number">.7</span><span class="hljs-number">.127</span> -p tcp -m tcp -j <span class="hljs-variable constant_">ACCEPT</span>
istio-cni-node-7q6z7 install-cni -A <span class="hljs-variable constant_">ISTIO_OUTPUT</span> -p tcp -m mark --mark <span class="hljs-number">0x111</span>/<span class="hljs-number">0xfff</span> -j <span class="hljs-variable constant_">ACCEPT</span>
istio-cni-node-7q6z7 install-cni -A <span class="hljs-variable constant_">ISTIO_OUTPUT</span> ! -d <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>/<span class="hljs-number">32</span> -o lo -j <span class="hljs-variable constant_">ACCEPT</span>
istio-cni-node-7q6z7 install-cni -A <span class="hljs-variable constant_">ISTIO_OUTPUT</span> ! -d <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>/<span class="hljs-number">32</span> -p tcp -m mark ! --mark <span class="hljs-number">0x539</span>/<span class="hljs-number">0xfff</span> -j <span class="hljs-variable constant_">REDIRECT</span> --to-ports <span class="hljs-number">15001</span>
istio-cni-node-7q6z7 install-cni <span class="hljs-variable constant_">COMMIT</span>
istio-cni-node-7q6z7 install-cni * mangle
istio-cni-node-7q6z7 install-cni -N <span class="hljs-variable constant_">ISTIO_PRERT</span>
istio-cni-node-7q6z7 install-cni -N <span class="hljs-variable constant_">ISTIO_OUTPUT</span>
istio-cni-node-7q6z7 install-cni -A <span class="hljs-variable constant_">PREROUTING</span> -j <span class="hljs-variable constant_">ISTIO_PRERT</span>
istio-cni-node-7q6z7 install-cni -A <span class="hljs-variable constant_">OUTPUT</span> -j <span class="hljs-variable constant_">ISTIO_OUTPUT</span>
istio-cni-node-7q6z7 install-cni -A <span class="hljs-variable constant_">ISTIO_PRERT</span> -m mark --mark <span class="hljs-number">0x539</span>/<span class="hljs-number">0xfff</span> -j <span class="hljs-variable constant_">CONNMARK</span> --set-xmark <span class="hljs-number">0x111</span>/<span class="hljs-number">0xfff</span>
istio-cni-node-7q6z7 install-cni -A <span class="hljs-variable constant_">ISTIO_PRERT</span> -s <span class="hljs-number">169.254</span><span class="hljs-number">.7</span><span class="hljs-number">.127</span> -p tcp -m tcp -j <span class="hljs-variable constant_">ACCEPT</span>
istio-cni-node-7q6z7 install-cni -A <span class="hljs-variable constant_">ISTIO_PRERT</span> ! -d <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>/<span class="hljs-number">32</span> -p tcp -i lo -j <span class="hljs-variable constant_">ACCEPT</span>
istio-cni-node-7q6z7 install-cni -A <span class="hljs-variable constant_">ISTIO_PRERT</span> -p tcp -m tcp --dport <span class="hljs-number">15008</span> -m mark ! --mark <span class="hljs-number">0x539</span>/<span class="hljs-number">0xfff</span> -j <span class="hljs-variable constant_">TPROXY</span> --on-port <span class="hljs-number">15008</span> --tproxy-mark <span class="hljs-number">0x111</span>/<span class="hljs-number">0xfff</span>
istio-cni-node-7q6z7 install-cni -A <span class="hljs-variable constant_">ISTIO_PRERT</span> -p tcp -m conntrack --ctstate <span class="hljs-variable constant_">RELATED</span>,<span class="hljs-variable constant_">ESTABLISHED</span> -j <span class="hljs-variable constant_">ACCEPT</span>
istio-cni-node-7q6z7 install-cni -A <span class="hljs-variable constant_">ISTIO_PRERT</span> ! -d <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>/<span class="hljs-number">32</span> -p tcp -m mark ! --mark <span class="hljs-number">0x539</span>/<span class="hljs-number">0xfff</span> -j <span class="hljs-variable constant_">TPROXY</span> --on-port <span class="hljs-number">15006</span> --tproxy-mark <span class="hljs-number">0x111</span>/<span class="hljs-number">0xfff</span>
istio-cni-node-7q6z7 install-cni -A <span class="hljs-variable constant_">ISTIO_OUTPUT</span> -m connmark --mark <span class="hljs-number">0x111</span>/<span class="hljs-number">0xfff</span> -j <span class="hljs-variable constant_">CONNMARK</span> --restore-mark --nfmask <span class="hljs-number">0xffffffff</span> --ctmask <span class="hljs-number">0xffffffff</span>
istio-cni-node-7q6z7 install-cni <span class="hljs-variable constant_">COMMIT</span>
istio-cni-node-7q6z7 install-cni <span class="hljs-number">2024</span>-<span class="hljs-number">06</span>-16<span class="hljs-attr">T10</span>:<span class="hljs-number">13</span>:<span class="hljs-number">59.</span>335115Z info <span class="hljs-title class_">Running</span> command (<span class="hljs-keyword">with</span> wait lock): iptables-restore --noflush -v --wait=<span class="hljs-number">30</span>
istio-cni-node-7q6z7 install-cni <span class="hljs-number">2024</span>-<span class="hljs-number">06</span>-16<span class="hljs-attr">T10</span>:<span class="hljs-number">13</span>:<span class="hljs-number">59.</span>550687Z info ambient <span class="hljs-title class_">About</span> to send added <span class="hljs-attr">pod</span>: 3ab72f78-8e2b-<span class="hljs-number">4e49</span>-bc47-45fa4f90dbf7 to <span class="hljs-attr">ztunnel</span>: <span class="hljs-attr">add</span>:{<span class="hljs-attr">uid</span>:<span class="hljs-string">"3ab72f78-8e2b-4e49-bc47-45fa4f90dbf7"</span> <span class="hljs-attr">workload_info</span>:{<span class="hljs-attr">name</span>:<span class="hljs-string">"httpbin-5bd875fbdd-84vs8"</span> <span class="hljs-attr">namespace</span>:<span class="hljs-string">"ambient-demo"</span> <span class="hljs-attr">service_account</span>:<span class="hljs-string">"default"</span> <span class="hljs-attr">trust_domain</span>:<span class="hljs-string">"cluster.local"</span>}
</code></pre>
<p>많은 로그가 생성되었습니다. 우리는 각 httpbin pod를 ambient-demo 네임스페이스에 추가하여 ztunnel을 통해 ambient 경로에 추가하고 있음을 확인할 수 있습니다.</p>
<ul>
<li>ztunnel</li>
</ul>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<pre><code class="hljs language-plaintext">(⎈|kind-ambient:ambient-demo)➜ ~ stern ztunnel -n istio-system

ztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.559505Z 정보 inpod::statemanager pod WorkloadUid("3ab72f78-8e2b-4e49-bc47-45fa4f90dbf7")가 netns를 수신하고 프록시를 시작합니다.
ztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.557545Z 정보 inpod::statemanager pod WorkloadUid("7f8be6a6-64f2-40e9-8926-6c3a618eb7d9")가 netns를 수신하고 프록시를 시작합니다.
ztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.560458Z 정보 proxy::inbound 리스너가 구성되었으며 주소=[::]:15008 구성요소="inbound" 투명=true
ztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.561604Z 정보 proxy::inbound_passthrough 리스너가 구성되었으며 주소=[::]:15006 구성요소="inbound plaintext" 투명=true
ztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.561647Z 정보 proxy::outbound 리스너가 구성되었으며 주소=[::]:15001 구성요소="outbound" 투명=true
ztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.573883Z 정보 proxy::inbound 리스너가 구성되었으며 주소=[::]:15008 구성요소="inbound" 투명=true
ztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.586596Z 정보 proxy::inbound_passthrough 리스너가 구성되었으며 주소=[::]:15006 구성요소="inbound plaintext" 투명=true
ztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.586819Z 정보 proxy::outbound 리스너가 구성되었으며 주소=[::]:15001 구성요소="outbound" 투명=true
ztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.811460Z 정보 xds::client:xds{id=14}가 응답을 수신했습니다. type_url="type.googleapis.com/istio.workload.Address" 크기=2  삭제=0
ztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.816352Z 정보 xds::client:xds{id=14}가 응답을 수신했습니다. type_url="type.googleapis.com/istio.workload.Address" 크기=2  삭제=0
ztunnel-gs52c istio-proxy 2024-06-16T10:13:59.821310Z 정보 xds::client:xds{id=14}가 응답을 수신했습니다. type_url="type.googleapis.com/istio.workload.Address" 크기=2  삭제=0
</code></pre>
<p>ztunnel이 자체 내부 및 외부 리스너를 설정 중인 것으로 보입니다.</p>
<h2>트래픽 흐름 - Istio Ingress를 통해</h2>
<p>이전과 마찬가지로, istio-ingress pod로 포트 포워딩을 설정하고 localhost를 통해 액세스합니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>두 개의 호출을 각각 2개의 httpbin 팟에 대응하도록 인그레스에서 호출을 추출하려고 합니다. 그리고 동시에 동일한 ztunnel 로그를 캡처하려고 합니다.</p>
<pre><code class="hljs language-js">(⎈|kind-<span class="hljs-attr">ambient</span>:istio-system)➜  ~ kpf istio-ingressgateway-6f48dfb7db-862sm <span class="hljs-number">8081</span>
<span class="hljs-title class_">Forwarding</span> <span class="hljs-keyword">from</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8081</span> -> <span class="hljs-number">8081</span>

$ curl <span class="hljs-attr">localhost</span>:<span class="hljs-number">8081</span>/
$ curl <span class="hljs-attr">localhost</span>:<span class="hljs-number">8081</span>/
</code></pre>
<pre><code class="hljs language-js">(⎈|kind-<span class="hljs-attr">ambient</span>:istio-system)➜  ~ stern ztunnel -n istio-system

ztunnel-fv5f8 istio-proxy <span class="hljs-number">2024</span>-<span class="hljs-number">06</span>-16<span class="hljs-attr">T12</span>:<span class="hljs-number">26</span>:<span class="hljs-number">24.</span>154500Z
info access connection complete src.<span class="hljs-property">addr</span>=<span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.70</span>:<span class="hljs-number">52792</span>
src.<span class="hljs-property">workload</span>=istio-ingressgateway-6f48dfb7db-862sm src.<span class="hljs-property">namespace</span>=istio-system
src.<span class="hljs-property">identity</span>=<span class="hljs-string">"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"</span>
dst.<span class="hljs-property">addr</span>=<span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.74</span>:<span class="hljs-number">80</span> dst.<span class="hljs-property">hbone_addr</span>=<span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.74</span>:<span class="hljs-number">80</span>
dst.<span class="hljs-property">service</span>=httpbin.<span class="hljs-property">ambient</span>-demo.<span class="hljs-property">svc</span>.<span class="hljs-property">cluster</span>.<span class="hljs-property">local</span>
dst.<span class="hljs-property">workload</span>=httpbin-6f4dc97cb-swdlb dst.<span class="hljs-property">namespace</span>=ambient-demo
dst.<span class="hljs-property">identity</span>=<span class="hljs-string">"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa"</span>
direction=<span class="hljs-string">"inbound"</span> bytes_sent=<span class="hljs-number">51083</span> bytes_recv=<span class="hljs-number">4180</span> duration=<span class="hljs-string">"2166ms"</span>

ztunnel-62hp8 istio-proxy <span class="hljs-number">2024</span>-<span class="hljs-number">06</span>-16<span class="hljs-attr">T12</span>:<span class="hljs-number">28</span>:<span class="hljs-number">40.</span>267690Z
info access connection complete src.<span class="hljs-property">addr</span>=<span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.70</span>:<span class="hljs-number">55036</span>
src.<span class="hljs-property">workload</span>=istio-ingressgateway-6f48dfb7db-862sm src.<span class="hljs-property">namespace</span>=istio-system
src.<span class="hljs-property">identity</span>=<span class="hljs-string">"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"</span>
dst.<span class="hljs-property">addr</span>=<span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.6</span>:<span class="hljs-number">80</span> dst.<span class="hljs-property">hbone_addr</span>=<span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.6</span>:<span class="hljs-number">80</span>
dst.<span class="hljs-property">service</span>=httpbin.<span class="hljs-property">ambient</span>-demo.<span class="hljs-property">svc</span>.<span class="hljs-property">cluster</span>.<span class="hljs-property">local</span>
dst.<span class="hljs-property">workload</span>=httpbin-6f4dc97cb-5dpz9 dst.<span class="hljs-property">namespace</span>=ambient-demo
dst.<span class="hljs-property">identity</span>=<span class="hljs-string">"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa"</span>
direction=<span class="hljs-string">"inbound"</span> bytes_sent=<span class="hljs-number">41251</span> bytes_recv=<span class="hljs-number">2007</span> duration=<span class="hljs-string">"2331ms"</span>
</code></pre>
<p>인그레스가 주변 데이터 플레인 경로에 떨어지지 않기 때문에 인그레스 팟에서의 호출은 주변 데이터 플레인 경로로 직접 ztunnel 팟으로 이어집니다. 한 번에 하나의 노드로 이동한 후 해당 내부 노드 팟으로 inbound됩니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>아래는 로그 캡처에서 확인한 내용입니다</p>
<pre><code class="hljs language-js">direction = <span class="hljs-string">"inbound"</span>;
</code></pre>
<ul>
<li>이는 주변 레이블이 붙은 네임스페이스 파드로의 트래픽이 항상 ztunnel을 통해 이동함을 확인합니다.</li>
</ul>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>dst.hbone_addr=192.168.184.74:80
dst.hbone_addr=192.168.246.6:80</p>
<p>httpbin-6f4dc97cb-5dpz9 1/1 Running 0 56m 192.168.246.6 ambient-worker2 <none> <none>
httpbin-6f4dc97cb-swdlb 1/1 Running 0 56m 192.168.184.74 ambient-worker <none> <none></none></none></none></none></p>
<ul>
<li>이것은 실제 httpbin pod ip에 해당하는 dest pod ip를 캡처합니다.</li>
</ul>
<h2>트래픽 흐름 — Mesh 내부를 통해</h2>
<p>클라이언트 디버그 pod에 exec하여 httpbin 서비스로의 Mesh 내부 호출을 시도하고 동시에 ztunnel 로그를 캡쳐하여 동일한 동작을 확인해보겠습니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<pre><code class="hljs language-js">(⎈|kind-<span class="hljs-attr">ambient</span>:ambient-demo)➜  ~ kgpo -owide
<span class="hljs-variable constant_">NAME</span>                      <span class="hljs-variable constant_">READY</span>   <span class="hljs-variable constant_">STATUS</span>    <span class="hljs-variable constant_">RESTARTS</span>   <span class="hljs-variable constant_">AGE</span>    <span class="hljs-variable constant_">IP</span>               <span class="hljs-variable constant_">NODE</span>                    <span class="hljs-variable constant_">NOMINATED</span> <span class="hljs-variable constant_">NODE</span>   <span class="hljs-variable constant_">READINESS</span> <span class="hljs-variable constant_">GATES</span>
doks-debug-j9mm5          <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          122m   <span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.5</span>    ambient-worker2         &#x3C;none>           &#x3C;none>
doks-debug-rdhgq          <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          122m   <span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.73</span>   ambient-worker          &#x3C;none>           &#x3C;none>
doks-debug-v7cld          <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          122m   <span class="hljs-number">192.168</span><span class="hljs-number">.208</span><span class="hljs-number">.3</span>    ambient-control-plane   &#x3C;none>           &#x3C;none>
httpbin-6f4dc97cb-5dpz9   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          56m    <span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.6</span>    ambient-worker2         &#x3C;none>           &#x3C;none>
httpbin-6f4dc97cb-swdlb   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          56m    <span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.74</span>   ambient-worker          &#x3C;none>           &#x3C;none>
</code></pre>
<p>그냥 같은 노드에 있는 클라이언트와 앱 팟들을 연결하기 위해 —</p>
<pre><code class="hljs language-js">(⎈|kind-<span class="hljs-attr">ambient</span>:ambient-demo)➜  ~ kgpo -A -owide | grep <span class="hljs-string">"ambient-worker "</span>
ambient-demo         doks-debug-rdhgq                                <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>               133m    <span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.73</span>   ambient-worker          &#x3C;none>           &#x3C;none>
istio-system         ztunnel-fv5f8                                   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>               3h24m   <span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.71</span>   ambient-worker          &#x3C;none>           &#x3C;none>
ambient-demo         httpbin-6f4dc97cb-swdlb                         <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>               68m     <span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.74</span>   ambient-worker          &#x3C;none>           &#x3C;none>


(⎈|kind-<span class="hljs-attr">ambient</span>:ambient-demo)➜  ~ kgpo -A -owide | grep <span class="hljs-string">"ambient-worker2"</span>
kube-system          doks-debug-9nlh7                                <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>               3h6m    <span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.4</span>    ambient-worker2         &#x3C;none>           &#x3C;none>
istio-system         ztunnel-62hp8                                   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>               3h23m   <span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.3</span>    ambient-worker2         &#x3C;none>           &#x3C;none>
ambient-demo         httpbin-6f4dc97cb-5dpz9                         <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>               67m     <span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.6</span>    ambient-worker2         &#x3C;none>           &#x3C;none>
</code></pre>
<p>debug pod인 doks-debug-rdhgq를 실행하기 위해 ambient-worker 노드에 스케줄된 상태로 들어가보겠습니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<img src="/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_10.png">
<pre><code class="hljs language-js">테이블 <span class="hljs-number">1</span>: 동일 노드 내의 클라이언트 및 서버
---------
ztunnel-fv5f8 istio-proxy <span class="hljs-number">2024</span>-<span class="hljs-number">06</span>-16<span class="hljs-attr">T12</span>:<span class="hljs-number">40</span>:<span class="hljs-number">48.</span>707707Z info access connection complete src.<span class="hljs-property">addr</span>=<span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.73</span>:<span class="hljs-number">56463</span> src.<span class="hljs-property">workload</span>=doks-debug-rdhgq src.<span class="hljs-property">namespace</span>=ambient-demo src.<span class="hljs-property">identity</span>=<span class="hljs-string">"spiffe://cluster.local/ns/ambient-demo/sa/default"</span> dst.<span class="hljs-property">addr</span>=<span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.74</span>:<span class="hljs-number">80</span> dst.<span class="hljs-property">hbone_addr</span>=<span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.74</span>:<span class="hljs-number">80</span> dst.<span class="hljs-property">service</span>=httpbin.<span class="hljs-property">ambient</span>-demo.<span class="hljs-property">svc</span>.<span class="hljs-property">cluster</span>.<span class="hljs-property">local</span> dst.<span class="hljs-property">workload</span>=httpbin-6f4dc97cb-swdlb dst.<span class="hljs-property">namespace</span>=ambient-demo dst.<span class="hljs-property">identity</span>=<span class="hljs-string">"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa"</span> direction  =<span class="hljs-string">"inbound"</span> bytes_sent=<span class="hljs-number">9832</span> bytes_recv=<span class="hljs-number">84</span> duration=<span class="hljs-string">"178ms"</span>
ztunnel-fv5f8 istio-proxy <span class="hljs-number">2024</span>-<span class="hljs-number">06</span>-16<span class="hljs-attr">T12</span>:<span class="hljs-number">40</span>:<span class="hljs-number">48.</span>708070Z info access connection complete src.<span class="hljs-property">addr</span>=<span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.73</span>:<span class="hljs-number">34190</span> src.<span class="hljs-property">workload</span>=doks-debug-rdhgq src.<span class="hljs-property">namespace</span>=ambient-demo src.<span class="hljs-property">identity</span>=<span class="hljs-string">"spiffe://cluster.local/ns/ambient-demo/sa/default"</span> dst.<span class="hljs-property">addr</span>=<span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.74</span>:<span class="hljs-number">15008</span> dst.<span class="hljs-property">hbone_addr</span>=<span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.74</span>:<span class="hljs-number">80</span> dst.<span class="hljs-property">service</span>=httpbin.<span class="hljs-property">ambient</span>-demo.<span class="hljs-property">svc</span>.<span class="hljs-property">cluster</span>.<span class="hljs-property">local</span> dst.<span class="hljs-property">workload</span>=httpbin-6f4dc97cb-swdlb dst.<span class="hljs-property">namespace</span>=ambient-demo dst.<span class="hljs-property">identity</span>=<span class="hljs-string">"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa"</span> direction=<span class="hljs-string">"outbound"</span> bytes_sent=<span class="hljs-number">84</span> bytes_recv=<span class="hljs-number">9832</span> duration=<span class="hljs-string">"203ms"</span>
</code></pre>
<p>동일 노드 내의 클라이언트와 서버의 경우, 파드에서 ztunnel로 외부 패킷이 들어오면 동일한 ztunnel을 통해 대상 파드로 들어오는 내부 패킷으로 리디렉션됩니다.</p>
<p>따라서, 동일 노드 내의 클라이언트 및 서버에서는 한 ztunnel이 외부 패킷과 내부 패킷을 받습니다. "bound"는 동일 노드 내의 응용 프로그램 파드로부터/받는 방향을 지정합니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<pre><code class="hljs language-js">캡처 <span class="hljs-number">2</span>: 클라이언트 및 서버가 다른 노드에 있는 경우
---------
ztunnel-62hp8 istio-proxy <span class="hljs-number">2024</span>-<span class="hljs-number">06</span>-16<span class="hljs-attr">T12</span>:<span class="hljs-number">48</span>:<span class="hljs-number">51.</span>792527Z info access connection complete src.<span class="hljs-property">addr</span>=<span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.73</span>:<span class="hljs-number">53265</span> src.<span class="hljs-property">workload</span>=doks-debug-rdhgq src.<span class="hljs-property">namespace</span>=ambient-demo src.<span class="hljs-property">identity</span>=<span class="hljs-string">"spiffe://cluster.local/ns/ambient-demo/sa/default"</span> dst.<span class="hljs-property">addr</span>=<span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.6</span>:<span class="hljs-number">80</span> dst.<span class="hljs-property">hbone_addr</span>=<span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.6</span>:<span class="hljs-number">80</span> dst.<span class="hljs-property">service</span>=httpbin.<span class="hljs-property">ambient</span>-demo.<span class="hljs-property">svc</span>.<span class="hljs-property">cluster</span>.<span class="hljs-property">local</span> dst.<span class="hljs-property">workload</span>=httpbin-6f4dc97cb-5dpz9 dst.<span class="hljs-property">namespace</span>=ambient-demo dst.<span class="hljs-property">identity</span>=<span class="hljs-string">"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa"</span> direction=<span class="hljs-string">"inbound"</span> bytes_sent=<span class="hljs-number">9832</span> bytes_recv=<span class="hljs-number">84</span> duration=<span class="hljs-string">"60ms"</span>
ztunnel-fv5f8 istio-proxy <span class="hljs-number">2024</span>-<span class="hljs-number">06</span>-16<span class="hljs-attr">T12</span>:<span class="hljs-number">48</span>:<span class="hljs-number">51.</span>793112Z info access connection complete src.<span class="hljs-property">addr</span>=<span class="hljs-number">192.168</span><span class="hljs-number">.184</span><span class="hljs-number">.73</span>:<span class="hljs-number">60162</span> src.<span class="hljs-property">workload</span>=doks-debug-rdhgq src.<span class="hljs-property">namespace</span>=ambient-demo src.<span class="hljs-property">identity</span>=<span class="hljs-string">"spiffe://cluster.local/ns/ambient-demo/sa/default"</span> dst.<span class="hljs-property">addr</span>=<span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.6</span>:<span class="hljs-number">15008</span> dst.<span class="hljs-property">hbone_addr</span>=<span class="hljs-number">192.168</span><span class="hljs-number">.246</span><span class="hljs-number">.6</span>:<span class="hljs-number">80</span> dst.<span class="hljs-property">service</span>=httpbin.<span class="hljs-property">ambient</span>-demo.<span class="hljs-property">svc</span>.<span class="hljs-property">cluster</span>.<span class="hljs-property">local</span> dst.<span class="hljs-property">workload</span>=httpbin-6f4dc97cb-5dpz9 dst.<span class="hljs-property">namespace</span>=ambient-demo dst.<span class="hljs-property">identity</span>=<span class="hljs-string">"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa"</span> direction=<span class="hljs-string">"outbound"</span> bytes_sent=<span class="hljs-number">84</span> bytes_recv=<span class="hljs-number">9832</span> duration=<span class="hljs-string">"61ms"</span>
</code></pre>
<p>만약 클라이언트와 서버가 다른 노드에 있는 경우, 출발 트래픽은 동일한 노드인 ztunnel에서 외부 트래픽 패킷을 만나고, 그런 다음 목적지 파드의 노드의 ztunnel로 전송되어 들어오는 패킷으로 처리됩니다.</p>
<h1>결론</h1>
<p>이 실험을 통해 Istio Ambient Mesh에서 ztunnel을 통한 패킷 흐름을 시각화할 수 있었습니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p><img src="/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_11.png" alt="이미지"></p>
<p>다음 파트에서는 ztunnel을 통해 적용할 수 있는 L4 인증 정책을 탐색할 것입니다.</p>
<p>또한 Ambient에 있는 L7 프록시인 Waypoint Proxy에 대해 탐구할 것입니다.</p>
<p>다른 기술 블로그는 여기에서 확인할 수 있습니다: <a href="https://janasabuj.github.io/posts/" rel="nofollow" target="_blank">링크</a></p>
</body>
</html>
</div></article></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"쿠버네티스 이스티오 앰비언트 메쉬 투어  1부 설정 및 Z터널 사용 방법","description":"","date":"2024-06-23 23:14","slug":"2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel","content":"\n피츠오는 앰비언트 모드로 전환하고 있어요 — 사이드카 없는 모델로 말이죠. 마침내 우리는 CPU와 메모리 소비가 많은 사이드카를 버릴 수 있게 되었어요!\n\n다가오는 장마시즌을 맞아, 저는 피츠오 앰비언트 메시에 간접적으로 참여해보기로 했어요.\n\n이 블로그를 사용하여 여행을 문서화하고, 비슷한 생각을 가진 피츠오 사용자들이 함께 따라올 수 있게 도와볼 거예요 :P.\n\n![이미지](/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_0.png)\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n제가 나름대로 번역해보겠습니다:\n\n안녕하세요! Part 1에서는 주변 메시 실험을 위해 로컬 클러스터 설정을 완벽하게 진행할 예정입니다. 그런 다음 메시의 ztunnel 구성 요소를 탐험할 것입니다.\n\nPart 2에서는 L4 인증 정책에 대해 이야기하고 waypoint 프록시를 시작하는 방법을 살펴볼 것입니다.\n\n# Ambient란 무엇인가요?\n\nIstio Ambient Mesh는 사이드카 없이 Istio의 새로운 데이터플레인 모드입니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n일반적인 Istio 모드에서는 모든 응용 프로그램 Pod이 envoy 프록시로 주입되었다는 것을 기억하십시오. 그러나 이 새로운 모드에서는 응용 프로그램 Pod이 건드리지 않을 거에요 :) 그리고 그들은 자신의 응용 프로그램 컨테이너만 가지게 될 거에요.\n\n![이미지](/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_1.png)\n\n가장 먼저 떠오르는 큰 장점 중 하나는 인프라 비용이 크게 절감된다는 것입니다. 컴퓨팅 코어 및 메모리 관점에서 얼마나 많은 돈을 절약하고 있는지 상상해보세요 !!\n\n![이미지](/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_2.png)\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n# Ambient Architecture\n\n과거와 현재의 Ambient Architecture를 상상해 보는 시간입니다. 데이터 평면의 트래픽 흐름 경로에서 그들이 어떻게 다른지 살펴봅시다.\n\n## Sidecar 모드\n\n![이미지](/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_3.png)\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n이것은 전통적인 사이드카 모델이며 각 서비스 팟에는 애플리케이션 컨테이너와 Envoy 사이드카가 결합되어 있습니다. 애플리케이션으로부터 오고 가는 모든 트래픽은 사이드카에 의해 가로채집니다.\n\n## Ambient 모드, ztunnel 사용\n\n![이미지](/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_4.png)\n\n이 새로운 ambient 모드에서 애플리케이션 팟은 사이드카가 없는 독립적인 팟입니다. 그러나 이 경우에는 클러스터의 각 Kubernetes 노드마다 데몬셋 팟이 실행될 것입니다 - 강력한 ztunnel (제로 트러스트 터널). 노드 내 팟간의 모든 트래픽은 ztunnel에 의해 가로채집됩니다. Ztunnel은 각 노드당 L4 프록시입니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n## Ambient mode, with ztunnel + waypoint\n\n![Image](/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_5.png)\n\nZtunnel은 L4 프록시가 필요한 워크로드 간 네트워킹에 충분합니다. http 헤더 기반 라우팅, L7 권한 부여와 같은 L7 요구 사항을 충족시키기 위해 waypoint 프록시라는 워크로드를 배포합니다. 이는 애플리케이션당 envoy 팟으로, 동일한 노드 또는 다른 노드에서 실행될 수 있습니다.\n\n이 경우 ztunnel에서 생성된 트래픽은 waypoint 프록시에 도달하고, waypoint는 그것을 목적지 ztunnel로 전달합니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n그러므로, 어플리케이션이 L7 처리를 요구하지 않는 경우 waypoint를 없애고 ztunnel만 사용할 수 있습니다. 이전 방식에서는, 우리가 L4 요구사항만 가지고 있더라도 envoy sidecars를 반드시 사용해야 했습니다.\n\n# 클러스터 설정 깊이에 대한 정보\n\n이상적으로 지원되는 환경에서 사용할 수 있는 유효한 CNI 설정으로 Kind 클러스터를 설정하는 데 많은 조정이 필요했습니다. 현재는 어떤 공개 GKE/AKS/EKS k8s 클러스터에 대한 실험을 할 수 있는 권한이 없습니다.\n\n![이미지](/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_6.png)\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n그러므로 로컬 Kind 클러스터를 홈 설정하겠습니다.\n\n## 시스템 사양\n\n- Mac M1 (Apple-Silicon 아키텍처)를 사용하며 기본 구성으로 진행됩니다.\n\n시스템 아키텍처(Linux/Windows/Apple Intel)를 고려하여 비슷하게 진행할 수 있습니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n- Rancher Desktop\n\n저희 k8s 클러스터를 위해 도커 런타임이 필요한데, 저는 SUSE의 Rancher Desktop을 사용할 예정입니다 — https://rancherdesktop.io/.\n\n다른 대안으로는 Docker Desktop이 있습니다 — https://www.docker.com/products/docker-desktop/\n\n- Kind\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n저는 Multi-Node K8s 클러스터가 필요하다고 생각해요. 그래서 우리가 사용할 최상의 도구는 Kind를 이용해 클러스터를 부트스트랩하는 거죠. 여기 https://kind.sigs.k8s.io/docs/user/quick-start 에서 보다 자세한 정보를 얻을 수 있어요.\n\n이를 통해 우리는 k8s 노드에 ssh로 접속하고 노드 구성을 실험해볼 수도 있을 거에요.\n\n그리고 블로그에 나온대로 istio-ambient 프로필을 설치한 후에는 Kind 노드에서 문제가 발생할 수 있어요. 여기 https://kind.sigs.k8s.io/docs/user/known-issues/#pod-errors-due-to-too-many-open-files 에서 문제를 해결할 수 있어요. 영향을 받는 노드의 sysctl.conf를 수정한 후에는 istio-system pods가 문제없이 생성될 거에요.\n\n\u003cimg src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_7.png\" /\u003e\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n- CNI(Container Networking Interface)\n\n\"Istio Ambient Mode\"은 Calico, Cilium 등과 같은 CNI와 함께 지원됩니다. Kind 클러스터의 기본 CNI는 \"kindnetd\"이며, 저는 직접 테스트해 본 결과 ztunnel 팟이 실행되지 않았습니다. 그래서 다른 CNI가 필요했습니다.\n\n- Cilium CNI도 Mac M1에서 제대로 로드되지 않았습니다. 즉, cilium 데몬셋 팟이 실행되지 않았습니다.\n- 마침내 Calico CNI로 Kind를 설정하는 방법을 찾았습니다. Kind에서 기본 CNI를 비활성화하고 다음과 같이 진행합니다: [https://docs.tigera.io/calico/latest/getting-started/kubernetes/kind](https://docs.tigera.io/calico/latest/getting-started/kubernetes/kind)\n- 이 설정에서 마지막 단계를 따를 수도 있습니다: [https://alexbrand.dev/post/creating-a-kind-cluster-with-calico-networking/](https://alexbrand.dev/post/creating-a-kind-cluster-with-calico-networking/)\n\n# Istio 설치\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n## 클러스터 개요\n\n이스티오를 시작하기 전에 클러스터 스펙을 살펴봅시다.\n\n다음은 Kind 클러스터 설정 스크립트입니다.\n\n마스터 노드 1개와 워커 노드 2개가 있습니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n```js\n(⎈|kind-ambient:istio-system)➜  ~ kg 노드\n이름                    상태     역할           생성 시간    버전\nambient-control-plane   준비     제어 플레인    117분     v1.30.0\nambient-worker          준비     \u003c없음\u003e         116분     v1.30.0\nambient-worker2         준비     \u003c없음\u003e         116분     v1.30.0\n```\n\n또한 Calico CNI 데몬세트가 실행 중인지 확인합니다. 클러스터 CoreDNS도 준비되어 있는지 확인합니다.\n\n```js\n(⎈|kind-ambient:kube-system)➜  ~ kgpo\n이름                                            준비     상태      재시작      생성 시간\ncalico-kube-controllers-564985c589-xmsrp        1/1     실행 중  1 (96분 전)  117분\ncalico-node-796kq                               1/1     실행 중  0             116분\ncalico-node-l6fsg                               1/1     실행 중  0             116분\ncalico-node-zkckp                               1/1     실행 중  0             116분\ncoredns-7db6d8ff4d-h88q6                        1/1     실행 중  0             118분\ncoredns-7db6d8ff4d-rtncd                        1/1     실행 중  0             118분\n```\n\n## Istio Ambient 프로필 설치\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n설치는 간단하게 진행됩니다. 여기에서 찾을 수 있어요: [https://istio.io/v1.20/docs/ops/ambient/getting-started/](https://istio.io/v1.20/docs/ops/ambient/getting-started/)\n\n```js\nsabuj $ istioctl install --set profile=ambient --set \"components.ingressGateways[0].enabled=true\" --set \"components.ingressGateways[0].name=istio-ingressgateway\" --skip-confirmation\n✔ Istio core가 설치되었습니다\n✔ Ztunnel이 설치되었습니다\n✔ Istiod가 설치되었습니다\n✔ CNI가 설치되었습니다\n✔ 인그레스 게이트웨이가 설치되었습니다\n✔ 설치가 완료되었습니다\n이 설치를 주입과 유효성 검사를 위한 기본 설정으로 지정합니다.\n```\n\n- 내가 사용 중인 Istio 버전은 다음과 같아요.\n\n```js\n(⎈|kind-ambient:kube-system)➜  ~ istioctl version\nclient version: 1.15.0\ncontrol plane version: 1.22.1\ndata plane version: 1.22.1 (4 프록시)\n```\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n- Ztunnel은 각 노드에서 실행되는 데몬세트입니다 — 이 경우 3개의 노드가 있습니다. istio-system 네임스페이스에서 ztunnel이 제대로 실행 중인지 확인해 봅시다.\n\n```js\n(⎈|kind-ambient:istio-system)➜  ~ kgpo -owide\nNAME                                    READY   STATUS    RESTARTS   AGE    IP               NODE                    NOMINATED NODE   READINESS GATES\nistio-cni-node-7q6z7                    1/1     Running   0          117m   172.18.0.2       ambient-worker2         \u003cnone\u003e           \u003cnone\u003e\nistio-cni-node-fg6n4                    1/1     Running   0          117m   172.18.0.4       ambient-worker          \u003cnone\u003e           \u003cnone\u003e\nistio-cni-node-gwvl8                    1/1     Running   0          117m   172.18.0.3       ambient-control-plane   \u003cnone\u003e           \u003cnone\u003e\nistio-ingressgateway-6f48dfb7db-862sm   1/1     Running   0          117m   192.168.184.70   ambient-worker          \u003cnone\u003e           \u003cnone\u003e\nistiod-6875bc5c58-n4j7d                 1/1     Running   0          118m   192.168.246.2    ambient-worker2         \u003cnone\u003e           \u003cnone\u003e\nztunnel-62hp8                           1/1     Running   0          117m   192.168.246.3    ambient-worker2         \u003cnone\u003e           \u003cnone\u003e\nztunnel-fv5f8                           1/1     Running   0          117m   192.168.184.71   ambient-worker          \u003cnone\u003e           \u003cnone\u003e\nztunnel-gs52c                           1/1     Running   0          117m   192.168.208.1    ambient-control-plane   \u003cnone\u003e           \u003cnone\u003e\n\n(⎈|kind-ambient:istio-system)➜  ~ kg ds\nNAME             DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE\nistio-cni-node   3         3         3       3            3           kubernetes.io/os=linux   119m\nztunnel          3         3         3       3            3           kubernetes.io/os=linux   118m\n```\n\n정말로 3개의 파드가 있네요 !\n\n- 비슷하게 Istio-cni는 또 다른 설치된 데몬세트입니다.\n- Istio 제어 평면인 istiod도 실행 중입니다.\n- 우리는 공개 트래픽을 위해 기본 istio ingressgateway도 설치했습니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n# 작업량 설정\n\n이 프로젝트의 모든 매니페스트 파일은 여기에서 찾을 수 있습니다: https://github.com/JanaSabuj/istio-ambient-mesh-exploration\n\n## 안건\n\n- 우리는 앰비언트 프로필 없이 앱을 설정하고, 일반 Istio crds를 사용할 것입니다. 그 후에 앱을 호출할 예정입니다. i) 인그레스 ii) 디버그 클라이언트 pod\n- 그 후에, Istio 데이터 평면 모드를 앰비언트로 전환하고, ztunnel pod를 통해 흐르는 트래픽 경로의 변화를 관찰할 것입니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n## 네임스페이스\n\nambient-demo라는 네임스페이스를 만들어 보겠습니다. 이 네임스페이스에서 앱을 호스팅할 예정입니다.\n\n```js\n(⎈|kind-ambient:istio-system)➜  ~ k create ns ambient-demo\n\n(⎈|kind-ambient:istio-system)➜  ~ kg ns\nNAME                 STATUS   AGE\ndefault              Active   132m\nistio-system         Active   125m\nkube-node-lease      Active   132m\nkube-public          Active   132m\nkube-system          Active   132m\nlocal-path-storage   Active   132m\n```\n\n## 애플리케이션\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n그럼 배포, 서비스 및 서비스 어카운트 yaml을 사용하여 애플리케이션을 배포합니다.\n\n클러스터에서는 다음과 같이 보입니다.\n\n```bash\n(⎈|kind-ambient:ambient-demo)➜  ~ kg all\nNAME                          READY   STATUS    RESTARTS   AGE\npod/httpbin-6f4dc97cb-5dpz9   1/1     Running   0          3m21s\npod/httpbin-6f4dc97cb-swdlb   1/1     Running   0          3m31s\n\nNAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE\nservice/httpbin   ClusterIP   10.96.157.221   \u003cnone\u003e        80/TCP    143m\n\nNAME                      READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/httpbin   2/2     2            2           143m\n\nNAME                                 DESIRED   CURRENT   READY   AGE\nreplicaset.apps/httpbin-6f4dc97cb    2         2         2       3m31s\n```\n\n## Istio 구성\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n외부 세계에 노출하기 위해 Istio Gateway 및 Istio VirtualService를 생성하여 Istio Ingress를 통해 액세스할 수 있게 만듭니다.\n\n- 우리는 Istio Ingress 파드에 8081 포트를 통해 게이트웨이를 추가하고 있습니다.\n- 그 다음으로, VirtualService를 통해 ambient-demo 네임스페이스에서 실행되는 httpbin 서비스로 라우팅합니다.\n\n## Istio Ingress를 통한 확인\n\n이제 우리의 응용 프로그램에 액세스할 수 있는지 확인할 수 있습니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n```js\n(⎈|kind-ambient:istio-system)➜  ~ kgs\nNAME                   TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)                                      AGE\nistio-ingressgateway   LoadBalancer   10.96.77.172   \u003cpending\u003e     15021:30807/TCP,80:30587/TCP,443:31004/TCP   147m\n```\n\nKind가 인그레스 서비스를 위한 외부 IP를 제공하지 않았기 때문에, 원하는 리스너 8081에서 인그레스 파드를 포트포워딩하여 외부 액세스를 시뮬레이션할 것입니다.\n\n```js\n(⎈|kind-ambient:istio-system)➜  ~ kpf istio-ingressgateway-6f48dfb7db-862sm 8081\nForwarding from 127.0.0.1:8081 -\u003e 8081\nForwarding from [::1]:8081 -\u003e 8081\n```\n\n브라우저에서 127.0.0.1:8081을 입력하여 애플리케이션을 확인할 수 있습니다!\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n```js\nhttp://127.0.0.1:8081/\n\nhttpbin.org\n 0.9.2\n[ Base URL: 127.0.0.1:8081/ ]\n간단한 HTTP 요청 및 응답 서비스입니다.\n\n로컬에서 실행: $ docker run -p 80:80 kennethreitz/httpbin\n\n개발자 - 웹사이트\n개발자에게 이메일 보내기\n```\n\n- 또 다른 확인 방법은 로컬에서 curl을 통해 하는 것입니다. 우리는 요청이 istio-envoy 파드에 의해 처리된 것을 확인합니다.\n\n```js\n(⎈|kind-ambient:istio-system)➜  ~ curl 127.0.0.1:8081 -v\n*   Trying 127.0.0.1:8081...\n* Connected to 127.0.0.1 (127.0.0.1) port 8081\n\u003e GET / HTTP/1.1\n\u003e Host: 127.0.0.1:8081\n\u003e User-Agent: curl/8.6.0\n\u003e Accept: */*\n\u003e\n\u003c HTTP/1.1 200 OK\n\u003c server: istio-envoy\n\u003c date: Sun, 16 Jun 2024 11:52:13 GMT\n\u003c content-type: text/html; charset=utf-8\n\u003c content-length: 9593\n\u003c access-control-allow-origin: *\n\u003c access-control-allow-credentials: true\n\u003c x-envoy-upstream-service-time: 271\n\u003c\n\u003c!DOCTYPE html\u003e\n\u003chtml lang=\"en\"\u003e\n...\n```\n\n## 디버그 클라이언트 파드를 통한 확인\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n우리는 메쉬 내부 호출을 테스트해보려고 합니다. 따라서 각 노드마다 클라이언트 팟이 하나씩 있는 것이 좋습니다. 이를 위해 디버거 데몬세트 클라이언트 워크로드를 설정할 수 있습니다 — https://github.com/digitalocean/doks-debug\n\n사용한 수정된 Manifest: https://gist.github.com/JanaSabuj/a4dd2504752b8c2b30d2d2d05320f7ef\n\n저는 이 데몬세트를 우리 ambient-demo 네임스페이스에 배포했습니다.\n\n```js\n(⎈|kind-ambient:ambient-demo)➜  ~ kg ds\nNAME         DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE\ndoks-debug   3         3         3       3            3           \u003cnone\u003e          89m\n\n(⎈|kind-ambient:ambient-demo)➜  ~ kgpo -owide\nNAME                      READY   STATUS    RESTARTS   AGE   IP               NODE                    NOMINATED NODE   READINESS GATES\ndoks-debug-j9mm5          1/1     Running   0          90m   192.168.246.5    ambient-worker2         \u003cnone\u003e           \u003cnone\u003e\ndoks-debug-rdhgq          1/1     Running   0          90m   192.168.184.73   ambient-worker          \u003cnone\u003e           \u003cnone\u003e\ndoks-debug-v7cld          1/1     Running   0          90m   192.168.208.3    ambient-control-plane   \u003cnone\u003e\n```\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n테스트해 보기 위해 디버그 팟으로 진입하여 k8s fqdn httpbin.ambient-demo.svc.cluster.local을 curl을 시도해 보았습니다.\n\n200 OK를 반환하고 있습니다.\n\n```js\n(⎈|kind-ambient:ambient-demo)➜  ~ k exec -it doks-debug-j9mm5 -- /bin/bash\n\nroot@doks-debug-j9mm5:~# curl httpbin.ambient-demo.svc.cluster.local -v\n*   Trying 10.96.157.221:80...\n* Connected to httpbin.ambient-demo.svc.cluster.local (10.96.157.221) port 80 (#0)\n\u003e GET / HTTP/1.1\n\u003e Host: httpbin.ambient-demo.svc.cluster.local\n\u003e User-Agent: curl/7.88.1\n\u003e Accept: */*\n\u003e\n\u003c HTTP/1.1 200 OK\n\u003c Server: gunicorn/19.9.0\n\u003c Date: Sun, 16 Jun 2024 12:06:11 GMT\n\u003c Connection: keep-alive\n\u003c Content-Type: text/html; charset=utf-8\n\u003c Content-Length: 9593\n\u003c Access-Control-Allow-Origin: *\n\u003c Access-Control-Allow-Credentials: true\n\u003c\n```\n\n# Ambient Injection\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n지금까지 앰비언트 모드가 활성화되지 않았습니다. Istio 게이트웨이에서 추가 된 리스너로 인해 요청은 Istio 인그레스 파드에 도착한 다음 VirtualService를 통해 앱 파드로 라우팅됩니다.\n\n매쉬 내부 호출의 경우, 클라이언트와 서버 파드 사이에 직접적인 포드 간 통신이 이루어집니다.\n\n![이미지](/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_8.png)\n\n앰비언트를 주입하는 동안 우리는 또한 다음 로그를 계속 추적할 것입니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n- istio-cni\n- ztunnel\n\nIstio가 네임스페이스 ambient-demo에 대한 Ambient Dataplane 모드를 활성화하도록 내부적으로 라우트, iptables 등을 설정했는지 확인하려면 아래 명령어를 사용해보세요.\n\n```js\n(⎈|kind-ambient:ambient-demo)➜\n~ kubectl label namespace ambient-demo istio.io/dataplane-mode=ambient\n```\n\n## 관찰된 로그\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n- istio-cni\n\n```js\n(⎈|kind-ambient:ambient-demo)➜ ~ stern istio-cni -n istio-system\n\nistio-cni-node-7q6z7 install-cni 2024-06-16T10:13:59.243451Z info ambient Namespace ambient-demo is enabled in ambient mesh\nistio-cni-node-7q6z7 install-cni 2024-06-16T10:13:59.264500Z info ambient in pod mode - adding pod ambient-demo/httpbin-5bd875fbdd-84vs8 to ztunnel\nistio-cni-node-gwvl8 install-cni 2024-06-16T10:13:59.291505Z info ambient Namespace ambient-demo is enabled in ambient mesh\nistio-cni-node-fg6n4 install-cni 2024-06-16T10:13:59.281587Z info ambient Namespace ambient-demo is enabled in ambient mesh\nistio-cni-node-fg6n4 install-cni 2024-06-16T10:13:59.313668Z info ambient in pod mode - adding pod ambient-demo/httpbin-5bd875fbdd-dp4ct to ztunnel\n\nistio-cni-node-7q6z7 install-cni 2024-06-16T10:13:59.264500Z info ambient in pod mode - adding pod ambient-demo/httpbin-5bd875fbdd-84vs8 to ztunnel\nistio-cni-node-7q6z7 install-cni 2024-06-16T10:13:59.325907Z info iptables Running iptables-restore with the following input:\nistio-cni-node-7q6z7 install-cni * nat\nistio-cni-node-7q6z7 install-cni -N ISTIO_OUTPUT\nistio-cni-node-7q6z7 install-cni -A OUTPUT -j ISTIO_OUTPUT\nistio-cni-node-7q6z7 install-cni -A ISTIO_OUTPUT -d 169.254.7.127 -p tcp -m tcp -j ACCEPT\nistio-cni-node-7q6z7 install-cni -A ISTIO_OUTPUT -p tcp -m mark --mark 0x111/0xfff -j ACCEPT\nistio-cni-node-7q6z7 install-cni -A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -j ACCEPT\nistio-cni-node-7q6z7 install-cni -A ISTIO_OUTPUT ! -d 127.0.0.1/32 -p tcp -m mark ! --mark 0x539/0xfff -j REDIRECT --to-ports 15001\nistio-cni-node-7q6z7 install-cni COMMIT\nistio-cni-node-7q6z7 install-cni * mangle\nistio-cni-node-7q6z7 install-cni -N ISTIO_PRERT\nistio-cni-node-7q6z7 install-cni -N ISTIO_OUTPUT\nistio-cni-node-7q6z7 install-cni -A PREROUTING -j ISTIO_PRERT\nistio-cni-node-7q6z7 install-cni -A OUTPUT -j ISTIO_OUTPUT\nistio-cni-node-7q6z7 install-cni -A ISTIO_PRERT -m mark --mark 0x539/0xfff -j CONNMARK --set-xmark 0x111/0xfff\nistio-cni-node-7q6z7 install-cni -A ISTIO_PRERT -s 169.254.7.127 -p tcp -m tcp -j ACCEPT\nistio-cni-node-7q6z7 install-cni -A ISTIO_PRERT ! -d 127.0.0.1/32 -p tcp -i lo -j ACCEPT\nistio-cni-node-7q6z7 install-cni -A ISTIO_PRERT -p tcp -m tcp --dport 15008 -m mark ! --mark 0x539/0xfff -j TPROXY --on-port 15008 --tproxy-mark 0x111/0xfff\nistio-cni-node-7q6z7 install-cni -A ISTIO_PRERT -p tcp -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT\nistio-cni-node-7q6z7 install-cni -A ISTIO_PRERT ! -d 127.0.0.1/32 -p tcp -m mark ! --mark 0x539/0xfff -j TPROXY --on-port 15006 --tproxy-mark 0x111/0xfff\nistio-cni-node-7q6z7 install-cni -A ISTIO_OUTPUT -m connmark --mark 0x111/0xfff -j CONNMARK --restore-mark --nfmask 0xffffffff --ctmask 0xffffffff\nistio-cni-node-7q6z7 install-cni COMMIT\nistio-cni-node-7q6z7 install-cni 2024-06-16T10:13:59.335115Z info Running command (with wait lock): iptables-restore --noflush -v --wait=30\nistio-cni-node-7q6z7 install-cni 2024-06-16T10:13:59.550687Z info ambient About to send added pod: 3ab72f78-8e2b-4e49-bc47-45fa4f90dbf7 to ztunnel: add:{uid:\"3ab72f78-8e2b-4e49-bc47-45fa4f90dbf7\" workload_info:{name:\"httpbin-5bd875fbdd-84vs8\" namespace:\"ambient-demo\" service_account:\"default\" trust_domain:\"cluster.local\"}\n```\n\n많은 로그가 생성되었습니다. 우리는 각 httpbin pod를 ambient-demo 네임스페이스에 추가하여 ztunnel을 통해 ambient 경로에 추가하고 있음을 확인할 수 있습니다.\n\n- ztunnel\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n```plaintext\n(⎈|kind-ambient:ambient-demo)➜ ~ stern ztunnel -n istio-system\n\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.559505Z 정보 inpod::statemanager pod WorkloadUid(\"3ab72f78-8e2b-4e49-bc47-45fa4f90dbf7\")가 netns를 수신하고 프록시를 시작합니다.\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.557545Z 정보 inpod::statemanager pod WorkloadUid(\"7f8be6a6-64f2-40e9-8926-6c3a618eb7d9\")가 netns를 수신하고 프록시를 시작합니다.\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.560458Z 정보 proxy::inbound 리스너가 구성되었으며 주소=[::]:15008 구성요소=\"inbound\" 투명=true\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.561604Z 정보 proxy::inbound_passthrough 리스너가 구성되었으며 주소=[::]:15006 구성요소=\"inbound plaintext\" 투명=true\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.561647Z 정보 proxy::outbound 리스너가 구성되었으며 주소=[::]:15001 구성요소=\"outbound\" 투명=true\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.573883Z 정보 proxy::inbound 리스너가 구성되었으며 주소=[::]:15008 구성요소=\"inbound\" 투명=true\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.586596Z 정보 proxy::inbound_passthrough 리스너가 구성되었으며 주소=[::]:15006 구성요소=\"inbound plaintext\" 투명=true\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.586819Z 정보 proxy::outbound 리스너가 구성되었으며 주소=[::]:15001 구성요소=\"outbound\" 투명=true\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.811460Z 정보 xds::client:xds{id=14}가 응답을 수신했습니다. type_url=\"type.googleapis.com/istio.workload.Address\" 크기=2  삭제=0\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.816352Z 정보 xds::client:xds{id=14}가 응답을 수신했습니다. type_url=\"type.googleapis.com/istio.workload.Address\" 크기=2  삭제=0\nztunnel-gs52c istio-proxy 2024-06-16T10:13:59.821310Z 정보 xds::client:xds{id=14}가 응답을 수신했습니다. type_url=\"type.googleapis.com/istio.workload.Address\" 크기=2  삭제=0\n```\n\nztunnel이 자체 내부 및 외부 리스너를 설정 중인 것으로 보입니다.\n\n## 트래픽 흐름 - Istio Ingress를 통해\n\n이전과 마찬가지로, istio-ingress pod로 포트 포워딩을 설정하고 localhost를 통해 액세스합니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n두 개의 호출을 각각 2개의 httpbin 팟에 대응하도록 인그레스에서 호출을 추출하려고 합니다. 그리고 동시에 동일한 ztunnel 로그를 캡처하려고 합니다.\n\n```js\n(⎈|kind-ambient:istio-system)➜  ~ kpf istio-ingressgateway-6f48dfb7db-862sm 8081\nForwarding from 127.0.0.1:8081 -\u003e 8081\n\n$ curl localhost:8081/\n$ curl localhost:8081/\n```\n\n```js\n(⎈|kind-ambient:istio-system)➜  ~ stern ztunnel -n istio-system\n\nztunnel-fv5f8 istio-proxy 2024-06-16T12:26:24.154500Z\ninfo access connection complete src.addr=192.168.184.70:52792\nsrc.workload=istio-ingressgateway-6f48dfb7db-862sm src.namespace=istio-system\nsrc.identity=\"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account\"\ndst.addr=192.168.184.74:80 dst.hbone_addr=192.168.184.74:80\ndst.service=httpbin.ambient-demo.svc.cluster.local\ndst.workload=httpbin-6f4dc97cb-swdlb dst.namespace=ambient-demo\ndst.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\"\ndirection=\"inbound\" bytes_sent=51083 bytes_recv=4180 duration=\"2166ms\"\n\nztunnel-62hp8 istio-proxy 2024-06-16T12:28:40.267690Z\ninfo access connection complete src.addr=192.168.184.70:55036\nsrc.workload=istio-ingressgateway-6f48dfb7db-862sm src.namespace=istio-system\nsrc.identity=\"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account\"\ndst.addr=192.168.246.6:80 dst.hbone_addr=192.168.246.6:80\ndst.service=httpbin.ambient-demo.svc.cluster.local\ndst.workload=httpbin-6f4dc97cb-5dpz9 dst.namespace=ambient-demo\ndst.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\"\ndirection=\"inbound\" bytes_sent=41251 bytes_recv=2007 duration=\"2331ms\"\n```\n\n인그레스가 주변 데이터 플레인 경로에 떨어지지 않기 때문에 인그레스 팟에서의 호출은 주변 데이터 플레인 경로로 직접 ztunnel 팟으로 이어집니다. 한 번에 하나의 노드로 이동한 후 해당 내부 노드 팟으로 inbound됩니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n아래는 로그 캡처에서 확인한 내용입니다\n\n```js\ndirection = \"inbound\";\n```\n\n- 이는 주변 레이블이 붙은 네임스페이스 파드로의 트래픽이 항상 ztunnel을 통해 이동함을 확인합니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\ndst.hbone_addr=192.168.184.74:80\ndst.hbone_addr=192.168.246.6:80\n\nhttpbin-6f4dc97cb-5dpz9 1/1 Running 0 56m 192.168.246.6 ambient-worker2 \u003cnone\u003e \u003cnone\u003e\nhttpbin-6f4dc97cb-swdlb 1/1 Running 0 56m 192.168.184.74 ambient-worker \u003cnone\u003e \u003cnone\u003e\n\n- 이것은 실제 httpbin pod ip에 해당하는 dest pod ip를 캡처합니다.\n\n## 트래픽 흐름 — Mesh 내부를 통해\n\n클라이언트 디버그 pod에 exec하여 httpbin 서비스로의 Mesh 내부 호출을 시도하고 동시에 ztunnel 로그를 캡쳐하여 동일한 동작을 확인해보겠습니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n```js\n(⎈|kind-ambient:ambient-demo)➜  ~ kgpo -owide\nNAME                      READY   STATUS    RESTARTS   AGE    IP               NODE                    NOMINATED NODE   READINESS GATES\ndoks-debug-j9mm5          1/1     Running   0          122m   192.168.246.5    ambient-worker2         \u003cnone\u003e           \u003cnone\u003e\ndoks-debug-rdhgq          1/1     Running   0          122m   192.168.184.73   ambient-worker          \u003cnone\u003e           \u003cnone\u003e\ndoks-debug-v7cld          1/1     Running   0          122m   192.168.208.3    ambient-control-plane   \u003cnone\u003e           \u003cnone\u003e\nhttpbin-6f4dc97cb-5dpz9   1/1     Running   0          56m    192.168.246.6    ambient-worker2         \u003cnone\u003e           \u003cnone\u003e\nhttpbin-6f4dc97cb-swdlb   1/1     Running   0          56m    192.168.184.74   ambient-worker          \u003cnone\u003e           \u003cnone\u003e\n```\n\n그냥 같은 노드에 있는 클라이언트와 앱 팟들을 연결하기 위해 —\n\n```js\n(⎈|kind-ambient:ambient-demo)➜  ~ kgpo -A -owide | grep \"ambient-worker \"\nambient-demo         doks-debug-rdhgq                                1/1     Running   0               133m    192.168.184.73   ambient-worker          \u003cnone\u003e           \u003cnone\u003e\nistio-system         ztunnel-fv5f8                                   1/1     Running   0               3h24m   192.168.184.71   ambient-worker          \u003cnone\u003e           \u003cnone\u003e\nambient-demo         httpbin-6f4dc97cb-swdlb                         1/1     Running   0               68m     192.168.184.74   ambient-worker          \u003cnone\u003e           \u003cnone\u003e\n\n\n(⎈|kind-ambient:ambient-demo)➜  ~ kgpo -A -owide | grep \"ambient-worker2\"\nkube-system          doks-debug-9nlh7                                1/1     Running   0               3h6m    192.168.246.4    ambient-worker2         \u003cnone\u003e           \u003cnone\u003e\nistio-system         ztunnel-62hp8                                   1/1     Running   0               3h23m   192.168.246.3    ambient-worker2         \u003cnone\u003e           \u003cnone\u003e\nambient-demo         httpbin-6f4dc97cb-5dpz9                         1/1     Running   0               67m     192.168.246.6    ambient-worker2         \u003cnone\u003e           \u003cnone\u003e\n```\n\ndebug pod인 doks-debug-rdhgq를 실행하기 위해 ambient-worker 노드에 스케줄된 상태로 들어가보겠습니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n\u003cimg src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_10.png\" /\u003e\n\n```js\n테이블 1: 동일 노드 내의 클라이언트 및 서버\n---------\nztunnel-fv5f8 istio-proxy 2024-06-16T12:40:48.707707Z info access connection complete src.addr=192.168.184.73:56463 src.workload=doks-debug-rdhgq src.namespace=ambient-demo src.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/default\" dst.addr=192.168.184.74:80 dst.hbone_addr=192.168.184.74:80 dst.service=httpbin.ambient-demo.svc.cluster.local dst.workload=httpbin-6f4dc97cb-swdlb dst.namespace=ambient-demo dst.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\" direction  =\"inbound\" bytes_sent=9832 bytes_recv=84 duration=\"178ms\"\nztunnel-fv5f8 istio-proxy 2024-06-16T12:40:48.708070Z info access connection complete src.addr=192.168.184.73:34190 src.workload=doks-debug-rdhgq src.namespace=ambient-demo src.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/default\" dst.addr=192.168.184.74:15008 dst.hbone_addr=192.168.184.74:80 dst.service=httpbin.ambient-demo.svc.cluster.local dst.workload=httpbin-6f4dc97cb-swdlb dst.namespace=ambient-demo dst.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\" direction=\"outbound\" bytes_sent=84 bytes_recv=9832 duration=\"203ms\"\n```\n\n동일 노드 내의 클라이언트와 서버의 경우, 파드에서 ztunnel로 외부 패킷이 들어오면 동일한 ztunnel을 통해 대상 파드로 들어오는 내부 패킷으로 리디렉션됩니다.\n\n따라서, 동일 노드 내의 클라이언트 및 서버에서는 한 ztunnel이 외부 패킷과 내부 패킷을 받습니다. \"bound\"는 동일 노드 내의 응용 프로그램 파드로부터/받는 방향을 지정합니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n```js\n캡처 2: 클라이언트 및 서버가 다른 노드에 있는 경우\n---------\nztunnel-62hp8 istio-proxy 2024-06-16T12:48:51.792527Z info access connection complete src.addr=192.168.184.73:53265 src.workload=doks-debug-rdhgq src.namespace=ambient-demo src.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/default\" dst.addr=192.168.246.6:80 dst.hbone_addr=192.168.246.6:80 dst.service=httpbin.ambient-demo.svc.cluster.local dst.workload=httpbin-6f4dc97cb-5dpz9 dst.namespace=ambient-demo dst.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\" direction=\"inbound\" bytes_sent=9832 bytes_recv=84 duration=\"60ms\"\nztunnel-fv5f8 istio-proxy 2024-06-16T12:48:51.793112Z info access connection complete src.addr=192.168.184.73:60162 src.workload=doks-debug-rdhgq src.namespace=ambient-demo src.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/default\" dst.addr=192.168.246.6:15008 dst.hbone_addr=192.168.246.6:80 dst.service=httpbin.ambient-demo.svc.cluster.local dst.workload=httpbin-6f4dc97cb-5dpz9 dst.namespace=ambient-demo dst.identity=\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\" direction=\"outbound\" bytes_sent=84 bytes_recv=9832 duration=\"61ms\"\n```\n\n만약 클라이언트와 서버가 다른 노드에 있는 경우, 출발 트래픽은 동일한 노드인 ztunnel에서 외부 트래픽 패킷을 만나고, 그런 다음 목적지 파드의 노드의 ztunnel로 전송되어 들어오는 패킷으로 처리됩니다.\n\n# 결론\n\n이 실험을 통해 Istio Ambient Mesh에서 ztunnel을 통한 패킷 흐름을 시각화할 수 있었습니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n![이미지](/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_11.png)\n\n다음 파트에서는 ztunnel을 통해 적용할 수 있는 L4 인증 정책을 탐색할 것입니다.\n\n또한 Ambient에 있는 L7 프록시인 Waypoint Proxy에 대해 탐구할 것입니다.\n\n다른 기술 블로그는 여기에서 확인할 수 있습니다: [링크](https://janasabuj.github.io/posts/)\n","ogImage":{"url":"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_0.png"},"coverImage":"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_0.png","tag":["Tech"],"readingTime":35},"content":"\u003c!doctype html\u003e\n\u003chtml lang=\"en\"\u003e\n\u003chead\u003e\n\u003cmeta charset=\"utf-8\"\u003e\n\u003cmeta content=\"width=device-width, initial-scale=1\" name=\"viewport\"\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n\u003cp\u003e피츠오는 앰비언트 모드로 전환하고 있어요 — 사이드카 없는 모델로 말이죠. 마침내 우리는 CPU와 메모리 소비가 많은 사이드카를 버릴 수 있게 되었어요!\u003c/p\u003e\n\u003cp\u003e다가오는 장마시즌을 맞아, 저는 피츠오 앰비언트 메시에 간접적으로 참여해보기로 했어요.\u003c/p\u003e\n\u003cp\u003e이 블로그를 사용하여 여행을 문서화하고, 비슷한 생각을 가진 피츠오 사용자들이 함께 따라올 수 있게 도와볼 거예요 :P.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_0.png\" alt=\"이미지\"\u003e\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e제가 나름대로 번역해보겠습니다:\u003c/p\u003e\n\u003cp\u003e안녕하세요! Part 1에서는 주변 메시 실험을 위해 로컬 클러스터 설정을 완벽하게 진행할 예정입니다. 그런 다음 메시의 ztunnel 구성 요소를 탐험할 것입니다.\u003c/p\u003e\n\u003cp\u003ePart 2에서는 L4 인증 정책에 대해 이야기하고 waypoint 프록시를 시작하는 방법을 살펴볼 것입니다.\u003c/p\u003e\n\u003ch1\u003eAmbient란 무엇인가요?\u003c/h1\u003e\n\u003cp\u003eIstio Ambient Mesh는 사이드카 없이 Istio의 새로운 데이터플레인 모드입니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e일반적인 Istio 모드에서는 모든 응용 프로그램 Pod이 envoy 프록시로 주입되었다는 것을 기억하십시오. 그러나 이 새로운 모드에서는 응용 프로그램 Pod이 건드리지 않을 거에요 :) 그리고 그들은 자신의 응용 프로그램 컨테이너만 가지게 될 거에요.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_1.png\" alt=\"이미지\"\u003e\u003c/p\u003e\n\u003cp\u003e가장 먼저 떠오르는 큰 장점 중 하나는 인프라 비용이 크게 절감된다는 것입니다. 컴퓨팅 코어 및 메모리 관점에서 얼마나 많은 돈을 절약하고 있는지 상상해보세요 !!\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_2.png\" alt=\"이미지\"\u003e\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch1\u003eAmbient Architecture\u003c/h1\u003e\n\u003cp\u003e과거와 현재의 Ambient Architecture를 상상해 보는 시간입니다. 데이터 평면의 트래픽 흐름 경로에서 그들이 어떻게 다른지 살펴봅시다.\u003c/p\u003e\n\u003ch2\u003eSidecar 모드\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_3.png\" alt=\"이미지\"\u003e\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e이것은 전통적인 사이드카 모델이며 각 서비스 팟에는 애플리케이션 컨테이너와 Envoy 사이드카가 결합되어 있습니다. 애플리케이션으로부터 오고 가는 모든 트래픽은 사이드카에 의해 가로채집니다.\u003c/p\u003e\n\u003ch2\u003eAmbient 모드, ztunnel 사용\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_4.png\" alt=\"이미지\"\u003e\u003c/p\u003e\n\u003cp\u003e이 새로운 ambient 모드에서 애플리케이션 팟은 사이드카가 없는 독립적인 팟입니다. 그러나 이 경우에는 클러스터의 각 Kubernetes 노드마다 데몬셋 팟이 실행될 것입니다 - 강력한 ztunnel (제로 트러스트 터널). 노드 내 팟간의 모든 트래픽은 ztunnel에 의해 가로채집됩니다. Ztunnel은 각 노드당 L4 프록시입니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch2\u003eAmbient mode, with ztunnel + waypoint\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_5.png\" alt=\"Image\"\u003e\u003c/p\u003e\n\u003cp\u003eZtunnel은 L4 프록시가 필요한 워크로드 간 네트워킹에 충분합니다. http 헤더 기반 라우팅, L7 권한 부여와 같은 L7 요구 사항을 충족시키기 위해 waypoint 프록시라는 워크로드를 배포합니다. 이는 애플리케이션당 envoy 팟으로, 동일한 노드 또는 다른 노드에서 실행될 수 있습니다.\u003c/p\u003e\n\u003cp\u003e이 경우 ztunnel에서 생성된 트래픽은 waypoint 프록시에 도달하고, waypoint는 그것을 목적지 ztunnel로 전달합니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e그러므로, 어플리케이션이 L7 처리를 요구하지 않는 경우 waypoint를 없애고 ztunnel만 사용할 수 있습니다. 이전 방식에서는, 우리가 L4 요구사항만 가지고 있더라도 envoy sidecars를 반드시 사용해야 했습니다.\u003c/p\u003e\n\u003ch1\u003e클러스터 설정 깊이에 대한 정보\u003c/h1\u003e\n\u003cp\u003e이상적으로 지원되는 환경에서 사용할 수 있는 유효한 CNI 설정으로 Kind 클러스터를 설정하는 데 많은 조정이 필요했습니다. 현재는 어떤 공개 GKE/AKS/EKS k8s 클러스터에 대한 실험을 할 수 있는 권한이 없습니다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_6.png\" alt=\"이미지\"\u003e\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e그러므로 로컬 Kind 클러스터를 홈 설정하겠습니다.\u003c/p\u003e\n\u003ch2\u003e시스템 사양\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eMac M1 (Apple-Silicon 아키텍처)를 사용하며 기본 구성으로 진행됩니다.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e시스템 아키텍처(Linux/Windows/Apple Intel)를 고려하여 비슷하게 진행할 수 있습니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cul\u003e\n\u003cli\u003eRancher Desktop\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e저희 k8s 클러스터를 위해 도커 런타임이 필요한데, 저는 SUSE의 Rancher Desktop을 사용할 예정입니다 — \u003ca href=\"https://rancherdesktop.io/\" rel=\"nofollow\" target=\"_blank\"\u003ehttps://rancherdesktop.io/\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003e다른 대안으로는 Docker Desktop이 있습니다 — \u003ca href=\"https://www.docker.com/products/docker-desktop/\" rel=\"nofollow\" target=\"_blank\"\u003ehttps://www.docker.com/products/docker-desktop/\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eKind\u003c/li\u003e\n\u003c/ul\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e저는 Multi-Node K8s 클러스터가 필요하다고 생각해요. 그래서 우리가 사용할 최상의 도구는 Kind를 이용해 클러스터를 부트스트랩하는 거죠. 여기 \u003ca href=\"https://kind.sigs.k8s.io/docs/user/quick-start\" rel=\"nofollow\" target=\"_blank\"\u003ehttps://kind.sigs.k8s.io/docs/user/quick-start\u003c/a\u003e 에서 보다 자세한 정보를 얻을 수 있어요.\u003c/p\u003e\n\u003cp\u003e이를 통해 우리는 k8s 노드에 ssh로 접속하고 노드 구성을 실험해볼 수도 있을 거에요.\u003c/p\u003e\n\u003cp\u003e그리고 블로그에 나온대로 istio-ambient 프로필을 설치한 후에는 Kind 노드에서 문제가 발생할 수 있어요. 여기 \u003ca href=\"https://kind.sigs.k8s.io/docs/user/known-issues/#pod-errors-due-to-too-many-open-files\" rel=\"nofollow\" target=\"_blank\"\u003ehttps://kind.sigs.k8s.io/docs/user/known-issues/#pod-errors-due-to-too-many-open-files\u003c/a\u003e 에서 문제를 해결할 수 있어요. 영향을 받는 노드의 sysctl.conf를 수정한 후에는 istio-system pods가 문제없이 생성될 거에요.\u003c/p\u003e\n\u003cimg src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_7.png\"\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cul\u003e\n\u003cli\u003eCNI(Container Networking Interface)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\"Istio Ambient Mode\"은 Calico, Cilium 등과 같은 CNI와 함께 지원됩니다. Kind 클러스터의 기본 CNI는 \"kindnetd\"이며, 저는 직접 테스트해 본 결과 ztunnel 팟이 실행되지 않았습니다. 그래서 다른 CNI가 필요했습니다.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCilium CNI도 Mac M1에서 제대로 로드되지 않았습니다. 즉, cilium 데몬셋 팟이 실행되지 않았습니다.\u003c/li\u003e\n\u003cli\u003e마침내 Calico CNI로 Kind를 설정하는 방법을 찾았습니다. Kind에서 기본 CNI를 비활성화하고 다음과 같이 진행합니다: \u003ca href=\"https://docs.tigera.io/calico/latest/getting-started/kubernetes/kind\" rel=\"nofollow\" target=\"_blank\"\u003ehttps://docs.tigera.io/calico/latest/getting-started/kubernetes/kind\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e이 설정에서 마지막 단계를 따를 수도 있습니다: \u003ca href=\"https://alexbrand.dev/post/creating-a-kind-cluster-with-calico-networking/\" rel=\"nofollow\" target=\"_blank\"\u003ehttps://alexbrand.dev/post/creating-a-kind-cluster-with-calico-networking/\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eIstio 설치\u003c/h1\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch2\u003e클러스터 개요\u003c/h2\u003e\n\u003cp\u003e이스티오를 시작하기 전에 클러스터 스펙을 살펴봅시다.\u003c/p\u003e\n\u003cp\u003e다음은 Kind 클러스터 설정 스크립트입니다.\u003c/p\u003e\n\u003cp\u003e마스터 노드 1개와 워커 노드 2개가 있습니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:istio-system)➜  ~ kg 노드\n이름                    상태     역할           생성 시간    버전\nambient-control-plane   준비     제어 플레인    \u003cspan class=\"hljs-number\"\u003e117\u003c/span\u003e분     v1\u003cspan class=\"hljs-number\"\u003e.30\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\nambient-worker          준비     \u0026#x3C;없음\u003e         \u003cspan class=\"hljs-number\"\u003e116\u003c/span\u003e분     v1\u003cspan class=\"hljs-number\"\u003e.30\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\nambient-worker2         준비     \u0026#x3C;없음\u003e         \u003cspan class=\"hljs-number\"\u003e116\u003c/span\u003e분     v1\u003cspan class=\"hljs-number\"\u003e.30\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e또한 Calico CNI 데몬세트가 실행 중인지 확인합니다. 클러스터 CoreDNS도 준비되어 있는지 확인합니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:kube-system)➜  ~ kgpo\n이름                                            준비     상태      재시작      생성 시간\ncalico-kube-controllers-564985c589-xmsrp        \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     실행 중  \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e (\u003cspan class=\"hljs-number\"\u003e96\u003c/span\u003e분 전)  \u003cspan class=\"hljs-number\"\u003e117\u003c/span\u003e분\ncalico-node-796kq                               \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     실행 중  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e             \u003cspan class=\"hljs-number\"\u003e116\u003c/span\u003e분\ncalico-node-l6fsg                               \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     실행 중  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e             \u003cspan class=\"hljs-number\"\u003e116\u003c/span\u003e분\ncalico-node-zkckp                               \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     실행 중  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e             \u003cspan class=\"hljs-number\"\u003e116\u003c/span\u003e분\ncoredns-7db6d8ff4d-h88q6                        \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     실행 중  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e             \u003cspan class=\"hljs-number\"\u003e118\u003c/span\u003e분\ncoredns-7db6d8ff4d-rtncd                        \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     실행 중  \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e             \u003cspan class=\"hljs-number\"\u003e118\u003c/span\u003e분\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eIstio Ambient 프로필 설치\u003c/h2\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e설치는 간단하게 진행됩니다. 여기에서 찾을 수 있어요: \u003ca href=\"https://istio.io/v1.20/docs/ops/ambient/getting-started/\" rel=\"nofollow\" target=\"_blank\"\u003ehttps://istio.io/v1.20/docs/ops/ambient/getting-started/\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003esabuj $ istioctl install --set profile=ambient --set \u003cspan class=\"hljs-string\"\u003e\"components.ingressGateways[0].enabled=true\"\u003c/span\u003e --set \u003cspan class=\"hljs-string\"\u003e\"components.ingressGateways[0].name=istio-ingressgateway\"\u003c/span\u003e --skip-confirmation\n✔ \u003cspan class=\"hljs-title class_\"\u003eIstio\u003c/span\u003e core가 설치되었습니다\n✔ \u003cspan class=\"hljs-title class_\"\u003eZtunnel\u003c/span\u003e이 설치되었습니다\n✔ \u003cspan class=\"hljs-title class_\"\u003eIstiod\u003c/span\u003e가 설치되었습니다\n✔ \u003cspan class=\"hljs-variable constant_\"\u003eCNI\u003c/span\u003e가 설치되었습니다\n✔ 인그레스 게이트웨이가 설치되었습니다\n✔ 설치가 완료되었습니다\n이 설치를 주입과 유효성 검사를 위한 기본 설정으로 지정합니다.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e내가 사용 중인 Istio 버전은 다음과 같아요.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:kube-system)➜  ~ istioctl version\nclient \u003cspan class=\"hljs-attr\"\u003eversion\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e1.15\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\ncontrol plane \u003cspan class=\"hljs-attr\"\u003eversion\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e1.22\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e\ndata plane \u003cspan class=\"hljs-attr\"\u003eversion\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e1.22\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e (\u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e 프록시)\n\u003c/code\u003e\u003c/pre\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cul\u003e\n\u003cli\u003eZtunnel은 각 노드에서 실행되는 데몬세트입니다 — 이 경우 3개의 노드가 있습니다. istio-system 네임스페이스에서 ztunnel이 제대로 실행 중인지 확인해 봅시다.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:istio-system)➜  ~ kgpo -owide\n\u003cspan class=\"hljs-variable constant_\"\u003eNAME\u003c/span\u003e                                    \u003cspan class=\"hljs-variable constant_\"\u003eREADY\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eSTATUS\u003c/span\u003e    \u003cspan class=\"hljs-variable constant_\"\u003eRESTARTS\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eAGE\u003c/span\u003e    \u003cspan class=\"hljs-variable constant_\"\u003eIP\u003c/span\u003e               \u003cspan class=\"hljs-variable constant_\"\u003eNODE\u003c/span\u003e                    \u003cspan class=\"hljs-variable constant_\"\u003eNOMINATED\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eNODE\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eREADINESS\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eGATES\u003c/span\u003e\nistio-cni-node-7q6z7                    \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e          117m   \u003cspan class=\"hljs-number\"\u003e172.18\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.2\u003c/span\u003e       ambient-worker2         \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\nistio-cni-node-fg6n4                    \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e          117m   \u003cspan class=\"hljs-number\"\u003e172.18\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.4\u003c/span\u003e       ambient-worker          \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\nistio-cni-node-gwvl8                    \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e          117m   \u003cspan class=\"hljs-number\"\u003e172.18\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.3\u003c/span\u003e       ambient-control-plane   \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\nistio-ingressgateway-6f48dfb7db-862sm   \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e          117m   \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.70\u003c/span\u003e   ambient-worker          \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\nistiod-6875bc5c58-n4j7d                 \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e          118m   \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.246\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.2\u003c/span\u003e    ambient-worker2         \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\nztunnel-62hp8                           \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e          117m   \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.246\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.3\u003c/span\u003e    ambient-worker2         \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\nztunnel-fv5f8                           \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e          117m   \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.71\u003c/span\u003e   ambient-worker          \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\nztunnel-gs52c                           \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e          117m   \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.208\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e    ambient-control-plane   \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\n\n(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:istio-system)➜  ~ kg ds\n\u003cspan class=\"hljs-variable constant_\"\u003eNAME\u003c/span\u003e             \u003cspan class=\"hljs-variable constant_\"\u003eDESIRED\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eCURRENT\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eREADY\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eUP\u003c/span\u003e-\u003cspan class=\"hljs-variable constant_\"\u003eTO\u003c/span\u003e-\u003cspan class=\"hljs-variable constant_\"\u003eDATE\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eAVAILABLE\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eNODE\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eSELECTOR\u003c/span\u003e            \u003cspan class=\"hljs-variable constant_\"\u003eAGE\u003c/span\u003e\nistio-cni-node   \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e         \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e         \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e       \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e            \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e           kubernetes.\u003cspan class=\"hljs-property\"\u003eio\u003c/span\u003e/os=linux   119m\nztunnel          \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e         \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e         \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e       \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e            \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e           kubernetes.\u003cspan class=\"hljs-property\"\u003eio\u003c/span\u003e/os=linux   118m\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e정말로 3개의 파드가 있네요 !\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e비슷하게 Istio-cni는 또 다른 설치된 데몬세트입니다.\u003c/li\u003e\n\u003cli\u003eIstio 제어 평면인 istiod도 실행 중입니다.\u003c/li\u003e\n\u003cli\u003e우리는 공개 트래픽을 위해 기본 istio ingressgateway도 설치했습니다.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch1\u003e작업량 설정\u003c/h1\u003e\n\u003cp\u003e이 프로젝트의 모든 매니페스트 파일은 여기에서 찾을 수 있습니다: \u003ca href=\"https://github.com/JanaSabuj/istio-ambient-mesh-exploration\" rel=\"nofollow\" target=\"_blank\"\u003ehttps://github.com/JanaSabuj/istio-ambient-mesh-exploration\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003e안건\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e우리는 앰비언트 프로필 없이 앱을 설정하고, 일반 Istio crds를 사용할 것입니다. 그 후에 앱을 호출할 예정입니다. i) 인그레스 ii) 디버그 클라이언트 pod\u003c/li\u003e\n\u003cli\u003e그 후에, Istio 데이터 평면 모드를 앰비언트로 전환하고, ztunnel pod를 통해 흐르는 트래픽 경로의 변화를 관찰할 것입니다.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch2\u003e네임스페이스\u003c/h2\u003e\n\u003cp\u003eambient-demo라는 네임스페이스를 만들어 보겠습니다. 이 네임스페이스에서 앱을 호스팅할 예정입니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:istio-system)➜  ~ k create ns ambient-demo\n\n(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:istio-system)➜  ~ kg ns\n\u003cspan class=\"hljs-variable constant_\"\u003eNAME\u003c/span\u003e                 \u003cspan class=\"hljs-variable constant_\"\u003eSTATUS\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eAGE\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e              \u003cspan class=\"hljs-title class_\"\u003eActive\u003c/span\u003e   132m\nistio-system         \u003cspan class=\"hljs-title class_\"\u003eActive\u003c/span\u003e   125m\nkube-node-lease      \u003cspan class=\"hljs-title class_\"\u003eActive\u003c/span\u003e   132m\nkube-public          \u003cspan class=\"hljs-title class_\"\u003eActive\u003c/span\u003e   132m\nkube-system          \u003cspan class=\"hljs-title class_\"\u003eActive\u003c/span\u003e   132m\nlocal-path-storage   \u003cspan class=\"hljs-title class_\"\u003eActive\u003c/span\u003e   132m\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e애플리케이션\u003c/h2\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e그럼 배포, 서비스 및 서비스 어카운트 yaml을 사용하여 애플리케이션을 배포합니다.\u003c/p\u003e\n\u003cp\u003e클러스터에서는 다음과 같이 보입니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(⎈|kind-ambient:ambient-demo)➜  ~ kg all\nNAME                          READY   STATUS    RESTARTS   AGE\npod/httpbin-6f4dc97cb-5dpz9   1/1     Running   0          3m21s\npod/httpbin-6f4dc97cb-swdlb   1/1     Running   0          3m31s\n\nNAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE\nservice/httpbin   ClusterIP   10.96.157.221   \u0026#x3C;none\u003e        80/TCP    143m\n\nNAME                      READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/httpbin   2/2     2            2           143m\n\nNAME                                 DESIRED   CURRENT   READY   AGE\nreplicaset.apps/httpbin-6f4dc97cb    2         2         2       3m31s\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eIstio 구성\u003c/h2\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e외부 세계에 노출하기 위해 Istio Gateway 및 Istio VirtualService를 생성하여 Istio Ingress를 통해 액세스할 수 있게 만듭니다.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e우리는 Istio Ingress 파드에 8081 포트를 통해 게이트웨이를 추가하고 있습니다.\u003c/li\u003e\n\u003cli\u003e그 다음으로, VirtualService를 통해 ambient-demo 네임스페이스에서 실행되는 httpbin 서비스로 라우팅합니다.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eIstio Ingress를 통한 확인\u003c/h2\u003e\n\u003cp\u003e이제 우리의 응용 프로그램에 액세스할 수 있는지 확인할 수 있습니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:istio-system)➜  ~ kgs\n\u003cspan class=\"hljs-variable constant_\"\u003eNAME\u003c/span\u003e                   \u003cspan class=\"hljs-variable constant_\"\u003eTYPE\u003c/span\u003e           \u003cspan class=\"hljs-variable constant_\"\u003eCLUSTER\u003c/span\u003e-\u003cspan class=\"hljs-variable constant_\"\u003eIP\u003c/span\u003e     \u003cspan class=\"hljs-variable constant_\"\u003eEXTERNAL\u003c/span\u003e-\u003cspan class=\"hljs-variable constant_\"\u003eIP\u003c/span\u003e   \u003cspan class=\"hljs-title function_\"\u003ePORT\u003c/span\u003e(S)                                      \u003cspan class=\"hljs-variable constant_\"\u003eAGE\u003c/span\u003e\nistio-ingressgateway   \u003cspan class=\"hljs-title class_\"\u003eLoadBalancer\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e10.96\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.77\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.172\u003c/span\u003e   \u0026#x3C;pending\u003e     \u003cspan class=\"hljs-number\"\u003e15021\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e30807\u003c/span\u003e/\u003cspan class=\"hljs-variable constant_\"\u003eTCP\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e30587\u003c/span\u003e/\u003cspan class=\"hljs-variable constant_\"\u003eTCP\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e443\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e31004\u003c/span\u003e/\u003cspan class=\"hljs-variable constant_\"\u003eTCP\u003c/span\u003e   147m\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eKind가 인그레스 서비스를 위한 외부 IP를 제공하지 않았기 때문에, 원하는 리스너 8081에서 인그레스 파드를 포트포워딩하여 외부 액세스를 시뮬레이션할 것입니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:istio-system)➜  ~ kpf istio-ingressgateway-6f48dfb7db-862sm \u003cspan class=\"hljs-number\"\u003e8081\u003c/span\u003e\n\u003cspan class=\"hljs-title class_\"\u003eForwarding\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e127.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e8081\u003c/span\u003e -\u003e \u003cspan class=\"hljs-number\"\u003e8081\u003c/span\u003e\n\u003cspan class=\"hljs-title class_\"\u003eForwarding\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e [::\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e]:\u003cspan class=\"hljs-number\"\u003e8081\u003c/span\u003e -\u003e \u003cspan class=\"hljs-number\"\u003e8081\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e브라우저에서 127.0.0.1:8081을 입력하여 애플리케이션을 확인할 수 있습니다!\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-attr\"\u003ehttp\u003c/span\u003e:\u003cspan class=\"hljs-comment\"\u003e//127.0.0.1:8081/\u003c/span\u003e\n\nhttpbin.\u003cspan class=\"hljs-property\"\u003eorg\u003c/span\u003e\n \u003cspan class=\"hljs-number\"\u003e0.9\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.2\u003c/span\u003e\n[ \u003cspan class=\"hljs-title class_\"\u003eBase\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eURL\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e127.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e8081\u003c/span\u003e/ ]\n간단한 \u003cspan class=\"hljs-variable constant_\"\u003eHTTP\u003c/span\u003e 요청 및 응답 서비스입니다.\n\n로컬에서 실행: $ docker run -p \u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e kennethreitz/httpbin\n\n개발자 - 웹사이트\n개발자에게 이메일 보내기\n\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e또 다른 확인 방법은 로컬에서 curl을 통해 하는 것입니다. 우리는 요청이 istio-envoy 파드에 의해 처리된 것을 확인합니다.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:istio-system)➜  ~ curl \u003cspan class=\"hljs-number\"\u003e127.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e8081\u003c/span\u003e -v\n*   \u003cspan class=\"hljs-title class_\"\u003eTrying\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e127.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e8081.\u003c/span\u003e..\n* \u003cspan class=\"hljs-title class_\"\u003eConnected\u003c/span\u003e to \u003cspan class=\"hljs-number\"\u003e127.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e (\u003cspan class=\"hljs-number\"\u003e127.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e) port \u003cspan class=\"hljs-number\"\u003e8081\u003c/span\u003e\n\u003e \u003cspan class=\"hljs-variable constant_\"\u003eGET\u003c/span\u003e / \u003cspan class=\"hljs-variable constant_\"\u003eHTTP\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1.1\u003c/span\u003e\n\u003e \u003cspan class=\"hljs-title class_\"\u003eHost\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e127.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e8081\u003c/span\u003e\n\u003e \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e-\u003cspan class=\"hljs-title class_\"\u003eAgent\u003c/span\u003e: curl/\u003cspan class=\"hljs-number\"\u003e8.6\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\n\u003e \u003cspan class=\"hljs-title class_\"\u003eAccept\u003c/span\u003e: *\u003cspan class=\"hljs-comment\"\u003e/*\n\u003e\n\u0026#x3C; HTTP/1.1 200 OK\n\u0026#x3C; server: istio-envoy\n\u0026#x3C; date: Sun, 16 Jun 2024 11:52:13 GMT\n\u0026#x3C; content-type: text/html; charset=utf-8\n\u0026#x3C; content-length: 9593\n\u0026#x3C; access-control-allow-origin: *\n\u0026#x3C; access-control-allow-credentials: true\n\u0026#x3C; x-envoy-upstream-service-time: 271\n\u0026#x3C;\n\u0026#x3C;!DOCTYPE html\u003e\n\u0026#x3C;html lang=\"en\"\u003e\n...\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e디버그 클라이언트 파드를 통한 확인\u003c/h2\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e우리는 메쉬 내부 호출을 테스트해보려고 합니다. 따라서 각 노드마다 클라이언트 팟이 하나씩 있는 것이 좋습니다. 이를 위해 디버거 데몬세트 클라이언트 워크로드를 설정할 수 있습니다 — \u003ca href=\"https://github.com/digitalocean/doks-debug\" rel=\"nofollow\" target=\"_blank\"\u003ehttps://github.com/digitalocean/doks-debug\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e사용한 수정된 Manifest: \u003ca href=\"https://gist.github.com/JanaSabuj/a4dd2504752b8c2b30d2d2d05320f7ef\" rel=\"nofollow\" target=\"_blank\"\u003ehttps://gist.github.com/JanaSabuj/a4dd2504752b8c2b30d2d2d05320f7ef\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e저는 이 데몬세트를 우리 ambient-demo 네임스페이스에 배포했습니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:ambient-demo)➜  ~ kg ds\n\u003cspan class=\"hljs-variable constant_\"\u003eNAME\u003c/span\u003e         \u003cspan class=\"hljs-variable constant_\"\u003eDESIRED\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eCURRENT\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eREADY\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eUP\u003c/span\u003e-\u003cspan class=\"hljs-variable constant_\"\u003eTO\u003c/span\u003e-\u003cspan class=\"hljs-variable constant_\"\u003eDATE\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eAVAILABLE\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eNODE\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eSELECTOR\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eAGE\u003c/span\u003e\ndoks-debug   \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e         \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e         \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e       \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e            \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e           \u0026#x3C;none\u003e          89m\n\n(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:ambient-demo)➜  ~ kgpo -owide\n\u003cspan class=\"hljs-variable constant_\"\u003eNAME\u003c/span\u003e                      \u003cspan class=\"hljs-variable constant_\"\u003eREADY\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eSTATUS\u003c/span\u003e    \u003cspan class=\"hljs-variable constant_\"\u003eRESTARTS\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eAGE\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eIP\u003c/span\u003e               \u003cspan class=\"hljs-variable constant_\"\u003eNODE\u003c/span\u003e                    \u003cspan class=\"hljs-variable constant_\"\u003eNOMINATED\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eNODE\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eREADINESS\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eGATES\u003c/span\u003e\ndoks-debug-j9mm5          \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e          90m   \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.246\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.5\u003c/span\u003e    ambient-worker2         \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\ndoks-debug-rdhgq          \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e          90m   \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.73\u003c/span\u003e   ambient-worker          \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\ndoks-debug-v7cld          \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e          90m   \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.208\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.3\u003c/span\u003e    ambient-control-plane   \u0026#x3C;none\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e테스트해 보기 위해 디버그 팟으로 진입하여 k8s fqdn httpbin.ambient-demo.svc.cluster.local을 curl을 시도해 보았습니다.\u003c/p\u003e\n\u003cp\u003e200 OK를 반환하고 있습니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:ambient-demo)➜  ~ k exec -it doks-debug-j9mm5 -- \u003cspan class=\"hljs-regexp\"\u003e/bin/\u003c/span\u003ebash\n\nroot@doks-debug-\u003cspan class=\"hljs-attr\"\u003ej9mm5\u003c/span\u003e:~# curl httpbin.\u003cspan class=\"hljs-property\"\u003eambient\u003c/span\u003e-demo.\u003cspan class=\"hljs-property\"\u003esvc\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecluster\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elocal\u003c/span\u003e -v\n*   \u003cspan class=\"hljs-title class_\"\u003eTrying\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10.96\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.157\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.221\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e80.\u003c/span\u003e..\n* \u003cspan class=\"hljs-title class_\"\u003eConnected\u003c/span\u003e to httpbin.\u003cspan class=\"hljs-property\"\u003eambient\u003c/span\u003e-demo.\u003cspan class=\"hljs-property\"\u003esvc\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecluster\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elocal\u003c/span\u003e (\u003cspan class=\"hljs-number\"\u003e10.96\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.157\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.221\u003c/span\u003e) port \u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e (#\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e)\n\u003e \u003cspan class=\"hljs-variable constant_\"\u003eGET\u003c/span\u003e / \u003cspan class=\"hljs-variable constant_\"\u003eHTTP\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1.1\u003c/span\u003e\n\u003e \u003cspan class=\"hljs-title class_\"\u003eHost\u003c/span\u003e: httpbin.\u003cspan class=\"hljs-property\"\u003eambient\u003c/span\u003e-demo.\u003cspan class=\"hljs-property\"\u003esvc\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecluster\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elocal\u003c/span\u003e\n\u003e \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e-\u003cspan class=\"hljs-title class_\"\u003eAgent\u003c/span\u003e: curl/\u003cspan class=\"hljs-number\"\u003e7.88\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e\n\u003e \u003cspan class=\"hljs-title class_\"\u003eAccept\u003c/span\u003e: *\u003cspan class=\"hljs-comment\"\u003e/*\n\u003e\n\u0026#x3C; HTTP/1.1 200 OK\n\u0026#x3C; Server: gunicorn/19.9.0\n\u0026#x3C; Date: Sun, 16 Jun 2024 12:06:11 GMT\n\u0026#x3C; Connection: keep-alive\n\u0026#x3C; Content-Type: text/html; charset=utf-8\n\u0026#x3C; Content-Length: 9593\n\u0026#x3C; Access-Control-Allow-Origin: *\n\u0026#x3C; Access-Control-Allow-Credentials: true\n\u0026#x3C;\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eAmbient Injection\u003c/h1\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e지금까지 앰비언트 모드가 활성화되지 않았습니다. Istio 게이트웨이에서 추가 된 리스너로 인해 요청은 Istio 인그레스 파드에 도착한 다음 VirtualService를 통해 앱 파드로 라우팅됩니다.\u003c/p\u003e\n\u003cp\u003e매쉬 내부 호출의 경우, 클라이언트와 서버 파드 사이에 직접적인 포드 간 통신이 이루어집니다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_8.png\" alt=\"이미지\"\u003e\u003c/p\u003e\n\u003cp\u003e앰비언트를 주입하는 동안 우리는 또한 다음 로그를 계속 추적할 것입니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cul\u003e\n\u003cli\u003eistio-cni\u003c/li\u003e\n\u003cli\u003eztunnel\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eIstio가 네임스페이스 ambient-demo에 대한 Ambient Dataplane 모드를 활성화하도록 내부적으로 라우트, iptables 등을 설정했는지 확인하려면 아래 명령어를 사용해보세요.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:ambient-demo)➜\n~ kubectl label namespace ambient-demo istio.\u003cspan class=\"hljs-property\"\u003eio\u003c/span\u003e/dataplane-mode=ambient\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e관찰된 로그\u003c/h2\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cul\u003e\n\u003cli\u003eistio-cni\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:ambient-demo)➜ ~ stern istio-cni -n istio-system\n\nistio-cni-node-7q6z7 install-cni \u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e06\u003c/span\u003e-16\u003cspan class=\"hljs-attr\"\u003eT10\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e13\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59.\u003c/span\u003e243451Z info ambient \u003cspan class=\"hljs-title class_\"\u003eNamespace\u003c/span\u003e ambient-demo is enabled \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e ambient mesh\nistio-cni-node-7q6z7 install-cni \u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e06\u003c/span\u003e-16\u003cspan class=\"hljs-attr\"\u003eT10\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e13\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59.\u003c/span\u003e264500Z info ambient \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e pod mode - adding pod ambient-demo/httpbin-5bd875fbdd-84vs8 to ztunnel\nistio-cni-node-gwvl8 install-cni \u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e06\u003c/span\u003e-16\u003cspan class=\"hljs-attr\"\u003eT10\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e13\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59.\u003c/span\u003e291505Z info ambient \u003cspan class=\"hljs-title class_\"\u003eNamespace\u003c/span\u003e ambient-demo is enabled \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e ambient mesh\nistio-cni-node-fg6n4 install-cni \u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e06\u003c/span\u003e-16\u003cspan class=\"hljs-attr\"\u003eT10\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e13\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59.\u003c/span\u003e281587Z info ambient \u003cspan class=\"hljs-title class_\"\u003eNamespace\u003c/span\u003e ambient-demo is enabled \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e ambient mesh\nistio-cni-node-fg6n4 install-cni \u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e06\u003c/span\u003e-16\u003cspan class=\"hljs-attr\"\u003eT10\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e13\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59.\u003c/span\u003e313668Z info ambient \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e pod mode - adding pod ambient-demo/httpbin-5bd875fbdd-dp4ct to ztunnel\n\nistio-cni-node-7q6z7 install-cni \u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e06\u003c/span\u003e-16\u003cspan class=\"hljs-attr\"\u003eT10\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e13\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59.\u003c/span\u003e264500Z info ambient \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e pod mode - adding pod ambient-demo/httpbin-5bd875fbdd-84vs8 to ztunnel\nistio-cni-node-7q6z7 install-cni \u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e06\u003c/span\u003e-16\u003cspan class=\"hljs-attr\"\u003eT10\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e13\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59.\u003c/span\u003e325907Z info iptables \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e iptables-restore \u003cspan class=\"hljs-keyword\"\u003ewith\u003c/span\u003e the following \u003cspan class=\"hljs-attr\"\u003einput\u003c/span\u003e:\nistio-cni-node-7q6z7 install-cni * nat\nistio-cni-node-7q6z7 install-cni -N \u003cspan class=\"hljs-variable constant_\"\u003eISTIO_OUTPUT\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni -A \u003cspan class=\"hljs-variable constant_\"\u003eOUTPUT\u003c/span\u003e -j \u003cspan class=\"hljs-variable constant_\"\u003eISTIO_OUTPUT\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni -A \u003cspan class=\"hljs-variable constant_\"\u003eISTIO_OUTPUT\u003c/span\u003e -d \u003cspan class=\"hljs-number\"\u003e169.254\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.7\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.127\u003c/span\u003e -p tcp -m tcp -j \u003cspan class=\"hljs-variable constant_\"\u003eACCEPT\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni -A \u003cspan class=\"hljs-variable constant_\"\u003eISTIO_OUTPUT\u003c/span\u003e -p tcp -m mark --mark \u003cspan class=\"hljs-number\"\u003e0x111\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e0xfff\u003c/span\u003e -j \u003cspan class=\"hljs-variable constant_\"\u003eACCEPT\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni -A \u003cspan class=\"hljs-variable constant_\"\u003eISTIO_OUTPUT\u003c/span\u003e ! -d \u003cspan class=\"hljs-number\"\u003e127.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e -o lo -j \u003cspan class=\"hljs-variable constant_\"\u003eACCEPT\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni -A \u003cspan class=\"hljs-variable constant_\"\u003eISTIO_OUTPUT\u003c/span\u003e ! -d \u003cspan class=\"hljs-number\"\u003e127.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e -p tcp -m mark ! --mark \u003cspan class=\"hljs-number\"\u003e0x539\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e0xfff\u003c/span\u003e -j \u003cspan class=\"hljs-variable constant_\"\u003eREDIRECT\u003c/span\u003e --to-ports \u003cspan class=\"hljs-number\"\u003e15001\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni \u003cspan class=\"hljs-variable constant_\"\u003eCOMMIT\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni * mangle\nistio-cni-node-7q6z7 install-cni -N \u003cspan class=\"hljs-variable constant_\"\u003eISTIO_PRERT\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni -N \u003cspan class=\"hljs-variable constant_\"\u003eISTIO_OUTPUT\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni -A \u003cspan class=\"hljs-variable constant_\"\u003ePREROUTING\u003c/span\u003e -j \u003cspan class=\"hljs-variable constant_\"\u003eISTIO_PRERT\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni -A \u003cspan class=\"hljs-variable constant_\"\u003eOUTPUT\u003c/span\u003e -j \u003cspan class=\"hljs-variable constant_\"\u003eISTIO_OUTPUT\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni -A \u003cspan class=\"hljs-variable constant_\"\u003eISTIO_PRERT\u003c/span\u003e -m mark --mark \u003cspan class=\"hljs-number\"\u003e0x539\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e0xfff\u003c/span\u003e -j \u003cspan class=\"hljs-variable constant_\"\u003eCONNMARK\u003c/span\u003e --set-xmark \u003cspan class=\"hljs-number\"\u003e0x111\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e0xfff\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni -A \u003cspan class=\"hljs-variable constant_\"\u003eISTIO_PRERT\u003c/span\u003e -s \u003cspan class=\"hljs-number\"\u003e169.254\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.7\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.127\u003c/span\u003e -p tcp -m tcp -j \u003cspan class=\"hljs-variable constant_\"\u003eACCEPT\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni -A \u003cspan class=\"hljs-variable constant_\"\u003eISTIO_PRERT\u003c/span\u003e ! -d \u003cspan class=\"hljs-number\"\u003e127.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e -p tcp -i lo -j \u003cspan class=\"hljs-variable constant_\"\u003eACCEPT\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni -A \u003cspan class=\"hljs-variable constant_\"\u003eISTIO_PRERT\u003c/span\u003e -p tcp -m tcp --dport \u003cspan class=\"hljs-number\"\u003e15008\u003c/span\u003e -m mark ! --mark \u003cspan class=\"hljs-number\"\u003e0x539\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e0xfff\u003c/span\u003e -j \u003cspan class=\"hljs-variable constant_\"\u003eTPROXY\u003c/span\u003e --on-port \u003cspan class=\"hljs-number\"\u003e15008\u003c/span\u003e --tproxy-mark \u003cspan class=\"hljs-number\"\u003e0x111\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e0xfff\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni -A \u003cspan class=\"hljs-variable constant_\"\u003eISTIO_PRERT\u003c/span\u003e -p tcp -m conntrack --ctstate \u003cspan class=\"hljs-variable constant_\"\u003eRELATED\u003c/span\u003e,\u003cspan class=\"hljs-variable constant_\"\u003eESTABLISHED\u003c/span\u003e -j \u003cspan class=\"hljs-variable constant_\"\u003eACCEPT\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni -A \u003cspan class=\"hljs-variable constant_\"\u003eISTIO_PRERT\u003c/span\u003e ! -d \u003cspan class=\"hljs-number\"\u003e127.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e32\u003c/span\u003e -p tcp -m mark ! --mark \u003cspan class=\"hljs-number\"\u003e0x539\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e0xfff\u003c/span\u003e -j \u003cspan class=\"hljs-variable constant_\"\u003eTPROXY\u003c/span\u003e --on-port \u003cspan class=\"hljs-number\"\u003e15006\u003c/span\u003e --tproxy-mark \u003cspan class=\"hljs-number\"\u003e0x111\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e0xfff\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni -A \u003cspan class=\"hljs-variable constant_\"\u003eISTIO_OUTPUT\u003c/span\u003e -m connmark --mark \u003cspan class=\"hljs-number\"\u003e0x111\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e0xfff\u003c/span\u003e -j \u003cspan class=\"hljs-variable constant_\"\u003eCONNMARK\u003c/span\u003e --restore-mark --nfmask \u003cspan class=\"hljs-number\"\u003e0xffffffff\u003c/span\u003e --ctmask \u003cspan class=\"hljs-number\"\u003e0xffffffff\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni \u003cspan class=\"hljs-variable constant_\"\u003eCOMMIT\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni \u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e06\u003c/span\u003e-16\u003cspan class=\"hljs-attr\"\u003eT10\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e13\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59.\u003c/span\u003e335115Z info \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e command (\u003cspan class=\"hljs-keyword\"\u003ewith\u003c/span\u003e wait lock): iptables-restore --noflush -v --wait=\u003cspan class=\"hljs-number\"\u003e30\u003c/span\u003e\nistio-cni-node-7q6z7 install-cni \u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e06\u003c/span\u003e-16\u003cspan class=\"hljs-attr\"\u003eT10\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e13\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e59.\u003c/span\u003e550687Z info ambient \u003cspan class=\"hljs-title class_\"\u003eAbout\u003c/span\u003e to send added \u003cspan class=\"hljs-attr\"\u003epod\u003c/span\u003e: 3ab72f78-8e2b-\u003cspan class=\"hljs-number\"\u003e4e49\u003c/span\u003e-bc47-45fa4f90dbf7 to \u003cspan class=\"hljs-attr\"\u003eztunnel\u003c/span\u003e: \u003cspan class=\"hljs-attr\"\u003eadd\u003c/span\u003e:{\u003cspan class=\"hljs-attr\"\u003euid\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e\"3ab72f78-8e2b-4e49-bc47-45fa4f90dbf7\"\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eworkload_info\u003c/span\u003e:{\u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e\"httpbin-5bd875fbdd-84vs8\"\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003enamespace\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e\"ambient-demo\"\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eservice_account\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e\"default\"\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etrust_domain\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e\"cluster.local\"\u003c/span\u003e}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e많은 로그가 생성되었습니다. 우리는 각 httpbin pod를 ambient-demo 네임스페이스에 추가하여 ztunnel을 통해 ambient 경로에 추가하고 있음을 확인할 수 있습니다.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eztunnel\u003c/li\u003e\n\u003c/ul\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-plaintext\"\u003e(⎈|kind-ambient:ambient-demo)➜ ~ stern ztunnel -n istio-system\n\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.559505Z 정보 inpod::statemanager pod WorkloadUid(\"3ab72f78-8e2b-4e49-bc47-45fa4f90dbf7\")가 netns를 수신하고 프록시를 시작합니다.\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.557545Z 정보 inpod::statemanager pod WorkloadUid(\"7f8be6a6-64f2-40e9-8926-6c3a618eb7d9\")가 netns를 수신하고 프록시를 시작합니다.\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.560458Z 정보 proxy::inbound 리스너가 구성되었으며 주소=[::]:15008 구성요소=\"inbound\" 투명=true\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.561604Z 정보 proxy::inbound_passthrough 리스너가 구성되었으며 주소=[::]:15006 구성요소=\"inbound plaintext\" 투명=true\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.561647Z 정보 proxy::outbound 리스너가 구성되었으며 주소=[::]:15001 구성요소=\"outbound\" 투명=true\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.573883Z 정보 proxy::inbound 리스너가 구성되었으며 주소=[::]:15008 구성요소=\"inbound\" 투명=true\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.586596Z 정보 proxy::inbound_passthrough 리스너가 구성되었으며 주소=[::]:15006 구성요소=\"inbound plaintext\" 투명=true\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.586819Z 정보 proxy::outbound 리스너가 구성되었으며 주소=[::]:15001 구성요소=\"outbound\" 투명=true\nztunnel-fv5f8 istio-proxy 2024-06-16T10:13:59.811460Z 정보 xds::client:xds{id=14}가 응답을 수신했습니다. type_url=\"type.googleapis.com/istio.workload.Address\" 크기=2  삭제=0\nztunnel-62hp8 istio-proxy 2024-06-16T10:13:59.816352Z 정보 xds::client:xds{id=14}가 응답을 수신했습니다. type_url=\"type.googleapis.com/istio.workload.Address\" 크기=2  삭제=0\nztunnel-gs52c istio-proxy 2024-06-16T10:13:59.821310Z 정보 xds::client:xds{id=14}가 응답을 수신했습니다. type_url=\"type.googleapis.com/istio.workload.Address\" 크기=2  삭제=0\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eztunnel이 자체 내부 및 외부 리스너를 설정 중인 것으로 보입니다.\u003c/p\u003e\n\u003ch2\u003e트래픽 흐름 - Istio Ingress를 통해\u003c/h2\u003e\n\u003cp\u003e이전과 마찬가지로, istio-ingress pod로 포트 포워딩을 설정하고 localhost를 통해 액세스합니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e두 개의 호출을 각각 2개의 httpbin 팟에 대응하도록 인그레스에서 호출을 추출하려고 합니다. 그리고 동시에 동일한 ztunnel 로그를 캡처하려고 합니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:istio-system)➜  ~ kpf istio-ingressgateway-6f48dfb7db-862sm \u003cspan class=\"hljs-number\"\u003e8081\u003c/span\u003e\n\u003cspan class=\"hljs-title class_\"\u003eForwarding\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e127.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.0\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e8081\u003c/span\u003e -\u003e \u003cspan class=\"hljs-number\"\u003e8081\u003c/span\u003e\n\n$ curl \u003cspan class=\"hljs-attr\"\u003elocalhost\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e8081\u003c/span\u003e/\n$ curl \u003cspan class=\"hljs-attr\"\u003elocalhost\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e8081\u003c/span\u003e/\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:istio-system)➜  ~ stern ztunnel -n istio-system\n\nztunnel-fv5f8 istio-proxy \u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e06\u003c/span\u003e-16\u003cspan class=\"hljs-attr\"\u003eT12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e26\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e24.\u003c/span\u003e154500Z\ninfo access connection complete src.\u003cspan class=\"hljs-property\"\u003eaddr\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.70\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e52792\u003c/span\u003e\nsrc.\u003cspan class=\"hljs-property\"\u003eworkload\u003c/span\u003e=istio-ingressgateway-6f48dfb7db-862sm src.\u003cspan class=\"hljs-property\"\u003enamespace\u003c/span\u003e=istio-system\nsrc.\u003cspan class=\"hljs-property\"\u003eidentity\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account\"\u003c/span\u003e\ndst.\u003cspan class=\"hljs-property\"\u003eaddr\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.74\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e dst.\u003cspan class=\"hljs-property\"\u003ehbone_addr\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.74\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e\ndst.\u003cspan class=\"hljs-property\"\u003eservice\u003c/span\u003e=httpbin.\u003cspan class=\"hljs-property\"\u003eambient\u003c/span\u003e-demo.\u003cspan class=\"hljs-property\"\u003esvc\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecluster\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elocal\u003c/span\u003e\ndst.\u003cspan class=\"hljs-property\"\u003eworkload\u003c/span\u003e=httpbin-6f4dc97cb-swdlb dst.\u003cspan class=\"hljs-property\"\u003enamespace\u003c/span\u003e=ambient-demo\ndst.\u003cspan class=\"hljs-property\"\u003eidentity\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\"\u003c/span\u003e\ndirection=\u003cspan class=\"hljs-string\"\u003e\"inbound\"\u003c/span\u003e bytes_sent=\u003cspan class=\"hljs-number\"\u003e51083\u003c/span\u003e bytes_recv=\u003cspan class=\"hljs-number\"\u003e4180\u003c/span\u003e duration=\u003cspan class=\"hljs-string\"\u003e\"2166ms\"\u003c/span\u003e\n\nztunnel-62hp8 istio-proxy \u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e06\u003c/span\u003e-16\u003cspan class=\"hljs-attr\"\u003eT12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e28\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e40.\u003c/span\u003e267690Z\ninfo access connection complete src.\u003cspan class=\"hljs-property\"\u003eaddr\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.70\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e55036\u003c/span\u003e\nsrc.\u003cspan class=\"hljs-property\"\u003eworkload\u003c/span\u003e=istio-ingressgateway-6f48dfb7db-862sm src.\u003cspan class=\"hljs-property\"\u003enamespace\u003c/span\u003e=istio-system\nsrc.\u003cspan class=\"hljs-property\"\u003eidentity\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account\"\u003c/span\u003e\ndst.\u003cspan class=\"hljs-property\"\u003eaddr\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.246\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.6\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e dst.\u003cspan class=\"hljs-property\"\u003ehbone_addr\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.246\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.6\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e\ndst.\u003cspan class=\"hljs-property\"\u003eservice\u003c/span\u003e=httpbin.\u003cspan class=\"hljs-property\"\u003eambient\u003c/span\u003e-demo.\u003cspan class=\"hljs-property\"\u003esvc\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecluster\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elocal\u003c/span\u003e\ndst.\u003cspan class=\"hljs-property\"\u003eworkload\u003c/span\u003e=httpbin-6f4dc97cb-5dpz9 dst.\u003cspan class=\"hljs-property\"\u003enamespace\u003c/span\u003e=ambient-demo\ndst.\u003cspan class=\"hljs-property\"\u003eidentity\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\"\u003c/span\u003e\ndirection=\u003cspan class=\"hljs-string\"\u003e\"inbound\"\u003c/span\u003e bytes_sent=\u003cspan class=\"hljs-number\"\u003e41251\u003c/span\u003e bytes_recv=\u003cspan class=\"hljs-number\"\u003e2007\u003c/span\u003e duration=\u003cspan class=\"hljs-string\"\u003e\"2331ms\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e인그레스가 주변 데이터 플레인 경로에 떨어지지 않기 때문에 인그레스 팟에서의 호출은 주변 데이터 플레인 경로로 직접 ztunnel 팟으로 이어집니다. 한 번에 하나의 노드로 이동한 후 해당 내부 노드 팟으로 inbound됩니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e아래는 로그 캡처에서 확인한 내용입니다\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003edirection = \u003cspan class=\"hljs-string\"\u003e\"inbound\"\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e이는 주변 레이블이 붙은 네임스페이스 파드로의 트래픽이 항상 ztunnel을 통해 이동함을 확인합니다.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003edst.hbone_addr=192.168.184.74:80\ndst.hbone_addr=192.168.246.6:80\u003c/p\u003e\n\u003cp\u003ehttpbin-6f4dc97cb-5dpz9 1/1 Running 0 56m 192.168.246.6 ambient-worker2 \u003cnone\u003e \u003cnone\u003e\nhttpbin-6f4dc97cb-swdlb 1/1 Running 0 56m 192.168.184.74 ambient-worker \u003cnone\u003e \u003cnone\u003e\u003c/none\u003e\u003c/none\u003e\u003c/none\u003e\u003c/none\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e이것은 실제 httpbin pod ip에 해당하는 dest pod ip를 캡처합니다.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e트래픽 흐름 — Mesh 내부를 통해\u003c/h2\u003e\n\u003cp\u003e클라이언트 디버그 pod에 exec하여 httpbin 서비스로의 Mesh 내부 호출을 시도하고 동시에 ztunnel 로그를 캡쳐하여 동일한 동작을 확인해보겠습니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:ambient-demo)➜  ~ kgpo -owide\n\u003cspan class=\"hljs-variable constant_\"\u003eNAME\u003c/span\u003e                      \u003cspan class=\"hljs-variable constant_\"\u003eREADY\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eSTATUS\u003c/span\u003e    \u003cspan class=\"hljs-variable constant_\"\u003eRESTARTS\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eAGE\u003c/span\u003e    \u003cspan class=\"hljs-variable constant_\"\u003eIP\u003c/span\u003e               \u003cspan class=\"hljs-variable constant_\"\u003eNODE\u003c/span\u003e                    \u003cspan class=\"hljs-variable constant_\"\u003eNOMINATED\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eNODE\u003c/span\u003e   \u003cspan class=\"hljs-variable constant_\"\u003eREADINESS\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eGATES\u003c/span\u003e\ndoks-debug-j9mm5          \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e          122m   \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.246\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.5\u003c/span\u003e    ambient-worker2         \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\ndoks-debug-rdhgq          \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e          122m   \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.73\u003c/span\u003e   ambient-worker          \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\ndoks-debug-v7cld          \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e          122m   \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.208\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.3\u003c/span\u003e    ambient-control-plane   \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\nhttpbin-6f4dc97cb-5dpz9   \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e          56m    \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.246\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.6\u003c/span\u003e    ambient-worker2         \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\nhttpbin-6f4dc97cb-swdlb   \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e          56m    \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.74\u003c/span\u003e   ambient-worker          \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e그냥 같은 노드에 있는 클라이언트와 앱 팟들을 연결하기 위해 —\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:ambient-demo)➜  ~ kgpo -A -owide | grep \u003cspan class=\"hljs-string\"\u003e\"ambient-worker \"\u003c/span\u003e\nambient-demo         doks-debug-rdhgq                                \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e               133m    \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.73\u003c/span\u003e   ambient-worker          \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\nistio-system         ztunnel-fv5f8                                   \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e               3h24m   \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.71\u003c/span\u003e   ambient-worker          \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\nambient-demo         httpbin-6f4dc97cb-swdlb                         \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e               68m     \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.74\u003c/span\u003e   ambient-worker          \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\n\n\n(⎈|kind-\u003cspan class=\"hljs-attr\"\u003eambient\u003c/span\u003e:ambient-demo)➜  ~ kgpo -A -owide | grep \u003cspan class=\"hljs-string\"\u003e\"ambient-worker2\"\u003c/span\u003e\nkube-system          doks-debug-9nlh7                                \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e               3h6m    \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.246\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.4\u003c/span\u003e    ambient-worker2         \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\nistio-system         ztunnel-62hp8                                   \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e               3h23m   \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.246\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.3\u003c/span\u003e    ambient-worker2         \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\nambient-demo         httpbin-6f4dc97cb-5dpz9                         \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e     \u003cspan class=\"hljs-title class_\"\u003eRunning\u003c/span\u003e   \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e               67m     \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.246\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.6\u003c/span\u003e    ambient-worker2         \u0026#x3C;none\u003e           \u0026#x3C;none\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003edebug pod인 doks-debug-rdhgq를 실행하기 위해 ambient-worker 노드에 스케줄된 상태로 들어가보겠습니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cimg src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_10.png\"\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e테이블 \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e: 동일 노드 내의 클라이언트 및 서버\n---------\nztunnel-fv5f8 istio-proxy \u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e06\u003c/span\u003e-16\u003cspan class=\"hljs-attr\"\u003eT12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e40\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e48.\u003c/span\u003e707707Z info access connection complete src.\u003cspan class=\"hljs-property\"\u003eaddr\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.73\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e56463\u003c/span\u003e src.\u003cspan class=\"hljs-property\"\u003eworkload\u003c/span\u003e=doks-debug-rdhgq src.\u003cspan class=\"hljs-property\"\u003enamespace\u003c/span\u003e=ambient-demo src.\u003cspan class=\"hljs-property\"\u003eidentity\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"spiffe://cluster.local/ns/ambient-demo/sa/default\"\u003c/span\u003e dst.\u003cspan class=\"hljs-property\"\u003eaddr\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.74\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e dst.\u003cspan class=\"hljs-property\"\u003ehbone_addr\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.74\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e dst.\u003cspan class=\"hljs-property\"\u003eservice\u003c/span\u003e=httpbin.\u003cspan class=\"hljs-property\"\u003eambient\u003c/span\u003e-demo.\u003cspan class=\"hljs-property\"\u003esvc\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecluster\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elocal\u003c/span\u003e dst.\u003cspan class=\"hljs-property\"\u003eworkload\u003c/span\u003e=httpbin-6f4dc97cb-swdlb dst.\u003cspan class=\"hljs-property\"\u003enamespace\u003c/span\u003e=ambient-demo dst.\u003cspan class=\"hljs-property\"\u003eidentity\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\"\u003c/span\u003e direction  =\u003cspan class=\"hljs-string\"\u003e\"inbound\"\u003c/span\u003e bytes_sent=\u003cspan class=\"hljs-number\"\u003e9832\u003c/span\u003e bytes_recv=\u003cspan class=\"hljs-number\"\u003e84\u003c/span\u003e duration=\u003cspan class=\"hljs-string\"\u003e\"178ms\"\u003c/span\u003e\nztunnel-fv5f8 istio-proxy \u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e06\u003c/span\u003e-16\u003cspan class=\"hljs-attr\"\u003eT12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e40\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e48.\u003c/span\u003e708070Z info access connection complete src.\u003cspan class=\"hljs-property\"\u003eaddr\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.73\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e34190\u003c/span\u003e src.\u003cspan class=\"hljs-property\"\u003eworkload\u003c/span\u003e=doks-debug-rdhgq src.\u003cspan class=\"hljs-property\"\u003enamespace\u003c/span\u003e=ambient-demo src.\u003cspan class=\"hljs-property\"\u003eidentity\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"spiffe://cluster.local/ns/ambient-demo/sa/default\"\u003c/span\u003e dst.\u003cspan class=\"hljs-property\"\u003eaddr\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.74\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e15008\u003c/span\u003e dst.\u003cspan class=\"hljs-property\"\u003ehbone_addr\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.74\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e dst.\u003cspan class=\"hljs-property\"\u003eservice\u003c/span\u003e=httpbin.\u003cspan class=\"hljs-property\"\u003eambient\u003c/span\u003e-demo.\u003cspan class=\"hljs-property\"\u003esvc\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecluster\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elocal\u003c/span\u003e dst.\u003cspan class=\"hljs-property\"\u003eworkload\u003c/span\u003e=httpbin-6f4dc97cb-swdlb dst.\u003cspan class=\"hljs-property\"\u003enamespace\u003c/span\u003e=ambient-demo dst.\u003cspan class=\"hljs-property\"\u003eidentity\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\"\u003c/span\u003e direction=\u003cspan class=\"hljs-string\"\u003e\"outbound\"\u003c/span\u003e bytes_sent=\u003cspan class=\"hljs-number\"\u003e84\u003c/span\u003e bytes_recv=\u003cspan class=\"hljs-number\"\u003e9832\u003c/span\u003e duration=\u003cspan class=\"hljs-string\"\u003e\"203ms\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e동일 노드 내의 클라이언트와 서버의 경우, 파드에서 ztunnel로 외부 패킷이 들어오면 동일한 ztunnel을 통해 대상 파드로 들어오는 내부 패킷으로 리디렉션됩니다.\u003c/p\u003e\n\u003cp\u003e따라서, 동일 노드 내의 클라이언트 및 서버에서는 한 ztunnel이 외부 패킷과 내부 패킷을 받습니다. \"bound\"는 동일 노드 내의 응용 프로그램 파드로부터/받는 방향을 지정합니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e캡처 \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e: 클라이언트 및 서버가 다른 노드에 있는 경우\n---------\nztunnel-62hp8 istio-proxy \u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e06\u003c/span\u003e-16\u003cspan class=\"hljs-attr\"\u003eT12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e48\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e51.\u003c/span\u003e792527Z info access connection complete src.\u003cspan class=\"hljs-property\"\u003eaddr\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.73\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e53265\u003c/span\u003e src.\u003cspan class=\"hljs-property\"\u003eworkload\u003c/span\u003e=doks-debug-rdhgq src.\u003cspan class=\"hljs-property\"\u003enamespace\u003c/span\u003e=ambient-demo src.\u003cspan class=\"hljs-property\"\u003eidentity\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"spiffe://cluster.local/ns/ambient-demo/sa/default\"\u003c/span\u003e dst.\u003cspan class=\"hljs-property\"\u003eaddr\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.246\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.6\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e dst.\u003cspan class=\"hljs-property\"\u003ehbone_addr\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.246\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.6\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e dst.\u003cspan class=\"hljs-property\"\u003eservice\u003c/span\u003e=httpbin.\u003cspan class=\"hljs-property\"\u003eambient\u003c/span\u003e-demo.\u003cspan class=\"hljs-property\"\u003esvc\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecluster\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elocal\u003c/span\u003e dst.\u003cspan class=\"hljs-property\"\u003eworkload\u003c/span\u003e=httpbin-6f4dc97cb-5dpz9 dst.\u003cspan class=\"hljs-property\"\u003enamespace\u003c/span\u003e=ambient-demo dst.\u003cspan class=\"hljs-property\"\u003eidentity\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\"\u003c/span\u003e direction=\u003cspan class=\"hljs-string\"\u003e\"inbound\"\u003c/span\u003e bytes_sent=\u003cspan class=\"hljs-number\"\u003e9832\u003c/span\u003e bytes_recv=\u003cspan class=\"hljs-number\"\u003e84\u003c/span\u003e duration=\u003cspan class=\"hljs-string\"\u003e\"60ms\"\u003c/span\u003e\nztunnel-fv5f8 istio-proxy \u003cspan class=\"hljs-number\"\u003e2024\u003c/span\u003e-\u003cspan class=\"hljs-number\"\u003e06\u003c/span\u003e-16\u003cspan class=\"hljs-attr\"\u003eT12\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e48\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e51.\u003c/span\u003e793112Z info access connection complete src.\u003cspan class=\"hljs-property\"\u003eaddr\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.184\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.73\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e60162\u003c/span\u003e src.\u003cspan class=\"hljs-property\"\u003eworkload\u003c/span\u003e=doks-debug-rdhgq src.\u003cspan class=\"hljs-property\"\u003enamespace\u003c/span\u003e=ambient-demo src.\u003cspan class=\"hljs-property\"\u003eidentity\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"spiffe://cluster.local/ns/ambient-demo/sa/default\"\u003c/span\u003e dst.\u003cspan class=\"hljs-property\"\u003eaddr\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.246\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.6\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e15008\u003c/span\u003e dst.\u003cspan class=\"hljs-property\"\u003ehbone_addr\u003c/span\u003e=\u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.246\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.6\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e80\u003c/span\u003e dst.\u003cspan class=\"hljs-property\"\u003eservice\u003c/span\u003e=httpbin.\u003cspan class=\"hljs-property\"\u003eambient\u003c/span\u003e-demo.\u003cspan class=\"hljs-property\"\u003esvc\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecluster\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elocal\u003c/span\u003e dst.\u003cspan class=\"hljs-property\"\u003eworkload\u003c/span\u003e=httpbin-6f4dc97cb-5dpz9 dst.\u003cspan class=\"hljs-property\"\u003enamespace\u003c/span\u003e=ambient-demo dst.\u003cspan class=\"hljs-property\"\u003eidentity\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"spiffe://cluster.local/ns/ambient-demo/sa/httpbin-sa\"\u003c/span\u003e direction=\u003cspan class=\"hljs-string\"\u003e\"outbound\"\u003c/span\u003e bytes_sent=\u003cspan class=\"hljs-number\"\u003e84\u003c/span\u003e bytes_recv=\u003cspan class=\"hljs-number\"\u003e9832\u003c/span\u003e duration=\u003cspan class=\"hljs-string\"\u003e\"61ms\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e만약 클라이언트와 서버가 다른 노드에 있는 경우, 출발 트래픽은 동일한 노드인 ztunnel에서 외부 트래픽 패킷을 만나고, 그런 다음 목적지 파드의 노드의 ztunnel로 전송되어 들어오는 패킷으로 처리됩니다.\u003c/p\u003e\n\u003ch1\u003e결론\u003c/h1\u003e\n\u003cp\u003e이 실험을 통해 Istio Ambient Mesh에서 ztunnel을 통한 패킷 흐름을 시각화할 수 있었습니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel_11.png\" alt=\"이미지\"\u003e\u003c/p\u003e\n\u003cp\u003e다음 파트에서는 ztunnel을 통해 적용할 수 있는 L4 인증 정책을 탐색할 것입니다.\u003c/p\u003e\n\u003cp\u003e또한 Ambient에 있는 L7 프록시인 Waypoint Proxy에 대해 탐구할 것입니다.\u003c/p\u003e\n\u003cp\u003e다른 기술 블로그는 여기에서 확인할 수 있습니다: \u003ca href=\"https://janasabuj.github.io/posts/\" rel=\"nofollow\" target=\"_blank\"\u003e링크\u003c/a\u003e\u003c/p\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"2024-06-23-TouringtheKubernetesIstioAmbientMeshPart1SetupZTunnel"},"buildId":"-dPCbnM2yhdKNgXe92VJV","isFallback":false,"gsp":true,"scriptLoader":[{"async":true,"src":"https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4877378276818686","strategy":"lazyOnload","crossOrigin":"anonymous"}]}</script></body></html>