<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><title>Spring Boot로 API 게이트웨이 구현하는 방법 | ui-station</title><meta name="description" content=""/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:url" content="https://ui-station.github.io///post/2024-06-22-APIgatewayinSpringboot" data-gatsby-head="true"/><meta property="og:type" content="website" data-gatsby-head="true"/><meta property="og:site_name" content="Spring Boot로 API 게이트웨이 구현하는 방법 | ui-station" data-gatsby-head="true"/><meta property="og:title" content="Spring Boot로 API 게이트웨이 구현하는 방법 | ui-station" data-gatsby-head="true"/><meta property="og:description" content="" data-gatsby-head="true"/><meta property="og:image" content="/assets/img/2024-06-22-APIgatewayinSpringboot_0.png" data-gatsby-head="true"/><meta property="og:locale" content="en_US" data-gatsby-head="true"/><meta name="twitter:card" content="summary_large_image" data-gatsby-head="true"/><meta property="twitter:domain" content="https://ui-station.github.io/" data-gatsby-head="true"/><meta property="twitter:url" content="https://ui-station.github.io///post/2024-06-22-APIgatewayinSpringboot" data-gatsby-head="true"/><meta name="twitter:title" content="Spring Boot로 API 게이트웨이 구현하는 방법 | ui-station" data-gatsby-head="true"/><meta name="twitter:description" content="" data-gatsby-head="true"/><meta name="twitter:image" content="/assets/img/2024-06-22-APIgatewayinSpringboot_0.png" data-gatsby-head="true"/><meta name="twitter:data1" content="Dev | ui-station" data-gatsby-head="true"/><meta name="article:published_time" content="2024-06-22 22:18" data-gatsby-head="true"/><meta name="next-head-count" content="19"/><meta name="google-site-verification" content="a-yehRo3k3xv7fg6LqRaE8jlE42e5wP2bDE_2F849O4"/><link rel="stylesheet" href="/favicons/favicon.ico"/><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png"/><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/assets/favicons/favicon-96x96.png"/><link rel="icon" href="/favicons/apple-icon-180x180.png"/><link rel="apple-touch-icon" href="/favicons/apple-icon-180x180.png"/><link rel="apple-touch-startup-image" href="/startup.png"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black"/><meta name="msapplication-config" content="/favicons/browserconfig.xml"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-BHFR6GTH9P"></script><script>window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
          
            gtag('config', 'G-BHFR6GTH9P');</script><link rel="preload" href="/_next/static/css/6e57edcf9f2ce551.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6e57edcf9f2ce551.css" data-n-g=""/><link rel="preload" href="/_next/static/css/b8ef307c9aee1e34.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b8ef307c9aee1e34.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee6df16fdc6dae4d.js" defer=""></script><script src="/_next/static/chunks/framework-46611630e39cfdeb.js" defer=""></script><script src="/_next/static/chunks/main-cf4a52eec9a970a0.js" defer=""></script><script src="/_next/static/chunks/pages/_app-6fae11262ee5c69b.js" defer=""></script><script src="/_next/static/chunks/75fc9c18-4a646156c659a948.js" defer=""></script><script src="/_next/static/chunks/348-d11c34b645b13f5b.js" defer=""></script><script src="/_next/static/chunks/162-4172e84c8e2aa747.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-4f7b40c1114f0d09.js" defer=""></script><script src="/_next/static/o1YmnmSuZvAX2O4TI9r41/_buildManifest.js" defer=""></script><script src="/_next/static/o1YmnmSuZvAX2O4TI9r41/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="Header_header__Z8PUO"><div class="Header_inner__tfr0u"><strong class="Header_title__Otn70"><a href="/">UI STATION</a></strong><nav class="Header_nav_area__6KVpk"><a class="nav_item" href="/posts/1">Posts</a></nav></div></header><main class="posts_container__NyRU3"><div class="posts_inner__i3n_i"><h1 class="posts_post_title__EbxNx">Spring Boot로 API 게이트웨이 구현하는 방법</h1><div class="posts_meta__cR7lu"><div class="posts_profile_wrap__mslMl"><div class="posts_profile_image_wrap__kPikV"><img alt="Spring Boot로 API 게이트웨이 구현하는 방법" loading="lazy" width="44" height="44" decoding="async" data-nimg="1" class="profile" style="color:transparent" src="/favicons/apple-icon-114x114.png"/></div><div class="posts_textarea__w_iKT"><span class="writer">UI STATION</span><span class="posts_info__5KJdN"><span class="posts_date__ctqHI">Posted On Jun 22, 2024</span><span class="posts_reading_time__f7YPP">17<!-- --> min read</span></span></div></div><img alt="" loading="lazy" width="50" height="50" decoding="async" data-nimg="1" class="posts_view_badge__tcbfm" style="color:transparent" src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fallround-coder.github.io/post/2024-06-22-APIgatewayinSpringboot&amp;count_bg=%2379C83D&amp;title_bg=%23555555&amp;icon=&amp;icon_color=%23E7E7E7&amp;title=views&amp;edge_flat=false"/></div><article class="posts_post_content__n_L6j"><div><!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
</head>
<body>
<p><img src="/assets/img/2024-06-22-APIgatewayinSpringboot_0.png" alt="API Gateway"></p>
<p>API는 응용 프로그램 간에 일반적인 통신 방식입니다. 마이크로서비스 아키텍처의 경우 여러 서비스가 있으며 클라이언트는 이러한 서비스를 호출하기 위해 모든 하위 응용 프로그램의 호스트 이름을 알아야 합니다.</p>
<p>이 통신을 간소화하기 위해 클라이언트와 서버 사이에 모든 API 요청을 관리하는 컴포넌트인 API 게이트웨이를 선호합니다. 또한 다음과 같은 다른 기능을 가질 수 있습니다:</p>
<ul>
<li>보안 — 인증, 권한 부여</li>
<li>라우팅 — 라우팅, 요청/응답 조작, 회로 차단기</li>
<li>관찰성 — 지표 집계, 로깅, 추적화</li>
</ul>
<p>API 게이트웨이의 아키텍처적 이점:</p>
<ul>
<li>복잡성 감소</li>
<li>정책의 중앙 집중화된 제어</li>
<li>단순화된 문제 해결</li>
</ul>
<p>API 게이트웨이에는 Spring Cloud Gateway, Zuul API Gateway, APIGee, EAG (Enterprise API Gateway)와 같은 다양한 구현 유형이 있습니다.</p>
<p>본 문서에서는 Spring Cloud API 게이트웨이를 구현하는 방법, 들어오는 요청 필터링, 요청/응답 조작, 인증 처리에 대해 살펴볼 것입니다.</p>
<p>아래에서 전체 에코시스템을 시각화할 수 있습니다:</p>
<p><img src="/assets/img/2024-06-22-APIgatewayinSpringboot_1.png" alt="에코시스템 다이어그램"></p>
<p>위 다이어그램에서 총 5개의 서비스가 있습니다.</p>
<ul>
<li>서비스 레지스트리 — 각 프로젝트 내의 각 마이크로서비스 인스턴스의 가용 상태를 추적하는 응용 프로그램입니다.</li>
<li>API 게이트웨이 — 들어오는 요청을 수신하고 인증(활성화되어 있다면)을 수행하고 실제 마이크로서비스로 요청을 전달합니다. 응답을 받으면 소비자에게 반환합니다.</li>
<li>인증 서버 — 인증을 처리하는 응용 프로그램입니다.</li>
<li>첫 번째와 두 번째 마이크로서비스 — 서로 다른 기능을 갖는 두 개의 일반 내부 응용 프로그램입니다.</li>
</ul>
<p>모든 애플리케이션은 시작 시 서비스 레지스트리에 등록됩니다. API 요청을 받으면 다음과 같은 단계가 발생합니다:</p>
<ul>
<li>소비자가 API 게이트웨이를 통해 애플리케이션을 호출합니다.</li>
<li>API 게이트웨이는 수신 URL이 인증이 필요한지 확인합니다. 필요하다면 인증 서버를 호출하여 유효성을 검사합니다.</li>
<li>유효한 토큰이라면 필터를 적용한 후 해당 애플리케이션으로 요청을 전달합니다.</li>
<li>유효하지 않은 토큰일 경우 소비자에게 권한이 없음을 응답합니다.</li>
<li>내부 마이크로서비스에서 응답을 받으면 필터를 적용한 후 해당 소비자에게 반환합니다.</li>
</ul>
<p>게이트웨이에서의 필터는 로깅, 요청/응답 세부 사항 조작/사용자 정의와 같은 작업이 포함될 수 있습니다.</p>
<p>Service registry</p>
<p>유레카 서버로 작동하는 애플리케이션이에요. pom.xml에 다음 종속성이 있어야 해요.</p>
<pre><code class="hljs language-js">&#x3C;dependency>
  <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.cloud<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span></span>
  <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-cloud-starter-netflix-eureka-server<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span></span>
&#x3C;/dependency>
</code></pre>
<p>그리고 메인 클래스에 <code>@EnableEurekaServer</code> 어노테이션이 있어야 해요.</p>
<p>기본적으로 유레카 서버는 자신을 디스커버리에 등록하는데, 이를 비활성화하기 위해 application.properties에 아래 속성을 포함해야 해요.</p>
<pre><code class="hljs language-js">eureka.<span class="hljs-property">client</span>.<span class="hljs-property">registerWithEureka</span> = <span class="hljs-literal">false</span>
eureka.<span class="hljs-property">client</span>.<span class="hljs-property">fetchRegistry</span> = <span class="hljs-literal">false</span>
</code></pre>
<p>다른 애플리케이션을 Eureka 클라이언트로 만들려면 pom.xml에 아래 종속성을 포함하세요:</p>
<pre><code class="hljs language-js">  &#x3C;dependency>
   <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.cloud<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span></span>
   <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span></span>
  &#x3C;/dependency>
</code></pre>
<p>그리고, application.properties 파일에 Eureka 서버 URL을 제공해주세요:</p>
<p>eureka.client.serviceUrl.defaultZone= &#x3C;eureka-서버-가동-호스트-및-포트></p>
<p>API 게이트웨이:</p>
<p>Spring Cloud API 게이트웨이에는 pom.xml에 아래 종속성이 필요합니다.</p>
<pre><code class="hljs language-xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">dependencies</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
   <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.cloud<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
   <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-cloud-starter-gateway<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
  <span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependencies</span>></span>
 <span class="hljs-tag">&#x3C;<span class="hljs-name">dependencyManagement</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">dependencies</span>></span>
   <span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.cloud<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-cloud-dependencies<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">version</span>></span>${spring-cloud.version}<span class="hljs-tag">&#x3C;/<span class="hljs-name">version</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">type</span>></span>pom<span class="hljs-tag">&#x3C;/<span class="hljs-name">type</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">scope</span>></span>import<span class="hljs-tag">&#x3C;/<span class="hljs-name">scope</span>></span>
   <span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;/<span class="hljs-name">dependencies</span>></span>
 <span class="hljs-tag">&#x3C;/<span class="hljs-name">dependencyManagement</span>></span>
</code></pre>
<p>application.yml 파일에서 모든 내부 마이크로서비스 이름, 경로 및 uri 세부 정보를 다음과 같이 제공해주세요:</p>
<pre><code class="hljs language-js"><span class="hljs-attr">spring</span>:
  <span class="hljs-attr">application</span>:
    <span class="hljs-attr">name</span>: gateway-service
  <span class="hljs-attr">cloud</span>:
    <span class="hljs-attr">gateway</span>:
      <span class="hljs-attr">routes</span>:
        - <span class="hljs-attr">id</span>: first
          <span class="hljs-attr">predicates</span>:
            - <span class="hljs-title class_">Path</span>=<span class="hljs-regexp">/first/</span>
          <span class="hljs-attr">uri</span>: <span class="hljs-attr">localhost</span>:<span class="hljs-number">8081</span>
        - <span class="hljs-attr">id</span>: second
          <span class="hljs-attr">predicates</span>:
            - <span class="hljs-title class_">Path</span>=<span class="hljs-regexp">/second/</span>
          <span class="hljs-attr">uri</span>: <span class="hljs-attr">localhost</span>:<span class="hljs-number">8082</span>
        - <span class="hljs-attr">id</span>: auth-server
          <span class="hljs-attr">predicates</span>:
            - <span class="hljs-title class_">Path</span>=<span class="hljs-regexp">/login/</span>
          <span class="hljs-attr">uri</span>: <span class="hljs-attr">localhost</span>:<span class="hljs-number">8088</span>
</code></pre>
<p>그리고 Gateway가 제공하는 모든 라우트를 제공하기 위해 RouteLocator 유형의 빈이 필요합니다. 요청/응답을 처리하려면 필요에 따라 필터를 포함할 수 있습니다:</p>
<pre><code class="hljs language-js">@<span class="hljs-title class_">Bean</span>
public <span class="hljs-title class_">RouteLocator</span> <span class="hljs-title function_">customRouteLocator</span>(<span class="hljs-params">RouteLocatorBuilder builder</span>) {
    <span class="hljs-keyword">return</span> builder.<span class="hljs-title function_">routes</span>()
            .<span class="hljs-title function_">route</span>(<span class="hljs-string">"first-microservice"</span>, r -> r.<span class="hljs-title function_">path</span>(<span class="hljs-string">"/first"</span>)
                    .<span class="hljs-title function_">and</span>().<span class="hljs-title function_">method</span>(<span class="hljs-string">"POST"</span>)
                    .<span class="hljs-title function_">and</span>().<span class="hljs-title function_">readBody</span>(<span class="hljs-title class_">Student</span>.<span class="hljs-property">class</span>, s -> <span class="hljs-literal">true</span>).<span class="hljs-title function_">filters</span>(f -> f.<span class="hljs-title function_">filters</span>(requestFilter, authFilter))
                    .<span class="hljs-title function_">uri</span>(<span class="hljs-string">"http://localhost:8081"</span>))
            .<span class="hljs-title function_">route</span>(<span class="hljs-string">"first-microservice"</span>, r -> r.<span class="hljs-title function_">path</span>(<span class="hljs-string">"/first"</span>)
                    .<span class="hljs-title function_">and</span>().<span class="hljs-title function_">method</span>(<span class="hljs-string">"GET"</span>).<span class="hljs-title function_">filters</span>(f-> f.<span class="hljs-title function_">filters</span>(authFilter))
                    .<span class="hljs-title function_">uri</span>(<span class="hljs-string">"http://localhost:8081"</span>))
            .<span class="hljs-title function_">route</span>(<span class="hljs-string">"second-microservice"</span>, r -> r.<span class="hljs-title function_">path</span>(<span class="hljs-string">"/second"</span>)
                    .<span class="hljs-title function_">and</span>().<span class="hljs-title function_">method</span>(<span class="hljs-string">"POST"</span>)
                    .<span class="hljs-title function_">and</span>().<span class="hljs-title function_">readBody</span>(<span class="hljs-title class_">Company</span>.<span class="hljs-property">class</span>, s -> <span class="hljs-literal">true</span>).<span class="hljs-title function_">filters</span>(f -> f.<span class="hljs-title function_">filters</span>(requestFilter, authFilter))
                    .<span class="hljs-title function_">uri</span>(<span class="hljs-string">"http://localhost:8082"</span>))
            .<span class="hljs-title function_">route</span>(<span class="hljs-string">"second-microservice"</span>, r -> r.<span class="hljs-title function_">path</span>(<span class="hljs-string">"/second"</span>)
                    .<span class="hljs-title function_">and</span>().<span class="hljs-title function_">method</span>(<span class="hljs-string">"GET"</span>).<span class="hljs-title function_">filters</span>(f-> f.<span class="hljs-title function_">filters</span>(authFilter))
                    .<span class="hljs-title function_">uri</span>(<span class="hljs-string">"http://localhost:8082"</span>))
            .<span class="hljs-title function_">route</span>(<span class="hljs-string">"auth-server"</span>, r -> r.<span class="hljs-title function_">path</span>(<span class="hljs-string">"/login"</span>)
                    .<span class="hljs-title function_">uri</span>(<span class="hljs-string">"http://localhost:8088"</span>))
            .<span class="hljs-title function_">build</span>();
}
</code></pre>
<p>필터:</p>
<p>A. 요청 본문을 로깅하려면:</p>
<p>본문을 읽기 위해 ResourceLocator 빈에서 readBody()를 true로 설정해야 합니다. 이렇게 하면 ServerWebExchange 객체가 요청 본문을 "cachedRequestBodyObject" 속성에 캐시합니다.</p>
<pre><code class="hljs language-js">package com.<span class="hljs-property">example</span>.<span class="hljs-property">springcloudgatewayoverview</span>.<span class="hljs-property">filter</span>;

<span class="hljs-keyword">import</span> com.<span class="hljs-property">example</span>.<span class="hljs-property">springcloudgatewayoverview</span>.<span class="hljs-property">model</span>.<span class="hljs-property">Company</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">example</span>.<span class="hljs-property">springcloudgatewayoverview</span>.<span class="hljs-property">model</span>.<span class="hljs-property">Student</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cloud</span>.<span class="hljs-property">gateway</span>.<span class="hljs-property">filter</span>.<span class="hljs-property">GatewayFilter</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cloud</span>.<span class="hljs-property">gateway</span>.<span class="hljs-property">filter</span>.<span class="hljs-property">GatewayFilterChain</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Component</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">server</span>.<span class="hljs-property">ServerWebExchange</span>;
<span class="hljs-keyword">import</span> reactor.<span class="hljs-property">core</span>.<span class="hljs-property">publisher</span>.<span class="hljs-property">Mono</span>;

@<span class="hljs-title class_">Component</span>
public <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestFilter</span> implements <span class="hljs-title class_">GatewayFilter</span> {
    @<span class="hljs-title class_">Override</span>
    public <span class="hljs-title class_">Mono</span>&#x3C;<span class="hljs-title class_">Void</span>> <span class="hljs-title function_">filter</span>(<span class="hljs-params">ServerWebExchange exchange, GatewayFilterChain chain</span>) {
        <span class="hljs-title class_">Object</span> body = exchange.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">"cachedRequestBodyObject"</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"in request filter"</span>);
        <span class="hljs-keyword">if</span>(body <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Student</span>) {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"body:"</span> + (<span class="hljs-title class_">Student</span>) body);
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(body <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Company</span>) {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"body:"</span> + (<span class="hljs-title class_">Company</span>) body);
        }
        <span class="hljs-keyword">return</span> chain.<span class="hljs-title function_">filter</span>(exchange);
    }
}
</code></pre>
<p>B. 응답 본문을 로깅하려면:</p>
<pre><code class="hljs language-js">package com.<span class="hljs-property">example</span>.<span class="hljs-property">springcloudgatewayoverview</span>.<span class="hljs-property">filter</span>;

<span class="hljs-keyword">import</span> com.<span class="hljs-property">example</span>.<span class="hljs-property">springcloudgatewayoverview</span>.<span class="hljs-property">model</span>.<span class="hljs-property">Company</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">example</span>.<span class="hljs-property">springcloudgatewayoverview</span>.<span class="hljs-property">model</span>.<span class="hljs-property">Student</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">fasterxml</span>.<span class="hljs-property">jackson</span>.<span class="hljs-property">core</span>.<span class="hljs-property">JsonProcessingException</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">fasterxml</span>.<span class="hljs-property">jackson</span>.<span class="hljs-property">databind</span>.<span class="hljs-property">ObjectMapper</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">reactivestreams</span>.<span class="hljs-property">Publisher</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">core</span>.<span class="hljs-property">io</span>.<span class="hljs-property">buffer</span>.<span class="hljs-property">DataBuffer</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">core</span>.<span class="hljs-property">io</span>.<span class="hljs-property">buffer</span>.<span class="hljs-property">DataBufferFactory</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">core</span>.<span class="hljs-property">io</span>.<span class="hljs-property">buffer</span>.<span class="hljs-property">DefaultDataBuffer</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">core</span>.<span class="hljs-property">io</span>.<span class="hljs-property">buffer</span>.<span class="hljs-property">DefaultDataBufferFactory</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">http</span>.<span class="hljs-property">server</span>.<span class="hljs-property">reactive</span>.<span class="hljs-property">ServerHttpRequest</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">http</span>.<span class="hljs-property">server</span>.<span class="hljs-property">reactive</span>.<span class="hljs-property">ServerHttpResponse</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">http</span>.<span class="hljs-property">server</span>.<span class="hljs-property">reactive</span>.<span class="hljs-property">ServerHttpResponseDecorator</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">server</span>.<span class="hljs-property">ServerWebExchange</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">server</span>.<span class="hljs-property">WebFilter</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">server</span>.<span class="hljs-property">WebFilterChain</span>;
<span class="hljs-keyword">import</span> reactor.<span class="hljs-property">core</span>.<span class="hljs-property">publisher</span>.<span class="hljs-property">Flux</span>;
<span class="hljs-keyword">import</span> reactor.<span class="hljs-property">core</span>.<span class="hljs-property">publisher</span>.<span class="hljs-property">Mono</span>;

<span class="hljs-keyword">import</span> java.<span class="hljs-property">nio</span>.<span class="hljs-property">charset</span>.<span class="hljs-property">StandardCharsets</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">List</span>;

public <span class="hljs-keyword">class</span> <span class="hljs-title class_">PostGlobalFilter</span> implements <span class="hljs-title class_">WebFilter</span> {

    @<span class="hljs-title class_">Override</span>
    public <span class="hljs-title class_">Mono</span>&#x3C;<span class="hljs-title class_">Void</span>> <span class="hljs-title function_">filter</span>(<span class="hljs-params">ServerWebExchange exchange, WebFilterChain chain</span>) {
        <span class="hljs-title class_">String</span> path = exchange.<span class="hljs-title function_">getRequest</span>().<span class="hljs-title function_">getPath</span>().<span class="hljs-title function_">toString</span>();
        <span class="hljs-title class_">ServerHttpResponse</span> response = exchange.<span class="hljs-title function_">getResponse</span>();
        <span class="hljs-title class_">ServerHttpRequest</span> request = exchange.<span class="hljs-title function_">getRequest</span>();
        <span class="hljs-title class_">DataBufferFactory</span> dataBufferFactory = response.<span class="hljs-title function_">bufferFactory</span>();
        <span class="hljs-title class_">ServerHttpResponseDecorator</span> decoratedResponse = <span class="hljs-title function_">getDecoratedResponse</span>(path, response, request, dataBufferFactory);
        <span class="hljs-keyword">return</span> chain.<span class="hljs-title function_">filter</span>(exchange.<span class="hljs-title function_">mutate</span>().<span class="hljs-title function_">response</span>(decoratedResponse).<span class="hljs-title function_">build</span>());
    }

    private <span class="hljs-title class_">ServerHttpResponseDecorator</span> <span class="hljs-title function_">getDecoratedResponse</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> path, ServerHttpResponse response, ServerHttpRequest request, DataBufferFactory dataBufferFactory</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerHttpResponseDecorator</span>(response) {

            @<span class="hljs-title class_">Override</span>
            public <span class="hljs-title class_">Mono</span>&#x3C;<span class="hljs-title class_">Void</span>> <span class="hljs-title function_">writeWith</span>(<span class="hljs-params">final Publisher&#x3C;? <span class="hljs-keyword">extends</span> DataBuffer> body</span>) {

                <span class="hljs-keyword">if</span> (body <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Flux</span>) {

                    <span class="hljs-title class_">Flux</span>&#x3C;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DataBuffer</span>> fluxBody = (<span class="hljs-title class_">Flux</span>&#x3C;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DataBuffer</span>>) body;

                    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">writeWith</span>(fluxBody.<span class="hljs-title function_">buffer</span>().<span class="hljs-title function_">map</span>(dataBuffers -> {

                        <span class="hljs-title class_">DefaultDataBuffer</span> joinedBuffers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultDataBufferFactory</span>().<span class="hljs-title function_">join</span>(dataBuffers);
                        byte[] content = <span class="hljs-keyword">new</span> byte[joinedBuffers.<span class="hljs-title function_">readableByteCount</span>()];
                        joinedBuffers.<span class="hljs-title function_">read</span>(content);
                        <span class="hljs-title class_">String</span> responseBody = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(content, <span class="hljs-title class_">StandardCharsets</span>.<span class="hljs-property">UTF_8</span>);<span class="hljs-comment">//응답 수정 및 수정된 응답 반환</span>
                        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"requestId: "</span>+request.<span class="hljs-title function_">getId</span>()+<span class="hljs-string">", method: "</span>+request.<span class="hljs-title function_">getMethodValue</span>()+<span class="hljs-string">", req url: "</span>+request.<span class="hljs-title function_">getURI</span>()+<span class="hljs-string">", response body :"</span>+ responseBody);
                        <span class="hljs-keyword">try</span> {
                            <span class="hljs-keyword">if</span>(request.<span class="hljs-title function_">getURI</span>().<span class="hljs-title function_">getPath</span>().<span class="hljs-title function_">equals</span>(<span class="hljs-string">"/first"</span>) &#x26;&#x26; request.<span class="hljs-title function_">getMethodValue</span>().<span class="hljs-title function_">equals</span>(<span class="hljs-string">"GET"</span>)) {
                                <span class="hljs-title class_">List</span>&#x3C;<span class="hljs-title class_">Student</span>> student = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().<span class="hljs-title function_">readValue</span>(responseBody, <span class="hljs-title class_">List</span>.<span class="hljs-property">class</span>);
                                <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"student:"</span> + student);
                            }
                            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(request.<span class="hljs-title function_">getURI</span>().<span class="hljs-title function_">getPath</span>().<span class="hljs-title function_">equals</span>(<span class="hljs-string">"/second"</span>) &#x26;&#x26; request.<span class="hljs-title function_">getMethodValue</span>().<span class="hljs-title function_">equals</span>(<span class="hljs-string">"GET"</span>)) {
                                <span class="hljs-title class_">List</span>&#x3C;<span class="hljs-title class_">Company</span>> companies = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().<span class="hljs-title function_">readValue</span>(responseBody, <span class="hljs-title class_">List</span>.<span class="hljs-property">class</span>);
                                <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"companies:"</span> + companies);
                            }
                        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">JsonProcessingException</span> e) {
                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
                        }
                        <span class="hljs-keyword">return</span> dataBufferFactory.<span class="hljs-title function_">wrap</span>(responseBody.<span class="hljs-title function_">getBytes</span>());
                    })).<span class="hljs-title function_">onErrorResume</span>(err -> {

                        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"error while decorating Response: {}"</span>+err.<span class="hljs-title function_">getMessage</span>());
                        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Mono</span>.<span class="hljs-title function_">empty</span>();
                    });

                }
                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">writeWith</span>(body);
            }
        };
    }

}
</code></pre>
<p>C. API 호출 전에 인증하기:</p>
<p>다음과 같이 인증 필터를 생성하십시오:</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">package</span> com.example.springcloudgatewayoverview.filter;

<span class="hljs-keyword">import</span> com.example.springcloudgatewayoverview.util.AuthUtil;
<span class="hljs-keyword">import</span> com.example.springcloudgatewayoverview.util.JWTUtil;
<span class="hljs-keyword">import</span> com.example.springcloudgatewayoverview.validator.RouteValidator;
<span class="hljs-keyword">import</span> io.jsonwebtoken.Claims;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.cloud.context.config.annotation.RefreshScope;
<span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilter;
<span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;
<span class="hljs-keyword">import</span> org.springframework.http.HttpStatus;
<span class="hljs-keyword">import</span> org.springframework.http.server.reactive.ServerHttpRequest;
<span class="hljs-keyword">import</span> org.springframework.http.server.reactive.ServerHttpResponse;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-keyword">import</span> org.springframework.web.server.ServerWebExchange;
<span class="hljs-keyword">import</span> reactor.core.publisher.Mono;

<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RefreshScope</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GatewayFilter</span> {

    <span class="hljs-meta">@Autowired</span>
    RouteValidator routeValidator;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> JWTUtil jwtUtil;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AuthUtil authUtil;

    <span class="hljs-meta">@Value("${authentication.enabled}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> authEnabled;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Mono&#x3C;Void> <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {
        <span class="hljs-keyword">if</span>(!authEnabled) {
            System.out.println(<span class="hljs-string">"Authentication is disabled. To enable it, make \"authentication.enabled\" property as true"</span>);
            <span class="hljs-keyword">return</span> chain.filter(exchange);
        }
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span><span class="hljs-string">""</span>;
        <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> exchange.getRequest();

        <span class="hljs-keyword">if</span>(routeValidator.isSecured.test(request)) {
            System.out.println(<span class="hljs-string">"validating authentication token"</span>);
            <span class="hljs-keyword">if</span>(<span class="hljs-built_in">this</span>.isCredsMissing(request)) {
                System.out.println(<span class="hljs-string">"in error"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.onError(exchange,<span class="hljs-string">"Credentials missing"</span>,HttpStatus.UNAUTHORIZED);
            }
            <span class="hljs-keyword">if</span> (request.getHeaders().containsKey(<span class="hljs-string">"userName"</span>) &#x26;&#x26; request.getHeaders().containsKey(<span class="hljs-string">"role"</span>)) {
                token = authUtil.getToken(request.getHeaders().get(<span class="hljs-string">"userName"</span>).toString(), request.getHeaders().get(<span class="hljs-string">"role"</span>).toString());
            }
            <span class="hljs-keyword">else</span> {
                token = request.getHeaders().get(<span class="hljs-string">"Authorization"</span>).toString().split(<span class="hljs-string">" "</span>)[<span class="hljs-number">1</span>];
            }

            <span class="hljs-keyword">if</span>(jwtUtil.isInvalid(token)) {
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.onError(exchange,<span class="hljs-string">"Auth header invalid"</span>,HttpStatus.UNAUTHORIZED);
            }
            <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"Authentication is successful"</span>);
            }

            <span class="hljs-built_in">this</span>.populateRequestWithHeaders(exchange,token);
        }
        <span class="hljs-keyword">return</span> chain.filter(exchange);
    }

    <span class="hljs-keyword">private</span> Mono&#x3C;Void> <span class="hljs-title function_">onError</span><span class="hljs-params">(ServerWebExchange exchange, String err, HttpStatus httpStatus)</span> {
        <span class="hljs-type">ServerHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> exchange.getResponse();
        response.setStatusCode(httpStatus);
        <span class="hljs-keyword">return</span> response.setComplete();
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getAuthHeader</span><span class="hljs-params">(ServerHttpRequest request)</span> {
        <span class="hljs-keyword">return</span>  request.getHeaders().getOrEmpty(<span class="hljs-string">"Authorization"</span>).get(<span class="hljs-number">0</span>);
    }


    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredsMissing</span><span class="hljs-params">(ServerHttpRequest request)</span> {
        <span class="hljs-keyword">return</span> !(request.getHeaders().containsKey(<span class="hljs-string">"userName"</span>) &#x26;&#x26; request.getHeaders().containsKey(<span class="hljs-string">"role"</span>)) &#x26;&#x26; !request.getHeaders().containsKey(<span class="hljs-string">"Authorization"</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">populateRequestWithHeaders</span><span class="hljs-params">(ServerWebExchange exchange, String token)</span> {
        <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> jwtUtil.getALlClaims(token);
        exchange.getRequest()
                .mutate()
                .header(<span class="hljs-string">"id"</span>,String.valueOf(claims.get(<span class="hljs-string">"id"</span>)))
                .header(<span class="hljs-string">"role"</span>, String.valueOf(claims.get(<span class="hljs-string">"role"</span>)))
                .build();
    }
}
</code></pre>
<p>Endpoints 중 일부는 토큰 없이 호출을 허용해야 합니다. (예: 로그인 URL, 헬스 체크 URL 등). 이러한 엔드포인트들을 아래 목록에 추가할 것입니다:</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">package</span> com.example.springcloudgatewayoverview.validator;

<span class="hljs-keyword">import</span> org.springframework.http.server.reactive.ServerHttpRequest;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.function.Predicate;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RouteValidator</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> List&#x3C;String> unprotectedURLs = List.of(<span class="hljs-string">"/login"</span>);

    <span class="hljs-keyword">public</span> Predicate&#x3C;ServerHttpRequest> isSecured = request -> unprotectedURLs.stream().noneMatch(uri -> request.getURI().getPath().contains(uri));
}
</code></pre>
<p>JWTUtil:</p>
<pre><code class="hljs language-java"></code></pre>
<pre><code class="hljs language-java"><span class="hljs-keyword">package</span> com.example.springcloudgatewayoverview.util;

<span class="hljs-keyword">import</span> io.jsonwebtoken.Claims;
<span class="hljs-keyword">import</span> io.jsonwebtoken.Jwts;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JWTUtil</span> {

    <span class="hljs-meta">@Value("${jwt.secret}")</span>
    <span class="hljs-keyword">private</span> String secret;

    <span class="hljs-keyword">public</span> Claims <span class="hljs-title function_">getAllClaims</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-keyword">return</span> Jwts.parserBuilder().setSigningKey(secret).build().parseClaimsJws(token).getBody();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTokenExpired</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getAllClaims(token).getExpiration().before(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isInvalid</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.isTokenExpired(token);
    }

}
</code></pre>
<p>Authentication server:</p>
<p>이 서비스는 내부 마이크로서비스에 액세스하기 위한 토큰을 제공합니다.</p>
<p>실행:</p>
<p>Once all applications are running, you can access the service registry by entering <a href="http://localhost:8761" rel="nofollow" target="_blank">http://localhost:8761</a> in your browser. Here, you can find information about all the currently running services:</p>
<p><img src="/assets/img/2024-06-22-APIgatewayinSpringboot_2.png" alt="Service Registry"></p>
<p>The API Gateway is running on localhost at port 8080. You can access the endpoints of the First or Second microservice from <a href="http://localhost:8080" rel="nofollow" target="_blank">http://localhost:8080</a>.</p>
<p><img src="/assets/img/2024-06-22-APIgatewayinSpringboot_3.png" alt="API Gateway Endpoints"></p>
<p>APIGateway 콘솔의 요청/응답 로그:</p>
<p><img src="/assets/img/2024-06-22-APIgatewayinSpringboot_4.png" alt="2024-06-22-APIgatewayinSpringboot_4"></p>
<p>인증이 포함된 샘플 요청:</p>
<p><img src="/assets/img/2024-06-22-APIgatewayinSpringboot_5.png" alt="2024-06-22-APIgatewayinSpringboot_5"></p>
<p>서비스의 모든 코드 기반은 여기에서 사용 가능합니다.</p>
<p>읽어 주셔서 감사합니다. 즐거운 탐험하세요!!!</p>
</body>
</html>
</div></article></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Spring Boot로 API 게이트웨이 구현하는 방법","description":"","date":"2024-06-22 22:18","slug":"2024-06-22-APIgatewayinSpringboot","content":"\n\n![API Gateway](/assets/img/2024-06-22-APIgatewayinSpringboot_0.png)\n\nAPI는 응용 프로그램 간에 일반적인 통신 방식입니다. 마이크로서비스 아키텍처의 경우 여러 서비스가 있으며 클라이언트는 이러한 서비스를 호출하기 위해 모든 하위 응용 프로그램의 호스트 이름을 알아야 합니다.\n\n이 통신을 간소화하기 위해 클라이언트와 서버 사이에 모든 API 요청을 관리하는 컴포넌트인 API 게이트웨이를 선호합니다. 또한 다음과 같은 다른 기능을 가질 수 있습니다:\n\n- 보안 — 인증, 권한 부여\r\n- 라우팅 — 라우팅, 요청/응답 조작, 회로 차단기\r\n- 관찰성 — 지표 집계, 로깅, 추적화\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\nAPI 게이트웨이의 아키텍처적 이점:\n\n- 복잡성 감소\n- 정책의 중앙 집중화된 제어\n- 단순화된 문제 해결\n\nAPI 게이트웨이에는 Spring Cloud Gateway, Zuul API Gateway, APIGee, EAG (Enterprise API Gateway)와 같은 다양한 구현 유형이 있습니다.\n\n본 문서에서는 Spring Cloud API 게이트웨이를 구현하는 방법, 들어오는 요청 필터링, 요청/응답 조작, 인증 처리에 대해 살펴볼 것입니다.\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n아래에서 전체 에코시스템을 시각화할 수 있습니다:\n\n![에코시스템 다이어그램](/assets/img/2024-06-22-APIgatewayinSpringboot_1.png)\n\n위 다이어그램에서 총 5개의 서비스가 있습니다.\n\n- 서비스 레지스트리 — 각 프로젝트 내의 각 마이크로서비스 인스턴스의 가용 상태를 추적하는 응용 프로그램입니다.\n- API 게이트웨이 — 들어오는 요청을 수신하고 인증(활성화되어 있다면)을 수행하고 실제 마이크로서비스로 요청을 전달합니다. 응답을 받으면 소비자에게 반환합니다.\n- 인증 서버 — 인증을 처리하는 응용 프로그램입니다.\n- 첫 번째와 두 번째 마이크로서비스 — 서로 다른 기능을 갖는 두 개의 일반 내부 응용 프로그램입니다.\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n모든 애플리케이션은 시작 시 서비스 레지스트리에 등록됩니다. API 요청을 받으면 다음과 같은 단계가 발생합니다:\n\n- 소비자가 API 게이트웨이를 통해 애플리케이션을 호출합니다.\n- API 게이트웨이는 수신 URL이 인증이 필요한지 확인합니다. 필요하다면 인증 서버를 호출하여 유효성을 검사합니다.\n- 유효한 토큰이라면 필터를 적용한 후 해당 애플리케이션으로 요청을 전달합니다.\n- 유효하지 않은 토큰일 경우 소비자에게 권한이 없음을 응답합니다.\n- 내부 마이크로서비스에서 응답을 받으면 필터를 적용한 후 해당 소비자에게 반환합니다.\n\n게이트웨이에서의 필터는 로깅, 요청/응답 세부 사항 조작/사용자 정의와 같은 작업이 포함될 수 있습니다.\n\nService registry\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n유레카 서버로 작동하는 애플리케이션이에요. pom.xml에 다음 종속성이 있어야 해요.\n\n```js\n\u003cdependency\u003e\n  \u003cgroupId\u003eorg.springframework.cloud\u003c/groupId\u003e\n  \u003cartifactId\u003espring-cloud-starter-netflix-eureka-server\u003c/artifactId\u003e\n\u003c/dependency\u003e\n```\n\n그리고 메인 클래스에 `@EnableEurekaServer` 어노테이션이 있어야 해요.\n\n기본적으로 유레카 서버는 자신을 디스커버리에 등록하는데, 이를 비활성화하기 위해 application.properties에 아래 속성을 포함해야 해요.\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n```js\neureka.client.registerWithEureka = false\neureka.client.fetchRegistry = false\n```\n\n다른 애플리케이션을 Eureka 클라이언트로 만들려면 pom.xml에 아래 종속성을 포함하세요:\n\n```js\n  \u003cdependency\u003e\n   \u003cgroupId\u003eorg.springframework.cloud\u003c/groupId\u003e\n   \u003cartifactId\u003espring-cloud-starter-netflix-eureka-client\u003c/artifactId\u003e\n  \u003c/dependency\u003e\n```\n\n그리고, application.properties 파일에 Eureka 서버 URL을 제공해주세요:\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n\neureka.client.serviceUrl.defaultZone= \u003ceureka-서버-가동-호스트-및-포트\u003e\n\nAPI 게이트웨이:\n\nSpring Cloud API 게이트웨이에는 pom.xml에 아래 종속성이 필요합니다.\n\n```xml\n\u003cdependencies\u003e\n  \u003cdependency\u003e\n   \u003cgroupId\u003eorg.springframework.cloud\u003c/groupId\u003e\n   \u003cartifactId\u003espring-cloud-starter-gateway\u003c/artifactId\u003e\n  \u003c/dependency\u003e\n\u003c/dependencies\u003e\n \u003cdependencyManagement\u003e\n  \u003cdependencies\u003e\n   \u003cdependency\u003e\n    \u003cgroupId\u003eorg.springframework.cloud\u003c/groupId\u003e\n    \u003cartifactId\u003espring-cloud-dependencies\u003c/artifactId\u003e\n    \u003cversion\u003e${spring-cloud.version}\u003c/version\u003e\n    \u003ctype\u003epom\u003c/type\u003e\n    \u003cscope\u003eimport\u003c/scope\u003e\n   \u003c/dependency\u003e\n  \u003c/dependencies\u003e\n \u003c/dependencyManagement\u003e\n```\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\napplication.yml 파일에서 모든 내부 마이크로서비스 이름, 경로 및 uri 세부 정보를 다음과 같이 제공해주세요:\n\n```js\nspring:\n  application:\n    name: gateway-service\n  cloud:\n    gateway:\n      routes:\n        - id: first\n          predicates:\n            - Path=/first/\n          uri: localhost:8081\n        - id: second\n          predicates:\n            - Path=/second/\n          uri: localhost:8082\n        - id: auth-server\n          predicates:\n            - Path=/login/\n          uri: localhost:8088\n```\n\n그리고 Gateway가 제공하는 모든 라우트를 제공하기 위해 RouteLocator 유형의 빈이 필요합니다. 요청/응답을 처리하려면 필요에 따라 필터를 포함할 수 있습니다:\n\n```js\n@Bean\npublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) {\n    return builder.routes()\n            .route(\"first-microservice\", r -\u003e r.path(\"/first\")\n                    .and().method(\"POST\")\n                    .and().readBody(Student.class, s -\u003e true).filters(f -\u003e f.filters(requestFilter, authFilter))\n                    .uri(\"http://localhost:8081\"))\n            .route(\"first-microservice\", r -\u003e r.path(\"/first\")\n                    .and().method(\"GET\").filters(f-\u003e f.filters(authFilter))\n                    .uri(\"http://localhost:8081\"))\n            .route(\"second-microservice\", r -\u003e r.path(\"/second\")\n                    .and().method(\"POST\")\n                    .and().readBody(Company.class, s -\u003e true).filters(f -\u003e f.filters(requestFilter, authFilter))\n                    .uri(\"http://localhost:8082\"))\n            .route(\"second-microservice\", r -\u003e r.path(\"/second\")\n                    .and().method(\"GET\").filters(f-\u003e f.filters(authFilter))\n                    .uri(\"http://localhost:8082\"))\n            .route(\"auth-server\", r -\u003e r.path(\"/login\")\n                    .uri(\"http://localhost:8088\"))\n            .build();\n}\n```\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n필터:\n\nA. 요청 본문을 로깅하려면:\n\n본문을 읽기 위해 ResourceLocator 빈에서 readBody()를 true로 설정해야 합니다. 이렇게 하면 ServerWebExchange 객체가 요청 본문을 \"cachedRequestBodyObject\" 속성에 캐시합니다.\n\n```js\npackage com.example.springcloudgatewayoverview.filter;\n\nimport com.example.springcloudgatewayoverview.model.Company;\nimport com.example.springcloudgatewayoverview.model.Student;\nimport org.springframework.cloud.gateway.filter.GatewayFilter;\nimport org.springframework.cloud.gateway.filter.GatewayFilterChain;\nimport org.springframework.stereotype.Component;\nimport org.springframework.web.server.ServerWebExchange;\nimport reactor.core.publisher.Mono;\n\n@Component\npublic class RequestFilter implements GatewayFilter {\n    @Override\n    public Mono\u003cVoid\u003e filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n        Object body = exchange.getAttribute(\"cachedRequestBodyObject\");\n        System.out.println(\"in request filter\");\n        if(body instanceof Student) {\n            System.out.println(\"body:\" + (Student) body);\n        }\n        else if(body instanceof Company) {\n            System.out.println(\"body:\" + (Company) body);\n        }\n        return chain.filter(exchange);\n    }\n}\n```\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\nB. 응답 본문을 로깅하려면:\n\n```js\npackage com.example.springcloudgatewayoverview.filter;\n\nimport com.example.springcloudgatewayoverview.model.Company;\nimport com.example.springcloudgatewayoverview.model.Student;\nimport com.fasterxml.jackson.core.JsonProcessingException;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport org.reactivestreams.Publisher;\nimport org.springframework.core.io.buffer.DataBuffer;\nimport org.springframework.core.io.buffer.DataBufferFactory;\nimport org.springframework.core.io.buffer.DefaultDataBuffer;\nimport org.springframework.core.io.buffer.DefaultDataBufferFactory;\nimport org.springframework.http.server.reactive.ServerHttpRequest;\nimport org.springframework.http.server.reactive.ServerHttpResponse;\nimport org.springframework.http.server.reactive.ServerHttpResponseDecorator;\nimport org.springframework.web.server.ServerWebExchange;\nimport org.springframework.web.server.WebFilter;\nimport org.springframework.web.server.WebFilterChain;\nimport reactor.core.publisher.Flux;\nimport reactor.core.publisher.Mono;\n\nimport java.nio.charset.StandardCharsets;\nimport java.util.List;\n\npublic class PostGlobalFilter implements WebFilter {\n\n    @Override\n    public Mono\u003cVoid\u003e filter(ServerWebExchange exchange, WebFilterChain chain) {\n        String path = exchange.getRequest().getPath().toString();\n        ServerHttpResponse response = exchange.getResponse();\n        ServerHttpRequest request = exchange.getRequest();\n        DataBufferFactory dataBufferFactory = response.bufferFactory();\n        ServerHttpResponseDecorator decoratedResponse = getDecoratedResponse(path, response, request, dataBufferFactory);\n        return chain.filter(exchange.mutate().response(decoratedResponse).build());\n    }\n\n    private ServerHttpResponseDecorator getDecoratedResponse(String path, ServerHttpResponse response, ServerHttpRequest request, DataBufferFactory dataBufferFactory) {\n        return new ServerHttpResponseDecorator(response) {\n\n            @Override\n            public Mono\u003cVoid\u003e writeWith(final Publisher\u003c? extends DataBuffer\u003e body) {\n\n                if (body instanceof Flux) {\n\n                    Flux\u003c? extends DataBuffer\u003e fluxBody = (Flux\u003c? extends DataBuffer\u003e) body;\n\n                    return super.writeWith(fluxBody.buffer().map(dataBuffers -\u003e {\n\n                        DefaultDataBuffer joinedBuffers = new DefaultDataBufferFactory().join(dataBuffers);\n                        byte[] content = new byte[joinedBuffers.readableByteCount()];\n                        joinedBuffers.read(content);\n                        String responseBody = new String(content, StandardCharsets.UTF_8);//응답 수정 및 수정된 응답 반환\n                        System.out.println(\"requestId: \"+request.getId()+\", method: \"+request.getMethodValue()+\", req url: \"+request.getURI()+\", response body :\"+ responseBody);\n                        try {\n                            if(request.getURI().getPath().equals(\"/first\") \u0026\u0026 request.getMethodValue().equals(\"GET\")) {\n                                List\u003cStudent\u003e student = new ObjectMapper().readValue(responseBody, List.class);\n                                System.out.println(\"student:\" + student);\n                            }\n                            else if(request.getURI().getPath().equals(\"/second\") \u0026\u0026 request.getMethodValue().equals(\"GET\")) {\n                                List\u003cCompany\u003e companies = new ObjectMapper().readValue(responseBody, List.class);\n                                System.out.println(\"companies:\" + companies);\n                            }\n                        } catch (JsonProcessingException e) {\n                            throw new RuntimeException(e);\n                        }\n                        return dataBufferFactory.wrap(responseBody.getBytes());\n                    })).onErrorResume(err -\u003e {\n\n                        System.out.println(\"error while decorating Response: {}\"+err.getMessage());\n                        return Mono.empty();\n                    });\n\n                }\n                return super.writeWith(body);\n            }\n        };\n    }\n\n}\n```\n\nC. API 호출 전에 인증하기:\n\n다음과 같이 인증 필터를 생성하십시오:\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n```java\npackage com.example.springcloudgatewayoverview.filter;\n\nimport com.example.springcloudgatewayoverview.util.AuthUtil;\nimport com.example.springcloudgatewayoverview.util.JWTUtil;\nimport com.example.springcloudgatewayoverview.validator.RouteValidator;\nimport io.jsonwebtoken.Claims;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.cloud.context.config.annotation.RefreshScope;\nimport org.springframework.cloud.gateway.filter.GatewayFilter;\nimport org.springframework.cloud.gateway.filter.GatewayFilterChain;\nimport org.springframework.http.HttpStatus;\nimport org.springframework.http.server.reactive.ServerHttpRequest;\nimport org.springframework.http.server.reactive.ServerHttpResponse;\nimport org.springframework.stereotype.Component;\nimport org.springframework.web.server.ServerWebExchange;\nimport reactor.core.publisher.Mono;\n\n@Component\n@RefreshScope\npublic class AuthFilter implements GatewayFilter {\n\n    @Autowired\n    RouteValidator routeValidator;\n\n    @Autowired\n    private JWTUtil jwtUtil;\n\n    @Autowired\n    private AuthUtil authUtil;\n\n    @Value(\"${authentication.enabled}\")\n    private boolean authEnabled;\n\n    @Override\n    public Mono\u003cVoid\u003e filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n        if(!authEnabled) {\n            System.out.println(\"Authentication is disabled. To enable it, make \\\"authentication.enabled\\\" property as true\");\n            return chain.filter(exchange);\n        }\n        String token =\"\";\n        ServerHttpRequest request = exchange.getRequest();\n\n        if(routeValidator.isSecured.test(request)) {\n            System.out.println(\"validating authentication token\");\n            if(this.isCredsMissing(request)) {\n                System.out.println(\"in error\");\n                return this.onError(exchange,\"Credentials missing\",HttpStatus.UNAUTHORIZED);\n            }\n            if (request.getHeaders().containsKey(\"userName\") \u0026\u0026 request.getHeaders().containsKey(\"role\")) {\n                token = authUtil.getToken(request.getHeaders().get(\"userName\").toString(), request.getHeaders().get(\"role\").toString());\n            }\n            else {\n                token = request.getHeaders().get(\"Authorization\").toString().split(\" \")[1];\n            }\n\n            if(jwtUtil.isInvalid(token)) {\n                return this.onError(exchange,\"Auth header invalid\",HttpStatus.UNAUTHORIZED);\n            }\n            else {\n                System.out.println(\"Authentication is successful\");\n            }\n\n            this.populateRequestWithHeaders(exchange,token);\n        }\n        return chain.filter(exchange);\n    }\n\n    private Mono\u003cVoid\u003e onError(ServerWebExchange exchange, String err, HttpStatus httpStatus) {\n        ServerHttpResponse response = exchange.getResponse();\n        response.setStatusCode(httpStatus);\n        return response.setComplete();\n    }\n\n    private String getAuthHeader(ServerHttpRequest request) {\n        return  request.getHeaders().getOrEmpty(\"Authorization\").get(0);\n    }\n\n\n    private boolean isCredsMissing(ServerHttpRequest request) {\n        return !(request.getHeaders().containsKey(\"userName\") \u0026\u0026 request.getHeaders().containsKey(\"role\")) \u0026\u0026 !request.getHeaders().containsKey(\"Authorization\");\n    }\n\n    private void populateRequestWithHeaders(ServerWebExchange exchange, String token) {\n        Claims claims = jwtUtil.getALlClaims(token);\n        exchange.getRequest()\n                .mutate()\n                .header(\"id\",String.valueOf(claims.get(\"id\")))\n                .header(\"role\", String.valueOf(claims.get(\"role\")))\n                .build();\n    }\n}\n```\n\nEndpoints 중 일부는 토큰 없이 호출을 허용해야 합니다. (예: 로그인 URL, 헬스 체크 URL 등). 이러한 엔드포인트들을 아래 목록에 추가할 것입니다:\n\n```java\npackage com.example.springcloudgatewayoverview.validator;\n\nimport org.springframework.http.server.reactive.ServerHttpRequest;\nimport org.springframework.stereotype.Component;\n\nimport java.util.List;\nimport java.util.function.Predicate;\n\n@Component\npublic class RouteValidator {\n    public static final List\u003cString\u003e unprotectedURLs = List.of(\"/login\");\n\n    public Predicate\u003cServerHttpRequest\u003e isSecured = request -\u003e unprotectedURLs.stream().noneMatch(uri -\u003e request.getURI().getPath().contains(uri));\n}\n```\n\nJWTUtil:\n```java\n```\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n```java\npackage com.example.springcloudgatewayoverview.util;\n\nimport io.jsonwebtoken.Claims;\nimport io.jsonwebtoken.Jwts;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.stereotype.Component;\n\nimport java.util.Date;\n\n@Component\npublic class JWTUtil {\n\n    @Value(\"${jwt.secret}\")\n    private String secret;\n\n    public Claims getAllClaims(String token) {\n        return Jwts.parserBuilder().setSigningKey(secret).build().parseClaimsJws(token).getBody();\n    }\n\n    private boolean isTokenExpired(String token) {\n        return this.getAllClaims(token).getExpiration().before(new Date());\n    }\n\n    public boolean isInvalid(String token) {\n        return this.isTokenExpired(token);\n    }\n\n}\n```\n\nAuthentication server:\n\n이 서비스는 내부 마이크로서비스에 액세스하기 위한 토큰을 제공합니다.\n\n실행:\n\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\nOnce all applications are running, you can access the service registry by entering http://localhost:8761 in your browser. Here, you can find information about all the currently running services:\n\n![Service Registry](/assets/img/2024-06-22-APIgatewayinSpringboot_2.png)\n\nThe API Gateway is running on localhost at port 8080. You can access the endpoints of the First or Second microservice from http://localhost:8080.\n\n![API Gateway Endpoints](/assets/img/2024-06-22-APIgatewayinSpringboot_3.png)\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\nAPIGateway 콘솔의 요청/응답 로그:\n\n![2024-06-22-APIgatewayinSpringboot_4](/assets/img/2024-06-22-APIgatewayinSpringboot_4.png)\n\n인증이 포함된 샘플 요청:\n\n![2024-06-22-APIgatewayinSpringboot_5](/assets/img/2024-06-22-APIgatewayinSpringboot_5.png)\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n서비스의 모든 코드 기반은 여기에서 사용 가능합니다.\n\n읽어 주셔서 감사합니다. 즐거운 탐험하세요!!!","ogImage":{"url":"/assets/img/2024-06-22-APIgatewayinSpringboot_0.png"},"coverImage":"/assets/img/2024-06-22-APIgatewayinSpringboot_0.png","tag":["Tech"],"readingTime":17},"content":"\u003c!doctype html\u003e\n\u003chtml lang=\"en\"\u003e\n\u003chead\u003e\n\u003cmeta charset=\"utf-8\"\u003e\n\u003cmeta content=\"width=device-width, initial-scale=1\" name=\"viewport\"\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-22-APIgatewayinSpringboot_0.png\" alt=\"API Gateway\"\u003e\u003c/p\u003e\n\u003cp\u003eAPI는 응용 프로그램 간에 일반적인 통신 방식입니다. 마이크로서비스 아키텍처의 경우 여러 서비스가 있으며 클라이언트는 이러한 서비스를 호출하기 위해 모든 하위 응용 프로그램의 호스트 이름을 알아야 합니다.\u003c/p\u003e\n\u003cp\u003e이 통신을 간소화하기 위해 클라이언트와 서버 사이에 모든 API 요청을 관리하는 컴포넌트인 API 게이트웨이를 선호합니다. 또한 다음과 같은 다른 기능을 가질 수 있습니다:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e보안 — 인증, 권한 부여\u003c/li\u003e\n\u003cli\u003e라우팅 — 라우팅, 요청/응답 조작, 회로 차단기\u003c/li\u003e\n\u003cli\u003e관찰성 — 지표 집계, 로깅, 추적화\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAPI 게이트웨이의 아키텍처적 이점:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e복잡성 감소\u003c/li\u003e\n\u003cli\u003e정책의 중앙 집중화된 제어\u003c/li\u003e\n\u003cli\u003e단순화된 문제 해결\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAPI 게이트웨이에는 Spring Cloud Gateway, Zuul API Gateway, APIGee, EAG (Enterprise API Gateway)와 같은 다양한 구현 유형이 있습니다.\u003c/p\u003e\n\u003cp\u003e본 문서에서는 Spring Cloud API 게이트웨이를 구현하는 방법, 들어오는 요청 필터링, 요청/응답 조작, 인증 처리에 대해 살펴볼 것입니다.\u003c/p\u003e\n\u003cp\u003e아래에서 전체 에코시스템을 시각화할 수 있습니다:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-22-APIgatewayinSpringboot_1.png\" alt=\"에코시스템 다이어그램\"\u003e\u003c/p\u003e\n\u003cp\u003e위 다이어그램에서 총 5개의 서비스가 있습니다.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e서비스 레지스트리 — 각 프로젝트 내의 각 마이크로서비스 인스턴스의 가용 상태를 추적하는 응용 프로그램입니다.\u003c/li\u003e\n\u003cli\u003eAPI 게이트웨이 — 들어오는 요청을 수신하고 인증(활성화되어 있다면)을 수행하고 실제 마이크로서비스로 요청을 전달합니다. 응답을 받으면 소비자에게 반환합니다.\u003c/li\u003e\n\u003cli\u003e인증 서버 — 인증을 처리하는 응용 프로그램입니다.\u003c/li\u003e\n\u003cli\u003e첫 번째와 두 번째 마이크로서비스 — 서로 다른 기능을 갖는 두 개의 일반 내부 응용 프로그램입니다.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e모든 애플리케이션은 시작 시 서비스 레지스트리에 등록됩니다. API 요청을 받으면 다음과 같은 단계가 발생합니다:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e소비자가 API 게이트웨이를 통해 애플리케이션을 호출합니다.\u003c/li\u003e\n\u003cli\u003eAPI 게이트웨이는 수신 URL이 인증이 필요한지 확인합니다. 필요하다면 인증 서버를 호출하여 유효성을 검사합니다.\u003c/li\u003e\n\u003cli\u003e유효한 토큰이라면 필터를 적용한 후 해당 애플리케이션으로 요청을 전달합니다.\u003c/li\u003e\n\u003cli\u003e유효하지 않은 토큰일 경우 소비자에게 권한이 없음을 응답합니다.\u003c/li\u003e\n\u003cli\u003e내부 마이크로서비스에서 응답을 받으면 필터를 적용한 후 해당 소비자에게 반환합니다.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e게이트웨이에서의 필터는 로깅, 요청/응답 세부 사항 조작/사용자 정의와 같은 작업이 포함될 수 있습니다.\u003c/p\u003e\n\u003cp\u003eService registry\u003c/p\u003e\n\u003cp\u003e유레카 서버로 작동하는 애플리케이션이에요. pom.xml에 다음 종속성이 있어야 해요.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u0026#x3C;dependency\u003e\n  \u003cspan class=\"xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003egroupId\u003c/span\u003e\u003e\u003c/span\u003eorg.springframework.cloud\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003egroupId\u003c/span\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eartifactId\u003c/span\u003e\u003e\u003c/span\u003espring-cloud-starter-netflix-eureka-server\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003eartifactId\u003c/span\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u0026#x3C;/dependency\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e그리고 메인 클래스에 \u003ccode\u003e@EnableEurekaServer\u003c/code\u003e 어노테이션이 있어야 해요.\u003c/p\u003e\n\u003cp\u003e기본적으로 유레카 서버는 자신을 디스커버리에 등록하는데, 이를 비활성화하기 위해 application.properties에 아래 속성을 포함해야 해요.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003eeureka.\u003cspan class=\"hljs-property\"\u003eclient\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eregisterWithEureka\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\neureka.\u003cspan class=\"hljs-property\"\u003eclient\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003efetchRegistry\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e다른 애플리케이션을 Eureka 클라이언트로 만들려면 pom.xml에 아래 종속성을 포함하세요:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e  \u0026#x3C;dependency\u003e\n   \u003cspan class=\"xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003egroupId\u003c/span\u003e\u003e\u003c/span\u003eorg.springframework.cloud\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003egroupId\u003c/span\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n   \u003cspan class=\"xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eartifactId\u003c/span\u003e\u003e\u003c/span\u003espring-cloud-starter-netflix-eureka-client\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003eartifactId\u003c/span\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u0026#x3C;/dependency\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e그리고, application.properties 파일에 Eureka 서버 URL을 제공해주세요:\u003c/p\u003e\n\u003cp\u003eeureka.client.serviceUrl.defaultZone= \u0026#x3C;eureka-서버-가동-호스트-및-포트\u003e\u003c/p\u003e\n\u003cp\u003eAPI 게이트웨이:\u003c/p\u003e\n\u003cp\u003eSpring Cloud API 게이트웨이에는 pom.xml에 아래 종속성이 필요합니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003edependencies\u003c/span\u003e\u003e\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003edependency\u003c/span\u003e\u003e\u003c/span\u003e\n   \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003egroupId\u003c/span\u003e\u003e\u003c/span\u003eorg.springframework.cloud\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003egroupId\u003c/span\u003e\u003e\u003c/span\u003e\n   \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eartifactId\u003c/span\u003e\u003e\u003c/span\u003espring-cloud-starter-gateway\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003eartifactId\u003c/span\u003e\u003e\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003edependency\u003c/span\u003e\u003e\u003c/span\u003e\n\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003edependencies\u003c/span\u003e\u003e\u003c/span\u003e\n \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003edependencyManagement\u003c/span\u003e\u003e\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003edependencies\u003c/span\u003e\u003e\u003c/span\u003e\n   \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003edependency\u003c/span\u003e\u003e\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003egroupId\u003c/span\u003e\u003e\u003c/span\u003eorg.springframework.cloud\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003egroupId\u003c/span\u003e\u003e\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eartifactId\u003c/span\u003e\u003e\u003c/span\u003espring-cloud-dependencies\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003eartifactId\u003c/span\u003e\u003e\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003eversion\u003c/span\u003e\u003e\u003c/span\u003e${spring-cloud.version}\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003eversion\u003c/span\u003e\u003e\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003etype\u003c/span\u003e\u003e\u003c/span\u003epom\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003etype\u003c/span\u003e\u003e\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003escope\u003c/span\u003e\u003e\u003c/span\u003eimport\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003escope\u003c/span\u003e\u003e\u003c/span\u003e\n   \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003edependency\u003c/span\u003e\u003e\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003edependencies\u003c/span\u003e\u003e\u003c/span\u003e\n \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003edependencyManagement\u003c/span\u003e\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eapplication.yml 파일에서 모든 내부 마이크로서비스 이름, 경로 및 uri 세부 정보를 다음과 같이 제공해주세요:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-attr\"\u003espring\u003c/span\u003e:\n  \u003cspan class=\"hljs-attr\"\u003eapplication\u003c/span\u003e:\n    \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e: gateway-service\n  \u003cspan class=\"hljs-attr\"\u003ecloud\u003c/span\u003e:\n    \u003cspan class=\"hljs-attr\"\u003egateway\u003c/span\u003e:\n      \u003cspan class=\"hljs-attr\"\u003eroutes\u003c/span\u003e:\n        - \u003cspan class=\"hljs-attr\"\u003eid\u003c/span\u003e: first\n          \u003cspan class=\"hljs-attr\"\u003epredicates\u003c/span\u003e:\n            - \u003cspan class=\"hljs-title class_\"\u003ePath\u003c/span\u003e=\u003cspan class=\"hljs-regexp\"\u003e/first/\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003euri\u003c/span\u003e: \u003cspan class=\"hljs-attr\"\u003elocalhost\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e8081\u003c/span\u003e\n        - \u003cspan class=\"hljs-attr\"\u003eid\u003c/span\u003e: second\n          \u003cspan class=\"hljs-attr\"\u003epredicates\u003c/span\u003e:\n            - \u003cspan class=\"hljs-title class_\"\u003ePath\u003c/span\u003e=\u003cspan class=\"hljs-regexp\"\u003e/second/\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003euri\u003c/span\u003e: \u003cspan class=\"hljs-attr\"\u003elocalhost\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e8082\u003c/span\u003e\n        - \u003cspan class=\"hljs-attr\"\u003eid\u003c/span\u003e: auth-server\n          \u003cspan class=\"hljs-attr\"\u003epredicates\u003c/span\u003e:\n            - \u003cspan class=\"hljs-title class_\"\u003ePath\u003c/span\u003e=\u003cspan class=\"hljs-regexp\"\u003e/login/\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003euri\u003c/span\u003e: \u003cspan class=\"hljs-attr\"\u003elocalhost\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e8088\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e그리고 Gateway가 제공하는 모든 라우트를 제공하기 위해 RouteLocator 유형의 빈이 필요합니다. 요청/응답을 처리하려면 필요에 따라 필터를 포함할 수 있습니다:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e@\u003cspan class=\"hljs-title class_\"\u003eBean\u003c/span\u003e\npublic \u003cspan class=\"hljs-title class_\"\u003eRouteLocator\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecustomRouteLocator\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eRouteLocatorBuilder builder\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e builder.\u003cspan class=\"hljs-title function_\"\u003eroutes\u003c/span\u003e()\n            .\u003cspan class=\"hljs-title function_\"\u003eroute\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"first-microservice\"\u003c/span\u003e, r -\u003e r.\u003cspan class=\"hljs-title function_\"\u003epath\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"/first\"\u003c/span\u003e)\n                    .\u003cspan class=\"hljs-title function_\"\u003eand\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003emethod\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"POST\"\u003c/span\u003e)\n                    .\u003cspan class=\"hljs-title function_\"\u003eand\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003ereadBody\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eStudent\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eclass\u003c/span\u003e, s -\u003e \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003efilters\u003c/span\u003e(f -\u003e f.\u003cspan class=\"hljs-title function_\"\u003efilters\u003c/span\u003e(requestFilter, authFilter))\n                    .\u003cspan class=\"hljs-title function_\"\u003euri\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"http://localhost:8081\"\u003c/span\u003e))\n            .\u003cspan class=\"hljs-title function_\"\u003eroute\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"first-microservice\"\u003c/span\u003e, r -\u003e r.\u003cspan class=\"hljs-title function_\"\u003epath\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"/first\"\u003c/span\u003e)\n                    .\u003cspan class=\"hljs-title function_\"\u003eand\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003emethod\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"GET\"\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003efilters\u003c/span\u003e(f-\u003e f.\u003cspan class=\"hljs-title function_\"\u003efilters\u003c/span\u003e(authFilter))\n                    .\u003cspan class=\"hljs-title function_\"\u003euri\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"http://localhost:8081\"\u003c/span\u003e))\n            .\u003cspan class=\"hljs-title function_\"\u003eroute\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"second-microservice\"\u003c/span\u003e, r -\u003e r.\u003cspan class=\"hljs-title function_\"\u003epath\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"/second\"\u003c/span\u003e)\n                    .\u003cspan class=\"hljs-title function_\"\u003eand\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003emethod\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"POST\"\u003c/span\u003e)\n                    .\u003cspan class=\"hljs-title function_\"\u003eand\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003ereadBody\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eCompany\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eclass\u003c/span\u003e, s -\u003e \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003efilters\u003c/span\u003e(f -\u003e f.\u003cspan class=\"hljs-title function_\"\u003efilters\u003c/span\u003e(requestFilter, authFilter))\n                    .\u003cspan class=\"hljs-title function_\"\u003euri\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"http://localhost:8082\"\u003c/span\u003e))\n            .\u003cspan class=\"hljs-title function_\"\u003eroute\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"second-microservice\"\u003c/span\u003e, r -\u003e r.\u003cspan class=\"hljs-title function_\"\u003epath\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"/second\"\u003c/span\u003e)\n                    .\u003cspan class=\"hljs-title function_\"\u003eand\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003emethod\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"GET\"\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003efilters\u003c/span\u003e(f-\u003e f.\u003cspan class=\"hljs-title function_\"\u003efilters\u003c/span\u003e(authFilter))\n                    .\u003cspan class=\"hljs-title function_\"\u003euri\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"http://localhost:8082\"\u003c/span\u003e))\n            .\u003cspan class=\"hljs-title function_\"\u003eroute\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"auth-server\"\u003c/span\u003e, r -\u003e r.\u003cspan class=\"hljs-title function_\"\u003epath\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"/login\"\u003c/span\u003e)\n                    .\u003cspan class=\"hljs-title function_\"\u003euri\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"http://localhost:8088\"\u003c/span\u003e))\n            .\u003cspan class=\"hljs-title function_\"\u003ebuild\u003c/span\u003e();\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e필터:\u003c/p\u003e\n\u003cp\u003eA. 요청 본문을 로깅하려면:\u003c/p\u003e\n\u003cp\u003e본문을 읽기 위해 ResourceLocator 빈에서 readBody()를 true로 설정해야 합니다. 이렇게 하면 ServerWebExchange 객체가 요청 본문을 \"cachedRequestBodyObject\" 속성에 캐시합니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003epackage com.\u003cspan class=\"hljs-property\"\u003eexample\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003espringcloudgatewayoverview\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003efilter\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e com.\u003cspan class=\"hljs-property\"\u003eexample\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003espringcloudgatewayoverview\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003emodel\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eCompany\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e com.\u003cspan class=\"hljs-property\"\u003eexample\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003espringcloudgatewayoverview\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003emodel\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eStudent\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.\u003cspan class=\"hljs-property\"\u003espringframework\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecloud\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003egateway\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003efilter\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eGatewayFilter\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.\u003cspan class=\"hljs-property\"\u003espringframework\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecloud\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003egateway\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003efilter\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eGatewayFilterChain\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.\u003cspan class=\"hljs-property\"\u003espringframework\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003estereotype\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eComponent\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.\u003cspan class=\"hljs-property\"\u003espringframework\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eweb\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eserver\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eServerWebExchange\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e reactor.\u003cspan class=\"hljs-property\"\u003ecore\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003epublisher\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eMono\u003c/span\u003e;\n\n@\u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e\npublic \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eRequestFilter\u003c/span\u003e implements \u003cspan class=\"hljs-title class_\"\u003eGatewayFilter\u003c/span\u003e {\n    @\u003cspan class=\"hljs-title class_\"\u003eOverride\u003c/span\u003e\n    public \u003cspan class=\"hljs-title class_\"\u003eMono\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eVoid\u003c/span\u003e\u003e \u003cspan class=\"hljs-title function_\"\u003efilter\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eServerWebExchange exchange, GatewayFilterChain chain\u003c/span\u003e) {\n        \u003cspan class=\"hljs-title class_\"\u003eObject\u003c/span\u003e body = exchange.\u003cspan class=\"hljs-title function_\"\u003egetAttribute\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"cachedRequestBodyObject\"\u003c/span\u003e);\n        \u003cspan class=\"hljs-title class_\"\u003eSystem\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eout\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eprintln\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"in request filter\"\u003c/span\u003e);\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e(body \u003cspan class=\"hljs-keyword\"\u003einstanceof\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eStudent\u003c/span\u003e) {\n            \u003cspan class=\"hljs-title class_\"\u003eSystem\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eout\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eprintln\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"body:\"\u003c/span\u003e + (\u003cspan class=\"hljs-title class_\"\u003eStudent\u003c/span\u003e) body);\n        }\n        \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e(body \u003cspan class=\"hljs-keyword\"\u003einstanceof\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eCompany\u003c/span\u003e) {\n            \u003cspan class=\"hljs-title class_\"\u003eSystem\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eout\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eprintln\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"body:\"\u003c/span\u003e + (\u003cspan class=\"hljs-title class_\"\u003eCompany\u003c/span\u003e) body);\n        }\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e chain.\u003cspan class=\"hljs-title function_\"\u003efilter\u003c/span\u003e(exchange);\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eB. 응답 본문을 로깅하려면:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003epackage com.\u003cspan class=\"hljs-property\"\u003eexample\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003espringcloudgatewayoverview\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003efilter\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e com.\u003cspan class=\"hljs-property\"\u003eexample\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003espringcloudgatewayoverview\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003emodel\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eCompany\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e com.\u003cspan class=\"hljs-property\"\u003eexample\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003espringcloudgatewayoverview\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003emodel\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eStudent\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e com.\u003cspan class=\"hljs-property\"\u003efasterxml\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ejackson\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecore\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eJsonProcessingException\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e com.\u003cspan class=\"hljs-property\"\u003efasterxml\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ejackson\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edatabind\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eObjectMapper\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.\u003cspan class=\"hljs-property\"\u003ereactivestreams\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ePublisher\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.\u003cspan class=\"hljs-property\"\u003espringframework\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecore\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eio\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ebuffer\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eDataBuffer\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.\u003cspan class=\"hljs-property\"\u003espringframework\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecore\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eio\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ebuffer\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eDataBufferFactory\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.\u003cspan class=\"hljs-property\"\u003espringframework\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecore\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eio\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ebuffer\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eDefaultDataBuffer\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.\u003cspan class=\"hljs-property\"\u003espringframework\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecore\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eio\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ebuffer\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eDefaultDataBufferFactory\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.\u003cspan class=\"hljs-property\"\u003espringframework\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ehttp\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eserver\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ereactive\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eServerHttpRequest\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.\u003cspan class=\"hljs-property\"\u003espringframework\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ehttp\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eserver\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ereactive\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eServerHttpResponse\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.\u003cspan class=\"hljs-property\"\u003espringframework\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ehttp\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eserver\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ereactive\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eServerHttpResponseDecorator\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.\u003cspan class=\"hljs-property\"\u003espringframework\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eweb\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eserver\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eServerWebExchange\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.\u003cspan class=\"hljs-property\"\u003espringframework\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eweb\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eserver\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eWebFilter\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.\u003cspan class=\"hljs-property\"\u003espringframework\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eweb\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eserver\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eWebFilterChain\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e reactor.\u003cspan class=\"hljs-property\"\u003ecore\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003epublisher\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eFlux\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e reactor.\u003cspan class=\"hljs-property\"\u003ecore\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003epublisher\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eMono\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e java.\u003cspan class=\"hljs-property\"\u003enio\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003echarset\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eStandardCharsets\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e java.\u003cspan class=\"hljs-property\"\u003eutil\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eList\u003c/span\u003e;\n\npublic \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePostGlobalFilter\u003c/span\u003e implements \u003cspan class=\"hljs-title class_\"\u003eWebFilter\u003c/span\u003e {\n\n    @\u003cspan class=\"hljs-title class_\"\u003eOverride\u003c/span\u003e\n    public \u003cspan class=\"hljs-title class_\"\u003eMono\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eVoid\u003c/span\u003e\u003e \u003cspan class=\"hljs-title function_\"\u003efilter\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eServerWebExchange exchange, WebFilterChain chain\u003c/span\u003e) {\n        \u003cspan class=\"hljs-title class_\"\u003eString\u003c/span\u003e path = exchange.\u003cspan class=\"hljs-title function_\"\u003egetRequest\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003egetPath\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003etoString\u003c/span\u003e();\n        \u003cspan class=\"hljs-title class_\"\u003eServerHttpResponse\u003c/span\u003e response = exchange.\u003cspan class=\"hljs-title function_\"\u003egetResponse\u003c/span\u003e();\n        \u003cspan class=\"hljs-title class_\"\u003eServerHttpRequest\u003c/span\u003e request = exchange.\u003cspan class=\"hljs-title function_\"\u003egetRequest\u003c/span\u003e();\n        \u003cspan class=\"hljs-title class_\"\u003eDataBufferFactory\u003c/span\u003e dataBufferFactory = response.\u003cspan class=\"hljs-title function_\"\u003ebufferFactory\u003c/span\u003e();\n        \u003cspan class=\"hljs-title class_\"\u003eServerHttpResponseDecorator\u003c/span\u003e decoratedResponse = \u003cspan class=\"hljs-title function_\"\u003egetDecoratedResponse\u003c/span\u003e(path, response, request, dataBufferFactory);\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e chain.\u003cspan class=\"hljs-title function_\"\u003efilter\u003c/span\u003e(exchange.\u003cspan class=\"hljs-title function_\"\u003emutate\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003eresponse\u003c/span\u003e(decoratedResponse).\u003cspan class=\"hljs-title function_\"\u003ebuild\u003c/span\u003e());\n    }\n\n    private \u003cspan class=\"hljs-title class_\"\u003eServerHttpResponseDecorator\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetDecoratedResponse\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003cspan class=\"hljs-built_in\"\u003eString\u003c/span\u003e path, ServerHttpResponse response, ServerHttpRequest request, DataBufferFactory dataBufferFactory\u003c/span\u003e) {\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eServerHttpResponseDecorator\u003c/span\u003e(response) {\n\n            @\u003cspan class=\"hljs-title class_\"\u003eOverride\u003c/span\u003e\n            public \u003cspan class=\"hljs-title class_\"\u003eMono\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eVoid\u003c/span\u003e\u003e \u003cspan class=\"hljs-title function_\"\u003ewriteWith\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003efinal Publisher\u0026#x3C;? \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e DataBuffer\u003e body\u003c/span\u003e) {\n\n                \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (body \u003cspan class=\"hljs-keyword\"\u003einstanceof\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFlux\u003c/span\u003e) {\n\n                    \u003cspan class=\"hljs-title class_\"\u003eFlux\u003c/span\u003e\u0026#x3C;? \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eDataBuffer\u003c/span\u003e\u003e fluxBody = (\u003cspan class=\"hljs-title class_\"\u003eFlux\u003c/span\u003e\u0026#x3C;? \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eDataBuffer\u003c/span\u003e\u003e) body;\n\n                    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-variable language_\"\u003esuper\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ewriteWith\u003c/span\u003e(fluxBody.\u003cspan class=\"hljs-title function_\"\u003ebuffer\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003emap\u003c/span\u003e(dataBuffers -\u003e {\n\n                        \u003cspan class=\"hljs-title class_\"\u003eDefaultDataBuffer\u003c/span\u003e joinedBuffers = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eDefaultDataBufferFactory\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003ejoin\u003c/span\u003e(dataBuffers);\n                        byte[] content = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e byte[joinedBuffers.\u003cspan class=\"hljs-title function_\"\u003ereadableByteCount\u003c/span\u003e()];\n                        joinedBuffers.\u003cspan class=\"hljs-title function_\"\u003eread\u003c/span\u003e(content);\n                        \u003cspan class=\"hljs-title class_\"\u003eString\u003c/span\u003e responseBody = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eString\u003c/span\u003e(content, \u003cspan class=\"hljs-title class_\"\u003eStandardCharsets\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eUTF_8\u003c/span\u003e);\u003cspan class=\"hljs-comment\"\u003e//응답 수정 및 수정된 응답 반환\u003c/span\u003e\n                        \u003cspan class=\"hljs-title class_\"\u003eSystem\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eout\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eprintln\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"requestId: \"\u003c/span\u003e+request.\u003cspan class=\"hljs-title function_\"\u003egetId\u003c/span\u003e()+\u003cspan class=\"hljs-string\"\u003e\", method: \"\u003c/span\u003e+request.\u003cspan class=\"hljs-title function_\"\u003egetMethodValue\u003c/span\u003e()+\u003cspan class=\"hljs-string\"\u003e\", req url: \"\u003c/span\u003e+request.\u003cspan class=\"hljs-title function_\"\u003egetURI\u003c/span\u003e()+\u003cspan class=\"hljs-string\"\u003e\", response body :\"\u003c/span\u003e+ responseBody);\n                        \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\n                            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e(request.\u003cspan class=\"hljs-title function_\"\u003egetURI\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003egetPath\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003eequals\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"/first\"\u003c/span\u003e) \u0026#x26;\u0026#x26; request.\u003cspan class=\"hljs-title function_\"\u003egetMethodValue\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003eequals\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"GET\"\u003c/span\u003e)) {\n                                \u003cspan class=\"hljs-title class_\"\u003eList\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eStudent\u003c/span\u003e\u003e student = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eObjectMapper\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003ereadValue\u003c/span\u003e(responseBody, \u003cspan class=\"hljs-title class_\"\u003eList\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eclass\u003c/span\u003e);\n                                \u003cspan class=\"hljs-title class_\"\u003eSystem\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eout\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eprintln\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"student:\"\u003c/span\u003e + student);\n                            }\n                            \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e(request.\u003cspan class=\"hljs-title function_\"\u003egetURI\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003egetPath\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003eequals\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"/second\"\u003c/span\u003e) \u0026#x26;\u0026#x26; request.\u003cspan class=\"hljs-title function_\"\u003egetMethodValue\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003eequals\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"GET\"\u003c/span\u003e)) {\n                                \u003cspan class=\"hljs-title class_\"\u003eList\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eCompany\u003c/span\u003e\u003e companies = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eObjectMapper\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003ereadValue\u003c/span\u003e(responseBody, \u003cspan class=\"hljs-title class_\"\u003eList\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eclass\u003c/span\u003e);\n                                \u003cspan class=\"hljs-title class_\"\u003eSystem\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eout\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eprintln\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"companies:\"\u003c/span\u003e + companies);\n                            }\n                        } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (\u003cspan class=\"hljs-title class_\"\u003eJsonProcessingException\u003c/span\u003e e) {\n                            \u003cspan class=\"hljs-keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eRuntimeException\u003c/span\u003e(e);\n                        }\n                        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e dataBufferFactory.\u003cspan class=\"hljs-title function_\"\u003ewrap\u003c/span\u003e(responseBody.\u003cspan class=\"hljs-title function_\"\u003egetBytes\u003c/span\u003e());\n                    })).\u003cspan class=\"hljs-title function_\"\u003eonErrorResume\u003c/span\u003e(err -\u003e {\n\n                        \u003cspan class=\"hljs-title class_\"\u003eSystem\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eout\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eprintln\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"error while decorating Response: {}\"\u003c/span\u003e+err.\u003cspan class=\"hljs-title function_\"\u003egetMessage\u003c/span\u003e());\n                        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMono\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eempty\u003c/span\u003e();\n                    });\n\n                }\n                \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-variable language_\"\u003esuper\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ewriteWith\u003c/span\u003e(body);\n            }\n        };\n    }\n\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eC. API 호출 전에 인증하기:\u003c/p\u003e\n\u003cp\u003e다음과 같이 인증 필터를 생성하십시오:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-java\"\u003e\u003cspan class=\"hljs-keyword\"\u003epackage\u003c/span\u003e com.example.springcloudgatewayoverview.filter;\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e com.example.springcloudgatewayoverview.util.AuthUtil;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e com.example.springcloudgatewayoverview.util.JWTUtil;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e com.example.springcloudgatewayoverview.validator.RouteValidator;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e io.jsonwebtoken.Claims;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.springframework.beans.factory.annotation.Autowired;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.springframework.beans.factory.annotation.Value;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.springframework.cloud.context.config.annotation.RefreshScope;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.springframework.cloud.gateway.filter.GatewayFilter;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.springframework.cloud.gateway.filter.GatewayFilterChain;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.springframework.http.HttpStatus;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.springframework.http.server.reactive.ServerHttpRequest;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.springframework.http.server.reactive.ServerHttpResponse;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.springframework.stereotype.Component;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.springframework.web.server.ServerWebExchange;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e reactor.core.publisher.Mono;\n\n\u003cspan class=\"hljs-meta\"\u003e@Component\u003c/span\u003e\n\u003cspan class=\"hljs-meta\"\u003e@RefreshScope\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eAuthFilter\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eimplements\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eGatewayFilter\u003c/span\u003e {\n\n    \u003cspan class=\"hljs-meta\"\u003e@Autowired\u003c/span\u003e\n    RouteValidator routeValidator;\n\n    \u003cspan class=\"hljs-meta\"\u003e@Autowired\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e JWTUtil jwtUtil;\n\n    \u003cspan class=\"hljs-meta\"\u003e@Autowired\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e AuthUtil authUtil;\n\n    \u003cspan class=\"hljs-meta\"\u003e@Value(\"${authentication.enabled}\")\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003eboolean\u003c/span\u003e authEnabled;\n\n    \u003cspan class=\"hljs-meta\"\u003e@Override\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e Mono\u0026#x3C;Void\u003e \u003cspan class=\"hljs-title function_\"\u003efilter\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(ServerWebExchange exchange, GatewayFilterChain chain)\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e(!authEnabled) {\n            System.out.println(\u003cspan class=\"hljs-string\"\u003e\"Authentication is disabled. To enable it, make \\\"authentication.enabled\\\" property as true\"\u003c/span\u003e);\n            \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e chain.filter(exchange);\n        }\n        \u003cspan class=\"hljs-type\"\u003eString\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003etoken\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\"\"\u003c/span\u003e;\n        \u003cspan class=\"hljs-type\"\u003eServerHttpRequest\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003erequest\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e exchange.getRequest();\n\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e(routeValidator.isSecured.test(request)) {\n            System.out.println(\u003cspan class=\"hljs-string\"\u003e\"validating authentication token\"\u003c/span\u003e);\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e(\u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.isCredsMissing(request)) {\n                System.out.println(\u003cspan class=\"hljs-string\"\u003e\"in error\"\u003c/span\u003e);\n                \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.onError(exchange,\u003cspan class=\"hljs-string\"\u003e\"Credentials missing\"\u003c/span\u003e,HttpStatus.UNAUTHORIZED);\n            }\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (request.getHeaders().containsKey(\u003cspan class=\"hljs-string\"\u003e\"userName\"\u003c/span\u003e) \u0026#x26;\u0026#x26; request.getHeaders().containsKey(\u003cspan class=\"hljs-string\"\u003e\"role\"\u003c/span\u003e)) {\n                token = authUtil.getToken(request.getHeaders().get(\u003cspan class=\"hljs-string\"\u003e\"userName\"\u003c/span\u003e).toString(), request.getHeaders().get(\u003cspan class=\"hljs-string\"\u003e\"role\"\u003c/span\u003e).toString());\n            }\n            \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\n                token = request.getHeaders().get(\u003cspan class=\"hljs-string\"\u003e\"Authorization\"\u003c/span\u003e).toString().split(\u003cspan class=\"hljs-string\"\u003e\" \"\u003c/span\u003e)[\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e];\n            }\n\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e(jwtUtil.isInvalid(token)) {\n                \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.onError(exchange,\u003cspan class=\"hljs-string\"\u003e\"Auth header invalid\"\u003c/span\u003e,HttpStatus.UNAUTHORIZED);\n            }\n            \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\n                System.out.println(\u003cspan class=\"hljs-string\"\u003e\"Authentication is successful\"\u003c/span\u003e);\n            }\n\n            \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.populateRequestWithHeaders(exchange,token);\n        }\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e chain.filter(exchange);\n    }\n\n    \u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e Mono\u0026#x3C;Void\u003e \u003cspan class=\"hljs-title function_\"\u003eonError\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(ServerWebExchange exchange, String err, HttpStatus httpStatus)\u003c/span\u003e {\n        \u003cspan class=\"hljs-type\"\u003eServerHttpResponse\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003eresponse\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e exchange.getResponse();\n        response.setStatusCode(httpStatus);\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e response.setComplete();\n    }\n\n    \u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e String \u003cspan class=\"hljs-title function_\"\u003egetAuthHeader\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(ServerHttpRequest request)\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e  request.getHeaders().getOrEmpty(\u003cspan class=\"hljs-string\"\u003e\"Authorization\"\u003c/span\u003e).get(\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e);\n    }\n\n\n    \u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003eboolean\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eisCredsMissing\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(ServerHttpRequest request)\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e !(request.getHeaders().containsKey(\u003cspan class=\"hljs-string\"\u003e\"userName\"\u003c/span\u003e) \u0026#x26;\u0026#x26; request.getHeaders().containsKey(\u003cspan class=\"hljs-string\"\u003e\"role\"\u003c/span\u003e)) \u0026#x26;\u0026#x26; !request.getHeaders().containsKey(\u003cspan class=\"hljs-string\"\u003e\"Authorization\"\u003c/span\u003e);\n    }\n\n    \u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003epopulateRequestWithHeaders\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(ServerWebExchange exchange, String token)\u003c/span\u003e {\n        \u003cspan class=\"hljs-type\"\u003eClaims\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003eclaims\u003c/span\u003e \u003cspan class=\"hljs-operator\"\u003e=\u003c/span\u003e jwtUtil.getALlClaims(token);\n        exchange.getRequest()\n                .mutate()\n                .header(\u003cspan class=\"hljs-string\"\u003e\"id\"\u003c/span\u003e,String.valueOf(claims.get(\u003cspan class=\"hljs-string\"\u003e\"id\"\u003c/span\u003e)))\n                .header(\u003cspan class=\"hljs-string\"\u003e\"role\"\u003c/span\u003e, String.valueOf(claims.get(\u003cspan class=\"hljs-string\"\u003e\"role\"\u003c/span\u003e)))\n                .build();\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eEndpoints 중 일부는 토큰 없이 호출을 허용해야 합니다. (예: 로그인 URL, 헬스 체크 URL 등). 이러한 엔드포인트들을 아래 목록에 추가할 것입니다:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-java\"\u003e\u003cspan class=\"hljs-keyword\"\u003epackage\u003c/span\u003e com.example.springcloudgatewayoverview.validator;\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.springframework.http.server.reactive.ServerHttpRequest;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.springframework.stereotype.Component;\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e java.util.List;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e java.util.function.Predicate;\n\n\u003cspan class=\"hljs-meta\"\u003e@Component\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eRouteValidator\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efinal\u003c/span\u003e List\u0026#x3C;String\u003e unprotectedURLs = List.of(\u003cspan class=\"hljs-string\"\u003e\"/login\"\u003c/span\u003e);\n\n    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e Predicate\u0026#x3C;ServerHttpRequest\u003e isSecured = request -\u003e unprotectedURLs.stream().noneMatch(uri -\u003e request.getURI().getPath().contains(uri));\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eJWTUtil:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-java\"\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-java\"\u003e\u003cspan class=\"hljs-keyword\"\u003epackage\u003c/span\u003e com.example.springcloudgatewayoverview.util;\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e io.jsonwebtoken.Claims;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e io.jsonwebtoken.Jwts;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.springframework.beans.factory.annotation.Value;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e org.springframework.stereotype.Component;\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e java.util.Date;\n\n\u003cspan class=\"hljs-meta\"\u003e@Component\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eJWTUtil\u003c/span\u003e {\n\n    \u003cspan class=\"hljs-meta\"\u003e@Value(\"${jwt.secret}\")\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e String secret;\n\n    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e Claims \u003cspan class=\"hljs-title function_\"\u003egetAllClaims\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(String token)\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e Jwts.parserBuilder().setSigningKey(secret).build().parseClaimsJws(token).getBody();\n    }\n\n    \u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003eboolean\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eisTokenExpired\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(String token)\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.getAllClaims(token).getExpiration().before(\u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eDate\u003c/span\u003e());\n    }\n\n    \u003cspan class=\"hljs-keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003eboolean\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eisInvalid\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(String token)\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.isTokenExpired(token);\n    }\n\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAuthentication server:\u003c/p\u003e\n\u003cp\u003e이 서비스는 내부 마이크로서비스에 액세스하기 위한 토큰을 제공합니다.\u003c/p\u003e\n\u003cp\u003e실행:\u003c/p\u003e\n\u003cp\u003eOnce all applications are running, you can access the service registry by entering \u003ca href=\"http://localhost:8761\" rel=\"nofollow\" target=\"_blank\"\u003ehttp://localhost:8761\u003c/a\u003e in your browser. Here, you can find information about all the currently running services:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-22-APIgatewayinSpringboot_2.png\" alt=\"Service Registry\"\u003e\u003c/p\u003e\n\u003cp\u003eThe API Gateway is running on localhost at port 8080. You can access the endpoints of the First or Second microservice from \u003ca href=\"http://localhost:8080\" rel=\"nofollow\" target=\"_blank\"\u003ehttp://localhost:8080\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-22-APIgatewayinSpringboot_3.png\" alt=\"API Gateway Endpoints\"\u003e\u003c/p\u003e\n\u003cp\u003eAPIGateway 콘솔의 요청/응답 로그:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-22-APIgatewayinSpringboot_4.png\" alt=\"2024-06-22-APIgatewayinSpringboot_4\"\u003e\u003c/p\u003e\n\u003cp\u003e인증이 포함된 샘플 요청:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-22-APIgatewayinSpringboot_5.png\" alt=\"2024-06-22-APIgatewayinSpringboot_5\"\u003e\u003c/p\u003e\n\u003cp\u003e서비스의 모든 코드 기반은 여기에서 사용 가능합니다.\u003c/p\u003e\n\u003cp\u003e읽어 주셔서 감사합니다. 즐거운 탐험하세요!!!\u003c/p\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"2024-06-22-APIgatewayinSpringboot"},"buildId":"o1YmnmSuZvAX2O4TI9r41","isFallback":false,"gsp":true,"scriptLoader":[{"async":true,"src":"https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4877378276818686","strategy":"lazyOnload","crossOrigin":"anonymous"}]}</script></body></html>