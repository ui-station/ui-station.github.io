<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><title>내 IaC AWS 다중 계정 프로비저닝 블루프린트, 최고의 관행 | ui-station</title><meta name="description" content=""/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:url" content="https://ui-station.github.io///post/2024-05-27-MyIaCAWSMulti-AccountProvisioningBluePrintBestPractices" data-gatsby-head="true"/><meta property="og:type" content="website" data-gatsby-head="true"/><meta property="og:site_name" content="내 IaC AWS 다중 계정 프로비저닝 블루프린트, 최고의 관행 | ui-station" data-gatsby-head="true"/><meta property="og:title" content="내 IaC AWS 다중 계정 프로비저닝 블루프린트, 최고의 관행 | ui-station" data-gatsby-head="true"/><meta property="og:description" content="" data-gatsby-head="true"/><meta property="og:image" content="/assets/img/2024-05-27-MyIaCAWSMulti-AccountProvisioningBluePrintBestPractices_0.png" data-gatsby-head="true"/><meta property="og:locale" content="en_US" data-gatsby-head="true"/><meta name="twitter:card" content="summary_large_image" data-gatsby-head="true"/><meta property="twitter:domain" content="https://ui-station.github.io/" data-gatsby-head="true"/><meta property="twitter:url" content="https://ui-station.github.io///post/2024-05-27-MyIaCAWSMulti-AccountProvisioningBluePrintBestPractices" data-gatsby-head="true"/><meta name="twitter:title" content="내 IaC AWS 다중 계정 프로비저닝 블루프린트, 최고의 관행 | ui-station" data-gatsby-head="true"/><meta name="twitter:description" content="" data-gatsby-head="true"/><meta name="twitter:image" content="/assets/img/2024-05-27-MyIaCAWSMulti-AccountProvisioningBluePrintBestPractices_0.png" data-gatsby-head="true"/><meta name="twitter:data1" content="Dev | ui-station" data-gatsby-head="true"/><meta name="article:published_time" content="2024-05-27 17:37" data-gatsby-head="true"/><meta name="next-head-count" content="19"/><meta name="google-site-verification" content="a-yehRo3k3xv7fg6LqRaE8jlE42e5wP2bDE_2F849O4"/><link rel="stylesheet" href="/favicons/favicon.ico"/><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png"/><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/assets/favicons/favicon-96x96.png"/><link rel="icon" href="/favicons/apple-icon-180x180.png"/><link rel="apple-touch-icon" href="/favicons/apple-icon-180x180.png"/><link rel="apple-touch-startup-image" href="/startup.png"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black"/><meta name="msapplication-config" content="/favicons/browserconfig.xml"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-BHFR6GTH9P"></script><script>window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
          
            gtag('config', 'G-BHFR6GTH9P');</script><link rel="preload" href="/_next/static/css/6e57edcf9f2ce551.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6e57edcf9f2ce551.css" data-n-g=""/><link rel="preload" href="/_next/static/css/b8ef307c9aee1e34.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b8ef307c9aee1e34.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee6df16fdc6dae4d.js" defer=""></script><script src="/_next/static/chunks/framework-46611630e39cfdeb.js" defer=""></script><script src="/_next/static/chunks/main-cf4a52eec9a970a0.js" defer=""></script><script src="/_next/static/chunks/pages/_app-6fae11262ee5c69b.js" defer=""></script><script src="/_next/static/chunks/75fc9c18-ac4aa08aae62f90e.js" defer=""></script><script src="/_next/static/chunks/463-0429087d4c0b0335.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-70e5ce89f3d962ac.js" defer=""></script><script src="/_next/static/T_Nz0g9U1yttYMSEma95P/_buildManifest.js" defer=""></script><script src="/_next/static/T_Nz0g9U1yttYMSEma95P/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="Header_header__Z8PUO"><div class="Header_inner__tfr0u"><strong class="Header_title__Otn70"><a href="/">UI STATION</a></strong><nav class="Header_nav_area__6KVpk"><a class="nav_item" href="/posts/1">Posts</a></nav></div></header><main class="posts_container__NyRU3"><div class="posts_inner__i3n_i"><h1 class="posts_post_title__EbxNx">내 IaC AWS 다중 계정 프로비저닝 블루프린트, 최고의 관행</h1><div class="posts_meta__cR7lu"><div class="posts_profile_wrap__mslMl"><div class="posts_profile_image_wrap__kPikV"><img alt="내 IaC AWS 다중 계정 프로비저닝 블루프린트, 최고의 관행" loading="lazy" width="44" height="44" decoding="async" data-nimg="1" class="profile" style="color:transparent" src="/favicons/apple-icon-114x114.png"/></div><div class="posts_textarea__w_iKT"><span class="writer">UI STATION</span><span class="posts_info__5KJdN"><span class="posts_date__ctqHI">Posted On May 27, 2024</span><span class="posts_reading_time__f7YPP">35<!-- --> min read</span></span></div></div><img alt="" loading="lazy" width="50" height="50" decoding="async" data-nimg="1" class="posts_view_badge__tcbfm" style="color:transparent" src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fallround-coder.github.io/post/2024-05-27-MyIaCAWSMulti-AccountProvisioningBluePrintBestPractices&amp;count_bg=%2379C83D&amp;title_bg=%23555555&amp;icon=&amp;icon_color=%23E7E7E7&amp;title=views&amp;edge_flat=false"/></div><article class="posts_post_content__n_L6j"><div><!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
</head>
<body>
<h2>SSO 사용자와 함께 Terraform 실행 역할을 가정하는 방법.</h2>
<p>이 기사에서는 IaC (Terraform) 프로젝트의 구조를 보여드리겠습니다. 이 프로젝트는 보통 여기저기 흩어져 있는 값 파일이 필요하지 않도록 구성됩니다. 또한 하나의 구성 파일만으로 모든 환경을 제어하는 방법과 플랫폼과 응용프로그램 인프라 코드를 어떻게 분리하는지도 보여드리겠습니다.</p>
<h2>이 기사에서 다루는 주제들:</h2>
<ul>
<li>여러 계정 배포 도구의 우승자인 Terragrunt</li>
<li>Terraform 및 Terragrunt의 협력</li>
<li>응용프로그램 인프라 Terragrunt Main 구성 파일 (Locals/Backend S3/AWS Provider)</li>
<li>Terraform 실행을 위한 AWS Identity Center (SSO) 권한 집합 (AWS 키와 비밀번호가 영구적이지 않는 역할으로 가정)</li>
<li>플랫폼 vs 응용프로그램 인프라</li>
<li>플랫폼 인프라 Terragrunt Main 구성 파일 (Locals/Backend S3/AWS Provider)</li>
<li>Terraform 실행 역할 생성 (응용프로그램 인프라 배포를 위해) IAM 액세스 Identity (SSO)로 프로비저닝된 역할의 신뢰 정책</li>
<li>안전하게 SSO AWS 임시 자격 증명 구성</li>
<li>AWS-VAULT</li>
</ul>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h1>테라그런트</h1>
<p>내 의견으로 테라그런트는 인프라를 위한 다중 계정 배포 구조화에 사용 가능한 (내가 아는 한) 최고 도구입니다.</p>
<p>테라그런트 문서에 따르면 코드를 다음과 같이 구조화하는 것을 제안합니다:</p>
<p><img src="/assets/img/2024-05-27-MyIaCAWSMulti-AccountProvisioningBluePrintBestPractices_0.png" alt="테라그런트 구조"></p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>그러나 주의해야 할 점은 terragrunt를 자원을 조정하는 데 과도하게 사용하지 않아야 합니다.</p>
<p>Terraform은 여러 모듈을 하나로 번들링하여 응용 프로그램이나 플랫폼 서비스를 사용하는 것을 목적으로 합니다.</p>
<p>Terragrunt는 이미 통합된 Terraform 모듈을 서로 다른 환경에 배포하는 데만 사용해야 합니다.</p>
<h1>응용 프로그램 모듈을 생성하는 데 Terraform을 사용하고, 다른 환경에 배포하는 데 Terragrunt를 사용하세요.</h1>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>애플리케이션 모듈(왼쪽)을 만들 때 Terragrunt를 사용하지 마세요. 그렇지 않으면 복잡해질 수 있고 테라폼 상태가 앱 단위가 아닌 구성 요소 단위로 생성될 수 있습니다. Terragrunt를 사용하는 경우 배포(오른쪽)에만 사용하세요.</p>
<p>과거에 저희가 한 실수를 피하기 위해 이렇게 말씀 드리는데요. 저는 Terragrunt 내부의 컴포넌트에 너무 많이 나눠 애플리케이션 인프라를 분리하면서 개별 리소스를 더 잘 관리하려고 했지만 더 많은 문제를 발생시켰습니다.</p>
<h1>왜 이런 문제가 발생할 수 있나요?</h1>
<p>저의 몇몇 프로젝트 중 하나에서 저는 Terragrunt에서 Terraform 워크스페이스로 다중 계정 배포 방법을 변경하는 작업을 맡게 되었습니다. 이것은 서로 다른 AWS 환경을 관리하기 위해 조직의 표준 절차에 맞추기 위한 것입니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>이 프로세스는 Terragrunt가 단순히 테라폼 래퍼일 뿐이기 때문에 매우 간단할 수 있었을 것입니다.</p>
<p>하지만 앱을 구성 요소로 분할하고 그 구성 요소가 모듈 내에 존재하면 상태 파일을 병합해야 하는 악몽이 될 수 있습니다.</p>
<p>그래서 Terragrunt 풋프린트를 최소화하려면...</p>
<p>T
erraform은 애플리케이션이나 플랫폼 서비스를 위해 서로 다른 모듈을 번들로 묶을 것으로 의도되어야 합니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h2>예시: 최소한의 애플리케이션 인프라 리소스:</h2>
<pre><code class="hljs language-js">data <span class="hljs-string">"aws_caller_identity"</span> <span class="hljs-string">"current"</span> {}

locals {
  aws_account_id = data.<span class="hljs-property">aws_caller_identity</span>.<span class="hljs-property">current</span>.<span class="hljs-property">account_id</span>
}

<span class="hljs-variable language_">module</span> <span class="hljs-string">"app_logs"</span> {
  source = <span class="hljs-string">"git::https://github.com/terraform-aws-modules/terraform-aws-dynamodb-table.git//"</span>
  name         = <span class="hljs-string">"${var.app_name}-logs"</span>
  billing_mode = <span class="hljs-string">"PAY_PER_REQUEST"</span>
  hash_key     = <span class="hljs-string">"organization"</span>
  range_key    = <span class="hljs-string">"job_id"</span>

  server_side_encryption_enabled = <span class="hljs-literal">true</span>
  deletion_protection_enabled    = <span class="hljs-literal">false</span>

  attributes = [
    {
      name = <span class="hljs-string">"organization"</span>
      type = <span class="hljs-string">"S"</span>
    },
    {
      name = <span class="hljs-string">"job_id"</span>
      type = <span class="hljs-string">"S"</span>
    }
  ]
}

<span class="hljs-variable language_">module</span> <span class="hljs-string">"app_users"</span> {
  source = <span class="hljs-string">"git::https://github.com/terraform-aws-modules/terraform-aws-dynamodb-table.git//"</span>
  # 필요 시 다른 <span class="hljs-title class_">DynamoDB</span> 테이블을 여기에 추가
}

<span class="hljs-variable language_">module</span> <span class="hljs-string">"lambda_execution_role"</span> {
  source = <span class="hljs-string">"../lambda-execution-role"</span>
  aws_account_id = local.<span class="hljs-property">aws_account_id</span>
  app_name       = <span class="hljs-keyword">var</span>.<span class="hljs-property">app_name</span>
  env            = <span class="hljs-keyword">var</span>.<span class="hljs-property">env</span>
}

<span class="hljs-variable language_">module</span> <span class="hljs-string">"s3_bucket_files"</span> {
  source = <span class="hljs-string">"git::https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git//?ref=v3.6.1"</span>
  bucket                  = <span class="hljs-keyword">var</span>.<span class="hljs-property">env</span> == <span class="hljs-string">"production"</span> ? <span class="hljs-string">"my-company-app-${var.app_name}-files"</span> : <span class="hljs-string">"my-company-app-${var.app_name}-files-${var.env}"</span>
  block_public_acls       = <span class="hljs-string">"true"</span>
  block_public_policy     = <span class="hljs-string">"true"</span>
  ignore_public_acls      = <span class="hljs-string">"true"</span>
  restrict_public_buckets = <span class="hljs-string">"true"</span>
}

<span class="hljs-variable language_">module</span> <span class="hljs-string">"another_s3_bucket_files"</span> {
  source = <span class="hljs-string">"git::https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git//?ref=v3.6.1"</span>
  # 필요 시 다른 <span class="hljs-variable constant_">S3</span> 버켓을 여기에 추가
}

# <span class="hljs-variable constant_">SSM</span> <span class="hljs-title class_">Params</span>는 서버리스나 다른 도구에 값들을 전달하는 좋은 방법입니다.
<span class="hljs-variable language_">module</span> <span class="hljs-string">"ssm_params"</span> {
  source = <span class="hljs-string">"../ssm-parameters-store"</span>
  parameters = {
    <span class="hljs-number">1</span> = {
      name  = <span class="hljs-string">"/app/${var.app_name}/s3_bucket_files"</span>
      value = <span class="hljs-variable language_">module</span>.<span class="hljs-property">s3_bucket_files</span>.<span class="hljs-property">s3_bucket_id</span>
    }
    <span class="hljs-number">2</span> = {
      name  = <span class="hljs-string">"/app/${var.app_name}/lambda_role"</span>
      value = <span class="hljs-variable language_">module</span>.<span class="hljs-property">lambda_execution_role</span>.<span class="hljs-property">role_arn</span>
    }
    <span class="hljs-number">3</span> = {
      name  = <span class="hljs-string">"/app/${var.app_name}/event_bridge_name"</span>
      value = <span class="hljs-string">"${var.app_name}-event-bus"</span>
    }
    <span class="hljs-number">4</span> = {
      name  = <span class="hljs-string">"/app/${var.app_name}/logs"</span>
      value = <span class="hljs-variable language_">module</span>.<span class="hljs-property">app_logs</span>.<span class="hljs-property">dynamodb_table_id</span>
    }
  }
}
</code></pre>
<p>이 모듈에서는 다른 모듈을 호출하여 다음과 같은 종류의 리소스를 생성합니다:</p>
<ul>
<li>DynamoDB 테이블</li>
<li>S3 버켓</li>
<li>IAM Lambda 실행 역할</li>
<li>이전에 생성된 리소스의 ARN 또는 ID를 보관하는 SSM 매개변수</li>
</ul>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>여기서 빠진 것은 다른 기사에서 보여준 것처럼 백엔드 S3 및 AWS 제공자 구성입니다... 여기서 Terragrunt가 등장합니다...</p>
<h1>플랫폼 대 응용 프로그램</h1>
<p>이러한 염려 사항의 분리는 서로 다른 GIT 저장소를 가지거나 단순히 동일한 Repo 내에서 다른 프로젝트로 취급함을 의미합니다... 여기서 중요한 것은 응용 프로그램 인프라 코드가 플랫폼 인프라 코드에 직접적인 종속성을 포함해서는 안된다는 것입니다... 따라서 이것은 응용 프로그램 소스 코드(BE/FE)와 함께 쉽게 추출될 수 있습니다...</p>
<p>하지만 우리는 어떻게 알 수 있을까요? 무엇을 플랫폼 인프라에 위치시키고 어떤 것을 애플리케이션 인프라에 위치시켜야 할지요?</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h2>플랫폼 인프라스트럭처:</h2>
<p>플랫폼 인프라스트럭처는 보다 포괄적이며 조직 전체에서 여러 응용 프로그램을 지원하는 기본 구성 요소와 서비스를 지칭합니다. 일반적으로 다음을 포함합니다:</p>
<ul>
<li>CI/CD용 IAM 역할</li>
<li>Route53 호스팅 영역</li>
<li>네트워킹: VPC, 방화벽 및 NAT와 같은 구성 요소</li>
<li>모니터링 및 로깅: Prometheus, Grafana 또는 CloudWatch와 같은 요소</li>
</ul>
<h2>응용 프로그램 인프라스트럭처:</h2>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>응용 프로그램 인프라는 특정 응용 프로그램 또는 응용 프로그램 세트를 실행하는 데 필요한 구성 요소와 리소스로 구성됩니다. 이는 종종 다음을 포함합니다:</p>
<ul>
<li>EC2 인스턴스, 람다 함수</li>
<li>트랜짓 게이트웨이, 로드 밸런서</li>
<li>앱 데이터베이스: MySQL, PostgreSQL 또는 MongoDB와 같은 데이터베이스</li>
<li>메시지 대기열: SQS 또는 Kafka와 같은 메시지 대기열</li>
</ul>
<h2>주요 포인트는 개별 앱의 요구 사항에 맞추는 것입니다.</h2>
<p>예를 들어 Serverless Framework나 AWS SAM이 있습니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>서버리스 애플리케이션에 대해서는 테라폼과 서버리스를 사용하는 멋진 가이드가 있어요.</p>
<h2>테라폼을 사용하지 않고 다른 도구를 사용할 때, 서버리스 프레임워크나 SAM같은:</h2>
<h1>애플리케이션 IaC를 위한 Terragrunt</h1>
<p>‘live‘ 디렉토리 내에서 배포할 환경을 지정하세요.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<pre><code class="hljs language-js">├── <span class="hljs-variable constant_">README</span>.<span class="hljs-property">md</span>
├── live
│   ├── _env
│   │   └── app.<span class="hljs-property">hcl</span>
│   ├── dev
│   │   └── app
│   │       └── terragrunt.<span class="hljs-property">hcl</span> &#x3C;--- <span class="hljs-variable language_">this</span> is not a config file, but an environment resource file
│   ├── production
│   │   └── app
│   │       └── terragrunt.<span class="hljs-property">hcl</span>
│   ├── terragrunt.<span class="hljs-property">hcl</span>         &#x3C;------ <span class="hljs-title class_">Terragrunt</span> config file (<span class="hljs-title class_">Unique</span>)
│   └── test
│       └── app
│           └── terragrunt.<span class="hljs-property">hcl</span>
└── modules
    ├── lambda-execution-role
    │   ├── data.<span class="hljs-property">tf</span>
    │   ├── main.<span class="hljs-property">tf</span>
    │   ├── output.<span class="hljs-property">tf</span>
    │   └── variables.<span class="hljs-property">tf</span>
    ├── application_1
    │   ├── main.<span class="hljs-property">tf</span>
    │   └── variables.<span class="hljs-property">tf</span>
    └── ssm-parameters-store
        ├── main.<span class="hljs-property">tf</span>
        └── variables.<span class="hljs-property">tf</span>
</code></pre>
<h1>유일무이한 terragrunt.hcl 설정 파일</h1>
<p>여기에는 하나의 terragrunt.hcl 구성 파일을 사용하여 멀티 계정 배포를 구성하는 방법이 나와 있어요.</p>
<p>테라폼 워크스페이스 구성과 Terragrunt 구성을 비교해보겠습니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>로컬 변수 정의는 "거의" 같은 상태로 유지되고 있으며, Terragrunt Live 디렉터리를 다른 환경의 이름으로 구조화하고 있습니다.</p>
<p>AWS 환경 이름과 디렉터리 이름이 일치하므로 간단한 정규 표현식으로 실행 시간에 환경 값을 추론할 수 있습니다.</p>
<h2>infrastructure/live/terragrunt.hcl</h2>
<p>여기에 완전한 terragrunt.hcl 파일이 있습니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>backend.tf와 provider.tf 생성기에서 "profile" 매개변수를 주목해주세요. 다음 섹션에서 이들을 제거할 예정입니다.</p>
<pre><code class="hljs language-js">locals {
  # 환경
  env_regex = <span class="hljs-string">"infrastructure/live/([a-zA-Z0-9-]+)/"</span>
  aws_env   = <span class="hljs-title function_">try</span>(<span class="hljs-title function_">regex</span>(local.<span class="hljs-property">env_regex</span>, <span class="hljs-title function_">get_original_terragrunt_dir</span>())[<span class="hljs-number">0</span>])
  # 어플리케이션
  app_name = <span class="hljs-string">"my-app"</span>
  component = <span class="hljs-string">"api"</span>

  # <span class="hljs-variable constant_">AWS</span> 조직 계정
  account_mapping = {
    dev             = <span class="hljs-number">22222222222</span>
    test            = <span class="hljs-number">111111111111</span>
    production      = <span class="hljs-number">000000000000</span>
    shared-services = <span class="hljs-number">555555555555</span>
  }
  # 가정할 <span class="hljs-variable constant_">IAM</span> 역할
  account_role_name     = <span class="hljs-string">"apps-terraform-execution-role"</span> # &#x3C;--- 가정할 역할
  # 지역 및 가용 영역
  region = <span class="hljs-string">"us-east-1"</span>
}
remote_state {
  backend = <span class="hljs-string">"s3"</span>
  generate = {
    path      = <span class="hljs-string">"backend.tf"</span>
    if_exists = <span class="hljs-string">"overwrite_terragrunt"</span>
  }
  config = {
    bucket         = <span class="hljs-string">"terraform-state-shared-services"</span>
    key            = <span class="hljs-string">"${local.app_name}/${get_path_from_repo_root()}/terraform.tfstate"</span>
    region         = local.<span class="hljs-property">region</span>
    profile        = <span class="hljs-string">"shared-services"</span> #&#x3C;----- <span class="hljs-variable constant_">AWS</span> 프로필
    encrypt        = <span class="hljs-literal">true</span>
    dynamodb_table = <span class="hljs-string">"shared-services-lock-table"</span>
  }
}
generate <span class="hljs-string">"provider"</span> {
  path      = <span class="hljs-string">"provider.tf"</span>
  if_exists = <span class="hljs-string">"overwrite_terragrunt"</span>
  contents  = &#x3C;&#x3C;-<span class="hljs-variable constant_">EOF</span>
    provider <span class="hljs-string">"aws"</span> {
      region = <span class="hljs-string">"${local.region}"</span>
      profile = <span class="hljs-string">"shared-services"</span> #&#x3C;----- <span class="hljs-variable constant_">AWS</span> 프로필
      allowed_account_ids = [
        <span class="hljs-string">"${local.account_mapping[local.aws_env]}"</span>
      ]
      assume_role {
        role_arn = <span class="hljs-string">"arn:aws:iam::${local.account_mapping[local.aws_env]}:role/${local.account_role_name}"</span>
      }
      default_tags {
        tags = {
          <span class="hljs-title class_">Environment</span> = <span class="hljs-string">"${local.aws_env}"</span>
          <span class="hljs-title class_">ManagedBy</span>   = <span class="hljs-string">"terraform"</span>
          <span class="hljs-title class_">DeployedBy</span>  = <span class="hljs-string">"terragrunt"</span>
          <span class="hljs-title class_">Creator</span>     = <span class="hljs-string">"${get_env("</span><span class="hljs-variable constant_">USER</span><span class="hljs-string">", "</span><span class="hljs-variable constant_">NOT_SET</span><span class="hljs-string">")}"</span>
          <span class="hljs-title class_">Application</span> = <span class="hljs-string">"${local.app_name}"</span>
          <span class="hljs-title class_">Component</span>   = <span class="hljs-string">"${local.component}"</span>
        }
      }
    }
<span class="hljs-variable constant_">EOF</span>
}
</code></pre>
<p>Terragrunt가 생성기에 보간을 허용하므로 모든 대상 AWS 계정에 대해 매개변수화할 수 있습니다.</p>
<h2>infrastructure/live/_env/app.hcl</h2>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>테이블 태그를 마크다운 형식으로 변경해주세요.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h2>Terraform 프로비저닝 인프라에 필요한 역할 설정하기</h2>
<pre><code class="hljs language-js">account_role_name     = <span class="hljs-string">"apps-terraform-execution-role"</span> # &#x3C;--- 전환할 역할
</code></pre>
<p>또한 이전 게시물에서 AWS 공유 서비스 계정에 terraform-multiaccount-role 및 각 작업 부하 계정(개발, 테스트, 프로덕션)에 terraform-role을 설정하는 방법을 설명했습니다.</p>
<p>그러나 이 설정은 하나의 엔터티(terraform-multiaccount-role)가 모든 계정에서 terraform-role을 가정(Assume)할 수 있도록 허용합니다. 이는 개발팀이 자체 인프라를 개발 환경에서 관리할 수 있도록 하려는 경우에는 편리하지 않습니다. 따라서 개발 팀이 Dev 계정에서만 역할을 전환할 수 있는 엔터티와 Test 및 Production에 대한 다른 엔터티가 필요합니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h2>AWS Identity Center 위임된 관리자 계정 및 권한 집합</h2>
<p>AWS 계정에 권한 집합을 만드는 방법 및 권한 집합을 AWS 계정에 할당하는 방법에 대한 문서를 따르세요.</p>
<p>다음과 같은 권한 집합을 만들어 보세요: terraform-dev, terraform-test, terraform-production.</p>
<p>각 권한 집합에 대한 대상 계정에 다음과 같은 내부 정책을 만드세요. 허용하는 권한 집합(Identity 계정에 설정된)이 공유 서비스 계정에 배포되어 다음 계정에서 역할을 가정할 수 있도록합니다:</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>이렇게 보이는 3가지 다른 권한 세트가 있습니다:</p>
<pre><code class="hljs language-js">{
    <span class="hljs-string">"Version"</span>: <span class="hljs-string">"2012-10-17"</span>,
    <span class="hljs-string">"Statement"</span>: [
        {
            <span class="hljs-string">"Effect"</span>: <span class="hljs-string">"Allow"</span>,
            <span class="hljs-string">"Action"</span>: <span class="hljs-string">"sts:AssumeRole"</span>,
            <span class="hljs-string">"Resource"</span>: <span class="hljs-string">"arn:aws:iam::000000000000:role/apps-terraform-execution-role"</span>
        },
        {
            <span class="hljs-string">"Sid"</span>: <span class="hljs-string">"Statement1"</span>,
            <span class="hljs-string">"Effect"</span>: <span class="hljs-string">"Allow"</span>,
            <span class="hljs-string">"Action"</span>: [
              <span class="hljs-string">"s3:GetObject"</span>,
              <span class="hljs-string">"s3:PutObject"</span>,
              <span class="hljs-string">"s3:ListBucket"</span>
            ],
            <span class="hljs-string">"Resource"</span>: [
                <span class="hljs-string">"arn:aws:s3:::terraform-state-shared-services*"</span>,
                <span class="hljs-string">"arn:aws:s3:::terraform-state-shared-services/*"</span>
            ]
        },
        {
            <span class="hljs-string">"Sid"</span>: <span class="hljs-string">"Statement2"</span>,
            <span class="hljs-string">"Effect"</span>: <span class="hljs-string">"Allow"</span>,
            <span class="hljs-string">"Action"</span>: [
              <span class="hljs-string">"dynamodb:GetItem"</span>,
              <span class="hljs-string">"dynamodb:PutItem"</span>,
              <span class="hljs-string">"dynamodb:DeleteItem"</span>
            ],
            <span class="hljs-string">"Resource"</span>: [
                <span class="hljs-string">"arn:aws:dynamodb:us-east-1:555555555555:table/shared-services-lock-table"</span>
            ]
        }
    ]
}
</code></pre>
<p>각 워크로드 계정에 apps-terraform-execution-role을 만들고 SSO 사용자가 역할을 할 수 있도록 허용합니다.</p>
<p>참고: "terraform-production"에게도 Test에서 역할을 수행할 수 있도록 정책을 약간 조정할 수도 있습니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h1>플랫폼 인프라 (IaC)</h1>
<p>최소한의 애플리케이션을 위해 DNS, 네트워킹 및 식별 관리 역할 및 정책과 같은 플랫폼 리소스를 제공해야 합니다.</p>
<pre><code class="hljs language-js">➜  live <span class="hljs-attr">git</span>:(main) ✗ tree
.
├── _env
│   ├── route53-zones.<span class="hljs-property">hcl</span>
│   └── iam-roles.<span class="hljs-property">hcl</span>
├── dev
│   ├── iam-roles
│   │   └── terragrunt.<span class="hljs-property">hcl</span>
│   ├── route53-zones
│   │   └── terragrunt.<span class="hljs-property">hcl</span>
│   └── platform
│       └── terragrunt.<span class="hljs-property">hcl</span>
├── network
│   ├── dmz
│   │   └── terragrunt.<span class="hljs-property">hcl</span>
│   ├── network-egress
│   │   └── terragrunt.<span class="hljs-property">hcl</span>
│   ├── transitgateway-dmz-vpc-attachment
│   │   └── terragrunt.<span class="hljs-property">hcl</span>
│   └── transitgateway-egress-vpc-attachment
│       ├── mystate.<span class="hljs-property">tfstate</span>
│       └── terragrunt.<span class="hljs-property">hcl</span>
├── production
│   ├── iam-roles
│   │   └── terragrunt.<span class="hljs-property">hcl</span>
│   └── platform
│       └── terragrunt.<span class="hljs-property">hcl</span>
├── terragrunt.<span class="hljs-property">hcl</span>
└── test
    ├── iam-roles
    │   └── terragrunt.<span class="hljs-property">hcl</span>
    ├── route53-zones
    │   └── terragrunt.<span class="hljs-property">hcl</span>
    └── platform
        └── terragrunt.<span class="hljs-property">hcl</span>
</code></pre>
<h2>로컬 변수</h2>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>여러 개의 계정 값들을 하나의 장소에서 중앙화하는 방법의 예시입니다:</p>
<pre><code class="hljs language-js">locals {
  # 환경 변수
  env_regex = <span class="hljs-string">"infrastructure/live/([a-zA-Z0-9-]+)/"</span>
  aws_env   = <span class="hljs-title function_">try</span>(<span class="hljs-title function_">regex</span>(local.<span class="hljs-property">env_regex</span>, <span class="hljs-title function_">get_original_terragrunt_dir</span>())[<span class="hljs-number">0</span>])
  # 어플리케이션
  app_name  = <span class="hljs-string">"my-application-platform"</span>
  component = <span class="hljs-string">"platform"</span>
  platform_apps = [
    <span class="hljs-string">"application_1"</span>,
    <span class="hljs-string">"application_2"</span>,
    <span class="hljs-string">"application_3"</span>
  ]
  # <span class="hljs-variable constant_">AWS</span> 조직 계정
  application_account_mapping = {
    dev        = <span class="hljs-number">222222222222</span>
    test       = <span class="hljs-number">111111111111</span>
    production = <span class="hljs-number">000000000000</span>
  }
  platform_account_mapping = {
    shared-services = <span class="hljs-number">555555555555</span>
    network         = <span class="hljs-string">"666666666666"</span>
    dns             = <span class="hljs-number">888888888888</span>
  }
  account_mapping = <span class="hljs-title function_">merge</span>(local.<span class="hljs-property">application_account_mapping</span>, local.<span class="hljs-property">platform_account_mapping</span>)

  # 가정할 <span class="hljs-variable constant_">IAM</span> 역할
  account_role_name     = <span class="hljs-string">"terraform-role"</span>
  multiaccount_role_arn = <span class="hljs-string">"arn:aws:iam::555555555555:role/terraform-multiaccount-role"</span> # shared-services

  terraform_execution_role_mapping = {
    dev = <span class="hljs-string">"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_terraform-dev_ab1"</span>
    test = <span class="hljs-string">"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_terraform-test_ab2"</span>
    production = <span class="hljs-string">"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_terraform-production_ab3"</span>
  }

  # 기타 플랫폼 구성 값들
  # ===================================
  # <span class="hljs-variable constant_">DNS</span>
  main_public_dns_zone_name     = <span class="hljs-string">"example.com"</span>
  env_public_dns_zone_subdomain = <span class="hljs-string">"${local.aws_env}"</span>
  environment_hosted_zone_name  = <span class="hljs-string">"${local.env_public_dns_zone_subdomain}.${local.main_public_dns_zone_name}"</span>
  acm_subject_alternative_names = [
    <span class="hljs-string">"${local.environment_hosted_zone_name}"</span>,
    <span class="hljs-string">"*.${local.environment_hosted_zone_name}"</span>,
    <span class="hljs-string">"*.api.${local.environment_hosted_zone_name}"</span>,
    <span class="hljs-string">"*.myapps.${local.environment_hosted_zone_name}"</span>,
    <span class="hljs-string">"*.apps.${local.environment_hosted_zone_name}"</span>
  ]
  # 지역 및 가용 영역
  region = <span class="hljs-string">"us-east-1"</span>
  azs = [
    <span class="hljs-string">"us-east-1a"</span>,
    <span class="hljs-string">"us-east-1b"</span>,
    <span class="hljs-string">"us-east-1c"</span>
  ]
  platform_accounts = {
    dev = {
      cidr = <span class="hljs-string">"10.3.0.0/16"</span>
      private_subnets = [
        <span class="hljs-string">"10.3.1.0/24"</span>,
        <span class="hljs-string">"10.3.2.0/24"</span>,
        <span class="hljs-string">"10.3.3.0/24"</span>
      ]
    }
    test = {
      cidr = <span class="hljs-string">"10.2.0.0/16"</span>
      private_subnets = [
        <span class="hljs-string">"10.2.1.0/24"</span>,
        <span class="hljs-string">"10.2.2.0/24"</span>,
        <span class="hljs-string">"10.2.3.0/24"</span>
      ]
    }
    production = {
      cidr = <span class="hljs-string">"10.0.0.0/16"</span>
      private_subnets = [
        <span class="hljs-string">"10.0.1.0/24"</span>,
        <span class="hljs-string">"10.0.2.0/24"</span>,
        <span class="hljs-string">"10.0.3.0/24"</span>
      ]
    }
  }
}
</code></pre>
<pre><code class="hljs language-js">include <span class="hljs-string">"root"</span> {
  path = <span class="hljs-title function_">find_in_parent_folders</span>()
}

include <span class="hljs-string">"env"</span> {
  path = <span class="hljs-string">"../../_env/iam-roles.hcl"</span>
}
</code></pre>
<pre><code class="hljs language-js">locals {
  env_vars = <span class="hljs-title function_">read_terragrunt_config</span>(<span class="hljs-title function_">find_in_parent_folders</span>(<span class="hljs-string">"terragrunt.hcl"</span>))
  env      = local.<span class="hljs-property">env_vars</span>.<span class="hljs-property">locals</span>.<span class="hljs-property">aws_env</span>
}

terraform {
  source = <span class="hljs-string">"../../../modules//platform/iam-roles"</span>
}

inputs = {
  trusted_role_arns = [
    local.<span class="hljs-property">env_vars</span>.<span class="hljs-property">locals</span>.<span class="hljs-property">terraform_execution_role_mapping</span>[local.<span class="hljs-property">env</span>]
  ]
}
</code></pre>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h2>infrastructure/modules/platform/iam-roles</h2>
<p>"Iam:<em>"에 대한 범위를 좁히고 있음을 알려드립니다. 이는 Terraform이 응용 프로그램을 위해 Role 및 정책을 생성, 제거 및 업데이트해야하기 때문에 필요한 권한입니다. 그러나 이 경우 ":role/app/</em>" 내의 Roles 및 Policies로 범위를 좁힐 수 있습니다.</p>
<pre><code class="hljs language-json">data <span class="hljs-string">"aws_caller_identity"</span> <span class="hljs-string">"current"</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
module <span class="hljs-string">"app_terraform_execution_role"</span> <span class="hljs-punctuation">{</span>
  source                            = <span class="hljs-string">"../../iam-role"</span>
  role_name                         = <span class="hljs-string">"apps-terraform-execution-role"</span>
  create_role                       = <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  role_requires_mfa                 = var.role_requires_mfa
  path                              = <span class="hljs-string">"/"</span>
  description                       = <span class="hljs-string">"Terraform Execution role"</span>
  trusted_role_arns                 = var.trusted_role_arns
  number_of_custom_role_policy_arns = <span class="hljs-number">1</span>
  policy = jsonencode(
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Version"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"2012-10-17"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Statement"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"Action"</span> <span class="hljs-punctuation">:</span> var.app_allowed_actions<span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Effect"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"Allow"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Resource"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"*"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Condition"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"StringEquals"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
              <span class="hljs-attr">"aws:RequestedRegion"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"us-east-1"</span>
            <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"Action"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
            <span class="hljs-string">"iam:*"</span>
          <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Effect"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"Allow"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"Resource"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"arn:aws:iam::${data.aws_caller_identity.current.account_id}:role/app/*"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>)
<span class="hljs-punctuation">}</span>

variable <span class="hljs-string">"app_allowed_actions"</span> <span class="hljs-punctuation">{</span>
  default = <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"cloudwatch:*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"iam:List*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"iam:Get*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"iam:Describe*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"logs:*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"logs:ListTagsLogGroup"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"s3:*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"secretsmanager:*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"ses:*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"sns:*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"ssm:*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"dynamodb:*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"sts:*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"route53:*"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-json">module <span class="hljs-string">"iam_policy"</span> <span class="hljs-punctuation">{</span>
  source      = <span class="hljs-string">"git::https://github.com/terraform-aws-modules/terraform-aws-iam.git//modules/iam-policy"</span>
  path        = var.path
  name        = <span class="hljs-string">"${var.role_name}-policy"</span>
  description = var.description
  policy      = var.policy
<span class="hljs-punctuation">}</span>

module <span class="hljs-string">"iam_assumable_role"</span> <span class="hljs-punctuation">{</span>
  source            = <span class="hljs-string">"git::https://github.com/terraform-aws-modules/terraform-aws-iam.git//modules/iam-assumable-role"</span>
  create_role       = var.create_role
  role_name         = var.role_name
  role_requires_mfa = var.role_requires_mfa
  trusted_role_arns = var.trusted_role_arns
  custom_role_policy_arns = <span class="hljs-punctuation">[</span>
    module.iam_policy.arn
  <span class="hljs-punctuation">]</span>
  number_of_custom_role_policy_arns = var.number_of_custom_role_policy_arns
<span class="hljs-punctuation">}</span>
</code></pre>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h1>AWS 인가: SSO를 사용할 예정이므로 장기적으로 유효한 자격 증명이 필요하지 않아요 🥳</h1>
<h1>로컬 구성 프로파일 구성 (~/.aws/config)</h1>
<h2>플랫폼</h2>
<p>요기 못생긴 닭과 계란 문제가 있는데... 깔끔한 AWS 계정이 있고, 플랫폼 인프라 프로비저닝에 권한을 부여해야 해요. 이건 IaC를 사용할 수 없어서 할 수 없는 문제에요.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>AWS 콘솔이나 CLI를 사용하여 Terraform 플랫폼에 대한 IAM 또는 IAM Identity Center 사용자를 수동으로 설정해야 합니다. 설정이 완료되면 IaC를 프로비저닝할 수 있습니다.</p>
<p>애플리케이션 프로비저닝을 위한 모든 역할과 정책(CICD 측면을 고려한)은 플랫폼 IaC에서 생성됩니다. 애플리케이션 실행을 위한 모든 역할과 정책(예: 람다 실행 역할)은 응용 프로그램 코드 내에서 생성됩니다.</p>
<pre><code class="hljs language-js">[profile terraform-platform]
sso_start_url=<span class="hljs-attr">https</span>:<span class="hljs-comment">//my-organization.awsapps.com/start</span>
sso_region=us-east-<span class="hljs-number">1</span>
sso_account_id=<span class="hljs-number">555555555555</span>
sso_role_name=<span class="hljs-title class_">PlatformTerraform</span>
region=us-east-<span class="hljs-number">1</span>
output=json
</code></pre>
<h2>응용 프로그램 리소스 (개발자가 쓰기 액세스를 얻는 곳)</h2>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<img src="/assets/img/2024-05-27-MyIaCAWSMulti-AccountProvisioningBluePrintBestPractices_1.png">
<pre><code class="hljs language-js">[profile terraform]
sso_start_url=<span class="hljs-attr">https</span>:<span class="hljs-comment">//my-organization.awsapps.com/start</span>
sso_region=us-east-<span class="hljs-number">1</span>
sso_account_id=<span class="hljs-number">555555555555</span>
sso_role_name=terraform-dev
region=us-east-<span class="hljs-number">1</span>
output=json

[profile terraform-test]
sso_start_url=<span class="hljs-attr">https</span>:<span class="hljs-comment">//my-organization.awsapps.com/start</span>
sso_region=us-east-<span class="hljs-number">1</span>
sso_account_id=<span class="hljs-number">555555555555</span>
sso_role_name=terraform-test
region=us-east-<span class="hljs-number">1</span>
output=json

[profile terraform-production]
sso_start_url=<span class="hljs-attr">https</span>:<span class="hljs-comment">//my-organization.awsapps.com/start</span>
sso_region=us-east-<span class="hljs-number">1</span>
sso_account_id=<span class="hljs-number">555555555555</span>
sso_role_name=terraform-production
region=us-east-<span class="hljs-number">1</span>
output=json
</code></pre>
<h1>AWS Backend &#x26; Provider Config</h1>
<p>어머머... 휴스턴, 문제 발생했어요.... AWS 계정 별로 다른 권한 세트가 있어요... 이제 더 이상 <code>profile = shared-services</code>를 사용할 수 없게 됐네요.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>혹시 매핑할까요? 아니면 환경과 접두사를 추가할까요?….</p>
<pre><code class="hljs language-js">remote_state {
  backend = <span class="hljs-string">"s3"</span>
 .....
  }
  config = {
   ........

    # 여기가 문제입니다
    profile        = <span class="hljs-string">"terraform"</span> # 혹은 <span class="hljs-string">"terraform-test"</span> 또는 <span class="hljs-string">"terraform-production"</span>
  }
}

generate <span class="hljs-string">"provider"</span> {
  path      = <span class="hljs-string">"provider.tf"</span>
  if_exists = <span class="hljs-string">"overwrite_terragrunt"</span>
  contents  = &#x3C;&#x3C;-<span class="hljs-variable constant_">EOF</span>
    provider <span class="hljs-string">"aws"</span> {
      ...
      ....
      profile = <span class="hljs-string">"terraform"</span> # 혹은 <span class="hljs-string">"terraform-test"</span> 또는 <span class="hljs-string">"terraform-production"</span>
    }
<span class="hljs-variable constant_">EOF</span>
}
</code></pre>
<h2>이것을 제거하고 환경 변수로 설정합시다</h2>
<pre><code class="hljs language-js">locals {
  # <span class="hljs-variable constant_">ENV</span>
  env_regex = <span class="hljs-string">"infrastructure/live/([a-zA-Z0-9-]+)/"</span>
  aws_env   = <span class="hljs-title function_">try</span>(<span class="hljs-title function_">regex</span>(local.<span class="hljs-property">env_regex</span>, <span class="hljs-title function_">get_original_terragrunt_dir</span>())[<span class="hljs-number">0</span>])
  # <span class="hljs-title class_">Application</span>
  app_name  = <span class="hljs-string">"my-application-platform"</span>
  component = <span class="hljs-string">"platform"</span>
  platform_apps = [
    <span class="hljs-string">"application_1"</span>,
    <span class="hljs-string">"application_2"</span>,
    <span class="hljs-string">"application_3"</span>
  ]
  # <span class="hljs-variable constant_">AWS</span> <span class="hljs-title class_">Organizations</span> <span class="hljs-title class_">Accounts</span>
  application_account_mapping = {
    dev        = <span class="hljs-number">222222222222</span>
    test       = <span class="hljs-number">111111111111</span>
    production = <span class="hljs-number">000000000000</span>
  }
  platform_account_mapping = {
    shared-services = <span class="hljs-number">555555555555</span>
    network         = <span class="hljs-string">"666666666666"</span>
    dns             = <span class="hljs-number">888888888888</span>
  }
  account_mapping = <span class="hljs-title function_">merge</span>(local.<span class="hljs-property">application_account_mapping</span>, local.<span class="hljs-property">platform_account_mapping</span>)

  # <span class="hljs-variable constant_">IAM</span> <span class="hljs-title class_">Roles</span> to <span class="hljs-title class_">Assume</span>
  account_role_name     = <span class="hljs-string">"terraform-role"</span>
  multiaccount_role_arn = <span class="hljs-string">"arn:aws:iam::555555555555:role/terraform-multiaccount-role"</span> # shared-services

  terraform_execution_role_mapping = {
    dev = <span class="hljs-string">"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_terraform-dev_ab1"</span>
    test = <span class="hljs-string">"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_terraform-test_ab2"</span>
    production = <span class="hljs-string">"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_terraform-production_ab3"</span>
  }

  # <span class="hljs-title class_">Other</span> <span class="hljs-title class_">Platform</span> <span class="hljs-title class_">Config</span> <span class="hljs-title class_">Values</span> <span class="hljs-title class_">Below</span>
  # ===================================
  # <span class="hljs-variable constant_">DNS</span>
  main_public_dns_zone_name     = <span class="hljs-string">"example.com"</span>
  env_public_dns_zone_subdomain = <span class="hljs-string">"${local.aws_env}"</span>
  environment_hosted_zone_name  = <span class="hljs-string">"${local.env_public_dns_zone_subdomain}.${local.main_public_dns_zone_name}"</span>
  acm_subject_alternative_names = [
    <span class="hljs-string">"${local.environment_hosted_zone_name}"</span>,
    <span class="hljs-string">"*.${local.environment_hosted_zone_name}"</span>,
    <span class="hljs-string">"*.api.${local.environment_hosted_zone_name}"</span>,
    <span class="hljs-string">"*.myapps.${local.environment_hosted_zone_name}"</span>,
    <span class="hljs-string">"*.apps.${local.environment_hosted_zone_name}"</span>
  ]
  # <span class="hljs-title class_">Region</span> and <span class="hljs-title class_">Zones</span>
  region = <span class="hljs-string">"us-east-1"</span>
  azs = [
    <span class="hljs-string">"us-east-1a"</span>,
    <span class="hljs-string">"us-east-1b"</span>,
    <span class="hljs-string">"us-east-1c"</span>
  ]
  platform_accounts = {
    dev = {
      cidr = <span class="hljs-string">"10.3.0.0/16"</span>
      private_subnets = [
        <span class="hljs-string">"10.3.1.0/24"</span>,
        <span class="hljs-string">"10.3.2.0/24"</span>,
        <span class="hljs-string">"10.3.3.0/24"</span>
      ]
    }
    test = {
      cidr = <span class="hljs-string">"10.2.0.0/16"</span>
      private_subnets = [
        <span class="hljs-string">"10.2.1.0/24"</span>,
        <span class="hljs-string">"10.2.2.0/24"</span>,
        <span class="hljs-string">"10.2.3.0/24"</span>
      ]
    }
    production = {
      cidr = <span class="hljs-string">"10.0.0.0/16"</span>
      private_subnets = [
        <span class="hljs-string">"10.0.1.0/24"</span>,
        <span class="hljs-string">"10.0.2.0/24"</span>,
        <span class="hljs-string">"10.0.3.0/24"</span>
      ]
    }
  }
}
remote_state {
  backend = <span class="hljs-string">"s3"</span>
  generate = {
    path      = <span class="hljs-string">"backend.tf"</span>
    if_exists = <span class="hljs-string">"overwrite_terragrunt"</span>
  }
  config = {
    bucket         = <span class="hljs-string">"terraform-state-shared-services"</span>
    key            = <span class="hljs-string">"${local.app_name}/${get_path_from_repo_root()}/terraform.tfstate"</span>
    region         = local.<span class="hljs-property">region</span>
    encrypt        = <span class="hljs-literal">true</span>
    dynamodb_table = <span class="hljs-string">"shared-services-lock-table"</span>
  }
}

generate <span class="hljs-string">"provider"</span> {
  path      = <span class="hljs-string">"provider.tf"</span>
  if_exists = <span class="hljs-string">"overwrite_terragrunt"</span>
  contents  = &#x3C;&#x3C;-<span class="hljs-variable constant_">EOF</span>
    provider <span class="hljs-string">"aws"</span> {
      region = <span class="hljs-string">"${local.region}"</span>
      allowed_account_ids = [
        <span class="hljs-string">"${local.account_mapping[local.aws_env]}"</span>
      ]
      assume_role {
        role_arn = <span class="hljs-string">"arn:aws:iam::${local.account_mapping[local.aws_env]}:role/${local.account_role_name}"</span>
      }
      default_tags {
        tags = {
          <span class="hljs-title class_">Environment</span> = <span class="hljs-string">"${local.aws_env}"</span>
          <span class="hljs-title class_">ManagedBy</span>   = <span class="hljs-string">"terraform"</span>
          <span class="hljs-title class_">DeployedBy</span>  = <span class="hljs-string">"terragrunt"</span>
          <span class="hljs-title class_">Creator</span>     = <span class="hljs-string">"${get_env("</span><span class="hljs-variable constant_">USER</span><span class="hljs-string">", "</span><span class="hljs-variable constant_">NOT_SET</span><span class="hljs-string">")}"</span>
          <span class="hljs-title class_">Application</span> = <span class="hljs-string">"${local.app_name}"</span>
          <span class="hljs-title class_">Component</span>   = <span class="hljs-string">"${local.component}"</span>
        }
      }
    }
<span class="hljs-variable constant_">EOF</span>
}
</code></pre>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h1>배포</h1>
<h2>플랫폼</h2>
<pre><code class="hljs language-js">aws sso login --profile terraform-platform
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">AWS_PROFILE</span>=terraform-platform

# 개발
cd infrastructure/live/dev/iam-roles
terragrunt init
terragrunt plan
terragrunt apply

# 테스트
cd infrastructure/live/test/iam-roles
terragrunt init
terragrunt plan
terragrunt apply

# 프로덕션
cd infrastructure/live/production/iam-roles
terragrunt init
terragrunt plan
terragrunt apply
</code></pre>
<h2>어플리케이션</h2>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>여기서는 방금 만든 새 역할을 사용합니다.</p>
<pre><code class="hljs language-js"># 개발
cd infrastructure/live/dev/app
aws sso login --profile terraform-dev
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">AWS_PROFILE</span>=terraform-dev
terragrunt init
terragrunt plan
terragrunt apply

# 테스트
cd infrastructure/live/test/app
aws sso login --profile terraform-test
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">AWS_PROFILE</span>=terraform-test
terragrunt init
terragrunt plan
terragrunt apply

# 프로덕션
cd infrastructure/live/production/app
aws sso login --profile terraform-production
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">AWS_PROFILE</span>=terraform-production
terragrunt init
terragrunt plan
terragrunt apply
</code></pre>
<h1>AWS Vault</h1>
<p>AWS Vault은 개발 환경에서 AWS 자격 증명을 안전하게 저장하고 액세스하는 도구입니다.</p>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>AWS Vault은 IAM 자격 증명을 사용자의 운영 체제 안전한 키 저장소에 저장한 다음 해당 자격 증명을 임시 자격 증명으로 생성하여 쉘 및 응용 프로그램에 노출합니다. 이는 AWS CLI 도구와 함께 보조적으로 사용되도록 설계되었으며 ~/.aws/config에 있는 프로필과 구성을 인식합니다.</p>
<pre><code class="hljs language-js">brew install --cask aws-vault
</code></pre>
<h2>따라서 이는 백엔드 구성 및 공급자에서 "프로필" 매개변수를 제거할 수 있음을 의미합니다.</h2>
<h1>AWS-Vault로 배포하기</h1>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h1>플랫폼</h1>
<pre><code class="hljs language-js"># <span class="hljs-title class_">Dev</span>
cd infrastructure/live/dev/iam-roles
aws-vault exec terraform-platform terragrunt init
aws-vault exec terraform-platform terragrunt plan
aws-vault exec terraform-platform terragrunt apply

# 테스트
cd infrastructure/live/test/iam-roles
aws-vault exec terraform-platform terragrunt init
aws-vault exec terraform-platform terragrunt plan
aws-vault exec terraform-platform terragrunt apply

# 프로덕션
cd infrastructure/live/production/iam-roles
aws-vault exec terraform-platform terragrunt init
aws-vault exec terraform-platform terragrunt plan
aws-vault exec terraform-platform terragrunt apply
</code></pre>
<h1>애플리케이션</h1>
<pre><code class="hljs language-js">cd infrastructure/live/dev/app
aws-vault exec terraform-dev terragrunt init
aws-vault exec terraform-dev terragrunt plan
aws-vault exec terraform-dev terragrunt apply

cd infrastructure/live/test/app
aws-vault exec terraform-test terragrunt init
aws-vault exec terraform-test terragrunt plan
aws-vault exec terraform-test terragrunt apply

cd infrastructure/live/production/app
aws-vault exec terraform-production terragrunt init
aws-vault exec terraform-production terragrunt plan
aws-vault exec terraform-production terragrunt apply
</code></pre>
<!-- ui-station 사각형 -->
<p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4877378276818686" data-ad-slot="7249294152" data-ad-format="auto" data-full-width-responsive="true"></ins></p>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<img src="/assets/img/2024-05-27-MyIaCAWSMulti-AccountProvisioningBluePrintBestPractices_2.png">
<h2>결과</h2>
<pre><code class="hljs language-js"> $ aws-vault exec terraform-production terragrunt apply



백엔드 초기화 중...

백엔드 <span class="hljs-string">"s3"</span>이 성공적으로 구성되었습니다! 백엔드 구성이 변경되지 않는 한 <span class="hljs-title class_">Terraform</span>은
자동으로이 백엔드를 사용할 것입니다.
모듈 초기화 중...
<span class="hljs-title function_">jobs_logs</span>(을)를 위해 <span class="hljs-attr">git</span>::<span class="hljs-attr">https</span>:<span class="hljs-comment">//github.com/terraform-aws-modules/terraform-aws-dynamodb-table.git을(를) 다운로드 중...</span>
- .<span class="hljs-property">terraform</span>/modules/logs에 jobs_logs
- ../lambda-execution-role에 lambda_execution_role
<span class="hljs-title function_">s3_bucket_files</span>(을)를 위해 <span class="hljs-attr">git</span>::<span class="hljs-attr">https</span>:<span class="hljs-comment">//github.com/terraform-aws-modules/terraform-aws-s3-bucket.git?ref=v3.6.1을(를) 다운로드 중...</span>
- .<span class="hljs-property">terraform</span>/modules/s3_bucket_files에 s3_bucket_files
- ../ssm-parameters-store에 ssm_params

제공자 플러그인 초기화 중...
- 종속성 잠금 파일에서 이전 버전의 hashicorp/aws 재사용
- hashicorp/aws v5<span class="hljs-number">.23</span><span class="hljs-number">.1</span> 설치 중...
- hashicorp/aws v5<span class="hljs-number">.23</span><span class="hljs-number">.1</span> 설치됨 (<span class="hljs-title class_">HashiCorp</span>에서 서명됨)

<span class="hljs-title class_">Terraform</span>이 성공적으로 초기화되었습니다!

이제 <span class="hljs-title class_">Terraform</span>을 사용하여 작업을 시작할 수 있습니다. <span class="hljs-string">"terraform plan"</span>을 실행하여
인프라에 필요한 모든 변경 사항을 확인해 보세요. 이제 모든 <span class="hljs-title class_">Terraform</span> 명령이
작동해야 합니다.

<span class="hljs-title class_">Terraform</span>을 위해 모듈이나 백엔드 구성을 설정 또는 변경한 경우,
작업 디렉터리를 다시 초기화하려면이 명령을 다시 실행하세요. 잊어 버린 경우
다른 명령이 필요한 경우이를 감지하고 다시 실행하라는 메시지가 표시됩니다.
상태 잠금 획득 중. 이 작업은 몇 분 정도 걸릴 수 있습니다...
<span class="hljs-variable language_">module</span>.<span class="hljs-property">lambda_execution_role</span>.<span class="hljs-property">data</span>.<span class="hljs-property">aws_iam_policy_document</span>.<span class="hljs-property">lambda_assume_role_policy</span>: 읽는 중...
<span class="hljs-variable language_">module</span>.<span class="hljs-property">s3_bucket_files</span>.<span class="hljs-property">data</span>.<span class="hljs-property">aws_caller_identity</span>.<span class="hljs-property">current</span>: 읽는 중...
<span class="hljs-variable language_">module</span>.<span class="hljs-property">s3_bucket_files</span>.<span class="hljs-property">data</span>.<span class="hljs-property">aws_canonical_user_id</span>.<span class="hljs-property">this</span>: 읽는 중...
data.<span class="hljs-property">aws_caller_identity</span>.<span class="hljs-property">current</span>: 읽는 중...
<span class="hljs-variable language_">module</span>.<span class="hljs-property">s3_bucket_files</span>.<span class="hljs-property">aws_s3_bucket</span>.<span class="hljs-property">this</span>[<span class="hljs-number">0</span>]: 상태 새로 고침 중... [id=my-company-myapp-files-dev]
<span class="hljs-variable language_">module</span>.<span class="hljs-property">jobs_logs</span>.<span class="hljs-property">aws_dynamodb_table</span>.<span class="hljs-property">this</span>[<span class="hljs-number">0</span>]: 상태 새로 고침 중... [id=my-company-myapp-logs]
<span class="hljs-variable language_">module</span>.<span class="hljs-property">lambda_execution_role</span>.<span class="hljs-property">data</span>.<span class="hljs-property">aws_iam_policy_document</span>.<span class="hljs-property">lambda_assume_role_policy</span>: <span class="hljs-number">0</span>초 후에 읽기 완료 [id=<span class="hljs-number">000000000</span>]
data.<span class="hljs-property">aws_caller_identity</span>.<span class="hljs-property">current</span>: <span class="hljs-number">0</span>초 후에 읽기 완료 [id=<span class="hljs-number">000000000</span>]
<span class="hljs-variable language_">module</span>.<span class="hljs-property">lambda_execution_role</span>.<span class="hljs-property">data</span>.<span class="hljs-property">aws_iam_policy_document</span>.<span class="hljs-property">inline_policy</span>: 읽는 중...
<span class="hljs-variable language_">module</span>.<span class="hljs-property">s3_bucket_files</span>.<span class="hljs-property">data</span>.<span class="hljs-property">aws_caller_identity</span>.<span class="hljs-property">current</span>: <span class="hljs-number">0</span>초 후에 읽기 완료 [id=<span class="hljs-number">000000000</span>]
<span class="hljs-variable language_">module</span>.<span class="hljs-property">lambda_execution_role</span>.<span class="hljs-property">data</span>.<span class="hljs-property">aws_iam_policy_document</span>.<span class="hljs-property">inline_policy</span>: <span class="hljs-number">0</span>초 후에 읽기 완료 [id=<span class="hljs-number">000000000</span>]
<span class="hljs-variable language_">module</span>.<span class="hljs-property">lambda_execution_role</span>.<span class="hljs-property">aws_iam_role</span>.<span class="hljs-property">lambda_execution_role</span>: 상태 새로 고침 중... [id=my-company-myapp-lambda-execution-role]
<span class="hljs-variable language_">module</span>.<span class="hljs-property">s3_bucket_files</span>.<span class="hljs-property">data</span>.<span class="hljs-property">aws_canonical_user_id</span>.<span class="hljs-property">this</span>: <span class="hljs-number">1</span>초 후에 읽기 완료 [id=51528157cefbacf17d3cc90bf31e07f8f463cadfbf31739f6b264afac67fb2ce]
<span class="hljs-variable language_">module</span>.<span class="hljs-property">s3_bucket_files</span>.<span class="hljs-property">aws_s3_bucket_public_access_block</span>.<span class="hljs-property">this</span>[<span class="hljs-number">0</span>]: 상태 새로 고침 중... [id=my-company-myapp-files-dev]
<span class="hljs-variable language_">module</span>.<span class="hljs-property">ssm_params</span>.<span class="hljs-property">aws_ssm_parameter</span>.<span class="hljs-property">this</span>[<span class="hljs-string">"2"</span>]: 상태 새로 고침 중... [id=<span class="hljs-regexp">/app/my</span>app/lambda_role]
<span class="hljs-variable language_">module</span>.<span class="hljs-property">ssm_params</span>.<span class="hljs-property">aws_ssm_parameter</span>.<span class="hljs-property">this</span>[<span class="hljs-string">"3"</span>]: 상태 새로 고침 중... [id=<span class="hljs-regexp">/app/my</span>app/event_bridge_name]
<span class="hljs-variable language_">module</span>.<span class="hljs-property">ssm_params</span>.<span class="hljs-property">aws_ssm_parameter</span>.<span class="hljs-property">this</span>[<span class="hljs-string">"4"</span>]: 상태 새로 고침 중... [id=<span class="hljs-regexp">/app/my</span>app/logs]
<span class="hljs-variable language_">module</span>.<span class="hljs-property">ssm_params</span>.<span class="hljs-property">aws_ssm_parameter</span>.<span class="hljs-property">this</span>[<span class="hljs-string">"1"</span>]: 상태 새로 고침 중... [id=<span class="hljs-regexp">/app/my</span>app/s3_bucket_files]

변경 사항이 없습니다. 인프라가 구성과 일치합니다.

<span class="hljs-title class_">Terraform</span>은 실제 인프라를 구성과 비교하고 차이점을 찾았으며 변경 사항이 필요하지 않습니다.
상태 잠금 해제 중. 이 작업은 몇 분 정도 걸릴 수 있습니다...
</code></pre>
<p>읽어 주셔서 감사합니다!</p>
</body>
</html>
</div></article></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"내 IaC AWS 다중 계정 프로비저닝 블루프린트, 최고의 관행","description":"","date":"2024-05-27 17:37","slug":"2024-05-27-MyIaCAWSMulti-AccountProvisioningBluePrintBestPractices","content":"\n## SSO 사용자와 함께 Terraform 실행 역할을 가정하는 방법.\n\n이 기사에서는 IaC (Terraform) 프로젝트의 구조를 보여드리겠습니다. 이 프로젝트는 보통 여기저기 흩어져 있는 값 파일이 필요하지 않도록 구성됩니다. 또한 하나의 구성 파일만으로 모든 환경을 제어하는 방법과 플랫폼과 응용프로그램 인프라 코드를 어떻게 분리하는지도 보여드리겠습니다.\n\n## 이 기사에서 다루는 주제들:\n\n- 여러 계정 배포 도구의 우승자인 Terragrunt\n- Terraform 및 Terragrunt의 협력\n- 응용프로그램 인프라 Terragrunt Main 구성 파일 (Locals/Backend S3/AWS Provider)\n- Terraform 실행을 위한 AWS Identity Center (SSO) 권한 집합 (AWS 키와 비밀번호가 영구적이지 않는 역할으로 가정)\n- 플랫폼 vs 응용프로그램 인프라\n- 플랫폼 인프라 Terragrunt Main 구성 파일 (Locals/Backend S3/AWS Provider)\n- Terraform 실행 역할 생성 (응용프로그램 인프라 배포를 위해) IAM 액세스 Identity (SSO)로 프로비저닝된 역할의 신뢰 정책\n- 안전하게 SSO AWS 임시 자격 증명 구성\n- AWS-VAULT\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n# 테라그런트\n\n내 의견으로 테라그런트는 인프라를 위한 다중 계정 배포 구조화에 사용 가능한 (내가 아는 한) 최고 도구입니다.\n\n테라그런트 문서에 따르면 코드를 다음과 같이 구조화하는 것을 제안합니다:\n\n![테라그런트 구조](/assets/img/2024-05-27-MyIaCAWSMulti-AccountProvisioningBluePrintBestPractices_0.png)\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n그러나 주의해야 할 점은 terragrunt를 자원을 조정하는 데 과도하게 사용하지 않아야 합니다.\n\nTerraform은 여러 모듈을 하나로 번들링하여 응용 프로그램이나 플랫폼 서비스를 사용하는 것을 목적으로 합니다.\n\nTerragrunt는 이미 통합된 Terraform 모듈을 서로 다른 환경에 배포하는 데만 사용해야 합니다.\n\n# 응용 프로그램 모듈을 생성하는 데 Terraform을 사용하고, 다른 환경에 배포하는 데 Terragrunt를 사용하세요.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n애플리케이션 모듈(왼쪽)을 만들 때 Terragrunt를 사용하지 마세요. 그렇지 않으면 복잡해질 수 있고 테라폼 상태가 앱 단위가 아닌 구성 요소 단위로 생성될 수 있습니다. Terragrunt를 사용하는 경우 배포(오른쪽)에만 사용하세요.\n\n과거에 저희가 한 실수를 피하기 위해 이렇게 말씀 드리는데요. 저는 Terragrunt 내부의 컴포넌트에 너무 많이 나눠 애플리케이션 인프라를 분리하면서 개별 리소스를 더 잘 관리하려고 했지만 더 많은 문제를 발생시켰습니다.\n\n# 왜 이런 문제가 발생할 수 있나요?\n\n저의 몇몇 프로젝트 중 하나에서 저는 Terragrunt에서 Terraform 워크스페이스로 다중 계정 배포 방법을 변경하는 작업을 맡게 되었습니다. 이것은 서로 다른 AWS 환경을 관리하기 위해 조직의 표준 절차에 맞추기 위한 것입니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n이 프로세스는 Terragrunt가 단순히 테라폼 래퍼일 뿐이기 때문에 매우 간단할 수 있었을 것입니다.\n\n하지만 앱을 구성 요소로 분할하고 그 구성 요소가 모듈 내에 존재하면 상태 파일을 병합해야 하는 악몽이 될 수 있습니다.\n\n그래서 Terragrunt 풋프린트를 최소화하려면...\n\nT\nerraform은 애플리케이션이나 플랫폼 서비스를 위해 서로 다른 모듈을 번들로 묶을 것으로 의도되어야 합니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n## 예시: 최소한의 애플리케이션 인프라 리소스:\n\n```js\ndata \"aws_caller_identity\" \"current\" {}\n\nlocals {\n  aws_account_id = data.aws_caller_identity.current.account_id\n}\n\nmodule \"app_logs\" {\n  source = \"git::https://github.com/terraform-aws-modules/terraform-aws-dynamodb-table.git//\"\n  name         = \"${var.app_name}-logs\"\n  billing_mode = \"PAY_PER_REQUEST\"\n  hash_key     = \"organization\"\n  range_key    = \"job_id\"\n\n  server_side_encryption_enabled = true\n  deletion_protection_enabled    = false\n\n  attributes = [\n    {\n      name = \"organization\"\n      type = \"S\"\n    },\n    {\n      name = \"job_id\"\n      type = \"S\"\n    }\n  ]\n}\n\nmodule \"app_users\" {\n  source = \"git::https://github.com/terraform-aws-modules/terraform-aws-dynamodb-table.git//\"\n  # 필요 시 다른 DynamoDB 테이블을 여기에 추가\n}\n\nmodule \"lambda_execution_role\" {\n  source = \"../lambda-execution-role\"\n  aws_account_id = local.aws_account_id\n  app_name       = var.app_name\n  env            = var.env\n}\n\nmodule \"s3_bucket_files\" {\n  source = \"git::https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git//?ref=v3.6.1\"\n  bucket                  = var.env == \"production\" ? \"my-company-app-${var.app_name}-files\" : \"my-company-app-${var.app_name}-files-${var.env}\"\n  block_public_acls       = \"true\"\n  block_public_policy     = \"true\"\n  ignore_public_acls      = \"true\"\n  restrict_public_buckets = \"true\"\n}\n\nmodule \"another_s3_bucket_files\" {\n  source = \"git::https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git//?ref=v3.6.1\"\n  # 필요 시 다른 S3 버켓을 여기에 추가\n}\n\n# SSM Params는 서버리스나 다른 도구에 값들을 전달하는 좋은 방법입니다.\nmodule \"ssm_params\" {\n  source = \"../ssm-parameters-store\"\n  parameters = {\n    1 = {\n      name  = \"/app/${var.app_name}/s3_bucket_files\"\n      value = module.s3_bucket_files.s3_bucket_id\n    }\n    2 = {\n      name  = \"/app/${var.app_name}/lambda_role\"\n      value = module.lambda_execution_role.role_arn\n    }\n    3 = {\n      name  = \"/app/${var.app_name}/event_bridge_name\"\n      value = \"${var.app_name}-event-bus\"\n    }\n    4 = {\n      name  = \"/app/${var.app_name}/logs\"\n      value = module.app_logs.dynamodb_table_id\n    }\n  }\n}\n```\n\n이 모듈에서는 다른 모듈을 호출하여 다음과 같은 종류의 리소스를 생성합니다:\n\n- DynamoDB 테이블\n- S3 버켓\n- IAM Lambda 실행 역할\n- 이전에 생성된 리소스의 ARN 또는 ID를 보관하는 SSM 매개변수\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n여기서 빠진 것은 다른 기사에서 보여준 것처럼 백엔드 S3 및 AWS 제공자 구성입니다... 여기서 Terragrunt가 등장합니다...\n\n# 플랫폼 대 응용 프로그램\n\n이러한 염려 사항의 분리는 서로 다른 GIT 저장소를 가지거나 단순히 동일한 Repo 내에서 다른 프로젝트로 취급함을 의미합니다... 여기서 중요한 것은 응용 프로그램 인프라 코드가 플랫폼 인프라 코드에 직접적인 종속성을 포함해서는 안된다는 것입니다... 따라서 이것은 응용 프로그램 소스 코드(BE/FE)와 함께 쉽게 추출될 수 있습니다...\n\n하지만 우리는 어떻게 알 수 있을까요? 무엇을 플랫폼 인프라에 위치시키고 어떤 것을 애플리케이션 인프라에 위치시켜야 할지요?\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n## 플랫폼 인프라스트럭처:\n\n플랫폼 인프라스트럭처는 보다 포괄적이며 조직 전체에서 여러 응용 프로그램을 지원하는 기본 구성 요소와 서비스를 지칭합니다. 일반적으로 다음을 포함합니다:\n\n- CI/CD용 IAM 역할\n- Route53 호스팅 영역\n- 네트워킹: VPC, 방화벽 및 NAT와 같은 구성 요소\n- 모니터링 및 로깅: Prometheus, Grafana 또는 CloudWatch와 같은 요소\n\n## 응용 프로그램 인프라스트럭처:\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n응용 프로그램 인프라는 특정 응용 프로그램 또는 응용 프로그램 세트를 실행하는 데 필요한 구성 요소와 리소스로 구성됩니다. 이는 종종 다음을 포함합니다:\n\n- EC2 인스턴스, 람다 함수\n- 트랜짓 게이트웨이, 로드 밸런서\n- 앱 데이터베이스: MySQL, PostgreSQL 또는 MongoDB와 같은 데이터베이스\n- 메시지 대기열: SQS 또는 Kafka와 같은 메시지 대기열\n\n## 주요 포인트는 개별 앱의 요구 사항에 맞추는 것입니다.\n\n예를 들어 Serverless Framework나 AWS SAM이 있습니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n서버리스 애플리케이션에 대해서는 테라폼과 서버리스를 사용하는 멋진 가이드가 있어요.\n\n## 테라폼을 사용하지 않고 다른 도구를 사용할 때, 서버리스 프레임워크나 SAM같은:\n\n# 애플리케이션 IaC를 위한 Terragrunt\n\n‘live‘ 디렉토리 내에서 배포할 환경을 지정하세요.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n```js\n├── README.md\n├── live\n│   ├── _env\n│   │   └── app.hcl\n│   ├── dev\n│   │   └── app\n│   │       └── terragrunt.hcl \u003c--- this is not a config file, but an environment resource file\n│   ├── production\n│   │   └── app\n│   │       └── terragrunt.hcl\n│   ├── terragrunt.hcl         \u003c------ Terragrunt config file (Unique)\n│   └── test\n│       └── app\n│           └── terragrunt.hcl\n└── modules\n    ├── lambda-execution-role\n    │   ├── data.tf\n    │   ├── main.tf\n    │   ├── output.tf\n    │   └── variables.tf\n    ├── application_1\n    │   ├── main.tf\n    │   └── variables.tf\n    └── ssm-parameters-store\n        ├── main.tf\n        └── variables.tf\n```\n\n# 유일무이한 terragrunt.hcl 설정 파일\n\n여기에는 하나의 terragrunt.hcl 구성 파일을 사용하여 멀티 계정 배포를 구성하는 방법이 나와 있어요.\n\n테라폼 워크스페이스 구성과 Terragrunt 구성을 비교해보겠습니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n로컬 변수 정의는 \"거의\" 같은 상태로 유지되고 있으며, Terragrunt Live 디렉터리를 다른 환경의 이름으로 구조화하고 있습니다.\n\nAWS 환경 이름과 디렉터리 이름이 일치하므로 간단한 정규 표현식으로 실행 시간에 환경 값을 추론할 수 있습니다.\n\n## infrastructure/live/terragrunt.hcl\n\n여기에 완전한 terragrunt.hcl 파일이 있습니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\nbackend.tf와 provider.tf 생성기에서 \"profile\" 매개변수를 주목해주세요. 다음 섹션에서 이들을 제거할 예정입니다.\n\n```js\nlocals {\n  # 환경\n  env_regex = \"infrastructure/live/([a-zA-Z0-9-]+)/\"\n  aws_env   = try(regex(local.env_regex, get_original_terragrunt_dir())[0])\n  # 어플리케이션\n  app_name = \"my-app\"\n  component = \"api\"\n\n  # AWS 조직 계정\n  account_mapping = {\n    dev             = 22222222222\n    test            = 111111111111\n    production      = 000000000000\n    shared-services = 555555555555\n  }\n  # 가정할 IAM 역할\n  account_role_name     = \"apps-terraform-execution-role\" # \u003c--- 가정할 역할\n  # 지역 및 가용 영역\n  region = \"us-east-1\"\n}\nremote_state {\n  backend = \"s3\"\n  generate = {\n    path      = \"backend.tf\"\n    if_exists = \"overwrite_terragrunt\"\n  }\n  config = {\n    bucket         = \"terraform-state-shared-services\"\n    key            = \"${local.app_name}/${get_path_from_repo_root()}/terraform.tfstate\"\n    region         = local.region\n    profile        = \"shared-services\" #\u003c----- AWS 프로필\n    encrypt        = true\n    dynamodb_table = \"shared-services-lock-table\"\n  }\n}\ngenerate \"provider\" {\n  path      = \"provider.tf\"\n  if_exists = \"overwrite_terragrunt\"\n  contents  = \u003c\u003c-EOF\n    provider \"aws\" {\n      region = \"${local.region}\"\n      profile = \"shared-services\" #\u003c----- AWS 프로필\n      allowed_account_ids = [\n        \"${local.account_mapping[local.aws_env]}\"\n      ]\n      assume_role {\n        role_arn = \"arn:aws:iam::${local.account_mapping[local.aws_env]}:role/${local.account_role_name}\"\n      }\n      default_tags {\n        tags = {\n          Environment = \"${local.aws_env}\"\n          ManagedBy   = \"terraform\"\n          DeployedBy  = \"terragrunt\"\n          Creator     = \"${get_env(\"USER\", \"NOT_SET\")}\"\n          Application = \"${local.app_name}\"\n          Component   = \"${local.component}\"\n        }\n      }\n    }\nEOF\n}\n```\n\nTerragrunt가 생성기에 보간을 허용하므로 모든 대상 AWS 계정에 대해 매개변수화할 수 있습니다.\n\n## infrastructure/live/\\_env/app.hcl\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n테이블 태그를 마크다운 형식으로 변경해주세요.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n## Terraform 프로비저닝 인프라에 필요한 역할 설정하기\n\n```js\naccount_role_name     = \"apps-terraform-execution-role\" # \u003c--- 전환할 역할\n```\n\n또한 이전 게시물에서 AWS 공유 서비스 계정에 terraform-multiaccount-role 및 각 작업 부하 계정(개발, 테스트, 프로덕션)에 terraform-role을 설정하는 방법을 설명했습니다.\n\n그러나 이 설정은 하나의 엔터티(terraform-multiaccount-role)가 모든 계정에서 terraform-role을 가정(Assume)할 수 있도록 허용합니다. 이는 개발팀이 자체 인프라를 개발 환경에서 관리할 수 있도록 하려는 경우에는 편리하지 않습니다. 따라서 개발 팀이 Dev 계정에서만 역할을 전환할 수 있는 엔터티와 Test 및 Production에 대한 다른 엔터티가 필요합니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n## AWS Identity Center 위임된 관리자 계정 및 권한 집합\n\nAWS 계정에 권한 집합을 만드는 방법 및 권한 집합을 AWS 계정에 할당하는 방법에 대한 문서를 따르세요.\n\n다음과 같은 권한 집합을 만들어 보세요: terraform-dev, terraform-test, terraform-production.\n\n각 권한 집합에 대한 대상 계정에 다음과 같은 내부 정책을 만드세요. 허용하는 권한 집합(Identity 계정에 설정된)이 공유 서비스 계정에 배포되어 다음 계정에서 역할을 가정할 수 있도록합니다:\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n이렇게 보이는 3가지 다른 권한 세트가 있습니다:\n\n```js\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": \"sts:AssumeRole\",\n            \"Resource\": \"arn:aws:iam::000000000000:role/apps-terraform-execution-role\"\n        },\n        {\n            \"Sid\": \"Statement1\",\n            \"Effect\": \"Allow\",\n            \"Action\": [\n              \"s3:GetObject\",\n              \"s3:PutObject\",\n              \"s3:ListBucket\"\n            ],\n            \"Resource\": [\n                \"arn:aws:s3:::terraform-state-shared-services*\",\n                \"arn:aws:s3:::terraform-state-shared-services/*\"\n            ]\n        },\n        {\n            \"Sid\": \"Statement2\",\n            \"Effect\": \"Allow\",\n            \"Action\": [\n              \"dynamodb:GetItem\",\n              \"dynamodb:PutItem\",\n              \"dynamodb:DeleteItem\"\n            ],\n            \"Resource\": [\n                \"arn:aws:dynamodb:us-east-1:555555555555:table/shared-services-lock-table\"\n            ]\n        }\n    ]\n}\n```\n\n각 워크로드 계정에 apps-terraform-execution-role을 만들고 SSO 사용자가 역할을 할 수 있도록 허용합니다.\n\n참고: \"terraform-production\"에게도 Test에서 역할을 수행할 수 있도록 정책을 약간 조정할 수도 있습니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n# 플랫폼 인프라 (IaC)\n\n최소한의 애플리케이션을 위해 DNS, 네트워킹 및 식별 관리 역할 및 정책과 같은 플랫폼 리소스를 제공해야 합니다.\n\n```js\n➜  live git:(main) ✗ tree\n.\n├── _env\n│   ├── route53-zones.hcl\n│   └── iam-roles.hcl\n├── dev\n│   ├── iam-roles\n│   │   └── terragrunt.hcl\n│   ├── route53-zones\n│   │   └── terragrunt.hcl\n│   └── platform\n│       └── terragrunt.hcl\n├── network\n│   ├── dmz\n│   │   └── terragrunt.hcl\n│   ├── network-egress\n│   │   └── terragrunt.hcl\n│   ├── transitgateway-dmz-vpc-attachment\n│   │   └── terragrunt.hcl\n│   └── transitgateway-egress-vpc-attachment\n│       ├── mystate.tfstate\n│       └── terragrunt.hcl\n├── production\n│   ├── iam-roles\n│   │   └── terragrunt.hcl\n│   └── platform\n│       └── terragrunt.hcl\n├── terragrunt.hcl\n└── test\n    ├── iam-roles\n    │   └── terragrunt.hcl\n    ├── route53-zones\n    │   └── terragrunt.hcl\n    └── platform\n        └── terragrunt.hcl\n```\n\n## 로컬 변수\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n여러 개의 계정 값들을 하나의 장소에서 중앙화하는 방법의 예시입니다:\n\n```js\nlocals {\n  # 환경 변수\n  env_regex = \"infrastructure/live/([a-zA-Z0-9-]+)/\"\n  aws_env   = try(regex(local.env_regex, get_original_terragrunt_dir())[0])\n  # 어플리케이션\n  app_name  = \"my-application-platform\"\n  component = \"platform\"\n  platform_apps = [\n    \"application_1\",\n    \"application_2\",\n    \"application_3\"\n  ]\n  # AWS 조직 계정\n  application_account_mapping = {\n    dev        = 222222222222\n    test       = 111111111111\n    production = 000000000000\n  }\n  platform_account_mapping = {\n    shared-services = 555555555555\n    network         = \"666666666666\"\n    dns             = 888888888888\n  }\n  account_mapping = merge(local.application_account_mapping, local.platform_account_mapping)\n\n  # 가정할 IAM 역할\n  account_role_name     = \"terraform-role\"\n  multiaccount_role_arn = \"arn:aws:iam::555555555555:role/terraform-multiaccount-role\" # shared-services\n\n  terraform_execution_role_mapping = {\n    dev = \"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_terraform-dev_ab1\"\n    test = \"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_terraform-test_ab2\"\n    production = \"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_terraform-production_ab3\"\n  }\n\n  # 기타 플랫폼 구성 값들\n  # ===================================\n  # DNS\n  main_public_dns_zone_name     = \"example.com\"\n  env_public_dns_zone_subdomain = \"${local.aws_env}\"\n  environment_hosted_zone_name  = \"${local.env_public_dns_zone_subdomain}.${local.main_public_dns_zone_name}\"\n  acm_subject_alternative_names = [\n    \"${local.environment_hosted_zone_name}\",\n    \"*.${local.environment_hosted_zone_name}\",\n    \"*.api.${local.environment_hosted_zone_name}\",\n    \"*.myapps.${local.environment_hosted_zone_name}\",\n    \"*.apps.${local.environment_hosted_zone_name}\"\n  ]\n  # 지역 및 가용 영역\n  region = \"us-east-1\"\n  azs = [\n    \"us-east-1a\",\n    \"us-east-1b\",\n    \"us-east-1c\"\n  ]\n  platform_accounts = {\n    dev = {\n      cidr = \"10.3.0.0/16\"\n      private_subnets = [\n        \"10.3.1.0/24\",\n        \"10.3.2.0/24\",\n        \"10.3.3.0/24\"\n      ]\n    }\n    test = {\n      cidr = \"10.2.0.0/16\"\n      private_subnets = [\n        \"10.2.1.0/24\",\n        \"10.2.2.0/24\",\n        \"10.2.3.0/24\"\n      ]\n    }\n    production = {\n      cidr = \"10.0.0.0/16\"\n      private_subnets = [\n        \"10.0.1.0/24\",\n        \"10.0.2.0/24\",\n        \"10.0.3.0/24\"\n      ]\n    }\n  }\n}\n```\n\n```js\ninclude \"root\" {\n  path = find_in_parent_folders()\n}\n\ninclude \"env\" {\n  path = \"../../_env/iam-roles.hcl\"\n}\n```\n\n```js\nlocals {\n  env_vars = read_terragrunt_config(find_in_parent_folders(\"terragrunt.hcl\"))\n  env      = local.env_vars.locals.aws_env\n}\n\nterraform {\n  source = \"../../../modules//platform/iam-roles\"\n}\n\ninputs = {\n  trusted_role_arns = [\n    local.env_vars.locals.terraform_execution_role_mapping[local.env]\n  ]\n}\n```\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n## infrastructure/modules/platform/iam-roles\n\n\"Iam:_\"에 대한 범위를 좁히고 있음을 알려드립니다. 이는 Terraform이 응용 프로그램을 위해 Role 및 정책을 생성, 제거 및 업데이트해야하기 때문에 필요한 권한입니다. 그러나 이 경우 \":role/app/_\" 내의 Roles 및 Policies로 범위를 좁힐 수 있습니다.\n\n```json\ndata \"aws_caller_identity\" \"current\" {}\nmodule \"app_terraform_execution_role\" {\n  source                            = \"../../iam-role\"\n  role_name                         = \"apps-terraform-execution-role\"\n  create_role                       = true\n  role_requires_mfa                 = var.role_requires_mfa\n  path                              = \"/\"\n  description                       = \"Terraform Execution role\"\n  trusted_role_arns                 = var.trusted_role_arns\n  number_of_custom_role_policy_arns = 1\n  policy = jsonencode(\n    {\n      \"Version\" : \"2012-10-17\",\n      \"Statement\" : [\n        {\n          \"Action\" : var.app_allowed_actions,\n          \"Effect\" : \"Allow\",\n          \"Resource\" : \"*\",\n          \"Condition\" : {\n            \"StringEquals\" : {\n              \"aws:RequestedRegion\" : \"us-east-1\"\n            }\n          }\n        },\n        {\n          \"Action\" : [\n            \"iam:*\"\n          ],\n          \"Effect\" : \"Allow\",\n          \"Resource\" : \"arn:aws:iam::${data.aws_caller_identity.current.account_id}:role/app/*\"\n        }\n      ]\n  })\n}\n\nvariable \"app_allowed_actions\" {\n  default = [\n    \"cloudwatch:*\",\n    \"iam:List*\",\n    \"iam:Get*\",\n    \"iam:Describe*\",\n    \"logs:*\",\n    \"logs:ListTagsLogGroup\",\n    \"s3:*\",\n    \"secretsmanager:*\",\n    \"ses:*\",\n    \"sns:*\",\n    \"ssm:*\",\n    \"dynamodb:*\",\n    \"sts:*\",\n    \"route53:*\"\n  ]\n}\n```\n\n```json\nmodule \"iam_policy\" {\n  source      = \"git::https://github.com/terraform-aws-modules/terraform-aws-iam.git//modules/iam-policy\"\n  path        = var.path\n  name        = \"${var.role_name}-policy\"\n  description = var.description\n  policy      = var.policy\n}\n\nmodule \"iam_assumable_role\" {\n  source            = \"git::https://github.com/terraform-aws-modules/terraform-aws-iam.git//modules/iam-assumable-role\"\n  create_role       = var.create_role\n  role_name         = var.role_name\n  role_requires_mfa = var.role_requires_mfa\n  trusted_role_arns = var.trusted_role_arns\n  custom_role_policy_arns = [\n    module.iam_policy.arn\n  ]\n  number_of_custom_role_policy_arns = var.number_of_custom_role_policy_arns\n}\n```\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n# AWS 인가: SSO를 사용할 예정이므로 장기적으로 유효한 자격 증명이 필요하지 않아요 🥳\n\n# 로컬 구성 프로파일 구성 (~/.aws/config)\n\n## 플랫폼\n\n요기 못생긴 닭과 계란 문제가 있는데... 깔끔한 AWS 계정이 있고, 플랫폼 인프라 프로비저닝에 권한을 부여해야 해요. 이건 IaC를 사용할 수 없어서 할 수 없는 문제에요.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\nAWS 콘솔이나 CLI를 사용하여 Terraform 플랫폼에 대한 IAM 또는 IAM Identity Center 사용자를 수동으로 설정해야 합니다. 설정이 완료되면 IaC를 프로비저닝할 수 있습니다.\n\n애플리케이션 프로비저닝을 위한 모든 역할과 정책(CICD 측면을 고려한)은 플랫폼 IaC에서 생성됩니다. 애플리케이션 실행을 위한 모든 역할과 정책(예: 람다 실행 역할)은 응용 프로그램 코드 내에서 생성됩니다.\n\n```js\n[profile terraform-platform]\nsso_start_url=https://my-organization.awsapps.com/start\nsso_region=us-east-1\nsso_account_id=555555555555\nsso_role_name=PlatformTerraform\nregion=us-east-1\noutput=json\n```\n\n## 응용 프로그램 리소스 (개발자가 쓰기 액세스를 얻는 곳)\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n\u003cimg src=\"/assets/img/2024-05-27-MyIaCAWSMulti-AccountProvisioningBluePrintBestPractices_1.png\" /\u003e\n\n```js\n[profile terraform]\nsso_start_url=https://my-organization.awsapps.com/start\nsso_region=us-east-1\nsso_account_id=555555555555\nsso_role_name=terraform-dev\nregion=us-east-1\noutput=json\n\n[profile terraform-test]\nsso_start_url=https://my-organization.awsapps.com/start\nsso_region=us-east-1\nsso_account_id=555555555555\nsso_role_name=terraform-test\nregion=us-east-1\noutput=json\n\n[profile terraform-production]\nsso_start_url=https://my-organization.awsapps.com/start\nsso_region=us-east-1\nsso_account_id=555555555555\nsso_role_name=terraform-production\nregion=us-east-1\noutput=json\n```\n\n# AWS Backend \u0026 Provider Config\n\n어머머... 휴스턴, 문제 발생했어요.... AWS 계정 별로 다른 권한 세트가 있어요... 이제 더 이상 `profile = shared-services`를 사용할 수 없게 됐네요.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n혹시 매핑할까요? 아니면 환경과 접두사를 추가할까요?….\n\n```js\nremote_state {\n  backend = \"s3\"\n .....\n  }\n  config = {\n   ........\n\n    # 여기가 문제입니다\n    profile        = \"terraform\" # 혹은 \"terraform-test\" 또는 \"terraform-production\"\n  }\n}\n\ngenerate \"provider\" {\n  path      = \"provider.tf\"\n  if_exists = \"overwrite_terragrunt\"\n  contents  = \u003c\u003c-EOF\n    provider \"aws\" {\n      ...\n      ....\n      profile = \"terraform\" # 혹은 \"terraform-test\" 또는 \"terraform-production\"\n    }\nEOF\n}\n```\n\n## 이것을 제거하고 환경 변수로 설정합시다\n\n```js\nlocals {\n  # ENV\n  env_regex = \"infrastructure/live/([a-zA-Z0-9-]+)/\"\n  aws_env   = try(regex(local.env_regex, get_original_terragrunt_dir())[0])\n  # Application\n  app_name  = \"my-application-platform\"\n  component = \"platform\"\n  platform_apps = [\n    \"application_1\",\n    \"application_2\",\n    \"application_3\"\n  ]\n  # AWS Organizations Accounts\n  application_account_mapping = {\n    dev        = 222222222222\n    test       = 111111111111\n    production = 000000000000\n  }\n  platform_account_mapping = {\n    shared-services = 555555555555\n    network         = \"666666666666\"\n    dns             = 888888888888\n  }\n  account_mapping = merge(local.application_account_mapping, local.platform_account_mapping)\n\n  # IAM Roles to Assume\n  account_role_name     = \"terraform-role\"\n  multiaccount_role_arn = \"arn:aws:iam::555555555555:role/terraform-multiaccount-role\" # shared-services\n\n  terraform_execution_role_mapping = {\n    dev = \"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_terraform-dev_ab1\"\n    test = \"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_terraform-test_ab2\"\n    production = \"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_terraform-production_ab3\"\n  }\n\n  # Other Platform Config Values Below\n  # ===================================\n  # DNS\n  main_public_dns_zone_name     = \"example.com\"\n  env_public_dns_zone_subdomain = \"${local.aws_env}\"\n  environment_hosted_zone_name  = \"${local.env_public_dns_zone_subdomain}.${local.main_public_dns_zone_name}\"\n  acm_subject_alternative_names = [\n    \"${local.environment_hosted_zone_name}\",\n    \"*.${local.environment_hosted_zone_name}\",\n    \"*.api.${local.environment_hosted_zone_name}\",\n    \"*.myapps.${local.environment_hosted_zone_name}\",\n    \"*.apps.${local.environment_hosted_zone_name}\"\n  ]\n  # Region and Zones\n  region = \"us-east-1\"\n  azs = [\n    \"us-east-1a\",\n    \"us-east-1b\",\n    \"us-east-1c\"\n  ]\n  platform_accounts = {\n    dev = {\n      cidr = \"10.3.0.0/16\"\n      private_subnets = [\n        \"10.3.1.0/24\",\n        \"10.3.2.0/24\",\n        \"10.3.3.0/24\"\n      ]\n    }\n    test = {\n      cidr = \"10.2.0.0/16\"\n      private_subnets = [\n        \"10.2.1.0/24\",\n        \"10.2.2.0/24\",\n        \"10.2.3.0/24\"\n      ]\n    }\n    production = {\n      cidr = \"10.0.0.0/16\"\n      private_subnets = [\n        \"10.0.1.0/24\",\n        \"10.0.2.0/24\",\n        \"10.0.3.0/24\"\n      ]\n    }\n  }\n}\nremote_state {\n  backend = \"s3\"\n  generate = {\n    path      = \"backend.tf\"\n    if_exists = \"overwrite_terragrunt\"\n  }\n  config = {\n    bucket         = \"terraform-state-shared-services\"\n    key            = \"${local.app_name}/${get_path_from_repo_root()}/terraform.tfstate\"\n    region         = local.region\n    encrypt        = true\n    dynamodb_table = \"shared-services-lock-table\"\n  }\n}\n\ngenerate \"provider\" {\n  path      = \"provider.tf\"\n  if_exists = \"overwrite_terragrunt\"\n  contents  = \u003c\u003c-EOF\n    provider \"aws\" {\n      region = \"${local.region}\"\n      allowed_account_ids = [\n        \"${local.account_mapping[local.aws_env]}\"\n      ]\n      assume_role {\n        role_arn = \"arn:aws:iam::${local.account_mapping[local.aws_env]}:role/${local.account_role_name}\"\n      }\n      default_tags {\n        tags = {\n          Environment = \"${local.aws_env}\"\n          ManagedBy   = \"terraform\"\n          DeployedBy  = \"terragrunt\"\n          Creator     = \"${get_env(\"USER\", \"NOT_SET\")}\"\n          Application = \"${local.app_name}\"\n          Component   = \"${local.component}\"\n        }\n      }\n    }\nEOF\n}\n```\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n# 배포\n\n## 플랫폼\n\n```js\naws sso login --profile terraform-platform\nexport AWS_PROFILE=terraform-platform\n\n# 개발\ncd infrastructure/live/dev/iam-roles\nterragrunt init\nterragrunt plan\nterragrunt apply\n\n# 테스트\ncd infrastructure/live/test/iam-roles\nterragrunt init\nterragrunt plan\nterragrunt apply\n\n# 프로덕션\ncd infrastructure/live/production/iam-roles\nterragrunt init\nterragrunt plan\nterragrunt apply\n```\n\n## 어플리케이션\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n여기서는 방금 만든 새 역할을 사용합니다.\n\n```js\n# 개발\ncd infrastructure/live/dev/app\naws sso login --profile terraform-dev\nexport AWS_PROFILE=terraform-dev\nterragrunt init\nterragrunt plan\nterragrunt apply\n\n# 테스트\ncd infrastructure/live/test/app\naws sso login --profile terraform-test\nexport AWS_PROFILE=terraform-test\nterragrunt init\nterragrunt plan\nterragrunt apply\n\n# 프로덕션\ncd infrastructure/live/production/app\naws sso login --profile terraform-production\nexport AWS_PROFILE=terraform-production\nterragrunt init\nterragrunt plan\nterragrunt apply\n```\n\n# AWS Vault\n\nAWS Vault은 개발 환경에서 AWS 자격 증명을 안전하게 저장하고 액세스하는 도구입니다.\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\nAWS Vault은 IAM 자격 증명을 사용자의 운영 체제 안전한 키 저장소에 저장한 다음 해당 자격 증명을 임시 자격 증명으로 생성하여 쉘 및 응용 프로그램에 노출합니다. 이는 AWS CLI 도구와 함께 보조적으로 사용되도록 설계되었으며 ~/.aws/config에 있는 프로필과 구성을 인식합니다.\n\n```js\nbrew install --cask aws-vault\n```\n\n## 따라서 이는 백엔드 구성 및 공급자에서 \"프로필\" 매개변수를 제거할 수 있음을 의미합니다.\n\n# AWS-Vault로 배포하기\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n# 플랫폼\n\n```js\n# Dev\ncd infrastructure/live/dev/iam-roles\naws-vault exec terraform-platform terragrunt init\naws-vault exec terraform-platform terragrunt plan\naws-vault exec terraform-platform terragrunt apply\n\n# 테스트\ncd infrastructure/live/test/iam-roles\naws-vault exec terraform-platform terragrunt init\naws-vault exec terraform-platform terragrunt plan\naws-vault exec terraform-platform terragrunt apply\n\n# 프로덕션\ncd infrastructure/live/production/iam-roles\naws-vault exec terraform-platform terragrunt init\naws-vault exec terraform-platform terragrunt plan\naws-vault exec terraform-platform terragrunt apply\n```\n\n# 애플리케이션\n\n```js\ncd infrastructure/live/dev/app\naws-vault exec terraform-dev terragrunt init\naws-vault exec terraform-dev terragrunt plan\naws-vault exec terraform-dev terragrunt apply\n\ncd infrastructure/live/test/app\naws-vault exec terraform-test terragrunt init\naws-vault exec terraform-test terragrunt plan\naws-vault exec terraform-test terragrunt apply\n\ncd infrastructure/live/production/app\naws-vault exec terraform-production terragrunt init\naws-vault exec terraform-production terragrunt plan\naws-vault exec terraform-production terragrunt apply\n```\n\n\u003c!-- ui-station 사각형 --\u003e\n\n\u003cins class=\"adsbygoogle\"\nstyle=\"display:block\"\ndata-ad-client=\"ca-pub-4877378276818686\"\ndata-ad-slot=\"7249294152\"\ndata-ad-format=\"auto\"\ndata-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\n\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\n\u003cimg src=\"/assets/img/2024-05-27-MyIaCAWSMulti-AccountProvisioningBluePrintBestPractices_2.png\" /\u003e\n\n## 결과\n\n```js\n $ aws-vault exec terraform-production terragrunt apply\n\n\n\n백엔드 초기화 중...\n\n백엔드 \"s3\"이 성공적으로 구성되었습니다! 백엔드 구성이 변경되지 않는 한 Terraform은\n자동으로이 백엔드를 사용할 것입니다.\n모듈 초기화 중...\njobs_logs(을)를 위해 git::https://github.com/terraform-aws-modules/terraform-aws-dynamodb-table.git을(를) 다운로드 중...\n- .terraform/modules/logs에 jobs_logs\n- ../lambda-execution-role에 lambda_execution_role\ns3_bucket_files(을)를 위해 git::https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git?ref=v3.6.1을(를) 다운로드 중...\n- .terraform/modules/s3_bucket_files에 s3_bucket_files\n- ../ssm-parameters-store에 ssm_params\n\n제공자 플러그인 초기화 중...\n- 종속성 잠금 파일에서 이전 버전의 hashicorp/aws 재사용\n- hashicorp/aws v5.23.1 설치 중...\n- hashicorp/aws v5.23.1 설치됨 (HashiCorp에서 서명됨)\n\nTerraform이 성공적으로 초기화되었습니다!\n\n이제 Terraform을 사용하여 작업을 시작할 수 있습니다. \"terraform plan\"을 실행하여\n인프라에 필요한 모든 변경 사항을 확인해 보세요. 이제 모든 Terraform 명령이\n작동해야 합니다.\n\nTerraform을 위해 모듈이나 백엔드 구성을 설정 또는 변경한 경우,\n작업 디렉터리를 다시 초기화하려면이 명령을 다시 실행하세요. 잊어 버린 경우\n다른 명령이 필요한 경우이를 감지하고 다시 실행하라는 메시지가 표시됩니다.\n상태 잠금 획득 중. 이 작업은 몇 분 정도 걸릴 수 있습니다...\nmodule.lambda_execution_role.data.aws_iam_policy_document.lambda_assume_role_policy: 읽는 중...\nmodule.s3_bucket_files.data.aws_caller_identity.current: 읽는 중...\nmodule.s3_bucket_files.data.aws_canonical_user_id.this: 읽는 중...\ndata.aws_caller_identity.current: 읽는 중...\nmodule.s3_bucket_files.aws_s3_bucket.this[0]: 상태 새로 고침 중... [id=my-company-myapp-files-dev]\nmodule.jobs_logs.aws_dynamodb_table.this[0]: 상태 새로 고침 중... [id=my-company-myapp-logs]\nmodule.lambda_execution_role.data.aws_iam_policy_document.lambda_assume_role_policy: 0초 후에 읽기 완료 [id=000000000]\ndata.aws_caller_identity.current: 0초 후에 읽기 완료 [id=000000000]\nmodule.lambda_execution_role.data.aws_iam_policy_document.inline_policy: 읽는 중...\nmodule.s3_bucket_files.data.aws_caller_identity.current: 0초 후에 읽기 완료 [id=000000000]\nmodule.lambda_execution_role.data.aws_iam_policy_document.inline_policy: 0초 후에 읽기 완료 [id=000000000]\nmodule.lambda_execution_role.aws_iam_role.lambda_execution_role: 상태 새로 고침 중... [id=my-company-myapp-lambda-execution-role]\nmodule.s3_bucket_files.data.aws_canonical_user_id.this: 1초 후에 읽기 완료 [id=51528157cefbacf17d3cc90bf31e07f8f463cadfbf31739f6b264afac67fb2ce]\nmodule.s3_bucket_files.aws_s3_bucket_public_access_block.this[0]: 상태 새로 고침 중... [id=my-company-myapp-files-dev]\nmodule.ssm_params.aws_ssm_parameter.this[\"2\"]: 상태 새로 고침 중... [id=/app/myapp/lambda_role]\nmodule.ssm_params.aws_ssm_parameter.this[\"3\"]: 상태 새로 고침 중... [id=/app/myapp/event_bridge_name]\nmodule.ssm_params.aws_ssm_parameter.this[\"4\"]: 상태 새로 고침 중... [id=/app/myapp/logs]\nmodule.ssm_params.aws_ssm_parameter.this[\"1\"]: 상태 새로 고침 중... [id=/app/myapp/s3_bucket_files]\n\n변경 사항이 없습니다. 인프라가 구성과 일치합니다.\n\nTerraform은 실제 인프라를 구성과 비교하고 차이점을 찾았으며 변경 사항이 필요하지 않습니다.\n상태 잠금 해제 중. 이 작업은 몇 분 정도 걸릴 수 있습니다...\n```\n\n읽어 주셔서 감사합니다!\n","ogImage":{"url":"/assets/img/2024-05-27-MyIaCAWSMulti-AccountProvisioningBluePrintBestPractices_0.png"},"coverImage":"/assets/img/2024-05-27-MyIaCAWSMulti-AccountProvisioningBluePrintBestPractices_0.png","tag":["Tech"],"readingTime":35},"content":"\u003c!doctype html\u003e\n\u003chtml lang=\"en\"\u003e\n\u003chead\u003e\n\u003cmeta charset=\"utf-8\"\u003e\n\u003cmeta content=\"width=device-width, initial-scale=1\" name=\"viewport\"\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n\u003ch2\u003eSSO 사용자와 함께 Terraform 실행 역할을 가정하는 방법.\u003c/h2\u003e\n\u003cp\u003e이 기사에서는 IaC (Terraform) 프로젝트의 구조를 보여드리겠습니다. 이 프로젝트는 보통 여기저기 흩어져 있는 값 파일이 필요하지 않도록 구성됩니다. 또한 하나의 구성 파일만으로 모든 환경을 제어하는 방법과 플랫폼과 응용프로그램 인프라 코드를 어떻게 분리하는지도 보여드리겠습니다.\u003c/p\u003e\n\u003ch2\u003e이 기사에서 다루는 주제들:\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e여러 계정 배포 도구의 우승자인 Terragrunt\u003c/li\u003e\n\u003cli\u003eTerraform 및 Terragrunt의 협력\u003c/li\u003e\n\u003cli\u003e응용프로그램 인프라 Terragrunt Main 구성 파일 (Locals/Backend S3/AWS Provider)\u003c/li\u003e\n\u003cli\u003eTerraform 실행을 위한 AWS Identity Center (SSO) 권한 집합 (AWS 키와 비밀번호가 영구적이지 않는 역할으로 가정)\u003c/li\u003e\n\u003cli\u003e플랫폼 vs 응용프로그램 인프라\u003c/li\u003e\n\u003cli\u003e플랫폼 인프라 Terragrunt Main 구성 파일 (Locals/Backend S3/AWS Provider)\u003c/li\u003e\n\u003cli\u003eTerraform 실행 역할 생성 (응용프로그램 인프라 배포를 위해) IAM 액세스 Identity (SSO)로 프로비저닝된 역할의 신뢰 정책\u003c/li\u003e\n\u003cli\u003e안전하게 SSO AWS 임시 자격 증명 구성\u003c/li\u003e\n\u003cli\u003eAWS-VAULT\u003c/li\u003e\n\u003c/ul\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch1\u003e테라그런트\u003c/h1\u003e\n\u003cp\u003e내 의견으로 테라그런트는 인프라를 위한 다중 계정 배포 구조화에 사용 가능한 (내가 아는 한) 최고 도구입니다.\u003c/p\u003e\n\u003cp\u003e테라그런트 문서에 따르면 코드를 다음과 같이 구조화하는 것을 제안합니다:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-05-27-MyIaCAWSMulti-AccountProvisioningBluePrintBestPractices_0.png\" alt=\"테라그런트 구조\"\u003e\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e그러나 주의해야 할 점은 terragrunt를 자원을 조정하는 데 과도하게 사용하지 않아야 합니다.\u003c/p\u003e\n\u003cp\u003eTerraform은 여러 모듈을 하나로 번들링하여 응용 프로그램이나 플랫폼 서비스를 사용하는 것을 목적으로 합니다.\u003c/p\u003e\n\u003cp\u003eTerragrunt는 이미 통합된 Terraform 모듈을 서로 다른 환경에 배포하는 데만 사용해야 합니다.\u003c/p\u003e\n\u003ch1\u003e응용 프로그램 모듈을 생성하는 데 Terraform을 사용하고, 다른 환경에 배포하는 데 Terragrunt를 사용하세요.\u003c/h1\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e애플리케이션 모듈(왼쪽)을 만들 때 Terragrunt를 사용하지 마세요. 그렇지 않으면 복잡해질 수 있고 테라폼 상태가 앱 단위가 아닌 구성 요소 단위로 생성될 수 있습니다. Terragrunt를 사용하는 경우 배포(오른쪽)에만 사용하세요.\u003c/p\u003e\n\u003cp\u003e과거에 저희가 한 실수를 피하기 위해 이렇게 말씀 드리는데요. 저는 Terragrunt 내부의 컴포넌트에 너무 많이 나눠 애플리케이션 인프라를 분리하면서 개별 리소스를 더 잘 관리하려고 했지만 더 많은 문제를 발생시켰습니다.\u003c/p\u003e\n\u003ch1\u003e왜 이런 문제가 발생할 수 있나요?\u003c/h1\u003e\n\u003cp\u003e저의 몇몇 프로젝트 중 하나에서 저는 Terragrunt에서 Terraform 워크스페이스로 다중 계정 배포 방법을 변경하는 작업을 맡게 되었습니다. 이것은 서로 다른 AWS 환경을 관리하기 위해 조직의 표준 절차에 맞추기 위한 것입니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e이 프로세스는 Terragrunt가 단순히 테라폼 래퍼일 뿐이기 때문에 매우 간단할 수 있었을 것입니다.\u003c/p\u003e\n\u003cp\u003e하지만 앱을 구성 요소로 분할하고 그 구성 요소가 모듈 내에 존재하면 상태 파일을 병합해야 하는 악몽이 될 수 있습니다.\u003c/p\u003e\n\u003cp\u003e그래서 Terragrunt 풋프린트를 최소화하려면...\u003c/p\u003e\n\u003cp\u003eT\nerraform은 애플리케이션이나 플랫폼 서비스를 위해 서로 다른 모듈을 번들로 묶을 것으로 의도되어야 합니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch2\u003e예시: 최소한의 애플리케이션 인프라 리소스:\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003edata \u003cspan class=\"hljs-string\"\u003e\"aws_caller_identity\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"current\"\u003c/span\u003e {}\n\nlocals {\n  aws_account_id = data.\u003cspan class=\"hljs-property\"\u003eaws_caller_identity\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaccount_id\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"app_logs\"\u003c/span\u003e {\n  source = \u003cspan class=\"hljs-string\"\u003e\"git::https://github.com/terraform-aws-modules/terraform-aws-dynamodb-table.git//\"\u003c/span\u003e\n  name         = \u003cspan class=\"hljs-string\"\u003e\"${var.app_name}-logs\"\u003c/span\u003e\n  billing_mode = \u003cspan class=\"hljs-string\"\u003e\"PAY_PER_REQUEST\"\u003c/span\u003e\n  hash_key     = \u003cspan class=\"hljs-string\"\u003e\"organization\"\u003c/span\u003e\n  range_key    = \u003cspan class=\"hljs-string\"\u003e\"job_id\"\u003c/span\u003e\n\n  server_side_encryption_enabled = \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e\n  deletion_protection_enabled    = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n\n  attributes = [\n    {\n      name = \u003cspan class=\"hljs-string\"\u003e\"organization\"\u003c/span\u003e\n      type = \u003cspan class=\"hljs-string\"\u003e\"S\"\u003c/span\u003e\n    },\n    {\n      name = \u003cspan class=\"hljs-string\"\u003e\"job_id\"\u003c/span\u003e\n      type = \u003cspan class=\"hljs-string\"\u003e\"S\"\u003c/span\u003e\n    }\n  ]\n}\n\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"app_users\"\u003c/span\u003e {\n  source = \u003cspan class=\"hljs-string\"\u003e\"git::https://github.com/terraform-aws-modules/terraform-aws-dynamodb-table.git//\"\u003c/span\u003e\n  # 필요 시 다른 \u003cspan class=\"hljs-title class_\"\u003eDynamoDB\u003c/span\u003e 테이블을 여기에 추가\n}\n\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"lambda_execution_role\"\u003c/span\u003e {\n  source = \u003cspan class=\"hljs-string\"\u003e\"../lambda-execution-role\"\u003c/span\u003e\n  aws_account_id = local.\u003cspan class=\"hljs-property\"\u003eaws_account_id\u003c/span\u003e\n  app_name       = \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eapp_name\u003c/span\u003e\n  env            = \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eenv\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"s3_bucket_files\"\u003c/span\u003e {\n  source = \u003cspan class=\"hljs-string\"\u003e\"git::https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git//?ref=v3.6.1\"\u003c/span\u003e\n  bucket                  = \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eenv\u003c/span\u003e == \u003cspan class=\"hljs-string\"\u003e\"production\"\u003c/span\u003e ? \u003cspan class=\"hljs-string\"\u003e\"my-company-app-${var.app_name}-files\"\u003c/span\u003e : \u003cspan class=\"hljs-string\"\u003e\"my-company-app-${var.app_name}-files-${var.env}\"\u003c/span\u003e\n  block_public_acls       = \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e\n  block_public_policy     = \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e\n  ignore_public_acls      = \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e\n  restrict_public_buckets = \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"another_s3_bucket_files\"\u003c/span\u003e {\n  source = \u003cspan class=\"hljs-string\"\u003e\"git::https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git//?ref=v3.6.1\"\u003c/span\u003e\n  # 필요 시 다른 \u003cspan class=\"hljs-variable constant_\"\u003eS3\u003c/span\u003e 버켓을 여기에 추가\n}\n\n# \u003cspan class=\"hljs-variable constant_\"\u003eSSM\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eParams\u003c/span\u003e는 서버리스나 다른 도구에 값들을 전달하는 좋은 방법입니다.\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"ssm_params\"\u003c/span\u003e {\n  source = \u003cspan class=\"hljs-string\"\u003e\"../ssm-parameters-store\"\u003c/span\u003e\n  parameters = {\n    \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e = {\n      name  = \u003cspan class=\"hljs-string\"\u003e\"/app/${var.app_name}/s3_bucket_files\"\u003c/span\u003e\n      value = \u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003es3_bucket_files\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003es3_bucket_id\u003c/span\u003e\n    }\n    \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e = {\n      name  = \u003cspan class=\"hljs-string\"\u003e\"/app/${var.app_name}/lambda_role\"\u003c/span\u003e\n      value = \u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elambda_execution_role\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003erole_arn\u003c/span\u003e\n    }\n    \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e = {\n      name  = \u003cspan class=\"hljs-string\"\u003e\"/app/${var.app_name}/event_bridge_name\"\u003c/span\u003e\n      value = \u003cspan class=\"hljs-string\"\u003e\"${var.app_name}-event-bus\"\u003c/span\u003e\n    }\n    \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e = {\n      name  = \u003cspan class=\"hljs-string\"\u003e\"/app/${var.app_name}/logs\"\u003c/span\u003e\n      value = \u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eapp_logs\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edynamodb_table_id\u003c/span\u003e\n    }\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e이 모듈에서는 다른 모듈을 호출하여 다음과 같은 종류의 리소스를 생성합니다:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eDynamoDB 테이블\u003c/li\u003e\n\u003cli\u003eS3 버켓\u003c/li\u003e\n\u003cli\u003eIAM Lambda 실행 역할\u003c/li\u003e\n\u003cli\u003e이전에 생성된 리소스의 ARN 또는 ID를 보관하는 SSM 매개변수\u003c/li\u003e\n\u003c/ul\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e여기서 빠진 것은 다른 기사에서 보여준 것처럼 백엔드 S3 및 AWS 제공자 구성입니다... 여기서 Terragrunt가 등장합니다...\u003c/p\u003e\n\u003ch1\u003e플랫폼 대 응용 프로그램\u003c/h1\u003e\n\u003cp\u003e이러한 염려 사항의 분리는 서로 다른 GIT 저장소를 가지거나 단순히 동일한 Repo 내에서 다른 프로젝트로 취급함을 의미합니다... 여기서 중요한 것은 응용 프로그램 인프라 코드가 플랫폼 인프라 코드에 직접적인 종속성을 포함해서는 안된다는 것입니다... 따라서 이것은 응용 프로그램 소스 코드(BE/FE)와 함께 쉽게 추출될 수 있습니다...\u003c/p\u003e\n\u003cp\u003e하지만 우리는 어떻게 알 수 있을까요? 무엇을 플랫폼 인프라에 위치시키고 어떤 것을 애플리케이션 인프라에 위치시켜야 할지요?\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch2\u003e플랫폼 인프라스트럭처:\u003c/h2\u003e\n\u003cp\u003e플랫폼 인프라스트럭처는 보다 포괄적이며 조직 전체에서 여러 응용 프로그램을 지원하는 기본 구성 요소와 서비스를 지칭합니다. 일반적으로 다음을 포함합니다:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCI/CD용 IAM 역할\u003c/li\u003e\n\u003cli\u003eRoute53 호스팅 영역\u003c/li\u003e\n\u003cli\u003e네트워킹: VPC, 방화벽 및 NAT와 같은 구성 요소\u003c/li\u003e\n\u003cli\u003e모니터링 및 로깅: Prometheus, Grafana 또는 CloudWatch와 같은 요소\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e응용 프로그램 인프라스트럭처:\u003c/h2\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e응용 프로그램 인프라는 특정 응용 프로그램 또는 응용 프로그램 세트를 실행하는 데 필요한 구성 요소와 리소스로 구성됩니다. 이는 종종 다음을 포함합니다:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eEC2 인스턴스, 람다 함수\u003c/li\u003e\n\u003cli\u003e트랜짓 게이트웨이, 로드 밸런서\u003c/li\u003e\n\u003cli\u003e앱 데이터베이스: MySQL, PostgreSQL 또는 MongoDB와 같은 데이터베이스\u003c/li\u003e\n\u003cli\u003e메시지 대기열: SQS 또는 Kafka와 같은 메시지 대기열\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e주요 포인트는 개별 앱의 요구 사항에 맞추는 것입니다.\u003c/h2\u003e\n\u003cp\u003e예를 들어 Serverless Framework나 AWS SAM이 있습니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e서버리스 애플리케이션에 대해서는 테라폼과 서버리스를 사용하는 멋진 가이드가 있어요.\u003c/p\u003e\n\u003ch2\u003e테라폼을 사용하지 않고 다른 도구를 사용할 때, 서버리스 프레임워크나 SAM같은:\u003c/h2\u003e\n\u003ch1\u003e애플리케이션 IaC를 위한 Terragrunt\u003c/h1\u003e\n\u003cp\u003e‘live‘ 디렉토리 내에서 배포할 환경을 지정하세요.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e├── \u003cspan class=\"hljs-variable constant_\"\u003eREADME\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003emd\u003c/span\u003e\n├── live\n│   ├── _env\n│   │   └── app.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e\n│   ├── dev\n│   │   └── app\n│   │       └── terragrunt.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e \u0026#x3C;--- \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e is not a config file, but an environment resource file\n│   ├── production\n│   │   └── app\n│   │       └── terragrunt.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e\n│   ├── terragrunt.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e         \u0026#x3C;------ \u003cspan class=\"hljs-title class_\"\u003eTerragrunt\u003c/span\u003e config file (\u003cspan class=\"hljs-title class_\"\u003eUnique\u003c/span\u003e)\n│   └── test\n│       └── app\n│           └── terragrunt.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e\n└── modules\n    ├── lambda-execution-role\n    │   ├── data.\u003cspan class=\"hljs-property\"\u003etf\u003c/span\u003e\n    │   ├── main.\u003cspan class=\"hljs-property\"\u003etf\u003c/span\u003e\n    │   ├── output.\u003cspan class=\"hljs-property\"\u003etf\u003c/span\u003e\n    │   └── variables.\u003cspan class=\"hljs-property\"\u003etf\u003c/span\u003e\n    ├── application_1\n    │   ├── main.\u003cspan class=\"hljs-property\"\u003etf\u003c/span\u003e\n    │   └── variables.\u003cspan class=\"hljs-property\"\u003etf\u003c/span\u003e\n    └── ssm-parameters-store\n        ├── main.\u003cspan class=\"hljs-property\"\u003etf\u003c/span\u003e\n        └── variables.\u003cspan class=\"hljs-property\"\u003etf\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003e유일무이한 terragrunt.hcl 설정 파일\u003c/h1\u003e\n\u003cp\u003e여기에는 하나의 terragrunt.hcl 구성 파일을 사용하여 멀티 계정 배포를 구성하는 방법이 나와 있어요.\u003c/p\u003e\n\u003cp\u003e테라폼 워크스페이스 구성과 Terragrunt 구성을 비교해보겠습니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e로컬 변수 정의는 \"거의\" 같은 상태로 유지되고 있으며, Terragrunt Live 디렉터리를 다른 환경의 이름으로 구조화하고 있습니다.\u003c/p\u003e\n\u003cp\u003eAWS 환경 이름과 디렉터리 이름이 일치하므로 간단한 정규 표현식으로 실행 시간에 환경 값을 추론할 수 있습니다.\u003c/p\u003e\n\u003ch2\u003einfrastructure/live/terragrunt.hcl\u003c/h2\u003e\n\u003cp\u003e여기에 완전한 terragrunt.hcl 파일이 있습니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003ebackend.tf와 provider.tf 생성기에서 \"profile\" 매개변수를 주목해주세요. 다음 섹션에서 이들을 제거할 예정입니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003elocals {\n  # 환경\n  env_regex = \u003cspan class=\"hljs-string\"\u003e\"infrastructure/live/([a-zA-Z0-9-]+)/\"\u003c/span\u003e\n  aws_env   = \u003cspan class=\"hljs-title function_\"\u003etry\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003eregex\u003c/span\u003e(local.\u003cspan class=\"hljs-property\"\u003eenv_regex\u003c/span\u003e, \u003cspan class=\"hljs-title function_\"\u003eget_original_terragrunt_dir\u003c/span\u003e())[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e])\n  # 어플리케이션\n  app_name = \u003cspan class=\"hljs-string\"\u003e\"my-app\"\u003c/span\u003e\n  component = \u003cspan class=\"hljs-string\"\u003e\"api\"\u003c/span\u003e\n\n  # \u003cspan class=\"hljs-variable constant_\"\u003eAWS\u003c/span\u003e 조직 계정\n  account_mapping = {\n    dev             = \u003cspan class=\"hljs-number\"\u003e22222222222\u003c/span\u003e\n    test            = \u003cspan class=\"hljs-number\"\u003e111111111111\u003c/span\u003e\n    production      = \u003cspan class=\"hljs-number\"\u003e000000000000\u003c/span\u003e\n    shared-services = \u003cspan class=\"hljs-number\"\u003e555555555555\u003c/span\u003e\n  }\n  # 가정할 \u003cspan class=\"hljs-variable constant_\"\u003eIAM\u003c/span\u003e 역할\n  account_role_name     = \u003cspan class=\"hljs-string\"\u003e\"apps-terraform-execution-role\"\u003c/span\u003e # \u0026#x3C;--- 가정할 역할\n  # 지역 및 가용 영역\n  region = \u003cspan class=\"hljs-string\"\u003e\"us-east-1\"\u003c/span\u003e\n}\nremote_state {\n  backend = \u003cspan class=\"hljs-string\"\u003e\"s3\"\u003c/span\u003e\n  generate = {\n    path      = \u003cspan class=\"hljs-string\"\u003e\"backend.tf\"\u003c/span\u003e\n    if_exists = \u003cspan class=\"hljs-string\"\u003e\"overwrite_terragrunt\"\u003c/span\u003e\n  }\n  config = {\n    bucket         = \u003cspan class=\"hljs-string\"\u003e\"terraform-state-shared-services\"\u003c/span\u003e\n    key            = \u003cspan class=\"hljs-string\"\u003e\"${local.app_name}/${get_path_from_repo_root()}/terraform.tfstate\"\u003c/span\u003e\n    region         = local.\u003cspan class=\"hljs-property\"\u003eregion\u003c/span\u003e\n    profile        = \u003cspan class=\"hljs-string\"\u003e\"shared-services\"\u003c/span\u003e #\u0026#x3C;----- \u003cspan class=\"hljs-variable constant_\"\u003eAWS\u003c/span\u003e 프로필\n    encrypt        = \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e\n    dynamodb_table = \u003cspan class=\"hljs-string\"\u003e\"shared-services-lock-table\"\u003c/span\u003e\n  }\n}\ngenerate \u003cspan class=\"hljs-string\"\u003e\"provider\"\u003c/span\u003e {\n  path      = \u003cspan class=\"hljs-string\"\u003e\"provider.tf\"\u003c/span\u003e\n  if_exists = \u003cspan class=\"hljs-string\"\u003e\"overwrite_terragrunt\"\u003c/span\u003e\n  contents  = \u0026#x3C;\u0026#x3C;-\u003cspan class=\"hljs-variable constant_\"\u003eEOF\u003c/span\u003e\n    provider \u003cspan class=\"hljs-string\"\u003e\"aws\"\u003c/span\u003e {\n      region = \u003cspan class=\"hljs-string\"\u003e\"${local.region}\"\u003c/span\u003e\n      profile = \u003cspan class=\"hljs-string\"\u003e\"shared-services\"\u003c/span\u003e #\u0026#x3C;----- \u003cspan class=\"hljs-variable constant_\"\u003eAWS\u003c/span\u003e 프로필\n      allowed_account_ids = [\n        \u003cspan class=\"hljs-string\"\u003e\"${local.account_mapping[local.aws_env]}\"\u003c/span\u003e\n      ]\n      assume_role {\n        role_arn = \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::${local.account_mapping[local.aws_env]}:role/${local.account_role_name}\"\u003c/span\u003e\n      }\n      default_tags {\n        tags = {\n          \u003cspan class=\"hljs-title class_\"\u003eEnvironment\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"${local.aws_env}\"\u003c/span\u003e\n          \u003cspan class=\"hljs-title class_\"\u003eManagedBy\u003c/span\u003e   = \u003cspan class=\"hljs-string\"\u003e\"terraform\"\u003c/span\u003e\n          \u003cspan class=\"hljs-title class_\"\u003eDeployedBy\u003c/span\u003e  = \u003cspan class=\"hljs-string\"\u003e\"terragrunt\"\u003c/span\u003e\n          \u003cspan class=\"hljs-title class_\"\u003eCreator\u003c/span\u003e     = \u003cspan class=\"hljs-string\"\u003e\"${get_env(\"\u003c/span\u003e\u003cspan class=\"hljs-variable constant_\"\u003eUSER\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\", \"\u003c/span\u003e\u003cspan class=\"hljs-variable constant_\"\u003eNOT_SET\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\")}\"\u003c/span\u003e\n          \u003cspan class=\"hljs-title class_\"\u003eApplication\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"${local.app_name}\"\u003c/span\u003e\n          \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e   = \u003cspan class=\"hljs-string\"\u003e\"${local.component}\"\u003c/span\u003e\n        }\n      }\n    }\n\u003cspan class=\"hljs-variable constant_\"\u003eEOF\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eTerragrunt가 생성기에 보간을 허용하므로 모든 대상 AWS 계정에 대해 매개변수화할 수 있습니다.\u003c/p\u003e\n\u003ch2\u003einfrastructure/live/_env/app.hcl\u003c/h2\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e테이블 태그를 마크다운 형식으로 변경해주세요.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch2\u003eTerraform 프로비저닝 인프라에 필요한 역할 설정하기\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003eaccount_role_name     = \u003cspan class=\"hljs-string\"\u003e\"apps-terraform-execution-role\"\u003c/span\u003e # \u0026#x3C;--- 전환할 역할\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e또한 이전 게시물에서 AWS 공유 서비스 계정에 terraform-multiaccount-role 및 각 작업 부하 계정(개발, 테스트, 프로덕션)에 terraform-role을 설정하는 방법을 설명했습니다.\u003c/p\u003e\n\u003cp\u003e그러나 이 설정은 하나의 엔터티(terraform-multiaccount-role)가 모든 계정에서 terraform-role을 가정(Assume)할 수 있도록 허용합니다. 이는 개발팀이 자체 인프라를 개발 환경에서 관리할 수 있도록 하려는 경우에는 편리하지 않습니다. 따라서 개발 팀이 Dev 계정에서만 역할을 전환할 수 있는 엔터티와 Test 및 Production에 대한 다른 엔터티가 필요합니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch2\u003eAWS Identity Center 위임된 관리자 계정 및 권한 집합\u003c/h2\u003e\n\u003cp\u003eAWS 계정에 권한 집합을 만드는 방법 및 권한 집합을 AWS 계정에 할당하는 방법에 대한 문서를 따르세요.\u003c/p\u003e\n\u003cp\u003e다음과 같은 권한 집합을 만들어 보세요: terraform-dev, terraform-test, terraform-production.\u003c/p\u003e\n\u003cp\u003e각 권한 집합에 대한 대상 계정에 다음과 같은 내부 정책을 만드세요. 허용하는 권한 집합(Identity 계정에 설정된)이 공유 서비스 계정에 배포되어 다음 계정에서 역할을 가정할 수 있도록합니다:\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e이렇게 보이는 3가지 다른 권한 세트가 있습니다:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e{\n    \u003cspan class=\"hljs-string\"\u003e\"Version\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"2012-10-17\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"Statement\"\u003c/span\u003e: [\n        {\n            \u003cspan class=\"hljs-string\"\u003e\"Effect\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"Allow\"\u003c/span\u003e,\n            \u003cspan class=\"hljs-string\"\u003e\"Action\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"sts:AssumeRole\"\u003c/span\u003e,\n            \u003cspan class=\"hljs-string\"\u003e\"Resource\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::000000000000:role/apps-terraform-execution-role\"\u003c/span\u003e\n        },\n        {\n            \u003cspan class=\"hljs-string\"\u003e\"Sid\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"Statement1\"\u003c/span\u003e,\n            \u003cspan class=\"hljs-string\"\u003e\"Effect\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"Allow\"\u003c/span\u003e,\n            \u003cspan class=\"hljs-string\"\u003e\"Action\"\u003c/span\u003e: [\n              \u003cspan class=\"hljs-string\"\u003e\"s3:GetObject\"\u003c/span\u003e,\n              \u003cspan class=\"hljs-string\"\u003e\"s3:PutObject\"\u003c/span\u003e,\n              \u003cspan class=\"hljs-string\"\u003e\"s3:ListBucket\"\u003c/span\u003e\n            ],\n            \u003cspan class=\"hljs-string\"\u003e\"Resource\"\u003c/span\u003e: [\n                \u003cspan class=\"hljs-string\"\u003e\"arn:aws:s3:::terraform-state-shared-services*\"\u003c/span\u003e,\n                \u003cspan class=\"hljs-string\"\u003e\"arn:aws:s3:::terraform-state-shared-services/*\"\u003c/span\u003e\n            ]\n        },\n        {\n            \u003cspan class=\"hljs-string\"\u003e\"Sid\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"Statement2\"\u003c/span\u003e,\n            \u003cspan class=\"hljs-string\"\u003e\"Effect\"\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"Allow\"\u003c/span\u003e,\n            \u003cspan class=\"hljs-string\"\u003e\"Action\"\u003c/span\u003e: [\n              \u003cspan class=\"hljs-string\"\u003e\"dynamodb:GetItem\"\u003c/span\u003e,\n              \u003cspan class=\"hljs-string\"\u003e\"dynamodb:PutItem\"\u003c/span\u003e,\n              \u003cspan class=\"hljs-string\"\u003e\"dynamodb:DeleteItem\"\u003c/span\u003e\n            ],\n            \u003cspan class=\"hljs-string\"\u003e\"Resource\"\u003c/span\u003e: [\n                \u003cspan class=\"hljs-string\"\u003e\"arn:aws:dynamodb:us-east-1:555555555555:table/shared-services-lock-table\"\u003c/span\u003e\n            ]\n        }\n    ]\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e각 워크로드 계정에 apps-terraform-execution-role을 만들고 SSO 사용자가 역할을 할 수 있도록 허용합니다.\u003c/p\u003e\n\u003cp\u003e참고: \"terraform-production\"에게도 Test에서 역할을 수행할 수 있도록 정책을 약간 조정할 수도 있습니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch1\u003e플랫폼 인프라 (IaC)\u003c/h1\u003e\n\u003cp\u003e최소한의 애플리케이션을 위해 DNS, 네트워킹 및 식별 관리 역할 및 정책과 같은 플랫폼 리소스를 제공해야 합니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e➜  live \u003cspan class=\"hljs-attr\"\u003egit\u003c/span\u003e:(main) ✗ tree\n.\n├── _env\n│   ├── route53-zones.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e\n│   └── iam-roles.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e\n├── dev\n│   ├── iam-roles\n│   │   └── terragrunt.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e\n│   ├── route53-zones\n│   │   └── terragrunt.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e\n│   └── platform\n│       └── terragrunt.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e\n├── network\n│   ├── dmz\n│   │   └── terragrunt.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e\n│   ├── network-egress\n│   │   └── terragrunt.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e\n│   ├── transitgateway-dmz-vpc-attachment\n│   │   └── terragrunt.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e\n│   └── transitgateway-egress-vpc-attachment\n│       ├── mystate.\u003cspan class=\"hljs-property\"\u003etfstate\u003c/span\u003e\n│       └── terragrunt.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e\n├── production\n│   ├── iam-roles\n│   │   └── terragrunt.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e\n│   └── platform\n│       └── terragrunt.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e\n├── terragrunt.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e\n└── test\n    ├── iam-roles\n    │   └── terragrunt.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e\n    ├── route53-zones\n    │   └── terragrunt.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e\n    └── platform\n        └── terragrunt.\u003cspan class=\"hljs-property\"\u003ehcl\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e로컬 변수\u003c/h2\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e여러 개의 계정 값들을 하나의 장소에서 중앙화하는 방법의 예시입니다:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003elocals {\n  # 환경 변수\n  env_regex = \u003cspan class=\"hljs-string\"\u003e\"infrastructure/live/([a-zA-Z0-9-]+)/\"\u003c/span\u003e\n  aws_env   = \u003cspan class=\"hljs-title function_\"\u003etry\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003eregex\u003c/span\u003e(local.\u003cspan class=\"hljs-property\"\u003eenv_regex\u003c/span\u003e, \u003cspan class=\"hljs-title function_\"\u003eget_original_terragrunt_dir\u003c/span\u003e())[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e])\n  # 어플리케이션\n  app_name  = \u003cspan class=\"hljs-string\"\u003e\"my-application-platform\"\u003c/span\u003e\n  component = \u003cspan class=\"hljs-string\"\u003e\"platform\"\u003c/span\u003e\n  platform_apps = [\n    \u003cspan class=\"hljs-string\"\u003e\"application_1\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"application_2\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"application_3\"\u003c/span\u003e\n  ]\n  # \u003cspan class=\"hljs-variable constant_\"\u003eAWS\u003c/span\u003e 조직 계정\n  application_account_mapping = {\n    dev        = \u003cspan class=\"hljs-number\"\u003e222222222222\u003c/span\u003e\n    test       = \u003cspan class=\"hljs-number\"\u003e111111111111\u003c/span\u003e\n    production = \u003cspan class=\"hljs-number\"\u003e000000000000\u003c/span\u003e\n  }\n  platform_account_mapping = {\n    shared-services = \u003cspan class=\"hljs-number\"\u003e555555555555\u003c/span\u003e\n    network         = \u003cspan class=\"hljs-string\"\u003e\"666666666666\"\u003c/span\u003e\n    dns             = \u003cspan class=\"hljs-number\"\u003e888888888888\u003c/span\u003e\n  }\n  account_mapping = \u003cspan class=\"hljs-title function_\"\u003emerge\u003c/span\u003e(local.\u003cspan class=\"hljs-property\"\u003eapplication_account_mapping\u003c/span\u003e, local.\u003cspan class=\"hljs-property\"\u003eplatform_account_mapping\u003c/span\u003e)\n\n  # 가정할 \u003cspan class=\"hljs-variable constant_\"\u003eIAM\u003c/span\u003e 역할\n  account_role_name     = \u003cspan class=\"hljs-string\"\u003e\"terraform-role\"\u003c/span\u003e\n  multiaccount_role_arn = \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::555555555555:role/terraform-multiaccount-role\"\u003c/span\u003e # shared-services\n\n  terraform_execution_role_mapping = {\n    dev = \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_terraform-dev_ab1\"\u003c/span\u003e\n    test = \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_terraform-test_ab2\"\u003c/span\u003e\n    production = \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_terraform-production_ab3\"\u003c/span\u003e\n  }\n\n  # 기타 플랫폼 구성 값들\n  # ===================================\n  # \u003cspan class=\"hljs-variable constant_\"\u003eDNS\u003c/span\u003e\n  main_public_dns_zone_name     = \u003cspan class=\"hljs-string\"\u003e\"example.com\"\u003c/span\u003e\n  env_public_dns_zone_subdomain = \u003cspan class=\"hljs-string\"\u003e\"${local.aws_env}\"\u003c/span\u003e\n  environment_hosted_zone_name  = \u003cspan class=\"hljs-string\"\u003e\"${local.env_public_dns_zone_subdomain}.${local.main_public_dns_zone_name}\"\u003c/span\u003e\n  acm_subject_alternative_names = [\n    \u003cspan class=\"hljs-string\"\u003e\"${local.environment_hosted_zone_name}\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"*.${local.environment_hosted_zone_name}\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"*.api.${local.environment_hosted_zone_name}\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"*.myapps.${local.environment_hosted_zone_name}\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"*.apps.${local.environment_hosted_zone_name}\"\u003c/span\u003e\n  ]\n  # 지역 및 가용 영역\n  region = \u003cspan class=\"hljs-string\"\u003e\"us-east-1\"\u003c/span\u003e\n  azs = [\n    \u003cspan class=\"hljs-string\"\u003e\"us-east-1a\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"us-east-1b\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"us-east-1c\"\u003c/span\u003e\n  ]\n  platform_accounts = {\n    dev = {\n      cidr = \u003cspan class=\"hljs-string\"\u003e\"10.3.0.0/16\"\u003c/span\u003e\n      private_subnets = [\n        \u003cspan class=\"hljs-string\"\u003e\"10.3.1.0/24\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"10.3.2.0/24\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"10.3.3.0/24\"\u003c/span\u003e\n      ]\n    }\n    test = {\n      cidr = \u003cspan class=\"hljs-string\"\u003e\"10.2.0.0/16\"\u003c/span\u003e\n      private_subnets = [\n        \u003cspan class=\"hljs-string\"\u003e\"10.2.1.0/24\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"10.2.2.0/24\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"10.2.3.0/24\"\u003c/span\u003e\n      ]\n    }\n    production = {\n      cidr = \u003cspan class=\"hljs-string\"\u003e\"10.0.0.0/16\"\u003c/span\u003e\n      private_subnets = [\n        \u003cspan class=\"hljs-string\"\u003e\"10.0.1.0/24\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"10.0.2.0/24\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"10.0.3.0/24\"\u003c/span\u003e\n      ]\n    }\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003einclude \u003cspan class=\"hljs-string\"\u003e\"root\"\u003c/span\u003e {\n  path = \u003cspan class=\"hljs-title function_\"\u003efind_in_parent_folders\u003c/span\u003e()\n}\n\ninclude \u003cspan class=\"hljs-string\"\u003e\"env\"\u003c/span\u003e {\n  path = \u003cspan class=\"hljs-string\"\u003e\"../../_env/iam-roles.hcl\"\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003elocals {\n  env_vars = \u003cspan class=\"hljs-title function_\"\u003eread_terragrunt_config\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003efind_in_parent_folders\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"terragrunt.hcl\"\u003c/span\u003e))\n  env      = local.\u003cspan class=\"hljs-property\"\u003eenv_vars\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elocals\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaws_env\u003c/span\u003e\n}\n\nterraform {\n  source = \u003cspan class=\"hljs-string\"\u003e\"../../../modules//platform/iam-roles\"\u003c/span\u003e\n}\n\ninputs = {\n  trusted_role_arns = [\n    local.\u003cspan class=\"hljs-property\"\u003eenv_vars\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elocals\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eterraform_execution_role_mapping\u003c/span\u003e[local.\u003cspan class=\"hljs-property\"\u003eenv\u003c/span\u003e]\n  ]\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch2\u003einfrastructure/modules/platform/iam-roles\u003c/h2\u003e\n\u003cp\u003e\"Iam:\u003cem\u003e\"에 대한 범위를 좁히고 있음을 알려드립니다. 이는 Terraform이 응용 프로그램을 위해 Role 및 정책을 생성, 제거 및 업데이트해야하기 때문에 필요한 권한입니다. 그러나 이 경우 \":role/app/\u003c/em\u003e\" 내의 Roles 및 Policies로 범위를 좁힐 수 있습니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-json\"\u003edata \u003cspan class=\"hljs-string\"\u003e\"aws_caller_identity\"\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"current\"\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\nmodule \u003cspan class=\"hljs-string\"\u003e\"app_terraform_execution_role\"\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n  source                            = \u003cspan class=\"hljs-string\"\u003e\"../../iam-role\"\u003c/span\u003e\n  role_name                         = \u003cspan class=\"hljs-string\"\u003e\"apps-terraform-execution-role\"\u003c/span\u003e\n  create_role                       = \u003cspan class=\"hljs-literal\"\u003e\u003cspan class=\"hljs-keyword\"\u003etrue\u003c/span\u003e\u003c/span\u003e\n  role_requires_mfa                 = var.role_requires_mfa\n  path                              = \u003cspan class=\"hljs-string\"\u003e\"/\"\u003c/span\u003e\n  description                       = \u003cspan class=\"hljs-string\"\u003e\"Terraform Execution role\"\u003c/span\u003e\n  trusted_role_arns                 = var.trusted_role_arns\n  number_of_custom_role_policy_arns = \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n  policy = jsonencode(\n    \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003e\"Version\"\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"2012-10-17\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003e\"Statement\"\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003e\"Action\"\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e var.app_allowed_actions\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003e\"Effect\"\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Allow\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003e\"Resource\"\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"*\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003e\"Condition\"\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"hljs-attr\"\u003e\"StringEquals\"\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n              \u003cspan class=\"hljs-attr\"\u003e\"aws:RequestedRegion\"\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"us-east-1\"\u003c/span\u003e\n            \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n          \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003e\"Action\"\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e[\u003c/span\u003e\n            \u003cspan class=\"hljs-string\"\u003e\"iam:*\"\u003c/span\u003e\n          \u003cspan class=\"hljs-punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003e\"Effect\"\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Allow\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003e\"Resource\"\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::${data.aws_caller_identity.current.account_id}:role/app/*\"\u003c/span\u003e\n        \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"hljs-punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e)\n\u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\nvariable \u003cspan class=\"hljs-string\"\u003e\"app_allowed_actions\"\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n  default = \u003cspan class=\"hljs-punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\"cloudwatch:*\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\"iam:List*\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\"iam:Get*\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\"iam:Describe*\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\"logs:*\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\"logs:ListTagsLogGroup\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\"s3:*\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\"secretsmanager:*\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\"ses:*\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\"sns:*\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\"ssm:*\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\"dynamodb:*\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\"sts:*\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-string\"\u003e\"route53:*\"\u003c/span\u003e\n  \u003cspan class=\"hljs-punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-json\"\u003emodule \u003cspan class=\"hljs-string\"\u003e\"iam_policy\"\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n  source      = \u003cspan class=\"hljs-string\"\u003e\"git::https://github.com/terraform-aws-modules/terraform-aws-iam.git//modules/iam-policy\"\u003c/span\u003e\n  path        = var.path\n  name        = \u003cspan class=\"hljs-string\"\u003e\"${var.role_name}-policy\"\u003c/span\u003e\n  description = var.description\n  policy      = var.policy\n\u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\nmodule \u003cspan class=\"hljs-string\"\u003e\"iam_assumable_role\"\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n  source            = \u003cspan class=\"hljs-string\"\u003e\"git::https://github.com/terraform-aws-modules/terraform-aws-iam.git//modules/iam-assumable-role\"\u003c/span\u003e\n  create_role       = var.create_role\n  role_name         = var.role_name\n  role_requires_mfa = var.role_requires_mfa\n  trusted_role_arns = var.trusted_role_arns\n  custom_role_policy_arns = \u003cspan class=\"hljs-punctuation\"\u003e[\u003c/span\u003e\n    module.iam_policy.arn\n  \u003cspan class=\"hljs-punctuation\"\u003e]\u003c/span\u003e\n  number_of_custom_role_policy_arns = var.number_of_custom_role_policy_arns\n\u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch1\u003eAWS 인가: SSO를 사용할 예정이므로 장기적으로 유효한 자격 증명이 필요하지 않아요 🥳\u003c/h1\u003e\n\u003ch1\u003e로컬 구성 프로파일 구성 (~/.aws/config)\u003c/h1\u003e\n\u003ch2\u003e플랫폼\u003c/h2\u003e\n\u003cp\u003e요기 못생긴 닭과 계란 문제가 있는데... 깔끔한 AWS 계정이 있고, 플랫폼 인프라 프로비저닝에 권한을 부여해야 해요. 이건 IaC를 사용할 수 없어서 할 수 없는 문제에요.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003eAWS 콘솔이나 CLI를 사용하여 Terraform 플랫폼에 대한 IAM 또는 IAM Identity Center 사용자를 수동으로 설정해야 합니다. 설정이 완료되면 IaC를 프로비저닝할 수 있습니다.\u003c/p\u003e\n\u003cp\u003e애플리케이션 프로비저닝을 위한 모든 역할과 정책(CICD 측면을 고려한)은 플랫폼 IaC에서 생성됩니다. 애플리케이션 실행을 위한 모든 역할과 정책(예: 람다 실행 역할)은 응용 프로그램 코드 내에서 생성됩니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e[profile terraform-platform]\nsso_start_url=\u003cspan class=\"hljs-attr\"\u003ehttps\u003c/span\u003e:\u003cspan class=\"hljs-comment\"\u003e//my-organization.awsapps.com/start\u003c/span\u003e\nsso_region=us-east-\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\nsso_account_id=\u003cspan class=\"hljs-number\"\u003e555555555555\u003c/span\u003e\nsso_role_name=\u003cspan class=\"hljs-title class_\"\u003ePlatformTerraform\u003c/span\u003e\nregion=us-east-\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\noutput=json\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e응용 프로그램 리소스 (개발자가 쓰기 액세스를 얻는 곳)\u003c/h2\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cimg src=\"/assets/img/2024-05-27-MyIaCAWSMulti-AccountProvisioningBluePrintBestPractices_1.png\"\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e[profile terraform]\nsso_start_url=\u003cspan class=\"hljs-attr\"\u003ehttps\u003c/span\u003e:\u003cspan class=\"hljs-comment\"\u003e//my-organization.awsapps.com/start\u003c/span\u003e\nsso_region=us-east-\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\nsso_account_id=\u003cspan class=\"hljs-number\"\u003e555555555555\u003c/span\u003e\nsso_role_name=terraform-dev\nregion=us-east-\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\noutput=json\n\n[profile terraform-test]\nsso_start_url=\u003cspan class=\"hljs-attr\"\u003ehttps\u003c/span\u003e:\u003cspan class=\"hljs-comment\"\u003e//my-organization.awsapps.com/start\u003c/span\u003e\nsso_region=us-east-\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\nsso_account_id=\u003cspan class=\"hljs-number\"\u003e555555555555\u003c/span\u003e\nsso_role_name=terraform-test\nregion=us-east-\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\noutput=json\n\n[profile terraform-production]\nsso_start_url=\u003cspan class=\"hljs-attr\"\u003ehttps\u003c/span\u003e:\u003cspan class=\"hljs-comment\"\u003e//my-organization.awsapps.com/start\u003c/span\u003e\nsso_region=us-east-\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\nsso_account_id=\u003cspan class=\"hljs-number\"\u003e555555555555\u003c/span\u003e\nsso_role_name=terraform-production\nregion=us-east-\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\noutput=json\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eAWS Backend \u0026#x26; Provider Config\u003c/h1\u003e\n\u003cp\u003e어머머... 휴스턴, 문제 발생했어요.... AWS 계정 별로 다른 권한 세트가 있어요... 이제 더 이상 \u003ccode\u003eprofile = shared-services\u003c/code\u003e를 사용할 수 없게 됐네요.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e혹시 매핑할까요? 아니면 환경과 접두사를 추가할까요?….\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003eremote_state {\n  backend = \u003cspan class=\"hljs-string\"\u003e\"s3\"\u003c/span\u003e\n .....\n  }\n  config = {\n   ........\n\n    # 여기가 문제입니다\n    profile        = \u003cspan class=\"hljs-string\"\u003e\"terraform\"\u003c/span\u003e # 혹은 \u003cspan class=\"hljs-string\"\u003e\"terraform-test\"\u003c/span\u003e 또는 \u003cspan class=\"hljs-string\"\u003e\"terraform-production\"\u003c/span\u003e\n  }\n}\n\ngenerate \u003cspan class=\"hljs-string\"\u003e\"provider\"\u003c/span\u003e {\n  path      = \u003cspan class=\"hljs-string\"\u003e\"provider.tf\"\u003c/span\u003e\n  if_exists = \u003cspan class=\"hljs-string\"\u003e\"overwrite_terragrunt\"\u003c/span\u003e\n  contents  = \u0026#x3C;\u0026#x3C;-\u003cspan class=\"hljs-variable constant_\"\u003eEOF\u003c/span\u003e\n    provider \u003cspan class=\"hljs-string\"\u003e\"aws\"\u003c/span\u003e {\n      ...\n      ....\n      profile = \u003cspan class=\"hljs-string\"\u003e\"terraform\"\u003c/span\u003e # 혹은 \u003cspan class=\"hljs-string\"\u003e\"terraform-test\"\u003c/span\u003e 또는 \u003cspan class=\"hljs-string\"\u003e\"terraform-production\"\u003c/span\u003e\n    }\n\u003cspan class=\"hljs-variable constant_\"\u003eEOF\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e이것을 제거하고 환경 변수로 설정합시다\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003elocals {\n  # \u003cspan class=\"hljs-variable constant_\"\u003eENV\u003c/span\u003e\n  env_regex = \u003cspan class=\"hljs-string\"\u003e\"infrastructure/live/([a-zA-Z0-9-]+)/\"\u003c/span\u003e\n  aws_env   = \u003cspan class=\"hljs-title function_\"\u003etry\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003eregex\u003c/span\u003e(local.\u003cspan class=\"hljs-property\"\u003eenv_regex\u003c/span\u003e, \u003cspan class=\"hljs-title function_\"\u003eget_original_terragrunt_dir\u003c/span\u003e())[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e])\n  # \u003cspan class=\"hljs-title class_\"\u003eApplication\u003c/span\u003e\n  app_name  = \u003cspan class=\"hljs-string\"\u003e\"my-application-platform\"\u003c/span\u003e\n  component = \u003cspan class=\"hljs-string\"\u003e\"platform\"\u003c/span\u003e\n  platform_apps = [\n    \u003cspan class=\"hljs-string\"\u003e\"application_1\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"application_2\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"application_3\"\u003c/span\u003e\n  ]\n  # \u003cspan class=\"hljs-variable constant_\"\u003eAWS\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eOrganizations\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eAccounts\u003c/span\u003e\n  application_account_mapping = {\n    dev        = \u003cspan class=\"hljs-number\"\u003e222222222222\u003c/span\u003e\n    test       = \u003cspan class=\"hljs-number\"\u003e111111111111\u003c/span\u003e\n    production = \u003cspan class=\"hljs-number\"\u003e000000000000\u003c/span\u003e\n  }\n  platform_account_mapping = {\n    shared-services = \u003cspan class=\"hljs-number\"\u003e555555555555\u003c/span\u003e\n    network         = \u003cspan class=\"hljs-string\"\u003e\"666666666666\"\u003c/span\u003e\n    dns             = \u003cspan class=\"hljs-number\"\u003e888888888888\u003c/span\u003e\n  }\n  account_mapping = \u003cspan class=\"hljs-title function_\"\u003emerge\u003c/span\u003e(local.\u003cspan class=\"hljs-property\"\u003eapplication_account_mapping\u003c/span\u003e, local.\u003cspan class=\"hljs-property\"\u003eplatform_account_mapping\u003c/span\u003e)\n\n  # \u003cspan class=\"hljs-variable constant_\"\u003eIAM\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eRoles\u003c/span\u003e to \u003cspan class=\"hljs-title class_\"\u003eAssume\u003c/span\u003e\n  account_role_name     = \u003cspan class=\"hljs-string\"\u003e\"terraform-role\"\u003c/span\u003e\n  multiaccount_role_arn = \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::555555555555:role/terraform-multiaccount-role\"\u003c/span\u003e # shared-services\n\n  terraform_execution_role_mapping = {\n    dev = \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_terraform-dev_ab1\"\u003c/span\u003e\n    test = \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_terraform-test_ab2\"\u003c/span\u003e\n    production = \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_terraform-production_ab3\"\u003c/span\u003e\n  }\n\n  # \u003cspan class=\"hljs-title class_\"\u003eOther\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePlatform\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eConfig\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eValues\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eBelow\u003c/span\u003e\n  # ===================================\n  # \u003cspan class=\"hljs-variable constant_\"\u003eDNS\u003c/span\u003e\n  main_public_dns_zone_name     = \u003cspan class=\"hljs-string\"\u003e\"example.com\"\u003c/span\u003e\n  env_public_dns_zone_subdomain = \u003cspan class=\"hljs-string\"\u003e\"${local.aws_env}\"\u003c/span\u003e\n  environment_hosted_zone_name  = \u003cspan class=\"hljs-string\"\u003e\"${local.env_public_dns_zone_subdomain}.${local.main_public_dns_zone_name}\"\u003c/span\u003e\n  acm_subject_alternative_names = [\n    \u003cspan class=\"hljs-string\"\u003e\"${local.environment_hosted_zone_name}\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"*.${local.environment_hosted_zone_name}\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"*.api.${local.environment_hosted_zone_name}\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"*.myapps.${local.environment_hosted_zone_name}\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"*.apps.${local.environment_hosted_zone_name}\"\u003c/span\u003e\n  ]\n  # \u003cspan class=\"hljs-title class_\"\u003eRegion\u003c/span\u003e and \u003cspan class=\"hljs-title class_\"\u003eZones\u003c/span\u003e\n  region = \u003cspan class=\"hljs-string\"\u003e\"us-east-1\"\u003c/span\u003e\n  azs = [\n    \u003cspan class=\"hljs-string\"\u003e\"us-east-1a\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"us-east-1b\"\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\"us-east-1c\"\u003c/span\u003e\n  ]\n  platform_accounts = {\n    dev = {\n      cidr = \u003cspan class=\"hljs-string\"\u003e\"10.3.0.0/16\"\u003c/span\u003e\n      private_subnets = [\n        \u003cspan class=\"hljs-string\"\u003e\"10.3.1.0/24\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"10.3.2.0/24\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"10.3.3.0/24\"\u003c/span\u003e\n      ]\n    }\n    test = {\n      cidr = \u003cspan class=\"hljs-string\"\u003e\"10.2.0.0/16\"\u003c/span\u003e\n      private_subnets = [\n        \u003cspan class=\"hljs-string\"\u003e\"10.2.1.0/24\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"10.2.2.0/24\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"10.2.3.0/24\"\u003c/span\u003e\n      ]\n    }\n    production = {\n      cidr = \u003cspan class=\"hljs-string\"\u003e\"10.0.0.0/16\"\u003c/span\u003e\n      private_subnets = [\n        \u003cspan class=\"hljs-string\"\u003e\"10.0.1.0/24\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"10.0.2.0/24\"\u003c/span\u003e,\n        \u003cspan class=\"hljs-string\"\u003e\"10.0.3.0/24\"\u003c/span\u003e\n      ]\n    }\n  }\n}\nremote_state {\n  backend = \u003cspan class=\"hljs-string\"\u003e\"s3\"\u003c/span\u003e\n  generate = {\n    path      = \u003cspan class=\"hljs-string\"\u003e\"backend.tf\"\u003c/span\u003e\n    if_exists = \u003cspan class=\"hljs-string\"\u003e\"overwrite_terragrunt\"\u003c/span\u003e\n  }\n  config = {\n    bucket         = \u003cspan class=\"hljs-string\"\u003e\"terraform-state-shared-services\"\u003c/span\u003e\n    key            = \u003cspan class=\"hljs-string\"\u003e\"${local.app_name}/${get_path_from_repo_root()}/terraform.tfstate\"\u003c/span\u003e\n    region         = local.\u003cspan class=\"hljs-property\"\u003eregion\u003c/span\u003e\n    encrypt        = \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e\n    dynamodb_table = \u003cspan class=\"hljs-string\"\u003e\"shared-services-lock-table\"\u003c/span\u003e\n  }\n}\n\ngenerate \u003cspan class=\"hljs-string\"\u003e\"provider\"\u003c/span\u003e {\n  path      = \u003cspan class=\"hljs-string\"\u003e\"provider.tf\"\u003c/span\u003e\n  if_exists = \u003cspan class=\"hljs-string\"\u003e\"overwrite_terragrunt\"\u003c/span\u003e\n  contents  = \u0026#x3C;\u0026#x3C;-\u003cspan class=\"hljs-variable constant_\"\u003eEOF\u003c/span\u003e\n    provider \u003cspan class=\"hljs-string\"\u003e\"aws\"\u003c/span\u003e {\n      region = \u003cspan class=\"hljs-string\"\u003e\"${local.region}\"\u003c/span\u003e\n      allowed_account_ids = [\n        \u003cspan class=\"hljs-string\"\u003e\"${local.account_mapping[local.aws_env]}\"\u003c/span\u003e\n      ]\n      assume_role {\n        role_arn = \u003cspan class=\"hljs-string\"\u003e\"arn:aws:iam::${local.account_mapping[local.aws_env]}:role/${local.account_role_name}\"\u003c/span\u003e\n      }\n      default_tags {\n        tags = {\n          \u003cspan class=\"hljs-title class_\"\u003eEnvironment\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"${local.aws_env}\"\u003c/span\u003e\n          \u003cspan class=\"hljs-title class_\"\u003eManagedBy\u003c/span\u003e   = \u003cspan class=\"hljs-string\"\u003e\"terraform\"\u003c/span\u003e\n          \u003cspan class=\"hljs-title class_\"\u003eDeployedBy\u003c/span\u003e  = \u003cspan class=\"hljs-string\"\u003e\"terragrunt\"\u003c/span\u003e\n          \u003cspan class=\"hljs-title class_\"\u003eCreator\u003c/span\u003e     = \u003cspan class=\"hljs-string\"\u003e\"${get_env(\"\u003c/span\u003e\u003cspan class=\"hljs-variable constant_\"\u003eUSER\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\", \"\u003c/span\u003e\u003cspan class=\"hljs-variable constant_\"\u003eNOT_SET\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\")}\"\u003c/span\u003e\n          \u003cspan class=\"hljs-title class_\"\u003eApplication\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"${local.app_name}\"\u003c/span\u003e\n          \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e   = \u003cspan class=\"hljs-string\"\u003e\"${local.component}\"\u003c/span\u003e\n        }\n      }\n    }\n\u003cspan class=\"hljs-variable constant_\"\u003eEOF\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch1\u003e배포\u003c/h1\u003e\n\u003ch2\u003e플랫폼\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003eaws sso login --profile terraform-platform\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eAWS_PROFILE\u003c/span\u003e=terraform-platform\n\n# 개발\ncd infrastructure/live/dev/iam-roles\nterragrunt init\nterragrunt plan\nterragrunt apply\n\n# 테스트\ncd infrastructure/live/test/iam-roles\nterragrunt init\nterragrunt plan\nterragrunt apply\n\n# 프로덕션\ncd infrastructure/live/production/iam-roles\nterragrunt init\nterragrunt plan\nterragrunt apply\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e어플리케이션\u003c/h2\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003e여기서는 방금 만든 새 역할을 사용합니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e# 개발\ncd infrastructure/live/dev/app\naws sso login --profile terraform-dev\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eAWS_PROFILE\u003c/span\u003e=terraform-dev\nterragrunt init\nterragrunt plan\nterragrunt apply\n\n# 테스트\ncd infrastructure/live/test/app\naws sso login --profile terraform-test\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eAWS_PROFILE\u003c/span\u003e=terraform-test\nterragrunt init\nterragrunt plan\nterragrunt apply\n\n# 프로덕션\ncd infrastructure/live/production/app\naws sso login --profile terraform-production\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eAWS_PROFILE\u003c/span\u003e=terraform-production\nterragrunt init\nterragrunt plan\nterragrunt apply\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003eAWS Vault\u003c/h1\u003e\n\u003cp\u003eAWS Vault은 개발 환경에서 AWS 자격 증명을 안전하게 저장하고 액세스하는 도구입니다.\u003c/p\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cp\u003eAWS Vault은 IAM 자격 증명을 사용자의 운영 체제 안전한 키 저장소에 저장한 다음 해당 자격 증명을 임시 자격 증명으로 생성하여 쉘 및 응용 프로그램에 노출합니다. 이는 AWS CLI 도구와 함께 보조적으로 사용되도록 설계되었으며 ~/.aws/config에 있는 프로필과 구성을 인식합니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003ebrew install --cask aws-vault\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e따라서 이는 백엔드 구성 및 공급자에서 \"프로필\" 매개변수를 제거할 수 있음을 의미합니다.\u003c/h2\u003e\n\u003ch1\u003eAWS-Vault로 배포하기\u003c/h1\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003ch1\u003e플랫폼\u003c/h1\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e# \u003cspan class=\"hljs-title class_\"\u003eDev\u003c/span\u003e\ncd infrastructure/live/dev/iam-roles\naws-vault exec terraform-platform terragrunt init\naws-vault exec terraform-platform terragrunt plan\naws-vault exec terraform-platform terragrunt apply\n\n# 테스트\ncd infrastructure/live/test/iam-roles\naws-vault exec terraform-platform terragrunt init\naws-vault exec terraform-platform terragrunt plan\naws-vault exec terraform-platform terragrunt apply\n\n# 프로덕션\ncd infrastructure/live/production/iam-roles\naws-vault exec terraform-platform terragrunt init\naws-vault exec terraform-platform terragrunt plan\naws-vault exec terraform-platform terragrunt apply\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003e애플리케이션\u003c/h1\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003ecd infrastructure/live/dev/app\naws-vault exec terraform-dev terragrunt init\naws-vault exec terraform-dev terragrunt plan\naws-vault exec terraform-dev terragrunt apply\n\ncd infrastructure/live/test/app\naws-vault exec terraform-test terragrunt init\naws-vault exec terraform-test terragrunt plan\naws-vault exec terraform-test terragrunt apply\n\ncd infrastructure/live/production/app\naws-vault exec terraform-production terragrunt init\naws-vault exec terraform-production terragrunt plan\naws-vault exec terraform-production terragrunt apply\n\u003c/code\u003e\u003c/pre\u003e\n\u003c!-- ui-station 사각형 --\u003e\n\u003cp\u003e\u003cins class=\"adsbygoogle\" style=\"display:block\" data-ad-client=\"ca-pub-4877378276818686\" data-ad-slot=\"7249294152\" data-ad-format=\"auto\" data-full-width-responsive=\"true\"\u003e\u003c/ins\u003e\u003c/p\u003e\n\u003cscript\u003e\n(adsbygoogle = window.adsbygoogle || []).push({});\n\u003c/script\u003e\n\u003cimg src=\"/assets/img/2024-05-27-MyIaCAWSMulti-AccountProvisioningBluePrintBestPractices_2.png\"\u003e\n\u003ch2\u003e결과\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e $ aws-vault exec terraform-production terragrunt apply\n\n\n\n백엔드 초기화 중...\n\n백엔드 \u003cspan class=\"hljs-string\"\u003e\"s3\"\u003c/span\u003e이 성공적으로 구성되었습니다! 백엔드 구성이 변경되지 않는 한 \u003cspan class=\"hljs-title class_\"\u003eTerraform\u003c/span\u003e은\n자동으로이 백엔드를 사용할 것입니다.\n모듈 초기화 중...\n\u003cspan class=\"hljs-title function_\"\u003ejobs_logs\u003c/span\u003e(을)를 위해 \u003cspan class=\"hljs-attr\"\u003egit\u003c/span\u003e::\u003cspan class=\"hljs-attr\"\u003ehttps\u003c/span\u003e:\u003cspan class=\"hljs-comment\"\u003e//github.com/terraform-aws-modules/terraform-aws-dynamodb-table.git을(를) 다운로드 중...\u003c/span\u003e\n- .\u003cspan class=\"hljs-property\"\u003eterraform\u003c/span\u003e/modules/logs에 jobs_logs\n- ../lambda-execution-role에 lambda_execution_role\n\u003cspan class=\"hljs-title function_\"\u003es3_bucket_files\u003c/span\u003e(을)를 위해 \u003cspan class=\"hljs-attr\"\u003egit\u003c/span\u003e::\u003cspan class=\"hljs-attr\"\u003ehttps\u003c/span\u003e:\u003cspan class=\"hljs-comment\"\u003e//github.com/terraform-aws-modules/terraform-aws-s3-bucket.git?ref=v3.6.1을(를) 다운로드 중...\u003c/span\u003e\n- .\u003cspan class=\"hljs-property\"\u003eterraform\u003c/span\u003e/modules/s3_bucket_files에 s3_bucket_files\n- ../ssm-parameters-store에 ssm_params\n\n제공자 플러그인 초기화 중...\n- 종속성 잠금 파일에서 이전 버전의 hashicorp/aws 재사용\n- hashicorp/aws v5\u003cspan class=\"hljs-number\"\u003e.23\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e 설치 중...\n- hashicorp/aws v5\u003cspan class=\"hljs-number\"\u003e.23\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.1\u003c/span\u003e 설치됨 (\u003cspan class=\"hljs-title class_\"\u003eHashiCorp\u003c/span\u003e에서 서명됨)\n\n\u003cspan class=\"hljs-title class_\"\u003eTerraform\u003c/span\u003e이 성공적으로 초기화되었습니다!\n\n이제 \u003cspan class=\"hljs-title class_\"\u003eTerraform\u003c/span\u003e을 사용하여 작업을 시작할 수 있습니다. \u003cspan class=\"hljs-string\"\u003e\"terraform plan\"\u003c/span\u003e을 실행하여\n인프라에 필요한 모든 변경 사항을 확인해 보세요. 이제 모든 \u003cspan class=\"hljs-title class_\"\u003eTerraform\u003c/span\u003e 명령이\n작동해야 합니다.\n\n\u003cspan class=\"hljs-title class_\"\u003eTerraform\u003c/span\u003e을 위해 모듈이나 백엔드 구성을 설정 또는 변경한 경우,\n작업 디렉터리를 다시 초기화하려면이 명령을 다시 실행하세요. 잊어 버린 경우\n다른 명령이 필요한 경우이를 감지하고 다시 실행하라는 메시지가 표시됩니다.\n상태 잠금 획득 중. 이 작업은 몇 분 정도 걸릴 수 있습니다...\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elambda_execution_role\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edata\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaws_iam_policy_document\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elambda_assume_role_policy\u003c/span\u003e: 읽는 중...\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003es3_bucket_files\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edata\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaws_caller_identity\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e: 읽는 중...\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003es3_bucket_files\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edata\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaws_canonical_user_id\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ethis\u003c/span\u003e: 읽는 중...\ndata.\u003cspan class=\"hljs-property\"\u003eaws_caller_identity\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e: 읽는 중...\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003es3_bucket_files\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaws_s3_bucket\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ethis\u003c/span\u003e[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e]: 상태 새로 고침 중... [id=my-company-myapp-files-dev]\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ejobs_logs\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaws_dynamodb_table\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ethis\u003c/span\u003e[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e]: 상태 새로 고침 중... [id=my-company-myapp-logs]\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elambda_execution_role\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edata\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaws_iam_policy_document\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elambda_assume_role_policy\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e초 후에 읽기 완료 [id=\u003cspan class=\"hljs-number\"\u003e000000000\u003c/span\u003e]\ndata.\u003cspan class=\"hljs-property\"\u003eaws_caller_identity\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e초 후에 읽기 완료 [id=\u003cspan class=\"hljs-number\"\u003e000000000\u003c/span\u003e]\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elambda_execution_role\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edata\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaws_iam_policy_document\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003einline_policy\u003c/span\u003e: 읽는 중...\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003es3_bucket_files\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edata\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaws_caller_identity\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e초 후에 읽기 완료 [id=\u003cspan class=\"hljs-number\"\u003e000000000\u003c/span\u003e]\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elambda_execution_role\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edata\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaws_iam_policy_document\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003einline_policy\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e초 후에 읽기 완료 [id=\u003cspan class=\"hljs-number\"\u003e000000000\u003c/span\u003e]\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elambda_execution_role\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaws_iam_role\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elambda_execution_role\u003c/span\u003e: 상태 새로 고침 중... [id=my-company-myapp-lambda-execution-role]\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003es3_bucket_files\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edata\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaws_canonical_user_id\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ethis\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e초 후에 읽기 완료 [id=51528157cefbacf17d3cc90bf31e07f8f463cadfbf31739f6b264afac67fb2ce]\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003es3_bucket_files\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaws_s3_bucket_public_access_block\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ethis\u003c/span\u003e[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e]: 상태 새로 고침 중... [id=my-company-myapp-files-dev]\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003essm_params\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaws_ssm_parameter\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ethis\u003c/span\u003e[\u003cspan class=\"hljs-string\"\u003e\"2\"\u003c/span\u003e]: 상태 새로 고침 중... [id=\u003cspan class=\"hljs-regexp\"\u003e/app/my\u003c/span\u003eapp/lambda_role]\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003essm_params\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaws_ssm_parameter\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ethis\u003c/span\u003e[\u003cspan class=\"hljs-string\"\u003e\"3\"\u003c/span\u003e]: 상태 새로 고침 중... [id=\u003cspan class=\"hljs-regexp\"\u003e/app/my\u003c/span\u003eapp/event_bridge_name]\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003essm_params\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaws_ssm_parameter\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ethis\u003c/span\u003e[\u003cspan class=\"hljs-string\"\u003e\"4\"\u003c/span\u003e]: 상태 새로 고침 중... [id=\u003cspan class=\"hljs-regexp\"\u003e/app/my\u003c/span\u003eapp/logs]\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003essm_params\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eaws_ssm_parameter\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ethis\u003c/span\u003e[\u003cspan class=\"hljs-string\"\u003e\"1\"\u003c/span\u003e]: 상태 새로 고침 중... [id=\u003cspan class=\"hljs-regexp\"\u003e/app/my\u003c/span\u003eapp/s3_bucket_files]\n\n변경 사항이 없습니다. 인프라가 구성과 일치합니다.\n\n\u003cspan class=\"hljs-title class_\"\u003eTerraform\u003c/span\u003e은 실제 인프라를 구성과 비교하고 차이점을 찾았으며 변경 사항이 필요하지 않습니다.\n상태 잠금 해제 중. 이 작업은 몇 분 정도 걸릴 수 있습니다...\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e읽어 주셔서 감사합니다!\u003c/p\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"2024-05-27-MyIaCAWSMulti-AccountProvisioningBluePrintBestPractices"},"buildId":"T_Nz0g9U1yttYMSEma95P","isFallback":false,"gsp":true,"scriptLoader":[{"async":true,"src":"https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4877378276818686","strategy":"lazyOnload","crossOrigin":"anonymous"}]}</script></body></html>